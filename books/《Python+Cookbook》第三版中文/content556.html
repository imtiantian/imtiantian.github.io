<div id="pf22c" class="pf w0 h0" data-page-no="22c"><div class="pc pc22c w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg22c.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x17 hf y1ab ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="fc9">&quot;Can<span class="ff9 ls34">&apos;</span><span class="ws13b">t convert </span><span class="ffa fcf">%s</span><span class="ls32">&quot;<span class="fc6 ls33">%</span></span></span>typename)</span></span></div><div class="t m0 x15 h11 y1ad ffa fs5 fcd sc0 ls0 ws4"># Cast from array.array objects</div><div class="t m0 x15 hf y1ae ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">from_array<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, param):</span></span></span></div><div class="t m0 x16 hf y1af ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">param<span class="fc6">.</span><span class="ws16d">typecode <span class="fc6 ws159">!= <span class="ff9 fc9 ls34">&apos;<span class="ff8">d</span><span class="ls0 ws13b">&apos;</span></span></span>:</span></span></div><div class="t m0 x17 hf y1b0 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">must be an array of doubles<span class="ff9 ws13b">&apos;</span></span>)</span></span></div><div class="t m0 x16 hf y355 ff8 fs5 fc0 sc0 ls0 ws13b">ptr, _ <span class="fc6 ls32">=</span><span class="ws13a">param<span class="fc6 ls34">.</span>buffer_info()</span></div><div class="t m0 x16 hf y410 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">ctypes<span class="fc6 ls34">.</span><span class="ws4">cast(ptr, ctypes</span><span class="fc6">.</span>POINTER(ctypes<span class="fc6">.</span>c_double))</span></div><div class="t m0 x15 h11 yba ffa fs5 fcd sc0 ls0 ws4"># Cast from lists/tuples</div><div class="t m0 x15 hf y8c6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">from_list<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, param):</span></span></span></div><div class="t m0 x16 hf ybed ff8 fs5 fc0 sc0 ls0 ws158">val <span class="fc6 ls32">=</span><span class="ws13a">((ctypes<span class="fc6 ls34">.</span>c_double)<span class="fc6 ls34">*</span><span class="fca">len</span>(param))(<span class="fc6">*</span>param)</span></div><div class="t m0 x16 hf ybee ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">val</span></div><div class="t m0 x15 hf ybf0 ff8 fs5 fc0 sc0 ls0 ws2a3">from_tuple <span class="fc6 ls32">=</span>from_list</div><div class="t m0 x15 h11 ybf1 ffa fs5 fcd sc0 ls0 ws4"># Cast from a numpy array</div><div class="t m0 x15 hf ybf2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">from_ndarray<span class="fc0">(<span class="fca">self</span><span class="ws4">, param):</span></span></span></div><div class="t m0 x16 hf ybf3 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">param<span class="fc6">.</span>ctypes<span class="fc6">.</span>data_as(ctypes<span class="fc6">.</span>POINTER(ctypes<span class="fc6 ls34">.</span>c_double))</span></div><div class="t m0 x5 hf ybf5 ff8 fs5 fc0 sc0 ls0 ws208">DoubleArray <span class="fc6 ls32">=</span>DoubleArrayType()</div><div class="t m0 x5 hf ybf6 ff8 fs5 fc0 sc0 ls0 ws13c">_avg <span class="fc6 ls32">=</span><span class="ws13a">_mod<span class="fc6 ls34">.</span>avg</span></div><div class="t m0 x5 hf ybf7 ff8 fs5 fc0 sc0 ls0 ws13a">_avg<span class="fc6 ls34">.</span><span class="ws1f5">argtypes <span class="fc6 ls33">=</span><span class="ws13b">(DoubleArray, ctypes<span class="fc6 ls34">.</span>c_int)</span></span></div><div class="t m0 x5 hf ybf8 ff8 fs5 fc0 sc0 ls0 ws13a">_avg<span class="fc6 ls34">.</span><span class="ws1f4">restype <span class="fc6 ls33">=</span></span>ctypes<span class="fc6 ls34">.</span>c_double</div><div class="t m0 x5 hf ybfa ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">avg<span class="fc0">(values):</span></span></div><div class="t m0 x15 hf ybfb ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws150">_avg(values, <span class="fca ws13a">len</span>(values))</span></div><div class="t m0 x5 h11 y1ed7 ffa fs5 fcd sc0 ls0 ws4"># struct Point { }</div><div class="t m0 x5 hf y1ed8 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Point<span class="ff8 fc0 ws13a">(ctypes<span class="fc6 ls34">.</span>Structure):</span></span></div><div class="t m0 x15 hf y1f83 ff8 fs5 fc0 sc0 ls0 ws1f5">_fields_ <span class="fc6 ls33">=</span><span class="ws13a">[(<span class="ff9 fc9 ls34">&apos;<span class="ff8">x</span>&apos;</span><span class="ws13b">, ctypes<span class="fc6 ls34">.</span>c_double),</span></span></div><div class="t m0 x18 hf y1ed9 ff8 fs5 fc0 sc0 ls0 ws13a">(<span class="ff9 fc9 ls34">&apos;<span class="ff8">y</span>&apos;</span><span class="ws13b">, ctypes<span class="fc6 ls34">.</span>c_double)]</span></div><div class="t m0 x5 h11 y1edb ffa fs5 fcd sc0 ls0 ws4"># double distance(Point *, Point *)</div><div class="t m0 x5 hf y1f84 ff8 fs5 fc0 sc0 ls0 ws16d">distance <span class="fc6 ls32">=</span><span class="ws13a">_mod<span class="fc6 ls34">.</span>distance</span></div><div class="t m0 x5 hf y2515 ff8 fs5 fc0 sc0 ls0 ws13a">distance<span class="fc6 ls34">.</span><span class="ws1f5">argtypes <span class="fc6 ls33">=</span></span>(ctypes<span class="fc6">.</span><span class="ws4">POINTER(Point), ctypes<span class="fc6 ls34">.</span>POINTER(Point))</span></div><div class="t m0 x5 hf y1edc ff8 fs5 fc0 sc0 ls0 ws13a">distance<span class="fc6 ls34">.</span><span class="ws1f4">restype <span class="fc6 ls33">=</span></span>ctypes<span class="fc6 ls34">.</span>c_double</div><div class="t m0 x0 h7 y35ce ff1 fs3 fc0 sc0 ls0 ws38">如果一切正常，你就可以加载并使用里面定义的 <span class="ff4 ls8">C</span>函数了。例如：</div><div class="t m0 x5 h10 y35cf ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y35d0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>gcd(<span class="fc7">35</span><span class="ls34">,</span><span class="fc7">42</span>)</span></div><div class="t m0 x5 hf y35aa ff8 fs5 fc8 sc0 ls0">7</div><div class="t m0 x5 hf y35d1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>in_mandel(<span class="fc7 ls34">0<span class="fc0">,</span><span class="ls0">0</span><span class="fc0">,</span><span class="ls0">500</span></span>)</span></div><div class="t m0 x5 hf y35d2 ff8 fs5 fc8 sc0 ls0">1</div><div class="t m0 x5 hf y35d3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>in_mandel(<span class="fc7">2.0</span><span class="ls34">,</span><span class="fc7">1.0</span><span class="ls34">,</span><span class="fc7">500</span>)</span></div><div class="t m0 x5 hf y21b7 ff8 fs5 fc8 sc0 ls0">0</div><div class="t m0 x5 hf y35d4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>divide(<span class="fc7">42</span>,<span class="fc7 ls34">8</span>)</span></div><div class="t m0 x5 hf y35d5 ff8 fs5 fc8 sc0 ls0 ws4">(5, 2)</div><div class="t m0 x5 hf y35d6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>avg([<span class="fc7">1</span><span class="ls34">,<span class="fc7">2</span>,</span><span class="fc7">3</span>])</span></div><div class="t m0 x5 hf y1948 ff8 fs5 fc8 sc0 ls0">2.0</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.1.<span class="_ _36"> </span>15.1 <span class="ff1 ws16b">使用 </span><span class="ws135b">ctypes <span class="ff1 ws16b">访问 </span><span class="ls246">C</span><span class="ff1 ws135c">代码 </span>547</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
