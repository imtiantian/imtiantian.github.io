<div id="pf1d6" class="pf w0 h0" data-page-no="1d6"><div class="pc pc1d6 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1d6.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls13 wse5">所有普通实例操作比如获取<span class="_ _1"></span>、修改和删除值仅仅操作这个字典。每个线程使用一个独<span class="_ _c"></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">立的字典就可以保证数据的隔离了。</div><div class="t m0 x5 hd y2f0c ff2 fs4 fc4 sc0 ls0 ws211">14.7<span class="_ _e"> </span>12.7 <span class="ff1">创建一个线程池</span></div><div class="t m0 x5 he y2f0d ff2 fs2 fc4 sc0 ls0 ws212">14.7.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y2f0e ff1 fs3 fc0 sc0 ls0">你创建一个工作者线程池，用来相应客户端请求或执行其他的工作。</div><div class="t m0 x5 he y2f0f ff2 fs2 fc4 sc0 ls0 ws212">14.7.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y2ea3 ff6 fs3 fc0 sc0 ls0 ws10cc">concurrent.futures <span class="ff1 ws10cd">函<span class="_ _6"></span>数<span class="_ _6"></span>库<span class="_ _6"></span>有<span class="_ _6"></span>一<span class="_ _6"></span>个 </span><span class="ws10ce">ThreadPoolExecutor <span class="ff1 wsa0">类<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>被<span class="_ _0"></span>用来<span class="_ _6"></span>完<span class="_ _6"></span>成<span class="_ _0"></span>这个</span></span></div><div class="t m0 x5 h7 y2ea4 ff1 fs3 fc0 sc0 ls0 ws38">任务。下面是一个简单的 <span class="ff4 wseb0">TCP </span>服务器，使用了一个线程池来响应客户端：</div><div class="t m0 x5 hf y2f10 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">AF_INET, SOCK_STREAM, socket</span></span></span></div><div class="t m0 x5 hf y2f11 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscf2">concurrent.futures </span><span class="ws1ff">import <span class="ff8 fc0">ThreadPoolExecutor</span></span></div><div class="t m0 x5 hf y2f12 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_client<span class="fc0 ws13b">(sock, client_addr):</span></span></div><div class="t m0 x15 h15 y2f13 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2f14 ffa fs5 fc9 sc0 ls0 ws4">Handle a client connection</div><div class="t m0 x15 h15 y2f15 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y2f16 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Got connection from<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, client_addr)</span></span></div><div class="t m0 x15 hf y2f17 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2f18 ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>recv(<span class="fc7">65536</span>)</span></div><div class="t m0 x16 hf y11b9 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">msg:</span></div><div class="t m0 x17 h10 y11ba ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x16 hf y2f19 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6">.</span>sendall(msg)</div><div class="t m0 x15 hf y2f1a ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Client closed connection<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf y2f1b ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 hf y6e4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_server<span class="fc0">(addr):</span></span></div><div class="t m0 x15 hf y6e5 ff8 fs5 fc0 sc0 ls0 ws13c">pool <span class="fc6 ls32">=</span><span class="ws13a">ThreadPoolExecutor(<span class="fc7">128</span>)</span></div><div class="t m0 x15 hf y6e6 ff8 fs5 fc0 sc0 ls0 ws13c">sock <span class="fc6 ls32">=</span><span class="ws4">socket(AF_INET, SOCK_STREAM)</span></div><div class="t m0 x15 hf y6e7 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>bind(addr)</div><div class="t m0 x15 hf y6e8 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>listen(<span class="fc7">5</span>)</div><div class="t m0 x15 hf y6e9 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y12e ff8 fs5 fc0 sc0 ls0 ws13b">client_sock, client_addr <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x16 hf y12f ff8 fs5 fc0 sc0 ls0 ws13a">pool<span class="fc6">.</span><span class="ws4">submit(echo_client, client_sock, client_addr)</span></div><div class="t m0 x5 hf y2f1c ff8 fs5 fc0 sc0 ls0 ws13a">echo_server((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls34">,</span><span class="fc7">15000</span>))</div><div class="t m0 x0 h7 y2f1d ff1 fs3 fc0 sc0 ls0 ws10cf">如<span class="_ _6"></span>果你<span class="_ _6"></span>想<span class="_ _6"></span>手<span class="_ _6"></span>动<span class="_ _6"></span>创<span class="_ _6"></span>建你<span class="_ _6"></span>自<span class="_ _6"></span>己<span class="_ _6"></span>的<span class="_ _6"></span>线<span class="_ _6"></span>程池，<span class="_ _6"></span>通<span class="_ _6"></span>常<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>使用<span class="_ _6"></span>一<span class="_ _6"></span>个 <span class="ff4 ws10d0">Queue </span><span class="wsa0">来<span class="_ _6"></span>轻<span class="_ _6"></span>松<span class="_ _6"></span>实现。<span class="_ _6"></span>下<span class="_ _6"></span>面</span></div><div class="t m0 x5 h9 y2f1e ff1 fs3 fc0 sc0 ls0">是一个稍微不同但是手动实现的例子：</div><div class="t m0 x5 hf y330 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 hf y331 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x5 hf y332 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.7.<span class="_ _36"> </span>12.7 <span class="ff1 ws600">创建一个线程池 </span>461</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
