<div id="pf1ac" class="pf w0 h0" data-page-no="1ac"><div class="pc pc1ac w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ac.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.<span class="fc0">start()</span></span></div><div class="t m0 x5 h11 y1ad ffa fs5 fcd sc0 ls0 ws4"># Some remote functions</div><div class="t m0 x5 hf y1ae ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y1af ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></div><div class="t m0 x5 hf y355 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">sub<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y410 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">-</span><span class="ls0">y</span></span></div><div class="t m0 x5 h11 yba ffa fs5 fcd sc0 ls0 ws4"># Register with a handler</div><div class="t m0 x5 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws155">handler <span class="fc6 ls32">=</span>RPCHandler()</div><div class="t m0 x5 hf ybed ff8 fs5 fc0 sc0 ls0 ws13a">handler<span class="fc6 ls34">.</span>register_function(add)</div><div class="t m0 x5 hf ybee ff8 fs5 fc0 sc0 ls0 ws13a">handler<span class="fc6 ls34">.</span>register_function(sub)</div><div class="t m0 x5 h11 ybf0 ffa fs5 fcd sc0 ls0 ws4"># Run the server</div><div class="t m0 x5 hf yd7d ff8 fs5 fc0 sc0 ls0 ws4">rpc_server(handler, (<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">localhost<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7 ws13a">17000</span>), authkey<span class="fc6 ws13a">=</span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">peekaboo<span class="ff9 ws13b">&apos;</span></span>)</div><div class="t m0 x0 h7 y2b99 ff1 fs3 fc0 sc0 ls10 wsf80">为了从一个远程客户端访问服务器，你需要创建一个对应的用来传送请求的 <span class="ff4 ls0">RPC</span></div><div class="t m0 x5 h9 y2b9a ff1 fs3 fc0 sc0 ls0">代理类。例如</div><div class="t m0 x5 h10 y1ba8 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">pickle</span></div><div class="t m0 x5 hf y2b9b ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">RPCProxy<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2b9c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, connection):</span></span></span></div><div class="t m0 x16 hf y2b9d ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">_connection </span><span class="ls33">=</span><span class="fc0">connection</span></span></div><div class="t m0 x15 hf y2588 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__getattr__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, name):</span></span></span></div><div class="t m0 x16 hf y2b9e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">do_rpc<span class="fc0 ls34">(<span class="fc6">*</span><span class="ls0 ws15f">args, </span></span><span class="fc6">**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x17 hf y2b9f ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_connection</span><span class="ls34">.</span><span class="fc0">send(pickle</span><span class="ls34">.</span><span class="fc0 ws13b">dumps((name, args, kwargs)))</span></span></div><div class="t m0 x17 hf y2ba0 ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="ws13a">pickle<span class="fc6">.</span>loads(<span class="fca">self<span class="fc6">.</span></span>_connection<span class="fc6 ls34">.</span>recv())</span></div><div class="t m0 x17 hf y2ba1 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">isinstance<span class="fc0 ws16d">(result, </span>Exception<span class="fc0">):</span></span></div><div class="t m0 x18 hf y2ba2 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 fc0">result</span></div><div class="t m0 x17 hf y2ba3 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">result</span></div><div class="t m0 x16 hf y2ba4 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">do_rpc</span></div><div class="t m0 x0 h9 y62a ff1 fs3 fc0 sc0 ls0">要使用这个代理类，你需要将其包装到一个服务器的连接上面，例如：</div><div class="t m0 x5 hf y1bce ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc wsf5c">multiprocessing.connection </span><span class="ws146">import <span class="ff8 fc0">Client</span></span></span></div><div class="t m0 x5 hf y1bcf ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0 ws13a">Client((<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">localhost<span class="ff9 ls34">&apos;</span></span></span>,<span class="fc7 ls0 ws13a">17000<span class="fc0 ws13b">), authkey<span class="fc6 ls34">=</span><span class="ws13a">b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">peekaboo<span class="ff9 ls34">&apos;</span></span>)</span></span></span></span></div><div class="t m0 x5 hf y1bd0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">proxy <span class="fc6 ls33">=</span>RPCProxy(c)</span></div><div class="t m0 x5 hf y2ba5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">proxy<span class="fc6">.</span>add(<span class="fc7 ls34">2</span><span class="ls32">,<span class="fc7 ls34">3</span></span>)</span></div><div class="t m0 x5 hf y190d ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf y2ba6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">proxy<span class="fc6">.</span>sub(<span class="fc7 ls34">2</span><span class="ls32">,<span class="fc7 ls34">3</span></span>)</span></div><div class="t m0 x5 hf y2ba7 ff8 fs5 fc8 sc0 ls0">-1</div><div class="t m0 x5 hf y2ba8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">proxy<span class="fc6">.</span>sub([<span class="fc7 ls34">1</span><span class="ls32">,<span class="fc7 ls34">2</span></span><span class="ws159">], <span class="fc7 ls34">4</span>)</span></span></div><div class="t m0 x5 hf y2ba9 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y2baa ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x19 hf y2bab ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;rpcserver.py&quot;</span><span class="ws145">, line <span class="fc7 ws13a">37</span><span class="ws13b">, in do_rpc</span></span></div><div class="t m0 x15 hf y2bac ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 fc0">result</span></div><div class="t m0 x5 hf y2bad ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: unsupported operand type(s) for -: <span class="ff9 ls34">&apos;</span><span class="ws13a">list<span class="ff9 ls33">&apos;</span><span class="ws15b">and <span class="ff9 ls34">&apos;</span></span>int<span class="ff9">&apos;</span></span></span></div><div class="t m0 x5 hf y25a ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.8.<span class="_ _5"> </span>11.8 <span class="ff1 ws533">实现远程方法调用 </span>419</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
