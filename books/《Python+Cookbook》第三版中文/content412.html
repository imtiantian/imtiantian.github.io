<div id="pf19c" class="pf w0 h0" data-page-no="19c"><div class="pc pc19c w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg19c.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0 wseb6">在这段<span class="_ _6"></span>代码<span class="_ _6"></span>中，你定<span class="_ _6"></span>义了<span class="_ _6"></span>一个特<span class="_ _6"></span>殊的<span class="_ _6"></span>处理类，<span class="_ _6"></span>实现了<span class="_ _6"></span>一个 <span class="ff6 ws2c3">handle() </span><span class="wsa0">方<span class="_ _6"></span>法，用来<span class="_ _6"></span>为</span></div><div class="t m0 x5 h7 y2b ff1 fs3 fc0 sc0 ls0 wseb7">客户端连<span class="_ _6"></span>接服务。 <span class="ff6 wseb8">request </span><span class="ls51 wseb9">属性是客户端 </span><span class="ff4 wsa5">so<span class="_ _6"></span>ck<span class="_ _c"></span>et<span class="ff1 ls1d6">，</span><span class="ff6 wseb8">client<span class="_ _7"> </span>address <span class="ff1 wsa0">有客户端<span class="_ _6"></span>地址。为</span></span></span></div><div class="t m0 x5 h7 y2c ff1 fs3 fc0 sc0 ls0 ws63">了测试这个服务器，运行它并打开另外一个 <span class="ff4 ws5c">Python </span>进程连接这个服务器：</div><div class="t m0 x5 hf y29df ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></span></div><div class="t m0 x5 hf y29e0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></span></div><div class="t m0 x5 hf y29e1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">connect((</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">localhost</span>&apos;</span><span class="ls32">,<span class="fc7 ls0 ws13a">20000<span class="fc0">))</span></span></span></span></div><div class="t m0 x5 hf y29e2 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">Hello<span class="ff9 ls34">&apos;</span></span>)</span></span></span></div><div class="t m0 x5 hf y29e3 ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf y29e4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">recv(<span class="fc7">8192</span>)</span></span></span></div><div class="t m0 x5 hf y29e5 ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws13a">Hello<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y29e6 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y29e7 ff1 fs3 fc0 sc0 ls0 wseba">很 多 时 候， 可 以 很 容 易 的 定 义 一 个 不 同 的 处 理 器。 下 面 是 一 个 使 用</div><div class="t m0 x5 h7 y29e8 ff6 fs3 fc0 sc0 ls0 ws4fa">StreamRequestHandler <span class="ff1 ws38">基类将一个类文件接口放置在底层 <span class="ff4 wsebb">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1">上的例子：</span></span></span></div><div class="t m0 x5 hf y29e9 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws96c">socketserver </span><span class="ws146">import <span class="ff8 fc0 ws4">StreamRequestHandler, TCPServer</span></span></div><div class="t m0 x5 hf y29ea ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">EchoHandler<span class="ff8 fc0">(StreamRequestHandler):</span></span></div><div class="t m0 x15 hf y29eb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y29ec ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Got connection from<span class="ff9">&apos;</span></span></span><span class="ls33">,</span></span><span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">client_address)</span></span></div><div class="t m0 x16 h11 y29ed ffa fs5 fcd sc0 ls0 ws4"># self.rfile is a file-like object for reading</div><div class="t m0 x16 hf y29ee ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">rfile:</span></span></span></div><div class="t m0 x17 h11 y29ef ffa fs5 fcd sc0 ls0 ws4"># self.wfile is a file-like object for writing</div><div class="t m0 x17 hf y29f0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">wfile</span><span class="ls34">.</span><span class="fc0">write(line)</span></span></div><div class="t m0 x5 hf y29f1 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y29f2 ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls33">,</span><span class="fc7">20000</span><span class="ws13b">), EchoHandler)</span></span></div><div class="t m0 x15 hf y29f3 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x5 he y29f4 ff2 fs2 fc4 sc0 ls0 ws212">13.2.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y34a ff6 fs3 fc0 sc0 ls0 wsebc">socketserver <span class="ff1 ws46">可以让我们很容易的创建简单的 <span class="ff4 wsebd">TCP </span><span class="wsa0">服务器。<span class="_ _1"></span>但是，<span class="_ _1"></span>你需要注意的</span></span></div><div class="t m0 x5 h9 y2507 ff1 fs3 fc0 sc0 ls1e ws111">是<span class="_ _1"></span>，默认情况下这种服务器是单线程的<span class="_ _1"></span>，一次只能为一个客户端连接服务。如果<span class="_ _1"></span>你想</div><div class="t m0 x5 h9 y29f5 ff1 fs3 fc0 sc0 ls0 ws1be">处理多个客户端，可以初始化一个 <span class="ff6 wsebe">ForkingTCPServer </span><span class="wsebf">或者是 <span class="ff6 wsec0">ThreadingTCPServer </span>对</span></div><div class="t m0 x5 h9 y29f6 ff1 fs3 fc0 sc0 ls0">象。例如：</div><div class="t m0 x5 hf y29f7 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws96c">socketserver </span><span class="ws146">import <span class="ff8 fc0">ThreadingTCPServer</span></span></div><div class="t m0 x5 hf y29f8 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y29f9 ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">ThreadingTCPServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">20000</span><span class="ws4">), EchoHandler)</span></span></div><div class="t m0 x15 hf y29fa ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h7 yf48 ff1 fs3 fc0 sc0 ls0 wsc0e">使<span class="_ _6"></span>用 <span class="ff4 wsec1">fork </span><span class="ls13 wse5">或线程服务器有个潜在问题就是它们会为每个客户端连接创建一个新的<span class="_ _c"></span></span></div><div class="t m0 x5 h9 yf8d ff1 fs3 fc0 sc0 ls13 wse5">进程或线程<span class="_ _1"></span>。由于客户端连接数是没有限制的，因此一个恶意的黑客可以同时发送大<span class="_ _c"></span></div><div class="t m0 x5 h9 yf8e ff1 fs3 fc0 sc0 ls0">量的连接让你的服务器奔溃。</div><div class="t m0 x0 h9 yf8f ff1 fs3 fc0 sc0 ls3a ws153">如果你担心这个问题，你可以创建一个预先分配大小的工作线程池或进程池。你先</div><div class="t m0 x5 h9 y6e ff1 fs3 fc0 sc0 ls22 wsec2">创建一个普通的非线程服务器，然后在一个线程<span class="_ _1"></span>池中使用 <span class="ff6 ls0 wsc3d">serve forever() <span class="ff1 wsa0">方<span class="_ _6"></span>法<span class="_ _6"></span>来启</span></span></div><div class="t m0 x5 h9 y674 ff1 fs3 fc0 sc0 ls0">动它们。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.2.<span class="_ _5"> </span>11.2 <span class="ff1 ws16b">创建 </span><span class="wseb4">TCP <span class="ff1 wseb5">服务器 </span>403</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
