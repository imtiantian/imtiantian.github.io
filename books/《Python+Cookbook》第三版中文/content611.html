<div id="pf263" class="pf w0 h0" data-page-no="263"><div class="pc pc263 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg263.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y1ab ff8 fs5 fc0 sc0 ls0 ws4">while (1) {</div><div class="t m0 x15 hf y1ac ff8 fs5 fc0 sc0 ls0 ws13b">PyObject *data;</div><div class="t m0 x15 hf y1ad ff8 fs5 fc0 sc0 ls0 ws13b">PyObject *enc_data;</div><div class="t m0 x15 hf y1ae ff8 fs5 fc0 sc0 ls0 ws13b">char *buf;</div><div class="t m0 x15 hf y1af ff8 fs5 fc0 sc0 ls0 ws13b">Py_ssize_t len;</div><div class="t m0 x15 hf y355 ff8 fs5 fc0 sc0 ls0 ws4">/* Call read() */</div><div class="t m0 x15 hf y410 ff8 fs5 fc0 sc0 ls0 ws4">if ((data = PyObject_Call(read_meth, read_args, NULL)) == NULL) {</div><div class="t m0 x50 hf y411 ff8 fs5 fc0 sc0 ls0 ws4">goto final;</div><div class="t m0 x15 hf yba ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x15 hf ybed ff8 fs5 fc0 sc0 ls0 ws4">/* Check for EOF */</div><div class="t m0 x15 hf ybee ff8 fs5 fc0 sc0 ls0 ws4">if (PySequence_Length(data) == 0) {</div><div class="t m0 x50 hf ybef ff8 fs5 fc0 sc0 ls0">Py_DECREF(data);</div><div class="t m0 x50 hf ybf0 ff8 fs5 fc0 sc0 ls0">break;</div><div class="t m0 x15 hf yd7d ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x15 hf ybf2 ff8 fs5 fc0 sc0 ls0 ws4">/* Encode Unicode as Bytes for C */</div><div class="t m0 x15 hf ybf3 ff8 fs5 fc0 sc0 ls0 ws13b">if ((enc_data=PyUnicode_AsEncodedString(data,&quot;utf-8&quot;,&quot;strict&quot;))==NULL) {</div><div class="t m0 x50 hf ybf4 ff8 fs5 fc0 sc0 ls0">Py_DECREF(data);</div><div class="t m0 x50 hf ybf5 ff8 fs5 fc0 sc0 ls0 ws4">goto final;</div><div class="t m0 x15 hf ybf6 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x15 hf ybf8 ff8 fs5 fc0 sc0 ls0 ws4">/* Extract underlying buffer data */</div><div class="t m0 x15 hf ybf9 ff8 fs5 fc0 sc0 ls0 ws13b">PyBytes_AsStringAndSize(enc_data, &amp;buf, &amp;len);</div><div class="t m0 x15 hf ybfb ff8 fs5 fc0 sc0 ls0 ws4">/* Write to stdout (replace with something more useful) */</div><div class="t m0 x15 hf y1ed6 ff8 fs5 fc0 sc0 ls0 ws13b">write(1, buf, len);</div><div class="t m0 x15 hf y1ed8 ff8 fs5 fc0 sc0 ls0 ws13b">/* Cleanup */</div><div class="t m0 x15 hf y1f83 ff8 fs5 fc0 sc0 ls0">Py_DECREF(enc_data);</div><div class="t m0 x15 hf y1ed9 ff8 fs5 fc0 sc0 ls0">Py_DECREF(data);</div><div class="t m0 x19 hf y1eda ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1edb ff8 fs5 fc0 sc0 ls0 ws4">result = Py_BuildValue(&quot;&quot;);</div><div class="t m0 x4b hf y2515 ff8 fs5 fc0 sc0 ls0">final:</div><div class="t m0 x19 hf y1edc ff8 fs5 fc0 sc0 ls0 ws4">/* Cleanup */</div><div class="t m0 x19 hf y1edd ff8 fs5 fc0 sc0 ls0">Py_DECREF(read_meth);</div><div class="t m0 x19 hf y1ede ff8 fs5 fc0 sc0 ls0">Py_DECREF(read_args);</div><div class="t m0 x19 hf y1edf ff8 fs5 fc0 sc0 ls0 ws4">return result;</div><div class="t m0 x5 hf y1ee0 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y3740 ff1 fs3 fc0 sc0 ls0 ws14">要测试这个代码，先构造一个类文件对象比如一个 <span class="ff4 ws15ee">StringIO </span>实例，然后传递进来：</div><div class="t m0 x5 h10 y3a94 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">io</span></span></div><div class="t m0 x5 hf y3a95 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=</span><span class="ls0 ws13a">io<span class="fc6 ls34">.</span>StringIO(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">Hello<span class="ff7 ws156">\n</span>World<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;</span></span></span>)</span></span></div><div class="t m0 x5 h10 y3a96 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y3a97 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>consume_file(f)</span></div><div class="t m0 x5 hf y3a98 ff8 fs5 fc8 sc0 ls0">Hello</div><div class="t m0 x5 hf y3a99 ff8 fs5 fc8 sc0 ls0">World</div><div class="t m0 x5 hf y3a9a ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.19.<span class="_ _36"> </span>15.19 <span class="ff1 ls7f">从</span><span class="ls246">C</span><span class="ff1 ws15dc">语言中读取类文件对象 </span>602</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
