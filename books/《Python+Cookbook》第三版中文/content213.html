<div id="pfd5" class="pf w0 h0" data-page-no="d5"><div class="pc pcd5 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgd5.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y432 ff8 fs5 fc8 sc0 ls0 ws4">3.4 6.3</div><div class="t m0 x5 hf y433 ff8 fs5 fc8 sc0 ls0 ws4">1.2 0.5</div><div class="t m0 x5 hf y434 ff8 fs5 fc8 sc0 ls0 ws4">4.6 9.2</div><div class="t m0 x5 hf yde6 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 yde7 ff1 fs3 fc0 sc0 ls0 ws38">将所有这些结合起来，下面是一个 <span class="ff6 ws23a">read<span class="_ _7"> </span>polys() </span>函数的另外一个修正版：</div><div class="t m0 x5 hf y173f ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Point<span class="ff8 fc0">(Structure):</span></span></div><div class="t m0 x15 hf y1740 ff8 fs5 fc0 sc0 ls0 ws1f5">_fields_ <span class="fc6 ls33">=</span>[</div><div class="t m0 x16 hf y1741 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;<span class="ff8 ws13a">&lt;d</span>&apos;</span><span class="ls33">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">x</span>&apos;</span><span class="ls0">),</span></div><div class="t m0 x16 hf y1742 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">d<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8">y</span><span class="ls0 ws13b">&apos;</span></span><span class="ls0">)</span></div><div class="t m0 x15 hf y1743 ff8 fs5 fc0 sc0 ls0">]</div><div class="t m0 x5 hf y1744 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PolyHeader<span class="ff8 fc0">(Structure):</span></span></div><div class="t m0 x15 hf y698 ff8 fs5 fc0 sc0 ls0 ws1f5">_fields_ <span class="fc6 ls33">=</span>[</div><div class="t m0 x16 hf y1745 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;<span class="ff8 ws13a">&lt;i</span>&apos;</span><span class="ls33">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">file_code</span>&apos;</span><span class="ls0">),</span></div><div class="t m0 x16 hf y1746 ff8 fs5 fc0 sc0 ls0 ws155">(Point, <span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">min</span>&apos;</span>),</div><div class="t m0 x16 hf y1747 ff8 fs5 fc0 sc0 ls0 ws155">(Point, <span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">max</span>&apos;</span>),</div><div class="t m0 x16 hf y1748 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">i<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">num_polys</span>&apos;</span><span class="ls0">)</span></div><div class="t m0 x15 hf y1749 ff8 fs5 fc0 sc0 ls0">]</div><div class="t m0 x5 hf y174a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">read_polys<span class="fc0">(filename):</span></span></div><div class="t m0 x15 hf y174b ff8 fs5 fc0 sc0 ls0 ws15f">polys <span class="fc6 ls33">=</span>[]</div><div class="t m0 x15 hf y174c ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws2a3">(filename, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ws13b">&apos;</span><span class="fc0 ls33">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y174d ff8 fs5 fc0 sc0 ls0 ws15f">phead <span class="fc6 ls33">=</span><span class="ws13a">PolyHeader<span class="fc6 ls34">.</span>from_file(f)</span></div><div class="t m0 x16 hf y174e ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0">(phead<span class="fc6 ls34">.</span>num_polys):</span></span></span></div><div class="t m0 x17 hf y174f ff8 fs5 fc0 sc0 ls0 ws158">rec <span class="fc6 ls32">=</span><span class="ws13a">SizedRecord<span class="fc6 ls34">.</span><span class="ws150">from_file(f, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">&lt;i<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x17 hf y1750 ff8 fs5 fc0 sc0 ls0 ws161">poly <span class="fc6 ls33">=</span><span class="ws13b">[ (p<span class="fc6 ws13a">.</span><span class="ws4">x, p<span class="fc6 ls34">.</span><span class="ws159">y) <span class="ff7 fca ws139">for </span><span class="ls33">p</span><span class="ff7 fca ws157">in </span><span class="ws13a">rec<span class="fc6 ls34">.</span></span></span></span>iter_as(Point) ]</span></div><div class="t m0 x17 hf y1751 ff8 fs5 fc0 sc0 ls0 ws13a">polys<span class="fc6 ls34">.</span>append(poly)</div><div class="t m0 x15 hf y1752 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">polys</span></div><div class="t m0 x5 he y1753 ff2 fs2 fc4 sc0 ls0 ws212">8.12.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y1754 ff1 fs3 fc0 sc0 ls0 wsa0">这一节向你展示了许<span class="_ _6"></span>多高级的编程技术，包括<span class="_ _6"></span>描述器，延迟计算，元类，类<span class="_ _6"></span>变量和</div><div class="t m0 x5 h9 y1755 ff1 fs3 fc0 sc0 ls0">内存视图。然而，它们都为了同一个特定的目标服务。</div><div class="t m0 x0 h9 y1756 ff1 fs3 fc0 sc0 ls14 ws8e6">上面的实现的一个主要特征是它是基于懒解包的思想<span class="_ _1"></span>。当一个 <span class="ff6 ls0 ws33a">Structure <span class="ff1 wsa0">实<span class="_ _6"></span>例<span class="_ _6"></span>被</span></span></div><div class="t m0 x5 h9 y1757 ff1 fs3 fc0 sc0 ls0 ws8e7">创建<span class="_ _6"></span>时， <span class="ff6 ws8e8">init<span class="_ _e"> </span>() </span><span class="ls22 ws119">仅仅只是创建一个字节数据的内存视图，没有做其他任何事<span class="_ _1"></span>。特</span></div><div class="t m0 x5 h9 y1758 ff1 fs3 fc0 sc0 ls13 wse5">别的<span class="_ _1"></span>，这时候并没有任何的解包或者其他与结构相关的操作发生。这样做的一个动机<span class="_ _c"></span></div><div class="t m0 x5 h9 y1759 ff1 fs3 fc0 sc0 ls2d ws132">是你可能仅仅只对一个字节记录的某一小部分感兴趣。我们只需要解包你需要访问的<span class="_ _1"></span></div><div class="t m0 x5 h9 y175a ff1 fs3 fc0 sc0 ls0">部分，而不是整个文件。</div><div class="t m0 x0 h9 y175b ff1 fs3 fc0 sc0 lse ws8e9">为了实现懒解包和打包，需要使用 <span class="ff6 ls0 ws675">StructField </span><span class="ws8ea">描述器类。用户在 <span class="ff6 ls0 ws8eb">fields <span class="ff1 wsa0">中列</span></span></span></div><div class="t m0 x5 h9 y175c ff1 fs3 fc0 sc0 ls17 ws8ec">出来的每个属性都会被转化成一个 <span class="ff6 ls0 ws1ec">StructField </span><span class="wsf6">描述器，它将相关<span class="_ _1"></span>结构格式码和偏移</span></div><div class="t m0 x5 h9 y175d ff1 fs3 fc0 sc0 ls42 ws8ed">值保存到存储缓存中。元类 <span class="ff6 ls0 ws3a0">StructureMeta </span><span class="ws186">在多个结构类被定义时自动创建了这些描<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y6b ff1 fs3 fc0 sc0 ls2d ws132">述器<span class="_ _1"></span>。我们使用元类的一个主要原因是它使得用户非常方便的通过一个高层描述<span class="_ _6"></span>就能<span class="_ _1"></span></div><div class="t m0 x5 h9 y6c ff1 fs3 fc0 sc0 ls0">指定结构格式，而无需考虑低层的细节问题。</div><div class="t m0 x0 h9 y175e ff6 fs3 fc0 sc0 ls0 ws770">StructureMeta <span class="ff1 ls3a ws153">的一个很微妙的地方就是它会固定字节数据顺序。也就是说，如果</span></div><div class="t m0 x5 h7 y175f ff1 fs3 fc0 sc0 ls82 ws8ee">任意的属性指定了一个字节顺序 <span class="ff4 ls1b">(<span class="ff12 ls14b">&lt;</span></span><span class="ws8ef">表示低位优先或者 <span class="ff12 ls14b">&gt;</span><span class="ws2f9">表示高位优先<span class="ff4 ls1b">)</span>，那后面所有</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">8.12.<span class="_ _5"> </span>6.12 <span class="ff1 ws6e7">读取嵌套和可变长二进制数据 </span>204</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
