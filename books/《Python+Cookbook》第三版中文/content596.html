<div id="pf254" class="pf w0 h0" data-page-no="254"><div class="pc pc254 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg254.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">foo(<span class="fc7 ls34">4</span>,<span class="fc7 ls34">5</span>)</span></div><div class="t m0 x5 hf y1ac ff8 fs5 fc8 sc0 ls0">41.0</div><div class="t m0 x5 hf y1ad ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">foo(<span class="fc7 ls34">1</span>,<span class="fc7 ls34">2</span>)</span></div><div class="t m0 x5 hf y1ae ff8 fs5 fc8 sc0 ls0">5.0</div><div class="t m0 x5 hf y1af ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 ye8c ff1 fs3 fc0 sc0 ls18 ws153b">并不是说在这个层面犯了任何错误就会导致 <span class="ff4 ls0 ws453">Python </span><span class="ws110">解释器挂掉。要记得的是你是<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y7cb ff1 fs3 fc0 sc0 ls0 ws14">在直接跟机器级别的内存地址和本地机器码打交道，而不是 <span class="ff4 ws5c">Python </span>函数。</div><div class="t m0 x5 hd y3947 ff2 fs4 fc4 sc0 ls0 wsd91">17.13<span class="_ _e"> </span>15.13 <span class="ff1 ws165">传递 </span><span class="ws153c">NULL <span class="ff1 ws357">结尾的字符串给 </span><span class="ls23d">C</span><span class="ff1">函数库</span></span></div><div class="t m0 x5 he y3948 ff2 fs2 fc4 sc0 ls0 wsadf">17.13.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y1d0e ff1 fs3 fc0 sc0 ls19 ws153d">你要写一个扩展模块，需要传递一个 <span class="ff4 ls0 ws103b">NULL </span><span class="wsbc8">结尾的字符串给 <span class="ff4 ls10d">C</span><span class="ls0 wsa0">函数库。不<span class="_ _6"></span>过，你</span></span></div><div class="t m0 x5 h7 y3949 ff1 fs3 fc0 sc0 ls0 ws38">不是很确定怎样使用 <span class="ff4 ws5c">Python </span><span class="ls5">的</span><span class="ff4 wsc1">Unico<span class="_ _6"></span>de </span>字符串去实现它。</div><div class="t m0 x5 he y394a ff2 fs2 fc4 sc0 ls0 wsadf">17.13.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y1c48 ff1 fs3 fc0 sc0 ls0 ws2c9">许多 <span class="ff4 ls293">C</span><span class="ws7ae">函数库包含一些操作 <span class="ff4 ws153e">NULL </span><span class="ws153f">结尾的字符串，被声明类型为 <span class="ff6 ws1540">char<span class="_ _26"> </span>* <span class="ff4 ls294">.</span></span>考虑如</span></span></div><div class="t m0 x5 h7 y394b ff1 fs3 fc0 sc0 ls0 ws14">下的 <span class="ff4 ls8">C</span>函数，我们用来做演示和测试用的：</div><div class="t m0 x5 hf y394c ff8 fs5 fc0 sc0 ls0 ws4">void print_chars(char *s) {</div><div class="t m0 x15 hf y2589 ff8 fs5 fc0 sc0 ls0 ws13b">while (*s) {</div><div class="t m0 x16 hf y20af ff8 fs5 fc0 sc0 ls0 ws4">printf(&quot;%2x &quot;, (unsigned char) *s);</div><div class="t m0 x16 hf y394d ff8 fs5 fc0 sc0 ls0">s++;</div><div class="t m0 x15 hf y394e ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x15 hf y394f ff8 fs5 fc0 sc0 ls0">printf(&quot;\n&quot;);</div><div class="t m0 x5 hf y3950 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y1909 ff1 fs3 fc0 sc0 ls3a ws153">此函数会打印被传进来字符串的每个字符的十六进制表示，这样的话可以很容易的</div><div class="t m0 x5 h9 y190a ff1 fs3 fc0 sc0 ls0">进行调试了。例如：</div><div class="t m0 x5 hf y38b6 ff8 fs5 fc0 sc0 ls0 ws4">print_chars(&quot;Hello&quot;);<span class="_ _3a"> </span>// Outputs: 48 65 6c 6c 6f</div><div class="t m0 x0 h7 y3951 ff1 fs3 fc0 sc0 ls295 ws1541">对于在 <span class="ff4 ls0 ws1542">Python <span class="ff1 ws1543">中<span class="_ _0"></span>调<span class="_ _0"></span>用<span class="_ _0"></span>这<span class="_ _0"></span>样<span class="_ _0"></span>的 </span><span class="ls296">C</span><span class="ff1 wsa0">函<span class="_ _0"></span>数，<span class="_ _0"></span>你<span class="_ _0"></span>有<span class="_ _0"></span>几<span class="_ _0"></span>种<span class="_ _0"></span>选<span class="_ _0"></span>择。<span class="_ _0"></span>首<span class="_ _0"></span>先，<span class="_ _0"></span>你<span class="_ _0"></span>可<span class="_ _0"></span>以<span class="_ _12"></span>通<span class="_ _0"></span>过<span class="_ _0"></span>调<span class="_ _0"></span>用</span></span></div><div class="t m0 x5 h7 y2de4 ff6 fs3 fc0 sc0 ls0 ws1dc">PyArg<span class="_ _7"> </span>ParseTuple() <span class="ff1 wsa0">并指定”<span class="ff4 wsa5">y</span>“转换码来限制它只能操作字节，如下：</span></div><div class="t m0 x5 hf y3952 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_chars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y3953 ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x19 hf y3954 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;y&quot;, &amp;s)) {</div><div class="t m0 x15 hf y3955 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y3956 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3287 ff8 fs5 fc0 sc0 ls0">print_chars(s);</div><div class="t m0 x19 hf y3957 ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y3958 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.13.<span class="_ _36"> </span>15.13 <span class="ff1 ws16b">传递 </span><span class="ws1544">NULL <span class="ff1 ws7da">结尾的字符串给 </span><span class="ls246">C</span><span class="ff1 ws1545">函数库 </span>587</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
