<div id="pf1b7" class="pf w0 h0" data-page-no="1b7"><div class="pc pc1b7 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1b7.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 wsadf">13.11.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y675 ff1 fs3 fc0 sc0 lse wsffe">为了在多个进程中传递文件描述符，你首先需要将它们连接到一起。在 <span class="ff4 ls0 wsfff">Unix <span class="ff1 wsa0">机器</span></span></div><div class="t m0 x5 h7 y676 ff1 fs3 fc0 sc0 ls0 ws1000">上，<span class="_ _6"></span>你<span class="_ _6"></span>可能<span class="_ _6"></span>需<span class="_ _6"></span>要<span class="_ _6"></span>使<span class="_ _6"></span>用 <span class="ff4 ws1001">Unix </span><span class="ws1002">域<span class="_ _6"></span>套<span class="_ _6"></span>接<span class="_ _6"></span>字，<span class="_ _6"></span>而<span class="_ _6"></span>在 <span class="ff4 ws1003">windo<span class="_ _1"></span>ws <span class="ff1 wsa0">上<span class="_ _6"></span>面<span class="_ _6"></span>你需<span class="_ _6"></span>要<span class="_ _6"></span>使<span class="_ _6"></span>用<span class="_ _6"></span>命<span class="_ _6"></span>名<span class="_ _6"></span>管<span class="_ _6"></span>道。<span class="_ _6"></span>不<span class="_ _6"></span>过</span></span></span></div><div class="t m0 x5 h9 y677 ff1 fs3 fc0 sc0 ls42 ws1004">你无需真的需要去操作这些底层，通常使用 <span class="ff6 ls0 ws185">multiprocessing <span class="ff1 wsa0">模块来创<span class="_ _6"></span>建这<span class="_ _6"></span>样的<span class="_ _6"></span>连接</span></span></div><div class="t m0 x5 h9 y678 ff1 fs3 fc0 sc0 ls0">会更容易一些。</div><div class="t m0 x0 h9 y1577 ff1 fs3 fc0 sc0 ls1f0 ws1005">一旦一个连接被创建<span class="_ _28"></span>，你可以使用 <span class="ff6 ls0 ws1006">multiprocessing.reduction <span class="ff1 ws1007">中 的</span></span></div><div class="t m0 x5 h9 y2c6e ff6 fs3 fc0 sc0 ls0 ws3e1">send handle()<span class="_ _b"> </span><span class="ff1 ls1f1">和</span><span class="ws5c3">recv handle()<span class="_ _b"> </span><span class="ff1 ls19d wsc4f">函数在不同的处理<span class="_ _6"></span>器直接传递文件描述符<span class="_ _8"></span>。<span class="_ _6"></span>下面<span class="_ _8"></span></span></span></div><div class="t m0 x5 h9 y11f0 ff1 fs3 fc0 sc0 ls0">的例子演示了最基本的用法：</div><div class="t m0 x5 h10 y2c6f ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">multiprocessing</span></div><div class="t m0 x5 hf y2c70 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws1008">multiprocessing.reduction </span><span class="ws146">import <span class="ff8 fc0 ws13b">recv_handle, send_handle</span></span></div><div class="t m0 x5 h10 y2c71 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">socket</span></div><div class="t m0 x5 hf y2c72 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">worker<span class="fc0 ws4">(in_p, out_p):</span></span></div><div class="t m0 x15 hf y2c73 ff8 fs5 fc0 sc0 ls0 ws13a">out_p<span class="fc6">.</span>close()</div><div class="t m0 x15 hf y2c74 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2c75 ff8 fs5 fc0 sc0 ls0 ws159">fd <span class="fc6 ls32">=</span>recv_handle(in_p)</div><div class="t m0 x16 hf y2c76 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">CHILD: GOT FD</span>&apos;</span><span class="ls0 ws4">, fd)</span></span></div><div class="t m0 x16 hf y2c77 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0 ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws13b">AF_INET, socket</span><span class="fc6">.</span><span class="ws4">SOCK_STREAM, fileno<span class="fc6 ls34">=</span><span class="ws158">fd) </span></span></span><span class="ws157">as <span class="ff8 fc0">s:</span></span></div><div class="t m0 x17 hf y2c78 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 hf y2c79 ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ls34">s</span><span class="fc6 ws13a">.<span class="fc0">recv(<span class="fc7">1024</span>)</span></span></div><div class="t m0 x18 hf y2c7a ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">msg:</span></div><div class="t m0 x29 h10 y2c7b ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x18 hf y2c7c ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">CHILD: RECV {!r}</span>&apos;</span><span class="fc6">.</span><span class="ls0">format(msg))</span></span></div><div class="t m0 x18 hf y2c7d ff8 fs5 fc0 sc0 ls0 ws13a">s<span class="fc6 ls34">.</span>send(msg)</div><div class="t m0 x5 hf y2c7e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">server<span class="fc0 ws4">(address, in_p, out_p, worker_pid):</span></span></div><div class="t m0 x15 hf y2c7f ff8 fs5 fc0 sc0 ls0 ws13a">in_p<span class="fc6 ls34">.</span>close()</div><div class="t m0 x15 hf y2c80 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws4">AF_INET, socket<span class="fc6 ls34">.</span>SOCK_STREAM)</span></span></div><div class="t m0 x15 hf y2c81 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">setsockopt(socket</span>.</span><span class="ls0 ws4">SOL_SOCKET, socket<span class="fc6 ws13a">.</span><span class="ws147">SO_REUSEADDR, <span class="fca ws13a">True</span>)</span></span></div><div class="t m0 x15 hf y2c82 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bind(address)</span></span></div><div class="t m0 x15 hf y2c83 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">listen(</span></span><span class="fc7">1</span><span class="ls0">)</span></div><div class="t m0 x15 hf y2c84 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2c85 ff8 fs5 fc0 sc0 ls0 ws13b">client, addr <span class="fc6 ls33">=</span><span class="ws13a">s<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x16 hf y2c86 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws4">SERVER: Got connection from<span class="ff9 ws13b">&apos;</span><span class="fc0">, addr)</span></span></span></span></div><div class="t m0 x16 hf y2c87 ff8 fs5 fc0 sc0 ls0 ws13b">send_handle(out_p, client<span class="fc6 ls34">.</span>fileno(), worker_pid)</div><div class="t m0 x16 hf y2c88 ff8 fs5 fc0 sc0 ls0 ws13a">client<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 hf y2c89 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y2c8a ff8 fs5 fc0 sc0 ls0 ws13b">c1, c2 <span class="fc6 ls32">=</span><span class="ws13a">multiprocessing<span class="fc6 ls34">.</span>Pipe()</span></div><div class="t m0 x15 hf y2c8b ff8 fs5 fc0 sc0 ls0 ws1f5">worker_p <span class="fc6 ls33">=</span><span class="ws13a">multiprocessing<span class="fc6 ls34">.</span>Process(target<span class="fc6">=</span><span class="ws4">worker, args<span class="fc6 ls34">=</span>(c1,c2))</span></span></div><div class="t m0 x15 hf y2c8c ff8 fs5 fc0 sc0 ls0 ws13a">worker_p<span class="fc6">.</span>start()</div><div class="t m0 x15 hf y2c8d ff8 fs5 fc0 sc0 ls0 ws1f5">server_p <span class="fc6 ls33">=</span><span class="ws13a">multiprocessing<span class="fc6 ls34">.</span>Process(target<span class="fc6">=</span>server,</span></div><div class="t m0 x34 hf y2c8e ff8 fs5 fc0 sc0 ls0 ws13a">args<span class="fc6 ls34">=</span>((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">15000</span><span class="ws4">), c1, c2, worker_p</span><span class="fc6">.</span>pid))</div><div class="t m0 x15 hf y2c8f ff8 fs5 fc0 sc0 ls0 ws13a">server_p<span class="fc6">.</span>start()</div><div class="t m0 x15 hf y2c90 ff8 fs5 fc0 sc0 ls0 ws13a">c1<span class="fc6 ls34">.</span>close()</div><div class="t m0 x15 hf y2c91 ff8 fs5 fc0 sc0 ls0 ws13a">c2<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.11.<span class="_ _36"> </span>11.11 <span class="ff1 ws36c">进程间传递 </span><span class="wsffc">So<span class="_ _0"></span>ck<span class="_ _c"></span>et <span class="ff1 wsffd">文件描述符 </span>430</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
