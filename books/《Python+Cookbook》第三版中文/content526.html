<div id="pf20e" class="pf w0 h0" data-page-no="20e"><div class="pc pc20e w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg20e.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y15f ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws157">io </span><span class="ws146">import <span class="ff8 fc0">StringIO</span></span></div><div class="t m0 x5 hf y160 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws248">unittest </span><span class="ws146">import <span class="ff8 fc0">TestCase</span></span></div><div class="t m0 x5 hf y956 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wsb44">unittest.mock </span><span class="ws146">import <span class="ff8 fc0">patch</span></span></div><div class="t m0 x5 h10 y957 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">mymodule</span></div><div class="t m0 x5 hf y959 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">TestURLPrint<span class="ff8 fc0">(TestCase):</span></span></div><div class="t m0 x15 hf y95a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test_url_gets_to_stdout<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y95b ff8 fs5 fc0 sc0 ls0 ws1f5">protocol <span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">http<span class="ff9">&apos;</span></span></div><div class="t m0 x16 hf y95c ff8 fs5 fc0 sc0 ls0 ws161">host <span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">www<span class="ff9">&apos;</span></span></div><div class="t m0 x16 hf y9f3 ff8 fs5 fc0 sc0 ls0 ws145">domain <span class="fc6 ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">example.com<span class="ff9">&apos;</span></span></div><div class="t m0 x16 hf y9f4 ff8 fs5 fc0 sc0 ls0 ws150">expected_url <span class="fc6 ls33">=</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">{}://{}.{}<span class="ff7 ws156">\n</span></span><span class="ls34">&apos;<span class="ff8 fc6">.</span></span></span><span class="ws13b">format(protocol, host, domain)</span></div><div class="t m0 x16 hf y95e ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">sys.stdout<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, new<span class="fc6 ls34">=</span><span class="ws208">StringIO()) </span></span></span><span class="ws157">as <span class="ff8 fc0">fake_out:</span></span></div><div class="t m0 x17 hf ybb7 ff8 fs5 fc0 sc0 ls0 ws13a">mymodule<span class="fc6">.</span><span class="ws4">urlprint(protocol, host, domain)</span></div><div class="t m0 x17 hf ybb8 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">assertEqual(fake_out</span><span class="ls34">.</span><span class="fc0 ws13b">getvalue(), expected_url)</span></span></div><div class="t m0 x5 he y3320 ff2 fs2 fc4 sc0 ls0 ws212">16.1.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y3321 ff6 fs3 fc0 sc0 ls0 ws1280">urlprint() <span class="ff1 ws1281">函 数 接 受 三 个 参 数， 测 试 方 法 开 始 会 先 设 置 每 一 个 参 数 的 值。</span></div><div class="t m0 x5 h9 y3322 ff6 fs3 fc0 sc0 ls0 ws15e">expected<span class="_ _7"> </span>url <span class="ff1">变量被设置成包含期望的输出的字符串。</span></div><div class="t m0 x0 h9 y3323 ff6 fs3 fc0 sc0 ls0 ws1282">unittest.mock.patch() <span class="ff1 ws1283">函数被<span class="_ _6"></span>用作一个<span class="_ _6"></span>上下文<span class="_ _6"></span>管理器，使<span class="_ _6"></span>用 </span><span class="ws266">StringIO <span class="ff1 wsa0">对象来代</span></span></div><div class="t m0 x5 h7 y2087 ff1 fs3 fc0 sc0 lsee">替<span class="ff6 ls0 ws677">sys.stdout <span class="ff4 ls1d2">.</span><span class="ws1284">fake out </span></span><span class="ls19 ws1285">变量是在该进程中被创建的模拟对象。在 </span><span class="ff4 ls0 ws1286">with </span><span class="ls0 wsa0">语句<span class="_ _6"></span>中使用</span></div><div class="t m0 x5 h7 y3324 ff1 fs3 fc0 sc0 ls18 ws14d">它可以执行各种检查。当 <span class="ff4 ls0 ws1287">with <span class="ff1 wsa0">语句结束<span class="_ _6"></span>时，<span class="ff6 ws819">patch </span></span></span><span class="ws110">会将所有东西恢复到测试开始前的</span></div><div class="t m0 x5 h7 y3325 ff1 fs3 fc0 sc0 ls0 ws1288">状<span class="_ _6"></span>态。<span class="_ _6"></span>有<span class="_ _6"></span>一<span class="_ _6"></span>点需<span class="_ _6"></span>要<span class="_ _6"></span>注<span class="_ _6"></span>意<span class="_ _6"></span>的<span class="_ _6"></span>是<span class="_ _6"></span>某<span class="_ _6"></span>些<span class="_ _6"></span>对 <span class="ff4 ws1289">Python </span><span class="ls211">的<span class="ff4 ls225">C</span></span><span class="ws11ff">扩<span class="_ _6"></span>展<span class="_ _6"></span>可<span class="_ _6"></span>能<span class="_ _6"></span>会<span class="_ _6"></span>忽<span class="_ _6"></span>略<span class="_ _6"></span>掉 <span class="ff6 ws576">sys.stdout </span><span class="wsa0">的<span class="_ _6"></span>配</span></span></div><div class="t m0 x5 h9 y3326 ff1 fs3 fc0 sc0 ls1e ws111">置二直接写入到标准输出中<span class="_ _1"></span>。限于篇幅<span class="_ _1"></span>，本节不会涉及到这方面的讲解，它适用<span class="_ _1"></span>于纯</div><div class="t m0 x5 h7 y3327 ff4 fs3 fc0 sc0 ls0 ws128a">Python <span class="ff1 wsab6">代码。如果你真的需要在 </span><span class="ls226">C</span><span class="ff1 ws558">扩展中捕获 </span><span class="wsa5">I/O<span class="ff1 wsa0">，你可以先打开一个临时文件，然</span></span></div><div class="t m0 x5 h7 y2a95 ff1 fs3 fc0 sc0 lsf ws128b">后将标准输出重定向到该文件中<span class="_ _c"></span>。更多关于捕获以字符串形式捕获 <span class="ff4 ls0 wsda">I/<span class="_ _6"></span>O </span><span class="ls107">和<span class="ff6 ls0">StringIO</span></span></div><div class="t m0 x5 h7 y3328 ff1 fs3 fc0 sc0 ls0 ws38">对象请参阅 <span class="ff4 ws171">5.6 </span>小节。</div><div class="t m0 x5 hd y1fae ff2 fs4 fc4 sc0 ls0 ws211">16.2<span class="_ _e"> </span>14.2 <span class="ff1">在单元测试中给对象打补丁</span></div><div class="t m0 x5 he y38d ff2 fs2 fc4 sc0 ls0 ws212">16.2.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y3329 ff1 fs3 fc0 sc0 ls63 ws21f">你写的单元测试中需要给指定的对象打补丁<span class="_ _c"></span>，用来断言它们在测试中的期望行为<span class="_ _1"></span></div><div class="t m0 x38 h9 y2169 ff1 fs3 fc0 sc0 ls0 wsa0">（比如，断言被调用时的参数个数，访问指定的属性等）<span class="_ _f"></span>。</div><div class="t m0 x5 he y332a ff2 fs2 fc4 sc0 ls0 ws212">16.2.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y332b ff6 fs3 fc0 sc0 ls0 ws128c">unittest.mock.patch() <span class="ff1 ws128d">函<span class="_ _6"></span>数<span class="_ _6"></span>可<span class="_ _6"></span>被<span class="_ _6"></span>用<span class="_ _6"></span>来<span class="_ _6"></span>解<span class="_ _6"></span>决<span class="_ _6"></span>这<span class="_ _0"></span>个问<span class="_ _6"></span>题。 </span><span class="ws128e">patch() <span class="ff1 wsa0">还<span class="_ _6"></span>可<span class="_ _0"></span>被用<span class="_ _6"></span>作<span class="_ _6"></span>一<span class="_ _0"></span>个</span></span></div><div class="t m0 x5 h9 y332c ff1 fs3 fc0 sc0 ls1e ws111">装饰器<span class="_ _1"></span>、上下文管理器或单独使用，尽管并不常见<span class="_ _c"></span>。例如，下面是一个将它当做装饰<span class="_ _1"></span></div><div class="t m0 x5 h9 y332d ff1 fs3 fc0 sc0 ls0">器使用的例子：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">16.2.<span class="_ _36"> </span>14.2 <span class="ff1 ws98a">在单元测试中给对象打补丁 </span>517</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
