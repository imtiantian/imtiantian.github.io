<div id="pf136" class="pf w0 h0" data-page-no="136"><div class="pc pc136 w0 h0"><img class="bi x13 y5 w2 hb" alt="" src="bg136.png"/><div class="t m0 xe h8 y76 ff2 fs3 fc0 sc0 ls0">CHAPTER</div><div class="t m0 x35 hc y77 ff2 fs4 fc0 sc0 ls0">ELEVEN</div><div class="t m0 x36 hd y78 ff1 fs4 fc0 sc0 ls0">第九章：元编程</div><div class="t m0 x0 h7 y79 ff1 fs3 fc0 sc0 ls0 wsa0">软件开发领域中最经典的口头禅就是“<span class="ff4 wsa5">don</span>’<span class="_ _c"></span><span class="ff4 wsb92">t rep<span class="_ _6"></span>eat yourself<span class="ff1 wsa0">”<span class="_ _31"></span>。也就是说，<span class="_ _c"></span>任何时</span></span></div><div class="t m0 x5 h7 ycf ff1 fs3 fc0 sc0 ls18 wsb93">候当你的程序中存在高度重复 <span class="ff4 ls1b">(</span><span class="ws110">或者是通过剪切复制<span class="ff4 ls69">)</span><span class="ls0 wsa0">的代码<span class="_ _6"></span>时，都应<span class="_ _6"></span>该想想<span class="_ _6"></span>是否有<span class="_ _6"></span>更</span></span></div><div class="t m0 x5 h7 yd0 ff1 fs3 fc0 sc0 lsa8 wsb94">好的解决方案。在 <span class="ff4 ls0 wsb95">Python </span><span class="ws3de">当中<span class="_ _1"></span>，通常都可以通过元编程来解决这类问题。简而言之<span class="_ _1"></span>，</span></div><div class="t m0 x5 h7 yd1 ff1 fs3 fc0 sc0 ls3d wsb96">元编程就是关于创建操作源代码 <span class="ff4 ls0 wsa5">(</span><span class="ws164">比如修改、生成或包装原来的代码<span class="_ _1"></span><span class="ff4 ls18a">)<span class="ff1 ls0 wsa0">的函数<span class="_ _6"></span>和类。<span class="_ _6"></span>主</span></span></span></div><div class="t m0 x5 h9 y520 ff1 fs3 fc0 sc0 ls1e ws111">要技术是使用装饰器<span class="_ _1"></span>、类装饰器和元类。不过还有一些其他技术<span class="_ _c"></span>，<span class="_ _6"></span>包括签名对象<span class="_ _1"></span>、使</div><div class="t m0 x5 h9 y20ac ff1 fs3 fc0 sc0 ls5">用<span class="ff6 ls0 ws25d">exec() </span><span class="ls0 wsa0">执行代码以及对内部函数和类的反射技术等。本章的主要目的是向大家介绍</span></div><div class="t m0 x5 h9 y20ad ff1 fs3 fc0 sc0 ls0">这些元编程技术，并且给出实例来演示它们是怎样定制化你的源代码行为的。</div><div class="t m0 x0 h7 y90f ff4 fs3 fc0 sc0 ls0 wsa5">Con<span class="_ _1"></span>ten<span class="_ _1"></span>ts:</div><div class="t m0 x5 hd y20ae ff2 fs4 fc4 sc0 ls0 ws9c6">11.1<span class="_ _e"> </span>9.1 <span class="ff1">在函数上添加包装器</span></div><div class="t m0 x5 he y20af ff2 fs2 fc4 sc0 ls0 ws212">11.1.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y20b0 ff1 fs3 fc0 sc0 ls0 ws38">你想在函数上添加一个包装器，增加额外的操作处理 <span class="ff4 ls1b">(</span><span class="wsa0">比如日志、计时等<span class="ff4 wsa5">)</span>。</span></div><div class="t m0 x5 he y20b1 ff2 fs2 fc4 sc0 ls0 ws212">11.1.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y20b2 ff1 fs3 fc0 sc0 ls0">如果你想使用额外的代码包装一个函数，可以定义一个装饰器函数，例如：</div><div class="t m0 x5 h10 y20b3 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">time</span></div><div class="t m0 x5 hf y20b4 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">wraps</span></span></div><div class="t m0 x5 hf y20b5 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">timethis<span class="fc0">(func):</span></span></div><div class="t m0 x15 h15 y20b6 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y20b7 ffa fs5 fc9 sc0 ls0 ws4">Decorator that reports the execution time.</div><div class="t m0 x15 h15 y20b8 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y1cc7 ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x15 hf y20b9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws458">args, </span>**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x16 hf y20ba ff8 fs5 fc0 sc0 ls0 ws15f">start <span class="fc6 ls33">=</span><span class="ws13a">time<span class="fc6">.</span>time()</span></div><div class="t m0 x16 hf y20bb ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="ws13a">func(<span class="fc6 ls34">*</span><span class="ws15f">args, <span class="fc6 ls34">**</span>kwargs)</span></span></div><div class="t m0 x16 hf y1802 ff8 fs5 fc0 sc0 ls0 ws158">end <span class="fc6 ls32">=</span><span class="ws13a">time<span class="fc6 ls34">.</span>time()</span></div><div class="t m0 x16 hf y20bc ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(func<span class="fc6 ls34">.</span><span class="ws13b">__name__, end<span class="fc6 ls34">-</span>start)</span></span></div><div class="t m0 x16 hf y20bd ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">result</span></div><div class="t m0 x15 hf y20be ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x26 h8 y29 ff2 fs3 fc0 sc0 ls0">301</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
