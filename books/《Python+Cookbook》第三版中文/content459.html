<div id="pf1cb" class="pf w0 h0" data-page-no="1cb"><div class="pc pc1cb w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1cb.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1ac ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_cv:</span></span></div><div class="t m0 x17 hf y1ad ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">len<span class="fc0 ls34">(</span>self<span class="fc6 ls34">.</span><span class="fc0 ws1f4">_queue) <span class="fc6 ws15c">== </span></span><span class="fc7">0<span class="fc0">:</span></span></span></div><div class="t m0 x18 hf y1ae ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_cv</span><span class="ls34">.</span><span class="fc0">wait()</span></span></div><div class="t m0 x17 hf y1af ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">heapq<span class="fc6 ls34">.</span>heappop(<span class="fca">self<span class="fc6 ls34">.</span></span>_queue)[<span class="fc6 ls34">-<span class="fc7">1</span></span>]</span></div><div class="t m0 x0 h9 y2e28 ff1 fs3 fc0 sc0 ls0 wsa0">使用队列来进行线程<span class="_ _6"></span>间通信是一个单向、不确定<span class="_ _6"></span>的过程。通常情况下，你没<span class="_ _6"></span>有办法</div><div class="t m0 x5 h9 y2e29 ff1 fs3 fc0 sc0 ls2d ws132">知道接收数据的线程是什么时候接收到的数据并开始工作的。不过队列对象提供一些<span class="_ _1"></span></div><div class="t m0 x5 h9 y1b63 ff1 fs3 fc0 sc0 ls0 ws14">基本完成的特性，比如下边这个例子中的 <span class="ff6 ws25d">task<span class="_ _7"> </span>done() </span><span class="ls4">和</span><span class="ff6 ws25d">join() </span>：</div><div class="t m0 x5 hf y2e2a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 hf y23e ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x5 h11 y240 ffa fs5 fcd sc0 ls0 ws4"># A thread that produces data</div><div class="t m0 x5 hf y884 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">producer<span class="fc0">(out_q):</span></span></div><div class="t m0 x15 hf y885 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0">running:</span></div><div class="t m0 x16 h11 y886 ffa fs5 fcd sc0 ls0 ws4"># Produce some data</div><div class="t m0 x16 hf y887 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf y70 ff8 fs5 fc0 sc0 ls0 ws13a">out_q<span class="fc6 ls34">.</span>put(data)</div><div class="t m0 x5 h11 y2e2b ffa fs5 fcd sc0 ls0 ws4"># A thread that consumes data</div><div class="t m0 x5 hf y2e2c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(in_q):</span></span></div><div class="t m0 x15 hf y2e2d ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 h11 y2e2e ffa fs5 fcd sc0 ls0 ws4"># Get some data</div><div class="t m0 x16 hf y2e2f ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="ws13a">in_q<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x16 h11 y2e30 ffa fs5 fcd sc0 ls0 ws4"># Process the data</div><div class="t m0 x16 hf y2e31 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 h11 y2e32 ffa fs5 fcd sc0 ls0 ws13b"># Indicate completion</div><div class="t m0 x16 hf ydb7 ff8 fs5 fc0 sc0 ls0 ws13a">in_q<span class="fc6">.</span>task_done()</div><div class="t m0 x5 h11 y8b8 ffa fs5 fcd sc0 ls0 ws4"># Create the shared queue and launch both threads</div><div class="t m0 x5 hf y2e33 ff8 fs5 fc0 sc0 ls32">q<span class="fc6 ls33">=</span><span class="ls0">Queue()</span></div><div class="t m0 x5 hf y2e34 ff8 fs5 fc0 sc0 ls0 ws159">t1 <span class="fc6 ls33">=</span><span class="ws13a">Thread(target<span class="fc6 ls34">=</span><span class="ws13b">consumer, args<span class="fc6 ls34">=</span>(q,))</span></span></div><div class="t m0 x5 hf y1171 ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">Thread(target<span class="fc6 ls34">=</span><span class="ws13b">producer, args<span class="fc6 ls34">=</span>(q,))</span></span></div><div class="t m0 x5 hf y2e35 ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span>start()</div><div class="t m0 x5 hf y2e36 ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span>start()</div><div class="t m0 x5 h11 y2e37 ffa fs5 fcd sc0 ls0 ws4"># Wait for all produced items to be consumed</div><div class="t m0 x5 hf y2e38 ff8 fs5 fc0 sc0 ls34">q<span class="fc6 ls0 ws13a">.<span class="fc0">join()</span></span></div><div class="t m0 x0 h9 y2e39 ff1 fs3 fc0 sc0 ls0 wsa0">如果一个线程需要在<span class="_ _6"></span>一个“消费者”线程处理完特<span class="_ _6"></span>定的数据项时立即得到<span class="_ _6"></span>通知，你</div><div class="t m0 x5 h9 y2e3a ff1 fs3 fc0 sc0 ls1c5 ws1094">可以把要发送的数据和一个 <span class="ff6 ls0 ws1095">Event <span class="ff1 wsa0">放<span class="_ _0"></span>到<span class="_ _6"></span>一<span class="_ _0"></span>起<span class="_ _6"></span>使<span class="_ _0"></span>用，<span class="_ _0"></span>这<span class="_ _6"></span>样<span class="_ _0"></span>“生<span class="_ _6"></span>产<span class="_ _0"></span>者”<span class="_ _0"></span>就<span class="_ _6"></span>可<span class="_ _0"></span>以<span class="_ _6"></span>通<span class="_ _0"></span>过<span class="_ _6"></span>这<span class="_ _0"></span>个</span></span></div><div class="t m0 x5 h7 y2e3b ff4 fs3 fc0 sc0 ls0 ws1096">Ev<span class="_ _1"></span>en<span class="_ _1"></span>t <span class="ff1">对象来监测处理的过程了。示例如下：</span></div><div class="t m0 x5 hf y2e3c ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 hf y2e3d ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0 ws4">Thread, Event</span></span></div><div class="t m0 x5 h11 y2e3e ffa fs5 fcd sc0 ls0 ws4"># A thread that produces data</div><div class="t m0 x5 hf y2e3f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">producer<span class="fc0">(out_q):</span></span></div><div class="t m0 x15 hf y2e40 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0">running:</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.3.<span class="_ _36"> </span>12.3 <span class="ff1 ws1090">线程间通信 </span>450</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
