<div id="pf25b" class="pf w0 h0" data-page-no="25b"><div class="pc pc25b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg25b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y1ab ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">print_wchars(s, len);</div><div class="t m0 x19 hf y1ad ff8 fs5 fc0 sc0 ls0">PyMem_Free(s);</div><div class="t m0 x19 hf y1ae ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y1af ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y288b ff1 fs3 fc0 sc0 ls0 wsa0">在<span class="_ _6"></span>这<span class="_ _6"></span>个<span class="_ _6"></span>实<span class="_ _6"></span>现<span class="_ _6"></span>中，<span class="_ _0"></span><span class="ff6 wsc64">PyUnicode AsWideCharString() </span><span class="ls36 ws158d">创建一个临时的 </span><span class="ff4 ws158e">wc<span class="_ _c"></span>har t<span class="_ _7"> </span><span class="ff1 wsa0">缓<span class="_ _6"></span>冲<span class="_ _0"></span>并</span></span></div><div class="t m0 x5 h7 y39e7 ff1 fs3 fc0 sc0 lse ws158f">复制数据进去。这个缓冲被传递给 <span class="ff4 ls20">C</span><span class="wsd8">然后被释放掉。但是我写这本书的时候<span class="_ _1"></span>，这里可</span></div><div class="t m0 x5 h7 y1ba1 ff1 fs3 fc0 sc0 ls0 ws38">能有个 <span class="ff4 wsa5">bug</span><span class="ws14">，后面的 <span class="ff4 ws5c">Python </span>问题页有介绍。</span></div><div class="t m0 x0 h7 y4d6 ff1 fs3 fc0 sc0 ls13 ws400">如果你知道 <span class="ff4 ls255">C</span><span class="ws1590">函数库需要的字节编码并不是 <span class="ff4 ls0 wsa5">UTF-8<span class="ff1 ws1591">，<span class="_ _6"></span>你<span class="_ _6"></span>可以<span class="_ _6"></span>强<span class="_ _6"></span>制 </span><span class="wsa18">Python <span class="ff1 wsa0">使<span class="_ _6"></span>用<span class="_ _6"></span>扩</span></span></span></span></div><div class="t m0 x5 h9 y39e8 ff1 fs3 fc0 sc0 ls0">展码来执行正确的转换，就像下面这样：</div><div class="t m0 x5 hf y39e9 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_chars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y39ea ff8 fs5 fc0 sc0 ls0 ws4">char *s = 0;</div><div class="t m0 x19 hf y39eb ff8 fs5 fc0 sc0 ls0 ws1305">int len;</div><div class="t m0 x19 hf y39ec ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;es#&quot;, &quot;encoding-name&quot;, &amp;s, &amp;len)) {</div><div class="t m0 x15 hf y39ed ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y39ee ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y39ef ff8 fs5 fc0 sc0 ls0 ws4">print_chars(s, len);</div><div class="t m0 x19 hf y39f0 ff8 fs5 fc0 sc0 ls0">PyMem_Free(s);</div><div class="t m0 x19 hf y39f1 ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y39f2 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y39f3 ff1 fs3 fc0 sc0 ls0 ws38">最后，如果你想直接处理 <span class="ff4 wsc1">Unico<span class="_ _6"></span>de </span>字符串，下面的是例子，演示了底层操作访问：</div><div class="t m0 x5 hf yddb ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_wchars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y39f4 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj;</div><div class="t m0 x19 hf y39f5 ff8 fs5 fc0 sc0 ls0 ws4">int n, len;</div><div class="t m0 x19 hf y39f6 ff8 fs5 fc0 sc0 ls0 ws4">int kind;</div><div class="t m0 x19 hf y2369 ff8 fs5 fc0 sc0 ls0 ws4">void *data;</div><div class="t m0 x19 hf y236b ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;U&quot;, &amp;obj)) {</div><div class="t m0 x15 hf yc77 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y236c ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y236d ff8 fs5 fc0 sc0 ls0 ws4">if (PyUnicode_READY(obj) &lt; 0) {</div><div class="t m0 x15 hf y236e ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y127a ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y9a8 ff8 fs5 fc0 sc0 ls0 ws4">len = PyUnicode_GET_LENGTH(obj);</div><div class="t m0 x19 hf y39f7 ff8 fs5 fc0 sc0 ls0 ws4">kind = PyUnicode_KIND(obj);</div><div class="t m0 x19 hf y39f8 ff8 fs5 fc0 sc0 ls0 ws4">data = PyUnicode_DATA(obj);</div><div class="t m0 x19 hf y3152 ff8 fs5 fc0 sc0 ls0 ws4">for (n = 0; n &lt; len; n++) {</div><div class="t m0 x15 hf y39f9 ff8 fs5 fc0 sc0 ls0 ws4">Py_UCS4 ch = PyUnicode_READ(kind, data, n);</div><div class="t m0 x15 hf y39fa ff8 fs5 fc0 sc0 ls0 ws13b">printf(&quot;%x &quot;, ch);</div><div class="t m0 x19 hf y39fb ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y39fc ff8 fs5 fc0 sc0 ls0">printf(&quot;\n&quot;);</div><div class="t m0 x19 hf y39fd ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y39fe ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y372f ff1 fs3 fc0 sc0 ls0 wsa0">在这个代码中，<span class="_ _c"></span><span class="ff6 ws137a">PyUnicode<span class="_ _7"> </span>KIND() <span class="ff1 ls29f">和</span><span class="ws6a0">PyUnicode<span class="_ _7"> </span>DATA() <span class="ff1 ws1592">这两个宏和 <span class="ff4 ws1593">Unico<span class="_ _6"></span>de </span>的可</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.14.<span class="_ _36"> </span>15.14 <span class="ff1 ws16b">传递 </span><span class="ws342">Unico<span class="_ _0"></span>de <span class="ff1 ws16b">字符串给 </span><span class="ls246">C</span><span class="ff1 ws1573">函数库 </span>594</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
