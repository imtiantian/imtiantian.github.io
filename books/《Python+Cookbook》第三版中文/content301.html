<div id="pf12d" class="pf w0 h0" data-page-no="12d"><div class="pc pc12d w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg12d.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h7 y2a ff1 fs3 fc0 sc0 ls9a">用<span class="ff4 ls0 wsb6c">yield </span><span class="ls36 ws14a">语句可以让你写出非常漂亮的代码<span class="_ _c"></span>，它消除了递归但是看上去又很像递归实<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">现，代码很简洁。</div><div class="t m0 x5 hd yf90 ff2 fs4 fc4 sc0 ls0 ws211">10.23<span class="_ _e"> </span>8.23 <span class="ff1">循环引用数据结构的内存管理</span></div><div class="t m0 x5 he yf91 ff2 fs2 fc4 sc0 ls0 wsadf">10.23.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y1fb9 ff1 fs3 fc0 sc0 ls0 ws558">你的程序创建了很多循环引用数据结构 <span class="ff4 wsa5">(</span><span class="wsa0">比如树、图、观察者模式等<span class="ff4 ls1b">)</span>，你碰到了内</span></div><div class="t m0 x5 h9 y1fba ff1 fs3 fc0 sc0 ls0">存管理难题。</div><div class="t m0 x5 he y1fbb ff2 fs2 fc4 sc0 ls0 wsadf">10.23.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y1fbc ff1 fs3 fc0 sc0 ls3a ws153">一个简单的循环引用数据结构例子就是一个树形结构，双亲节点有指针指向孩子节</div><div class="t m0 x5 h9 y2d6 ff1 fs3 fc0 sc0 ls12 wsb6d">点，孩子节点又返回来指向<span class="_ _1"></span>双亲节点。这种情况下<span class="_ _1"></span>，可以考虑使用 <span class="ff6 ls0 wsb6e">weakref <span class="ff1 wsa0">库中<span class="_ _6"></span>的<span class="_ _6"></span>弱</span></span></div><div class="t m0 x5 h9 y2d7 ff1 fs3 fc0 sc0 ls0">引用。例如：</div><div class="t m0 x5 h10 y1fbd ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">weakref</span></div><div class="t m0 x5 hf y1fbe ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Node<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1fbf ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, value):</span></span></span></div><div class="t m0 x16 hf y1fc0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">value </span><span class="ls32">=</span><span class="fc0">value</span></span></div><div class="t m0 x16 hf yfcf ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_parent </span><span class="ls33">=</span></span>None</div><div class="t m0 x16 hf y1fc1 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">children </span><span class="ls32">=</span><span class="fc0">[]</span></span></div><div class="t m0 x15 hf yd82 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__repr__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y1fc2 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">Node({!r:})<span class="ff9 ws13b">&apos;</span><span class="fc6 ls34">.</span><span class="fc0">format(<span class="fca">self<span class="fc6 ls34">.</span></span>value)</span></span></span></div><div class="t m0 x15 h11 y1fc3 ffa fs5 fcd sc0 ls0 ws4"># property that manages the parent as a weak-reference</div><div class="t m0 x15 h10 y1fc4 ff7 fs5 fc12 sc0 ls0">@property</div><div class="t m0 x15 hf y163e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">parent<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1fc5 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13c">None </span><span class="ws157">if <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0 ws155">_parent </span></span></span>is <span class="ff8 ws13c">None </span><span class="ws15a">else <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_parent()</span></span></span></span></span></div><div class="t m0 x15 h10 y1fc6 ff7 fs5 fc12 sc0 ls0">@parent.setter</div><div class="t m0 x15 hf y1640 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">parent<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1641 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_parent </span><span class="ls33">=</span><span class="fc0">weakref</span><span class="ls34">.</span><span class="fc0">ref(node)</span></span></div><div class="t m0 x15 hf y1642 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add_child<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, child):</span></span></span></div><div class="t m0 x16 hf y1643 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">children</span><span class="ls34">.</span><span class="fc0">append(child)</span></span></div><div class="t m0 x16 hf y1fc7 ff8 fs5 fc0 sc0 ls0 ws13a">child<span class="fc6 ls34">.</span><span class="ws145">parent <span class="fc6 ls33">=</span><span class="fca">self</span></span></div><div class="t m0 x0 h7 y1fc8 ff1 fs3 fc0 sc0 ls0 wsc">这种是想方式允许 <span class="ff4 wsb6f">paren<span class="_ _1"></span>t <span class="ff1">静默终止。例如：</span></span></div><div class="t m0 x5 hf y1646 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13c">root <span class="fc6 ls32">=</span><span class="ws13a">Node(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">parent<span class="ff9 ws13b">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y1647 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">c1 <span class="fc6 ls33">=</span><span class="ws13a">Node(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">child<span class="ff9 ws13b">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y1648 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">root<span class="fc6 ls34">.</span>add_child(c1)</span></div><div class="t m0 x5 hf y1649 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0 ws13a">(c1<span class="fc6">.</span>parent)</span></span></div><div class="t m0 x5 hf y164a ff8 fs5 fc8 sc0 ls0 ws13a">Node(<span class="ff9 ws13b">&apos;</span>parent<span class="ff9 ws13b">&apos;</span>)</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.23.<span class="_ _5"> </span>8.23 <span class="ff1 wsb70">循环引用数据结构的内存管理 </span>292</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
