<div id="pf244" class="pf w0 h0" data-page-no="244"><div class="pc pc244 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg244.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">17.8.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y236 ff1 fs3 fc0 sc0 ls0 ws145c">在<span class="_ _6"></span>涉<span class="_ _6"></span>及<span class="_ _6"></span>到 <span class="ff4 ls274">C</span><span class="ls275">和</span><span class="ff4 ws145d">Python </span><span class="lsf wsdb">的高级程序中，很多事情一起做是很常见的—<span class="_ _1d"></span>—可能是对<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y237 ff4 fs3 fc0 sc0 ls0 wsa5">C<span class="ff1 ls276">、</span>Python<span class="ff1 ls277">、</span><span class="ls274">C</span><span class="ff1 wsa0">线<span class="_ _6"></span>程、<span class="_ _6"></span></span><span class="ws145e">Python <span class="ff1 lsf wsdb">线程的混合使用。只要你确保解释器被正确的初始化<span class="_ _c"></span>，<span class="_ _1"></span></span></span></div><div class="t m0 x5 h7 y238 ff1 fs3 fc0 sc0 ls0 ws38">并且涉及到解释器的 <span class="ff4 ls8">C</span><span class="ws14">代码执行了正确的 <span class="ff4 ws145f">GIL </span>管理，应该没什么问题。</span></div><div class="t m0 x0 h9 y278 ff1 fs3 fc0 sc0 ls36 ws1460">要注意的是调用 <span class="ff6 ls0 ws65d">PyGILState Ensure()<span class="_ _7"> </span></span><span class="ws14a">并不会立刻抢占或中断解释器。如果有其<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y279 ff1 fs3 fc0 sc0 ls2d ws1461">他代码正在执行<span class="_ _1"></span>，这个函数被中断知道那个执行代码释放掉 <span class="ff4 ls0 wsa5">GIL</span><span class="ws132">。在内部，解释器会<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y27a ff1 fs3 fc0 sc0 ls1e ws111">执行周期性的线程切换<span class="_ _1"></span>，因此如果其他线程在执行<span class="_ _1"></span>，调用者最终还是可以运行的（<span class="_ _1"></span>尽</div><div class="t m0 x5 h9 y27b ff1 fs3 fc0 sc0 ls0 wsa0">管可能要先等一会）<span class="_ _f"></span>。</div><div class="t m0 x5 hd y27c ff2 fs4 fc4 sc0 ls0 ws211">17.9<span class="_ _e"> </span>15.9 <span class="ff1 lsac">用</span><span class="ws1462">WSIG <span class="ff1 ws165">包装 </span><span class="ls23d">C</span><span class="ff1">代码</span></span></div><div class="t m0 x5 he y27d ff2 fs2 fc4 sc0 ls0 ws212">17.9.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y4f6 ff1 fs3 fc0 sc0 ls0 ws1463">你想<span class="_ _6"></span>让<span class="_ _6"></span>你<span class="_ _6"></span>写的 <span class="ff4 ls278">C</span><span class="ls10 ws1464">代码作为一个 <span class="ff4 ls278">C</span><span class="ws1465">扩展模块来访问，想通过使用 </span></span><span class="ff4 fc3 ws1466">Swig <span class="ff1 ls10 wsdf">包装生成器<span class="_ _1"></span></span></span></div><div class="t m0 x5 h9 y1721 ff1 fs3 fc0 sc0 ls0">来完成。</div><div class="t m0 x5 he y37c8 ff2 fs2 fc4 sc0 ls0 ws212">17.9.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y37c9 ff4 fs3 fc0 sc0 ls0 ws1467">Swig <span class="ff1 ls3d ws2bd">通过解析 </span><span class="ls24b">C<span class="ff1 ls3d ws435">头文件并自动创建扩展代码来操作。要使用它，你先要有一个 </span></span>C</div><div class="t m0 x5 h9 y37ca ff1 fs3 fc0 sc0 ls0">头文件。例如，我们示例的头文件如下：</div><div class="t m0 x5 hf y32b5 ff8 fs5 fc0 sc0 ls0 ws4">/* sample.h */</div><div class="t m0 x5 hf y37cb ff8 fs5 fc0 sc0 ls0 ws4">#include &lt;math.h&gt;</div><div class="t m0 x5 hf y37cc ff8 fs5 fc0 sc0 ls0 ws4">extern int gcd(int, int);</div><div class="t m0 x5 hf y37cd ff8 fs5 fc0 sc0 ls0 ws4">extern int in_mandel(double x0, double y0, int n);</div><div class="t m0 x5 hf y37ce ff8 fs5 fc0 sc0 ls0 ws4">extern int divide(int a, int b, int *remainder);</div><div class="t m0 x5 hf y37cf ff8 fs5 fc0 sc0 ls0 ws4">extern double avg(double *a, int n);</div><div class="t m0 x5 hf ya2a ff8 fs5 fc0 sc0 ls0 ws4">typedef struct Point {</div><div class="t m0 x15 hf y3064 ff8 fs5 fc0 sc0 ls0 ws13b">double x,y;</div><div class="t m0 x5 hf y37d0 ff8 fs5 fc0 sc0 ls0 ws4">} Point;</div><div class="t m0 x5 hf y3764 ff8 fs5 fc0 sc0 ls0 ws4">extern double distance(Point *p1, Point *p2);</div><div class="t m0 x0 h7 ya98 ff1 fs3 fc0 sc0 ls68 ws120e">一旦你有了这个头文件，下一步就是编写一个 <span class="ff4 ls0 ws1468">Swig” <span class="ff1 wsa0">接口</span><span class="ls279">”</span><span class="ff1 wsa0">文件。按<span class="_ _6"></span>照约定，这些</span></span></div><div class="t m0 x5 h7 y37d1 ff1 fs3 fc0 sc0 ls0 wsa0">文件以<span class="ff4 ws1469">”<span class="_ _1d"></span>.i” <span class="ff1">后缀并且类似下面这样：</span></span></div><div class="t m0 x5 hf y37d2 ff8 fs5 fc0 sc0 ls0 ws4">// sample.i - Swig interface</div><div class="t m0 x5 hf y37d3 ff8 fs5 fc0 sc0 ls0 ws4">%module sample</div><div class="t m0 x5 hf y37d4 ff8 fs5 fc0 sc0 ls0">%{</div><div class="t m0 x5 hf y37d5 ff8 fs5 fc0 sc0 ls0 ws4">#include &quot;sample.h&quot;</div><div class="t m0 x5 hf y37d6 ff8 fs5 fc0 sc0 ls0">%}</div><div class="t m0 x5 hf y37d7 ff8 fs5 fc0 sc0 ls0 ws4">/* Customizations */</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.9.<span class="_ _36"> </span>15.9 <span class="ff1 ls81">用</span><span class="ws146a">WSIG <span class="ff1 ws16b">包装 </span><span class="ls246">C</span><span class="ff1 ws146b">代码 </span>571</span></div><a class="l" href="http://www.swig.org/"><div class="d m1" style="border-style:none;position:absolute;left:651.280500px;bottom:767.328000px;width:89.089000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
