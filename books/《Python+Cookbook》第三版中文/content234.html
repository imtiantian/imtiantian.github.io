<div id="pfea" class="pf w0 h0" data-page-no="ea"><div class="pc pcea w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgea.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">9.11.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y236 ff1 fs3 fc0 sc0 ls56 ws1fa">通过使用生成器和协程可以使得回调函数内联在某个函数中<span class="_ _c"></span>。为了演示说明<span class="_ _1"></span>，假<span class="_ _1"></span></div><div class="t m0 x5 h7 y237 ff1 fs3 fc0 sc0 ls22 ws99a">设你有如下所示的一个执行某种计算任务然后调用一个回调函数的函数 <span class="ff4 ls0 wsa5">(<span class="ff1 ws2eb">参考 </span><span class="ws99b">7.10 <span class="ff1">小</span></span></span></div><div class="t m0 x5 h7 y238 ff1 fs3 fc0 sc0 lsb">节<span class="ff4 ls0 wsa5">)<span class="ff1">：</span></span></div><div class="t m0 x5 hf y1983 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">apply_async<span class="fc0 ws13b">(func, args, <span class="fc6 ls34">*</span><span class="ws4">, callback):</span></span></span></div><div class="t m0 x15 h11 y1984 ffa fs5 fcd sc0 ls0 ws4"># Compute the result</div><div class="t m0 x15 hf y1985 ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="ws13a">func(<span class="fc6 ls34">*</span>args)</span></div><div class="t m0 x15 h11 y1986 ffa fs5 fcd sc0 ls0 ws4"># Invoke the callback with the result</div><div class="t m0 x15 hf y1987 ff8 fs5 fc0 sc0 ls0">callback(result)</div><div class="t m0 x0 h9 y1988 ff1 fs3 fc0 sc0 ls149 ws99c">接下来让我们看一下下面的代码<span class="_ _c"></span>，<span class="_ _6"></span>它包含了一个 <span class="ff6 ls0 ws99d">Async <span class="ff1 ws99e">类<span class="_ _6"></span>和<span class="_ _6"></span>一<span class="_ _0"></span>个 </span><span class="ws470">inlined async</span></span></div><div class="t m0 x5 h9 y1989 ff1 fs3 fc0 sc0 ls0">装饰器：</div><div class="t m0 x5 hf y198a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 hf y198b ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">wraps</span></span></div><div class="t m0 x5 hf y198c ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Async<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y198d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, func, args):</span></span></span></div><div class="t m0 x16 hf y198e ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">func </span><span class="ls33">=</span><span class="fc0">func</span></span></div><div class="t m0 x16 hf y198f ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">args </span><span class="ls33">=</span><span class="fc0">args</span></span></div><div class="t m0 x5 hf yba1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">inlined_async<span class="fc0">(func):</span></span></div><div class="t m0 x15 hf y1990 ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x15 hf y1991 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0">args):</span></span></span></div><div class="t m0 x16 hf y1992 ff8 fs5 fc0 sc0 ls32">f<span class="fc6 ls33">=</span><span class="ls0 ws13a">func(<span class="fc6 ls34">*</span>args)</span></div><div class="t m0 x16 hf y1993 ff8 fs5 fc0 sc0 ls0 ws150">result_queue <span class="fc6 ls33">=</span>Queue()</div><div class="t m0 x16 hf y1994 ff8 fs5 fc0 sc0 ls0 ws13a">result_queue<span class="fc6">.</span>put(<span class="fca">None</span>)</div><div class="t m0 x16 hf y1995 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1996 ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="ws13a">result_queue<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x17 hf y1997 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x18 hf y1998 ff8 fs5 fc0 sc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">f<span class="fc6 ls34">.</span>send(result)</span></div><div class="t m0 x18 hf y1999 ff8 fs5 fc0 sc0 ls0 ws13a">apply_async(a<span class="fc6 ls34">.</span><span class="ws13b">func, a<span class="fc6 ls34">.</span>args, callback<span class="fc6 ls34">=</span></span>result_queue<span class="fc6 ls34">.</span>put)</div><div class="t m0 x17 hf y199a ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws13a">StopIteration<span class="fc0">:</span></span></div><div class="t m0 x18 h10 y199b ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x15 hf y199c ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x0 h9 y199d ff1 fs3 fc0 sc0 ls0 wsc">这两个代码片段允许你使用 <span class="ff6 ws19e">yield </span>语句内联回调步骤。比如：</div><div class="t m0 x5 hf y199e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y199f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></div><div class="t m0 x5 h10 y19a0 ff7 fs5 fc12 sc0 ls0">@inlined_async</div><div class="t m0 x5 hf y19a1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test<span class="fc0">():</span></span></div><div class="t m0 x15 hf y19a2 ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=<span class="ff7 fca ls0 ws16a">yield </span></span><span class="ls0 ws4">Async(add, (<span class="fc7 ls34">2</span></span>,<span class="fc7 ls34">3</span><span class="ls0">))</span></div><div class="t m0 x15 hf y19a3 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0">(r)</span></div><div class="t m0 x15 hf y19a4 ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=<span class="ff7 fca ls0 ws16a">yield </span></span><span class="ls0 ws4">Async(add, (<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">hello<span class="ff9 ls34">&apos;</span></span></span>,<span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">world</span>&apos;</span><span class="ls0">))</span></div><div class="t m0 x15 hf y19a5 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0">(r)</span></div><div class="t m0 x15 hf y19a6 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0 ls34">(</span><span class="fc7">10<span class="fc0">):</span></span></span></span></div><div class="t m0 x16 hf y19a7 ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=<span class="ff7 fca ls0 ws16a">yield </span></span><span class="ls0 ws4">Async(add, (n, n))</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">9.11.<span class="_ _5"> </span>7.11 <span class="ff1 ws999">内联回调函数 </span>225</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
