<div id="pf9e" class="pf w0 h0" data-page-no="9e"><div class="pc pc9e w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg9e.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y15f ff8 fs5 fc8 sc0 ls0">0</div><div class="t m0 x5 h11 y160 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Reassign a slice</span></div><div class="t m0 x5 hf y956 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">m[<span class="fc7 ls34">0<span class="fc0">:</span><span class="ls0">11</span></span><span class="ls33">]<span class="fc6 ls32">=</span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span></span><span class="fc9 ws13b">Hello World<span class="ff9">&apos;</span></span></span></div><div class="t m0 x5 hf y957 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">m<span class="fc6 ls0 ws13a">.<span class="fc0">close()</span></span></span></div><div class="t m0 x5 h11 y959 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Verify that changes were made</span></div><div class="t m0 x5 hf y95a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">with <span class="ff8 ws13a">open<span class="fc0 ls34">(<span class="ff9 fc9">&apos;</span></span><span class="fc9">data<span class="ff9 ls34">&apos;</span><span class="fc0 ls32">,</span><span class="ff9 ls34">&apos;</span>rb<span class="ff9 ls34">&apos;</span><span class="fc0 ls32">)</span></span></span><span class="ws160">as <span class="ff8 fc0">f:</span></span></span></div><div class="t m0 x5 hf y95b ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca ws156">print<span class="ff8 fc0 ws13a">(f<span class="fc6 ls34">.</span>read(<span class="fc7">11</span>))</span></span></div><div class="t m0 x5 h10 y95c ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y9f3 ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">Hello World<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y9f4 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y9f5 ff6 fs3 fc0 sc0 ls0 ws6a4">mmap() <span class="ff1 ws6a5">返回的 </span><span class="ws6a6">mmap <span class="ff1 wsa0">对象同样也可以作为一个上下文管理器来使用，这时候底层的</span></span></div><div class="t m0 x5 h9 y9f6 ff1 fs3 fc0 sc0 ls0">文件会被自动关闭。比如：</div><div class="t m0 x5 hf y114c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">with <span class="ff8 fc0 ws13a">memory_map(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">data<span class="ff9 ls34">&apos;</span></span><span class="ls32">)</span></span><span class="ws160">as <span class="ff8 fc0">m:</span></span></span></div><div class="t m0 x5 hf y114d ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0 ls34">(</span><span class="ff8 ws13a">len<span class="fc0">(m))</span></span></span></div><div class="t m0 x5 hf y114e ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0 ws13a">(m[<span class="fc7">0</span><span class="ls34">:</span><span class="fc7">10</span>])</span></span></div><div class="t m0 x5 h10 y114f ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y1150 ff8 fs5 fc8 sc0 ls0">1000000</div><div class="t m0 x5 hf y1151 ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">Hello World<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y1152 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">m<span class="fc6 ls0 ws13a">.<span class="fc0">closed</span></span></span></div><div class="t m0 x5 hf y1153 ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y1154 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1155 ff1 fs3 fc0 sc0 ls0 ws6a7">默<span class="_ _6"></span>认<span class="_ _6"></span>情<span class="_ _6"></span>况<span class="_ _6"></span>下， <span class="ff6 ws67b">memeory map()<span class="_ _18"> </span></span><span class="ls36 ws14a">函数打开的文件同时支持读和写操作<span class="_ _c"></span>。任何的修改<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y1156 ff1 fs3 fc0 sc0 ls0 ws3b8">内容都会复制回原来的文件中。如果需要只读的访问模式，可以给参数 <span class="ff6 ws496">access </span>赋值为</div><div class="t m0 x5 h9 y1157 ff6 fs3 fc0 sc0 ls0 ws17a">mmap.ACCESS<span class="_ _7"> </span>READ <span class="ff1">。比如：</span></div><div class="t m0 x5 hf y1027 ff8 fs5 fc0 sc0 ls32">m<span class="fc6 ls33">=</span><span class="ls0 ws13b">memory_map(filename, mmap<span class="fc6 ls34">.</span>ACCESS_READ)</span></div><div class="t m0 x0 h9 y1158 ff1 fs3 fc0 sc0 ls0 wsa0">如<span class="_ _12"></span>果<span class="_ _12"></span>你<span class="_ _24"></span>想<span class="_ _12"></span>在<span class="_ _12"></span>本<span class="_ _12"></span>地<span class="_ _24"></span>修<span class="_ _12"></span>改<span class="_ _12"></span>数<span class="_ _24"></span>据，<span class="_ _12"></span>但<span class="_ _12"></span>是<span class="_ _24"></span>又<span class="_ _12"></span>不<span class="_ _12"></span>想<span class="_ _24"></span>将<span class="_ _12"></span>修<span class="_ _12"></span>改<span class="_ _12"></span>写<span class="_ _24"></span>回<span class="_ _12"></span>到<span class="_ _12"></span>原<span class="_ _24"></span>始<span class="_ _12"></span>文<span class="_ _12"></span>件<span class="_ _12"></span>中，<span class="_ _24"></span>可<span class="_ _12"></span>以<span class="_ _12"></span>使<span class="_ _24"></span>用</div><div class="t m0 x5 h9 y1159 ff6 fs3 fc0 sc0 ls0 ws17a">mmap.ACCESS<span class="_ _7"> </span>COPY <span class="ff1">：</span></div><div class="t m0 x5 hf y115a ff8 fs5 fc0 sc0 ls32">m<span class="fc6 ls33">=</span><span class="ls0 ws13b">memory_map(filename, mmap<span class="fc6 ls34">.</span>ACCESS_COPY)</span></div><div class="t m0 x5 he yb79 ff2 fs2 fc4 sc0 ls0 ws212">7.10.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y115b ff1 fs3 fc0 sc0 lse ws6a8">为了随机访问文件的内容，使用 <span class="ff6 ls0 ws179">mmap </span><span class="wsd8">将文件映射到内存中是一个高效和优雅的方<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y115c ff1 fs3 fc0 sc0 ls0 ws495">法。例如，你无需打开一个文件并执行大量的 <span class="ff6 ws25d">seek() </span><span class="ls5">，</span><span class="ff6 ws25d">read() </span><span class="ls5">，</span><span class="ff6 ws23a">write() </span>调用，只</div><div class="t m0 x5 h9 y115d ff1 fs3 fc0 sc0 ls0">需要简单的映射文件并使用切片操作访问数据即可。</div><div class="t m0 x0 h9 y115e ff1 fs3 fc0 sc0 ls0 ws6a9">一般<span class="_ _6"></span>来讲， <span class="ff6 ws6aa">mmap() </span><span class="lse wsd8">所暴露的内存看上去就是一个二进制数组对象。但是<span class="_ _1"></span>，你可以</span></div><div class="t m0 x5 h9 y115f ff1 fs3 fc0 sc0 ls0">使用一个内存视图来解析其中的数据。比如：</div><div class="t m0 x5 hf y1160 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">m<span class="fc6 ls33">=</span><span class="ls0 ws13a">memory_map(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">data<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 h11 y1161 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Memoryview of unsigned integers</span></div><div class="t m0 x5 hf y1162 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">v<span class="fc6 ls33">=</span><span class="ls0 ws13a">memoryview(m)<span class="fc6 ls34">.</span>cast(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">I<span class="ff9">&apos;</span></span></span>)</span></span></div><div class="t m0 x5 hf y1163 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">v[<span class="fc7 ls34">0</span><span class="ls33">]<span class="fc6 ls32">=</span></span><span class="fc7">7</span></span></div><div class="t m0 x5 hf y1164 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">m[<span class="fc7 ls34">0<span class="fc0">:</span>4</span>]</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">7.10.<span class="_ _5"> </span>5.10 <span class="ff1 ws509">内存映射的二进制文件 </span>149</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
