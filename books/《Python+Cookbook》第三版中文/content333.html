<div id="pf14d" class="pf w0 h0" data-page-no="14d"><div class="pc pc14d w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg14d.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls13 wse5">来<span class="_ _1"></span>，并且接下来仅仅使用剩余的位置和关键字参数去调用这个函数时，这个特殊参数<span class="_ _c"></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0 ws14">会被排除在外。也就是说，它并不会被纳入到 <span class="ff6 ws1f3">**kwargs </span>中去。</div><div class="t m0 x0 h9 y8dd ff1 fs3 fc0 sc0 ls3a ws153">还有一个难点就是如何去处理被添加的参数与被包装函数参数直接的名字冲突。例</div><div class="t m0 x5 h9 y99 ff1 fs3 fc0 sc0 ls0 wsc13">如，如<span class="_ _6"></span>果装饰<span class="_ _6"></span>器 <span class="ff6 wsc14">@optional debug </span><span class="ls3d wsad8">作用在一个已经拥有一个 </span><span class="ff6 wsc14">debug </span><span class="ls3d ws164">参数的函数上时会</span></div><div class="t m0 x5 h9 y9a ff1 fs3 fc0 sc0 ls0">有问题。这里我们增加了一步名字检查。</div><div class="t m0 x0 h9 y30 ff1 fs3 fc0 sc0 ls3a ws153">上面的方案还可以更完美一点，因为精明的程序员应该发现了被包装函数的函数签</div><div class="t m0 x5 h9 y31 ff1 fs3 fc0 sc0 ls0">名其实是错误的。例如：</div><div class="t m0 x5 h10 y22e1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fc12">@optional_debug</span></div><div class="t m0 x5 hf y22e2 ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">def <span class="ff8 fcb ws13a">add<span class="fc0">(x,y):</span></span></span></div><div class="t m0 x5 hf y22e3 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws146">return <span class="ff8 fc0 ls34">x<span class="fc6 ls0 ws13a">+<span class="fc0">y</span></span></span></span></div><div class="t m0 x5 h10 y22e4 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 h10 y22e5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">inspect</span></span></div><div class="t m0 x5 hf y22e6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0 ws13a">(inspect<span class="fc6 ls34">.</span>signature(add))</span></span></div><div class="t m0 x5 hf y22e7 ff8 fs5 fc8 sc0 ls0 ws4">(x, y)</div><div class="t m0 x5 hf y22e8 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y22e9 ff1 fs3 fc0 sc0 ls0">通过如下的修改，可以解决这个问题：</div><div class="t m0 x5 hf y22ea ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">wraps</span></span></div><div class="t m0 x5 h10 y22eb ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">inspect</span></div><div class="t m0 x5 hf y22ec ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">optional_debug<span class="fc0">(func):</span></span></div><div class="t m0 x15 hf y22ed ff7 fs5 fca sc0 ls0 ws157">if <span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">debug</span><span class="ls33">&apos;</span></span>in <span class="ff8 fc0 ws13a">inspect<span class="fc6 ls34">.</span>getargspec(func)<span class="fc6">.</span>args:</span></div><div class="t m0 x16 hf y22ee ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">debug argument already defined<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y22ef ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x15 hf y22f0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws4">args, debug</span><span class="ls34">=</span><span class="fca">False<span class="fc0 ls32">,</span></span><span class="ls34">**</span><span class="fc0">kwargs):</span></span></span></div><div class="t m0 x16 hf y22f1 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0">debug:</span></div><div class="t m0 x17 hf y22f2 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Calling</span>&apos;</span><span class="ls0 ws13b">, func</span><span class="fc6">.</span><span class="ls0">__name__)</span></span></div><div class="t m0 x16 hf y22f3 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">func(<span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs)</span></div><div class="t m0 x15 hf y22f4 ff8 fs5 fc0 sc0 ls0 ws158">sig <span class="fc6 ls32">=</span><span class="ws13a">inspect<span class="fc6 ls34">.</span>signature(func)</span></div><div class="t m0 x15 hf y22f5 ff8 fs5 fc0 sc0 ls0 ws15f">parms <span class="fc6 ls33">=</span><span class="fca ws13a">list<span class="fc0">(sig<span class="fc6">.</span>parameters<span class="fc6">.</span>values())</span></span></div><div class="t m0 x15 hf y22f6 ff8 fs5 fc0 sc0 ls0 ws13a">parms<span class="fc6">.</span>append(inspect<span class="fc6 ls34">.</span>Parameter(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">debug<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x18 hf y205 ff8 fs5 fc0 sc0 ls0 ws13a">inspect<span class="fc6">.</span>Parameter<span class="fc6 ls34">.</span>KEYWORD_ONLY,</div><div class="t m0 x18 hf y22f7 ff8 fs5 fc0 sc0 ls0 ws13a">default<span class="fc6">=<span class="fca">False</span></span>))</div><div class="t m0 x15 hf y22f8 ff8 fs5 fc0 sc0 ls0 ws13a">wrapper<span class="fc6 ls34">.</span><span class="ws147">__signature__ <span class="fc6 ls32">=</span></span>sig<span class="fc6">.</span>replace(parameters<span class="fc6 ls34">=</span>parms)</div><div class="t m0 x15 hf y22f9 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x0 h9 y9ec ff1 fs3 fc0 sc0 ls0 ws38">通过这样的修改，包装后的函数签名就能正确的显示 <span class="ff6 ws17d">debug </span>参数的存在了。例如：</div><div class="t m0 x5 h10 y22fa ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fc12">@optional_debug</span></div><div class="t m0 x5 hf y22fb ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">def <span class="ff8 fcb ws13a">add<span class="fc0">(x,y):</span></span></span></div><div class="t m0 x5 hf y22fc ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws146">return <span class="ff8 fc0 ls34">x<span class="fc6 ls0 ws13a">+<span class="fc0">y</span></span></span></span></div><div class="t m0 x5 h10 y22fd ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y22fe ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0 ws13a">(inspect<span class="fc6 ls34">.</span>signature(add))</span></span></div><div class="t m0 x5 hf y22ff ff8 fs5 fc8 sc0 ls0 ws4">(x, y, *, debug=False)</div><div class="t m0 x5 hf y2300 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">add(<span class="fc7 ls34">2</span>,<span class="fc7 ls34">3</span>)</span></div><div class="t m0 x5 hf y2301 ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf y2302 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.11.<span class="_ _5"> </span>9.11 <span class="ff1 wsb70">装饰器为被包装函数增加参数 </span>324</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
