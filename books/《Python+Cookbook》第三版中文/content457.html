<div id="pf1c9" class="pf w0 h0" data-page-no="1c9"><div class="pc pc1c9 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1c9.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1401 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1402 ff1 fs3 fc0 sc0 ls3a ws153">编写涉及到大量的线程间同步问题的代码会让你痛不欲生。比较合适的方式是使用</div><div class="t m0 x5 h7 y2822 ff1 fs3 fc0 sc0 ls12 ws108b">队列来进行线程间通信或者每个把线程当作一个 <span class="ff4 ls0 wsa5">A<span class="_ _1"></span>ctor<span class="ff1 ls12 ws108c">，利用 </span><span class="ws108d">A<span class="_ _1"></span>ctor <span class="ff1 wsa0">模<span class="_ _6"></span>型来<span class="_ _6"></span>控制<span class="_ _6"></span>并<span class="_ _6"></span>发。</span></span></span></div><div class="t m0 x5 h7 y2823 ff1 fs3 fc0 sc0 ls0 ws14">下一节将会介绍到队列，而 <span class="ff4 wsbb9">A<span class="_ _1"></span>ctor <span class="ff1 ws14">模型将在 </span><span class="ws2aa">12.10 <span class="ff1">节介绍。</span></span></span></div><div class="t m0 x5 hd y2e00 ff2 fs4 fc4 sc0 ls0 ws211">14.3<span class="_ _e"> </span>12.3 <span class="ff1">线程间通信</span></div><div class="t m0 x5 he y2e01 ff2 fs2 fc4 sc0 ls0 ws212">14.3.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 yb00 ff1 fs3 fc0 sc0 ls0">你的程序中有多个线程，你需要在这些线程之间安全地交换信息或数据</div><div class="t m0 x5 he y2e02 ff2 fs2 fc4 sc0 ls0 ws212">14.3.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y2e03 ff1 fs3 fc0 sc0 ls14 ws108e">从一个线程向另一个线程发送数据最安全的方式可能就是使用 <span class="ff6 ls0 ws106c">queue <span class="ff1 wsa0">库中<span class="_ _6"></span>的<span class="_ _6"></span>队<span class="_ _6"></span>列</span></span></div><div class="t m0 x5 h9 y2e04 ff1 fs3 fc0 sc0 ls3a ws515">了。创建一个被多个线程共享的 <span class="ff6 ls0 ws1ce">Queue </span><span class="ws108f">对象，这些线程通过使用 <span class="ff6 ls0 ws1ce">put() </span><span class="lsad">和<span class="ff6 ls0 ws1ce">get() <span class="ff1 wsa0">操作</span></span></span></span></div><div class="t m0 x5 h9 y1f9 ff1 fs3 fc0 sc0 ls0">来向队列中添加或者删除元素。例如：</div><div class="t m0 x5 hf y2e05 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 hf yefb ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x5 h11 y2e06 ffa fs5 fcd sc0 ls0 ws4"># A thread that produces data</div><div class="t m0 x5 hf y2e07 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">producer<span class="fc0">(out_q):</span></span></div><div class="t m0 x15 hf y2e08 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 h11 y2e09 ffa fs5 fcd sc0 ls0 ws4"># Produce some data</div><div class="t m0 x16 hf y2e0a ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf y2e0b ff8 fs5 fc0 sc0 ls0 ws13a">out_q<span class="fc6 ls34">.</span>put(data)</div><div class="t m0 x5 h11 y2e0c ffa fs5 fcd sc0 ls0 ws4"># A thread that consumes data</div><div class="t m0 x5 hf y2e0d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(in_q):</span></span></div><div class="t m0 x15 hf y2e0e ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x5 h11 y2e0f ffa fs5 fcd sc0 ls0 ws4"># Get some data</div><div class="t m0 x16 hf y2e10 ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="ws13a">in_q<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x16 h11 y2e11 ffa fs5 fcd sc0 ls0 ws4"># Process the data</div><div class="t m0 x16 hf y2e12 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 h11 y2e13 ffa fs5 fcd sc0 ls0 ws4"># Create the shared queue and launch both threads</div><div class="t m0 x5 hf y20da ff8 fs5 fc0 sc0 ls32">q<span class="fc6 ls33">=</span><span class="ls0">Queue()</span></div><div class="t m0 x5 hf y20db ff8 fs5 fc0 sc0 ls0 ws159">t1 <span class="fc6 ls33">=</span><span class="ws13a">Thread(target<span class="fc6 ls34">=</span><span class="ws13b">consumer, args<span class="fc6 ls34">=</span>(q,))</span></span></div><div class="t m0 x5 hf y20dc ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">Thread(target<span class="fc6 ls34">=</span><span class="ws13b">producer, args<span class="fc6 ls34">=</span>(q,))</span></span></div><div class="t m0 x5 hf y20dd ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span>start()</div><div class="t m0 x5 hf y8d9 ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span>start()</div><div class="t m0 x0 h9 y20de ff6 fs3 fc0 sc0 ls0 ws30d">Queue <span class="ff1 wsa0">对象已经<span class="_ _6"></span>包含了必要<span class="_ _6"></span>的锁，所以你<span class="_ _6"></span>可以通过它<span class="_ _6"></span>在多个线程<span class="_ _6"></span>间多安全地<span class="_ _6"></span>共享数</span></div><div class="t m0 x5 h9 y2e14 ff1 fs3 fc0 sc0 ls1e ws111">据<span class="_ _1"></span>。当使用队列时，协调生产者和消<span class="_ _1"></span>费者的关闭问题可能会有一些麻烦。一个通<span class="_ _1"></span>用的</div><div class="t m0 x5 h9 y20e0 ff1 fs3 fc0 sc0 ls0 wsa0">解<span class="_ _6"></span>决方<span class="_ _6"></span>法<span class="_ _6"></span>是<span class="_ _6"></span>在<span class="_ _6"></span>队<span class="_ _6"></span>列中<span class="_ _6"></span>放<span class="_ _6"></span>置<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>特殊<span class="_ _6"></span>的<span class="_ _6"></span>只，<span class="_ _6"></span>当<span class="_ _6"></span>消<span class="_ _6"></span>费者<span class="_ _6"></span>读<span class="_ _6"></span>到<span class="_ _6"></span>这<span class="_ _6"></span>个<span class="_ _6"></span>值的<span class="_ _6"></span>时<span class="_ _6"></span>候，<span class="_ _6"></span>终<span class="_ _6"></span>止<span class="_ _6"></span>执<span class="_ _6"></span>行。例</div><div class="t m0 x5 h9 y2e15 ff1 fs3 fc0 sc0 ls0">如：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.3.<span class="_ _36"> </span>12.3 <span class="ff1 ws1090">线程间通信 </span>448</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
