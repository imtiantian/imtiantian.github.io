<div id="pf140" class="pf w0 h0" data-page-no="140"><div class="pc pc140 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg140.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">logged<span class="fc0">(func<span class="fc6 ls34">=</span><span class="fca">None</span><span class="ls32">,<span class="fc6 ls34">*</span></span><span class="ws13b">, level<span class="fc6 ls34">=</span></span>logging<span class="fc6">.</span><span class="ws4">DEBUG, name<span class="fc6 ls34">=</span></span><span class="fca">None</span><span class="ws13b">, message</span><span class="fc6">=<span class="fca">None</span></span>):</span></span></div><div class="t m0 x15 hf y1ac ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">func </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x16 hf y1ad ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13b">partial(logged, level<span class="fc6 ls34">=</span>level, name<span class="fc6 ls34">=</span>name, message<span class="fc6 ls34">=</span>message)</span></div><div class="t m0 x15 hf y1af ff8 fs5 fc0 sc0 ls0 ws155">logname <span class="fc6 ls32">=</span><span class="ws13c">name <span class="ff7 fca ws157">if </span>name <span class="ff7 fca ws218">else </span><span class="ws13a">func<span class="fc6 ls34">.</span>__module__</span></span></div><div class="t m0 x15 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws158">log <span class="fc6 ls32">=</span><span class="ws13a">logging<span class="fc6 ls34">.</span>getLogger(logname)</span></div><div class="t m0 x15 hf y355 ff8 fs5 fc0 sc0 ls0 ws145">logmsg <span class="fc6 ls32">=</span><span class="ws155">message <span class="ff7 fca ws157">if </span>message <span class="ff7 fca ws15a">else </span><span class="ws13a">func<span class="fc6 ls34">.</span>__name__</span></span></div><div class="t m0 x15 hf y411 ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x15 hf yba ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws458">args, </span>**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x16 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span><span class="ws13b">log(level, logmsg)</span></div><div class="t m0 x16 hf ybed ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">func(<span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs)</span></div><div class="t m0 x15 hf ybef ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x5 h11 yd7d ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 h10 ybf1 ff7 fs5 fc12 sc0 ls0">@logged</div><div class="t m0 x5 hf ybf2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf ybf3 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></div><div class="t m0 x5 hf ybf5 ff7 fs5 fc12 sc0 ls0 ws156">@logged<span class="ff8 fc0 ws13a">(level<span class="fc6 ls34">=</span>logging<span class="fc6 ls34">.</span><span class="ws4">CRITICAL, name<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span></span><span class="fc9">example<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 hf ybf6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">spam<span class="fc0">():</span></span></div><div class="t m0 x15 hf ybf7 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Spam!<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x0 h9 y21a8 ff1 fs3 fc0 sc0 ls0 wsa0">可以看到，<span class="ff6 ws23a">@logged </span>装饰器可以同时不带参数或带参数。</div><div class="t m0 x5 he y21a9 ff2 fs2 fc4 sc0 ls0 ws212">11.6.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y21aa ff1 fs3 fc0 sc0 ls22 ws119">这里提到的这个问题就是通常所说的编程一致性问题。当我们使用装饰器的时候<span class="_ _1"></span>，</div><div class="t m0 x5 h9 y21ab ff1 fs3 fc0 sc0 ls13 wse5">大部分程序员习惯了要么不给它们传递任何参数<span class="_ _1"></span>，要么给它们传递确切参数。其实从<span class="_ _c"></span></div><div class="t m0 x5 h9 y21ac ff1 fs3 fc0 sc0 ls0">技术上来讲，我们可以定义一个所有参数都是可选的装饰器，就像下面这样：</div><div class="t m0 x5 hf y21ad ff7 fs5 fc12 sc0 ls0 ws156">@logged<span class="ff8 fc0">()</span></div><div class="t m0 x5 hf y21ae ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y21af ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls34">x<span class="fc6 ls0 ws13a">+<span class="fc0">y</span></span></span></div><div class="t m0 x0 h9 y21b0 ff1 fs3 fc0 sc0 ls3a ws153">但是，这种写法并不符合我们的习惯，有时候程序员忘记加上后面的括号会导致错</div><div class="t m0 x5 h9 y21b1 ff1 fs3 fc0 sc0 ls2d ws132">误<span class="_ _1"></span>。这里我们向你展示了如何以一致的编程风格来同时满足没有括号和有括号两<span class="_ _6"></span>种情<span class="_ _1"></span></div><div class="t m0 x5 h9 y21b2 ff1 fs3 fc0 sc0 ls0">况。</div><div class="t m0 x0 h9 y21b3 ff1 fs3 fc0 sc0 ls3a ws153">为了理解代码是如何工作的，你需要非常熟悉装饰器是如何作用到函数上以及它们</div><div class="t m0 x5 h9 y21b4 ff1 fs3 fc0 sc0 ls0">的调用规则。对于一个像下面这样的简单装饰器：</div><div class="t m0 x5 h11 y21b5 ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 h10 y21b6 ff7 fs5 fc12 sc0 ls0">@logged</div><div class="t m0 x5 hf y21b7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y21b8 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></div><div class="t m0 x0 h9 y21b9 ff1 fs3 fc0 sc0 ls0">这个调用序列跟下面等价：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">11.6.<span class="_ _5"> </span>9.6 <span class="ff1 ws2ad">带可选参数的装饰器 </span>311</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
