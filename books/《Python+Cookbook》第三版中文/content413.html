<div id="pf19d" class="pf w0 h0" data-page-no="19d"><div class="pc pc19d w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg19d.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y765 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y766 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x15 hf y767 ff8 fs5 fc0 sc0 ls0 ws1f5">NWORKERS <span class="fc6 ls33">=</span><span class="fc7">16</span></div><div class="t m0 x15 hf y768 ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls33">,</span><span class="fc7">20000</span><span class="ws13b">), EchoHandler)</span></span></div><div class="t m0 x15 hf y769 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0">(NWORKERS):</span></span></span></div><div class="t m0 x16 hf y76a ff8 fs5 fc0 sc0 ls32">t<span class="fc6 ls33">=</span><span class="ls0 ws13a">Thread(target<span class="fc6 ls34">=</span>serv<span class="fc6 ls34">.</span>serve_forever)</span></div><div class="t m0 x16 hf y76b ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x16 hf y76c ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.<span class="fc0">start()</span></span></div><div class="t m0 x15 hf y842 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h9 y518 ff1 fs3 fc0 sc0 ls1d7 wsec3">一般来讲<span class="_ _1f"></span>，一个 <span class="ff6 ls0 wsec4">TCPServer <span class="ff1 wsec5">在 实 例 化 的 时 候 会 绑 定 并<span class="_ _35"> </span>激 活 相 应 的<span class="_ _17"> </span></span>socket</span></div><div class="t m0 x5 h9 y29fb ff1 fs3 fc0 sc0 ls1bb wsec6">。不过<span class="_ _1d"></span>，<span class="_ _6"></span>有时候你想通过设置某些选项去调整底下的 <span class="ff13 ls0 wsec7">so<span class="_ _c"></span>cket‘ <span class="ff1 wsd44">， 可 以 设 置 参 数</span></span></div><div class="t m0 x5 h9 y29fc ff6 fs3 fc0 sc0 ls0 ws2dc">bind<span class="_ _7"> </span>and<span class="_ _16"> </span>activate=False <span class="ff1">。如下：</span></div><div class="t m0 x5 hf y29fd ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y29fe ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls33">,</span><span class="fc7">20000</span><span class="ws13b">), EchoHandler, bind_and_activate</span><span class="fc6">=<span class="fca">False</span></span>)</span></div><div class="t m0 x15 h11 y29ff ffa fs5 fcd sc0 ls0 ws4"># Set up various socket options</div><div class="t m0 x15 hf y2a00 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>socket<span class="fc6 ls34">.</span>setsockopt(socket<span class="fc6 ls34">.</span><span class="ws13b">SOL_SOCKET, socket<span class="fc6 ls34">.</span><span class="ws147">SO_REUSEADDR, </span></span><span class="fca">True</span>)</div><div class="t m0 x15 h11 y2a01 ffa fs5 fcd sc0 ls0 ws4"># Bind and activate</div><div class="t m0 x15 hf yfe5 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>server_bind()</div><div class="t m0 x15 hf y2a02 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>server_activate()</div><div class="t m0 x15 hf y2a03 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h9 y2a04 ff1 fs3 fc0 sc0 ls3d wsb67">上面的 <span class="ff6 ls0 ws20b">socket </span><span class="ws164">选项是一个非常普遍的配置项，它允许服务器重新绑定一个之前使</span></div><div class="t m0 x5 h9 y2344 ff1 fs3 fc0 sc0 ls14 wsec8">用过的端口号<span class="_ _1"></span>。由于要被经常使用到，它被放置到类变量中<span class="_ _c"></span>，可以直接在 <span class="ff6 ls0">TCPServer</span></div><div class="t m0 x5 h9 y2a05 ff1 fs3 fc0 sc0 ls0">上面设置。在实例化服务器的时候去设置它的值，如下所示：</div><div class="t m0 x5 hf y2a06 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y2a07 ff8 fs5 fc0 sc0 ls0 ws13a">TCPServer<span class="fc6 ls34">.</span><span class="ws5b3">allow_reuse_address <span class="fc6 ls32">=</span><span class="fca">True</span></span></div><div class="t m0 x15 hf y2a08 ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls33">,</span><span class="fc7">20000</span><span class="ws13b">), EchoHandler)</span></span></div><div class="t m0 x15 hf y2a09 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h9 y2a0a ff1 fs3 fc0 sc0 ls1c4 wsdcc">在上面示例中<span class="_ _19"></span>，我们演示了两种不同的处理器基类（<span class="_ _8"></span><span class="ff6 ls0 wsec9">BaseRequestHandler <span class="ff1">和</span></span></div><div class="t m0 x5 h9 y2a0b ff6 fs3 fc0 sc0 ls0 wseca">StreamRequestHandler <span class="ff1 wsecb">）<span class="_ _f"></span>。 <span class="ff6 wseca">StreamRequestHandler </span><span class="wsa0">更<span class="_ _0"></span>加<span class="_ _12"></span>灵<span class="_ _12"></span>活<span class="_ _0"></span>点，<span class="_ _12"></span>能<span class="_ _0"></span>通<span class="_ _12"></span>过<span class="_ _12"></span>设<span class="_ _0"></span>置<span class="_ _12"></span>其<span class="_ _0"></span>他</span></span></div><div class="t m0 x5 h9 y2a0c ff1 fs3 fc0 sc0 ls0">的类变量来支持一些新的特性。比如：</div><div class="t m0 x5 h10 y2a0d ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">socket</span></div><div class="t m0 x5 hf y2a0e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">EchoHandler<span class="ff8 fc0">(StreamRequestHandler):</span></span></div><div class="t m0 x15 h11 y2a0f ffa fs5 fcd sc0 ls0 ws4"># Optional settings (defaults shown)</div><div class="t m0 x15 hf y2922 ff8 fs5 fc0 sc0 ls0 ws155">timeout <span class="fc6 ls32">=<span class="fc7 ls1d8">5</span></span><span class="ffa fcd ws4"># Timeout on all socket operations</span></div><div class="t m0 x15 hf y2a10 ff8 fs5 fc0 sc0 ls0 ws1f5">rbufsize <span class="fc6 ws1a1">= -<span class="fc7 ls1d9">1</span><span class="ffa fcd ws4"># Read buffer size</span></span></div><div class="t m0 x15 hf y2a11 ff8 fs5 fc0 sc0 ls0 ws1f5">wbufsize <span class="fc6 ls33">=<span class="fc7 ls1da">0</span></span><span class="ffa fcd ws4"># Write buffer size</span></div><div class="t m0 x15 hf y2a12 ff8 fs5 fc0 sc0 ls0 wscb8">disable_nagle_algorithm <span class="fc6 ls33">=</span><span class="fca wsecc">False <span class="ffa fcd ws4"># Sets TCP_NODELAY socket option</span></span></div><div class="t m0 x15 hf y2936 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y2a13 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Got connection from<span class="ff9">&apos;</span></span></span><span class="ls33">,</span></span><span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">client_address)</span></span></div><div class="t m0 x16 hf y2a14 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y2a15 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws157">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">rfile:</span></span></span></div><div class="t m0 x18 h11 y293 ffa fs5 fcd sc0 ls0 ws4"># self.wfile is a file-like object for writing</div><div class="t m0 x18 hf y2a16 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">wfile</span><span class="ls34">.</span><span class="fc0">write(line)</span></span></div><div class="t m0 x16 hf y2a17 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13a">socket<span class="fc6 ls34">.</span>timeout:</span></div><div class="t m0 x17 hf y2a18 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Timed out!</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.2.<span class="_ _5"> </span>11.2 <span class="ff1 ws16b">创建 </span><span class="wseb4">TCP <span class="ff1 wseb5">服务器 </span>404</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
