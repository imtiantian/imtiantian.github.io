<div id="pf1ad" class="pf w0 h0" data-page-no="1ad"><div class="pc pc1ad w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ad.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h7 y2a ff1 fs3 fc0 sc0 ls51 ws542">要注意的是很多消息层（比如 <span class="ff6 ls0 wsf81">multiprocessing <span class="ff1 wsf82">）已经使用 <span class="ff4 wsf83">pickle </span><span class="wsa0">序列化了数据。</span></span></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0 ws38">如果是这样的话，对 <span class="ff6 wsae2">pickle.dumps() </span><span class="ls4">和</span><span class="ff6 ws2dc">pickle.loads() </span>的调用要去掉。</div><div class="t m0 x5 he y2bae ff2 fs2 fc4 sc0 ls0 ws212">13.8.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2baf ff6 fs3 fc0 sc0 ls0 wsf84">RPCHandler <span class="ff1 ls9a">和</span><span class="ws83c">RPCProxy <span class="ff1 ls36 ws14a">的基本思路是很比较简单的<span class="_ _c"></span>。如果一个客户端想要调用</span></span></div><div class="t m0 x5 h7 y2bb0 ff1 fs3 fc0 sc0 ls24 wsf85">一个远程函数<span class="_ _c"></span>，比如 <span class="ff6 ls0 wsf86">foo(1, 2, z=3)<span class="_ _18"> </span><span class="ff4 ls1e7">,</span></span><span class="ws11d">代理类创建一个包含了函数名和参数的元组<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y275f ff6 fs3 fc0 sc0 ls0 wsf87">(&apos;foo&apos;, (1, 2), <span class="ffd ls84">{</span><span class="wsf88">&apos;z&apos;: 3<span class="ffd ws305">}</span><span class="ls1e8">)<span class="ff1 ls13 wsf89">。这个元组被 </span></span><span class="ff4 wsf8a">pic<span class="_ _1"></span>kle <span class="ff1 ls13 wse5">序列化后通过网络连接发生出去。<span class="_ _c"></span></span></span></span></div><div class="t m0 x5 h9 yf4f ff1 fs3 fc0 sc0 ls40 wsf8b">这一步在 <span class="ff6 ls0 wsf8c">RPCProxy </span><span class="ls1e9">的<span class="ff6 ls0 wsad7">getattr<span class="_ _e"> </span>() </span></span><span class="wsf8d">方法返回的 <span class="ff6 ls0 wsac8">do rpc() </span><span class="ws180">闭包中完成。服务器接收<span class="_ _c"></span></span></span></div><div class="t m0 x5 h7 y2bb1 ff1 fs3 fc0 sc0 ls0 wsf8e">后<span class="_ _0"></span>通<span class="_ _6"></span>过 <span class="ff4 wsf8f">pickle </span><span class="lsb5 ws942">反序列化消息<span class="_ _d"></span>，查找函数名看看是否已经注册过<span class="_ _c"></span>，然后执行相应的函<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y2bb2 ff1 fs3 fc0 sc0 ls0 wsf90">数。<span class="_ _6"></span>执<span class="_ _0"></span>行<span class="_ _6"></span>结<span class="_ _6"></span>果 <span class="ff4 wsa5">(</span><span class="wsa0">或<span class="_ _6"></span>异<span class="_ _0"></span>常<span class="ff4 ls1ea">)</span><span class="ls12b">被</span><span class="ff4 wsf91">pic<span class="_ _c"></span>kle <span class="ff1 wsa0">序<span class="_ _0"></span>列<span class="_ _6"></span>化<span class="_ _6"></span>后<span class="_ _6"></span>返<span class="_ _0"></span>回<span class="_ _6"></span>发<span class="_ _6"></span>送<span class="_ _0"></span>给<span class="_ _6"></span>客<span class="_ _6"></span>户<span class="_ _6"></span>端。<span class="_ _0"></span>我<span class="_ _6"></span>们<span class="_ _6"></span>的<span class="_ _0"></span>实<span class="_ _6"></span>例<span class="_ _6"></span>需<span class="_ _0"></span>要<span class="_ _6"></span>依<span class="_ _6"></span>赖</span></span></span></div><div class="t m0 x5 h9 y2bb3 ff6 fs3 fc0 sc0 ls0 wsf92">multiprocessing <span class="ff1 ls15b ws9ae">进行通信<span class="_ _c"></span>。不过<span class="_ _c"></span>，这种方式可以适用于其他任何消息系统<span class="_ _c"></span>。例如<span class="_ _1"></span>，<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y2bb4 ff1 fs3 fc0 sc0 lsa5 wsf93">如果你想在 <span class="ff4 ls0 wsf94">ZeroMQ <span class="ff1 wsf95">之<span class="_ _6"></span>上<span class="_ _6"></span>实<span class="_ _6"></span>习 </span><span class="wsa5">RPC<span class="ff1 wsf96">，<span class="_ _6"></span>仅<span class="_ _6"></span>仅<span class="_ _6"></span>只<span class="_ _6"></span>需<span class="_ _6"></span>要<span class="_ _0"></span>将连<span class="_ _6"></span>接<span class="_ _0"></span>对象<span class="_ _6"></span>换<span class="_ _6"></span>成<span class="_ _0"></span>合适<span class="_ _6"></span>的 </span><span class="wsf97">ZeroMQ <span class="ff1">的</span></span></span></span></div><div class="t m0 x5 h7 y2bb5 ff4 fs3 fc0 sc0 ls0 wsebb">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1">对象即可。</span></div><div class="t m0 x0 h7 y2bb6 ff1 fs3 fc0 sc0 ls0 wsf98">由于底<span class="_ _6"></span>层需要<span class="_ _6"></span>依赖 <span class="ff4 wsa5">pickle</span><span class="ls3d ws164">，那么安全问题就需要考虑了（<span class="_ _1"></span>因为一个聪明的黑客可以</span></div><div class="t m0 x5 h7 y2bb7 ff1 fs3 fc0 sc0 ls49 wsf99">创建特定的消息<span class="_ _1"></span>，能够让任意函数通过 <span class="ff4 ls0 wsf9a">pic<span class="_ _1"></span>kle <span class="ff1 ls49 ws1a6">反序列化后被执行）<span class="_ _2e"></span>。因此你永远不要<span class="_ _c"></span></span></span></div><div class="t m0 x5 h7 y2bb8 ff1 fs3 fc0 sc0 ls0 wsf9b">允许来<span class="_ _6"></span>自不信任<span class="_ _6"></span>或未认<span class="_ _6"></span>证的客户<span class="_ _6"></span>端的 <span class="ff4 wsa5">RPC</span><span class="wsf9c">。特别<span class="_ _6"></span>是你绝<span class="_ _6"></span>对不要允<span class="_ _6"></span>许来自 <span class="ff4 wsf9d">Internet </span><span class="wsa0">的任</span></span></div><div class="t m0 x5 h9 y2bb9 ff1 fs3 fc0 sc0 ls0">意机器的访问，这种只能在内部被使用，位于防火墙后面并且不要对外暴露。</div><div class="t m0 x0 h7 y2bba ff1 fs3 fc0 sc0 ls0 wsf9e">作<span class="_ _0"></span>为 <span class="ff4 wsf9f">pic<span class="_ _c"></span>kle <span class="ff1 wsfa0">的<span class="_ _0"></span>替<span class="_ _0"></span>代，<span class="_ _0"></span>你<span class="_ _6"></span>也<span class="_ _0"></span>许<span class="_ _0"></span>可<span class="_ _6"></span>以<span class="_ _0"></span>考<span class="_ _0"></span>虑<span class="_ _0"></span>使<span class="_ _6"></span>用 </span><span class="wsa5">JSON<span class="ff1 ls1eb">、</span><span class="wsfa1">XML <span class="ff1 wsa0">或<span class="_ _0"></span>一<span class="_ _0"></span>些<span class="_ _6"></span>其<span class="_ _0"></span>他<span class="_ _0"></span>的<span class="_ _0"></span>编<span class="_ _6"></span>码<span class="_ _0"></span>格<span class="_ _0"></span>式</span></span></span></span></div><div class="t m0 x5 h7 y2bbb ff1 fs3 fc0 sc0 ls54 wsfa2">来序列化消息<span class="_ _8"></span>。例如<span class="_ _d"></span>，本机实例可以很容易的改写成 <span class="ff4 ls0 ws1e5">JSON <span class="ff1 wsa0">编<span class="_ _0"></span>码<span class="_ _12"></span>方<span class="_ _12"></span>案。<span class="_ _0"></span>还<span class="_ _12"></span>需<span class="_ _12"></span>要<span class="_ _0"></span>将</span></span></div><div class="t m0 x5 h9 y2bbc ff6 fs3 fc0 sc0 ls0 ws2dc">pickle.loads() <span class="ff1 ls5">和</span>pickle.dumps() <span class="ff1 ws38">替换成 </span><span class="ws1dc">json.loads() <span class="ff1 ls5">和</span>json.dumps() <span class="ff1">即可：</span></span></div><div class="t m0 x5 h11 y2bbd ffa fs5 fcd sc0 ls0 ws4"># jsonrpcserver.py</div><div class="t m0 x5 h10 y2bbe ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">json</span></div><div class="t m0 x5 hf y2bbf ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">RPCHandler<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2bc0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y2bc1 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws2a3">_functions </span><span class="ls33">=</span><span class="fc0 ws13b">{ }</span></span></div><div class="t m0 x15 hf y2bc2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">register_function<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, func):</span></span></span></div><div class="t m0 x16 hf y2bc3 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_functions[func</span><span class="ls34">.</span><span class="fc0 ws16e">__name__] </span><span class="ls33">=</span><span class="fc0">func</span></span></div><div class="t m0 x15 hf y2bc4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_connection<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, connection):</span></span></span></div><div class="t m0 x16 hf y2bc5 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y2bc6 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 h11 yd76 ffa fs5 fcd sc0 ls0 ws4"># Receive a message</div><div class="t m0 x18 hf y2bc7 ff8 fs5 fc0 sc0 ls0 ws13b">func_name, args, kwargs <span class="fc6 ls33">=</span><span class="ws13a">json<span class="fc6 ls34">.</span>loads(connection<span class="fc6 ls34">.</span>recv())</span></div><div class="t m0 x18 h11 y2bc8 ffa fs5 fcd sc0 ls0 ws4"># Run the RPC and send a response</div><div class="t m0 x18 hf y2bc9 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x29 hf y2bca ff8 fs5 fc0 sc0 ls32">r<span class="fc6">=<span class="fca ls0 ws13a">self</span><span class="ls34">.</span></span><span class="ls0 ws13a">_functions[func_name](<span class="fc6 ls34">*</span>args,<span class="fc6 ls34">**</span>kwargs)</span></div><div class="t m0 x29 hf y2bcb ff8 fs5 fc0 sc0 ls0 ws13a">connection<span class="fc6 ls34">.</span>send(json<span class="fc6 ls34">.</span>dumps(r))</div><div class="t m0 x18 hf y2bcc ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws16e">Exception </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x29 hf y2bcd ff8 fs5 fc0 sc0 ls0 ws13a">connection<span class="fc6 ls34">.</span>send(json<span class="fc6 ls34">.</span>dumps(<span class="fca">str</span>(e)))</div><div class="t m0 x16 hf y2bce ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws13a">EOFError<span class="fc0">:</span></span></div><div class="t m0 x3d h10 y2bcf ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 h11 y2556 ffa fs5 fcd sc0 ls0 ws4"># jsonrpcclient.py</div><div class="t m0 x5 h10 y2557 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">json</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.8.<span class="_ _5"> </span>11.8 <span class="ff1 ws533">实现远程方法调用 </span>420</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
