<div id="pf24f" class="pf w0 h0" data-page-no="24f"><div class="pc pc24f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg24f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 wsadf">17.11.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y236 ff1 fs3 fc0 sc0 ls2c ws150b">作为一个例子，下面的代码演示了一个 <span class="ff4 ls0 ws150c">Cython </span><span class="ws12f">函数，用来修整一个<span class="_ _1"></span>简单的一维双</span></div><div class="t m0 x5 h9 y237 ff1 fs3 fc0 sc0 ls0">精度浮点数数组中元素的值。</div><div class="t m0 x5 hf y38d6 ff8 fs5 fc0 sc0 ls0 ws4"># sample.pyx (Cython)</div><div class="t m0 x5 hf y38d7 ff8 fs5 fc0 sc0 ls0 ws4">cimport cython</div><div class="t m0 x5 hf y25d ff8 fs5 fc0 sc0 ls0">@cython.boundscheck(False)</div><div class="t m0 x5 hf y25e ff8 fs5 fc0 sc0 ls0">@cython.wraparound(False)</div><div class="t m0 x5 hf y2caf ff8 fs5 fc0 sc0 ls0 ws4">cpdef clip(double[:] a, double min, double max, double[:] out):</div><div class="t m0 x15 h15 y2cb0 ff9 fs5 fc0 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y2cb1 ff8 fs5 fc0 sc0 ls0 ws4">Clip the values in a to be between min and max. Result in out</div><div class="t m0 x15 h15 y38d8 ff9 fs5 fc0 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y2cb2 ff8 fs5 fc0 sc0 ls0 ws4">if min &gt; max:</div><div class="t m0 x16 hf y2cb3 ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;min must be &lt;= max&quot;)</div><div class="t m0 x15 hf y2cb4 ff8 fs5 fc0 sc0 ls0 ws4">if a.shape[0] != out.shape[0]:</div><div class="t m0 x16 hf y2cb5 ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;input and output arrays must be the same size&quot;)</div><div class="t m0 x15 hf y2d13 ff8 fs5 fc0 sc0 ls0 ws4">for i in range(a.shape[0]):</div><div class="t m0 x16 hf y2cb7 ff8 fs5 fc0 sc0 ls0 ws4">if a[i] &lt; min:</div><div class="t m0 x17 hf y2cb8 ff8 fs5 fc0 sc0 ls0 ws13b">out[i] = min</div><div class="t m0 x16 hf y2cb9 ff8 fs5 fc0 sc0 ls0 ws4">elif a[i] &gt; max:</div><div class="t m0 x17 hf y2cba ff8 fs5 fc0 sc0 ls0 ws13b">out[i] = max</div><div class="t m0 x16 hf y2cbb ff8 fs5 fc0 sc0 ls0">else:</div><div class="t m0 x17 hf y2c59 ff8 fs5 fc0 sc0 ls0 ws13b">out[i] = a[i]</div><div class="t m0 x0 h9 y38d9 ff1 fs3 fc0 sc0 ls42 ws150d">要编译和构建这个扩展，你需要一个像下面这样的 <span class="ff6 ls0 ws5a6">setup.py <span class="ff1 ws150e">文件<span class="_ _6"></span>（使用 </span>python3</span></div><div class="t m0 x5 h9 y38da ff6 fs3 fc0 sc0 ls0 ws4">setup.py build<span class="_ _7"> </span>ext --inplace<span class="_ _a"> </span><span class="ff1 wsa0">来构建它）<span class="_ _f"></span>：</span></div><div class="t m0 x5 hf y38db ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws2dd">distutils.core </span><span class="ws146">import <span class="ff8 fc0">setup</span></span></div><div class="t m0 x5 hf y38dc ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws14b4">distutils.extension </span><span class="ws146">import <span class="ff8 fc0">Extension</span></span></div><div class="t m0 x5 hf y38dd ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws40c">Cython.Distutils </span><span class="ws146">import <span class="ff8 fc0">build_ext</span></span></div><div class="t m0 x5 hf y38de ff8 fs5 fc0 sc0 ls0 ws208">ext_modules <span class="fc6 ls32">=</span>[</div><div class="t m0 x15 hf y38df ff8 fs5 fc0 sc0 ls0 ws13a">Extension(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">sample<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x52 hf y38e0 ff8 fs5 fc0 sc0 ls34">[<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">sample.pyx</span>&apos;</span><span class="ls0">])</span></div><div class="t m0 x5 hf y38e1 ff8 fs5 fc0 sc0 ls0">]</div><div class="t m0 x5 hf y38e2 ff8 fs5 fc0 sc0 ls0">setup(</div><div class="t m0 x19 hf y38e3 ff8 fs5 fc0 sc0 ls0 ws13c">name <span class="fc6 ls33">=</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Sample app</span>&apos;</span>,</div><div class="t m0 x19 hf y38e4 ff8 fs5 fc0 sc0 ls0 ws16d">cmdclass <span class="fc6 ls32">=</span><span class="ls34">{<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">build_ext<span class="ff9 ls34">&apos;</span></span><span class="ws4">: build_ext},</span></div><div class="t m0 x19 hf y38e5 ff8 fs5 fc0 sc0 ls0 ws208">ext_modules <span class="fc6 ls33">=</span>ext_modules</div><div class="t m0 x5 hf y38e6 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x0 h9 y38e7 ff1 fs3 fc0 sc0 ls30 ws138">你会发现结果函数确实对数组进行的修正，并且可以适用于多种类型的数组对象<span class="_ _c"></span>。</div><div class="t m0 x5 h9 y3080 ff1 fs3 fc0 sc0 ls0">例如：</div><div class="t m0 x5 h11 ycf5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># array module example</span></div><div class="t m0 x5 h10 y83f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 h10 y840 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">array</span></span></div><div class="t m0 x5 hf y841 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">array<span class="fc6 ls34">.</span>array(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">d<span class="ff9">&apos;</span></span></span>,[<span class="fc7 ls34">1<span class="fc0">,</span></span><span class="fc6">-<span class="fc7 ls34">3<span class="fc0">,</span>4</span></span>,<span class="fc7 ls34">7<span class="fc0">,</span><span class="ls0">2</span><span class="fc0">,</span>0</span>])</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.11.<span class="_ _36"> </span>15.11 <span class="ff1 ls7f">用</span><span class="ws747">Cython <span class="ff1 ws150a">写高性能的数组操作 </span>582</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
