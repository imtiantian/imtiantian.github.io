<div id="pf13f" class="pf w0 h0" data-page-no="13f"><div class="pc pc13f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg13f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc12 sc0 ls0 ws156">@logged<span class="ff8 fc0 ws13a">(logging<span class="fc6 ls34">.</span>DEBUG)</span></div><div class="t m0 x5 h10 y1ac ff7 fs5 fc12 sc0 ls0">@timethis</div><div class="t m0 x5 hf y1ad ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">countdown<span class="fc0">(n):</span></span></div><div class="t m0 x15 hf y1ae ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0 ls33">n<span class="fc6 ls32">&gt;<span class="fc7 ls34">0</span></span><span class="ls0">:</span></span></div><div class="t m0 x16 hf y1af ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls0 ws23d">-= <span class="fc7">1</span></span></div><div class="t m0 x0 h7 ye8c ff1 fs3 fc0 sc0 ls0 wsc">还能通过使用 <span class="ff4 ws271">lam<span class="_ _1"></span>b<span class="_ _6"></span>da <span class="ff1">表达式代码来让访问函数的返回不同的设定值：</span></span></div><div class="t m0 x5 hf yc2a ff7 fs5 fc12 sc0 ls0 ws156">@attach_wrapper<span class="ff8 fc0">(wrapper)</span></div><div class="t m0 x5 hf yc2b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_level<span class="fc0">():</span></span></div><div class="t m0 x15 hf y357 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">level</span></div><div class="t m0 x5 h11 yca3 ffa fs5 fcd sc0 ls0 ws4"># Alternative</div><div class="t m0 x5 hf y1fa8 ff8 fs5 fc0 sc0 ls0 ws13a">wrapper<span class="fc6 ls34">.</span><span class="ws16e">get_level <span class="fc6 ls33">=</span><span class="ff7 fca ws156">lambda</span><span class="ws13b">: level</span></span></div><div class="t m0 x0 h9 y2192 ff1 fs3 fc0 sc0 ls3a ws153">一个比较难理解的地方就是对于访问函数的首次使用。例如，你可能会考虑另外一</div><div class="t m0 x5 h9 y2193 ff1 fs3 fc0 sc0 ls0">个方法直接访问函数的属性，如下：</div><div class="t m0 x5 hf y2194 ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x5 hf y2195 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws458">args, </span>**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x15 hf y2196 ff8 fs5 fc0 sc0 ls0 ws13a">wrapper<span class="fc6 ls34">.</span>log<span class="fc6 ls34">.</span>log(wrapper<span class="fc6">.</span><span class="ws4">level, wrapper</span><span class="fc6">.</span>logmsg)</div><div class="t m0 x15 hf y2197 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">func(<span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs)</span></div><div class="t m0 x5 h11 y2198 ffa fs5 fcd sc0 ls0 ws4"># Attach adjustable attributes</div><div class="t m0 x5 hf y2199 ff8 fs5 fc0 sc0 ls0 ws13a">wrapper<span class="fc6 ls34">.</span><span class="ws15f">level <span class="fc6 ls33">=</span>level</span></div><div class="t m0 x5 hf y219a ff8 fs5 fc0 sc0 ls0 ws13a">wrapper<span class="fc6 ls34">.</span><span class="ws145">logmsg <span class="fc6 ls32">=</span>logmsg</span></div><div class="t m0 x5 hf y219b ff8 fs5 fc0 sc0 ls0 ws13a">wrapper<span class="fc6 ls34">.</span><span class="ws158">log <span class="fc6 ls32">=</span>log</span></div><div class="t m0 x0 h9 y219c ff1 fs3 fc0 sc0 ls3a ws153">这个方法也可能正常工作，但前提是它必须是最外层的装饰器才行。如果它的上面</div><div class="t m0 x5 h7 y219d ff1 fs3 fc0 sc0 ls19 wsbc7">还有另外的装饰器 <span class="ff4 ls1b">(</span><span class="wsbc8">比如上面提到的 <span class="ff6 ls0 ws864">@timethis <span class="ff1 wsa0">例子<span class="ff4 ls1b">)</span></span></span><span class="ws22a">，那么它会隐藏底层属性，使得</span></span></div><div class="t m0 x5 h9 y219e ff1 fs3 fc0 sc0 ls0">修改它们没有任何作用。而通过使用访问函数就能避免这样的局限性。</div><div class="t m0 x0 h7 y219f ff1 fs3 fc0 sc0 ls0 ws14">最后提一点，这一小节的方案也可以作为 <span class="ff4 ws2b4">9.9 </span>小节中装饰器类的另一种实现方法。</div><div class="t m0 x5 hd y21a0 ff2 fs4 fc4 sc0 ls0 ws9c6">11.6<span class="_ _e"> </span>9.6 <span class="ff1">带可选参数的装饰器</span></div><div class="t m0 x5 he y21a1 ff2 fs2 fc4 sc0 ls0 ws212">11.6.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y21a2 ff1 fs3 fc0 sc0 ls0 wsbc9">你想写<span class="_ _6"></span>一个装<span class="_ _6"></span>饰器，<span class="_ _6"></span>既可以<span class="_ _6"></span>不传参<span class="_ _6"></span>数给它，<span class="_ _6"></span>比如 <span class="ff6 wsbca">@decorator </span><span class="wsa0">，也<span class="_ _6"></span>可以传<span class="_ _6"></span>递可选<span class="_ _6"></span>参</span></div><div class="t m0 x5 h9 y21a3 ff1 fs3 fc0 sc0 ls0 ws14">数给它，比如 <span class="ff6 ws5d8">@decorator(x,y,z) </span>。</div><div class="t m0 x5 he y21a4 ff2 fs2 fc4 sc0 ls0 ws212">11.6.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y21a5 ff1 fs3 fc0 sc0 ls0 ws38">下面是 <span class="ff4 ws2b4">9.5 </span>小节中日志装饰器的一个修改版本：</div><div class="t m0 x5 hf y21a6 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0 ws4">wraps, partial</span></span></div><div class="t m0 x5 h10 y21a7 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">logging</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">11.6.<span class="_ _5"> </span>9.6 <span class="ff1 ws2ad">带可选参数的装饰器 </span>310</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
