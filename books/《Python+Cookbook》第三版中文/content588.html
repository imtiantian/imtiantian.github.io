<div id="pf24c" class="pf w0 h0" data-page-no="24c"><div class="pc pc24c w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg24c.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y334 ff8 fs5 fc0 sc0 ls0 ws4">cimport csample</div><div class="t m0 x5 hf y336 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">gcd<span class="fc0 ws16e">(unsigned <span class="fca ws158">int </span><span class="ws4">x, unsigned <span class="fca ws158">int </span>y):</span></span></span></div><div class="t m0 x15 hf y337 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">csample<span class="fc6 ls34">.</span>gcd(x,y)</span></div><div class="t m0 x0 h7 y3880 ff1 fs3 fc0 sc0 ls0 wsa0">对于<span class="_ _6"></span>简<span class="_ _6"></span>单的<span class="_ _6"></span>函<span class="_ _6"></span>数，<span class="_ _6"></span>你并<span class="_ _6"></span>不<span class="_ _6"></span>需要<span class="_ _6"></span>去<span class="_ _6"></span>做太<span class="_ _6"></span>多<span class="_ _6"></span>的时。<span class="_ _6"></span><span class="ff4 ws14c3">Cython </span>会<span class="_ _6"></span>生<span class="_ _6"></span>成包<span class="_ _6"></span>装<span class="_ _6"></span>代码<span class="_ _6"></span>来<span class="_ _6"></span>正确<span class="_ _6"></span>的<span class="_ _6"></span>转</div><div class="t m0 x5 h7 y25b ff1 fs3 fc0 sc0 ls49 ws1333">换参数和返回值<span class="_ _1"></span>。绑定到属性上的 <span class="ff4 ls23c">C</span><span class="ws1a6">数据类型是可选的<span class="_ _1"></span>。不过，如果你包含了它们<span class="_ _c"></span>，</span></div><div class="t m0 x5 h9 y12be ff1 fs3 fc0 sc0 ls1e ws111">你可以另外做一些错误检查<span class="_ _1"></span>。例如<span class="_ _1"></span>，如果有人使用负数来调用这个函数，会抛出<span class="_ _1"></span>一个</div><div class="t m0 x5 h9 y12bf ff1 fs3 fc0 sc0 ls0">异常：</div><div class="t m0 x5 hf y3881 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>gcd(<span class="fc6 ls34">-</span><span class="fc7">10</span><span class="ls34">,<span class="fc7">2</span></span>)</span></div><div class="t m0 x5 hf y3882 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y3883 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x19 hf y3884 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;sample.pyx&quot;</span><span class="ws13b">, line <span class="fc7 ls34">7</span><span class="ws4">, in sample.gcd (sample.c:1284)</span></span></div><div class="t m0 x15 hf y3885 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">gcd<span class="fc0 ws16e">(unsigned <span class="fca ws158">int </span><span class="ws2a3">x,unsigned <span class="fca ws158">int </span>y):</span></span></span></div><div class="t m0 x5 hf y3886 ff8 fs5 fc2 sc0 ls0 ws13a">OverflowError<span class="fc0 ws4">: can<span class="ff9 ls34">&apos;</span>t convert negative value to unsigned int</span></div><div class="t m0 x5 hf y3887 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y3888 ff1 fs3 fc0 sc0 ls0">如果你想对包装函数做另外的检查，只需要使用另外的包装代码。例如：</div><div class="t m0 x5 hf y3889 ff8 fs5 fc0 sc0 ls0 ws4">def gcd(unsigned int x, unsigned int y):</div><div class="t m0 x15 hf y388a ff8 fs5 fc0 sc0 ls0 ws4">if x &lt;= 0:</div><div class="t m0 x16 hf y388b ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;x must be &gt; 0&quot;)</div><div class="t m0 x15 hf y388c ff8 fs5 fc0 sc0 ls0 ws4">if y &lt;= 0:</div><div class="t m0 x16 hf y388d ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;y must be &gt; 0&quot;)</div><div class="t m0 x15 hf y388e ff8 fs5 fc0 sc0 ls0 ws13b">return csample.gcd(x,y)</div><div class="t m0 x0 h7 y3586 ff1 fs3 fc0 sc0 ls12b">在<span class="ff4 ls0 ws14c4">csample.p<span class="_ _1"></span>xd <span class="ff1 ws14c5">文<span class="_ _6"></span>件<span class="_ _0"></span>中<span class="_ _6"></span>的 </span><span class="ws14c6">‘‘in mandel()‘‘<span class="_ _7"> </span><span class="ff1 lsd3 ws4b2">声明有个很有趣但是比较难理解的定义<span class="_ _1"></span>。<span class="_ _c"></span></span></span></span></div><div class="t m0 x5 h7 y388f ff1 fs3 fc0 sc0 ls0 ws14c7">在这个文件中，<span class="_ _1"></span>函数被声明为然后一个 <span class="ff4 ws14c8">bint </span><span class="ws14c9">而不是一个 <span class="ff4 wsa5">in<span class="_ _c"></span>t<span class="ff1 wsa0">。它会让函数创建一个正确</span></span></span></div><div class="t m0 x5 h7 y3890 ff1 fs3 fc0 sc0 ls4">的<span class="ff4 ls0 ws14ca">Bo<span class="_ _6"></span>olean </span><span class="ls0 ws14">值而不是简单的整数。因此，返回值 <span class="ff4 lsc">0</span>表示 <span class="ff4 ws14cb">F<span class="_ _8"></span>alse <span class="ff1 ls4">而</span><span class="ls39">1</span><span class="ff1 ws14">表示 </span><span class="wsa5">T<span class="_ _d"></span>rue<span class="ff1">。</span></span></span></span></div><div class="t m0 x0 h7 y3891 ff1 fs3 fc0 sc0 ls286">在<span class="ff4 ls0 ws14cc">Cython </span><span class="ls0 ws14cd">包装器中，<span class="_ _8"></span>你可以选择声明 <span class="ff4 ls287">C</span><span class="ws14ce">数据类型，<span class="_ _d"></span>也可以使用所有的常见 <span class="ff4">Python</span></span></span></div><div class="t m0 x5 h9 y3892 ff1 fs3 fc0 sc0 ls0 ws25a">对象。对于 <span class="ff6 ws25b">divide() </span><span class="wsa0">的包装器展示了这样一个例子，同时还有如何去处理一个指针参</span></div><div class="t m0 x5 h9 y3893 ff1 fs3 fc0 sc0 ls0">数。</div><div class="t m0 x5 hf y3894 ff8 fs5 fc0 sc0 ls0 ws4">def divide(x,y):</div><div class="t m0 x15 hf y3895 ff8 fs5 fc0 sc0 ls0 ws13b">cdef int rem</div><div class="t m0 x15 hf y3896 ff8 fs5 fc0 sc0 ls0 ws13b">quot = csample.divide(x,y,&amp;rem)</div><div class="t m0 x15 hf yab5 ff8 fs5 fc0 sc0 ls0 ws13b">return quot, rem</div><div class="t m0 x0 h7 y3897 ff1 fs3 fc0 sc0 ls0 wsa0">在这里，<span class="ff6 ws14cf">rem </span><span class="ls3a ws14d0">变量被显示的声明为一个 <span class="ff4 ls288">C</span></span><span class="ws14d1">整型变量。当<span class="_ _6"></span>它被传入 <span class="ff6 ws5ee">divide() </span></span>函数的</div><div class="t m0 x5 h7 y3898 ff1 fs3 fc0 sc0 ls0 wsa0">时候，<span class="ff6 ws14d2">&amp;rem </span><span class="wsde5">创建一个跟 <span class="ff4 ls289">C</span><span class="ws1bc">一样的指向它的指针。 <span class="ff6 ws4ed">avg() </span><span class="ws91">函数的代码演示了 <span class="ff4 ws14d3">Cython </span>更</span></span></span></div><div class="t m0 x5 h9 y1590 ff1 fs3 fc0 sc0 ls0 ws14d4">高级<span class="_ _6"></span>的特性。<span class="_ _6"></span>首先 <span class="ff6 ws14d5">def<span class="_ _23"> </span>avg(double[:]<span class="_ _2c"> </span>a) </span><span class="ws228">声明<span class="_ _6"></span>了 <span class="ff6 ws14d6">avg() </span><span class="ls19 ws22a">接受一个一维的双精度内存</span></span></div><div class="t m0 x5 h7 y3899 ff1 fs3 fc0 sc0 ls12 ws14d7">视图。最惊奇的部分是返回<span class="_ _1"></span>的结果函数可以接受任何兼容的数组对象，包括被 <span class="ff4 ls0 wsa5">n<span class="_ _c"></span>umpy</span></div><div class="t m0 x5 h9 y389a ff1 fs3 fc0 sc0 ls0">创建的。例如：</div><div class="t m0 x5 h10 y389b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">array</span></span></div><div class="t m0 x5 hf y389c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">array<span class="fc6 ls34">.</span>array(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">d<span class="ff9">&apos;</span></span></span>,[<span class="fc7 ls34">1<span class="fc0">,</span><span class="ls0">2</span><span class="fc0">,</span>3</span>])</span></span></div><div class="t m0 x5 h10 y389d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">numpy</span></span></div><div class="t m0 x5 hf y389e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">b<span class="fc6 ls33">=</span><span class="ls0 ws13a">numpy<span class="fc6 ls34">.</span>array([<span class="fc7">1.</span></span>,<span class="fc7 ls0 ws13a">2.</span>,<span class="fc7 ls0 ws13a">3.<span class="fc0">])</span></span></span></div><div class="t m0 x5 h10 y389f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y38a0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>avg(a)</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.10.<span class="_ _36"> </span>15.10 <span class="ff1 ls7f">用</span><span class="ws747">Cython <span class="ff1 ws16b">包装 </span><span class="ls246">C</span><span class="ff1 ws14a7">代码 </span>579</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
