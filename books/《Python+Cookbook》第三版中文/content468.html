<div id="pf1d4" class="pf w0 h0" data-page-no="1d4"><div class="pc pc1d4 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1d4.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">philosopher<span class="fc0 ws13b">(left, right):</span></span></div><div class="t m0 x15 hf y1ac ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y1ad ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0">acquire(left,right):</span></div><div class="t m0 x3d hf y1ae ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(threading<span class="fc6 ls34">.</span><span class="ws1f8">currentThread(), <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">eating<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 h11 y1b0 ffa fs5 fcd sc0 ls0 ws4"># The chopsticks (represented by locks)</div><div class="t m0 x5 hf y355 ff8 fs5 fc0 sc0 ls0 ws155">NSTICKS <span class="fc6 ls32">=</span><span class="fc7">5</span></div><div class="t m0 x5 hf y410 ff8 fs5 fc0 sc0 ls0 ws2a3">chopsticks <span class="fc6 ls32">=</span><span class="ws13a">[threading<span class="fc6">.</span><span class="ws19f">Lock() <span class="ff7 fca ws38d">for </span><span class="ls33">n</span><span class="ff7 fca ws157">in </span></span><span class="fca">range</span>(NSTICKS)]</span></div><div class="t m0 x5 h11 yba ffa fs5 fcd sc0 ls0 ws4"># Create all of the philosophers</div><div class="t m0 x5 hf y8c6 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws160">in <span class="ff8 ws13a">range<span class="fc0">(NSTICKS):</span></span></span></div><div class="t m0 x15 hf ybed ff8 fs5 fc0 sc0 ls32">t<span class="fc6 ls33">=</span><span class="ls0 ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6">=</span>philosopher,</span></div><div class="t m0 x44 hf ybee ff8 fs5 fc0 sc0 ls0 ws13a">args<span class="fc6 ls34">=</span>(chopsticks[n],chopsticks[(n<span class="fc6 ls34">+<span class="fc7">1</span></span><span class="ls32">)<span class="fc6 ls33">%</span></span>NSTICKS]))</div><div class="t m0 x15 hf ybef ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.<span class="fc0">start()</span></span></div><div class="t m0 x0 h9 y2ee4 ff1 fs3 fc0 sc0 ls19 ws10bc">最后，要特别注意到<span class="_ _1"></span>，为了避免死锁，所有的加锁操作必须使用 <span class="ff6 ls0 ws864">acquire() <span class="ff1 wsa0">函数。</span></span></div><div class="t m0 x5 h7 y2ee5 ff1 fs3 fc0 sc0 ls1f ws10bd">如果代码中的某部分绕过 <span class="ff4 ls0 ws10be">acquire </span><span class="ws113">函数直接申请锁，那么整个死锁避免机制就不起作用</span></div><div class="t m0 x5 h9 y2ee6 ff1 fs3 fc0 sc0 ls0">了。</div><div class="t m0 x5 hd y2ee7 ff2 fs4 fc4 sc0 ls0 ws211">14.6<span class="_ _e"> </span>12.6 <span class="ff1">保存线程的状态信息</span></div><div class="t m0 x5 he y2ee8 ff2 fs2 fc4 sc0 ls0 ws212">14.6.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y2ee9 ff1 fs3 fc0 sc0 ls0">你需要保存正在运行线程的状态，这个状态对于其他的线程是不可见的。</div><div class="t m0 x5 he y2eea ff2 fs2 fc4 sc0 ls0 ws212">14.6.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y2eeb ff1 fs3 fc0 sc0 ls1a8 wscb9">有时在多线程编程中<span class="_ _d"></span>，你需要只保存当前运行线程的状态<span class="_ _d"></span>。要这么做<span class="_ _d"></span>，可使用<span class="_ _c"></span></div><div class="t m0 x5 h9 y2eec ff6 fs3 fc0 sc0 ls0 ws10bf">thread.local() <span class="ff1 ls2b ws12e">创建一个本地线程存储对象。对这个对象的属性的保存和读取操作都</span></div><div class="t m0 x5 h9 y2eed ff1 fs3 fc0 sc0 ls0">只会对执行线程可见，而其他线程并不可见。</div><div class="t m0 x0 h7 y2d99 ff1 fs3 fc0 sc0 ls0 ws10c0">作 为 使 用 本 地 存 储 的 一 个 有 趣 的 实 际 例 子， 考 虑 在<span class="_ _e"> </span><span class="ff4 ws10c1">8.3 </span><span class="ls200 ws10c2">小节定义过的<span class="_ _f"></span></span></div><div class="t m0 x5 h9 y141e ff6 fs3 fc0 sc0 ls0 ws10c3">LazyConnection <span class="ff1 lsaa ws3e4">上下文管理器类<span class="_ _8"></span>。下面我们对它进行一些小的修改使得它可以适<span class="_ _d"></span></span></div><div class="t m0 x5 h9 ye2c ff1 fs3 fc0 sc0 ls0">用于多线程：</div><div class="t m0 x5 hf y2eee ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 h10 y1f ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y2eef ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">LazyConnection<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2235 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, address, family</span><span class="fc6">=</span><span class="ws16d">AF_INET, </span><span class="fca">type<span class="fc6 ls34">=</span></span>SOCK_STREAM):</span></span></div><div class="t m0 x16 hf y2ef0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">address </span><span class="ls33">=</span><span class="fc0">address</span></span></div><div class="t m0 x16 hf y2ef1 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">family </span><span class="ls32">=</span><span class="fc0">AF_INET</span></span></div><div class="t m0 x16 hf y2ef2 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">type </span><span class="ls33">=</span><span class="fc0">SOCK_STREAM</span></span></div><div class="t m0 x16 hf y2ef3 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">local </span><span class="ls32">=</span><span class="fc0">threading</span><span class="ls34">.</span><span class="fc0">local()</span></span></div><div class="t m0 x15 hf y2ef4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__enter__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y2ef5 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">hasattr<span class="fc0 ls34">(</span>self<span class="fc6">.<span class="fc0 ws19f">local, <span class="ff9 fc9 ws13b">&apos;</span></span><span class="fc9">sock<span class="ff9 ls34">&apos;</span><span class="fc0">):</span></span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.6.<span class="_ _36"> </span>12.6 <span class="ff1 ws544">保存线程的状态信息 </span>459</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
