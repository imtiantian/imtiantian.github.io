<div id="pf1cf" class="pf w0 h0" data-page-no="1cf"><div class="pc pc1cf w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1cf.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">14.4.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y236 ff1 fs3 fc0 sc0 ls3a ws153">线程调度本质上是不确定的，因此，在多线程程序中错误地使用锁机制可能会导致</div><div class="t m0 x5 h9 y237 ff1 fs3 fc0 sc0 ls1e ws111">随机数据损坏或者其他的异常行为<span class="_ _1"></span>，我们称之为竞争条件<span class="_ _1"></span>。为了避免竞争条件<span class="_ _1"></span>，最好</div><div class="t m0 x5 h7 y238 ff1 fs3 fc0 sc0 ls18 ws110">只在临界区（对临界资源进行操作的那部分代码）使用锁。在一些“<span class="_ _1"></span>老的”<span class="ff4 ls0 wsf8">Python <span class="ff1">代</span></span></div><div class="t m0 x5 h9 yea6 ff1 fs3 fc0 sc0 ls0">码中，显式获取和释放锁是很常见的。下边是一个上一个例子的变种：</div><div class="t m0 x5 h10 y2e85 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y13db ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">SharedCounter<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h15 y13dc ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y13dd ffa fs5 fc9 sc0 ls0 ws4">A counter object that can be shared by multiple threads.</div><div class="t m0 x15 h15 y13de ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y13df ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, initial_value <span class="fc6 ls32">=<span class="fc7 ls34">0</span></span>):</span></span></span></div><div class="t m0 x16 hf y13e0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_value </span><span class="ls32">=</span><span class="fc0">initial_value</span></span></div><div class="t m0 x16 hf y2e86 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">_value_lock </span><span class="ls33">=</span><span class="fc0">threading</span><span class="ls34">.</span><span class="fc0">Lock()</span></span></div><div class="t m0 x15 hf y2e87 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">incr<span class="fc0">(<span class="fca">self</span>,delta<span class="fc6">=<span class="fc7 ls34">1</span></span>):</span></span></div><div class="t m0 x16 h15 y13e4 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 y13e5 ffa fs5 fc9 sc0 ls0 ws4">Increment the counter with locking</div><div class="t m0 x16 h15 y3c ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y13e6 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_value_lock</span><span class="ls34">.</span><span class="fc0">acquire()</span></span></div><div class="t m0 x16 hf y13e7 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_value </span><span class="ws1a1">+= <span class="fc0">delta</span></span></span></div><div class="t m0 x16 hf y13e8 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_value_lock</span><span class="ls34">.</span><span class="fc0">release()</span></span></div><div class="t m0 x15 hf y13ea ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decr<span class="fc0">(<span class="fca">self</span>,delta<span class="fc6">=<span class="fc7 ls34">1</span></span>):</span></span></div><div class="t m0 x16 h15 y13eb ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 y13ec ffa fs5 fc9 sc0 ls0 ws4">Decrement the counter with locking</div><div class="t m0 x16 h15 y2971 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y2e88 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_value_lock</span><span class="ls34">.</span><span class="fc0">acquire()</span></span></div><div class="t m0 x16 hf y2e89 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_value </span><span class="ws1a1">-= <span class="fc0">delta</span></span></span></div><div class="t m0 x16 hf y13f0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_value_lock</span><span class="ls34">.</span><span class="fc0">release()</span></span></div><div class="t m0 x0 h7 y2e8a ff1 fs3 fc0 sc0 ls0 wsa0">相比于这种显式调用的方法，<span class="_ _c"></span><span class="ff4 ws10a5">with <span class="ff1 wsa0">语句更加优雅，<span class="_ _1"></span>也更不容易出错，<span class="_ _1"></span>特别是程序员</span></span></div><div class="t m0 x5 h7 y1171 ff1 fs3 fc0 sc0 ls2c ws10a6">可能会忘记调用 <span class="ff4 ls0 ws10a7">release() </span><span class="ws10a8">方法或者程序在获得锁之后产生异常这两种情况（使用 <span class="ff4 ls0">with</span></span></div><div class="t m0 x5 h9 y2e8b ff1 fs3 fc0 sc0 ls0 wsa0">语句可以保证在这两种情况下仍能正确释放锁）<span class="_ _f"></span>。为了避免出现死锁的情况，<span class="_ _1"></span>使用锁机</div><div class="t m0 x5 h9 y17be ff1 fs3 fc0 sc0 ls13 wse5">制的程序应该设定为每个线程一次只允许获取一个锁<span class="_ _1"></span>。如果不能这样做的话，你就需<span class="_ _c"></span></div><div class="t m0 x5 h7 y2e8c ff1 fs3 fc0 sc0 ls3a ws10a9">要更高级的死锁避免机制，我们将在 <span class="ff4 ls0 ws10aa">12.5 <span class="ff1 ws10ab">节介绍。在 <span class="ff6 ws10ac">threading </span></span></span><span class="ws153">库中还提供了其他的</span></div><div class="t m0 x5 h9 y2e8d ff1 fs3 fc0 sc0 ls2c ws10ad">同步原语，比如 <span class="ff6 ls0 ws9b8">RLoct </span><span class="lsd6">和<span class="ff6 ls0 ws10ae">Semaphore </span></span><span class="ws12f">对象。但是根据以往经验<span class="_ _1"></span>，这些原语是用于一些</span></div><div class="t m0 x5 h9 y2e8e ff1 fs3 fc0 sc0 ls1e ws111">特殊的情况<span class="_ _1"></span>，如果你只是需要简单地对可变对象进行锁定<span class="_ _1"></span>，那就不应该使用它们<span class="_ _1"></span>。一</div><div class="t m0 x5 h9 y1044 ff1 fs3 fc0 sc0 ls65">个<span class="ff6 ls0 ws10af">RLock </span><span class="ls0 wsa0">（可重<span class="_ _6"></span>入锁）<span class="_ _6"></span>可<span class="_ _6"></span>以被<span class="_ _6"></span>同一<span class="_ _6"></span>个<span class="_ _6"></span>线程<span class="_ _6"></span>多次<span class="_ _6"></span>获取，<span class="_ _6"></span>主<span class="_ _6"></span>要用<span class="_ _6"></span>来实<span class="_ _6"></span>现基<span class="_ _6"></span>于<span class="_ _6"></span>监测<span class="_ _6"></span>对象<span class="_ _6"></span>模式</span></div><div class="t m0 x5 h9 y2e8f ff1 fs3 fc0 sc0 ls0 wsa0">的<span class="_ _6"></span>锁定<span class="_ _6"></span>和<span class="_ _6"></span>同<span class="_ _6"></span>步。<span class="_ _6"></span>在<span class="_ _6"></span>使用<span class="_ _6"></span>这<span class="_ _6"></span>种<span class="_ _6"></span>锁<span class="_ _6"></span>的<span class="_ _6"></span>情况<span class="_ _6"></span>下，<span class="_ _6"></span>当<span class="_ _6"></span>锁<span class="_ _6"></span>被<span class="_ _6"></span>持<span class="_ _6"></span>有时，<span class="_ _6"></span>只<span class="_ _6"></span>有<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>线程<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>使<span class="_ _6"></span>用<span class="_ _6"></span>完整</div><div class="t m0 x5 h7 y2e90 ff1 fs3 fc0 sc0 ls0 ws14">的函数或者类中的方法。比如，你可以实现一个这样的 <span class="ff4 ws9e">SharedCoun<span class="_ _1"></span>ter <span class="ff1">类：</span></span></div><div class="t m0 x5 h10 y23 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y1380 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">SharedCounter<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h15 y573 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y574 ffa fs5 fc9 sc0 ls0 ws4">A counter object that can be shared by multiple threads.</div><div class="t m0 x15 h15 y575 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y576 ff8 fs5 fc0 sc0 ls0 ws15f">_lock <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>RLock()</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.4.<span class="_ _36"> </span>12.4 <span class="ff1 ws600">给关键部分加锁 </span>454</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
