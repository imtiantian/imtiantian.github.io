<div id="pf1e6" class="pf w0 h0" data-page-no="1e6"><div class="pc pc1e6 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1e6.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x17 hf y181 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">task </span><span class="ws157">in <span class="ff8 fc0">tasks:</span></span></div><div class="t m0 x18 hf y182 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">detach(task)</span></span></div><div class="t m0 x15 hf y184 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">send<span class="fc0">(<span class="fca">self</span><span class="ws4">, msg):</span></span></span></div><div class="t m0 x16 hf y185 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws2a3">subscriber </span><span class="ws157">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_subscribers:</span></span></span></div><div class="t m0 x17 hf y186 ff8 fs5 fc0 sc0 ls0 ws13a">subscriber<span class="fc6 ls34">.</span>send(msg)</div><div class="t m0 x5 h11 y188 ffa fs5 fcd sc0 ls0 ws4"># Dictionary of all created exchanges</div><div class="t m0 x5 hf y98e ff8 fs5 fc0 sc0 ls0 ws2a3">_exchanges <span class="fc6 ls32">=</span>defaultdict(Exchange)</div><div class="t m0 x5 h11 y990 ffa fs5 fcd sc0 ls0 ws4"># Return the Exchange instance associated with a given name</div><div class="t m0 x5 hf y991 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_exchange<span class="fc0">(name):</span></span></div><div class="t m0 x15 hf y992 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">_exchanges[name]</span></div><div class="t m0 x5 h11 ya70 ffa fs5 fcd sc0 ls0 ws4"># Example of using the subscribe() method</div><div class="t m0 x5 hf y994 ff8 fs5 fc0 sc0 ls0 ws158">exc <span class="fc6 ls32">=</span><span class="ws13a">get_exchange(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">name<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y995 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">exc<span class="fc6 ls34">.</span><span class="ws13b">subscribe(task_a, task_b):</span></span></div><div class="t m0 x31 hf y996 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x31 hf y997 ff8 fs5 fc0 sc0 ls0 ws13a">exc<span class="fc6 ls34">.</span>send(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">msg1<span class="ff9 ls34">&apos;</span></span>)</div><div class="t m0 x31 hf y998 ff8 fs5 fc0 sc0 ls0 ws13a">exc<span class="fc6 ls34">.</span>send(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">msg2<span class="ff9 ls34">&apos;</span></span>)</div><div class="t m0 x31 hf ya71 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 h11 y99a ffa fs5 fcd sc0 ls0 ws4"># task_a and task_b detached here</div><div class="t m0 x0 h9 y305e ff1 fs3 fc0 sc0 ls3a ws153">最后还应该注意的是关于交换机的思想有很多种的扩展实现。例如，交换机可以实</div><div class="t m0 x5 h9 y305f ff1 fs3 fc0 sc0 ls2d ws132">现一整个消息通道集合或提供交换机名称的模式匹配规则。交换机还可以被扩展到分<span class="_ _1"></span></div><div class="t m0 x5 h9 y3060 ff1 fs3 fc0 sc0 ls0 wsa0">布式计算程序中（比如，将消息路由到不同机器上面的任务中去）<span class="_ _f"></span>。</div><div class="t m0 x5 hd y3061 ff2 fs4 fc4 sc0 ls0 wsd91">14.12<span class="_ _e"> </span>12.12 <span class="ff1">使用生成器代替线程</span></div><div class="t m0 x5 he y3062 ff2 fs2 fc4 sc0 ls0 wsadf">14.12.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y3063 ff1 fs3 fc0 sc0 ls0 wsa0">你想使用生成器（协程）<span class="_ _6"></span>替代系统线程来实现并发。<span class="_ _6"></span>这个有时又被称为用户<span class="_ _6"></span>级线程</div><div class="t m0 x5 h9 y3064 ff1 fs3 fc0 sc0 ls0">或绿色线程。</div><div class="t m0 x5 he y3065 ff2 fs2 fc4 sc0 ls0 wsadf">14.12.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y243b ff1 fs3 fc0 sc0 ls19 ws1183">要使用生成器实现自己的并发，你首先要对生成器函数和 <span class="ff6 ls0 ws1fc">yield <span class="ff1 wsa0">语句<span class="_ _6"></span>有深刻<span class="_ _6"></span>理解。</span></span></div><div class="t m0 x5 h9 y2316 ff6 fs3 fc0 sc0 ls0 ws106c">yield <span class="ff1 ls14 ws174">语句会让一个生成器挂起它的执行<span class="_ _1"></span>，这样就可以编写一个调度器<span class="_ _1"></span>，将生成器当<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y3066 ff1 fs3 fc0 sc0 ls1e ws111">做某种“<span class="_ _1"></span>任务”并使用任务协作切换来替换它们的执行<span class="_ _c"></span>。要演示这<span class="_ _6"></span>种思想<span class="_ _1"></span>，考虑下面</div><div class="t m0 x5 h9 y3067 ff1 fs3 fc0 sc0 ls0 ws38">两个使用简单的 <span class="ff6 ws19e">yield </span>语句的生成器函数：</div><div class="t m0 x5 h11 y1a6 ffa fs5 fcd sc0 ls0 ws4"># Two simple generator functions</div><div class="t m0 x5 hf y1a7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">countdown<span class="fc0">(n):</span></span></div><div class="t m0 x15 hf y1a8 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0 ls33">n<span class="fc6 ls32">&gt;<span class="fc7 ls34">0</span></span><span class="ls0">:</span></span></div><div class="t m0 x16 hf y1a9 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">T-minus</span>&apos;</span><span class="ls0 ws13b">, n)</span></span></div><div class="t m0 x16 h10 y1aa ff7 fs5 fca sc0 ls0">yield</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.12.<span class="_ _36"> </span>12.12 <span class="ff1 ws104c">使用生成器代替线程 </span>477</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
