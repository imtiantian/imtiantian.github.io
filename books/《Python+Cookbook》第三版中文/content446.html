<div id="pf1be" class="pf w0 h0" data-page-no="1be"><div class="pc pc1be w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1be.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, sock, handler_list):</span></span></span></div><div class="t m0 x16 hf y1ac ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">sock </span><span class="ls33">=</span><span class="fc0">sock</span></span></div><div class="t m0 x16 hf y1ad ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">handler_list </span><span class="ls32">=</span><span class="fc0">handler_list</span></span></div><div class="t m0 x16 hf y1ae ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">outgoing </span><span class="ls32">=</span></span>bytearray<span class="fc0">()</span></div><div class="t m0 x15 hf y1b0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">fileno<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y355 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">sock<span class="fc6 ls34">.</span>fileno()</span></span></div><div class="t m0 x15 hf y411 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">close<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf yba ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">close()</span></span></div><div class="t m0 x16 h11 y8c6 ffa fs5 fcd sc0 ls0 ws4"># Remove myself from the event loop<span class="ffb ls34">&apos;</span><span class="ws13b">s handler list</span></div><div class="t m0 x16 hf ybed ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">handler_list</span><span class="ls34">.</span><span class="fc0">remove(</span></span>self<span class="fc0">)</span></div><div class="t m0 x15 hf ybef ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wants_to_send<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf ybf0 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13c">True </span><span class="ws157">if <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0 ws16d">outgoing </span></span></span><span class="ws15a">else <span class="ff8">False</span></span></span></div><div class="t m0 x15 hf ybf1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_send<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf ybf2 ff8 fs5 fc0 sc0 ls0 ws15f">nsent <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">send(</span></span>self<span class="fc6 ls34">.</span></span>outgoing)</div><div class="t m0 x16 hf ybf3 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">outgoing </span><span class="ls32">=</span></span>self<span class="fc6 ls34">.</span><span class="fc0">outgoing[nsent:]</span></div><div class="t m0 x5 hf ybf5 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">TCPEchoClient<span class="ff8 fc0">(TCPClient):</span></span></div><div class="t m0 x15 hf ybf6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wants_to_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf ybf7 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">True</span></div><div class="t m0 x15 hf ybf9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf ybfa ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">sock<span class="fc6 ls34">.</span>recv(<span class="fc7">8192</span>)</span></span></div><div class="t m0 x16 hf ybfb ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">data:</span></div><div class="t m0 x17 hf y1ed6 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">close()</span></span></div><div class="t m0 x16 hf y1ed7 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y1ed8 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">outgoing</span><span class="ls34">.</span><span class="fc0">extend(data)</span></span></div><div class="t m0 x5 hf y1ed9 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x3c hf y1eda ff8 fs5 fc0 sc0 ls0 ws16d">handlers <span class="fc6 ls32">=</span>[]</div><div class="t m0 x3c hf y1edb ff8 fs5 fc0 sc0 ls0 ws13a">handlers<span class="fc6 ls34">.</span>append(TCPServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls34">,</span><span class="fc7">16000</span><span class="ws13b">), TCPEchoClient, handlers))</span></div><div class="t m0 x3c hf y1f84 ff8 fs5 fc0 sc0 ls0">event_loop(handlers)</div><div class="t m0 x0 h7 y2d0a ff4 fs3 fc0 sc0 ls0 ws1039">TCP <span class="ff1 lsd3 ws4b2">例子的关键点是从处理器中列表增加和删除客户端的操作<span class="_ _c"></span>。对每一个连接<span class="_ _c"></span>，<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2d0b ff1 fs3 fc0 sc0 ls13 wse5">一个新的处理器被创建并加到列表中<span class="_ _1"></span>。当连接被关闭后，每个客户端负责将其从列表<span class="_ _c"></span></div><div class="t m0 x5 h7 y2d0c ff1 fs3 fc0 sc0 ls19 ws103a">中删除。如果你运行程序并试着用 <span class="ff4 ls0 ws103b">T<span class="_ _8"></span>elnet <span class="ff1 ls19 ws22a">或类似工具连接，它会将你发送的消息回显<span class="_ _1"></span></span></span></div><div class="t m0 x5 h9 y1bd1 ff1 fs3 fc0 sc0 ls0">给你。并且它能很轻松的处理多客户端连接。</div><div class="t m0 x5 he y2d0d ff2 fs2 fc4 sc0 ls0 wsadf">13.12.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2d0e ff1 fs3 fc0 sc0 ls3a ws153">实际上所有的事件驱动框架原理跟上面的例子相差无几。实际的实现细节和软件架</div><div class="t m0 x5 h7 y2d0f ff1 fs3 fc0 sc0 ls48 ws103c">构可能不一样<span class="_ _1"></span>，但是在最核心的部分，都会有一个轮询的循环来检查活动 <span class="ff4 ls0 wsa5">sock<span class="_ _c"></span>et<span class="ff1 wsa0">，<span class="_ _6"></span>并</span></span></div><div class="t m0 x5 h9 y2d10 ff1 fs3 fc0 sc0 ls0">执行响应操作。</div><div class="t m0 x0 h7 y2d11 ff1 fs3 fc0 sc0 ls0 ws103d">事<span class="_ _6"></span>件驱<span class="_ _6"></span>动 <span class="ff4 ws39b">I/<span class="_ _6"></span>O </span><span class="ls40 ws180">的一个可能好处是它能处理非常大的并发连接，而不需要使用多线<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y2d12 ff1 fs3 fc0 sc0 ls1f ws113">程或多进程。也就是说，<span class="ff6 ls0 ws103e">select() </span><span class="wsc62">调用（或其他等效的）能监听大量的 <span class="ff4 ls0 ws103f">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1 ls1f ws113">并响应</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.12.<span class="_ _36"> </span>11.12 <span class="ff1 ws36c">理解事件驱动的 </span><span class="ws102f">IO 437</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
