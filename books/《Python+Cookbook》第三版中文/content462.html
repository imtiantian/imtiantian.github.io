<div id="pf1ce" class="pf w0 h0" data-page-no="1ce"><div class="pc pc1ce w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ce.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y20bf ff1 fs3 fc0 sc0 ls0 ws109d">最<span class="_ _6"></span>后，<span class="_ _6"></span>有 <span class="ff6 ws109e">q.qsize() </span><span class="ls1fe">，</span><span class="ff6 ws6b8">q.full() </span><span class="ls1ff">，</span><span class="ff6 ws374">q.empty() </span><span class="ls49 ws1a6">等实用方法可以获取一个队列的<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2a19 ff1 fs3 fc0 sc0 ls0 wsa0">当<span class="_ _0"></span>前<span class="_ _6"></span>大<span class="_ _0"></span>小<span class="_ _0"></span>和<span class="_ _0"></span>状<span class="_ _6"></span>态。<span class="_ _0"></span>但<span class="_ _0"></span>要<span class="_ _0"></span>注<span class="_ _6"></span>意，<span class="_ _0"></span>这<span class="_ _0"></span>些<span class="_ _0"></span>方<span class="_ _6"></span>法<span class="_ _0"></span>都<span class="_ _0"></span>不<span class="_ _0"></span>是<span class="_ _6"></span>线<span class="_ _0"></span>程<span class="_ _0"></span>安<span class="_ _0"></span>全<span class="_ _6"></span>的。<span class="_ _0"></span>可<span class="_ _0"></span>能<span class="_ _0"></span>你<span class="_ _0"></span>对<span class="_ _6"></span>一<span class="_ _0"></span>个<span class="_ _0"></span>队<span class="_ _6"></span>列<span class="_ _0"></span>使<span class="_ _0"></span>用</div><div class="t m0 x5 h9 y2a1a ff6 fs3 fc0 sc0 ls0 ws241">empty() <span class="ff1 ls48 ws242">判断出这个队列为空<span class="_ _1"></span>，但同时另外一个线程可能已经向这个队列中插入一个<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2e6a ff1 fs3 fc0 sc0 ls0">数据项。所以，你最好不要在你的代码中使用这些方法。</div><div class="t m0 x5 hd y2e6b ff2 fs4 fc4 sc0 ls0 ws211">14.4<span class="_ _e"> </span>12.4 <span class="ff1">给关键部分加锁</span></div><div class="t m0 x5 he y2e6c ff2 fs2 fc4 sc0 ls0 ws212">14.4.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y2e6d ff1 fs3 fc0 sc0 ls0">你需要对多线程程序中的临界区加锁以避免竞争条件。</div><div class="t m0 x5 he y2e6e ff2 fs2 fc4 sc0 ls0 ws212">14.4.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y2e6f ff1 fs3 fc0 sc0 ls16 ws109f">要在多线程程序中安全使用可变对象<span class="_ _c"></span>，你需要使用 <span class="ff4 ls0 ws10a0">threading <span class="ff1 ws10a1">库<span class="_ _0"></span>中<span class="_ _6"></span>的 <span class="ff6 ws10a2">Lock </span><span class="wsa0">对<span class="_ _6"></span>象，</span></span></span></div><div class="t m0 x5 h9 y2e70 ff1 fs3 fc0 sc0 ls0">就像下边这个例子这样：</div><div class="t m0 x5 h10 y2672 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y2e71 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">SharedCounter<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h15 y2e72 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2e73 ffa fs5 fc9 sc0 ls0 ws4">A counter object that can be shared by multiple threads.</div><div class="t m0 x15 h15 y2e74 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y2e75 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, initial_value <span class="fc6 ls32">=<span class="fc7 ls34">0</span></span>):</span></span></span></div><div class="t m0 x16 hf y2e76 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_value </span><span class="ls32">=</span><span class="fc0">initial_value</span></span></div><div class="t m0 x16 hf y2e77 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">_value_lock </span><span class="ls33">=</span><span class="fc0">threading</span><span class="ls34">.</span><span class="fc0">Lock()</span></span></div><div class="t m0 x15 hf y133e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">incr<span class="fc0">(<span class="fca">self</span>,delta<span class="fc6">=<span class="fc7 ls34">1</span></span>):</span></span></div><div class="t m0 x16 h15 y2e78 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 y2e79 ffa fs5 fc9 sc0 ls0 ws4">Increment the counter with locking</div><div class="t m0 x16 h15 y2e7a ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y2e7b ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_value_lock:</span></span></div><div class="t m0 x3d hf y2e7c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws145">_value <span class="fc6 ws23d">+= </span>delta</span></div><div class="t m0 x15 hf y2e7d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decr<span class="fc0">(<span class="fca">self</span>,delta<span class="fc6">=<span class="fc7 ls34">1</span></span>):</span></span></div><div class="t m0 x16 h15 y2e7e ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 y2e7f ffa fs5 fc9 sc0 ls0 ws4">Decrement the counter with locking</div><div class="t m0 x16 h15 y2e80 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y2e81 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_value_lock:</span></span></div><div class="t m0 x3d hf y691 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws145">_value <span class="fc6 ws23d">-= </span>delta</span></div><div class="t m0 x0 h9 y2e82 ff6 fs3 fc0 sc0 ls0 ws9e5">Lock <span class="ff1 ws9d7">对象和 </span>with <span class="ff1 wsa0">语句块一起使用可以保证互斥执行，就是每次只有一个线程可以</span></div><div class="t m0 x5 h7 y2e83 ff1 fs3 fc0 sc0 ls0 ws2c9">执行 <span class="ff4 ws10a3">with </span><span class="wsa0">语句包含的代码块。<span class="ff4 ws10a4">with </span>语句会在这个代码块执行前自动获取锁，在执行结</span></div><div class="t m0 x5 h9 y2e84 ff1 fs3 fc0 sc0 ls0">束后自动释放锁。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.4.<span class="_ _36"> </span>12.4 <span class="ff1 ws600">给关键部分加锁 </span>453</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
