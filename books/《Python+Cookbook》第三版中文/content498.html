<div id="pf1f2" class="pf w0 h0" data-page-no="1f2"><div class="pc pc1f2 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1f2.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 h10 yb1e ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">time</span></div><div class="t m0 x15 hf yb1f ff8 fs5 fc0 sc0 ls0 ws13a">sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span>write(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Daemon started with pid {}<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;<span class="ff8 fc6">.</span></span></span></span>format(os<span class="fc6 ls34">.</span>getpid()))</div><div class="t m0 x15 hf yb20 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf yb21 ff8 fs5 fc0 sc0 ls0 ws13a">sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span>write(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">Daemon Alive! {}<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;</span></span></span><span class="fc6">.</span>format(time<span class="fc6 ls34">.</span>ctime()))</div><div class="t m0 x16 hf yb22 ff8 fs5 fc0 sc0 ls0 ws13a">time<span class="fc6">.</span>sleep(<span class="fc7">10</span>)</div><div class="t m0 x5 hf yb24 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf yb25 ff8 fs5 fc0 sc0 ls0 ws155">PIDFILE <span class="fc6 ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">/tmp/daemon.pid<span class="ff9">&apos;</span></span></div><div class="t m0 x15 hf yb27 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">len<span class="fc0">(sys<span class="fc6 ls34">.</span><span class="ws15f">argv) <span class="fc6 ws159">!= <span class="fc7 ls34">2</span></span>:</span></span></span></div><div class="t m0 x16 hf yfda ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Usage: {} [start<span class="ffd">|</span><span class="ws13a">stop]</span></span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13a">format(sys</span><span class="fc6">.</span><span class="ls0 ws13a">argv[</span><span class="fc7">0</span><span class="ls0 ws158">]), <span class="fca ws13a">file</span></span><span class="fc6">=</span><span class="ls0 ws13a">sys<span class="fc6">.</span>stderr)</span></span></div><div class="t m0 x16 hf y1e41 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf y1e43 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>argv[<span class="fc7">1</span><span class="ls33">]</span><span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">start<span class="ff9 ls34">&apos;</span></span>:</span></div><div class="t m0 x16 hf y1e44 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y3120 ff8 fs5 fc0 sc0 ls0">daemonize(PIDFILE,</div><div class="t m0 x47 hf y3121 ff8 fs5 fc0 sc0 ls0 ws13a">stdout<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">/tmp/daemon.log<span class="ff9 ws13b">&apos;</span></span>,</div><div class="t m0 x47 hf y3122 ff8 fs5 fc0 sc0 ls0 ws13a">stderr<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">/tmp/dameon.log<span class="ff9 ws13b">&apos;</span></span>)</div><div class="t m0 x16 hf y3123 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws150">RuntimeError </span><span class="ws160">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x17 hf y3124 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws158">(e, <span class="fca ws13a">file<span class="fc6 ls34">=</span><span class="fc0">sys<span class="fc6 ls34">.</span>stderr)</span></span></span></div><div class="t m0 x17 hf y3125 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x16 hf y3126 ff8 fs5 fc0 sc0 ls0">main()</div><div class="t m0 x15 hf y217e ff7 fs5 fca sc0 ls0 ws15a">elif <span class="ff8 fc0 ws13a">sys<span class="fc6">.</span>argv[<span class="fc7 ls34">1</span><span class="ls32">]</span><span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">stop<span class="ff9 ls34">&apos;</span></span>:</span></div><div class="t m0 x16 hf y3127 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">os<span class="fc6 ls34">.</span>path<span class="fc6 ls34">.</span>exists(PIDFILE):</span></div><div class="t m0 x17 hf y3128 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 ws13a">open<span class="fc0 ws51e">(PIDFILE) </span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x18 hf y3129 ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>kill(<span class="fca">int</span>(f<span class="fc6 ls34">.</span><span class="ws13b">read()), signal</span><span class="fc6">.</span>SIGTERM)</div><div class="t m0 x16 hf y312a ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y312b ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Not running</span>&apos;</span><span class="ls32">,</span></span><span class="ff8 ws13a">file<span class="fc6 ls34">=</span><span class="fc0">sys<span class="fc6 ls34">.</span>stderr)</span></span></div><div class="t m0 x17 hf y312c ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf y312d ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x16 hf y312e ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Unknown command {!r}</span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13a">format(sys</span><span class="fc6">.</span><span class="ls0 ws13a">argv[<span class="fc7">1</span><span class="ws158">]), </span><span class="fca">file</span></span><span class="fc6">=</span><span class="ls0 ws13a">sys</span><span class="fc6">.</span><span class="ls0">stderr)</span></span></div><div class="t m0 x16 hf y312f ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x0 h9 ye2b ff1 fs3 fc0 sc0 ls0">要启动这个守护进程，用户需要使用如下的命令：</div><div class="t m0 x5 hf y3130 ff8 fs5 fc0 sc0 ls0 ws4">bash % daemon.py start</div><div class="t m0 x5 hf y3131 ff8 fs5 fc0 sc0 ls0 ws4">bash % cat /tmp/daemon.pid</div><div class="t m0 x5 hf y3132 ff8 fs5 fc0 sc0 ls0">2882</div><div class="t m0 x5 hf y3133 ff8 fs5 fc0 sc0 ls0 ws4">bash % tail -f /tmp/daemon.log</div><div class="t m0 x5 hf y3134 ff8 fs5 fc0 sc0 ls0 ws4">Daemon started with pid 2882</div><div class="t m0 x5 hf y3135 ff8 fs5 fc0 sc0 ls0 ws4">Daemon Alive! Fri Oct 12 13:45:37 2012</div><div class="t m0 x5 hf y1965 ff8 fs5 fc0 sc0 ls0 ws4">Daemon Alive! Fri Oct 12 13:45:47 2012</div><div class="t m0 x5 hf y1966 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x0 h9 y3136 ff1 fs3 fc0 sc0 ls0 wsa0">守护进程可以完全在<span class="_ _6"></span>后台运行，因此这个命令会<span class="_ _6"></span>立即返回。不过，你可以像<span class="_ _6"></span>上面那</div><div class="t m0 x5 h7 y3137 ff1 fs3 fc0 sc0 ls0 ws14">样查看与它相关的 <span class="ff4 ws11bb">pid </span>文件和日志。要停止这个守护进程，使用：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.14.<span class="_ _36"> </span>12.14 <span class="ff1 ls7f">在</span><span class="ws11b9">Unix <span class="ff1 ws11ba">系统上面启动守护进程 </span>489</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
