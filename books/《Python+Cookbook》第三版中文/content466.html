<div id="pf1d2" class="pf w0 h0" data-page-no="1d2"><div class="pc pc1d2 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1d2.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h10 y334 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y335 ff8 fs5 fc0 sc0 ls0 ws145">x_lock <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Lock()</span></div><div class="t m0 x5 hf y336 ff8 fs5 fc0 sc0 ls0 ws145">y_lock <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Lock()</span></div><div class="t m0 x5 hf yadd ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">thread_1<span class="fc0">():</span></span></div><div class="t m0 x15 hf yade ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf yadf ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0 ws4">acquire(x_lock, y_lock):</span></div><div class="t m0 x17 hf yc64 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Thread-1<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y177c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">thread_2<span class="fc0">():</span></span></div><div class="t m0 x15 hf y177d ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y177e ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0 ws4">acquire(y_lock, x_lock):</span></div><div class="t m0 x17 hf y177f ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Thread-2<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y1781 ff8 fs5 fc0 sc0 ls0 ws159">t1 <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6 ls34">=</span>thread_1)</span></div><div class="t m0 x5 hf y1782 ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span><span class="ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x5 hf y1783 ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span>start()</div><div class="t m0 x5 hf y1785 ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6 ls34">=</span>thread_2)</span></div><div class="t m0 x5 hf y1786 ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span><span class="ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x5 hf y1787 ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span>start()</div><div class="t m0 x0 h9 y2eb6 ff1 fs3 fc0 sc0 ls3a ws153">如果你执行这段代码，你会发现它即使在不同的函数中以不同的顺序获取锁也没有</div><div class="t m0 x5 h9 y2eb7 ff1 fs3 fc0 sc0 ls40 ws180">发生死锁<span class="_ _1"></span>。其关键在于，在第一段代码中<span class="_ _c"></span>，我们对这些锁进行了排序。通过排序<span class="_ _c"></span>，使</div><div class="t m0 x5 h9 y2eb8 ff1 fs3 fc0 sc0 ls13 wse5">得不管用户以什么样的顺序来请求锁<span class="_ _1"></span>，这些锁都会按照固定的顺序被获取。如果有多<span class="_ _c"></span></div><div class="t m0 x5 h7 y2eb9 ff1 fs3 fc0 sc0 ls96">个<span class="ff6 ls0 wsc64">acquire() </span><span class="ls10 wsdf">操作被嵌套调用，可以通过线程本地存储（<span class="_ _c"></span><span class="ff4 ls0 wsa5">TLS<span class="ff1 ls10 wsdf">）来检测潜在的死锁问</span></span></span></div><div class="t m0 x5 h9 y2eba ff1 fs3 fc0 sc0 ls0">题。假设你的代码是这样写的：</div><div class="t m0 x5 h10 y2ebb ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y2ebc ff8 fs5 fc0 sc0 ls0 ws145">x_lock <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Lock()</span></div><div class="t m0 x5 hf y2ebd ff8 fs5 fc0 sc0 ls0 ws145">y_lock <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Lock()</span></div><div class="t m0 x5 hf y183f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">thread_1<span class="fc0">():</span></span></div><div class="t m0 x15 hf y2ebe ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2ebf ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0">acquire(x_lock):</span></div><div class="t m0 x17 hf y2ec0 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0">acquire(y_lock):</span></div><div class="t m0 x18 hf y2ec1 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Thread-1<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y2ec2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">thread_2<span class="fc0">():</span></span></div><div class="t m0 x15 hf y2ec3 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2ec4 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0">acquire(y_lock):</span></div><div class="t m0 x17 hf y2ec5 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0">acquire(x_lock):</span></div><div class="t m0 x18 hf y2ec6 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Thread-2<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y2ec7 ff8 fs5 fc0 sc0 ls0 ws159">t1 <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6 ls34">=</span>thread_1)</span></div><div class="t m0 x5 hf y2ec8 ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span><span class="ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x5 hf y2ec9 ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span>start()</div><div class="t m0 x5 hf y20e0 ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6 ls34">=</span>thread_2)</span></div><div class="t m0 x5 hf y2eca ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span><span class="ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.5.<span class="_ _36"> </span>12.5 <span class="ff1 ws544">防止死锁的加锁机制 </span>457</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
