<div id="pf16b" class="pf w0 h0" data-page-no="16b"><div class="pc pc16b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg16b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y334 ff8 fs5 fc2 sc0 ls0 ws13a">RuntimeError<span class="fc0 ws13b">: oops</span></div><div class="t m0 x5 hf y335 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">items</span></div><div class="t m0 x5 hf y336 ff8 fs5 fc8 sc0 ls0 ws4">[1, 2, 3, 4, 5]</div><div class="t m0 x5 hf y337 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y1fc9 ff2 fs2 fc4 sc0 ls0 wsadf">11.22.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y25b6 ff1 fs3 fc0 sc0 ls1a8 wscb9">通常情况下<span class="_ _d"></span>，如果要写一个上下文管理器<span class="_ _d"></span>，你需要定义一个类<span class="_ _d"></span>，里面包含一个<span class="_ _c"></span></div><div class="t m0 x32 h9 y25b7 ff6 fs3 fc0 sc0 ls0 ws308">enter<span class="_ _e"> </span>() <span class="ff1 ws911">和一个 </span>exit<span class="_ _e"> </span>() <span class="ff1">方法，如下所示：</span></div><div class="t m0 x5 h10 y25b8 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">time</span></div><div class="t m0 x5 hf y25b9 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">timethis<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y25ba ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, label):</span></span></span></div><div class="t m0 x16 hf y198a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">label </span><span class="ls32">=</span><span class="fc0">label</span></span></div><div class="t m0 x15 hf y25bb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__enter__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y25bc ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">start </span><span class="ls32">=</span><span class="fc0">time</span><span class="ls34">.</span><span class="fc0">time()</span></span></div><div class="t m0 x15 hf y25bd ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__exit__<span class="fc0">(<span class="fca">self</span><span class="ws4">, exc_ty, exc_val, exc_tb):</span></span></span></div><div class="t m0 x16 hf y25be ff8 fs5 fc0 sc0 ls0 ws158">end <span class="fc6 ls32">=</span><span class="ws13a">time<span class="fc6 ls34">.</span>time()</span></div><div class="t m0 x16 hf y25bf ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">{}: {}</span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13a">format(<span class="fca">self<span class="fc6">.</span></span><span class="ws4">label, end <span class="fc6 ls33">-</span></span><span class="fca">self</span></span><span class="fc6">.</span><span class="ls0">start))</span></span></div><div class="t m0 x0 h9 y25c0 ff1 fs3 fc0 sc0 ls14 wscba">尽管这个也不难写<span class="_ _1"></span>，但是相比较写一个简单的使用 <span class="ff6 ls0 ws173">@contextmanager <span class="ff1 wsa0">注<span class="_ _6"></span>解<span class="_ _6"></span>的函<span class="_ _6"></span>数</span></span></div><div class="t m0 x5 h9 y25c1 ff1 fs3 fc0 sc0 ls0">而言还是稍显乏味。</div><div class="t m0 x0 h9 y25c2 ff6 fs3 fc0 sc0 ls0 wscbb">@contextmanager <span class="ff1 ls10c ws9c5">应该仅仅用来写自包含的上下文管理函数<span class="_ _8"></span>。如果你有一些对<span class="_ _d"></span></span></div><div class="t m0 x5 h7 y25c3 ff1 fs3 fc0 sc0 ls1a9">象<span class="ff4 ls1b">(</span><span class="ls0 wsa0">比<span class="_ _0"></span>如<span class="_ _0"></span>一<span class="_ _0"></span>个<span class="_ _0"></span>文<span class="_ _0"></span>件、<span class="_ _0"></span>网<span class="_ _0"></span>络<span class="_ _0"></span>连<span class="_ _0"></span>接<span class="_ _0"></span>或<span class="_ _0"></span>锁<span class="ff4 wsa5">)</span><span class="wscbc">，<span class="_ _0"></span>需<span class="_ _0"></span>要<span class="_ _0"></span>支<span class="_ _0"></span>持 <span class="ff6 wscbd">with </span></span>语<span class="_ _0"></span>句，<span class="_ _0"></span>那<span class="_ _0"></span>么<span class="_ _6"></span>你<span class="_ _0"></span>就<span class="_ _0"></span>需<span class="_ _0"></span>要<span class="_ _0"></span>单<span class="_ _0"></span>独<span class="_ _0"></span>实<span class="_ _0"></span>现</span></div><div class="t m0 x32 h9 y25c4 ff6 fs3 fc0 sc0 ls0 ws308">enter<span class="_ _e"> </span>() <span class="ff1 ws911">方法和 </span>exit<span class="_ _e"> </span>() <span class="ff1">方法。</span></div><div class="t m0 x5 hd y25c5 ff2 fs4 fc4 sc0 ls0 ws211">11.23<span class="_ _e"> </span>9.23 <span class="ff1">在局部变量域中执行代码</span></div><div class="t m0 x5 he y25c6 ff2 fs2 fc4 sc0 ls0 wsadf">11.23.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y193e ff1 fs3 fc0 sc0 ls0">你想在使用范围内执行某个代码片段，并且希望在执行后所有的结果都不可见。</div><div class="t m0 x5 he y25c7 ff2 fs2 fc4 sc0 ls0 wsadf">11.23.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y25c8 ff1 fs3 fc0 sc0 ls0 wsa0">为了理解这个问题，先<span class="_ _6"></span>试试一个简单场景。首先，在<span class="_ _6"></span>全局命名空间内执行一<span class="_ _6"></span>个代码</div><div class="t m0 x5 h9 y25c9 ff1 fs3 fc0 sc0 ls0">片段：</div><div class="t m0 x5 hf y25ca ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=<span class="fc7 ls0">13</span></span></span></div><div class="t m0 x5 hf y25cb ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">exec<span class="ff8 fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls5e ws209">b=a+1<span class="_ _15"></span><span class="ff9 ls34">&apos;<span class="ff8 fc0 ls0">)</span></span></span></span></span></div><div class="t m0 x5 hf y25cc ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0">(b)</span></span></div><div class="t m0 x5 hf y25cd ff8 fs5 fc8 sc0 ls0">14</div><div class="t m0 x5 hf y25ce ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.23.<span class="_ _5"> </span>9.23 <span class="ff1 wsb03">在局部变量域中执行代码 </span>354</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
