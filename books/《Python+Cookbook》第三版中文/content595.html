<div id="pf253" class="pf w0 h0" data-page-no="253"><div class="pc pc253 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg253.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y334 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">addr</span></div><div class="t m0 x5 hf y335 ff8 fs5 fc8 sc0 ls0">140735505915760</div><div class="t m0 x5 h11 y337 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Turn the address into a callable function</span></div><div class="t m0 x5 hf yadd ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws1f5">functype <span class="fc6 ls33">=</span><span class="ws13a">ctypes<span class="fc6 ls34">.</span>CFUNCTYPE(ctypes<span class="fc6">.</span><span class="ws4">c_double, ctypes<span class="fc6 ls34">.</span>c_double)</span></span></span></div><div class="t m0 x5 hf yade ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13c">func <span class="fc6 ls32">=</span>functype(addr)</span></div><div class="t m0 x5 hf yadf ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">func</span></div><div class="t m0 x5 hf yc64 ff8 fs5 fc8 sc0 ls0 ws4">&lt;CFunctionType object at 0x1006816d0&gt;</div><div class="t m0 x5 h11 y177c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Call the resulting function</span></div><div class="t m0 x5 hf y177d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">func(<span class="fc7">2</span>)</span></div><div class="t m0 x5 hf y177e ff8 fs5 fc8 sc0 ls0">0.9092974268256817</div><div class="t m0 x5 hf y177f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">func(<span class="fc7">0</span>)</span></div><div class="t m0 x5 hf y1780 ff8 fs5 fc8 sc0 ls0">0.0</div><div class="t m0 x5 hf y1781 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y1180 ff2 fs2 fc4 sc0 ls0 wsadf">17.12.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2efc ff1 fs3 fc0 sc0 ls22 ws1538">要构建一个可调用对象<span class="_ _1"></span>，你首先需要创建一个 <span class="ff6 ls0 wsb3a">CFUNCTYPE <span class="ff1 ws1539">实<span class="_ _6"></span>例。 </span><span class="ws107c">CFUNCTYPE() <span class="ff1">的</span></span></span></div><div class="t m0 x5 h9 y392e ff1 fs3 fc0 sc0 ls1e ws111">第一个参数是返回类型<span class="_ _1"></span>。接下来的参数是参数类型<span class="_ _1"></span>。一旦你定义了函数类型<span class="_ _1"></span>，你就能</div><div class="t m0 x5 h9 y392f ff1 fs3 fc0 sc0 ls2d ws132">将它包装在一个整型内存地址上来创建一个可调用对象了。生成的对象被当做普通的<span class="_ _1"></span></div><div class="t m0 x5 h9 y3930 ff1 fs3 fc0 sc0 ls0 ws38">可通过 <span class="ff6 ws25d">ctypes </span>访问的函数来使用。</div><div class="t m0 x0 h9 y3931 ff1 fs3 fc0 sc0 ls0 wsa0">本节看上去可能有点<span class="_ _6"></span>神秘，偏底层一点。但是，但是<span class="_ _6"></span>它被广泛使用于各种高<span class="_ _6"></span>级代码</div><div class="t m0 x5 h7 y3932 ff1 fs3 fc0 sc0 ls0 ws14">生成技术比如即时编译，在 <span class="ff4 ws153a">LL<span class="_ _19"></span>VM <span class="ff1">函数库中可以看到。</span></span></div><div class="t m0 x0 h9 y3933 ff1 fs3 fc0 sc0 lse ws126e">例如，下面是一个使用 <span class="ff6 ls0 ws6aa">llvmpy </span><span class="wsd8">扩展的简单例子<span class="_ _1"></span>，用来构建一个小的聚集函数，获</span></div><div class="t m0 x5 h7 y3934 ff1 fs3 fc0 sc0 ls0 ws14">取它的函数指针，并将其转换为一个 <span class="ff4 ws5c">Python </span>可调用对象。</div><div class="t m0 x5 hf y3935 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws285">llvm.core </span><span class="ws146">import <span class="ff8 fc0 ws4">Module, Function, Type, Builder</span></span></span></div><div class="t m0 x5 hf y3936 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">mod <span class="fc6 ls32">=</span><span class="ws13a">Module<span class="fc6">.</span>new(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">example<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y183f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=</span><span class="ls0 ws13a">Function<span class="fc6">.</span>new(mod,Type<span class="fc6 ls34">.</span>function(Type<span class="fc6 ls34">.</span><span class="ws4">double(), \</span></span></span></div><div class="t m0 x46 hf y3937 ff8 fs5 fc8 sc0 ls0 ws4">[Type.double(), Type.double()], False), <span class="ff9 ls34">&apos;</span><span class="ws13a">foo<span class="ff9 ls34">&apos;</span>)</span></div><div class="t m0 x5 hf y3938 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">block <span class="fc6 ls33">=</span><span class="ws13a">f<span class="fc6 ls34">.</span>append_basic_block(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">entry<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y3939 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws155">builder <span class="fc6 ls32">=</span><span class="ws13a">Builder<span class="fc6 ls34">.</span>new(block)</span></span></div><div class="t m0 x5 hf y393a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">x2 <span class="fc6 ls33">=</span><span class="ws13a">builder<span class="fc6">.</span>fmul(f<span class="fc6">.</span>args[<span class="fc7 ls34">0</span>],f<span class="fc6 ls34">.</span>args[<span class="fc7 ls34">0</span>])</span></span></div><div class="t m0 x5 hf y393b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">y2 <span class="fc6 ls33">=</span><span class="ws13a">builder<span class="fc6">.</span>fmul(f<span class="fc6">.</span>args[<span class="fc7 ls34">1</span>],f<span class="fc6 ls34">.</span>args[<span class="fc7 ls34">1</span>])</span></span></div><div class="t m0 x5 hf y393c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">r<span class="fc6 ls33">=</span><span class="ls0 ws13a">builder<span class="fc6 ls34">.</span>fadd(x2,y2)</span></span></div><div class="t m0 x5 hf y393d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">builder<span class="fc6 ls34">.</span>ret(r)</span></div><div class="t m0 x5 hf y393e ff8 fs5 fc8 sc0 ls0 ws4">&lt;llvm.core.Instruction object at 0x10078e990&gt;</div><div class="t m0 x5 hf y393f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws2f0">llvm.ee </span><span class="ws146">import <span class="ff8 fc0">ExecutionEngine</span></span></span></div><div class="t m0 x5 hf y3940 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws145">engine <span class="fc6 ls32">=</span><span class="ws13a">ExecutionEngine<span class="fc6 ls34">.</span>new(mod)</span></span></div><div class="t m0 x5 hf y3941 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">ptr <span class="fc6 ls32">=</span><span class="ws13a">engine<span class="fc6">.</span>get_pointer_to_function(f)</span></span></div><div class="t m0 x5 hf y3942 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">ptr</span></div><div class="t m0 x5 hf y2ec7 ff8 fs5 fc8 sc0 ls0">4325863440</div><div class="t m0 x5 hf y3943 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">foo <span class="fc6 ls32">=</span><span class="ws13a">ctypes<span class="fc6">.</span>CFUNCTYPE(ctypes<span class="fc6 ls34">.</span><span class="ws13b">c_double, ctypes<span class="fc6 ls34">.</span><span class="ws4">c_double, ctypes</span></span><span class="fc6">.</span>c_double)(ptr)</span></span></div><div class="t m0 x5 h11 y3944 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Call the resulting function</span></div><div class="t m0 x5 hf y3945 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">foo(<span class="fc7 ls34">2</span>,<span class="fc7 ls34">3</span>)</span></div><div class="t m0 x5 hf y3946 ff8 fs5 fc8 sc0 ls0">13.0</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.12.<span class="_ _36"> </span>15.12 <span class="ff1 ws1537">将函数指针转换为可调用对象 </span>586</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
