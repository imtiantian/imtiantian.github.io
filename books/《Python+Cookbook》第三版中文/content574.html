<div id="pf23e" class="pf w0 h0" data-page-no="23e"><div class="pc pc23e w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg23e.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y1ab ff8 fs5 fc0 sc0 ls0 ws4">PyGILState_STATE state = PyGILState_Ensure();</div><div class="t m0 x19 hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">/* Verify that func is a proper callable */</div><div class="t m0 x19 hf y1ae ff8 fs5 fc0 sc0 ls0 ws4">if (!PyCallable_Check(func)) {</div><div class="t m0 x15 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">fprintf(stderr,&quot;call_func: expected a callable\n&quot;);</div><div class="t m0 x15 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws13b">goto fail;</div><div class="t m0 x19 hf y355 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y410 ff8 fs5 fc0 sc0 ls0 ws4">/* Build arguments */</div><div class="t m0 x19 hf y411 ff8 fs5 fc0 sc0 ls0 ws4">args = Py_BuildValue(&quot;(dd)&quot;, x, y);</div><div class="t m0 x19 hf yba ff8 fs5 fc0 sc0 ls0 ws4">kwargs = NULL;</div><div class="t m0 x19 hf ybed ff8 fs5 fc0 sc0 ls0 ws4">/* Call the function */</div><div class="t m0 x19 hf ybee ff8 fs5 fc0 sc0 ls0 ws4">result = PyObject_Call(func, args, kwargs);</div><div class="t m0 x19 hf ybef ff8 fs5 fc0 sc0 ls0">Py_DECREF(args);</div><div class="t m0 x19 hf ybf0 ff8 fs5 fc0 sc0 ls0">Py_XDECREF(kwargs);</div><div class="t m0 x19 hf ybf1 ff8 fs5 fc0 sc0 ls0 ws4">/* Check for Python exceptions (if any) */</div><div class="t m0 x19 hf ybf2 ff8 fs5 fc0 sc0 ls0 ws4">if (PyErr_Occurred()) {</div><div class="t m0 x15 hf ybf3 ff8 fs5 fc0 sc0 ls0">PyErr_Print();</div><div class="t m0 x15 hf ybf4 ff8 fs5 fc0 sc0 ls0 ws13b">goto fail;</div><div class="t m0 x19 hf ybf5 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf ybf7 ff8 fs5 fc0 sc0 ls0 ws4">/* Verify the result is a float object */</div><div class="t m0 x19 hf ybf8 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyFloat_Check(result)) {</div><div class="t m0 x15 hf ybf9 ff8 fs5 fc0 sc0 ls0 ws13b">fprintf(stderr,&quot;call_func: callable didn<span class="ff9 ls34">&apos;</span><span class="ws4">t return a float\n&quot;);</span></div><div class="t m0 x15 hf ybfa ff8 fs5 fc0 sc0 ls0 ws13b">goto fail;</div><div class="t m0 x19 hf ybfb ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1ed7 ff8 fs5 fc0 sc0 ls0 ws4">/* Create the return value */</div><div class="t m0 x19 hf y1ed8 ff8 fs5 fc0 sc0 ls0 ws4">retval = PyFloat_AsDouble(result);</div><div class="t m0 x19 hf y1f83 ff8 fs5 fc0 sc0 ls0">Py_DECREF(result);</div><div class="t m0 x19 hf y1eda ff8 fs5 fc0 sc0 ls0 ws4">/* Restore previous GIL state and return */</div><div class="t m0 x19 hf y1edb ff8 fs5 fc0 sc0 ls0">PyGILState_Release(state);</div><div class="t m0 x19 hf y1f84 ff8 fs5 fc0 sc0 ls0 ws4">return retval;</div><div class="t m0 x5 hf y1edc ff8 fs5 fc0 sc0 ls0">fail:</div><div class="t m0 x19 hf y1edd ff8 fs5 fc0 sc0 ls0">Py_XDECREF(result);</div><div class="t m0 x19 hf y1ede ff8 fs5 fc0 sc0 ls0">PyGILState_Release(state);</div><div class="t m0 x19 hf y1edf ff8 fs5 fc0 sc0 ls0 ws4">abort();<span class="_ _3a"> </span>// Change to something more appropriate</div><div class="t m0 x5 hf y1ee0 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y3740 ff1 fs3 fc0 sc0 ls18 ws1419">要使用这个函数，你需要获取传递过来的某个已存在 <span class="ff4 ls0 ws453">Python </span><span class="ws110">调用的引用。有很多<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y3741 ff1 fs3 fc0 sc0 lse ws141a">种方法可以让你这样做，比如将一个可调用对象传给一个扩展模块或<span class="_ _1"></span>直接写 <span class="ff4 ls20">C</span><span class="ls3d ws164">代码从</span></div><div class="t m0 x5 h9 y3742 ff1 fs3 fc0 sc0 ls0">已存在模块中提取出来。</div><div class="t m0 x0 h7 y3743 ff1 fs3 fc0 sc0 ls0 ws38">下面是一个简单例子用来掩饰从一个嵌入的 <span class="ff4 ws5c">Python </span>解释器中调用一个函数：</div><div class="t m0 x5 hf y3744 ff8 fs5 fc0 sc0 ls0 ws4">#include &lt;Python.h&gt;</div><div class="t m0 x5 hf y3745 ff8 fs5 fc0 sc0 ls0 ws4">/* Definition of call_func() same as above */</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.6.<span class="_ _36"> </span>15.6 <span class="ff1 ls81">从</span><span class="ls260">C</span><span class="ff1 ws7da">语言中调用 </span><span class="wscda">Python <span class="ff1 ws42c">代码 </span>565</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
