<div id="pf188" class="pf w0 h0" data-page-no="188"><div class="pc pc188 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg188.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1401 ff8 fs5 fc0 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1402 ff1 fs3 fc0 sc0 ls1c1 wsdaa">这个特殊的方案会安装一个特别的查找器 <span class="ff6 ls0 wsdab">UrlMetaFinder <span class="ff1 wsdac">实 例， 作 为</span></span></div><div class="t m0 x5 h9 y2822 ff6 fs3 fc0 sc0 ls0 ws3a9">sys.meta path<span class="_ _b"> </span><span class="ff1 ls129 wsdad">中最后的实体<span class="_ _d"></span>。当模块被导入时<span class="_ _d"></span>，会依据 <span class="ff6 ls0 ws3a9">sys.meta path<span class="_ _1e"> </span><span class="ff1 wsa0">中<span class="_ _0"></span>的<span class="_ _12"></span>查<span class="_ _0"></span>找</span></span></span></div><div class="t m0 x5 h9 y2823 ff1 fs3 fc0 sc0 ls14 ws174">器定位模块<span class="_ _1"></span>。在这个例子中，<span class="ff6 ls0 ws230">UrlMetaFinder </span>实例是最后一个查找器方案<span class="_ _c"></span>，当模块在</div><div class="t m0 x5 h9 y2824 ff1 fs3 fc0 sc0 ls0">任何一个普通地方都找不到的时候就触发它。</div><div class="t m0 x0 h7 y2825 ff1 fs3 fc0 sc0 ls0 wsa0">作为常见的实现方案，<span class="_ _1"></span><span class="ff6 wsdae">UrlMetaFinder <span class="ff1 wsa81">类包装在一个用户指定的 <span class="ff4 wsdaf">URL </span><span class="wsa0">上。<span class="_ _1"></span>在内部，</span></span></span></div><div class="t m0 x5 h7 y2172 ff1 fs3 fc0 sc0 ls1f ws72b">查找器通过抓取指定 <span class="ff4 ls0 ws708">URL </span><span class="ws113">的内容构建合法的链接集合。导入的时候，模块名会跟已有</span></div><div class="t m0 x5 h9 y2826 ff1 fs3 fc0 sc0 ls42 wsdb0">的链接作对比。如果找到了一个匹配的<span class="_ _1"></span>，一个单独的 <span class="ff6 ls0 wsdb1">UrlModuleLoader </span><span class="ws186">类被用来从远</span></div><div class="t m0 x5 h9 y2827 ff1 fs3 fc0 sc0 ls2d ws132">程机器上加载源代码并创建最终的模块对象。这里缓存链接的一个原因是避免不必要<span class="_ _1"></span></div><div class="t m0 x5 h7 y2828 ff1 fs3 fc0 sc0 ls4">的<span class="ff4 ls0 ws86">HTTP <span class="ff1">请求重复导入。</span></span></div><div class="t m0 x0 h9 y2829 ff1 fs3 fc0 sc0 ls3d wsdb2">自定义导入的第二种方法是编写一个钩子直接嵌入到 <span class="ff6 ls0 ws2c3">sys.path <span class="ff1 wsa0">变量中<span class="_ _6"></span>去，识别<span class="_ _6"></span>某</span></span></div><div class="t m0 x5 h9 y282a ff1 fs3 fc0 sc0 ls0 ws38">些目录命名模式。在 <span class="ff6 ws1dc">urlimport.py </span>中添加如下的类和支持函数：</div><div class="t m0 x5 h11 yd7d ffa fs5 fcd sc0 ls0 ws4"># urlimport.py</div><div class="t m0 x5 h11 ybf1 ffa fs5 fcd sc0 ls0 ws4"># ... include previous code above ...</div><div class="t m0 x5 h11 ybf2 ffa fs5 fcd sc0 ls0 ws4"># Path finder class for a URL</div><div class="t m0 x5 hf ybf3 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">UrlPathFinder<span class="ff8 fc0 ws13a">(importlib<span class="fc6 ls34">.</span>abc<span class="fc6 ls34">.</span>PathEntryFinder):</span></span></div><div class="t m0 x15 hf ybf4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, baseurl):</span></span></span></div><div class="t m0 x16 hf y282b ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_links </span><span class="ls32">=</span></span>None</div><div class="t m0 x16 hf y282c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_loader </span><span class="ls33">=</span><span class="fc0">UrlModuleLoader(baseurl)</span></span></div><div class="t m0 x16 hf y282d ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">_baseurl </span><span class="ls32">=</span><span class="fc0">baseurl</span></span></div><div class="t m0 x15 hf y282e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_loader<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fullname):</span></span></span></div><div class="t m0 x16 hf y282f ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws150">find_loader: </span><span class="ffa fcf">%r<span class="ff9 fc9 ws13b">&apos;</span></span><span class="ws4">, fullname)</span></div><div class="t m0 x16 hf ybfb ff8 fs5 fc0 sc0 ls0 ws15f">parts <span class="fc6 ls33">=</span><span class="ws13a">fullname<span class="fc6 ls34">.</span>split(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">.<span class="ff9">&apos;</span></span></span>)</span></div><div class="t m0 x16 hf y1ed6 ff8 fs5 fc0 sc0 ls0 ws1f5">basename <span class="fc6 ls33">=</span><span class="ws13a">parts[<span class="fc6 ls34">-<span class="fc7">1</span></span>]</span></div><div class="t m0 x16 h11 y1ed7 ffa fs5 fcd sc0 ls0 ws4"># Check link cache</div><div class="t m0 x16 hf y1ed8 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws145">_links </span></span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1f83 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws145">_links </span><span class="ls33">=</span><span class="fc0 ws159">[] <span class="ffa fcd ws4"># See discussion</span></span></span></div><div class="t m0 x17 hf y1ed9 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws145">_links </span><span class="ls33">=</span><span class="fc0">_get_links(</span></span>self<span class="fc6 ls34">.</span><span class="fc0">_baseurl)</span></div><div class="t m0 x16 h11 y2830 ffa fs5 fcd sc0 ls0 ws4"># Check if it<span class="ffb ls34">&apos;</span>s a package</div><div class="t m0 x16 hf y1622 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">basename </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_links:</span></span></span></div><div class="t m0 x17 hf y2831 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_loader: trying package </span><span class="ffa fcf">%r<span class="ff9 fc9 ws13b">&apos;</span></span><span class="ws4">, fullname)</span></div><div class="t m0 x17 hf y2832 ff8 fs5 fc0 sc0 ls0 ws155">fullurl <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span><span class="ws1f5">_baseurl <span class="fc6 ls33">+</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">/</span><span class="ls33">&apos;</span></span><span class="fc6 ls32">+</span>basename</span></div><div class="t m0 x17 h11 y2833 ffa fs5 fcd sc0 ls0 ws4"># Attempt to load the package (which accesses __init__.py)</div><div class="t m0 x17 hf y1328 ff8 fs5 fc0 sc0 ls0 ws145">loader <span class="fc6 ls32">=</span>UrlPackageLoader(fullurl)</div><div class="t m0 x17 hf y1edf ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x18 hf y1ee0 ff8 fs5 fc0 sc0 ls0 ws13a">loader<span class="fc6 ls34">.</span>load_module(fullname)</div><div class="t m0 x18 hf y2516 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_loader: package <span class="ffa fcf ws159">%r </span><span class="ws13a">loaded<span class="ff9 ls34">&apos;</span></span></span><span class="ws4">, fullname)</span></div><div class="t m0 x17 hf y1ee1 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws208">ImportError </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x18 hf y1ee2 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws150">find_loader: <span class="ffa fcf ws159">%r </span><span class="ws4">is a namespace package<span class="ff9 ls34">&apos;</span></span></span><span class="ws13b">, fullname)</span></div><div class="t m0 x18 hf y1ee3 ff8 fs5 fc0 sc0 ls0 ws145">loader <span class="fc6 ls32">=</span><span class="fca">None</span></div><div class="t m0 x17 hf y2834 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13b">(loader, [fullurl])</span></div><div class="t m0 x16 h11 y2835 ffa fs5 fcd sc0 ls0 ws4"># A normal module</div><div class="t m0 x16 hf y2836 ff8 fs5 fc0 sc0 ls0 ws1f5">filename <span class="fc6 ls33">=</span>basename <span class="fc6 ls33">+<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">.py<span class="ff9">&apos;</span></span></div><div class="t m0 x16 hf y2837 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">filename </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_links:</span></span></span></div><div class="t m0 x17 hf y2838 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_loader: module <span class="ffa fcf ws159">%r </span><span class="ws13a">found<span class="ff9 ls34">&apos;</span></span><span class="fc0">, fullname)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">12.11.<span class="_ _5"> </span>10.11 <span class="ff1 wsd98">通过钩子远程加载模块 </span>383</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
