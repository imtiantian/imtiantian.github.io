<div id="pf1ba" class="pf w0 h0" data-page-no="1ba"><div class="pc pc1ba w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ba.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>sendmsg([b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">x<span class="ff9 ls34">&apos;</span></span>],</div><div class="t m0 x41 hf y1ac ff8 fs5 fc0 sc0 ls0 ws13a">[(socket<span class="fc6 ls34">.</span><span class="ws13b">SOL_SOCKET, socket<span class="fc6 ls34">.</span>SCM_RIGHTS, struct<span class="fc6 ls34">.</span></span>pack(<span class="ff9 fc9 ls34">&apos;<span class="ff8">i</span><span class="ls0 ws13b">&apos;</span></span><span class="ws4">, fd))])</span></div><div class="t m0 x15 hf y1ad ff8 fs5 fc0 sc0 ls0 ws158">ack <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>recv(<span class="fc7">2</span>)</span></div><div class="t m0 x15 hf y1ae ff7 fs5 fca sc0 ls0 ws146">assert <span class="ff8 fc0 ws158">ack <span class="fc6 ws159">== </span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">OK<span class="ff9">&apos;</span></span></span></div><div class="t m0 x5 hf y1b0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">server<span class="fc0 ws4">(work_address, port):</span></span></div><div class="t m0 x15 h11 y355 ffa fs5 fcd sc0 ls0 ws4"># Wait for the worker to connect</div><div class="t m0 x15 hf y410 ff8 fs5 fc0 sc0 ls0 ws16e">work_serv <span class="fc6 ls33">=</span><span class="ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws13b">AF_UNIX, socket<span class="fc6 ls34">.</span>SOCK_STREAM)</span></span></div><div class="t m0 x15 hf y411 ff8 fs5 fc0 sc0 ls0 ws13a">work_serv<span class="fc6 ls34">.</span>bind(work_address)</div><div class="t m0 x15 hf yba ff8 fs5 fc0 sc0 ls0 ws13a">work_serv<span class="fc6 ls34">.</span>listen(<span class="fc7 ls34">1</span>)</div><div class="t m0 x15 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws13b">worker, addr <span class="fc6 ls33">=</span><span class="ws13a">work_serv<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x15 h11 ybee ffa fs5 fcd sc0 ls0 ws4"># Now run a TCP/IP server and send clients to worker</div><div class="t m0 x15 hf ybef ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws4">AF_INET, socket<span class="fc6 ls34">.</span>SOCK_STREAM)</span></span></div><div class="t m0 x15 hf ybf0 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">setsockopt(socket</span>.</span><span class="ls0 ws4">SOL_SOCKET, socket<span class="fc6 ws13a">.</span><span class="ws147">SO_REUSEADDR, <span class="fca ws13a">True</span>)</span></span></div><div class="t m0 x15 hf yd7d ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bind((<span class="ff9 fc9 ws13b">&apos;&apos;</span>,port))</span></span></div><div class="t m0 x15 hf ybf1 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">listen(</span></span><span class="fc7">1</span><span class="ls0">)</span></div><div class="t m0 x15 hf ybf2 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf ybf3 ff8 fs5 fc0 sc0 ls0 ws13b">client, addr <span class="fc6 ls33">=</span><span class="ws13a">s<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x16 hf ybf4 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws4">SERVER: Got connection from<span class="ff9 ws13b">&apos;</span><span class="fc0">, addr)</span></span></span></span></div><div class="t m0 x16 hf ybf5 ff8 fs5 fc0 sc0 ls0 ws13b">send_fd(worker, client<span class="fc6 ls34">.</span>fileno())</div><div class="t m0 x16 hf ybf6 ff8 fs5 fc0 sc0 ls0 ws13a">client<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 hf ybf8 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 h10 ybf9 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x15 hf ybfa ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">len<span class="fc0">(sys<span class="fc6 ls34">.</span><span class="ws15f">argv) <span class="fc6 ws159">!= <span class="fc7 ls34">3</span></span>:</span></span></span></div><div class="t m0 x16 hf ybfb ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws4">Usage: server.py server_address port</span>&apos;</span><span class="ls32">,</span></span><span class="ff8 ws13a">file<span class="fc6 ls34">=</span><span class="fc0">sys<span class="fc6 ls34">.</span>stderr)</span></span></div><div class="t m0 x16 hf y1ed6 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf y1ed8 ff8 fs5 fc0 sc0 ls0 ws13a">server(sys<span class="fc6 ls34">.</span>argv[<span class="fc7">1</span><span class="ws159">], </span><span class="fca">int</span>(sys<span class="fc6">.</span>argv[<span class="fc7 ls34">2</span>]))</div><div class="t m0 x0 h9 y2cc9 ff1 fs3 fc0 sc0 ls0">下面是使用套接字的工作者实现：</div><div class="t m0 x5 h11 y2cca ffa fs5 fcd sc0 ls0 ws4"># worker.py</div><div class="t m0 x5 h10 y2ccb ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">socket</span></div><div class="t m0 x5 h10 y2ccc ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">struct</span></div><div class="t m0 x5 hf y2ccd ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">recv_fd<span class="fc0">(sock):</span></span></div><div class="t m0 x15 h15 y2cce ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2ccf ffa fs5 fc9 sc0 ls0 ws4">Receive a single file descriptor</div><div class="t m0 x15 h15 y2cd0 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y2cd1 ff8 fs5 fc0 sc0 ls0 ws4">msg, ancdata, flags, addr <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>recvmsg(<span class="fc7">1</span>,</span></div><div class="t m0 xd hf y2cd2 ff8 fs5 fc0 sc0 ls0 ws13a">socket<span class="fc6 ls34">.</span>CMSG_LEN(struct<span class="fc6 ls34">.</span>calcsize(<span class="ff9 fc9 ls34">&apos;<span class="ff8">i</span><span class="ls0 ws13b">&apos;</span></span>)))</div><div class="t m0 x15 hf y21b5 ff8 fs5 fc0 sc0 ls0 ws13b">cmsg_level, cmsg_type, cmsg_data <span class="fc6 ls32">=</span><span class="ws13a">ancdata[<span class="fc7 ls34">0</span>]</span></div><div class="t m0 x15 hf y21b6 ff7 fs5 fca sc0 ls0 ws146">assert <span class="ff8 fc0 ws2a3">cmsg_level <span class="fc6 ws159">== </span><span class="ws13a">socket<span class="fc6">.</span></span>SOL_SOCKET </span><span class="ws139">and <span class="ff8 fc0 ws16e">cmsg_type <span class="fc6 ws15c">== </span><span class="ws13a">socket<span class="fc6 ls34">.</span>SCM_RIGHTS</span></span></span></div><div class="t m0 x15 hf y2cd3 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>sendall(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">OK<span class="ff9 ls34">&apos;</span></span>)</div><div class="t m0 x15 hf y2cd4 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">struct<span class="fc6 ls34">.</span>unpack(<span class="ff9 fc9 ls34">&apos;<span class="ff8">i</span><span class="ls0 ws13b">&apos;</span></span><span class="ws4">, cmsg_data)[<span class="fc7 ls34">0</span>]</span></span></div><div class="t m0 x5 hf y2cd5 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">worker<span class="fc0">(server_address):</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.11.<span class="_ _36"> </span>11.11 <span class="ff1 ws36c">进程间传递 </span><span class="wsffc">So<span class="_ _0"></span>ck<span class="_ _c"></span>et <span class="ff1 wsffd">文件描述符 </span>433</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
