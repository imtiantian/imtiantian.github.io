<div id="pfa5" class="pf w0 h0" data-page-no="a5"><div class="pc pca5 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bga5.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">7.15.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y675 ff1 fs3 fc0 sc0 ls3a ws153">这一小节讨论的是在编写必须处理文件系统的程序时一个不太常见但又很棘手的问</div><div class="t m0 x5 h7 y676 ff1 fs3 fc0 sc0 ls0 wsa0">题。默认情况下，<span class="ff4 ws4eb">Python </span><span class="ls3a ws6d0">假定所有文件名都已经根据 </span><span class="ff6">sys.getfilesystemencoding()</span></div><div class="t m0 x5 h9 y677 ff1 fs3 fc0 sc0 ls0 wsa0">的<span class="_ _6"></span>值编<span class="_ _6"></span>码<span class="_ _6"></span>过<span class="_ _6"></span>了。<span class="_ _6"></span>但<span class="_ _6"></span>是，有<span class="_ _6"></span>一<span class="_ _6"></span>些<span class="_ _6"></span>文<span class="_ _6"></span>件<span class="_ _6"></span>系统<span class="_ _6"></span>并<span class="_ _6"></span>没<span class="_ _6"></span>有<span class="_ _6"></span>强<span class="_ _6"></span>制<span class="_ _6"></span>要求<span class="_ _6"></span>这<span class="_ _6"></span>样<span class="_ _6"></span>做，<span class="_ _6"></span>因<span class="_ _6"></span>此允<span class="_ _6"></span>许<span class="_ _6"></span>创<span class="_ _6"></span>建<span class="_ _6"></span>文<span class="_ _6"></span>件名</div><div class="t m0 x5 h9 y678 ff1 fs3 fc0 sc0 ls13 wse5">没有正确编码的文件<span class="_ _1"></span>。这种情况不太常见，但是总会有些用户冒险这样做或者是无意<span class="_ _c"></span></div><div class="t m0 x5 h7 y679 ff1 fs3 fc0 sc0 ls0 ws91">之中这样做了 <span class="ff4 ls118">(</span><span class="ws2c8">可能是在一个有缺陷的代码中给 <span class="ff6 ws6d1">open() </span>函数传递了一个不合规范的文</span></div><div class="t m0 x5 h7 y67a ff1 fs3 fc0 sc0 ls0 wsa0">件名<span class="ff4 ls1b">)</span>。</div><div class="t m0 x0 h7 y11f0 ff1 fs3 fc0 sc0 ls0 ws6d2">当<span class="_ _6"></span>执<span class="_ _6"></span>行<span class="_ _6"></span>类<span class="_ _6"></span>似 <span class="ff6 ws6d3">os.listdir() </span><span class="lsa5 ws6d4">这样的函数时<span class="_ _1"></span>，这些不合规范的文件名就会让 <span class="ff4 ls0">Python</span></span></div><div class="t m0 x5 h9 y11f1 ff1 fs3 fc0 sc0 ls1e ws111">陷入困境<span class="_ _1"></span>。一方面，它不能仅仅只是丢弃这些不合格的名字<span class="_ _c"></span>。而另<span class="_ _6"></span>一方面<span class="_ _1"></span>，它又不能</div><div class="t m0 x5 h7 y11f2 ff1 fs3 fc0 sc0 ls2c ws12f">将这些文件名转换为正确的文本字符串。<span class="ff4 ls0 ws10f">Python </span>对这个问题的解决方案是从文件名中</div><div class="t m0 x5 h7 y11f3 ff1 fs3 fc0 sc0 ls19 ws6d5">获取未解码的字节值比如 <span class="ffd ls84">\<span class="ff6 ls0 ws6d6">xhh </span></span><span class="ws6d7">并将它映射成 <span class="ff4 ls0 ws6d8">Unico<span class="_ _6"></span>de <span class="ff1 ws6d9">字符 <span class="ffd ls84">\</span><span class="ff6 ws4ba">udchh </span></span></span><span class="ws22a">表示的所谓的<span class="ff4 ls119">”</span><span class="ls0">代</span></span></span></div><div class="t m0 x5 h7 y11f4 ff1 fs3 fc0 sc0 ls17 wsf6">理编码<span class="ff4 ls8e">”</span><span class="ws6da">。下面一个例子演示了当一个不合格目录列表中含有一个文件名为 <span class="ff4 ls0 wsa5">bäd.txt(<span class="ff1">使</span></span></span></div><div class="t m0 x5 h7 y11f5 ff1 fs3 fc0 sc0 ls4">用<span class="ff4 ls0 ws60f">Latin-1 </span><span class="ls0 ws38">而不是 <span class="ff4 ws61f">UTF-8 </span><span class="wsa0">编码<span class="ff4 ls11a">)</span>时的样子：</span></span></div><div class="t m0 x5 h10 y11f6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">os</span></span></div><div class="t m0 x5 hf y11f7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">files <span class="fc6 ls33">=</span><span class="ws13a">os<span class="fc6 ls34">.</span>listdir(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">.<span class="ff9">&apos;</span></span></span>)</span></span></div><div class="t m0 x5 hf y11f8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">files</span></div><div class="t m0 x5 hf y11f9 ff8 fs5 fc8 sc0 ls34">[<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws13a">spam.py<span class="ff9 ws13b">&apos;</span><span class="ls33">,</span><span class="ff9 ws13b">&apos;</span>b\udce4d.txt</span><span class="ff9">&apos;</span><span class="ls32">,</span><span class="ff9">&apos;</span><span class="ls0 ws13a">foo.txt</span><span class="ff9">&apos;</span><span class="ls0">]</span></div><div class="t m0 x5 hf y11fa ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y11fb ff1 fs3 fc0 sc0 ls3d ws6db">如果你有代码需要操作文件名或者将文件名传递给 <span class="ff6 ls0 ws20b">open() <span class="ff1 wsa0">这样<span class="_ _6"></span>的函<span class="_ _6"></span>数，一切<span class="_ _6"></span>都能</span></span></div><div class="t m0 x5 h7 y11fc ff1 fs3 fc0 sc0 ls1f ws6dc">正常工作。只有当你想要输出文件名时才会碰到些麻烦 <span class="ff4 ls1b">(</span><span class="ws113">比如打印输出到屏幕或日志文</span></div><div class="t m0 x5 h7 y11fd ff1 fs3 fc0 sc0 ls0 wsa0">件等<span class="ff4 ls1b">)</span>。特别的，当你想打印上面的文件名列表时，你的程序就会崩溃：</div><div class="t m0 x5 hf y11fe ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">for <span class="ff8 fc0 ws161">name </span><span class="ws160">in <span class="ff8 fc0">files:</span></span></span></div><div class="t m0 x5 hf y11ff ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0">(name)</span></span></div><div class="t m0 x5 h10 y1200 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y1201 ff8 fs5 fc8 sc0 ls0">spam.py</div><div class="t m0 x5 hf y1202 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y1203 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">2</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x5 hf y1204 ff8 fs5 fc2 sc0 ls0 ws13a">UnicodeEncodeError<span class="fc0 ls33">:<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0">utf-8<span class="ff9 ls32">&apos;</span><span class="ws4">codec can<span class="ff9 ls34">&apos;</span><span class="ws13b">t encode character <span class="ff9 ls34">&apos;</span></span></span>\udce4<span class="ff9 ls32">&apos;</span>in</span></span></div><div class="t m0 x5 hf y1205 ff8 fs5 fc8 sc0 ls0 ws4">position 1: surrogates not allowed</div><div class="t m0 x5 hf y1206 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y1207 ff1 fs3 fc0 sc0 ls23 ws6dd">程序崩溃的原因就是字符 <span class="ffd ls0 ws305">\<span class="ff6 ws6de">udce4 </span></span><span class="ws6df">是一个非法的 <span class="ff4 ls0 ws6e0">Unico<span class="_ _6"></span>de </span><span class="ws11a">字符<span class="_ _c"></span>。它其实是一个被<span class="_ _c"></span></span></span></div><div class="t m0 x5 h9 y1208 ff1 fs3 fc0 sc0 ls13 wse5">称为代理字符对的双字符组合的后半部分<span class="_ _1"></span>。由于缺少了前半部分，因此它是个非法的<span class="_ _c"></span></div><div class="t m0 x5 h7 y1209 ff4 fs3 fc0 sc0 ls0 wsa5">Unico<span class="_ _6"></span>de<span class="ff1 ls2c ws12f">。所以，唯一能成功输出的方法就是当遇到不合法文件名时采取相应的补救措</span></div><div class="t m0 x5 h9 y120a ff1 fs3 fc0 sc0 ls0">施。比如可以将上述代码修改如下：</div><div class="t m0 x5 hf y120b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">for <span class="ff8 fc0 ws161">name </span><span class="ws160">in <span class="ff8 fc0">files:</span></span></span></div><div class="t m0 x5 hf y120c ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca ws156">try<span class="ff8 fc0">:</span></span></div><div class="t m0 x5 hf y120d ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0">(name)</span></span></div><div class="t m0 x5 hf y120e ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca ws146">except <span class="ff8 ws13a">UnicodeEncodeError<span class="fc0">:</span></span></span></div><div class="t m0 x5 hf y120f ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0">(bad_filename(name))</span></span></div><div class="t m0 x5 h10 y1210 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y1211 ff8 fs5 fc8 sc0 ls0">spam.py</div><div class="t m0 x5 hf y1212 ff8 fs5 fc8 sc0 ls0">b\udce4d.txt</div><div class="t m0 x5 hf y1213 ff8 fs5 fc8 sc0 ls0">foo.txt</div><div class="t m0 x5 hf y1214 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">7.15.<span class="_ _5"> </span>5.15 <span class="ff1 ws544">打印不合法的文件名 </span>156</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
