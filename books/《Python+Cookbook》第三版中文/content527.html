<div id="pf20f" class="pf w0 h0" data-page-no="20f"><div class="pc pc20f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg20f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y181 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wsb44">unittest.mock </span><span class="ws146">import <span class="ff8 fc0">patch</span></span></div><div class="t m0 x5 h10 y182 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">example</span></div><div class="t m0 x5 hf y184 ff7 fs5 fc12 sc0 ls0 ws156">@patch<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">example.func<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y185 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test1<span class="fc0 ws13b">(x, mock_func):</span></span></div><div class="t m0 x15 hf y186 ff8 fs5 fc0 sc0 ls0 ws13a">example<span class="fc6 ls34">.</span><span class="ws128f">func(x) <span class="ffa fcd ws4"># Uses patched example.func</span></span></div><div class="t m0 x15 hf y187 ff8 fs5 fc0 sc0 ls0 ws13a">mock_func<span class="fc6 ls34">.</span>assert_called_with(x)</div><div class="t m0 x0 h9 y332e ff1 fs3 fc0 sc0 ls0">它还可以被当做一个上下文管理器：</div><div class="t m0 x5 hf y332f ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">example.func<span class="ff9 ls34">&apos;</span></span><span class="ls33">)</span></span><span class="ws157">as <span class="ff8 fc0">mock_func:</span></span></div><div class="t m0 x15 hf y192e ff8 fs5 fc0 sc0 ls0 ws13a">example<span class="fc6 ls34">.</span><span class="ws1290">func(x) <span class="ffa fcd ws4"># Uses patched example.func</span></span></div><div class="t m0 x15 hf y3330 ff8 fs5 fc0 sc0 ls0 ws13a">mock_func<span class="fc6 ls34">.</span>assert_called_with(x)</div><div class="t m0 x0 h9 y864 ff1 fs3 fc0 sc0 ls0">最后，你还可以手动的使用它打补丁：</div><div class="t m0 x5 hf y3331 ff8 fs5 fc0 sc0 ls32">p<span class="fc6 ls33">=</span><span class="ls0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">example.func<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 hf y3332 ff8 fs5 fc0 sc0 ls0 ws16e">mock_func <span class="fc6 ls33">=</span><span class="ws13a">p<span class="fc6 ls34">.</span>start()</span></div><div class="t m0 x5 hf y3333 ff8 fs5 fc0 sc0 ls0 ws13a">example<span class="fc6 ls34">.</span>func(x)</div><div class="t m0 x5 hf y3334 ff8 fs5 fc0 sc0 ls0 ws13a">mock_func<span class="fc6">.</span>assert_called_with(x)</div><div class="t m0 x5 hf y3335 ff8 fs5 fc0 sc0 ls34">p<span class="fc6 ls0 ws13a">.<span class="fc0">stop()</span></span></div><div class="t m0 x0 h9 y3336 ff1 fs3 fc0 sc0 ls0">如果可能的话，你能够叠加装饰器和上下文管理器来给多个对象打补丁。例如：</div><div class="t m0 x5 hf y3337 ff7 fs5 fc12 sc0 ls0 ws156">@patch<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">example.func1</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y3338 ff7 fs5 fc12 sc0 ls0 ws156">@patch<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">example.func2</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y3339 ff7 fs5 fc12 sc0 ls0 ws156">@patch<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">example.func3</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y333a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test1<span class="fc0 ws13b">(mock1, mock2, mock3):</span></span></div><div class="t m0 x15 hf y333b ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 hf yff ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test2<span class="fc0">():</span></span></div><div class="t m0 x15 hf y100 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">example.patch1<span class="ff9 ls34">&apos;</span></span><span class="ls32">)</span></span><span class="ws157">as <span class="ff8 fc0 ws4">mock1, \</span></span></div><div class="t m0 x2b hf y101 ff8 fs5 fc0 sc0 ls0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">example.patch2<span class="ff9 ls34">&apos;</span></span><span class="ls32">)</span><span class="ff7 fca ws157">as </span><span class="ws4">mock2, \</span></div><div class="t m0 x2b hf y102 ff8 fs5 fc0 sc0 ls0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">example.patch3<span class="ff9 ls34">&apos;</span></span><span class="ls32">)</span><span class="ff7 fca ws157">as </span>mock3:</div><div class="t m0 x15 hf y103 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 he y669 ff2 fs2 fc4 sc0 ls0 ws212">16.2.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y333c ff6 fs3 fc0 sc0 ls0 ws23e">patch() <span class="ff1 ls68 ws23f">接受一个已存在对象的全路径名，将其替换为一个新的值。原来的值会在</span></div><div class="t m0 x5 h9 y333d ff1 fs3 fc0 sc0 ls0 ws1291">装饰器函数或上下文管理器完成后自动恢复回来。<span class="_ _d"></span>默认情况下，<span class="_ _d"></span>所有值会被 <span class="ff6">MagicMock</span></div><div class="t m0 x5 h9 y333e ff1 fs3 fc0 sc0 ls0">实例替代。例如：</div><div class="t m0 x5 hf y333f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">x<span class="fc6 ls33">=<span class="fc7 ls0">42</span></span></span></div><div class="t m0 x5 hf y3340 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">with <span class="ff8 fc0 ws13a">patch(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">__main__.x<span class="ff9 ls34">&apos;</span></span>):</span></span></div><div class="t m0 x5 hf y3341 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0">(x)</span></span></div><div class="t m0 x5 h10 y3342 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y3343 ff8 fs5 fc8 sc0 ls0 ws4">&lt;MagicMock name=<span class="ff9 ws13b">&apos;</span><span class="ls34">x<span class="ff9 ls33">&apos;</span></span><span class="ws13a">id=<span class="ff9 ws13b">&apos;</span>4314230032<span class="ff9 ws13b">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y3344 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">x</span></div><div class="t m0 x5 hf y3345 ff8 fs5 fc8 sc0 ls0">42</div><div class="t m0 x5 hf y1f82 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">16.2.<span class="_ _36"> </span>14.2 <span class="ff1 ws98a">在单元测试中给对象打补丁 </span>518</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
