<div id="pf238" class="pf w0 h0" data-page-no="238"><div class="pc pc238 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg238.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y1ab ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">if (!(p2 = PyPoint_AsPoint(py_p2))) {</div><div class="t m0 x15 hf y1ad ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y1ae ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">result = distance(p1,p2);</div><div class="t m0 x19 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;d&quot;, result);</div><div class="t m0 x5 hf y355 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y36d6 ff1 fs3 fc0 sc0 ls4">在<span class="ff4 ls0 ws5c">Python <span class="ff1">中可以像下面这样来使用这些函数：</span></span></div><div class="t m0 x5 h10 y357 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y358 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p1 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">2</span>,<span class="fc7 ls34">3</span>)</span></span></div><div class="t m0 x5 hf yca3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p2 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">4</span>,<span class="fc7 ls34">5</span>)</span></span></div><div class="t m0 x5 hf y1fa8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">p1</span></div><div class="t m0 x5 hf y1fa9 ff8 fs5 fc8 sc0 ls0 ws4">&lt;capsule object &quot;Point&quot; at 0x1004ea330&gt;</div><div class="t m0 x5 hf y1faa ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">p2</span></div><div class="t m0 x5 hf y36d7 ff8 fs5 fc8 sc0 ls0 ws4">&lt;capsule object &quot;Point&quot; at 0x1005d1db0&gt;</div><div class="t m0 x5 hf y36d8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>distance(p1,p2)</span></div><div class="t m0 x5 hf y36d9 ff8 fs5 fc8 sc0 ls0">2.8284271247461903</div><div class="t m0 x5 hf y36da ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y36db ff2 fs2 fc4 sc0 ls0 ws212">17.4.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y36dc ff1 fs3 fc0 sc0 ls0 ws13e7">胶<span class="_ _12"></span>囊<span class="_ _0"></span>和 <span class="ff4 ls261">C</span><span class="ls1e5 wsf41">指针类<span class="_ _6"></span>似<span class="_ _8"></span>。在内部<span class="_ _8"></span>，它们获取一个通用指针和一个名称<span class="_ _8"></span>，<span class="_ _6"></span>可以使用<span class="_ _8"></span></span></div><div class="t m0 x5 h9 y36dd ff6 fs3 fc0 sc0 ls0 wsc64">PyCapsule New() <span class="ff1 ls36 ws14a">函数很容易的被创建。另外<span class="_ _c"></span>，一个可选的析构函数能被绑定到胶囊<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y36de ff1 fs3 fc0 sc0 ls0">上，用来在胶囊对象被垃圾回收时释放底层的内存。</div><div class="t m0 x0 h9 y36df ff1 fs3 fc0 sc0 lse ws13e8">要提取胶囊中的指针，可使用 <span class="ff6 ls0 ws335">PyCapsule GetPointer() <span class="ff1 wsa0">函数<span class="_ _6"></span>并指定<span class="_ _6"></span>名称。<span class="_ _6"></span>如果提</span></span></div><div class="t m0 x5 h7 y36e0 ff1 fs3 fc0 sc0 ls0 ws63">供的名称和胶囊不匹配或其他错误出现，那么就会抛出异常并返回 <span class="ff4 wsa5">NULL</span>。</div><div class="t m0 x0 h9 y36e1 ff1 fs3 fc0 sc0 ls0 ws13e9">本<span class="_ _6"></span>节<span class="_ _6"></span>中，<span class="_ _0"></span>一对<span class="_ _0"></span>工<span class="_ _6"></span>具<span class="_ _6"></span>函<span class="_ _6"></span>数<span class="_ _6"></span>—<span class="_ _8"></span>— <span class="ff6 ws67b">PyPoint FromPoint()<span class="_ _18"> </span></span><span class="lsc5">和</span><span class="ff6 ws470">PyPoint AsPoint() </span><span class="wsa0">被<span class="_ _0"></span>用来</span></div><div class="t m0 x5 h7 y36e2 ff1 fs3 fc0 sc0 ls40 ws13ea">创建和从胶囊对象中提取 <span class="ff4 ls0 ws13eb">P<span class="_ _1"></span>oin<span class="_ _1"></span>t <span class="ff1 ls40 ws180">实例。在任何扩展函数中<span class="_ _c"></span>，我们会使用这些函数而不</span></span></div><div class="t m0 x5 h7 y36e3 ff1 fs3 fc0 sc0 ls1e ws13ec">是直接使用胶囊对象<span class="_ _1"></span>。这种设计使得我们可以很容易的应对将来对 <span class="ff4 ls0 ws13ed">Poin<span class="_ _c"></span>t <span class="ff1 ls1e ws111">底下的包装</span></span></div><div class="t m0 x5 h9 y36e4 ff1 fs3 fc0 sc0 ls0">的更改。例如，如果你决定使用另外一个胶囊了，那么只需要更改这两个函数即可。</div><div class="t m0 x0 h9 y36e5 ff1 fs3 fc0 sc0 ls0 ws13ee">对于胶囊对象一个难点在于垃圾回收和内存管理。 <span class="ff6 ws13ef">PyPoint<span class="_ _7"> </span>FromPoint() </span>函数接受</div><div class="t m0 x5 h7 y36e6 ff1 fs3 fc0 sc0 ls0 ws6d9">一个 <span class="ff6 ws13f0">must<span class="_ _7"> </span>free </span><span class="ls19 ws13f1">参数，用来指定当胶囊被销毁时底层 </span><span class="ff4 wsfa">P<span class="_ _c"></span>oint * <span class="ff1 ls19 ws22a">结构体是否应该被回收。<span class="_ _1"></span></span></span></div><div class="t m0 x5 h7 y36e7 ff1 fs3 fc0 sc0 ls0 ws4e4">在某<span class="_ _6"></span>些 <span class="ff4 ls209">C</span><span class="ws13f2">代码<span class="_ _6"></span>中，归<span class="_ _6"></span>属问题<span class="_ _6"></span>通常<span class="_ _6"></span>很难<span class="_ _6"></span>被处<span class="_ _6"></span>理（比<span class="_ _6"></span>如一<span class="_ _6"></span>个 <span class="ff4 ws13f3">P<span class="_ _c"></span>oint <span class="ff1 wsa0">结构体<span class="_ _6"></span>被嵌<span class="_ _6"></span>入到<span class="_ _6"></span>一个<span class="_ _6"></span>被</span></span></span></div><div class="t m0 x5 h9 y36e8 ff1 fs3 fc0 sc0 ls1e ws13f4">单独管理的大结构体中<span class="_ _1"></span>）<span class="_ _f"></span>。程序员可以使用 <span class="ff6 ls0 ws2b7">extra </span><span class="ws111">参数来控制<span class="_ _c"></span>，而不是单方面的决定</span></div><div class="t m0 x5 h9 ycb7 ff1 fs3 fc0 sc0 ls0 ws13f5">垃<span class="_ _6"></span>圾<span class="_ _6"></span>回<span class="_ _6"></span>收。<span class="_ _6"></span>要<span class="_ _6"></span>注<span class="_ _6"></span>意<span class="_ _6"></span>的<span class="_ _0"></span>是和<span class="_ _6"></span>现<span class="_ _6"></span>有<span class="_ _0"></span>胶囊<span class="_ _6"></span>有<span class="_ _6"></span>关<span class="_ _0"></span>的析<span class="_ _6"></span>构<span class="_ _6"></span>器<span class="_ _0"></span>能使<span class="_ _6"></span>用 <span class="ff6 wsc6b">PyCapsule SetDestructor()</span></div><div class="t m0 x5 h9 y36e9 ff1 fs3 fc0 sc0 ls0">函数来更改。</div><div class="t m0 x0 h7 y36ea ff1 fs3 fc0 sc0 lsd3 ws13f6">对于涉及到结构体的 <span class="ff4 ls262">C</span><span class="ws4b2">代码而言<span class="_ _c"></span>，使用胶囊是一个比较合理的解决方案。例如<span class="_ _d"></span>，</span></div><div class="t m0 x5 h9 y1591 ff1 fs3 fc0 sc0 ls2d ws132">有时候你并不关心暴露结构体的内部信息或者将其转换成一个完整的扩展类型。通过<span class="_ _1"></span></div><div class="t m0 x5 h9 y36eb ff1 fs3 fc0 sc0 ls0">使用胶囊，你可以在它上面放一个轻量级的包装器，然后将它传给其他的扩展函数。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.4.<span class="_ _36"> </span>15.4 <span class="ff1 ls81">在</span><span class="ls260">C</span><span class="ff1 ws13e5">扩展模块中操作隐形指针 </span>559</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
