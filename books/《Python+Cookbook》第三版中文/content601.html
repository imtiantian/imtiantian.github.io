<div id="pf259" class="pf w0 h0" data-page-no="259"><div class="pc pc259 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg259.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0 ws2c8">对于那些需要处理机器本地 <span class="ff6 ws1574">wchar<span class="_ _7"> </span>t </span><span class="wsa0">类型的库函数，你可以像下面这样编写扩展代</span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">码：</div><div class="t m0 x5 hf y48d ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_wchars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y48e ff8 fs5 fc0 sc0 ls0 ws4">wchar_t *s;</div><div class="t m0 x19 hf y48f ff8 fs5 fc0 sc0 ls0 ws1303">Py_ssize_t len;</div><div class="t m0 x19 hf y7ab ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;u#&quot;, &amp;s, &amp;len)) {</div><div class="t m0 x15 hf y1760 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y1761 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1762 ff8 fs5 fc0 sc0 ls0">print_wchars(s,len);</div><div class="t m0 x19 hf y1763 ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y1764 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y39bf ff1 fs3 fc0 sc0 ls0">下面是一个交互会话来演示这个函数是如何工作的：</div><div class="t m0 x5 hf ycfd ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalape<span class="ff7 ws156">\u00f1</span><span class="ws13a">o<span class="ff9">&apos;</span></span></span></span></span></span></div><div class="t m0 x5 hf ycfe ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">print_chars(s)</span></div><div class="t m0 x5 hf ycff ff8 fs5 fc8 sc0 ls0 ws4">53 70 69 63 79 20 4a 61 6c 61 70 65 c3 b1 6f</div><div class="t m0 x5 hf yd00 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">print_wchars(s)</span></div><div class="t m0 x5 hf yd01 ff8 fs5 fc8 sc0 ls0 ws4">53 70 69 63 79 20 4a 61 6c 61 70 65 f1 6f</div><div class="t m0 x5 hf y1932 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y39c0 ff1 fs3 fc0 sc0 ls19 ws1575">仔细观察这个面向字节的函数 <span class="ff6 ls0 ws474">print chars() </span><span class="ws1576">是怎样接受 <span class="ff4 ls0 ws1577">UTF-8 </span><span class="ws22a">编码数据的，以</span></span></div><div class="t m0 x5 h7 ya5 ff1 fs3 fc0 sc0 ls4">及<span class="ff6 ls0 ws1f3">print<span class="_ _7"> </span>wchars() </span><span class="ls0 ws63">是怎样接受 <span class="ff4 wsc1">Unicode </span>编码值的</span></div><div class="t m0 x5 he y18c7 ff2 fs2 fc4 sc0 ls0 wsadf">17.14.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y39c1 ff1 fs3 fc0 sc0 ls0 ws264">在继续本节之前，你应该首先学习你访问的 <span class="ff4 ls29c">C</span>函数库的特征。<span class="_ _c"></span>对于很多 <span class="ff4 ls29c">C</span>函数库，</div><div class="t m0 x5 h9 y39c2 ff1 fs3 fc0 sc0 ls0">通常传递字节而不是字符串会比较好些。要这样做，请使用如下的转换代码：</div><div class="t m0 x5 hf y39c3 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_chars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y29ba ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x19 hf y39c4 ff8 fs5 fc0 sc0 ls0 ws1303">Py_ssize_t len;</div><div class="t m0 x19 hf y29bc ff8 fs5 fc0 sc0 ls0 ws4">/* accepts bytes, bytearray, or other byte-like object */</div><div class="t m0 x19 hf y39c5 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;y#&quot;, &amp;s, &amp;len)) {</div><div class="t m0 x15 hf y39c6 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y29bd ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y29be ff8 fs5 fc0 sc0 ls0 ws4">print_chars(s, len);</div><div class="t m0 x19 hf y29bf ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y39c7 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y39c8 ff1 fs3 fc0 sc0 ls17 ws1578">如果你仍然还是想要传递字符串，你需要知道 <span class="ff4 ls0 wsfe2">Python 3 </span><span class="wsf6">可使用一个合适的字符串</span></div><div class="t m0 x5 h7 y39c9 ff1 fs3 fc0 sc0 ls0 ws1579">表<span class="_ _6"></span>示，<span class="_ _0"></span>它<span class="_ _6"></span>并<span class="_ _0"></span>不<span class="_ _6"></span>直<span class="_ _0"></span>接<span class="_ _6"></span>映<span class="_ _0"></span>射<span class="_ _6"></span>到<span class="_ _0"></span>使<span class="_ _6"></span>用<span class="_ _0"></span>标<span class="_ _6"></span>准<span class="_ _0"></span>类<span class="_ _6"></span>型 <span class="ff6 ws157a">char<span class="_ _34"> </span>* </span><span class="ls29d">或</span><span class="ff6 ws149">wchar t<span class="_ _34"> </span>*<span class="_ _b"> </span></span><span class="ws157b">（更<span class="_ _0"></span>多<span class="_ _6"></span>细<span class="_ _0"></span>节<span class="_ _6"></span>参<span class="_ _0"></span>考 <span class="ff4">PEP</span></span></div><div class="t m0 x5 h7 y39ca ff4 fs3 fc0 sc0 ls0 wsa5">393<span class="ff1 ws157c">）<span class="_ _6"></span>的 </span><span class="ls29e">C</span><span class="ff1 ws157d">函<span class="_ _6"></span>数<span class="_ _6"></span>库。<span class="_ _0"></span>因<span class="_ _6"></span>此，<span class="_ _6"></span>要<span class="_ _6"></span>在 </span><span class="ls29e">C<span class="ff1 ls56 ws1fa">中表示这个字符串数据<span class="_ _1"></span>，一些转换还是必须要的<span class="_ _1"></span>。<span class="_ _c"></span></span></span></div><div class="t m0 x5 h7 y39cb ff1 fs3 fc0 sc0 ls4">在<span class="ff6 ls0 ws1dc">PyArg<span class="_ _7"> </span>ParseTuple() </span><span class="ls0 wsa0">中使用<span class="ff4 ws157e">”s#” </span><span class="lsb">和</span><span class="ff4 ws157f">”u#” </span>格式化码可以安全的执行这样的转换。</span></div><div class="t m0 x0 h9 y38d4 ff1 fs3 fc0 sc0 ls3a ws153">不过这种转换有个缺点就是它可能会导致原始字符串对象的尺寸增大。一旦转换过</div><div class="t m0 x5 h9 y39cc ff1 fs3 fc0 sc0 ls1e ws111">后<span class="_ _1"></span>，会有一个转换数据的复制附加到原始字符串对象上面<span class="_ _1"></span>，之后可以被重用<span class="_ _1"></span>。你可以</div><div class="t m0 x5 h9 y39cd ff1 fs3 fc0 sc0 ls0">观察下这种效果：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.14.<span class="_ _36"> </span>15.14 <span class="ff1 ws16b">传递 </span><span class="ws342">Unico<span class="_ _0"></span>de <span class="ff1 ws16b">字符串给 </span><span class="ls246">C</span><span class="ff1 ws1573">函数库 </span>592</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
