<div id="pf10f" class="pf w0 h0" data-page-no="10f"><div class="pc pc10f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg10f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 ws211">10.13<span class="_ _e"> </span>8.13 <span class="ff1">实现数据模型的类型约束</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">10.13.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y2b2 ff1 fs3 fc0 sc0 ls0">你想定义某些在属性赋值上面有限制的数据结构。</div><div class="t m0 x5 he y2b3 ff2 fs2 fc4 sc0 ls0 wsadf">10.13.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y6ef ff1 fs3 fc0 sc0 ls3a ws153">在这个问题中，你需要在对某些实例属性赋值时进行检查。所以你要自定义属性赋</div><div class="t m0 x5 h9 y6f0 ff1 fs3 fc0 sc0 ls0">值函数，这种情况下最好使用描述器。</div><div class="t m0 x0 h9 y1d3a ff1 fs3 fc0 sc0 ls0">下面的代码使用描述器实现了一个系统类型和赋值验证框架：</div><div class="t m0 x5 h11 y1d3b ffa fs5 fcd sc0 ls0 ws4"># Base class. Uses a descriptor to set a value</div><div class="t m0 x5 hf y1d3c ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Descriptor<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1d3d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name</span><span class="fc6">=<span class="fca">None</span></span><span class="ls33">,</span><span class="fc6">**</span>opts):</span></span></div><div class="t m0 x16 hf y1d3e ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x16 hf y1d3f ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">key, value </span><span class="ws157">in <span class="ff8 fc0 ws13a">opts<span class="fc6 ls34">.</span>items():</span></span></div><div class="t m0 x17 hf y1d40 ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ls34">(</span>self<span class="fc0 ws4">, key, value)</span></div><div class="t m0 x15 hf y1d41 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__set__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, value):</span></span></span></div><div class="t m0 x16 hf y1d42 ff8 fs5 fc0 sc0 ls0 ws13a">instance<span class="fc6">.</span>__dict__[<span class="fca">self<span class="fc6 ls34">.</span></span><span class="ws15f">name] <span class="fc6 ls32">=</span>value</span></div><div class="t m0 x5 h11 y1d43 ffa fs5 fcd sc0 ls0 ws4"># Descriptor for enforcing types</div><div class="t m0 x5 hf y1d44 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Typed<span class="ff8 fc0">(Descriptor):</span></span></div><div class="t m0 x15 hf y1d45 ff8 fs5 fc0 sc0 ls0 ws147">expected_type <span class="fc6 ls33">=</span><span class="fca ws13a">type</span><span class="ls34">(</span><span class="fca ws13a">None</span>)</div><div class="t m0 x15 hf y626 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__set__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, value):</span></span></span></div><div class="t m0 x16 hf y627 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 ws13a">isinstance<span class="fc0 ws155">(value, </span>self<span class="fc6 ls34">.</span><span class="fc0">expected_type):</span></span></div><div class="t m0 x17 hf y628 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws16d">expected <span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span></span></span>str<span class="fc0">(</span>self<span class="fc6 ls34">.</span><span class="fc0">expected_type))</span></span></div><div class="t m0 x16 hf y629 ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span><span class="ws13b">__set__(instance, value)</span></span></div><div class="t m0 x5 h11 y1d46 ffa fs5 fcd sc0 ls0 ws4"># Descriptor for enforcing values</div><div class="t m0 x5 hf y1d47 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Unsigned<span class="ff8 fc0">(Descriptor):</span></span></div><div class="t m0 x15 hf y1d48 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__set__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, value):</span></span></span></div><div class="t m0 x16 hf y1d49 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws15f">value <span class="fc6 ls33">&lt;<span class="fc7 ls34">0</span></span>:</span></div><div class="t m0 x17 hf y1d4a ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">ValueError<span class="fc0 ls34">(<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13b">Expected &gt;= 0<span class="ff9 ls34">&apos;</span><span class="fc0">)</span></span></span></div><div class="t m0 x16 hf y1d4b ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span><span class="ws13b">__set__(instance, value)</span></span></div><div class="t m0 x5 hf y1d4c ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">MaxSized<span class="ff8 fc0">(Descriptor):</span></span></div><div class="t m0 x15 hf y1d4d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name</span><span class="fc6">=<span class="fca">None</span></span><span class="ls33">,</span><span class="fc6">**</span>opts):</span></span></div><div class="t m0 x16 hf y1d4e ff7 fs5 fca sc0 ls0 ws157">if <span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">size</span><span class="ls32">&apos;</span></span>not in <span class="ff8 fc0">opts:</span></div><div class="t m0 x17 hf y1d4f ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">missing size option<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x16 hf y1d50 ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span><span class="ws169">__init__(name, </span><span class="fc6">**</span>opts)</span></div><div class="t m0 x15 hf y1d51 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__set__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, value):</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.13.<span class="_ _5"> </span>8.13 <span class="ff1 wsb03">实现数据模型的类型约束 </span>262</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
