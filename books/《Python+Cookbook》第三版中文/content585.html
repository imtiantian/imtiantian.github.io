<div id="pf249" class="pf w0 h0" data-page-no="249"><div class="pc pc249 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg249.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 wsadf">17.10.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y236 ff1 fs3 fc0 sc0 ls0 ws14a8">使用 <span class="ff4 ws14a9">Cython </span><span class="ls2c ws12f">构建一个扩展模块看上去很手写扩展有些类似，因为你需要创建很多<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y237 ff1 fs3 fc0 sc0 ls17 ws14aa">包装函数。不过<span class="_ _1"></span>，跟前面不同的是，你不需要在 <span class="ff4 ls231">C</span><span class="wsf6">语言中做这些—<span class="_ _19"></span>—代码看上去更像</span></div><div class="t m0 x5 h7 y238 ff1 fs3 fc0 sc0 ls4">是<span class="ff4 ls0 wsa5">Python<span class="ff1">。</span></span></div><div class="t m0 x0 h7 y278 ff1 fs3 fc0 sc0 ls17 ws14ab">作为准备，假设本章介绍部分的示例代码已经<span class="_ _1"></span>被编译到某个叫 <span class="ff6 ls0 ws11e6">libsample </span><span class="ls192">的<span class="ff4 ls273">C</span><span class="ls0">函</span></span></div><div class="t m0 x5 h9 y279 ff1 fs3 fc0 sc0 ls0 ws38">数库中了。首先创建一个名叫 <span class="ff6 ws133">csample.pxd </span>的文件，如下所示：</div><div class="t m0 x5 hf y382e ff8 fs5 fc0 sc0 ls0 ws4"># csample.pxd</div><div class="t m0 x5 hf y382f ff8 fs5 fc0 sc0 ls0">#</div><div class="t m0 x5 hf y3830 ff8 fs5 fc0 sc0 ls0 ws4"># Declarations of &quot;external&quot; C functions and structures</div><div class="t m0 x5 hf y3831 ff8 fs5 fc0 sc0 ls0 ws4">cdef extern from &quot;sample.h&quot;:</div><div class="t m0 x15 hf y3832 ff8 fs5 fc0 sc0 ls0 ws13b">int gcd(int, int)</div><div class="t m0 x15 hf yef7 ff8 fs5 fc0 sc0 ls0 ws4">bint in_mandel(double, double, int)</div><div class="t m0 x15 hf yef8 ff8 fs5 fc0 sc0 ls0 ws4">int divide(int, int, int *)</div><div class="t m0 x15 hf y3833 ff8 fs5 fc0 sc0 ls0 ws4">double avg(double *, int) nogil</div><div class="t m0 x15 hf y3834 ff8 fs5 fc0 sc0 ls0 ws13b">ctypedef struct Point:</div><div class="t m0 x2b hf y3835 ff8 fs5 fc0 sc0 ls0 ws13b">double x</div><div class="t m0 x2b hf y3836 ff8 fs5 fc0 sc0 ls0 ws13b">double y</div><div class="t m0 x15 hf y3837 ff8 fs5 fc0 sc0 ls0 ws4">double distance(Point *, Point *)</div><div class="t m0 x0 h7 y3838 ff1 fs3 fc0 sc0 ls3d ws14ac">这个文件在 <span class="ff4 ls0 ws14ad">Cython <span class="ff1 ws14ae">中的作<span class="_ _6"></span>用就<span class="_ _6"></span>跟 </span><span class="ls24b">C</span></span><span class="ws14af">的头文件一样。初始声明 <span class="ff6 ls0 ws14b0">cdef extern from</span></span></div><div class="t m0 x5 h7 y1263 ff6 fs3 fc0 sc0 ls0 ws147e">&quot;sample.h&quot; <span class="ff1 ws1326">指定了所学的 <span class="ff4 ls285">C</span><span class="wsa0">头文件。接下来的声明都是来自于那个头文件。<span class="_ _c"></span>文件名是</span></span></div><div class="t m0 x5 h9 y3839 ff6 fs3 fc0 sc0 ls0 ws1e2">csample.pxd <span class="ff1 ws14">，而不是 </span><span class="ws17c">sample.pxd <span class="ff1 wsa0">—<span class="_ _8"></span>—这点很重要。</span></span></div><div class="t m0 x0 h9 y35c2 ff1 fs3 fc0 sc0 ls0 ws14b1">下<span class="_ _12"></span>一<span class="_ _0"></span>步，<span class="_ _12"></span>创<span class="_ _12"></span>建<span class="_ _12"></span>一<span class="_ _0"></span>个<span class="_ _12"></span>名<span class="_ _12"></span>为 <span class="ff6 ws14b2">sample.pyx </span><span class="ls1df ws14b3">的问题<span class="_ _8"></span>。该文件会定义包装器<span class="_ _8"></span>，用来桥接<span class="_ _d"></span></span></div><div class="t m0 x5 h7 y383a ff4 fs3 fc0 sc0 ls0 ws5c">Python <span class="ff1 ws14">解释器到 <span class="ff6 ws1e2">csample.pxd </span>中声明的 </span><span class="ls8">C</span><span class="ff1">代码。</span></div><div class="t m0 x5 hf y247b ff8 fs5 fc0 sc0 ls0 ws4"># sample.pyx</div><div class="t m0 x5 hf y383b ff8 fs5 fc0 sc0 ls0 ws4"># Import the low-level C declarations</div><div class="t m0 x5 hf y383c ff8 fs5 fc0 sc0 ls0 ws4">cimport csample</div><div class="t m0 x5 hf y383d ff8 fs5 fc0 sc0 ls0 ws4"># Import some functionality from Python and the C stdlib</div><div class="t m0 x5 hf y383e ff8 fs5 fc0 sc0 ls0 ws4">from cpython.pycapsule cimport *</div><div class="t m0 x5 hf y383f ff8 fs5 fc0 sc0 ls0 ws4">from libc.stdlib cimport malloc, free</div><div class="t m0 x5 hf y3840 ff8 fs5 fc0 sc0 ls0 ws4"># Wrappers</div><div class="t m0 x5 hf y3841 ff8 fs5 fc0 sc0 ls0 ws4">def gcd(unsigned int x, unsigned int y):</div><div class="t m0 x15 hf y3842 ff8 fs5 fc0 sc0 ls0 ws13b">return csample.gcd(x, y)</div><div class="t m0 x5 hf y3843 ff8 fs5 fc0 sc0 ls0 ws4">def in_mandel(x, y, unsigned int n):</div><div class="t m0 x15 hf y3844 ff8 fs5 fc0 sc0 ls0 ws4">return csample.in_mandel(x, y, n)</div><div class="t m0 x5 hf y3845 ff8 fs5 fc0 sc0 ls0 ws4">def divide(x, y):</div><div class="t m0 x15 hf yb1d ff8 fs5 fc0 sc0 ls0 ws13b">cdef int rem</div><div class="t m0 x15 hf y3846 ff8 fs5 fc0 sc0 ls0 ws4">quot = csample.divide(x, y, &amp;rem)</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.10.<span class="_ _36"> </span>15.10 <span class="ff1 ls7f">用</span><span class="ws747">Cython <span class="ff1 ws16b">包装 </span><span class="ls246">C</span><span class="ff1 ws14a7">代码 </span>576</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
