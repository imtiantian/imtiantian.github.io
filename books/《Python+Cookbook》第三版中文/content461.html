<div id="pf1cd" class="pf w0 h0" data-page-no="1cd"><div class="pc pc1cd w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1cd.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h7 y2a ff6 fs3 fc0 sc0 ls0 ws106c">Queue <span class="ff1 ls14 ws1097">对象提供一些在当前上下文很有用的附加特性<span class="_ _1"></span>。比如在创建 <span class="ff4 ls0 ws1098">Queue <span class="ff1 wsa0">对<span class="_ _6"></span>象<span class="_ _6"></span>时</span></span></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls1f ws85d">提供可选的 <span class="ff6 ls0 ws9f6">size </span><span class="ws113">参数来限制可以添加到队列中的元素数量。对于“生产者”与“消费</span></div><div class="t m0 x5 h9 y2c ff1 fs3 fc0 sc0 ls40 ws180">者<span class="_ _1"></span>”速度有差异的情况，为队列中的元素数量添加上限是有意义的<span class="_ _c"></span>。比如，一个“<span class="_ _c"></span>生</div><div class="t m0 x5 h9 y2d ff1 fs3 fc0 sc0 ls40 ws180">产者<span class="_ _1"></span>”产生项目的速度比“消费者<span class="_ _c"></span>”<span class="_ _6"></span>“消费<span class="_ _c"></span>”的速度快，那么使用固定大小的队列就<span class="_ _c"></span></div><div class="t m0 x5 h9 y2e ff1 fs3 fc0 sc0 ls2d ws132">可以在队列已满的时候阻塞队列，以免未预期的连锁效应扩散整个程序造成死锁或者<span class="_ _1"></span></div><div class="t m0 x5 h9 y2f ff1 fs3 fc0 sc0 ls1e ws111">程序运行失常<span class="_ _1"></span>。在通信的线程之间进行“<span class="_ _1"></span>流量控制”是一个看起来容易实现起来<span class="_ _1"></span>困难</div><div class="t m0 x5 h9 y30 ff1 fs3 fc0 sc0 ls13 wse5">的问题<span class="_ _1"></span>。如果你发现自己曾经试图通过摆弄队列大小来解决一个问题，这也许就标志<span class="_ _c"></span></div><div class="t m0 x5 h9 y31 ff1 fs3 fc0 sc0 ls2c ws1099">着你的程序可能存在脆弱设计或者固有的可伸缩问题。 <span class="ff6 ls0 ws819">get() </span><span class="ls17b">和<span class="ff6 ls0 ws109a">put() <span class="ff1 wsa0">方法都<span class="_ _6"></span>支持非</span></span></span></div><div class="t m0 x5 h9 y32 ff1 fs3 fc0 sc0 ls0">阻塞方式和设定超时，例如：</div><div class="t m0 x5 h10 y13c1 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">queue</span></div><div class="t m0 x5 hf y2e55 ff8 fs5 fc0 sc0 ls32">q<span class="fc6 ls33">=</span><span class="ls0 ws13a">queue<span class="fc6">.</span>Queue()</span></div><div class="t m0 x5 hf y2e56 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x15 hf y2e57 ff8 fs5 fc0 sc0 ls0 ws13c">data <span class="fc6 ls32">=</span><span class="ls34">q</span><span class="fc6 ws13a">.<span class="fc0">get(block</span><span class="ls34">=</span><span class="fca">False</span></span>)</div><div class="t m0 x5 hf y2e58 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13a">queue<span class="fc6">.</span>Empty:</span></div><div class="t m0 x15 hf y2e59 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 hf y4da ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x15 hf y1ba7 ff8 fs5 fc0 sc0 ls34">q<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws4">put(item, block</span><span class="fc6">=<span class="fca ls0 ws13a">False<span class="fc0">)</span></span></span></div><div class="t m0 x5 hf y1ba8 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13a">queue<span class="fc6">.</span>Full:</span></div><div class="t m0 x15 hf y2e5a ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 hf y2b9c ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x15 hf y2b9d ff8 fs5 fc0 sc0 ls0 ws13c">data <span class="fc6 ls32">=</span><span class="ls34">q</span><span class="fc6 ws13a">.<span class="fc0">get(timeout</span><span class="ls34">=</span><span class="fc7">5.0</span></span>)</div><div class="t m0 x5 hf y2588 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13a">queue<span class="fc6">.</span>Empty:</span></div><div class="t m0 x15 hf y2b9e ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x0 h9 y2cf9 ff1 fs3 fc0 sc0 ls22 ws119">这些操作都可以用来避免当执行某些特定队列操作时发生无限阻塞的情况，比如<span class="_ _1"></span>，</div><div class="t m0 x5 h9 y2e5b ff1 fs3 fc0 sc0 lsa8 ws109b">一个非阻塞的 <span class="ff6 ls0 wse15">put() </span><span class="ws3de">方法和一个固定大小的队列一起使用，这样当队列已满时就可以<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2e5c ff1 fs3 fc0 sc0 ls0">执行不同的代码。比如输出一条日志信息并丢弃。</div><div class="t m0 x5 hf y2e5d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">producer<span class="fc0">(q):</span></span></div><div class="t m0 x15 hf y2e5e ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x15 hf y2e5f ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x16 hf y2139 ff8 fs5 fc0 sc0 ls34">q<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws4">put(item, block</span><span class="fc6">=<span class="fca ls0 ws13a">False<span class="fc0">)</span></span></span></div><div class="t m0 x15 hf y213a ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13a">queue<span class="fc6">.</span>Full:</span></div><div class="t m0 x16 hf y2e60 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>warning(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">queued item <span class="ffa fcf ws159">%r </span><span class="ws13a">discarded!</span></span><span class="ls34">&apos;</span></span><span class="ws4">, item)</span></div><div class="t m0 x0 h9 y254f ff1 fs3 fc0 sc0 ls14 ws109c">如果你试图让消费者线程在执行像 <span class="ff6 ls0 ws307">q.get() </span><span class="ws174">这样的操作时<span class="_ _1"></span>，超时自动终止以便检</span></div><div class="t m0 x5 h9 y2e61 ff1 fs3 fc0 sc0 ls0 ws38">查终止标志，你应该使用 <span class="ff6 ws23a">q.get() </span>的可选参数 <span class="ff6 ws23a">timeout </span>，如下：</div><div class="t m0 x5 hf y2e62 ff8 fs5 fc0 sc0 ls0 ws16d">_running <span class="fc6 ls32">=</span><span class="fca">True</span></div><div class="t m0 x5 hf y2e63 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(q):</span></span></div><div class="t m0 x15 hf y23ea ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0">_running:</span></div><div class="t m0 x16 hf y2e64 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y2e65 ff8 fs5 fc0 sc0 ls0 ws161">item <span class="fc6 ls33">=</span><span class="ls34">q</span><span class="fc6 ws13a">.<span class="fc0">get(timeout</span><span class="ls34">=</span><span class="fc7">5.0</span></span>)</div><div class="t m0 x17 h11 y2e66 ffa fs5 fcd sc0 ls0 ws13b"># Process item</div><div class="t m0 x17 hf y2e67 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf y2e68 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13a">queue<span class="fc6">.</span>Empty:</span></div><div class="t m0 x17 h10 y2e69 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.3.<span class="_ _36"> </span>12.3 <span class="ff1 ws1090">线程间通信 </span>452</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
