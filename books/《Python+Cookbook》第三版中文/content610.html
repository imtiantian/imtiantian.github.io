<div id="pf262" class="pf w0 h0" data-page-no="262"><div class="pc pc262 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg262.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls56 ws1fa">其次<span class="_ _c"></span>，你需要特别注意文件的归属者以及关闭文件的职责<span class="_ _1"></span>。如果一个文件描述符<span class="_ _1"></span></div><div class="t m0 x5 h7 y2b ff1 fs3 fc0 sc0 ls0 ws84f">被传<span class="_ _6"></span>给 <span class="ff4 wsa5">C</span><span class="ls6b ws807">，但是在 </span><span class="ff4 ws10ff">Python </span><span class="ls6b ws15dd">中还在被使用着，你需要确保 <span class="ff4 ls240">C</span><span class="ws28f">没有意外的关闭它<span class="_ _c"></span>。类似</span></span></div><div class="t m0 x5 h7 y2c ff1 fs3 fc0 sc0 lsa5 ws15de">的<span class="_ _1"></span>，如果一个文件描述符被转换为一个 <span class="ff4 ls0 ws15df">Python <span class="ff1 wsa0">文<span class="_ _6"></span>件<span class="_ _6"></span>对<span class="_ _6"></span>象，<span class="_ _6"></span>你<span class="_ _6"></span>需<span class="_ _0"></span>要清<span class="_ _6"></span>楚<span class="_ _6"></span>谁<span class="_ _0"></span>应该<span class="_ _6"></span>去<span class="_ _6"></span>关<span class="_ _0"></span>闭</span></span></div><div class="t m0 x5 h7 y2d ff1 fs3 fc0 sc0 ls0 ws5cf">它。 <span class="ff6 ws15e0">PyFile<span class="_ _7"> </span>FromFd() </span><span class="ws6a5">的最后一个参数被设置成 <span class="ff4 ls6">1</span><span class="ws144f">，用来指出 <span class="ff4 ws347">Python </span>应该关闭这个文</span></span></div><div class="t m0 x5 h9 y2e ff1 fs3 fc0 sc0 ls0">件。</div><div class="t m0 x0 h7 y9b ff1 fs3 fc0 sc0 ls17 ws15e1">如果你需要从 <span class="ff4 ls231">C</span><span class="ls0 ws746">标准 <span class="ff4 ws1060">I/<span class="_ _6"></span>O </span><span class="ws15e2">库中<span class="_ _6"></span>使用<span class="_ _6"></span>如　 <span class="ff6 wse1f">fdopen() </span></span></span><span class="wsf6">函数来创建不同类<span class="_ _6"></span>型的文件对</span></div><div class="t m0 x5 h7 y9c ff1 fs3 fc0 sc0 ls0 ws1592">象比如 <span class="ff6 ws15e3">FILE<span class="_ _1e"> </span>* </span><span class="ws15e4">对象，<span class="_ _c"></span>你需要特别小心了。这样做会在 <span class="ff4 ws15e5">I/O </span>堆栈中产生两个完全不同的</span></div><div class="t m0 x5 h7 y9d ff4 fs3 fc0 sc0 ls0 ws15e6">I/O <span class="ff1 ws15e7">缓<span class="_ _6"></span>冲<span class="_ _6"></span>层（一<span class="_ _6"></span>个<span class="_ _6"></span>是来<span class="_ _6"></span>自 </span><span class="wse67">Python <span class="ff1 ls125">的</span><span class="ff6 ws8e8">io <span class="ff1 ls22 ws15e8">模块，另一个来自 </span></span><span class="ls26c">C<span class="ff1 ls125">的</span></span><span class="ff6 ws3d0">stdio <span class="ff1 ws15e9">）<span class="_ _f"></span>。像 <span class="ff4 ls26c">C</span><span class="wsa0">中<span class="_ _6"></span>的</span></span></span></span></div><div class="t m0 x5 h7 y9e ff6 fs3 fc0 sc0 ls0 ws86a">fclose() <span class="ff1 ws15ea">会关<span class="_ _6"></span>闭 <span class="ff4 ws1345">Python </span><span class="ls6b ws28f">要使用的文件。如果让你选的话<span class="_ _1"></span>，你应该会选择去构建一个</span></span></div><div class="t m0 x5 h7 y278c ff1 fs3 fc0 sc0 ls0 wsa0">扩展代码来处理底层的整型文件描述符，而不是使用来自<span class="ff12 ws305">&lt;<span class="ff4 wsa5">stdio.h</span><span class="lse0">&gt;</span></span>的高层抽象功能。</div><div class="t m0 x5 hd y292b ff2 fs4 fc4 sc0 ls0 wsd91">17.19<span class="_ _e"> </span>15.19 <span class="ff1 ls7c">从</span><span class="ls23d">C</span><span class="ff1">语言中读取类文件对象</span></div><div class="t m0 x5 he y292c ff2 fs2 fc4 sc0 ls0 wsadf">17.19.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 yc6e ff1 fs3 fc0 sc0 ls0 ws15eb">你<span class="_ _0"></span>要<span class="_ _12"></span>写 <span class="ff4 ls2ac">C</span><span class="ls52 ws15ec">扩展来读取来自任何 </span><span class="ff4 ws15ed">Python </span><span class="ls52 ws276">类文件对象中的数据（<span class="_ _8"></span>比如普通文件<span class="_ _d"></span>、<span class="_ _8"></span></span></div><div class="t m0 x5 h7 y3a86 ff4 fs3 fc0 sc0 ls0 ws15ee">StringIO <span class="ff1 wsa0">对象等）<span class="_ _f"></span>。</span></div><div class="t m0 x5 he y3a87 ff2 fs2 fc4 sc0 ls0 wsadf">17.19.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y3a88 ff1 fs3 fc0 sc0 lse ws15ef">要读取一个类文件对象的数据，你需要重复调用 <span class="ff6 ls0 ws6aa">read() </span><span class="wsd8">方法<span class="_ _1"></span>，然后正确的解码获</span></div><div class="t m0 x5 h9 y3a89 ff1 fs3 fc0 sc0 ls0">得的数据。</div><div class="t m0 x0 h7 y3a8a ff1 fs3 fc0 sc0 ls2d ws1446">下面是一个 <span class="ff4 ls252">C</span><span class="ws132">扩展函数例子<span class="_ _1"></span>，仅仅只是读取一个类文件对象中的所有数据并将其</span></div><div class="t m0 x5 h9 y3a8b ff1 fs3 fc0 sc0 ls0">输出到标准输出：</div><div class="t m0 x5 hf y206d ff8 fs5 fc0 sc0 ls0 ws4">#define CHUNK_SIZE 8192</div><div class="t m0 x5 hf y206f ff8 fs5 fc0 sc0 ls0 ws4">/* Consume a &quot;file-like&quot; object and write bytes to stdout */</div><div class="t m0 x5 hf y2070 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_consume_file(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y2071 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj;</div><div class="t m0 x19 hf y2072 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *read_meth;</div><div class="t m0 x19 hf y3a8c ff8 fs5 fc0 sc0 ls0 ws4">PyObject *result = NULL;</div><div class="t m0 x19 hf y3a8d ff8 fs5 fc0 sc0 ls0 ws4">PyObject *read_args;</div><div class="t m0 x19 hf y1bd1 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args,&quot;O&quot;, &amp;obj)) {</div><div class="t m0 x15 hf y2787 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y2788 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3a8e ff8 fs5 fc0 sc0 ls0 ws4">/* Get the read method of the passed object */</div><div class="t m0 x19 hf y3a8f ff8 fs5 fc0 sc0 ls0 ws4">if ((read_meth = PyObject_GetAttrString(obj, &quot;read&quot;)) == NULL) {</div><div class="t m0 x15 hf y3a90 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y3a91 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3a92 ff8 fs5 fc0 sc0 ls0 ws4">/* Build the argument list to read() */</div><div class="t m0 x19 hf y3a93 ff8 fs5 fc0 sc0 ls0 ws4">read_args = Py_BuildValue(&quot;(i)&quot;, CHUNK_SIZE);</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.19.<span class="_ _36"> </span>15.19 <span class="ff1 ls7f">从</span><span class="ls246">C</span><span class="ff1 ws15dc">语言中读取类文件对象 </span>601</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
