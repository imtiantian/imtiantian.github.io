<div id="pf1b9" class="pf w0 h0" data-page-no="1b9"><div class="pc pc1b9 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1b9.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws4">Usage: server.py server_address port</span>&apos;</span><span class="ls32">,</span></span><span class="ff8 ws13a">file<span class="fc6 ls34">=</span><span class="fc0">sys<span class="fc6 ls34">.</span>stderr)</span></span></div><div class="t m0 x16 hf y1ac ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf y1ae ff8 fs5 fc0 sc0 ls0 ws13a">server(sys<span class="fc6 ls34">.</span>argv[<span class="fc7">1</span><span class="ws159">], </span><span class="fca">int</span>(sys<span class="fc6">.</span>argv[<span class="fc7 ls34">2</span>]))</div><div class="t m0 x0 h9 y21ba ff1 fs3 fc0 sc0 ls0 ws626">运行这个服务器，只需要执行 <span class="ff13 ws1019">python3 servermp.py /tmp/<span class="_ _6"></span>servc<span class="_ _d"></span>onn 15000 <span class="ff1 wsa0">，下面是</span></span></div><div class="t m0 x5 h9 y21bb ff1 fs3 fc0 sc0 ls0">相应的工作者代码：</div><div class="t m0 x5 h11 y25c ffa fs5 fcd sc0 ls0 ws4"># workermp.py</div><div class="t m0 x5 hf y25e ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wsf5c">multiprocessing.connection </span><span class="ws146">import <span class="ff8 fc0">Client</span></span></div><div class="t m0 x5 hf y2caf ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws1008">multiprocessing.reduction </span><span class="ws146">import <span class="ff8 fc0">recv_handle</span></span></div><div class="t m0 x5 h10 y2cb0 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">os</span></div><div class="t m0 x5 hf y2cb1 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 hf y2cb2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">worker<span class="fc0">(server_address):</span></span></div><div class="t m0 x15 hf y2cb3 ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws4">Client(server_address, authkey<span class="fc6 ls34">=</span><span class="ws13a">b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">peekaboo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y2cb4 ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>send(os<span class="fc6">.</span>getpid())</div><div class="t m0 x15 hf y2cb5 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2cb6 ff8 fs5 fc0 sc0 ls0 ws159">fd <span class="fc6 ls32">=</span>recv_handle(serv)</div><div class="t m0 x16 hf y2cb7 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">WORKER: GOT FD</span>&apos;</span><span class="ls0 ws13b">, fd)</span></span></div><div class="t m0 x16 hf y2cb8 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0 ws4">socket(AF_INET, SOCK_STREAM, fileno<span class="fc6 ls34">=</span><span class="ws158">fd) </span></span><span class="ws157">as <span class="ff8 fc0">client:</span></span></div><div class="t m0 x17 hf y2cb9 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 hf y2cba ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ws13a">client<span class="fc6 ls34">.</span>recv(<span class="fc7">1024</span>)</span></div><div class="t m0 x18 hf y2cbb ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">msg:</span></div><div class="t m0 x29 h10 y2c59 ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x18 hf y2cbc ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">WORKER: RECV {!r}</span>&apos;</span><span class="fc6">.</span><span class="ls0">format(msg))</span></span></div><div class="t m0 x18 hf y2cbd ff8 fs5 fc0 sc0 ls0 ws13a">client<span class="fc6 ls34">.</span>send(msg)</div><div class="t m0 x5 hf y2cbe ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 h10 y2cbf ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x15 hf y2cc0 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">len<span class="fc0">(sys<span class="fc6 ls34">.</span><span class="ws15f">argv) <span class="fc6 ws159">!= <span class="fc7 ls34">2</span></span>:</span></span></span></div><div class="t m0 x16 hf y1a3e ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Usage: worker.py server_address</span>&apos;</span><span class="ls33">,</span></span><span class="ff8 ws13a">file<span class="fc6">=<span class="fc0">sys</span><span class="ls34">.</span><span class="fc0">stderr)</span></span></span></div><div class="t m0 x16 hf y1a3f ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf y1a41 ff8 fs5 fc0 sc0 ls0 ws13a">worker(sys<span class="fc6 ls34">.</span>argv[<span class="fc7">1</span>])</div><div class="t m0 x0 h7 y2cc1 ff1 fs3 fc0 sc0 ls0 ws101a">要<span class="_ _6"></span>运<span class="_ _6"></span>行<span class="_ _6"></span>工<span class="_ _6"></span>作<span class="_ _6"></span>者，<span class="_ _0"></span>执行<span class="_ _6"></span>执<span class="_ _0"></span>行命<span class="_ _6"></span>令 <span class="ff13 ws101b">python3<span class="_ _18"> </span>workermp.py<span class="_ _18"> </span>/<span class="_ _6"></span>tmp/<span class="_ _6"></span>servc<span class="_ _c"></span>onn <span class="ff4 ls1f2">.</span><span class="ff1 wsa0">效<span class="_ _6"></span>果<span class="_ _6"></span>跟<span class="_ _0"></span>使用</span></span></div><div class="t m0 x5 h7 y12d ff4 fs3 fc0 sc0 ls0 ws101c">Pip<span class="_ _6"></span>e() <span class="ff1 lsa8 ws101d">例子是完全一样的。文件描述符的传递会涉及到 </span><span class="ws101e">UNIX <span class="ff1 lsa8 ws3de">域套接字的创建和套接</span></span></div><div class="t m0 x5 h9 y2cc2 ff1 fs3 fc0 sc0 ls0 ws9ec">字的 <span class="ff6 ws396">sendmsg() </span><span class="lsa8 ws3de">方法。不过这种技术并不常见，下面是<span class="_ _1"></span>使用套接字来传递描述符的另</span></div><div class="t m0 x5 h9 y10a4 ff1 fs3 fc0 sc0 ls0">外一种实现：</div><div class="t m0 x5 h11 y2cc3 ffa fs5 fcd sc0 ls0 ws4"># server.py</div><div class="t m0 x5 h10 y2cc4 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">socket</span></div><div class="t m0 x5 h10 y2cc5 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">struct</span></div><div class="t m0 x5 hf y2cc6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">send_fd<span class="fc0 ws4">(sock, fd):</span></span></div><div class="t m0 x15 h15 y2cc7 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2cc8 ffa fs5 fc9 sc0 ls0 ws4">Send a single file descriptor.</div><div class="t m0 x15 h15 y1866 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.11.<span class="_ _36"> </span>11.11 <span class="ff1 ws36c">进程间传递 </span><span class="wsffc">So<span class="_ _0"></span>ck<span class="_ _c"></span>et <span class="ff1 wsffd">文件描述符 </span>432</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
