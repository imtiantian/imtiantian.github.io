<div id="pf1e9" class="pf w0 h0" data-page-no="1e9"><div class="pc pc1e9 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1e9.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h11 y334 ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 hf y335 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y336 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">printer<span class="fc0">():</span></span></div><div class="t m0 x16 hf y337 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x17 hf yadd ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ff7 fca">yield</span></div><div class="t m0 x17 hf yade ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Got:<span class="ff9 ws13b">&apos;</span><span class="fc0 ws4">, msg)</span></span></span></span></div><div class="t m0 x15 hf yc64 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">counter<span class="fc0">(sched):</span></span></div><div class="t m0 x16 hf y1555 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x17 h11 y177c ffa fs5 fcd sc0 ls0 ws4"># Receive the current count</div><div class="t m0 x17 hf y177d ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls33">=<span class="ff7 fca ls0">yield</span></span></div><div class="t m0 x17 hf y177e ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ls32">n<span class="fc6 ls0 ws15c">== <span class="fc7 ws13a">0<span class="fc0">:</span></span></span></span></div><div class="t m0 x18 h10 y177f ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x17 h11 y1780 ffa fs5 fcd sc0 ls0 ws4"># Send to the printer task</div><div class="t m0 x17 hf y1781 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span>send(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">printer<span class="ff9 ws13b">&apos;</span></span><span class="ws4">, n)</span></div><div class="t m0 x17 h11 y1782 ffa fs5 fcd sc0 ls0 ws4"># Send the next count to the counter task (recursive)</div><div class="t m0 x17 hf y1784 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span>send(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">counter<span class="ff9 ws13b">&apos;</span></span><span class="ws4">, n<span class="fc6 ls34">-<span class="fc7">1</span></span>)</span></div><div class="t m0 x15 hf y1786 ff8 fs5 fc0 sc0 ls0 ws15f">sched <span class="fc6 ls33">=</span>ActorScheduler()</div><div class="t m0 x15 h11 y1787 ffa fs5 fcd sc0 ls0 ws4"># Create the initial actors</div><div class="t m0 x15 hf y1788 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6">.</span>new_actor(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">printer<span class="ff9 ls34">&apos;</span></span><span class="ws4">, printer())</span></div><div class="t m0 x15 hf y1789 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6">.</span>new_actor(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">counter<span class="ff9 ls34">&apos;</span></span><span class="ws4">, counter(sched))</span></div><div class="t m0 x15 h11 y178b ffa fs5 fcd sc0 ls0 ws4"># Send an initial message to the counter to initiate</div><div class="t m0 x15 hf y178c ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6">.</span>send(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">counter<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">10000</span>)</div><div class="t m0 x15 hf y178d ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6">.</span>run()</div><div class="t m0 x0 h9 ya02 ff1 fs3 fc0 sc0 ls30 ws138">完全弄懂这段代码需要更深入的学习<span class="_ _1"></span>，但是关键点在于收集消息的队列。本质上<span class="_ _c"></span>，</div><div class="t m0 x5 h9 y309b ff1 fs3 fc0 sc0 ls2d ws132">调度器在有需要发送的消息时会一直运行着。计数生成器会给自己发送消息并在一个<span class="_ _1"></span></div><div class="t m0 x5 h9 y309c ff1 fs3 fc0 sc0 ls0">递归循环中结束。</div><div class="t m0 x0 h9 y309d ff1 fs3 fc0 sc0 ls0">下面是一个更加高级的例子，演示了使用生成器来实现一个并发网络应用程序：</div><div class="t m0 x5 hf y309e ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">collections </span><span class="ws146">import <span class="ff8 fc0">deque</span></span></div><div class="t m0 x5 hf y1f7a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">select <span class="fca">import <span class="ff8 fc0">select</span></span></span></div><div class="t m0 x5 h11 y1f7b ffa fs5 fcd sc0 ls0 ws4"># This class represents a generic yield event in the scheduler</div><div class="t m0 x5 hf y309f ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">YieldEvent<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1f7c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_yield<span class="fc0">(<span class="fca">self</span><span class="ws4">, sched, task):</span></span></span></div><div class="t m0 x16 h10 y1f7d ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x15 hf y1f7e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_resume<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, sched, task):</span></span></span></div><div class="t m0 x16 h10 y1f7f ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 h11 y350 ffa fs5 fcd sc0 ls0 ws4"># Task Scheduler</div><div class="t m0 x5 hf y30a0 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Scheduler<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y30a1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y30a2 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws51e">_numtasks </span><span class="ls32">=<span class="fc7 ls210">0</span></span><span class="ffa fcd ws4"># Total num of tasks</span></span></div><div class="t m0 x16 hf y30a3 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_ready </span><span class="ls32">=</span><span class="fc0 ws118b">deque() <span class="ffa fcd ws4"># Tasks ready to run</span></span></span></div><div class="t m0 x16 hf y30a4 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws5a4">_read_waiting </span><span class="ls32">=</span><span class="fc0 wsb1e">{} <span class="ffa fcd ws4"># Tasks waiting to read</span></span></span></div><div class="t m0 x16 hf y30a5 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws169">_write_waiting </span><span class="ls33">=</span><span class="fc0 ws159">{} <span class="ffa fcd ws4"># Tasks waiting to write</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.12.<span class="_ _36"> </span>12.12 <span class="ff1 ws104c">使用生成器代替线程 </span>480</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
