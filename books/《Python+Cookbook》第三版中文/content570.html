<div id="pf23a" class="pf w0 h0" data-page-no="23a"><div class="pc pc23a w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg23a.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff8 fs5 fc0 sc0 ls0 ws4">/* Method table in external module */</div><div class="t m0 x5 hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">static _PointAPIMethods *_point_api = 0;</div><div class="t m0 x5 hf y1ae ff8 fs5 fc0 sc0 ls0 ws4">/* Import the API table from sample */</div><div class="t m0 x5 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">static int import_sample(void) {</div><div class="t m0 x19 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws4">_point_api = (_PointAPIMethods *) PyCapsule_Import(&quot;sample._point_api&quot;,0);</div><div class="t m0 x19 hf y355 ff8 fs5 fc0 sc0 ls0 ws4">return (_point_api != NULL) ? 1 : 0;</div><div class="t m0 x5 hf y410 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf yba ff8 fs5 fc0 sc0 ls0 ws4">/* Macros to implement the programming interface */</div><div class="t m0 x5 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws4">#define PyPoint_AsPoint(obj) (_point_api-&gt;aspoint)(obj)</div><div class="t m0 x5 hf ybed ff8 fs5 fc0 sc0 ls0 ws4">#define PyPoint_FromPoint(obj) (_point_api-&gt;frompoint)(obj)</div><div class="t m0 x5 hf ybee ff8 fs5 fc0 sc0 ls0">#endif</div><div class="t m0 x5 hf ybf0 ff8 fs5 fc0 sc0 ls0 ws4">#ifdef __cplusplus</div><div class="t m0 x5 hf yd7d ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf ybf1 ff8 fs5 fc0 sc0 ls0">#endif</div><div class="t m0 x0 h7 y36ff ff1 fs3 fc0 sc0 ls68 ws1406">这里最重要的部分是函数指针表 <span class="ff6 ls0 ws1407">PointAPIMethods <span class="ff4 ls266">.</span></span><span class="ws23f">它会在导出模块时被初始化，</span></div><div class="t m0 x5 h9 y3700 ff1 fs3 fc0 sc0 ls0">然后导入模块时被查找到。修改原始的扩展模块来填充表格并将它像下面这样导出：</div><div class="t m0 x5 hf y27f7 ff8 fs5 fc0 sc0 ls0 ws4">/* pysample.c */</div><div class="t m0 x5 hf y1c62 ff8 fs5 fc0 sc0 ls0 ws4">#include &quot;Python.h&quot;</div><div class="t m0 x5 hf y3701 ff8 fs5 fc0 sc0 ls0 ws4">#define PYSAMPLE_MODULE</div><div class="t m0 x5 hf y3702 ff8 fs5 fc0 sc0 ls0 ws4">#include &quot;pysample.h&quot;</div><div class="t m0 x5 hf y3703 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y3704 ff8 fs5 fc0 sc0 ls0 ws4">/* Destructor function for points */</div><div class="t m0 x5 hf y3705 ff8 fs5 fc0 sc0 ls0 ws4">static void del_Point(PyObject *obj) {</div><div class="t m0 x19 hf y3706 ff8 fs5 fc0 sc0 ls0 ws4">printf(&quot;Deleting point\n&quot;);</div><div class="t m0 x19 hf y3707 ff8 fs5 fc0 sc0 ls0">free(PyCapsule_GetPointer(obj,&quot;Point&quot;));</div><div class="t m0 x5 hf y3708 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y3709 ff8 fs5 fc0 sc0 ls0 ws4">/* Utility functions */</div><div class="t m0 x5 hf y1c6b ff8 fs5 fc0 sc0 ls0 ws4">static Point *PyPoint_AsPoint(PyObject *obj) {</div><div class="t m0 x19 hf y370a ff8 fs5 fc0 sc0 ls0 ws4">return (Point *) PyCapsule_GetPointer(obj, &quot;Point&quot;);</div><div class="t m0 x5 hf y370b ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y30c3 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *PyPoint_FromPoint(Point *p, int free) {</div><div class="t m0 x19 hf y370c ff8 fs5 fc0 sc0 ls0 ws4">return PyCapsule_New(p, &quot;Point&quot;, free ? del_Point : NULL);</div><div class="t m0 x5 hf y1800 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y370d ff8 fs5 fc0 sc0 ls0 ws4">static _PointAPIMethods _point_api = {</div><div class="t m0 x19 hf y370e ff8 fs5 fc0 sc0 ls0">PyPoint_AsPoint,</div><div class="t m0 x19 hf y370f ff8 fs5 fc0 sc0 ls0">PyPoint_FromPoint</div><div class="t m0 x5 hf y3710 ff8 fs5 fc0 sc0 ls0">};</div><div class="t m0 x5 hf y3711 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y3712 ff8 fs5 fc0 sc0 ls0 ws4">/* Module initialization function */</div><div class="t m0 x5 hf y3713 ff8 fs5 fc0 sc0 ls0">PyMODINIT_FUNC</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.5.<span class="_ _36"> </span>15.5 <span class="ff1 ws36c">从扩张模块中定义和导出 </span><span class="ls246">C<span class="ff1 ls81">的</span></span><span class="ws1405">API 561</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
