<div id="pf1de" class="pf w0 h0" data-page-no="1de"><div class="pc pc1de w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1de.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y334 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">result</span></div><div class="t m0 x5 h11 y336 ffa fs5 fcd sc0 ls0 ws4"># A thread that calls the above function</div><div class="t m0 x5 hf y337 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">some_thread<span class="fc0">():</span></span></div><div class="t m0 x15 hf yadd ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf yade ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf yadf ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=</span><span class="ls0">some_work(args)</span></div><div class="t m0 x15 hf yc64 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x0 h9 yc65 ff1 fs3 fc0 sc0 ls0">修改代码，使用进程池：</div><div class="t m0 x5 h11 y2fae ffa fs5 fcd sc0 ls0 ws4"># Processing pool (see below for initiazation)</div><div class="t m0 x5 hf y2faf ff8 fs5 fc0 sc0 ls0 ws13c">pool <span class="fc6 ls32">=</span><span class="fca">None</span></div><div class="t m0 x5 h11 y2fb0 ffa fs5 fcd sc0 ls0 ws4"># Performs a large calculation (CPU bound)</div><div class="t m0 x5 hf y2fb1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">some_work<span class="fc0">(args):</span></span></div><div class="t m0 x15 hf y2fb2 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x15 hf y1fec ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">result</span></div><div class="t m0 x5 h11 y2ea5 ffa fs5 fcd sc0 ls0 ws4"># A thread that calls the above function</div><div class="t m0 x5 hf y2fb3 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">some_thread<span class="fc0">():</span></span></div><div class="t m0 x15 hf y2ea6 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2ea7 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf y2fb4 ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=</span><span class="ls0 ws13a">pool<span class="fc6">.</span><span class="ws4">apply(some_work, (args))</span></span></div><div class="t m0 x16 hf y2b04 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 h11 y2ea8 ffa fs5 fcd sc0 ls0 ws4"># Initiaze the pool</div><div class="t m0 x5 hf y2b06 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 h10 y1185 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">multiprocessing</span></div><div class="t m0 x15 hf y2fb5 ff8 fs5 fc0 sc0 ls0 ws13c">pool <span class="fc6 ls32">=</span><span class="ws13a">multiprocessing<span class="fc6 ls34">.</span>Pool()</span></div><div class="t m0 x0 h7 y2fb6 ff1 fs3 fc0 sc0 ls2c ws661">这个通过使用一个技巧利用进程池解决了 <span class="ff4 ls0 ws1135">GIL </span><span class="ws1136">的问题。当一个线程想要执行 <span class="ff4 ls0">CPU</span></span></div><div class="t m0 x5 h9 y2fb7 ff1 fs3 fc0 sc0 ls13 wse5">密集型工作时<span class="_ _1"></span>，会将任务发给进程池。然后进程池会在另外一个进程中启动一个单独<span class="_ _c"></span></div><div class="t m0 x5 h7 y2fb8 ff1 fs3 fc0 sc0 lse4">的<span class="ff4 ls0 ws1137">Python </span><span class="ls0 ws1138">解释器来工作。当线程等待结果的时候会释放 <span class="ff4 wsa5">GIL</span><span class="wsa0">。<span class="_ _c"></span>并且，由于计算任务在</span></span></div><div class="t m0 x5 h7 y2fb9 ff1 fs3 fc0 sc0 lse ws1139">单独解释器中执行，那么就不会受限于 <span class="ff4 ls0 ws113a">GIL </span><span class="wsd8">了<span class="_ _1"></span>。在一个多核系统上面，你会发现这个</span></div><div class="t m0 x5 h7 y2fba ff1 fs3 fc0 sc0 ls0 ws14">技术可以让你很好的利用多 <span class="ff4 wsa8">CPU </span>的优势。</div><div class="t m0 x0 h7 y2fbb ff1 fs3 fc0 sc0 ls0 ws113b">另外一<span class="_ _6"></span>个解<span class="_ _6"></span>决 <span class="ff4 ws113c">GIL </span>的策略<span class="_ _6"></span>是使用 <span class="ff4 ls205">C</span><span class="wsa0">扩<span class="_ _6"></span>展编程<span class="_ _6"></span>技术。主<span class="_ _6"></span>要思<span class="_ _6"></span>想是将<span class="_ _6"></span>计算密<span class="_ _6"></span>集型任<span class="_ _6"></span>务</span></div><div class="t m0 x5 h7 y1ffc ff1 fs3 fc0 sc0 ls82 ws8be">转移给 <span class="ff4 ls0 wsa5">C<span class="ff1 ws113d">，跟 </span><span class="wsd77">Python </span></span><span class="ws113e">独立，在工作的时候在 <span class="ff4 lsd7">C</span><span class="ls0 ws8bc">代码中释放 <span class="ff4 wsa5">GIL</span></span><span class="wsba3">。这可以通过在 <span class="ff4 ls206">C</span><span class="ls0">代</span></span></span></div><div class="t m0 x5 h9 y2fbc ff1 fs3 fc0 sc0 ls0">码中插入下面这样的特殊宏来完成：</div><div class="t m0 x5 hf y29bf ff8 fs5 fc0 sc0 ls0 ws4">#include &quot;Python.h&quot;</div><div class="t m0 x5 hf y2fbd ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y2fbe ff8 fs5 fc0 sc0 ls0 ws4">PyObject *pyfunc(PyObject *self, PyObject *args) {</div><div class="t m0 x3c hf y2fbf ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x3c hf y2fc0 ff8 fs5 fc0 sc0 ls0">Py_BEGIN_ALLOW_THREADS</div><div class="t m0 x3c hf y2fc1 ff8 fs5 fc0 sc0 ls0 ws4">// Threaded C code</div><div class="t m0 x3c hf y2fc2 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x3c hf y2fc3 ff8 fs5 fc0 sc0 ls0">Py_END_ALLOW_THREADS</div><div class="t m0 x3c hf y2fc4 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y2fc5 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws1133">14.9.<span class="_ _36"> </span>12.9 Python <span class="ff1 ws1134">的全局锁问题 </span>469</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
