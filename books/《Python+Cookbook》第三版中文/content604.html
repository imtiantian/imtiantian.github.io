<div id="pf25c" class="pf w0 h0" data-page-no="25c"><div class="pc pc25c w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg25c.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h7 y2a ff1 fs3 fc0 sc0 ls17 ws1561">变宽度存储有关，这个在 <span class="ff4 ls0 wsfe2">PEP 393 <span class="ff1 ws34e">中有描<span class="_ _6"></span>述。 <span class="ff6 ws1594">kind </span></span></span><span class="wsf6">变量编码底层存储（<span class="ff4 lsed">8</span><span class="ls0 wsa0">位、<span class="ff4 ws1595">16 </span>位</span></span></div><div class="t m0 x5 h7 y2b ff1 fs3 fc0 sc0 ls13e">或<span class="ff4 ls0 ws143">32 </span><span class="ls35 ws144">位）以及指向缓存的数据指针相关的信息。在实际情况中，你并不需要知道任何</span></div><div class="t m0 x5 h9 y2c ff1 fs3 fc0 sc0 ls0 ws14">跟这些值有关的东西，只需要在提取字符的时候将它们传给 <span class="ff6 ws25d">PyUnicode<span class="_ _7"> </span>READ() </span>宏。</div><div class="t m0 x0 h7 y99 ff1 fs3 fc0 sc0 ls0 ws1596">还<span class="_ _6"></span>有<span class="_ _6"></span>最<span class="_ _6"></span>后<span class="_ _6"></span>几<span class="_ _6"></span>句：<span class="_ _6"></span>当<span class="_ _6"></span>从 <span class="ff4 wse45">Python </span><span class="ws371">传递 <span class="ff4 ws1597">Unico<span class="_ _6"></span>de </span><span class="ws1598">字<span class="_ _6"></span>符<span class="_ _6"></span>串<span class="_ _6"></span>给 <span class="ff4 ls2a0">C</span><span class="wsa0">的<span class="_ _6"></span>时<span class="_ _6"></span>候，<span class="_ _6"></span>你<span class="_ _6"></span>应<span class="_ _6"></span>该<span class="_ _6"></span>尽<span class="_ _6"></span>量<span class="_ _6"></span>简<span class="_ _6"></span>单</span></span></span></div><div class="t m0 x5 h7 y9a ff1 fs3 fc0 sc0 ls0 ws1599">点。<span class="_ _6"></span>如果<span class="_ _6"></span>有 <span class="ff4 ws159a">UTF-8 </span><span class="ws159b">和<span class="_ _6"></span>宽<span class="_ _6"></span>字<span class="_ _6"></span>符两<span class="_ _6"></span>种<span class="_ _6"></span>选<span class="_ _6"></span>择，<span class="_ _6"></span>请选<span class="_ _6"></span>择 <span class="ff4 ws159c">UTF-8. </span><span class="ls158">对</span><span class="ff4 ws159a">UTF-8 </span><span class="wsa0">的<span class="_ _6"></span>支<span class="_ _6"></span>持<span class="_ _6"></span>更加<span class="_ _6"></span>普<span class="_ _6"></span>遍<span class="_ _6"></span>一</span></span></div><div class="t m0 x5 h9 y9b ff1 fs3 fc0 sc0 ls0 ws159d">些，<span class="_ _6"></span>也<span class="_ _0"></span>不<span class="_ _6"></span>容<span class="_ _0"></span>易<span class="_ _6"></span>犯<span class="_ _0"></span>错，<span class="_ _6"></span>解<span class="_ _0"></span>释<span class="_ _6"></span>器<span class="_ _0"></span>也<span class="_ _6"></span>能<span class="_ _0"></span>支<span class="_ _6"></span>持<span class="_ _0"></span>的<span class="_ _6"></span>更<span class="_ _0"></span>好<span class="_ _6"></span>些。<span class="_ _0"></span>最<span class="_ _6"></span>后，<span class="_ _0"></span>确<span class="_ _6"></span>保<span class="_ _0"></span>你<span class="_ _6"></span>仔<span class="_ _0"></span>细<span class="_ _6"></span>阅<span class="_ _0"></span>读<span class="_ _6"></span>了 <span class="fc3 wsa0">关<span class="_ _0"></span>于<span class="_ _6"></span>处<span class="_ _0"></span>理</span></div><div class="t m0 x5 h7 y9c ff4 fs3 fc3 sc0 ls0 ws356">Unico<span class="_ _6"></span>de <span class="ff1">的相关文档</span></div><div class="t m0 x5 hd y1867 ff2 fs4 fc4 sc0 ls0 ws159e">17.15<span class="_ _e"> </span>15.15 C <span class="ff1 ws165">字符串转换为 </span><span class="wsce8">Python <span class="ff1">字符串</span></span></div><div class="t m0 x5 he y1868 ff2 fs2 fc4 sc0 ls0 wsadf">17.15.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y18dd ff1 fs3 fc0 sc0 ls0 ws38">怎样将 <span class="ff4 ls8">C</span><span class="ws14">中的字符串转换为 <span class="ff4 ws5c">Python </span>字节或一个字符串对象？</span></div><div class="t m0 x5 he y39ff ff2 fs2 fc4 sc0 ls0 wsadf">17.15.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y223f ff4 fs3 fc0 sc0 ls2a1">C<span class="ff1 ls126 ws159f">字符串使用一对 </span><span class="ff6 ls0 ws15a0">char<span class="_ _2c"> </span>* <span class="ff1 ls2a2">和</span><span class="ws15a1">int </span></span><span class="ff1 ls126 ws74c">来表示<span class="_ _8"></span>，你需要决定字符串到底是用一个<span class="_ _8"></span></span></div><div class="t m0 x5 h7 y1d5e ff1 fs3 fc0 sc0 ls67 ws15a2">原始字节字符串还是一个 <span class="ff4 ls0 ws15a3">Unico<span class="_ _6"></span>de </span><span class="ws234">字符串来表示<span class="_ _8"></span>。字节对象可以像下面这样使用<span class="_ _d"></span></span></div><div class="t m0 x5 h9 y131d ff6 fs3 fc0 sc0 ls0 ws1dc">Py<span class="_ _7"> </span>BuildValue() <span class="ff1">来构建：</span></div><div class="t m0 x5 hf y3a00 ff8 fs5 fc0 sc0 ls0 ws4">char *s;<span class="_ _1a"> </span>/* Pointer to C string data */</div><div class="t m0 x5 hf y3a01 ff8 fs5 fc0 sc0 ls0 ws4">int<span class="_ _3a"> </span>len;<span class="_ _4a"> </span>/* Length of data */</div><div class="t m0 x5 hf y3a02 ff8 fs5 fc0 sc0 ls0 ws4">/* Make a bytes object */</div><div class="t m0 x5 hf y3a03 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj = Py_BuildValue(&quot;y#&quot;, s, len);</div><div class="t m0 x0 h7 y3a04 ff1 fs3 fc0 sc0 ls2b ws15a4">如果你要创建一个 <span class="ff4 ls0 ws15a5">Unico<span class="_ _6"></span>de <span class="ff1 ws15a6">字符串，<span class="_ _6"></span>并且你知<span class="_ _6"></span>道 <span class="ff6 ls2a3">s</span></span></span><span class="ws12c">指向了 <span class="ff4 ls0 ws155a">UTF-8 <span class="ff1 wsa0">编码的<span class="_ _6"></span>数据，可</span></span></span></div><div class="t m0 x5 h9 y3a05 ff1 fs3 fc0 sc0 ls0">以使用下面的方式：</div><div class="t m0 x5 hf y3a06 ff8 fs5 fc0 sc0 ls0 ws16d">PyObject <span class="fc6 ws13a">*</span><span class="ws158">obj <span class="fc6 ls33">=</span><span class="ws13a">Py_BuildValue(<span class="fc9">&quot;s#&quot;</span><span class="ws13b">, s, </span><span class="fca">len</span>);</span></span></div><div class="t m0 x0 h9 y2dc1 ff1 fs3 fc0 sc0 ls0 ws15a7">如果 <span class="ff6 ls2a4">s</span><span class="ls68 ws15a8">使用其他编码方式，那么可以像下面使用 </span><span class="ff6 ws365">PyUnicode<span class="_ _7"> </span>Decode() </span><span class="ls68 ws23f">来构建一个</span></div><div class="t m0 x5 h9 y3a07 ff1 fs3 fc0 sc0 ls0">字符串：</div><div class="t m0 x5 hf y3a08 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj = PyUnicode_Decode(s, len, &quot;encoding&quot;, &quot;errors&quot;);</div><div class="t m0 x5 hf y2381 ff8 fs5 fc0 sc0 ls0 ws4">/* Examples /*</div><div class="t m0 x5 hf y2382 ff8 fs5 fc0 sc0 ls0 ws4">obj = PyUnicode_Decode(s, len, &quot;latin-1&quot;, &quot;strict&quot;);</div><div class="t m0 x5 hf y2383 ff8 fs5 fc0 sc0 ls0 ws4">obj = PyUnicode_Decode(s, len, &quot;ascii&quot;, &quot;ignore&quot;);</div><div class="t m0 x0 h9 y3a09 ff1 fs3 fc0 sc0 lse ws15a9">如果你恰好有一个用 <span class="ff6 ls0 ws15aa">wchar t<span class="_ _23"> </span>*,<span class="_ _23"> </span>len </span><span class="wsd8">对表示的宽字符串，有几种选择性。首先你<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y3a0a ff1 fs3 fc0 sc0 ls0 ws14">可以使用 <span class="ff6 ws1dc">Py<span class="_ _7"> </span>BuildValue() </span>：</div><div class="t m0 x5 hf y3a0b ff8 fs5 fc0 sc0 ls0 ws4">wchar_t *w;<span class="_ _22"> </span>/* Wide character string */</div><div class="t m0 x5 hf y3a0c ff8 fs5 fc0 sc0 ls0 ws4">int len;<span class="_ _41"> </span>/* Length */</div><div class="t m0 x5 hf y3a0d ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj = Py_BuildValue(&quot;u#&quot;, w, len);</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws1133">17.15.<span class="_ _36"> </span>15.15 C <span class="ff1 ws16b">字符串转换为 </span><span class="wscda">Python <span class="ff1 ws15ab">字符串 </span>595</span></div><a class="l" href="https://docs.python.org/3/c-api/unicode.html"><div class="d m1" style="border-style:none;position:absolute;left:710.779500px;bottom:1013.494500px;width:49.423000px;height:14.016000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="https://docs.python.org/3/c-api/unicode.html"><div class="d m1" style="border-style:none;position:absolute;left:108.000000px;bottom:991.033500px;width:105.289000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
