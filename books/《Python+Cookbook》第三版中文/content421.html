<div id="pf1a5" class="pf w0 h0" data-page-no="1a5"><div class="pc pc1a5 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1a5.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wsgi_app<span class="fc0 ws13b">(environ, start_response):</span></span></div><div class="t m0 x15 h10 y1ac ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x0 h7 y2ad9 ff6 fs3 fc0 sc0 ls0 wsf20">environ <span class="ff1 wsf21">属性是一个字典，<span class="_ _d"></span>包含了从 <span class="ff4 wsf22">w<span class="_ _1"></span>eb <span class="ff1 wsf23">服务器如 </span><span class="wsa5">Apache[<span class="ff1 wsf24">参考 </span><span class="wsf25">In<span class="_ _c"></span>ternet RFC 3875]</span></span></span></span></div><div class="t m0 x5 h7 y2ada ff1 fs3 fc0 sc0 ls0 ws38">提供的 <span class="ff4 wsf26">CGI </span>接口中获取的值。要将这些不同的值提取出来，你可以像这么这样写：</div><div class="t m0 x5 hf y2adb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wsgi_app<span class="fc0 ws13b">(environ, start_response):</span></span></div><div class="t m0 x15 hf y2adc ff8 fs5 fc0 sc0 ls0 ws145">method <span class="fc6 ls32">=</span><span class="ws13a">environ[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">REQUEST_METHOD<span class="ff9 ls34">&apos;</span></span>]</span></div><div class="t m0 x15 hf y2add ff8 fs5 fc0 sc0 ls0 ws13c">path <span class="fc6 ls32">=</span><span class="ws13a">environ[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">PATH_INFO<span class="ff9 ls34">&apos;</span></span>]</span></div><div class="t m0 x15 h11 y2ade ffa fs5 fcd sc0 ls0 ws4"># Parse the query parameters</div><div class="t m0 x15 hf y2adf ff8 fs5 fc0 sc0 ls0 ws145">params <span class="fc6 ls32">=</span><span class="ws13a">cgi<span class="fc6">.</span>FieldStorage(environ[<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">wsgi.input<span class="ff9 ws13b">&apos;</span></span><span class="ws4">], environ</span><span class="fc6">=</span>environ)</span></div><div class="t m0 x0 h9 y2ae0 ff1 fs3 fc0 sc0 ls0 wsc65">我 们 展 示 了 一 些 常 见 的 值。 <span class="ff6 wsf27">environ[&apos;REQUEST METHOD&apos;]<span class="_ _e"> </span></span>代 表 请 求 类 型 如</div><div class="t m0 x5 h7 y2ae1 ff4 fs3 fc0 sc0 ls0 wsa5">GET<span class="ff1 ls1e1">、</span>POST<span class="ff1 ls1e1">、</span><span class="wsf28">HEAD <span class="ff1 wsf29">等。 <span class="ff6 ws5d3">environ[&apos;PATH INFO&apos;]<span class="_ _26"> </span></span><span class="ls1e2 wsf2a">表示被请求资源的路径<span class="_ _8"></span>。调用<span class="_ _19"></span></span></span></span></div><div class="t m0 x5 h9 y2ae2 ff6 fs3 fc0 sc0 ls0 wsf2b">cgi.FieldStorage() <span class="ff1 ls52 ws276">可以从请求中提取查询参数并将它们放入一个类字典对象中<span class="_ _8"></span></span></div><div class="t m0 x5 h9 y2ae3 ff1 fs3 fc0 sc0 ls0">以便后面使用。</div><div class="t m0 x0 h9 y2ae4 ff6 fs3 fc0 sc0 ls0 ws27d">start response <span class="ff1 ls48 ws242">参数是一个为了初始化一个请求对象而必须被调用的函数。第一<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y2ae5 ff1 fs3 fc0 sc0 ls2c wsf2c">个参数是返回的 <span class="ff4 ls0 wsf2d">HTTP </span><span class="wsf2e">状态值，第二个参数是一个 <span class="ff4 ls0 wsa5">(</span><span class="lsb">名<span class="ff4 ls1af">,</span>值<span class="ff4 lsa6">)</span></span><span class="ws12f">元组列表，用来构建返回<span class="_ _1"></span></span></span></div><div class="t m0 x5 h7 y2ae6 ff1 fs3 fc0 sc0 ls4">的<span class="ff4 ls0 ws86">HTTP <span class="ff1">头。例如：</span></span></div><div class="t m0 x5 hf y2ae7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wsgi_app<span class="fc0 ws13b">(environ, start_response):</span></span></div><div class="t m0 x15 h10 y2ae8 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x15 hf y2ae9 ff8 fs5 fc0 sc0 ls0 ws13a">start_response(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">200 OK<span class="ff9 ls34">&apos;</span><span class="fc0">, [(</span><span class="ff9">&apos;</span><span class="ws13a">Content-type<span class="ff9 ls34">&apos;</span></span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">text/plain<span class="ff9 ls34">&apos;</span></span>)])</div><div class="t m0 x0 h7 y180a ff1 fs3 fc0 sc0 ls0 wsf2f">为<span class="_ _6"></span>了返<span class="_ _6"></span>回<span class="_ _6"></span>数<span class="_ _6"></span>据，<span class="_ _6"></span>一<span class="_ _6"></span>个 <span class="ff4 wsf30">WSGI </span><span class="ls40 ws180">程序必须返回一个字节字符串序列。可以像下面这样<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y2aea ff1 fs3 fc0 sc0 ls0">使用一个列表来完成：</div><div class="t m0 x5 hf y2aeb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wsgi_app<span class="fc0 ws13b">(environ, start_response):</span></span></div><div class="t m0 x15 h10 y2212 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x15 hf y2213 ff8 fs5 fc0 sc0 ls0 ws13a">start_response(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">200 OK<span class="ff9 ls34">&apos;</span><span class="fc0">, [(</span><span class="ff9">&apos;</span><span class="ws13a">Content-type<span class="ff9 ls34">&apos;</span></span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">text/plain<span class="ff9 ls34">&apos;</span></span>)])</div><div class="t m0 x15 hf y2214 ff8 fs5 fc0 sc0 ls0 ws13c">resp <span class="fc6 ls32">=</span>[]</div><div class="t m0 x15 hf y2215 ff8 fs5 fc0 sc0 ls0 ws13a">resp<span class="fc6 ls34">.</span>append(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Hello World<span class="ff7 ws156">\n<span class="ff9 ws13b">&apos;</span></span></span>)</div><div class="t m0 x15 hf y2aec ff8 fs5 fc0 sc0 ls0 ws13a">resp<span class="fc6 ls34">.</span>append(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Goodbye!<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;</span></span></span>)</div><div class="t m0 x15 hf y2aed ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">resp</span></div><div class="t m0 x0 h9 y2aee ff1 fs3 fc0 sc0 ls0 ws38">或者，你还可以使用 <span class="ff6 ws17d">yield </span>：</div><div class="t m0 x5 hf y2aef ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wsgi_app<span class="fc0 ws13b">(environ, start_response):</span></span></div><div class="t m0 x15 h10 y2af0 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x15 hf y2af1 ff8 fs5 fc0 sc0 ls0 ws13a">start_response(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">200 OK<span class="ff9 ls34">&apos;</span><span class="fc0">, [(</span><span class="ff9">&apos;</span><span class="ws13a">Content-type<span class="ff9 ls34">&apos;</span></span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">text/plain<span class="ff9 ls34">&apos;</span></span>)])</div><div class="t m0 x15 hf y2af2 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">b<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Hello World<span class="ff7 ws156">\n<span class="ff9">&apos;</span></span></span></span></span></div><div class="t m0 x15 hf y2af3 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">b<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Goodbye!<span class="ff7 ws156">\n<span class="ff9">&apos;</span></span></span></span></span></div><div class="t m0 x0 h9 y1d6d ff1 fs3 fc0 sc0 ls63 ws21f">这里要强调的一点是最后返回的必须是字节字符串<span class="_ _c"></span>。如果返回结果包含文本字符<span class="_ _1"></span></div><div class="t m0 x5 h9 y1426 ff1 fs3 fc0 sc0 ls1e ws111">串<span class="_ _1"></span>，必须先将其编码成字节。当然<span class="_ _c"></span>，并没有要求你返回的一点是文<span class="_ _6"></span>本<span class="_ _1"></span>，你可以很轻松</div><div class="t m0 x5 h9 y2af4 ff1 fs3 fc0 sc0 ls0">的编写一个生成图片的程序。</div><div class="t m0 x0 h7 y2af5 ff1 fs3 fc0 sc0 ls0 wsf31">尽<span class="_ _6"></span>管 <span class="ff4 wsf32">WSGI </span><span class="ls40 ws180">程序通常被定义成一个函数<span class="_ _1"></span>，不过你也可以使用类实例来实现，只要<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y2af6 ff1 fs3 fc0 sc0 ls0 ws911">它实现了合适的 <span class="ff6 ws308">call<span class="_ _e"> </span>() </span>方法。例如：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.5.<span class="_ _5"> </span>11.5 <span class="ff1 ws36c">创建一个简单的 </span><span class="wsf07">REST <span class="ff1 wsf08">接口 </span>412</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
