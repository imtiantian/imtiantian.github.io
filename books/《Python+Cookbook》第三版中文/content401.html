<div id="pf191" class="pf w0 h0" data-page-no="191"><div class="pc pc191 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg191.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 wsd91">12.12<span class="_ _e"> </span>10.12 <span class="ff1">导入模块的同时修改模块</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">12.12.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y658 ff1 fs3 fc0 sc0 ls3a ws153">你想给某个已存在模块中的函数添加装饰器。不过，前提是这个模块已经被导入并</div><div class="t m0 x5 h9 y659 ff1 fs3 fc0 sc0 ls0">且被使用过。</div><div class="t m0 x5 he y18fe ff2 fs2 fc4 sc0 ls0 wsadf">12.12.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y18bb ff1 fs3 fc0 sc0 ls3a ws153">这里问题的本质就是你想在模块被加载时执行某个动作。可能是你想在一个模块被</div><div class="t m0 x5 h9 y18bc ff1 fs3 fc0 sc0 ls0">加载时触发某个回调函数来通知你。</div><div class="t m0 x0 h7 y28f5 ff1 fs3 fc0 sc0 ls51 wse2b">这个问题可以使用 <span class="ff4 ls0 wse2c">10.11 </span><span class="ws1c8">小节中同样的导入钩子机制来实现。下面是一个可能的方</span></div><div class="t m0 x5 h9 y28f6 ff1 fs3 fc0 sc0 ls0">案：</div><div class="t m0 x5 h11 y28f7 ffa fs5 fcd sc0 ls0 ws4"># postimport.py</div><div class="t m0 x5 h10 y28f8 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">importlib</span></div><div class="t m0 x5 h10 y28f9 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x5 hf y28fa ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">collections </span><span class="ws146">import <span class="ff8 fc0">defaultdict</span></span></div><div class="t m0 x5 hf yaac ff8 fs5 fc0 sc0 ls0 ws9bb">_post_import_hooks <span class="fc6 ls32">=</span><span class="ws13a">defaultdict(<span class="fca">list</span>)</span></div><div class="t m0 x5 hf y28fb ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PostImportFinder<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y28fc ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y28fd ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">_skip </span><span class="ls32">=</span></span>set<span class="fc0">()</span></div><div class="t m0 x15 hf y28fe ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_module<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fullname, path<span class="fc6 ls34">=</span></span>None<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y28ff ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">fullname </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_skip:</span></span></span></div><div class="t m0 x17 hf y2900 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">None</span></div><div class="t m0 x16 hf y2901 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_skip</span><span class="ls34">.</span><span class="fc0">add(fullname)</span></span></div><div class="t m0 x16 hf y2902 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">PostImportLoader(<span class="fca">self</span>)</span></div><div class="t m0 x5 hf y2903 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PostImportLoader<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2904 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, finder):</span></span></span></div><div class="t m0 x16 hf y2905 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_finder </span><span class="ls33">=</span><span class="fc0">finder</span></span></div><div class="t m0 x15 hf y2906 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">load_module<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fullname):</span></span></span></div><div class="t m0 x16 hf y2907 ff8 fs5 fc0 sc0 ls0 ws13a">importlib<span class="fc6 ls34">.</span>import_module(fullname)</div><div class="t m0 x16 hf y2908 ff8 fs5 fc0 sc0 ls0 ws145">module <span class="fc6 ls32">=</span><span class="ws13a">sys<span class="fc6">.</span>modules[fullname]</span></div><div class="t m0 x16 hf y2909 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">func </span><span class="ws160">in <span class="ff8 fc0">_post_import_hooks[fullname]:</span></span></div><div class="t m0 x17 hf y22ba ff8 fs5 fc0 sc0 ls0">func(module)</div><div class="t m0 x16 hf y22bb ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_finder</span>.<span class="fc0">_skip</span><span class="ls34">.</span><span class="fc0">remove(fullname)</span></span></div><div class="t m0 x16 hf y22bc ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">module</span></div><div class="t m0 x5 hf y290a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">when_imported<span class="fc0">(fullname):</span></span></div><div class="t m0 x15 hf y290b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decorate<span class="fc0">(func):</span></span></div><div class="t m0 x16 hf y290c ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">fullname </span>in <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>modules:</span></div><div class="t m0 x17 hf y290d ff8 fs5 fc0 sc0 ls0 ws13a">func(sys<span class="fc6">.</span>modules[fullname])</div><div class="t m0 x16 hf y290e ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">12.12.<span class="_ _5"> </span>10.12 <span class="ff1 wse2d">导入模块的同时修改模块 </span>392</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
