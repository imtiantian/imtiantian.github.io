<div id="pf184" class="pf w0 h0" data-page-no="184"><div class="pc pc184 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg184.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff8 fs5 fc0 sc0 ls0 ws13c">code <span class="fc6 ls32">=</span><span class="fca ws13a">compile</span><span class="ws147">(source, url, <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">exec<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf y1ac ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws1f5">__file__ <span class="fc6 ls33">=</span>url</span></div><div class="t m0 x15 hf y1ad ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws208">__package__ <span class="fc6 ls32">=</span><span class="ff9 fc9 ws13b">&apos;&apos;</span></span></div><div class="t m0 x15 hf y1ae ff7 fs5 fca sc0 ls0 ws156">exec<span class="ff8 fc0 ws13b">(code, mod<span class="fc6 ls34">.</span>__dict__)</span></div><div class="t m0 x15 hf y1af ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">mod</span></div><div class="t m0 x0 h9 yd8e ff1 fs3 fc0 sc0 ls49 wsda6">这个函数会下载源代码<span class="_ _1"></span>，并使用 <span class="ff6 ls0 ws374">compile() </span><span class="ws1a6">将其编译到一个代码对象中<span class="_ _1"></span>，然后在<span class="_ _1"></span></span></div><div class="t m0 x5 h9 yd8f ff1 fs3 fc0 sc0 ls0">一个新创建的模块对象的字典中来执行它。下面是使用这个函数的方式：</div><div class="t m0 x5 hf y27eb ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">fib <span class="fc6 ls32">=</span><span class="ws13a">load_module(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">http://localhost:15000/fib.py<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y27ec ff8 fs5 fc8 sc0 ls34">I<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">m fib</span></div><div class="t m0 x5 hf y27ed ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">fib<span class="fc6 ls34">.</span>fib(<span class="fc7">10</span>)</span></div><div class="t m0 x5 hf y27ee ff8 fs5 fc8 sc0 ls0">89</div><div class="t m0 x5 hf y27ef ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13c">spam <span class="fc6 ls32">=</span><span class="ws13a">load_module(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">http://localhost:15000/spam.py<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y27f0 ff8 fs5 fc8 sc0 ls34">I<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">m spam</span></div><div class="t m0 x5 hf y27f1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">spam<span class="fc6 ls34">.</span>hello(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Guido<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y27f2 ff8 fs5 fc8 sc0 ls0 ws4">Hello Guido</div><div class="t m0 x5 hf y27f3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">fib</span></div><div class="t m0 x5 hf y27f4 ff8 fs5 fc8 sc0 ls0 ws155">&lt;module <span class="ff9 ls34">&apos;</span><span class="ws13a">http://localhost:15000/fib.py<span class="ff9 ls32">&apos;</span><span class="ws13c">from <span class="ff9 ws13b">&apos;</span></span>http://localhost:15000/fib.py<span class="ff9 ws13b">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y27f5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">spam</span></div><div class="t m0 x5 hf y27f6 ff8 fs5 fc8 sc0 ls0 ws155">&lt;module <span class="ff9 ls34">&apos;</span><span class="ws13a">http://localhost:15000/spam.py<span class="ff9 ls33">&apos;</span><span class="ws161">from <span class="ff9 ls34">&apos;</span></span>http://localhost:15000/spam.py<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y27f7 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y27f8 ff1 fs3 fc0 sc0 ls0 wsda7">正如你所见，<span class="_ _c"></span>对于简单的模块这个是行得通的。<span class="_ _c"></span>不过它并没有嵌入到通常的 <span class="ff4 wsa5">imp<span class="_ _6"></span>ort</span></div><div class="t m0 x5 h9 y27f9 ff1 fs3 fc0 sc0 ls0">语句中，如果要支持更高级的结构比如包就需要更多的工作了。</div><div class="t m0 x0 h9 y2c0 ff1 fs3 fc0 sc0 ls30 ws138">一个更酷的做法是创建一个自定义导入器。第一种方法是创建一个元路径导入器<span class="_ _c"></span>。</div><div class="t m0 x5 h9 y27fa ff1 fs3 fc0 sc0 ls0">如下：</div><div class="t m0 x5 h11 y27fb ffa fs5 fcd sc0 ls0 ws4"># urlimport.py</div><div class="t m0 x5 h10 y27fc ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x5 h10 y27fd ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">importlib.abc</span></div><div class="t m0 x5 h10 y27fe ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">imp</span></div><div class="t m0 x5 hf y27ff ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws2dd">urllib.request </span><span class="ws146">import <span class="ff8 fc0">urlopen</span></span></div><div class="t m0 x5 hf y2800 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws96c">urllib.error </span><span class="ws146">import <span class="ff8 fc0 ws4">HTTPError, URLError</span></span></div><div class="t m0 x5 hf y2801 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">html.parser </span><span class="ws146">import <span class="ff8 fc0">HTMLParser</span></span></div><div class="t m0 x5 h11 y2802 ffa fs5 fcd sc0 ls0 ws4"># Debugging</div><div class="t m0 x5 h10 y2803 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">logging</span></div><div class="t m0 x5 hf y2804 ff8 fs5 fc0 sc0 ls0 ws158">log <span class="fc6 ls32">=</span><span class="ws13a">logging<span class="fc6 ls34">.</span>getLogger(__name__)</span></div><div class="t m0 x5 h11 y2805 ffa fs5 fcd sc0 ls0 ws4"># Get links from a given URL</div><div class="t m0 x5 hf y2806 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_get_links<span class="fc0">(url):</span></span></div><div class="t m0 x15 hf y2807 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">LinkParser<span class="ff8 fc0">(HTMLParser):</span></span></div><div class="t m0 x16 hf y2808 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_starttag<span class="fc0">(<span class="fca">self</span><span class="ws4">, tag, attrs):</span></span></span></div><div class="t m0 x17 hf y2809 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws158">tag <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">a<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x18 hf y280a ff8 fs5 fc0 sc0 ls0 ws15f">attrs <span class="fc6 ls32">=</span><span class="fca ws13a">dict</span>(attrs)</div><div class="t m0 x18 hf y280b ff8 fs5 fc0 sc0 ls0 ws13a">links<span class="fc6 ls34">.</span>add(attrs<span class="fc6">.</span>get(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">href<span class="ff9 ls34">&apos;</span></span>)<span class="fc6 ls34">.</span>rstrip(<span class="ff9 fc9 ls34">&apos;<span class="ff8">/</span><span class="ls0 ws13b">&apos;</span></span>))</div><div class="t m0 x15 hf y280c ff8 fs5 fc0 sc0 ls0 ws15f">links <span class="fc6 ls33">=</span><span class="fca ws13a">set</span>()</div><div class="t m0 x15 hf y280d ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x16 hf y280e ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">Getting links from </span><span class="ffa fcf">%s<span class="ff9 fc9 ls33">&apos;</span></span><span class="fc6 ls32">%</span>url)</div><div class="t m0 x16 hf y280f ff8 fs5 fc0 sc0 ls32">u<span class="fc6 ls33">=</span><span class="ls0">urlopen(url)</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">12.11.<span class="_ _5"> </span>10.11 <span class="ff1 wsd98">通过钩子远程加载模块 </span>379</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
