<div id="pf185" class="pf w0 h0" data-page-no="185"><div class="pc pc185 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg185.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fc0 sc0 ls0 ws145">parser <span class="fc6 ls32">=</span>LinkParser()</div><div class="t m0 x16 hf y1ac ff8 fs5 fc0 sc0 ls0 ws13a">parser<span class="fc6 ls34">.</span>feed(u<span class="fc6 ls34">.</span>read()<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ws13b">&apos;</span></span>))</div><div class="t m0 x15 hf y1ad ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws16e">Exception </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x16 hf y1ae ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Could not get links. </span><span class="ffa fcf">%s<span class="ff9 fc9 ws13b">&apos;</span></span><span class="ws4">, e)</span></div><div class="t m0 x15 hf y1af ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws145">links: </span><span class="ffa fcf">%r<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws4">, links)</span></div><div class="t m0 x15 hf y1b0 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">links</span></div><div class="t m0 x5 hf y410 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">UrlMetaFinder<span class="ff8 fc0 ws13a">(importlib<span class="fc6 ls34">.</span>abc<span class="fc6 ls34">.</span>MetaPathFinder):</span></span></div><div class="t m0 x15 hf y411 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, baseurl):</span></span></span></div><div class="t m0 x16 hf yba ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">_baseurl </span><span class="ls32">=</span><span class="fc0">baseurl</span></span></div><div class="t m0 x16 hf y8c6 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_links </span><span class="ls32">=</span><span class="fc0 ws13b">{ }</span></span></div><div class="t m0 x16 hf ybed ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">_loaders </span><span class="ls32">=</span><span class="fc0 ws4">{ baseurl : UrlModuleLoader(baseurl) }</span></span></div><div class="t m0 x15 hf ybef ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_module<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fullname, path<span class="fc6 ls34">=</span></span>None<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf ybf0 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: fullname=</span><span class="ffa fcf">%r</span><span class="fc9 ws4">, path=</span><span class="ffa fcf">%r<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws13b">, fullname, path)</span></div><div class="t m0 x16 hf yd7d ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">path </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf ybf1 ff8 fs5 fc0 sc0 ls0 ws155">baseurl <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span>_baseurl</div><div class="t m0 x16 hf ybf2 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf ybf3 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0 ws13a">path[<span class="fc7 ls34">0<span class="fc0">]<span class="fc6">.</span></span></span>startswith(<span class="fca">self<span class="fc6">.</span></span>_baseurl):</span></div><div class="t m0 x18 hf ybf4 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">None</span></div><div class="t m0 x17 hf ybf5 ff8 fs5 fc0 sc0 ls0 ws155">baseurl <span class="fc6 ls32">=</span><span class="ws13a">path[<span class="fc7">0</span>]</span></div><div class="t m0 x16 hf ybf6 ff8 fs5 fc0 sc0 ls0 ws15f">parts <span class="fc6 ls33">=</span><span class="ws13a">fullname<span class="fc6 ls34">.</span>split(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">.<span class="ff9">&apos;</span></span></span>)</span></div><div class="t m0 x16 hf ybf7 ff8 fs5 fc0 sc0 ls0 ws1f5">basename <span class="fc6 ls33">=</span><span class="ws13a">parts[<span class="fc6 ls34">-<span class="fc7">1</span></span>]</span></div><div class="t m0 x16 hf ybf8 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: baseurl=</span><span class="ffa fcf">%r</span><span class="fc9 ws13b">, basename=</span><span class="ffa fcf">%r<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws13b">, baseurl, basename)</span></div><div class="t m0 x16 h11 ybfa ffa fs5 fcd sc0 ls0 ws4"># Check link cache</div><div class="t m0 x16 hf ybfb ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">basename </span><span class="ws38d">not in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_links:</span></span></span></span></div><div class="t m0 x17 hf y1ed6 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws151">_links[baseurl] </span><span class="ls32">=</span><span class="fc0">_get_links(baseurl)</span></span></div><div class="t m0 x16 h11 y1ed8 ffa fs5 fcd sc0 ls0 ws4"># Check if it<span class="ffb ls34">&apos;</span>s a package</div><div class="t m0 x16 hf y1f83 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">basename </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_links[baseurl]:</span></span></span></div><div class="t m0 x17 hf y1ed9 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: trying package </span><span class="ffa fcf">%r<span class="ff9 fc9 ws13b">&apos;</span></span><span class="ws4">, fullname)</span></div><div class="t m0 x17 hf y1eda ff8 fs5 fc0 sc0 ls0 ws155">fullurl <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span><span class="ws1f5">_baseurl <span class="fc6 ls33">+</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">/</span><span class="ls33">&apos;</span></span><span class="fc6 ls32">+</span>basename</span></div><div class="t m0 x17 h11 y1edb ffa fs5 fcd sc0 ls0 ws4"># Attempt to load the package (which accesses __init__.py)</div><div class="t m0 x17 hf y1f84 ff8 fs5 fc0 sc0 ls0 ws145">loader <span class="fc6 ls32">=</span>UrlPackageLoader(fullurl)</div><div class="t m0 x17 hf y2515 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x18 hf y1edc ff8 fs5 fc0 sc0 ls0 ws13a">loader<span class="fc6 ls34">.</span>load_module(fullname)</div><div class="t m0 x18 hf y1edd ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws151">_links[fullurl] </span><span class="ls32">=</span><span class="fc0">_get_links(fullurl)</span></span></div><div class="t m0 x18 hf y1ede ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws23c">_loaders[fullurl] </span><span class="ls33">=</span><span class="fc0">UrlModuleLoader(fullurl)</span></span></div><div class="t m0 x18 hf y1edf ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: package <span class="ffa fcf ws159">%r </span><span class="ws13a">loaded<span class="ff9 ls34">&apos;</span></span></span><span class="ws4">, fullname)</span></div><div class="t m0 x17 hf y1ee0 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws208">ImportError </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x18 hf y2516 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: package failed. </span><span class="ffa fcf">%s<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws13b">, e)</span></div><div class="t m0 x18 hf y1ee1 ff8 fs5 fc0 sc0 ls0 ws145">loader <span class="fc6 ls32">=</span><span class="fca">None</span></div><div class="t m0 x17 hf y1ee2 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">loader</span></div><div class="t m0 x16 h11 y1ee3 ffa fs5 fcd sc0 ls0 ws4"># A normal module</div><div class="t m0 x16 hf y1f85 ff8 fs5 fc0 sc0 ls0 ws1f5">filename <span class="fc6 ls33">=</span>basename <span class="fc6 ls33">+<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">.py<span class="ff9">&apos;</span></span></div><div class="t m0 x16 hf y1ee4 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">filename </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_links[baseurl]:</span></span></span></div><div class="t m0 x17 hf y1ee5 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: module <span class="ffa fcf ws159">%r </span><span class="ws13a">found<span class="ff9 ls34">&apos;</span></span><span class="fc0">, fullname)</span></span></div><div class="t m0 x17 hf y1ee6 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_loaders[baseurl]</span></span></span></div><div class="t m0 x16 hf y1f86 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y1543 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">find_module: module <span class="ffa fcf ws159">%r </span><span class="ws4">not found<span class="ff9 ls34">&apos;</span></span><span class="fc0">, fullname)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">12.11.<span class="_ _5"> </span>10.11 <span class="ff1 wsd98">通过钩子远程加载模块 </span>380</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
