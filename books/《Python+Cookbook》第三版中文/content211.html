<div id="pfd3" class="pf w0 h0" data-page-no="d3"><div class="pc pcd3 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgd3.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=<span class="fca ls0 ws13a">open<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">polys.bin<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ls34">&apos;</span></span>)</span></span></span></span></div><div class="t m0 x5 hf y1ac ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">phead <span class="fc6 ls33">=</span><span class="ws13a">PolyHeader<span class="fc6 ls34">.</span>from_file(f)</span></span></div><div class="t m0 x5 hf y1ad ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span><span class="ws51e">file_code <span class="fc6 ws159">== <span class="fc7">0x1234</span></span></span></span></div><div class="t m0 x5 hf y1ae ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y1af ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span><span class="ws158">min <span class="ffa fcd ws4"># Nested structure</span></span></span></div><div class="t m0 x5 hf y1b0 ff8 fs5 fc8 sc0 ls0 ws4">&lt;__main__.Point object at 0x1006a48d0&gt;</div><div class="t m0 x5 hf y355 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>min<span class="fc6 ls34">.</span>x</span></div><div class="t m0 x5 hf y410 ff8 fs5 fc8 sc0 ls0">0.5</div><div class="t m0 x5 hf y411 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>min<span class="fc6 ls34">.</span>y</span></div><div class="t m0 x5 hf yba ff8 fs5 fc8 sc0 ls0">0.5</div><div class="t m0 x5 hf y8c6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>max<span class="fc6 ls34">.</span>x</span></div><div class="t m0 x5 hf ybed ff8 fs5 fc8 sc0 ls0">7.0</div><div class="t m0 x5 hf ybee ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>max<span class="fc6 ls34">.</span>y</span></div><div class="t m0 x5 hf ybef ff8 fs5 fc8 sc0 ls0">9.2</div><div class="t m0 x5 hf ybf0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>num_polys</span></div><div class="t m0 x5 hf yd7d ff8 fs5 fc8 sc0 ls0">3</div><div class="t m0 x5 hf ybf1 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1700 ff1 fs3 fc0 sc0 ls56 ws1fa">到目前为止<span class="_ _c"></span>，一个处理定长记录的框架已经写好了<span class="_ _1"></span>。但是如果组件记录是变长的<span class="_ _1"></span></div><div class="t m0 x5 h9 y1701 ff1 fs3 fc0 sc0 ls0">呢？比如，多边形文件包含变长的部分。</div><div class="t m0 x0 h9 y1702 ff1 fs3 fc0 sc0 ls3a ws153">一种方案是写一个类来表示字节数据，同时写一个工具函数来通过多少方式解析内</div><div class="t m0 x5 h7 y1703 ff1 fs3 fc0 sc0 ls0 ws38">容。跟 <span class="ff4 wsca">6.11 </span>小节的代码很类似：</div><div class="t m0 x5 hf y1704 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">SizedRecord<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1705 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, bytedata):</span></span></span></div><div class="t m0 x16 hf y1706 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_buffer </span><span class="ls33">=</span><span class="fc0">memoryview(bytedata)</span></span></div><div class="t m0 x15 h10 y1707 ff7 fs5 fc12 sc0 ls0">@classmethod</div><div class="t m0 x15 hf y1708 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">from_file<span class="fc0 ws4">(cls, f, size_fmt, includes_size</span><span class="fc6">=<span class="fca">True<span class="fc0">):</span></span></span></span></div><div class="t m0 x16 hf y1709 ff8 fs5 fc0 sc0 ls0 ws16e">sz_nbytes <span class="fc6 ls33">=</span><span class="ws13a">struct<span class="fc6 ls34">.</span>calcsize(size_fmt)</span></div><div class="t m0 x16 hf y170a ff8 fs5 fc0 sc0 ls0 ws1f5">sz_bytes <span class="fc6 ls33">=</span><span class="ls34">f</span><span class="fc6 ws13a">.</span>read(sz_nbytes)</div><div class="t m0 x16 hf y170b ff8 fs5 fc0 sc0 ls0 ws158">sz, <span class="fc6 ls32">=</span><span class="ws13a">struct<span class="fc6">.</span><span class="ws4">unpack(size_fmt, sz_bytes)</span></span></div><div class="t m0 x16 hf y170c ff8 fs5 fc0 sc0 ls0 ws158">buf <span class="fc6 ls32">=</span><span class="ls34">f<span class="fc6">.</span></span><span class="ws1f4">read(sz <span class="fc6 ls33">-</span><span class="ws147">includes_size <span class="fc6 ls33">*</span>sz_nbytes)</span></span></div><div class="t m0 x16 hf y170d ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">cls(buf)</span></div><div class="t m0 x15 hf y170e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">iter_as<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, code):</span></span></span></div><div class="t m0 x16 hf y170f ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">isinstance<span class="fc0 ws145">(code, </span>str<span class="fc0">):</span></span></div><div class="t m0 x17 hf y1710 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">struct<span class="fc6 ls34">.</span>Struct(code)</span></div><div class="t m0 x17 hf y1711 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws158">off </span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0 ls34">(<span class="fc7">0</span><span class="ls32">,</span></span>len<span class="fc0 ls34">(</span>self<span class="fc6 ls34">.</span><span class="fc0 ws13b">_buffer), s<span class="fc6 ls34">.</span>size):</span></span></span></div><div class="t m0 x18 hf y1712 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">unpack_from(<span class="fca">self</span></span><span class="ls34">.</span><span class="fc0 ws13b">_buffer, off)</span></span></span></div><div class="t m0 x16 hf y1713 ff7 fs5 fca sc0 ls0 ws218">elif <span class="ff8 ws13a">isinstance<span class="fc0 ws13b">(code, StructureMeta):</span></span></div><div class="t m0 x17 hf y1714 ff8 fs5 fc0 sc0 ls0 ws161">size <span class="fc6 ls33">=</span><span class="ws13a">code<span class="fc6">.</span>struct_size</span></div><div class="t m0 x17 hf y1715 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws158">off </span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0 ls34">(<span class="fc7">0</span><span class="ls32">,</span></span>len<span class="fc0 ls34">(</span>self<span class="fc6 ls34">.</span><span class="fc0 ws13b">_buffer), size):</span></span></span></div><div class="t m0 x18 hf y1716 ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.<span class="fc0">_buffer[off:off</span><span class="ls34">+</span></span></span>size]</div><div class="t m0 x18 hf y1717 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0">code(data)</span></div><div class="t m0 x0 h9 y1718 ff1 fs3 fc0 sc0 ls36 ws8de">类方法 <span class="ff6 ls0 ws8df">SizedRecord.from file() <span class="ff1 wsa0">是<span class="_ _0"></span>一个<span class="_ _0"></span>工具，<span class="_ _0"></span>用来<span class="_ _0"></span>从一<span class="_ _0"></span>个文<span class="_ _0"></span>件中<span class="_ _0"></span>读取<span class="_ _0"></span>带大<span class="_ _6"></span>小<span class="_ _0"></span>前</span></span></div><div class="t m0 x5 h9 y1719 ff1 fs3 fc0 sc0 ls1e ws111">缀的数据块<span class="_ _1"></span>，这也是很多文件格式常用的方式<span class="_ _1"></span>。作为输入，它接受一个包含大小<span class="_ _1"></span>编码</div><div class="t m0 x5 h9 y171a ff1 fs3 fc0 sc0 ls30 ws8e0">的结构格式编码，并且也是自<span class="_ _1"></span>己形式。可选的 <span class="ff6 ls0 ws8e1">includes size </span><span class="ws138">参数指定了字节数是否<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y171b ff1 fs3 fc0 sc0 ls0">包含头部大小。下面是一个例子教你怎样使用从多边形文件中读取单独的多边形数据：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">8.12.<span class="_ _5"> </span>6.12 <span class="ff1 ws6e7">读取嵌套和可变长二进制数据 </span>202</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
