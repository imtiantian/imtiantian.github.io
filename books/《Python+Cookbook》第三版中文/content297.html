<div id="pf129" class="pf w0 h0" data-page-no="129"><div class="pc pc129 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg129.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 ws211">10.22<span class="_ _e"> </span>8.22 <span class="ff1">不用递归实现访问者模式</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">10.22.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y658 ff1 fs3 fc0 sc0 ls3a ws153">你使用访问者模式遍历一个很深的嵌套树形数据结构，并且因为超过嵌套层级限制</div><div class="t m0 x5 h9 y659 ff1 fs3 fc0 sc0 ls0">而失败。你想消除递归，并同时保持访问者编程模式。</div><div class="t m0 x5 he y18fe ff2 fs2 fc4 sc0 ls0 wsadf">10.22.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y6f0 ff1 fs3 fc0 sc0 ls2d wsb60">通过巧妙的使用生成器可以在树遍历或搜索算法中消除递归。在 <span class="ff4 ls0 wsb47">8.21 <span class="ff1 wsa0">小节<span class="_ _6"></span>中，我</span></span></div><div class="t m0 x5 h9 y6f1 ff1 fs3 fc0 sc0 ls0">们给出了一个访问者类。下面我们利用一个栈和生成器重新实现这个类：</div><div class="t m0 x5 h10 y12f6 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">types</span></div><div class="t m0 x5 hf y1f70 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Node<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h10 y1f71 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 hf y3de ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">NodeVisitor<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y3df ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, node):</span></span></span></div><div class="t m0 x16 hf y3e0 ff8 fs5 fc0 sc0 ls0 ws15f">stack <span class="fc6 ls33">=</span>[node]</div><div class="t m0 x16 hf y3e1 ff8 fs5 fc0 sc0 ls0 ws208">last_result <span class="fc6 ls32">=</span><span class="fca">None</span></div><div class="t m0 x16 hf y1f72 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0">stack:</span></div><div class="t m0 x17 hf y1f73 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x18 hf y1f74 ff8 fs5 fc0 sc0 ls0 ws161">last <span class="fc6 ls33">=</span><span class="ws13a">stack[<span class="fc6 ls34">-<span class="fc7">1</span></span>]</span></div><div class="t m0 x18 hf y1f75 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">isinstance<span class="fc0 ws4">(last, types<span class="fc6 ls34">.</span>GeneratorType):</span></span></div><div class="t m0 x29 hf y1f76 ff8 fs5 fc0 sc0 ls0 ws13a">stack<span class="fc6 ls34">.</span>append(last<span class="fc6 ls34">.</span>send(last_result))</div><div class="t m0 x29 hf y1f77 ff8 fs5 fc0 sc0 ls0 ws6c3">last_result <span class="fc6 ls33">=</span><span class="fca">None</span></div><div class="t m0 x18 hf y2e0 ff7 fs5 fca sc0 ls0 ws218">elif <span class="ff8 ws13a">isinstance<span class="fc0 ws13b">(last, Node):</span></span></div><div class="t m0 x29 hf y2e1 ff8 fs5 fc0 sc0 ls0 ws13a">stack<span class="fc6 ls34">.</span>append(<span class="fca">self<span class="fc6 ls34">.</span></span>_visit(stack<span class="fc6 ls34">.</span>pop()))</div><div class="t m0 x18 hf y2e2 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x29 hf y1f78 ff8 fs5 fc0 sc0 ls0 ws6c3">last_result <span class="fc6 ls33">=</span><span class="ws13a">stack<span class="fc6 ls34">.</span>pop()</span></div><div class="t m0 x17 hf y1f79 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws13a">StopIteration<span class="fc0">:</span></span></div><div class="t m0 x18 hf y1f7a ff8 fs5 fc0 sc0 ls0 ws13a">stack<span class="fc6 ls34">.</span>pop()</div><div class="t m0 x16 hf y1f7b ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">last_result</span></div><div class="t m0 x15 hf y1f7c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_visit<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1f7d ff8 fs5 fc0 sc0 ls0 ws1f5">methname <span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">visit_<span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span><span class="fca">type<span class="fc0">(node)<span class="fc6 ls34">.</span>__name__</span></span></span></div><div class="t m0 x16 hf y1f7e ff8 fs5 fc0 sc0 ls0 ws161">meth <span class="fc6 ls33">=</span><span class="fca ws13a">getattr</span><span class="ls34">(</span><span class="fca ws13a">self</span><span class="ws13b">, methname, <span class="fca ws13a">None</span>)</span></div><div class="t m0 x16 hf y1f7f ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">meth </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1f80 ff8 fs5 fc0 sc0 ls0 ws161">meth <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.</span></span>generic_visit</div><div class="t m0 x16 hf y1f81 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">meth(node)</span></div><div class="t m0 x15 hf y352 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">generic_visit<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y353 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">No {} method</span><span class="ls34">&apos;<span class="ff8 fc6">.</span></span></span><span class="fc0">format(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">visit_<span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span></span></span>type<span class="fc0">(node)<span class="fc6 ls34">.</span>__name__))</span></span></div><div class="t m0 x0 h9 y15c6 ff1 fs3 fc0 sc0 ls3a ws153">如果你使用这个类，也能达到相同的效果。事实上你完全可以将它作为上一节中的</div><div class="t m0 x5 h9 y1f82 ff1 fs3 fc0 sc0 ls0">访问者模式的替代实现。考虑如下代码，遍历一个表达式的树：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.22.<span class="_ _5"> </span>8.22 <span class="ff1 wsb03">不用递归实现访问者模式 </span>288</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
