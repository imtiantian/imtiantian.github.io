<div id="pf256" class="pf w0 h0" data-page-no="256"><div class="pc pc256 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg256.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff8 fs5 fc0 sc0 ls0">{</div><div class="t m0 x3c hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x3c hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">s = PyBytes_AsString(o);</div><div class="t m0 x3c hf y1ae ff8 fs5 fc0 sc0 ls0 ws4">if (!s) {</div><div class="t m0 x50 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">return NULL;<span class="_ _3a"> </span>/* TypeError already raised */</div><div class="t m0 x3c hf y1b0 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x3c hf y355 ff8 fs5 fc0 sc0 ls0">print_chars(s);</div><div class="t m0 x5 hf y410 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf yba ff8 fs5 fc0 sc0 ls0 ws4">/* Conversion to UTF-8 bytes from a string */</div><div class="t m0 x5 hf y8c6 ff8 fs5 fc0 sc0 ls0">{</div><div class="t m0 x3c hf ybed ff8 fs5 fc0 sc0 ls0 ws4">PyObject *bytes;</div><div class="t m0 x3c hf ybee ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x3c hf ybef ff8 fs5 fc0 sc0 ls0 ws4">if (!PyUnicode_Check(obj)) {</div><div class="t m0 x2c hf ybf0 ff8 fs5 fc0 sc0 ls0 ws4">PyErr_SetString(PyExc_TypeError, &quot;Expected string&quot;);</div><div class="t m0 x2c hf yd7d ff8 fs5 fc0 sc0 ls0 ws4">return NULL;</div><div class="t m0 x3c hf ybf1 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x3c hf ybf2 ff8 fs5 fc0 sc0 ls0 ws4">bytes = PyUnicode_AsUTF8String(obj);</div><div class="t m0 x3c hf ybf3 ff8 fs5 fc0 sc0 ls0 ws4">s = PyBytes_AsString(bytes);</div><div class="t m0 x3c hf ybf4 ff8 fs5 fc0 sc0 ls0">print_chars(s);</div><div class="t m0 x3c hf ybf5 ff8 fs5 fc0 sc0 ls0">Py_DECREF(bytes);</div><div class="t m0 x5 hf ybf6 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y397d ff1 fs3 fc0 sc0 ls1e ws1555">前面两种转换都可以确保是 <span class="ff4 ls0 ws1556">NULL </span><span class="ws111">结尾的数据<span class="_ _1"></span>，但是它们并不检查字符串中间是<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y397e ff1 fs3 fc0 sc0 ls0 ws14">否嵌入了 <span class="ff4 wsbe">NULL </span>字节。因此，如果这个很重要的话，那你需要自己去做检查了。</div><div class="t m0 x5 he y367 ff2 fs2 fc4 sc0 ls0 wsadf">17.13.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y1cbf ff1 fs3 fc0 sc0 ls0 wsb02">如果可能的话，你应该避免去写一些依赖于 <span class="ff4 ws1557">NULL </span>结尾的字符串，因为 <span class="ff4 ws108">Python </span>并</div><div class="t m0 x5 h9 y397f ff1 fs3 fc0 sc0 ls1e ws111">没有这个需要<span class="_ _1"></span>。最好结合使用一个指针和长度值来处理字符串<span class="_ _1"></span>。不过，有时候你<span class="_ _1"></span>必须</div><div class="t m0 x5 h7 y269 ff1 fs3 fc0 sc0 ls0 ws38">去处理 <span class="ff4 ls8">C</span>语言遗留代码时就没得选择了。</div><div class="t m0 x0 h9 y3980 ff1 fs3 fc0 sc0 lsf5 ws1558">尽管很容易使用<span class="_ _d"></span>，但是很容易忽视的一个问题是在 <span class="ff6 ls0 ws149">PyArg ParseTuple()<span class="_ _18"> </span><span class="ff1 wsa0">中<span class="_ _0"></span>使<span class="_ _0"></span>用</span></span></div><div class="t m0 x4c h7 y1a72 ff1 fs3 fc0 sc0 ls0 wsa0">“<span class="ff4 ls298">s</span><span class="ls2b ws1559">”格式化码会有内存损耗。但你需要使用这种转换的时候，一个 </span><span class="ff4 ws155a">UTF-8 </span>字符串被创</div><div class="t m0 x5 h7 y3981 ff1 fs3 fc0 sc0 lse ws155b">建并永久附加在原始字符串对象上面。如果原始字符串包含非 <span class="ff4 ls0 ws155c">ASCI<span class="_ _6"></span>I </span><span class="wsd8">字符的话，就会<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y254e ff1 fs3 fc0 sc0 ls0">导致字符串的尺寸增到一直到被垃圾回收。例如：</div><div class="t m0 x5 h10 y3982 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sys</span></span></div><div class="t m0 x5 hf y3983 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalape<span class="ff7 ws156">\u00f1</span><span class="ws13a">o<span class="ff9">&apos;</span></span></span></span></span></span></div><div class="t m0 x5 hf y3984 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>getsizeof(s)</span></div><div class="t m0 x5 hf y3985 ff8 fs5 fc8 sc0 ls0">87</div><div class="t m0 x5 hf y3986 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws155d">print_chars(s) <span class="ffa fcd ws13b"># Passing string</span></span></div><div class="t m0 x5 hf y3987 ff8 fs5 fc8 sc0 ls0 ws4">53 70 69 63 79 20 4a 61 6c 61 70 65 c3 b1 6f</div><div class="t m0 x5 hf y3988 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span><span class="ws155e">getsizeof(s) <span class="ffa fcd ws4"># Notice increased size</span></span></span></div><div class="t m0 x5 hf y2f97 ff8 fs5 fc8 sc0 ls0">103</div><div class="t m0 x5 hf y3989 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y398a ff1 fs3 fc0 sc0 ls299 ws155f">如果你在乎这个内存的损耗<span class="_ _2d"></span>，你最好重写你的 <span class="ff4 ls29a">C</span><span class="ws1560">扩展代码<span class="_ _2d"></span>，<span class="_ _6"></span>让它使用<span class="_ _2d"></span></span></div><div class="t m0 x5 h9 y398b ff6 fs3 fc0 sc0 ls0 ws2dc">PyUnicode<span class="_ _7"> </span>AsUTF8String() <span class="ff1">函数。如下：</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.13.<span class="_ _36"> </span>15.13 <span class="ff1 ws16b">传递 </span><span class="ws1544">NULL <span class="ff1 ws7da">结尾的字符串给 </span><span class="ls246">C</span><span class="ff1 ws1545">函数库 </span>589</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
