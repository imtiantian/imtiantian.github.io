<div id="pf16a" class="pf w0 h0" data-page-no="16a"><div class="pc pc16a w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg16a.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 wsadf">11.22.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y236 ff1 fs3 fc0 sc0 ls1a7 wscad">实现一个新的上下文管理器的最简单的方法就是使用 <span class="ff6 ls0 wscae">contexlib <span class="ff1 wsa0">模<span class="_ _24"></span>块<span class="_ _24"> </span>中<span class="_ _25"> </span>的</span></span></div><div class="t m0 x5 h9 y237 ff6 fs3 fc0 sc0 ls0 ws4f7">@contextmanager <span class="ff1">装饰器。下面是一个实现了代码块计时功能的上下文管理器例子：</span></div><div class="t m0 x5 h10 y2598 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">time</span></div><div class="t m0 x5 hf y2599 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscaf">contextlib </span><span class="ws146">import <span class="ff8 fc0">contextmanager</span></span></div><div class="t m0 x5 h10 y259a ff7 fs5 fc12 sc0 ls0">@contextmanager</div><div class="t m0 x5 hf y19ad ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">timethis<span class="fc0">(label):</span></span></div><div class="t m0 x15 hf y19ae ff8 fs5 fc0 sc0 ls0 ws15f">start <span class="fc6 ls33">=</span><span class="ws13a">time<span class="fc6">.</span>time()</span></div><div class="t m0 x15 hf y19af ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x16 h10 y19b0 ff7 fs5 fca sc0 ls0">yield</div><div class="t m0 x15 hf y19b1 ff7 fs5 fca sc0 ls0 ws156">finally<span class="ff8 fc0">:</span></div><div class="t m0 x16 hf y19b2 ff8 fs5 fc0 sc0 ls0 ws158">end <span class="fc6 ls32">=</span><span class="ws13a">time<span class="fc6 ls34">.</span>time()</span></div><div class="t m0 x16 hf y2542 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">{}: {}</span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13b">format(label, end <span class="fc6 ls32">-</span>start))</span></span></div><div class="t m0 x5 h11 y259b ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 hf y259c ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">timethis(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">counting<span class="ff9 ws13b">&apos;</span></span>):</span></div><div class="t m0 x15 hf y259d ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls33">=<span class="fc7 ls0">10000000</span></span></div><div class="t m0 x15 hf y259e ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0 ls33">n<span class="fc6 ls32">&gt;<span class="fc7 ls34">0</span></span><span class="ls0">:</span></span></div><div class="t m0 x16 hf y259f ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls0 ws23d">-= <span class="fc7">1</span></span></div><div class="t m0 x0 h9 y2307 ff1 fs3 fc0 sc0 lsc8 wscb0">在函数 <span class="ff6 ls0 wscb1">timethis() <span class="ff1 wsa0">中，<span class="_ _6"></span></span><span class="wscb2">yield </span></span><span class="ls23 wscb3">之前的代码会在上下文管理器中作为 <span class="ff6 ls0 wsb75">enter ()</span></span></div><div class="t m0 x5 h9 y25a0 ff1 fs3 fc0 sc0 ls0 wscb4">方<span class="_ _6"></span>法<span class="_ _6"></span>执<span class="_ _6"></span>行，<span class="_ _6"></span>所<span class="_ _6"></span>有<span class="_ _6"></span>在 <span class="ff6 wscb5">yield </span><span class="lsa5 wscb6">之后的代码会作为 </span><span class="ff6 ws590">exit<span class="_ _e"> </span>() </span><span class="lsa5 ws3b5">方法执行。如果出现了异常<span class="_ _c"></span>，<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y2dd ff1 fs3 fc0 sc0 ls0 ws14">异常会在 <span class="ff4 wscb7">yield </span>语句那里抛出。</div><div class="t m0 x0 h9 y25a1 ff1 fs3 fc0 sc0 ls0">下面是一个更加高级一点的上下文管理器，实现了列表对象上的某种事务：</div><div class="t m0 x5 h10 y25a2 ff7 fs5 fc12 sc0 ls0">@contextmanager</div><div class="t m0 x5 hf y25a3 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">list_transaction<span class="fc0">(orig_list):</span></span></div><div class="t m0 x15 hf y25a4 ff8 fs5 fc0 sc0 ls0 ws155">working <span class="fc6 ls32">=</span><span class="fca ws13a">list</span>(orig_list)</div><div class="t m0 x15 hf y25a5 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0">working</span></div><div class="t m0 x15 hf y25a6 ff8 fs5 fc0 sc0 ls0 ws150">orig_list[:] <span class="fc6 ls33">=</span>working</div><div class="t m0 x0 h9 y25a7 ff1 fs3 fc0 sc0 ls3a ws153">这段代码的作用是任何对列表的修改只有当所有代码运行完成并且不出现异常的情</div><div class="t m0 x5 h9 y25a8 ff1 fs3 fc0 sc0 ls0">况下才会生效。下面我们来演示一下：</div><div class="t m0 x5 hf y25a9 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">items <span class="fc6 ls33">=</span><span class="ws13a">[<span class="fc7 ls34">1</span><span class="ls33">,</span><span class="fc7">2</span><span class="ls33">,<span class="fc7 ls34">3</span></span>]</span></span></div><div class="t m0 x5 hf y25aa ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">with <span class="ff8 fc0 wscb8">list_transaction(items) </span><span class="ws157">as <span class="ff8 fc0">working:</span></span></span></div><div class="t m0 x5 hf y25ab ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ws13a">working<span class="fc6 ls34">.</span>append(<span class="fc7">4</span>)</span></div><div class="t m0 x5 hf y25ac ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ws13a">working<span class="fc6 ls34">.</span>append(<span class="fc7">5</span>)</span></div><div class="t m0 x5 h10 y25ad ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y25ae ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">items</span></div><div class="t m0 x5 hf y1d20 ff8 fs5 fc8 sc0 ls0 ws4">[1, 2, 3, 4, 5]</div><div class="t m0 x5 hf y25af ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">with <span class="ff8 fc0 wscb8">list_transaction(items) </span><span class="ws157">as <span class="ff8 fc0">working:</span></span></span></div><div class="t m0 x5 hf y25b0 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ws13a">working<span class="fc6 ls34">.</span>append(<span class="fc7">6</span>)</span></div><div class="t m0 x5 hf y25b1 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ws13a">working<span class="fc6 ls34">.</span>append(<span class="fc7">7</span>)</span></div><div class="t m0 x5 hf y25b2 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">oops<span class="ff9 ls34">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 h10 y25b3 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y25b4 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y25b5 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">4</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.22.<span class="_ _5"> </span>9.22 <span class="ff1 wsb70">定义上下文管理器的简单方法 </span>353</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
