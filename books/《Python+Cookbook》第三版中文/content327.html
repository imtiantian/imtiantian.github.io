<div id="pf147" class="pf w0 h0" data-page-no="147"><div class="pc pc147 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg147.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">11.9.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y675 ff1 fs3 fc0 sc0 ls0 wsbf7">为了将装饰器定义成一个实例，<span class="_ _c"></span>你需要确保它实现了 <span class="ff6 ws9d2">call<span class="_ _e"> </span>() </span><span class="ls15d">和</span><span class="ff6 wsbf8">get<span class="_ _e"> </span>() </span>方法。</div><div class="t m0 x5 h9 y676 ff1 fs3 fc0 sc0 ls0">例如，下面的代码定义了一个类，它在其他函数上放置一个简单的记录层：</div><div class="t m0 x5 h10 y10ae ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">types</span></div><div class="t m0 x5 hf y10af ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">wraps</span></span></div><div class="t m0 x5 hf y10b1 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Profiled<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y10b2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, func):</span></span></span></div><div class="t m0 x16 hf y10b3 ff8 fs5 fc0 sc0 ls0 ws13a">wraps(func)(<span class="fca">self</span>)</div><div class="t m0 x16 hf y10b4 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">ncalls </span><span class="ls32">=</span><span class="fc7">0</span></span></div><div class="t m0 x15 hf y10b6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__call__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs):</span></span></div><div class="t m0 x16 hf y2239 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">ncalls </span><span class="ws1a1">+= <span class="fc7">1</span></span></span></div><div class="t m0 x16 hf y223a ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">__wrapped__(<span class="fc6 ls34">*</span><span class="ws15f">args, <span class="fc6 ls34">**</span>kwargs)</span></span></span></div><div class="t m0 x15 hf y223b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__get__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, cls):</span></span></span></div><div class="t m0 x16 hf y223c ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">instance </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y223d ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x16 hf y223e ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y223f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">types<span class="fc6 ls34">.</span>MethodType(<span class="fca">self</span><span class="ws4">, instance)</span></span></div><div class="t m0 x0 h9 y2240 ff1 fs3 fc0 sc0 ls0">你可以将它当做一个普通的装饰器来使用，在类里面或外面都可以：</div><div class="t m0 x5 h10 y2241 ff7 fs5 fc12 sc0 ls0">@Profiled</div><div class="t m0 x5 hf y2242 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y2243 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></div><div class="t m0 x5 hf y2244 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h10 y2245 ff7 fs5 fc12 sc0 ls0">@Profiled</div><div class="t m0 x15 hf y2246 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">bar<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, x):</span></span></span></div><div class="t m0 x16 hf y2247 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(</span><span class="ff8 ws13a">self<span class="fc0 ws4">, x)</span></span></div><div class="t m0 x0 h9 y2248 ff1 fs3 fc0 sc0 ls0">在交互环境中的使用示例：</div><div class="t m0 x5 hf y2249 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">add(<span class="fc7 ls34">2</span><span class="ls32">,<span class="fc7 ls34">3</span></span>)</span></div><div class="t m0 x5 hf y224a ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf y224b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">add(<span class="fc7 ls34">4</span><span class="ls32">,<span class="fc7 ls34">5</span></span>)</span></div><div class="t m0 x5 hf y224c ff8 fs5 fc8 sc0 ls0">9</div><div class="t m0 x5 hf y224d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">add<span class="fc6 ls34">.</span>ncalls</span></div><div class="t m0 x5 hf y224e ff8 fs5 fc8 sc0 ls0">2</div><div class="t m0 x5 hf y224f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">Spam()</span></span></div><div class="t m0 x5 hf y2250 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bar(</span></span><span class="fc7">1</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y2251 ff8 fs5 fc8 sc0 ls0 ws4">&lt;__main__.Spam object at 0x10069e9d0&gt; 1</div><div class="t m0 x5 hf y2252 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bar(</span></span><span class="fc7">2</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y175d ff8 fs5 fc8 sc0 ls0 ws4">&lt;__main__.Spam object at 0x10069e9d0&gt; 2</div><div class="t m0 x5 hf y2253 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bar(</span></span><span class="fc7">3</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y2254 ff8 fs5 fc8 sc0 ls0 ws4">&lt;__main__.Spam object at 0x10069e9d0&gt; 3</div><div class="t m0 x5 hf y2255 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">Spam<span class="fc6 ls34">.</span>bar<span class="fc6">.</span>ncalls</span></div><div class="t m0 x5 hf y2256 ff8 fs5 fc8 sc0 ls0">3</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">11.9.<span class="_ _5"> </span>9.9 <span class="ff1 ws2a4">将装饰器定义为类 </span>318</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
