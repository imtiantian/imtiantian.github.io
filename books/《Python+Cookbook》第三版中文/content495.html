<div id="pf1ef" class="pf w0 h0" data-page-no="1ef"><div class="pc pc1ef w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ef.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h7 y2a ff1 fs3 fc0 sc0 ls0 ws11af">来执行 <span class="ff4 ws11b0">I/O </span><span class="ws11b1">操作。 <span class="ff6 ws170">put() </span>方法再将数据放入队列后会写一个单字节到某个套接字中去。</span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls212">而<span class="ff6 ls0 wse15">get() </span><span class="lsa8 ws3de">方法在从队列中移除一个元素时会从另外一个套接字中读取到这个单字节数<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2c ff1 fs3 fc0 sc0 ls0">据。</div><div class="t m0 x0 h9 y99 ff6 fs3 fc0 sc0 ls0 ws11b2">fileno() <span class="ff1 ws11b3">方法使用一个函数比如 </span>select() <span class="ff1 wsa0">来让这个队列可以被轮询。<span class="_ _c"></span>它仅仅只是</span></div><div class="t m0 x5 h7 y9a ff1 fs3 fc0 sc0 ls0 ws14">暴露了底层被 <span class="ff6 ws17d">get() </span>函数使用到的 <span class="ff4 ws11b4">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1">的文件描述符而已。</span></span></div><div class="t m0 x0 h9 y30 ff1 fs3 fc0 sc0 ls0">下面是一个例子，定义了一个为到来的元素监控多个队列的消费者：</div><div class="t m0 x5 h10 y30e5 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">select</span></div><div class="t m0 x5 h10 y30e6 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y30e7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(queues):</span></span></div><div class="t m0 x15 h15 y30e8 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y30e9 ffa fs5 fc9 sc0 ls0 ws4">Consumer that reads data on multiple queues simultaneously</div><div class="t m0 x15 h15 y30ea ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y30eb ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y30ec ff8 fs5 fc0 sc0 ls0 ws13b">can_read, _, _ <span class="fc6 ls32">=</span><span class="ws13a">select<span class="fc6">.</span>select(queues,[],[])</span></div><div class="t m0 x16 hf y30ed ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">r</span><span class="ws157">in <span class="ff8 fc0">can_read:</span></span></div><div class="t m0 x17 hf y30ee ff8 fs5 fc0 sc0 ls0 ws161">item <span class="fc6 ls33">=</span><span class="ls34">r</span><span class="fc6 ws13a">.</span>get()</div><div class="t m0 x17 hf y30ef ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Got:<span class="ff9 ws13b">&apos;</span><span class="fc0 ws4">, item)</span></span></span></span></div><div class="t m0 x5 hf y30f0 ff8 fs5 fc0 sc0 ls0 ws159">q1 <span class="fc6 ls33">=</span>PollableQueue()</div><div class="t m0 x5 hf y30f1 ff8 fs5 fc0 sc0 ls0 ws159">q2 <span class="fc6 ls33">=</span>PollableQueue()</div><div class="t m0 x5 hf y30f2 ff8 fs5 fc0 sc0 ls0 ws159">q3 <span class="fc6 ls33">=</span>PollableQueue()</div><div class="t m0 x5 hf y3f8 ff8 fs5 fc0 sc0 ls32">t<span class="fc6 ls33">=</span><span class="ls0 ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6">=</span><span class="ws4">consumer, args</span><span class="fc6">=</span>([q1,q2,q3],))</span></div><div class="t m0 x5 hf y30f3 ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws19f">daemon <span class="fc6 ls32">=</span><span class="fca">True</span></span></div><div class="t m0 x5 hf y30f4 ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.<span class="fc0">start()</span></span></div><div class="t m0 x5 h11 y3fc ffa fs5 fcd sc0 ls0 ws4"># Feed data to the queues</div><div class="t m0 x5 hf y3fd ff8 fs5 fc0 sc0 ls0 ws13a">q1<span class="fc6 ls34">.</span>put(<span class="fc7 ls34">1</span>)</div><div class="t m0 x5 hf y30f5 ff8 fs5 fc0 sc0 ls0 ws13a">q2<span class="fc6 ls34">.</span>put(<span class="fc7">10</span>)</div><div class="t m0 x5 hf y30f6 ff8 fs5 fc0 sc0 ls0 ws13a">q3<span class="fc6 ls34">.</span>put(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">hello<span class="ff9 ls34">&apos;</span></span>)</div><div class="t m0 x5 hf y30f7 ff8 fs5 fc0 sc0 ls0 ws13a">q2<span class="fc6 ls34">.</span>put(<span class="fc7">15</span>)</div><div class="t m0 x5 hf y30f8 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x0 h9 y30f9 ff1 fs3 fc0 sc0 ls3a ws153">如果你试着运行它，你会发现这个消费者会接受到所有的被放入的元素，不管元素</div><div class="t m0 x5 h9 y30fa ff1 fs3 fc0 sc0 ls0">被放进了哪个队列中。</div><div class="t m0 x5 he y30fb ff2 fs2 fc4 sc0 ls0 wsadf">14.13.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y30fc ff1 fs3 fc0 sc0 ls0 wsa0">对于轮询非类文件对<span class="_ _6"></span>象，比如队列通常都是比较<span class="_ _6"></span>棘手的问题。例如，如果你<span class="_ _6"></span>不使用</div><div class="t m0 x5 h9 y30fd ff1 fs3 fc0 sc0 ls2d ws132">上面的套接字技术，你唯一的选择就是编写代码来循环遍历这些队列并使用一个定时<span class="_ _1"></span></div><div class="t m0 x5 h9 y30fe ff1 fs3 fc0 sc0 ls0">器。像下面这样：</div><div class="t m0 x5 h10 y5f5 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">time</span></div><div class="t m0 x5 hf y30ff ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(queues):</span></span></div><div class="t m0 x15 hf y3100 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y3101 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">q</span><span class="ws157">in <span class="ff8 fc0">queues:</span></span></div><div class="t m0 x17 hf y3102 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0 ls34">q<span class="fc6 ls0 ws13a">.<span class="fc0">empty():</span></span></span></div><div class="t m0 x18 hf y3103 ff8 fs5 fc0 sc0 ls0 ws161">item <span class="fc6 ls33">=</span><span class="ws13a">q<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.13.<span class="_ _36"> </span>12.13 <span class="ff1 ws11ae">多个线程队列轮询 </span>486</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
