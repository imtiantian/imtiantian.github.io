<div id="pf1b8" class="pf w0 h0" data-page-no="1b8"><div class="pc pc1b8 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1b8.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0 ws1009">在<span class="_ _6"></span>这<span class="_ _6"></span>个<span class="_ _6"></span>例<span class="_ _6"></span>子<span class="_ _6"></span>中，<span class="_ _6"></span>两<span class="_ _6"></span>个<span class="_ _6"></span>进<span class="_ _6"></span>程<span class="_ _6"></span>被<span class="_ _6"></span>创<span class="_ _6"></span>建<span class="_ _6"></span>并<span class="_ _6"></span>通<span class="_ _6"></span>过<span class="_ _6"></span>一个 <span class="ff6 ws100a">multiprocessing </span><span class="wsa0">管<span class="_ _6"></span>道<span class="_ _6"></span>连<span class="_ _6"></span>接<span class="_ _6"></span>起<span class="_ _6"></span>来。<span class="_ _6"></span>服</span></div><div class="t m0 x5 h7 y2b ff1 fs3 fc0 sc0 ls2d ws100b">务器进程打开一个 <span class="ff4 ls0 ws100c">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1 ls2d ws100d">并等待客户端连接请求。工作进程仅仅使用 </span><span class="ff6 ws3e1">recv handle()</span></span></div><div class="t m0 x5 h7 y2c ff1 fs3 fc0 sc0 ls48 ws404">在管道上面等待接收一个文件描述符<span class="_ _c"></span>。当服务器接收到一个连接，它将产生的 <span class="ff4 ls0 wsa5">sock<span class="_ _c"></span>et</span></div><div class="t m0 x5 h7 y2d ff1 fs3 fc0 sc0 ls0 ws100e">文件描<span class="_ _6"></span>述符<span class="_ _6"></span>通过 <span class="ff6 ws214">send handle() </span><span class="ws100f">传<span class="_ _6"></span>递给<span class="_ _6"></span>工作进<span class="_ _6"></span>程。工作<span class="_ _6"></span>进程接<span class="_ _6"></span>收到 <span class="ff4 ws1010">so<span class="_ _6"></span>ck<span class="_ _c"></span>et <span class="ff1 wsa0">后向<span class="_ _6"></span>客户端</span></span></span></div><div class="t m0 x5 h9 y2e ff1 fs3 fc0 sc0 ls0">回应数据，然后此次连接关闭。</div><div class="t m0 x0 h7 y9b ff1 fs3 fc0 sc0 ls0 ws38">如果你使用 <span class="ff4 wsbe">T<span class="_ _8"></span>elnet <span class="ff1">或类似工具连接到服务器，下面是一个演示例子：</span></span></div><div class="t m0 x20 h7 y31 ff4 fs3 fc0 sc0 ls0 ws1011">bash % p<span class="_ _1"></span>ython3 passfd.p<span class="_ _1"></span>y SER<span class="_ _19"></span>VER: Got connection from (‘127.0.0.1’,<span class="_ _a"> </span>55543)</div><div class="t m0 x20 h7 y32 ff4 fs3 fc0 sc0 ls0 ws9c">CHILD: GOT FD 7 CHILD: RECV b’Hellorn’ CHILD: RECV b’W<span class="_ _8"></span>orldrn’</div><div class="t m0 x0 h7 y278c ff1 fs3 fc0 sc0 ls40 ws1012">此例最重要的部分是服务器接收到的客户端 <span class="ff4 ls0 ws1013">so<span class="_ _6"></span>c<span class="_ _1"></span>ket <span class="ff1 ls40 ws180">实际上被另外一个不同的进程<span class="_ _c"></span></span></span></div><div class="t m0 x5 h9 y278d ff1 fs3 fc0 sc0 ls0">处理。服务器仅仅只是将其转手并关闭此连接，然后等待下一个连接。</div><div class="t m0 x5 he y2c92 ff2 fs2 fc4 sc0 ls0 wsadf">13.11.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2c93 ff1 fs3 fc0 sc0 ls3a ws153">对于大部分程序员来讲在不同进程之间传递文件描述符好像没什么必要。但是，有</div><div class="t m0 x5 h9 yf55 ff1 fs3 fc0 sc0 ls0 wsa0">时<span class="_ _6"></span>候它<span class="_ _6"></span>是<span class="_ _6"></span>构<span class="_ _6"></span>建<span class="_ _6"></span>一<span class="_ _6"></span>个可<span class="_ _6"></span>扩<span class="_ _6"></span>展<span class="_ _6"></span>系<span class="_ _6"></span>统<span class="_ _6"></span>的很<span class="_ _6"></span>有<span class="_ _6"></span>用<span class="_ _6"></span>的<span class="_ _6"></span>工<span class="_ _6"></span>具。例<span class="_ _6"></span>如，<span class="_ _6"></span>在<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>多<span class="_ _6"></span>核机<span class="_ _6"></span>器<span class="_ _6"></span>上<span class="_ _6"></span>面，<span class="_ _6"></span>你<span class="_ _6"></span>可以</div><div class="t m0 x5 h7 y2c94 ff1 fs3 fc0 sc0 ls0 ws38">有多个 <span class="ff4 ws5c">Python </span>解释器实例，将文件描述符传递给其它解释器来实现负载均衡。</div><div class="t m0 x0 h9 y2c95 ff6 fs3 fc0 sc0 ls0 ws3e1">send handle()<span class="_ _7"> </span><span class="ff1 ls44">和</span>recv handle()<span class="_ _18"> </span><span class="ff1 ls1d ws9a0">函数只能够用于 </span><span class="ws1014">multiprocessing <span class="ff1 wsa0">连<span class="_ _6"></span>接。<span class="_ _6"></span>使<span class="_ _0"></span>用</span></span></div><div class="t m0 x5 h7 y2c96 ff1 fs3 fc0 sc0 ls10 ws1015">它们来代替管道的使用（参考 <span class="ff4 ls0 wsb86">11.7 <span class="ff1 ws1016">节）<span class="_ _f"></span>，只<span class="_ _6"></span>要你<span class="_ _6"></span>使<span class="_ _6"></span>用<span class="_ _6"></span>的是 <span class="ff4 ws1017">Unix </span><span class="ls10 ws1018">域套接字或 </span><span class="ff4 wsa5">Windows</span></span></span></div><div class="t m0 x5 h9 y2c97 ff1 fs3 fc0 sc0 ls1e ws111">管道<span class="_ _1"></span>。例如，你可以让服务器和工作<span class="_ _1"></span>者各自以单独的程序来启动。下面是服务器<span class="_ _1"></span>的实</div><div class="t m0 x5 h9 y2c98 ff1 fs3 fc0 sc0 ls0">现例子：</div><div class="t m0 x5 h11 y2c99 ffa fs5 fcd sc0 ls0 ws4"># servermp.py</div><div class="t m0 x5 hf y2c9a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wsf5c">multiprocessing.connection </span><span class="ws146">import <span class="ff8 fc0">Listener</span></span></div><div class="t m0 x5 hf y2c9b ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws1008">multiprocessing.reduction </span><span class="ws146">import <span class="ff8 fc0">send_handle</span></span></div><div class="t m0 x5 h10 y2c9c ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">socket</span></div><div class="t m0 x5 hf y2c9d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">server<span class="fc0 ws4">(work_address, port):</span></span></div><div class="t m0 x15 h11 y2c9e ffa fs5 fcd sc0 ls0 ws4"># Wait for the worker to connect</div><div class="t m0 x15 hf y2c9f ff8 fs5 fc0 sc0 ls0 ws16e">work_serv <span class="fc6 ls33">=</span><span class="ws13b">Listener(work_address, authkey<span class="fc6 ls34">=<span class="fc0">b<span class="ff9 fc9">&apos;</span></span></span><span class="fc9 ws13a">peekaboo<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf y2ca0 ff8 fs5 fc0 sc0 ls0 ws145">worker <span class="fc6 ls32">=</span><span class="ws13a">work_serv<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x15 hf y2ca1 ff8 fs5 fc0 sc0 ls0 ws2a3">worker_pid <span class="fc6 ls32">=</span><span class="ws13a">worker<span class="fc6">.</span>recv()</span></div><div class="t m0 x15 h11 y2ca2 ffa fs5 fcd sc0 ls0 ws4"># Now run a TCP/IP server and send clients to worker</div><div class="t m0 x15 hf y2ca3 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws4">AF_INET, socket<span class="fc6 ls34">.</span>SOCK_STREAM)</span></span></div><div class="t m0 x15 hf y2ca4 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">setsockopt(socket</span>.</span><span class="ls0 ws4">SOL_SOCKET, socket<span class="fc6 ws13a">.</span><span class="ws147">SO_REUSEADDR, <span class="fca ws13a">True</span>)</span></span></div><div class="t m0 x15 hf y2ca5 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bind((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ws4">, port))</span></span></span></div><div class="t m0 x15 hf y2ca6 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">listen(</span></span><span class="fc7">1</span><span class="ls0">)</span></div><div class="t m0 x15 hf y2ca7 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2ca8 ff8 fs5 fc0 sc0 ls0 ws13b">client, addr <span class="fc6 ls33">=</span><span class="ws13a">s<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x16 hf y2ca9 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws4">SERVER: Got connection from<span class="ff9 ws13b">&apos;</span><span class="fc0">, addr)</span></span></span></span></div><div class="t m0 x16 hf y2caa ff8 fs5 fc0 sc0 ls0 ws13b">send_handle(worker, client<span class="fc6 ws13a">.</span><span class="ws4">fileno(), worker_pid)</span></div><div class="t m0 x16 hf y2cab ff8 fs5 fc0 sc0 ls0 ws13a">client<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 hf y2cac ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 h10 y2cad ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x15 hf y2cae ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">len<span class="fc0">(sys<span class="fc6 ls34">.</span><span class="ws15f">argv) <span class="fc6 ws159">!= <span class="fc7 ls34">3</span></span>:</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.11.<span class="_ _36"> </span>11.11 <span class="ff1 ws36c">进程间传递 </span><span class="wsffc">So<span class="_ _0"></span>ck<span class="_ _c"></span>et <span class="ff1 wsffd">文件描述符 </span>431</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
