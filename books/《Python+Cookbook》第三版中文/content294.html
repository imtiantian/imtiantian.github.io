<div id="pf126" class="pf w0 h0" data-page-no="126"><div class="pc pc126 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg126.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y181 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">right </span><span class="ls32">=</span><span class="fc0">right</span></span></div><div class="t m0 x5 hf y183 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Add<span class="ff8 fc0">(BinaryOperator):</span></span></div><div class="t m0 x15 h10 y184 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 hf y186 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Sub<span class="ff8 fc0">(BinaryOperator):</span></span></div><div class="t m0 x15 h10 y187 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 hf y98e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Mul<span class="ff8 fc0">(BinaryOperator):</span></span></div><div class="t m0 x15 h10 y98f ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 hf y991 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Div<span class="ff8 fc0">(BinaryOperator):</span></span></div><div class="t m0 x15 h10 y992 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 hf ya70 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Negate<span class="ff8 fc0">(UnaryOperator):</span></span></div><div class="t m0 x15 h10 y994 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x5 hf y996 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Number<span class="ff8 fc0">(Node):</span></span></div><div class="t m0 x15 hf y997 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, value):</span></span></span></div><div class="t m0 x16 hf y998 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">value </span><span class="ls32">=</span><span class="fc0">value</span></span></div><div class="t m0 x0 h9 y1f2d ff1 fs3 fc0 sc0 ls0">然后利用这些类构建嵌套数据结构，如下所示：</div><div class="t m0 x5 h11 y174c ffa fs5 fcd sc0 ls0 ws4"># Representation of 1 + 2 * (3 - 4) / 5</div><div class="t m0 x5 hf y174d ff8 fs5 fc0 sc0 ls0 ws159">t1 <span class="fc6 ls33">=</span><span class="ws13a">Sub(Number(<span class="fc7">3</span><span class="ws4">), Number(</span><span class="fc7">4</span>))</span></div><div class="t m0 x5 hf y174e ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">Mul(Number(<span class="fc7">2</span><span class="ws4">), t1)</span></span></div><div class="t m0 x5 hf y174f ff8 fs5 fc0 sc0 ls0 ws159">t3 <span class="fc6 ls33">=</span><span class="ws13b">Div(t2, Number(<span class="fc7 ws13a">5</span>))</span></div><div class="t m0 x5 hf y1750 ff8 fs5 fc0 sc0 ls0 ws159">t4 <span class="fc6 ls33">=</span><span class="ws13a">Add(Number(<span class="fc7">1</span><span class="ws4">), t3)</span></span></div><div class="t m0 x0 h9 y1f2e ff1 fs3 fc0 sc0 ls3a ws153">这样做的问题是对于每个表达式，每次都要重新定义一遍，有没有一种更通用的方</div><div class="t m0 x5 h9 y1f2f ff1 fs3 fc0 sc0 ls0">式让它支持所有的数字和操作符呢。这里我们使用访问者模式可以达到这样的目的：</div><div class="t m0 x5 hf ydb8 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">NodeVisitor<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1f30 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, node):</span></span></span></div><div class="t m0 x16 hf y1f31 ff8 fs5 fc0 sc0 ls0 ws1f5">methname <span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">visit_<span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span><span class="fca">type<span class="fc0">(node)<span class="fc6 ls34">.</span>__name__</span></span></span></div><div class="t m0 x16 hf y1f32 ff8 fs5 fc0 sc0 ls0 ws161">meth <span class="fc6 ls33">=</span><span class="fca ws13a">getattr</span><span class="ls34">(</span><span class="fca ws13a">self</span><span class="ws13b">, methname, <span class="fca ws13a">None</span>)</span></div><div class="t m0 x16 hf y1f33 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">meth </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1f34 ff8 fs5 fc0 sc0 ls0 ws161">meth <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.</span></span>generic_visit</div><div class="t m0 x16 hf y1f35 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">meth(node)</span></div><div class="t m0 x15 hf y1f36 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">generic_visit<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1f37 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">No {} method</span><span class="ls34">&apos;<span class="ff8 fc6">.</span></span></span><span class="fc0">format(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">visit_<span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span></span></span>type<span class="fc0">(node)<span class="fc6 ls34">.</span>__name__))</span></span></div><div class="t m0 x0 h9 y1f38 ff1 fs3 fc0 sc0 ls17 wsb52">为了使用这个类，可以定义一个类继承它并且实现各种 <span class="ff6 ls0 wsb53">visit Name() <span class="ff1 wsa0">方法，<span class="_ _6"></span>其中</span></span></div><div class="t m0 x5 h7 y1f39 ff4 fs3 fc0 sc0 ls0 wsb54">Name <span class="ff1 ls4">是</span><span class="wsb55">no<span class="_ _6"></span>de <span class="ff1">类型。例如，如果你想求表达式的值，可以这样写：</span></span></div><div class="t m0 x5 hf y1f3a ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Evaluator<span class="ff8 fc0">(NodeVisitor):</span></span></div><div class="t m0 x15 hf y1f3b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Number<span class="fc0">(<span class="fca">self</span><span class="ws4">, node):</span></span></span></div><div class="t m0 x16 hf y1f3c ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">node<span class="fc6 ls34">.</span>value</span></div><div class="t m0 x15 hf y1f3d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Add<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1f3e ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">visit(node<span class="fc6 ls34">.</span><span class="ws15f">left) <span class="fc6 ls32">+</span></span></span>self<span class="fc6 ls34">.</span><span class="fc0">visit(node<span class="fc6 ls34">.</span>right)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.21.<span class="_ _5"> </span>8.21 <span class="ff1 wsb0f">实现访问者模式 </span>285</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
