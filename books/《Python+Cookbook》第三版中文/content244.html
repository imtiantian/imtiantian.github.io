<div id="pff4" class="pf w0 h0" data-page-no="f4"><div class="pc pcf4 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgf4.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y181 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">partial</span></span></div><div class="t m0 x5 hf y183 ff8 fs5 fc0 sc0 ls0 ws13c">conn <span class="fc6 ls32">=</span><span class="ws13a">LazyConnection((<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">www.python.org<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">80</span>))</span></div><div class="t m0 x5 h11 y184 ffa fs5 fcd sc0 ls0 ws4"># Connection closed</div><div class="t m0 x5 hf y185 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws161">conn </span><span class="ws157">as <span class="ff8 fc0">s:</span></span></div><div class="t m0 x15 h11 y186 ffa fs5 fcd sc0 ls0 ws4"># conn.__enter__() executes: connection open</div><div class="t m0 x15 hf y187 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">GET /index.html HTTP/1.0<span class="ff7 ws156">\r\n</span></span><span class="ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y188 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Host: www.python.org<span class="ff7 ws156">\r\n</span></span><span class="ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y98e ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff7 ws156">\r\n</span><span class="ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y98f ff8 fs5 fc0 sc0 ls0 ws13c">resp <span class="fc6 ls32">=</span><span class="ls34">b</span><span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="fc6 ls34">.</span><span class="ws13a">join(<span class="fca">iter</span>(partial(s<span class="fc6">.</span><span class="ws458">recv, </span><span class="fc7">8192</span><span class="ws13b">), b<span class="ff9 fc9">&apos;&apos;</span>))</span></span></div><div class="t m0 x15 h11 y990 ffa fs5 fcd sc0 ls0 ws4"># conn.__exit__() executes: connection closed</div><div class="t m0 x5 he y1a62 ff2 fs2 fc4 sc0 ls0 ws212">10.3.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y1a63 ff1 fs3 fc0 sc0 ls0 ws9d7">编写上下文管理器的主要原理是你的代码会放到 <span class="ff6 ws9e5">with </span><span class="ws9e6">语句块中执行。当出现 <span class="ff6">with</span></span></div><div class="t m0 x5 h7 y1a64 ff1 fs3 fc0 sc0 ls2d ws9e7">语句的时候<span class="_ _1"></span>，对象的 <span class="ff6 ls0 ws5f7">enter<span class="_ _e"> </span>() <span class="ff1 ws9e8">方<span class="_ _6"></span>法<span class="_ _6"></span>被触<span class="_ _6"></span>发，<span class="_ _6"></span>它<span class="_ _6"></span>返回<span class="_ _6"></span>的<span class="_ _6"></span>值 <span class="ff4 wsa5">(</span><span class="wsa0">如<span class="_ _6"></span>果有<span class="_ _6"></span>的<span class="_ _6"></span>话<span class="ff4 ls5c">)</span>会<span class="_ _6"></span>被赋<span class="_ _6"></span>值<span class="_ _6"></span>给</span></span></span></div><div class="t m0 x5 h9 y1a65 ff6 fs3 fc0 sc0 ls0 ws26b">as <span class="ff1 ls68 ws23f">声明的变量。然后，</span><span class="ws364">with <span class="ff1 ls68 ws9e9">语句块里面的代码开始执行。最后， </span></span>exit<span class="_ _e"> </span>() <span class="ff1 ls68 ws23f">方法被触<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y1a66 ff1 fs3 fc0 sc0 ls0">发进行清理工作。</div><div class="t m0 x0 h9 y1a67 ff1 fs3 fc0 sc0 ls0 ws409">不管 <span class="ff6 ws27f">with </span><span class="lse wsd8">代码块中发生什么，上面的控制流都会执行完，就算代码块中发生了异</span></div><div class="t m0 x5 h9 y1a68 ff1 fs3 fc0 sc0 ls0 ws9ea">常也是一样的。<span class="_ _1"></span>事实上， <span class="ff6 ws9eb">exit<span class="_ _e"> </span>() </span><span class="wsa0">方法的第三个参数包含了异常类型、<span class="_ _1"></span>异常值和追溯</span></div><div class="t m0 x5 h7 y1a69 ff1 fs3 fc0 sc0 ls0 ws9ec">信息 <span class="ff4 ls1b">(</span><span class="lsa8 ws3de">如果有的话</span><span class="ff4 wsa5">)</span><span class="ls161">。</span><span class="ff6 ws9ed">exit<span class="_ _e"> </span>() </span><span class="lsa8 ws3de">方法能自己决定怎样利用这个异常信息，或者忽略它<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y1a6a ff1 fs3 fc0 sc0 ls0 ws38">并返回一个 <span class="ff4 ws91b">None </span><span class="ws9d6">值。如果 <span class="ff6 ws308">exit<span class="_ _e"> </span>() </span><span class="wsc">返回 <span class="ff6 ws27b">True </span>，那么异常会被清空，就好像什么都</span></span></div><div class="t m0 x5 h9 y1a6b ff1 fs3 fc0 sc0 ls0 ws14">没发生一样， <span class="ff6 ws17a">with </span>语句后面的程序继续在正常执行。</div><div class="t m0 x0 h9 y1a6c ff1 fs3 fc0 sc0 ls0 ws9ee">还有<span class="_ _6"></span>一<span class="_ _6"></span>个细<span class="_ _6"></span>节<span class="_ _6"></span>问题<span class="_ _6"></span>就<span class="_ _6"></span>是 <span class="ff6 ws9ef">LazyConnection </span><span class="ws9f0">类是<span class="_ _6"></span>否<span class="_ _6"></span>允许<span class="_ _6"></span>多个 <span class="ff6 ws9f1">with </span><span class="wsa0">语<span class="_ _6"></span>句<span class="_ _6"></span>来嵌<span class="_ _6"></span>套<span class="_ _6"></span>使用<span class="_ _6"></span>连</span></span></div><div class="t m0 x5 h7 y1a6d ff1 fs3 fc0 sc0 ls6b ws9f2">接。很显然<span class="_ _c"></span>，上面的定义中一次只能允许<span class="_ _6"></span>一个 <span class="ff4 ls0 ws9f3">so<span class="_ _6"></span>c<span class="_ _c"></span>ket <span class="ff1 ls6b ws9f4">连接<span class="_ _1"></span>，如果正在使用一个 <span class="ff4 ls0 wsa5">so<span class="_ _6"></span>ck<span class="_ _c"></span>et</span></span></span></div><div class="t m0 x5 h9 y1a6e ff1 fs3 fc0 sc0 ls1f ws9f5">的时候又重复使用 <span class="ff6 ls0 ws9f6">with </span><span class="ws113">语句，就会产生一个异常了。不过你可以像下面这样修改下上</span></div><div class="t m0 x5 h9 y1a6f ff1 fs3 fc0 sc0 ls0">面的实现来解决这个问题：</div><div class="t m0 x5 hf y1a70 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 hf y1a71 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">LazyConnection<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1a72 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, address, family</span><span class="fc6">=</span><span class="ws16d">AF_INET, </span><span class="fca">type<span class="fc6 ls34">=</span></span>SOCK_STREAM):</span></span></div><div class="t m0 x16 hf y1a73 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">address </span><span class="ls33">=</span><span class="fc0">address</span></span></div><div class="t m0 x16 hf y1a74 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">family </span><span class="ls32">=</span><span class="fc0">family</span></span></div><div class="t m0 x16 hf y1a75 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">type </span><span class="ls33">=</span></span>type</div><div class="t m0 x16 hf y529 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">connections </span><span class="ls33">=</span><span class="fc0">[]</span></span></div><div class="t m0 x15 hf y52b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__enter__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1a76 ff8 fs5 fc0 sc0 ls0 ws161">sock <span class="fc6 ls33">=</span><span class="ws13a">socket(<span class="fca">self<span class="fc6 ls34">.</span></span><span class="ws1f4">family, </span><span class="fca">self<span class="fc6 ls34">.</span></span>type)</span></div><div class="t m0 x16 hf y1a77 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6">.</span>connect(<span class="fca">self<span class="fc6 ls34">.</span></span>address)</div><div class="t m0 x16 hf y1a78 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">connections</span><span class="ls34">.</span><span class="fc0">append(sock)</span></span></div><div class="t m0 x16 hf y1a79 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">sock</span></div><div class="t m0 x15 hf y1a7a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__exit__<span class="fc0">(<span class="fca">self</span><span class="ws4">, exc_ty, exc_val, tb):</span></span></span></div><div class="t m0 x16 hf y1a7b ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">connections</span><span class="ls34">.</span><span class="fc0">pop()</span><span class="ls34">.</span><span class="fc0">close()</span></span></div><div class="t m0 x5 h11 y1a7c ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">10.3.<span class="_ _5"> </span>8.3 <span class="ff1 ws23b">让对象支持上下文管理协议 </span>235</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
