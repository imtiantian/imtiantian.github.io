<div id="pf134" class="pf w0 h0" data-page-no="134"><div class="pc pc134 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg134.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls0 wsb87">保<span class="_ _6"></span>存。<span class="_ _6"></span>一<span class="_ _6"></span>个 <span class="ff6 wsb88">WeakValueDictionary </span><span class="wsa0">实<span class="_ _0"></span>例只<span class="_ _0"></span>会保<span class="_ _0"></span>存<span class="_ _6"></span>那<span class="_ _6"></span>些<span class="_ _6"></span>在<span class="_ _6"></span>其<span class="_ _6"></span>它<span class="_ _0"></span>地方<span class="_ _0"></span>还在<span class="_ _0"></span>被使<span class="_ _0"></span>用<span class="_ _6"></span>的<span class="_ _6"></span>实<span class="_ _6"></span>例。</span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">否则的话，只要实例不再被使用了，它就从字典中被移除了。观察下下面的测试结果：</div><div class="t m0 x5 hf y2075 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">get_spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">foo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y2076 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">b<span class="fc6 ls33">=</span><span class="ls0 ws13a">get_spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">bar<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y2077 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0 ws13a">get_spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">foo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y2078 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fca ws13a">list<span class="fc0">(_spam_cache)</span></span></div><div class="t m0 x5 hf y2079 ff8 fs5 fc8 sc0 ls34">[<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws13a">foo<span class="ff9 ws13b">&apos;</span><span class="ls33">,</span></span><span class="ff9">&apos;</span><span class="ls0 ws13a">bar<span class="ff9 ws13b">&apos;</span>]</span></div><div class="t m0 x5 hf y207a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0">a</span></span></div><div class="t m0 x5 hf y207b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0">c</span></span></div><div class="t m0 x5 hf y207c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fca ws13a">list<span class="fc0">(_spam_cache)</span></span></div><div class="t m0 x5 hf y207d ff8 fs5 fc8 sc0 ls34">[<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws13a">bar<span class="ff9 ws13b">&apos;</span>]</span></div><div class="t m0 x5 hf y207e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0">b</span></span></div><div class="t m0 x5 hf y207f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fca ws13a">list<span class="fc0">(_spam_cache)</span></span></div><div class="t m0 x5 hf y2080 ff8 fs5 fc8 sc0 ls0">[]</div><div class="t m0 x5 hf y2081 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y2082 ff1 fs3 fc0 sc0 ls3a ws153">对于大部分程序而已，这里代码已经够用了。不过还是有一些更高级的实现值得了</div><div class="t m0 x5 h9 y2083 ff1 fs3 fc0 sc0 ls0">解下。</div><div class="t m0 x0 h9 y2084 ff1 fs3 fc0 sc0 ls3a ws153">首先是这里使用到了一个全局变量，并且工厂函数跟类放在一块。我们可以通过将</div><div class="t m0 x5 h9 y2085 ff1 fs3 fc0 sc0 ls0">缓存代码放到一个单独的缓存管理器中：</div><div class="t m0 x5 h10 y2086 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">weakref</span></div><div class="t m0 x5 hf y2087 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">CachedSpamManager<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2088 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y2089 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_cache </span><span class="ls32">=</span><span class="fc0">weakref</span><span class="ls34">.</span><span class="fc0">WeakValueDictionary()</span></span></div><div class="t m0 x15 hf y229 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_spam<span class="fc0">(<span class="fca">self</span><span class="ws4">, name):</span></span></span></div><div class="t m0 x16 hf y22a ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">name </span>not in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_cache:</span></span></span></div><div class="t m0 x17 hf y22b ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">Spam(name)</span></div><div class="t m0 x17 hf y22c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">_cache[name] </span><span class="ls32">=</span><span class="fc0">s</span></span></div><div class="t m0 x16 hf y208a ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y22e ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=<span class="fca ls0 ws13a">self<span class="fc6">.<span class="fc0">_cache[name]</span></span></span></span></div><div class="t m0 x16 hf y22f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">s</span></div><div class="t m0 x15 hf y208b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">clear<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x17 hf y208c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_cache</span>.<span class="fc0">clear()</span></span></div><div class="t m0 x5 hf y1e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y208d ff8 fs5 fc0 sc0 ls0 ws155">manager <span class="fc6 ls32">=</span>CachedSpamManager()</div><div class="t m0 x15 hf y208e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name):</span></span></span></div><div class="t m0 x16 hf y208f ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x15 hf y2090 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_spam<span class="fc0">(name):</span></span></div><div class="t m0 x16 hf y2091 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">Spam<span class="fc6 ls34">.</span>manager<span class="fc6">.</span>get_spam(name)</span></div><div class="t m0 x0 h9 yf8e ff1 fs3 fc0 sc0 ls0 wsa0">这样的话代码更清晰，<span class="_ _6"></span>并且也更灵活，我们可以增<span class="_ _6"></span>加更多的缓存管理机制，<span class="_ _6"></span>只需要</div><div class="t m0 x5 h7 y8c4 ff1 fs3 fc0 sc0 ls0 ws14">替代 <span class="ff4 wsb89">manager </span>即可。</div><div class="t m0 x0 h9 y6e ff1 fs3 fc0 sc0 ls30 ws138">还有一点就是<span class="_ _1"></span>，我们暴露了类的实例化给用户，用户很容易去直接实例化这个类<span class="_ _c"></span>，</div><div class="t m0 x5 h9 y674 ff1 fs3 fc0 sc0 ls0">而不是使用工厂方法，如：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.25.<span class="_ _5"> </span>8.25 <span class="ff1 wsb83">创建缓存实例 </span>299</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
