<div id="pf1bd" class="pf w0 h0" data-page-no="1bd"><div class="pc pc1bd w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1bd.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1ac ff8 fs5 fc0 sc0 ls0 ws13b">msg, addr <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">sock<span class="fc6 ls34">.</span>recvfrom(<span class="fc7 ls34">1</span>)</span></span></div><div class="t m0 x16 hf y1ad ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">sendto(time</span><span class="ls34">.</span><span class="fc0">ctime()</span><span class="ls34">.</span><span class="fc0">encode(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">ascii<span class="ff9 ls34">&apos;</span></span><span class="ws13b">), addr)</span></span></span></div><div class="t m0 x5 hf y1af ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">UDPEchoServer<span class="ff8 fc0">(UDPServer):</span></span></div><div class="t m0 x15 hf y1b0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y355 ff8 fs5 fc0 sc0 ls0 ws13b">msg, addr <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">sock<span class="fc6 ls34">.</span>recvfrom(<span class="fc7">8192</span>)</span></span></div><div class="t m0 x16 hf y410 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0 ws4">sendto(msg, addr)</span></span></div><div class="t m0 x5 hf yba ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws1f5">handlers <span class="fc6 ls33">=</span><span class="ws13b">[ UDPTimeServer((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ws13a">,<span class="fc7">14000</span><span class="ws4">)), UDPEchoServer((</span></span><span class="ff9 fc9">&apos;&apos;</span><span class="ls34">,</span><span class="fc7 ws13a">15000</span><span class="ws41d">)) ]</span></span></div><div class="t m0 x15 hf ybed ff8 fs5 fc0 sc0 ls0">event_loop(handlers)</div><div class="t m0 x0 h7 y2cf5 ff1 fs3 fc0 sc0 ls0 ws14">测试这段代码，试着从另外一个 <span class="ff4 ws5c">Python </span>解释器连接它：</div><div class="t m0 x5 hf y19b3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc6">*</span></span></span></span></div><div class="t m0 x5 hf y19b4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_DGRAM)</span></span></div><div class="t m0 x5 hf y19b5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">sendto(b</span></span><span class="ff9 fc9">&apos;&apos;</span><span class="ls0 ws13a">,(</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">localhost</span>&apos;</span>,<span class="fc7 ls0 ws13a">14000<span class="fc0">))</span></span></span></div><div class="t m0 x5 hf y2cf6 ff8 fs5 fc8 sc0 ls0">0</div><div class="t m0 x5 hf y14bd ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">recvfrom(<span class="fc7">128</span>)</span></span></span></div><div class="t m0 x5 hf y14be ff8 fs5 fc8 sc0 ls0 ws13a">(b<span class="ff9 ls34">&apos;</span><span class="ws4">Tue Sep 18 14:29:23 2012<span class="ff9 ws13b">&apos;</span>, (<span class="ff9 ws13b">&apos;</span></span>127.0.0.1<span class="ff9 ls34">&apos;</span><span class="ws13b">, 14000))</span></div><div class="t m0 x5 hf y2cf7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">sendto(b</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Hello<span class="ff9 ws13b">&apos;</span><span class="fc0">,(</span><span class="ff9 ws13b">&apos;</span>localhost</span>&apos;</span><span class="ls0 ws13a">,<span class="fc7">15000</span>))</span></span></div><div class="t m0 x5 hf y14bf ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf y2cf8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">recvfrom(<span class="fc7">128</span>)</span></span></span></div><div class="t m0 x5 hf y14c0 ff8 fs5 fc8 sc0 ls0 ws13a">(b<span class="ff9 ls34">&apos;</span>Hello<span class="ff9 ls34">&apos;</span><span class="ws13b">, (<span class="ff9">&apos;</span></span>127.0.0.1<span class="ff9 ls34">&apos;</span><span class="ws13b">, 15000))</span></div><div class="t m0 x5 hf y14c1 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y230a ff1 fs3 fc0 sc0 ls3d ws1036">实现一个 <span class="ff4 ls0 ws1037">TCP </span><span class="ws164">服务器会更加复杂一点，因为每一个客户端都要初始化一个新的处</span></div><div class="t m0 x5 h7 y2cf9 ff1 fs3 fc0 sc0 ls0 ws14">理器对象。下面是一个 <span class="ff4 ws88">TCP </span>应答客户端例子：</div><div class="t m0 x5 hf y2cfa ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">TCPServer<span class="ff8 fc0">(EventHandler):</span></span></div><div class="t m0 x15 hf y2cfb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, address, client_handler, handler_list):</span></span></span></div><div class="t m0 x16 hf y2cfc ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">sock </span><span class="ls33">=</span><span class="fc0">socket</span><span class="ls34">.</span><span class="fc0">socket(socket</span><span class="ls34">.</span><span class="fc0 ws13b">AF_INET, socket</span>.<span class="fc0">SOCK_STREAM)</span></span></div><div class="t m0 x16 hf y2cfd ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">setsockopt(socket</span><span class="ls34">.</span><span class="fc0 ws4">SOL_SOCKET, socket</span><span class="ls34">.</span><span class="fc0 ws147">SO_REUSEADDR, </span></span>True<span class="fc0">)</span></div><div class="t m0 x16 hf y2cfe ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">bind(address)</span></span></div><div class="t m0 x16 hf y2cff ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">listen(<span class="fc7 ls34">1</span>)</span></span></div><div class="t m0 x16 hf y2d00 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws169">client_handler </span><span class="ls33">=</span><span class="fc0">client_handler</span></span></div><div class="t m0 x16 hf y2d01 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">handler_list </span><span class="ls32">=</span><span class="fc0">handler_list</span></span></div><div class="t m0 x15 hf y2d02 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">fileno<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y2d03 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">sock<span class="fc6 ls34">.</span>fileno()</span></span></div><div class="t m0 x15 hf y2d04 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wants_to_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y2d05 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">True</span></div><div class="t m0 x15 hf y2cd ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y2d06 ff8 fs5 fc0 sc0 ls0 ws13b">client, addr <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span></span></span>accept()</div><div class="t m0 x16 h11 y2d07 ffa fs5 fcd sc0 ls0 ws4"># Add the client to the event loop<span class="ffb ws13b">&apos;</span>s handler list</div><div class="t m0 x16 hf y2d08 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">handler_list</span><span class="ls34">.</span><span class="fc0">append(</span></span>self<span class="fc6 ls34">.</span><span class="fc0 ws1038">client_handler(client, </span>self<span class="fc6 ls34">.</span><span class="fc0">handler_list))</span></div><div class="t m0 x5 hf y2d09 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">TCPClient<span class="ff8 fc0">(EventHandler):</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.12.<span class="_ _36"> </span>11.12 <span class="ff1 ws36c">理解事件驱动的 </span><span class="ws102f">IO 436</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
