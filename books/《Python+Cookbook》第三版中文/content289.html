<div id="pf121" class="pf w0 h0" data-page-no="121"><div class="pc pc121 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg121.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 ws211">10.19<span class="_ _e"> </span>8.19 <span class="ff1">实现状态对象或者状态机</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">10.19.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y114 ff1 fs3 fc0 sc0 ls3a ws153">你想实现一个状态机或者是在不同状态下执行操作的对象，但是又不想在代码中出</div><div class="t m0 x5 h9 y115 ff1 fs3 fc0 sc0 ls0">现太多的条件判断语句。</div><div class="t m0 x5 he y116 ff2 fs2 fc4 sc0 ls0 wsadf">10.19.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 yf10 ff1 fs3 fc0 sc0 ls3a ws153">在很多程序中，有些对象会根据状态的不同来执行不同的操作。比如考虑如下的一</div><div class="t m0 x5 h9 yf11 ff1 fs3 fc0 sc0 ls0">个连接对象：</div><div class="t m0 x5 hf y1ebf ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Connection<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h12 y1ec0 ffa fs5 fc9 sc0 ls0 ws158">&quot;&quot;&quot; <span class="ffc fs6 ws3d3">普通方案，好多个判断语句，效率低下 </span>~~&quot;&quot;&quot;</div><div class="t m0 x15 hf y1ec1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y16b9 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">state </span><span class="ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">CLOSED<span class="ff9">&apos;</span></span></span></div><div class="t m0 x15 hf y1ec2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">read<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y1ec3 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws15f">state <span class="fc6 ws159">!= <span class="ff9 fc9 ls34">&apos;</span></span></span><span class="fc9">OPEN<span class="ff9 ls34">&apos;</span><span class="fc0">:</span></span></span></div><div class="t m0 x17 hf y1ec4 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Not open</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x16 hf y1ec5 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">reading</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x15 hf yf7f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">write<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, data):</span></span></span></div><div class="t m0 x16 hf y1ec6 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws15f">state <span class="fc6 ws159">!= <span class="ff9 fc9 ls34">&apos;</span></span></span><span class="fc9">OPEN<span class="ff9 ls34">&apos;</span><span class="fc0">:</span></span></span></div><div class="t m0 x17 hf y1ec7 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Not open</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x16 hf y1ec8 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">writing</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x15 hf y1ec9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">open<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y1eca ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws15f">state <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span></span><span class="fc9">OPEN<span class="ff9 ls34">&apos;</span><span class="fc0">:</span></span></span></div><div class="t m0 x17 hf y1ecb ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Already open</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x16 hf y1ecc ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">state </span><span class="ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">OPEN<span class="ff9">&apos;</span></span></span></div><div class="t m0 x15 hf y12ea ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">close<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1ecd ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws15f">state <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span></span><span class="fc9">CLOSED<span class="ff9 ls34">&apos;</span><span class="fc0">:</span></span></span></div><div class="t m0 x17 hf y1ece ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Already closed</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x16 hf y1ecf ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">state </span><span class="ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">CLOSED<span class="ff9">&apos;</span></span></span></div><div class="t m0 x0 h9 y1ed0 ff1 fs3 fc0 sc0 ls24 ws11d">这样写有很多缺点<span class="_ _c"></span>，首先是代码太复杂了<span class="_ _1"></span>，好多的条件判断<span class="_ _1"></span>。其次是执行效率变<span class="_ _c"></span></div><div class="t m0 x5 h7 y1bec ff1 fs3 fc0 sc0 ls0 ws38">低，因为一些常见的操作比如 <span class="ff4 wsa5">read()</span><span class="lsb">、</span><span class="ff4 wsb48">write() </span>每次执行前都需要执行检查。</div><div class="t m0 x0 h9 y1ed1 ff1 fs3 fc0 sc0 ls0">一个更好的办法是为每个状态定义一个对象：</div><div class="t m0 x5 hf y1ed2 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Connection1<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h12 y1ed3 ffa fs5 fc9 sc0 ls0 ws158">&quot;&quot;&quot; <span class="ffc fs6 ws3d4">新方案——对每个状态定义一个类</span>&quot;&quot;&quot;</div><div class="t m0 x15 hf y1ed4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y1ed5 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">new_state(ClosedConnectionState)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.19.<span class="_ _5"> </span>8.19 <span class="ff1 wsb03">实现状态对象或者状态机 </span>280</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
