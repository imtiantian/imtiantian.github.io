<div id="pfcf" class="pf w0 h0" data-page-no="cf"><div class="pc pccf w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgcf.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls1e ws111">码<span class="_ _1"></span>。如果用这样的代码来处理真实的数据文件<span class="_ _1"></span>，那未免也太繁杂了点。因此很显<span class="_ _1"></span>然应</div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">该有另一种解决方法可以简化这些步骤，让程序员只关注自最重要的事情。</div><div class="t m0 x0 h9 y8dd ff1 fs3 fc0 sc0 ls3a ws153">在本小节接下来的部分，我会逐步演示一个更加优秀的解析字节数据的方案。目标</div><div class="t m0 x5 h9 y99 ff1 fs3 fc0 sc0 ls13 wse5">是可以给程序员提供一个高级的文件格式化方法<span class="_ _1"></span>，并简化读取和解包数据的细节。但<span class="_ _c"></span></div><div class="t m0 x5 h9 y9a ff1 fs3 fc0 sc0 ls13 wse5">是我要先提醒你<span class="_ _1"></span>，本小节接下来的部分代码应该是整本书中最复杂最高级的例子，使<span class="_ _c"></span></div><div class="t m0 x5 h9 y9b ff1 fs3 fc0 sc0 ls13 wse5">用了大量的面向对象编程和元编程技术<span class="_ _1"></span>。一定要仔细的阅读我们的讨论部分，另外也<span class="_ _c"></span></div><div class="t m0 x5 h9 y9c ff1 fs3 fc0 sc0 ls0">要参考下其他章节内容。</div><div class="t m0 x0 h9 y32 ff1 fs3 fc0 sc0 ls3a ws153">首先，当读取字节数据的时候，通常在文件开始部分会包含文件头和其他的数据结</div><div class="t m0 x5 h7 y33 ff1 fs3 fc0 sc0 ls0 ws8d3">构。尽<span class="_ _6"></span>管 <span class="ff4 ws8d4">struct </span><span class="ls22 ws119">模块可以解包这些数据到一个元组中去，另外一种表示这种信<span class="_ _1"></span>息的方</span></div><div class="t m0 x5 h9 y34 ff1 fs3 fc0 sc0 ls0">式就是使用一个类。就像下面这样：</div><div class="t m0 x5 h10 y168f ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">struct</span></div><div class="t m0 x5 hf y1690 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">StructField<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h15 y1691 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y1692 ffa fs5 fc9 sc0 ls0 ws4">Descriptor representing a simple structure field</div><div class="t m0 x15 h15 y1693 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y1694 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, format, offset):</span></span></span></div><div class="t m0 x16 hf y1695 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">format </span><span class="ls32">=</span><span class="fc0">format</span></span></div><div class="t m0 x16 hf y1696 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">offset </span><span class="ls32">=</span><span class="fc0">offset</span></span></div><div class="t m0 x15 hf y1697 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__get__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, cls):</span></span></span></div><div class="t m0 x16 hf y1698 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">instance </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1699 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x16 hf y169a ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y169b ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=</span><span class="ls0 ws13a">struct<span class="fc6 ls34">.</span>unpack_from(<span class="fca">self<span class="fc6 ls34">.</span></span><span class="ws4">format, instance</span><span class="fc6">.</span><span class="ws16d">_buffer, </span><span class="fca">self<span class="fc6 ls34">.</span></span>offset)</span></div><div class="t m0 x17 hf y169c ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">r[<span class="fc7 ls34">0</span><span class="ls32">]</span></span><span class="ws160">if <span class="ff8 ws13a">len<span class="fc0 ws158">(r) <span class="fc6 ws159">== <span class="fc7 ls32">1</span></span></span></span><span class="ws15a">else <span class="ff8 fc0">r</span></span></span></div><div class="t m0 x5 hf y169d ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Structure<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y169e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, bytedata):</span></span></span></div><div class="t m0 x16 hf y169f ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_buffer </span><span class="ls33">=</span><span class="fc0">memoryview(bytedata)</span></span></div><div class="t m0 x0 h9 y16a0 ff1 fs3 fc0 sc0 ls63 ws21f">这里我们使用了一个描述器来表示每个结构字段<span class="_ _c"></span>，每个描述器包含一个结构兼容<span class="_ _1"></span></div><div class="t m0 x5 h9 y16a1 ff1 fs3 fc0 sc0 ls0 ws8d5">格<span class="_ _0"></span>式<span class="_ _6"></span>的<span class="_ _0"></span>代<span class="_ _0"></span>码<span class="_ _6"></span>以<span class="_ _0"></span>及<span class="_ _0"></span>一<span class="_ _6"></span>个<span class="_ _0"></span>字<span class="_ _0"></span>节<span class="_ _0"></span>偏<span class="_ _6"></span>移<span class="_ _0"></span>量，<span class="_ _0"></span>存<span class="_ _6"></span>储<span class="_ _0"></span>在<span class="_ _0"></span>内<span class="_ _0"></span>部<span class="_ _6"></span>的<span class="_ _0"></span>内<span class="_ _0"></span>存<span class="_ _6"></span>缓<span class="_ _0"></span>冲<span class="_ _0"></span>中。<span class="_ _6"></span>在 <span class="ff6 ws8d6">get<span class="_ _e"> </span>() </span><span class="wsa0">方<span class="_ _0"></span>法<span class="_ _0"></span>中，</span></div><div class="t m0 x5 h9 y16a2 ff6 fs3 fc0 sc0 ls0 ws20b">struct.unpack from() <span class="ff1 ls3d ws164">函数被用来从缓冲中解包一个值，省去了额外的分片或复制操</span></div><div class="t m0 x5 h9 y16a3 ff1 fs3 fc0 sc0 ls0">作步骤。</div><div class="t m0 x0 h9 y16a4 ff6 fs3 fc0 sc0 ls0 ws8d7">Structure <span class="ff1 ls16 wsf3">类就是一个基础类<span class="_ _c"></span>，接受字节数据并存储在内部的内存缓冲中<span class="_ _1"></span>，并被<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y16a5 ff6 fs3 fc0 sc0 ls0 ws8d8">StructField <span class="ff1 ws528">描述器使用。这里使用了 </span><span class="ws8d9">memoryview() <span class="ff1 wsa0">，<span class="_ _1"></span>我们会在后面详细讲解它是用</span></span></div><div class="t m0 x5 h9 y16a6 ff1 fs3 fc0 sc0 ls0">来干嘛的。</div><div class="t m0 x0 h9 y16a7 ff1 fs3 fc0 sc0 ls3a ws153">使用这个代码，你现在就能定义一个高层次的结构对象来表示上面表格信息所期望</div><div class="t m0 x5 h9 y16a8 ff1 fs3 fc0 sc0 ls0">的文件格式。例如：</div><div class="t m0 x5 hf y16a9 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PolyHeader<span class="ff8 fc0">(Structure):</span></span></div><div class="t m0 x15 hf y16aa ff8 fs5 fc0 sc0 ls0 ws16e">file_code <span class="fc6 ls33">=</span><span class="ws13a">StructField(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;i<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">0</span>)</span></div><div class="t m0 x15 hf y16ab ff8 fs5 fc0 sc0 ls0 ws15f">min_x <span class="fc6 ls33">=</span><span class="ws13a">StructField(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;d<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,<span class="fc7 ls34">4</span></span>)</span></div><div class="t m0 x15 hf y16ac ff8 fs5 fc0 sc0 ls0 ws15f">min_y <span class="fc6 ls33">=</span><span class="ws13a">StructField(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;d<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">12</span>)</span></div><div class="t m0 x15 hf y16ad ff8 fs5 fc0 sc0 ls0 ws15f">max_x <span class="fc6 ls33">=</span><span class="ws13a">StructField(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;d<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">20</span>)</span></div><div class="t m0 x15 hf y16ae ff8 fs5 fc0 sc0 ls0 ws15f">max_y <span class="fc6 ls33">=</span><span class="ws13a">StructField(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;d<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">28</span>)</span></div><div class="t m0 x15 hf y16af ff8 fs5 fc0 sc0 ls0 ws16e">num_polys <span class="fc6 ls33">=</span><span class="ws13a">StructField(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;i<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">36</span>)</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">8.12.<span class="_ _5"> </span>6.12 <span class="ff1 ws6e7">读取嵌套和可变长二进制数据 </span>198</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
