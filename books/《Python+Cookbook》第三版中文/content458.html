<div id="pf1ca" class="pf w0 h0" data-page-no="1ca"><div class="pc pc1ca w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ca.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y15f ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 hf y160 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x5 h11 y957 ffa fs5 fcd sc0 ls0 ws4"># Object that signals shutdown</div><div class="t m0 x5 hf y958 ff8 fs5 fc0 sc0 ls0 ws16e">_sentinel <span class="fc6 ls33">=</span><span class="fca ws13a">object</span>()</div><div class="t m0 x5 h11 y95a ffa fs5 fcd sc0 ls0 ws4"># A thread that produces data</div><div class="t m0 x5 hf y95b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">producer<span class="fc0">(out_q):</span></span></div><div class="t m0 x15 hf y95c ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0">running:</span></div><div class="t m0 x16 h11 y9f3 ffa fs5 fcd sc0 ls0 ws4"># Produce some data</div><div class="t m0 x16 hf y9f4 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf y95d ff8 fs5 fc0 sc0 ls0 ws13a">out_q<span class="fc6 ls34">.</span>put(data)</div><div class="t m0 x15 h11 ybb7 ffa fs5 fcd sc0 ls0 ws4"># Put the sentinel on the queue to indicate completion</div><div class="t m0 x15 hf ybb8 ff8 fs5 fc0 sc0 ls0 ws13a">out_q<span class="fc6">.</span>put(_sentinel)</div><div class="t m0 x5 h11 ybba ffa fs5 fcd sc0 ls0 ws4"># A thread that consumes data</div><div class="t m0 x5 hf ybbb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(in_q):</span></span></div><div class="t m0 x15 hf ybbc ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 h11 ybbd ffa fs5 fcd sc0 ls0 ws4"># Get some data</div><div class="t m0 x16 hf ybbe ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="ws13a">in_q<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x16 h11 ybc0 ffa fs5 fcd sc0 ls0 ws4"># Check for termination</div><div class="t m0 x16 hf ybc1 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">data </span>is <span class="ff8 fc0">_sentinel:</span></div><div class="t m0 x17 hf y2e16 ff8 fs5 fc0 sc0 ls0 ws13a">in_q<span class="fc6">.</span>put(_sentinel)</div><div class="t m0 x17 h10 y2e17 ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x16 h11 y2e18 ffa fs5 fcd sc0 ls0 ws4"># Process the data</div><div class="t m0 x16 hf y2e19 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x0 h9 y2e1a ff1 fs3 fc0 sc0 ls63 ws21f">本例中有一个特殊的地方<span class="_ _c"></span>：消费者在读到这个特殊值之后立即又把它放回到队列<span class="_ _1"></span></div><div class="t m0 x5 h9 y2e1b ff1 fs3 fc0 sc0 ls1e ws111">中<span class="_ _1"></span>，将之传递下去。这样<span class="_ _c"></span>，所有监听这个队列的消费者线程就可以<span class="_ _6"></span>全部关闭了<span class="_ _1"></span>。尽管</div><div class="t m0 x5 h9 y2e1c ff1 fs3 fc0 sc0 ls2d ws132">队列是最常见的线程间通信机制，但是仍然可以自己通过创建自己的数据结构并添加<span class="_ _1"></span></div><div class="t m0 x5 h9 y68a ff1 fs3 fc0 sc0 ls17 ws1091">所需的锁和同步机制来实现线程间通信。最常见的方法是使用 <span class="ff6 ls0 ws396">Condition </span><span class="wsf6">变量来包装<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y2e1d ff1 fs3 fc0 sc0 ls0 ws1092">你的数据结构。<span class="_ _c"></span>下边这个例子演示了如何创建一个线程安全的优先级队列，<span class="_ _1"></span>如同 <span class="ff4 ws1093">1.5 </span>节</div><div class="t m0 x5 h9 y2e1e ff1 fs3 fc0 sc0 ls0">中介绍的那样。</div><div class="t m0 x5 h10 y2e1f ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">heapq</span></div><div class="t m0 x5 h10 y2e20 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">threading</span></div><div class="t m0 x5 hf y2e21 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PriorityQueue<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2e22 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y2e23 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_queue </span><span class="ls32">=</span><span class="fc0">[]</span></span></div><div class="t m0 x16 hf y2e24 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_count </span><span class="ls32">=</span><span class="fc7">0</span></span></div><div class="t m0 x16 hf y2e25 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws158">_cv </span><span class="ls33">=</span><span class="fc0">threading</span><span class="ls34">.</span><span class="fc0">Condition()</span></span></div><div class="t m0 x15 hf y2e26 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">put<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, item, priority):</span></span></span></div><div class="t m0 x16 hf y1e12 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_cv:</span></span></div><div class="t m0 x17 hf y2e27 ff8 fs5 fc0 sc0 ls0 ws13a">heapq<span class="fc6 ls34">.</span>heappush(<span class="fca">self<span class="fc6">.</span></span><span class="ws4">_queue, (<span class="fc6 ls34">-</span><span class="ws16e">priority, </span></span><span class="fca">self<span class="fc6">.</span></span><span class="ws4">_count, item))</span></div><div class="t m0 x17 hf y1dec ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws145">_count </span><span class="ws1a1">+= <span class="fc7">1</span></span></span></div><div class="t m0 x17 hf y1ded ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_cv</span>.<span class="fc0">notify()</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.3.<span class="_ _36"> </span>12.3 <span class="ff1 ws1090">线程间通信 </span>449</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
