<div id="pf9b" class="pf w0 h0" data-page-no="9b"><div class="pc pc9b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg9b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y181 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">partial</span></span></div><div class="t m0 x5 hf y183 ff8 fs5 fc0 sc0 ls0 ws208">RECORD_SIZE <span class="fc6 ls32">=</span><span class="fc7">32</span></div><div class="t m0 x5 hf y185 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">somefile.data<span class="ff9 ls34">&apos;</span></span><span class="ls33">,</span><span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">rb<span class="ff9 ls34">&apos;</span></span><span class="ls32">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x15 hf y186 ff8 fs5 fc0 sc0 ls0 ws155">records <span class="fc6 ls32">=</span><span class="fca ws13a">iter<span class="fc0">(partial(f<span class="fc6 ls34">.</span><span class="ws4">read, RECORD_SIZE), b<span class="ff9 fc9 ls34">&apos;&apos;</span>)</span></span></span></div><div class="t m0 x15 hf y187 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">r</span><span class="ws157">in <span class="ff8 fc0">records:</span></span></div><div class="t m0 x16 hf y188 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x0 h9 y10fe ff1 fs3 fc0 sc0 ls0 ws306">这<span class="_ _6"></span>个<span class="_ _6"></span>例<span class="_ _6"></span>子<span class="_ _6"></span>中<span class="_ _6"></span>的 <span class="ff6 ws307">records </span><span class="ls14 ws174">对象是一个可迭代对象<span class="_ _1"></span>，它会不断的产生固定大小的数据<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y10ff ff1 fs3 fc0 sc0 ls1e ws111">块<span class="_ _1"></span>，直到文件末尾。要注意的是如果<span class="_ _1"></span>总记录大小不是块大小的整数倍的话，最后<span class="_ _1"></span>一个</div><div class="t m0 x5 h9 y1100 ff1 fs3 fc0 sc0 ls0">返回元素的字节数会比期望值少。</div><div class="t m0 x5 he y1101 ff2 fs2 fc4 sc0 ls0 ws135">7.8.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y1102 ff6 fs3 fc0 sc0 ls0 ws68f">iter() <span class="ff1 ls2d ws132">函数有一个鲜为人知的特性就是<span class="_ _1"></span>，如果你给它传递一个可调用对象和一个</span></div><div class="t m0 x5 h9 y1103 ff1 fs3 fc0 sc0 ls13 wse5">标记值<span class="_ _1"></span>，它会创建一个迭代器。这个迭代器会一直调用传入的可调用对象直到它返回<span class="_ _c"></span></div><div class="t m0 x5 h9 y1104 ff1 fs3 fc0 sc0 ls0">标记值为止，这时候迭代终止。</div><div class="t m0 x0 h9 y754 ff1 fs3 fc0 sc0 ls0 ws690">在<span class="_ _6"></span>例<span class="_ _6"></span>子中， <span class="ff6 ws194">functools.partial </span><span class="ls48 ws242">用来创建一个每次被调用时从文件中读取固定数</span></div><div class="t m0 x5 h9 y1105 ff1 fs3 fc0 sc0 ls0 ws38">目字节的可调用对象。标记值 <span class="ff6 ws15e">b&apos;&apos; </span>就是当到达文件结尾时的返回值。</div><div class="t m0 x0 h9 y1106 ff1 fs3 fc0 sc0 ls3a ws153">最后再提一点，上面的例子中的文件时以二进制模式打开的。如果是读取固定大小</div><div class="t m0 x5 h7 yc71 ff1 fs3 fc0 sc0 lsf ws691">的记录<span class="_ _c"></span>，这通常是最普遍的情况。而对于文本文件<span class="_ _c"></span>，一行一行的读取 <span class="ff4 ls1b">(</span><span class="ls0 wsa0">默<span class="_ _6"></span>认<span class="_ _6"></span>的<span class="_ _6"></span>迭<span class="_ _6"></span>代<span class="_ _0"></span>行</span></div><div class="t m0 x5 h7 y1107 ff1 fs3 fc0 sc0 lsb">为<span class="ff4 ls6a">)</span><span class="ls0">更普遍点。</span></div><div class="t m0 x5 hd y1108 ff2 fs4 fc4 sc0 ls0 ws134">7.9<span class="_ _e"> </span>5.9 <span class="ff1">读取二进制数据到可变缓冲区中</span></div><div class="t m0 x5 he y1109 ff2 fs2 fc4 sc0 ls0 ws135">7.9.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y110a ff1 fs3 fc0 sc0 ls30 ws138">你想直接读取二进制数据到一个可变缓冲区中，而不需要做任何的中间复制操作<span class="_ _c"></span>。</div><div class="t m0 x5 h9 y110b ff1 fs3 fc0 sc0 ls0">或者你想原地修改数据并将它写回到一个文件中去。</div><div class="t m0 x5 he y110c ff2 fs2 fc4 sc0 ls0 ws135">7.9.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y110d ff1 fs3 fc0 sc0 ls0 ws14">为了读取数据到一个可变数组中，使用文件对象的 <span class="ff6 ws2d1">readinto() </span>方法。比如：</div><div class="t m0 x5 h10 y110e ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">os.path</span></div><div class="t m0 x5 hf y110f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">read_into_buffer<span class="fc0">(filename):</span></span></div><div class="t m0 x15 hf y1110 ff8 fs5 fc0 sc0 ls0 ws158">buf <span class="fc6 ls32">=</span><span class="fca ws13a">bytearray<span class="fc0">(os<span class="fc6 ls34">.</span>path<span class="fc6">.</span>getsize(filename))</span></span></div><div class="t m0 x15 hf y1111 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws2a3">(filename, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ws13b">&apos;</span><span class="fc0 ls33">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y1112 ff8 fs5 fc0 sc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">readinto(buf)</span></span></div><div class="t m0 x15 hf y1113 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">buf</span></div><div class="t m0 x0 h9 y1114 ff1 fs3 fc0 sc0 ls0">下面是一个演示这个函数使用方法的例子：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws13e">7.9.<span class="_ _5"> </span>5.9 <span class="ff1 ws658">读取二进制数据到可变缓冲区中 </span>146</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
