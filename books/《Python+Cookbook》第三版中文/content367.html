<div id="pf16f" class="pf w0 h0" data-page-no="16f"><div class="pc pc16f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg16f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1e8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">top <span class="fc6 ls32">=</span><span class="ws13a">ast<span class="fc6 ls34">.</span>parse(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">for i in range(10): print(i)</span>&apos;</span><span class="ws4">, mode</span><span class="fc6">=<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">exec<span class="ff9 ls34">&apos;</span></span></span>)</span></span></div><div class="t m0 x5 hf y1e9 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">top</span></div><div class="t m0 x5 hf y1ea ff8 fs5 fc8 sc0 ls0 ws4">&lt;_ast.Module object at 0x100747390&gt;</div><div class="t m0 x5 hf y903 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">ast<span class="fc6 ls34">.</span>dump(top)</span></div><div class="t m0 x5 hf y1eb ff8 fs5 fc8 sc0 ls0 ws13a">&quot;Module(body=[For(target=Name(id=<span class="ff9 ls34">&apos;</span>i<span class="ff9 ls34">&apos;</span><span class="ws4">, ctx=Store()),</span></div><div class="t m0 x5 hf y1ec ff8 fs5 fc8 sc0 ls0 ws13a">iter=Call(func=Name(id=<span class="ff9 ws13b">&apos;</span>range<span class="ff9 ls34">&apos;</span><span class="ws13b">, ctx=Load()), args=[Num(n=10)],</span></div><div class="t m0 x5 hf y904 ff8 fs5 fc8 sc0 ls0 ws4">keywords=[], starargs=None, kwargs=None),</div><div class="t m0 x5 hf y905 ff8 fs5 fc8 sc0 ls0 ws13a">body=[Expr(value=Call(func=Name(id=<span class="ff9 ls34">&apos;</span>print<span class="ff9 ls34">&apos;</span><span class="ws13b">, ctx=Load()),</span></div><div class="t m0 x5 hf y906 ff8 fs5 fc8 sc0 ls0 ws13a">args=[Name(id=<span class="ff9 ls34">&apos;<span class="ff8">i</span><span class="ls0 ws13b">&apos;</span></span><span class="ws4">, ctx=Load())], keywords=[], starargs=None,</span></div><div class="t m0 x5 hf y907 ff8 fs5 fc8 sc0 ls0 ws4">kwargs=None))], orelse=[])])&quot;</div><div class="t m0 x5 hf y908 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y2616 ff1 fs3 fc0 sc0 lsaa wscdc">分析源码树需要你自己更多的学习<span class="_ _8"></span>，它是<span class="_ _6"></span>由一系列 <span class="ff4 ls0 wscdd">AST </span><span class="ws3e4">节点组成的<span class="_ _8"></span>。分析这<span class="_ _d"></span></span></div><div class="t m0 x5 h9 y2617 ff1 fs3 fc0 sc0 ls1ab wscde">些节点最简单的方法就是定义一个访问者类<span class="_ _19"></span>，实现很多 <span class="ff6 ls0 ws149">visit NodeName()<span class="_ _26"> </span><span class="ff1 wsa0">方<span class="_ _12"></span>法，</span></span></div><div class="t m0 x5 h9 y2618 ff6 fs3 fc0 sc0 ls0 wscdf">NodeName() <span class="ff1 ls6f ws2a7">匹配那些你感兴趣的节点<span class="_ _1"></span>。下面是这样一个类<span class="_ _1"></span>，记录了哪些名字被加载<span class="_ _1"></span>、<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2619 ff1 fs3 fc0 sc0 ls0">存储和删除的信息。</div><div class="t m0 x5 h10 yd68 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">ast</span></div><div class="t m0 x5 hf yd6a ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">CodeAnalyzer<span class="ff8 fc0 ws13a">(ast<span class="fc6 ls34">.</span>NodeVisitor):</span></span></div><div class="t m0 x15 hf y261a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y261b ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">loaded </span><span class="ls32">=</span></span>set<span class="fc0">()</span></div><div class="t m0 x16 hf y13af ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">stored </span><span class="ls32">=</span></span>set<span class="fc0">()</span></div><div class="t m0 x16 hf y13b0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">deleted </span><span class="ls33">=</span></span>set<span class="fc0">()</span></div><div class="t m0 x15 hf y13b2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Name<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y13b3 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">isinstance<span class="fc0">(node<span class="fc6 ls34">.</span><span class="ws13b">ctx, ast<span class="fc6 ls34">.</span>Load):</span></span></span></div><div class="t m0 x17 hf y261c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">loaded</span>.<span class="fc0">add(node</span><span class="ls34">.</span><span class="fc0">id)</span></span></div><div class="t m0 x16 hf y261d ff7 fs5 fca sc0 ls0 ws218">elif <span class="ff8 ws13a">isinstance<span class="fc0">(node<span class="fc6 ls34">.</span><span class="ws4">ctx, ast<span class="fc6 ls34">.</span>Store):</span></span></span></div><div class="t m0 x17 hf y261e ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">stored</span>.<span class="fc0">add(node</span><span class="ls34">.</span><span class="fc0">id)</span></span></div><div class="t m0 x16 hf y261f ff7 fs5 fca sc0 ls0 ws218">elif <span class="ff8 ws13a">isinstance<span class="fc0">(node<span class="fc6 ls34">.</span><span class="ws4">ctx, ast<span class="fc6 ls34">.</span>Del):</span></span></span></div><div class="t m0 x17 hf y2620 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">deleted</span><span class="ls34">.</span><span class="fc0">add(node</span><span class="ls34">.</span><span class="fc0">id)</span></span></div><div class="t m0 x5 h11 y2621 ffa fs5 fcd sc0 ls0 ws4"># Sample usage</div><div class="t m0 x5 hf y2622 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 h11 y2623 ffa fs5 fcd sc0 ls0 ws4"># Some Python code</div><div class="t m0 x15 hf y2624 ff8 fs5 fc0 sc0 ls0 ws13c">code <span class="fc6 ls32">=</span><span class="ff9 fc9">&apos;&apos;&apos;</span></div><div class="t m0 x15 hf y2625 ff8 fs5 fc9 sc0 ls0 ws4">for i in range(10):</div><div class="t m0 x16 hf y2626 ff8 fs5 fc9 sc0 ls0">print(i)</div><div class="t m0 x15 hf y2627 ff8 fs5 fc9 sc0 ls0 ws13b">del i</div><div class="t m0 x15 h15 y2628 ff9 fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2629 ffa fs5 fcd sc0 ls0 ws4"># Parse into an AST</div><div class="t m0 x15 hf y262a ff8 fs5 fc0 sc0 ls0 ws158">top <span class="fc6 ls32">=</span><span class="ws13a">ast<span class="fc6 ls34">.</span><span class="ws4">parse(code, mode<span class="fc6 ls34">=</span><span class="ff9 fc9 ws13b">&apos;</span></span><span class="fc9">exec<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 h11 y262b ffa fs5 fcd sc0 ls0 ws4"># Feed the AST to analyze name usage</div><div class="t m0 x15 hf y262c ff8 fs5 fc0 sc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0">CodeAnalyzer()</span></div><div class="t m0 x15 hf y262d ff8 fs5 fc0 sc0 ls34">c<span class="fc6 ls0 ws13a">.<span class="fc0">visit(top)</span></span></div><div class="t m0 x15 hf y262e ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Loaded:<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, c<span class="fc6 ls34">.</span>loaded)</span></span></div><div class="t m0 x15 hf y262f ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Stored:<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, c<span class="fc6 ls34">.</span>stored)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.24.<span class="_ _5"> </span>9.24 <span class="ff1 ws7da">解析与分析 </span><span class="wscda">Python <span class="ff1 wscdb">源码 </span>358</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
