<div id="pf1bb" class="pf w0 h0" data-page-no="1bb"><div class="pc pc1bb w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1bb.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6">.</span><span class="ws4">AF_UNIX, socket<span class="fc6 ls34">.</span>SOCK_STREAM)</span></span></div><div class="t m0 x15 hf y1ac ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>connect(server_address)</div><div class="t m0 x15 hf y1ad ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y1ae ff8 fs5 fc0 sc0 ls0 ws159">fd <span class="fc6 ls32">=</span>recv_fd(serv)</div><div class="t m0 x16 hf y1af ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">WORKER: GOT FD</span>&apos;</span><span class="ls0 ws13b">, fd)</span></span></div><div class="t m0 x16 hf y1b0 ff7 fs5 fca sc0 ls0 ws218">with <span class="ff8 fc0 ws13a">socket<span class="fc6 ls34">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws13b">AF_INET, socket</span><span class="fc6">.</span><span class="ws4">SOCK_STREAM, fileno<span class="fc6 ls34">=</span><span class="ws158">fd) </span></span></span><span class="ws157">as <span class="ff8 fc0">client:</span></span></div><div class="t m0 x17 hf y355 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 hf y410 ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ws13a">client<span class="fc6 ls34">.</span>recv(<span class="fc7">1024</span>)</span></div><div class="t m0 x18 hf y411 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">msg:</span></div><div class="t m0 x29 h10 yba ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x18 hf y8c6 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">WORKER: RECV {!r}</span>&apos;</span><span class="fc6">.</span><span class="ls0">format(msg))</span></span></div><div class="t m0 x18 hf ybed ff8 fs5 fc0 sc0 ls0 ws13a">client<span class="fc6 ls34">.</span>send(msg)</div><div class="t m0 x5 hf ybef ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 h10 ybf0 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x15 hf yd7d ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">len<span class="fc0">(sys<span class="fc6 ls34">.</span><span class="ws15f">argv) <span class="fc6 ws159">!= <span class="fc7 ls34">2</span></span>:</span></span></span></div><div class="t m0 x16 hf ybf1 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Usage: worker.py server_address</span>&apos;</span><span class="ls33">,</span></span><span class="ff8 ws13a">file<span class="fc6">=<span class="fc0">sys</span><span class="ls34">.</span><span class="fc0">stderr)</span></span></span></div><div class="t m0 x16 hf ybf2 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf ybf4 ff8 fs5 fc0 sc0 ls0 ws13a">worker(sys<span class="fc6 ls34">.</span>argv[<span class="fc7">1</span>])</div><div class="t m0 x0 h9 y2cd6 ff1 fs3 fc0 sc0 ls6d ws2a0">如果你想在你的程序中传递文件描述符<span class="_ _8"></span>，建议你参阅其他一些更加高级的文<span class="_ _8"></span></div><div class="t m0 x5 h9 y2cd7 ff1 fs3 fc0 sc0 ls0 ws101f">档，<span class="_ _0"></span>比<span class="_ _0"></span>如 <span class="ff6 ws1020">Unix Network Programming by W. Richard Stevens (Prentice Hall,</span></div><div class="t m0 x5 h7 y2cd8 ff6 fs3 fc0 sc0 ls0 ws1021">1990) <span class="ff4 ls1f3">.<span class="ff1 ls1f4">在</span><span class="ls0 ws1022">Windo<span class="_ _1"></span>ws <span class="ff1 ls1f5 ws1023">上传递文件描述符跟 </span><span class="ws1024">Unix <span class="ff1 ls1f5 ws1025">是不一样的<span class="_ _1d"></span>，建议你研究下<span class="_ _1d"></span></span></span></span></span></div><div class="t m0 x5 h9 y2cd9 ff6 fs3 fc0 sc0 ls0 ws1026">multiprocessing.reduction <span class="ff1">中的源代码看看其工作原理。</span></div><div class="t m0 x5 hd y2cda ff2 fs4 fc4 sc0 ls0 wsd91">13.12<span class="_ _e"> </span>11.12 <span class="ff1 ws357">理解事件驱动的 </span>IO</div><div class="t m0 x5 he y2cdb ff2 fs2 fc4 sc0 ls0 wsadf">13.12.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y115a ff1 fs3 fc0 sc0 ls40 ws1027">你应该已经听过基于事件驱动或异步 <span class="ff4 ls0 ws39b">I/O </span><span class="ws180">的包，但是你还不能完全理解它的底层<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y2cdc ff1 fs3 fc0 sc0 ls0">到底是怎样工作的，或者是如果使用它的话会对你的程序产生什么影响。</div><div class="t m0 x5 he y2cdd ff2 fs2 fc4 sc0 ls0 wsadf">13.12.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y2cde ff1 fs3 fc0 sc0 ls12 ws1028">事件驱动 <span class="ff4 ls0 ws1029">I/O </span><span class="ws102a">本质上来讲就是将基本 <span class="ff4 ls0 ws1029">I/<span class="_ _6"></span>O <span class="ff1 wsa0">操作<span class="_ _6"></span>（比<span class="_ _6"></span>如读<span class="_ _6"></span>和<span class="_ _6"></span>写）转<span class="_ _6"></span>化为<span class="_ _6"></span>你<span class="_ _6"></span>程序<span class="_ _6"></span>需要</span></span></span></div><div class="t m0 x5 h7 y29d7 ff1 fs3 fc0 sc0 ls0 ws102b">处理的事件。<span class="_ _c"></span>例如，当数据在某个 <span class="ff4 ws102c">sock<span class="_ _c"></span>et <span class="ff1 ws102d">上被接受后，<span class="_ _1"></span>它会转换成一个 <span class="ff6 ws102e">receive </span>事件，</span></span></div><div class="t m0 x5 h9 y2cdf ff1 fs3 fc0 sc0 ls13 wse5">然后被你定义的回调方法或函数来处理<span class="_ _1"></span>。作为一个可能的起始点，一个事件驱动的框<span class="_ _c"></span></div><div class="t m0 x5 h9 y2ce0 ff1 fs3 fc0 sc0 ls0">架可能会以一个实现了一系列基本事件处理器方法的基类开始：</div><div class="t m0 x5 hf y2ce1 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">EventHandler<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2ce2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">fileno<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y2ce3 ff9 fs5 fc9 sc0 ls34">&apos;<span class="ff8 ls0 ws4">Return the associated file descriptor<span class="ff9">&apos;</span></span></div><div class="t m0 x16 hf y2ce4 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">NotImplemented<span class="fc0 ls34">(<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13b">must implement<span class="ff9 ls34">&apos;</span><span class="fc0">)</span></span></span></div><div class="t m0 x15 hf y2273 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wants_to_receive<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.12.<span class="_ _36"> </span>11.12 <span class="ff1 ws36c">理解事件驱动的 </span><span class="ws102f">IO 434</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
