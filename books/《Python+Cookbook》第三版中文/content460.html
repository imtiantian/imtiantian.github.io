<div id="pf1cc" class="pf w0 h0" data-page-no="1cc"><div class="pc pc1cc w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1cc.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 h11 y181 ffa fs5 fcd sc0 ls0 ws4"># Produce some data</div><div class="t m0 x16 hf y182 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 h11 y183 ffa fs5 fcd sc0 ls0 ws4"># Make an (data, event) pair and hand it to the consumer</div><div class="t m0 x16 hf y184 ff8 fs5 fc0 sc0 ls0 ws158">evt <span class="fc6 ls32">=</span>Event()</div><div class="t m0 x16 hf y185 ff8 fs5 fc0 sc0 ls0 ws13a">out_q<span class="fc6 ls34">.</span><span class="ws4">put((data, evt))</span></div><div class="t m0 x16 hf y186 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 h11 y187 ffa fs5 fcd sc0 ls0 ws4"># Wait for the consumer to process the item</div><div class="t m0 x16 hf y188 ff8 fs5 fc0 sc0 ls0 ws13a">evt<span class="fc6 ls34">.</span>wait()</div><div class="t m0 x5 h11 y98f ffa fs5 fcd sc0 ls0 ws4"># A thread that consumes data</div><div class="t m0 x5 hf y990 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(in_q):</span></span></div><div class="t m0 x15 hf y991 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 h11 y992 ffa fs5 fcd sc0 ls0 ws4"># Get some data</div><div class="t m0 x16 hf y993 ff8 fs5 fc0 sc0 ls0 ws13b">data, evt <span class="fc6 ls33">=</span><span class="ws13a">in_q<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x16 h11 ya70 ffa fs5 fcd sc0 ls0 ws4"># Process the data</div><div class="t m0 x16 hf y994 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 h11 y995 ffa fs5 fcd sc0 ls0 ws13b"># Indicate completion</div><div class="t m0 x16 hf y996 ff8 fs5 fc0 sc0 ls0 ws13a">evt<span class="fc6 ls34">.</span>set()</div><div class="t m0 x5 he y2e41 ff2 fs2 fc4 sc0 ls0 ws212">14.3.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2c2f ff1 fs3 fc0 sc0 ls3a ws153">基于简单队列编写多线程程序在多数情况下是一个比较明智的选择。从线程安全队</div><div class="t m0 x5 h9 y2e42 ff1 fs3 fc0 sc0 ls13 wse5">列的底层实现来看<span class="_ _1"></span>，你无需在你的代码中使用锁和其他底层的同步机制，这些只会把<span class="_ _c"></span></div><div class="t m0 x5 h9 y2e43 ff1 fs3 fc0 sc0 ls13 wse5">你的程序弄得乱七八糟<span class="_ _1"></span>。此外，使用队列这种基于消息的通信机制可以被扩展到更大<span class="_ _c"></span></div><div class="t m0 x5 h9 y2e44 ff1 fs3 fc0 sc0 ls13 wse5">的应用范畴<span class="_ _1"></span>，比如，你可以把你的程序放入多个进程甚至是分布式系统而无需改变底<span class="_ _c"></span></div><div class="t m0 x5 h9 y2e45 ff1 fs3 fc0 sc0 ls13 wse5">层的队列结构<span class="_ _1"></span>。使用线程队列有一个要注意的问题是，向队列中添加数据项时并不会<span class="_ _c"></span></div><div class="t m0 x5 h9 y2e46 ff1 fs3 fc0 sc0 ls13 wse5">复制此数据项<span class="_ _1"></span>，线程间通信实际上是在线程间传递对象引用。如果你担心对象的共享<span class="_ _c"></span></div><div class="t m0 x5 h9 y2e47 ff1 fs3 fc0 sc0 ls40 ws180">状态<span class="_ _1"></span>，那你最好只传递不可修改的数据结构（如<span class="_ _c"></span>：整型、字符串或者元组<span class="_ _c"></span>）或者一个</div><div class="t m0 x5 h9 y2e48 ff1 fs3 fc0 sc0 ls0">对象的深拷贝。例如：</div><div class="t m0 x5 hf y2e49 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws16a">queue </span><span class="ws146">import <span class="ff8 fc0">Queue</span></span></div><div class="t m0 x5 hf y2e4a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x5 h10 y2e4b ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">copy</span></div><div class="t m0 x5 h11 y1811 ffa fs5 fcd sc0 ls0 ws4"># A thread that produces data</div><div class="t m0 x5 hf y2e4c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">producer<span class="fc0">(out_q):</span></span></div><div class="t m0 x15 hf y2e4d ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 h11 y2e4e ffa fs5 fcd sc0 ls0 ws4"># Produce some data</div><div class="t m0 x16 hf y2e4f ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x16 hf y2e50 ff8 fs5 fc0 sc0 ls0 ws13a">out_q<span class="fc6 ls34">.</span>put(copy<span class="fc6 ls34">.</span>deepcopy(data))</div><div class="t m0 x5 h11 y2e51 ffa fs5 fcd sc0 ls0 ws4"># A thread that consumes data</div><div class="t m0 x5 hf y2e52 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">consumer<span class="fc0">(in_q):</span></span></div><div class="t m0 x15 hf y2e53 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 h11 y2e54 ffa fs5 fcd sc0 ls0 ws4"># Get some data</div><div class="t m0 x16 hf y149a ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="ws13a">in_q<span class="fc6 ls34">.</span>get()</span></div><div class="t m0 x16 h11 y149b ffa fs5 fcd sc0 ls0 ws4"># Process the data</div><div class="t m0 x16 hf y149c ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.3.<span class="_ _36"> </span>12.3 <span class="ff1 ws1090">线程间通信 </span>451</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
