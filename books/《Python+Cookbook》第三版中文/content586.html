<div id="pf24a" class="pf w0 h0" data-page-no="24a"><div class="pc pc24a w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg24a.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y3487 ff8 fs5 fc0 sc0 ls0 ws13b">return quot, rem</div><div class="t m0 x5 hf y3489 ff8 fs5 fc0 sc0 ls0 ws4">def avg(double[:] a):</div><div class="t m0 x15 hf y348a ff8 fs5 fc0 sc0 ls0">cdef:</div><div class="t m0 x16 hf y3847 ff8 fs5 fc0 sc0 ls0 ws13b">int sz</div><div class="t m0 x16 hf y3848 ff8 fs5 fc0 sc0 ls0 ws13b">double result</div><div class="t m0 x15 hf y3849 ff8 fs5 fc0 sc0 ls0 ws13b">sz = a.size</div><div class="t m0 x15 hf y384a ff8 fs5 fc0 sc0 ls0 ws13b">with nogil:</div><div class="t m0 x16 hf y384b ff8 fs5 fc0 sc0 ls0 ws4">result = csample.avg(&lt;double *&gt; &amp;a[0], sz)</div><div class="t m0 x15 hf y384c ff8 fs5 fc0 sc0 ls0 ws13b">return result</div><div class="t m0 x5 hf y384d ff8 fs5 fc0 sc0 ls0 ws4"># Destructor for cleaning up Point objects</div><div class="t m0 x5 hf y384e ff8 fs5 fc0 sc0 ls0 ws4">cdef del_Point(object obj):</div><div class="t m0 x15 hf y384f ff8 fs5 fc0 sc0 ls0 ws4">pt = &lt;csample.Point *&gt; PyCapsule_GetPointer(obj,&quot;Point&quot;)</div><div class="t m0 x15 hf y3850 ff8 fs5 fc0 sc0 ls0 ws13b">free(&lt;void *&gt; pt)</div><div class="t m0 x5 hf y3851 ff8 fs5 fc0 sc0 ls0 ws4"># Create a Point object and return as a capsule</div><div class="t m0 x5 hf y3852 ff8 fs5 fc0 sc0 ls0 ws4">def Point(double x,double y):</div><div class="t m0 x15 hf y3853 ff8 fs5 fc0 sc0 ls0 ws13b">cdef csample.Point *p</div><div class="t m0 x15 hf y3854 ff8 fs5 fc0 sc0 ls0 ws4">p = &lt;csample.Point *&gt; malloc(sizeof(csample.Point))</div><div class="t m0 x15 hf y3855 ff8 fs5 fc0 sc0 ls0 ws4">if p == NULL:</div><div class="t m0 x16 hf y11c8 ff8 fs5 fc0 sc0 ls0 ws4">raise MemoryError(&quot;No memory to make a Point&quot;)</div><div class="t m0 x15 hf y3856 ff8 fs5 fc0 sc0 ls0 ws13b">p.x = x</div><div class="t m0 x15 hf y23db ff8 fs5 fc0 sc0 ls0 ws13b">p.y = y</div><div class="t m0 x15 hf y3857 ff8 fs5 fc0 sc0 ls0 ws13b">return PyCapsule_New(&lt;void *&gt;p,&quot;Point&quot;,&lt;PyCapsule_Destructor&gt;del_Point)</div><div class="t m0 x5 hf y3858 ff8 fs5 fc0 sc0 ls0 ws4">def distance(p1, p2):</div><div class="t m0 x15 hf y3859 ff8 fs5 fc0 sc0 ls0 ws4">pt1 = &lt;csample.Point *&gt; PyCapsule_GetPointer(p1,&quot;Point&quot;)</div><div class="t m0 x15 hf y385a ff8 fs5 fc0 sc0 ls0 ws4">pt2 = &lt;csample.Point *&gt; PyCapsule_GetPointer(p2,&quot;Point&quot;)</div><div class="t m0 x15 hf y385b ff8 fs5 fc0 sc0 ls0 ws13b">return csample.distance(pt1,pt2)</div><div class="t m0 x0 h9 y385c ff1 fs3 fc0 sc0 ls0 wsa0">该文件更多的细节部<span class="_ _6"></span>分会在讨论部分详细展开。<span class="_ _6"></span>最后，为了构建扩展模块，<span class="_ _6"></span>像下面</div><div class="t m0 x5 h9 y385d ff1 fs3 fc0 sc0 ls0 ws14">这样创建一个 <span class="ff6 ws1f3">setup.py </span>文件：</div><div class="t m0 x5 hf y385e ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws2dd">distutils.core </span><span class="ws146">import <span class="ff8 fc0">setup</span></span></div><div class="t m0 x5 hf y1c6c ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws14b4">distutils.extension </span><span class="ws146">import <span class="ff8 fc0">Extension</span></span></div><div class="t m0 x5 hf y385f ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws40c">Cython.Distutils </span><span class="ws146">import <span class="ff8 fc0">build_ext</span></span></div><div class="t m0 x5 hf y1c6e ff8 fs5 fc0 sc0 ls0 ws208">ext_modules <span class="fc6 ls32">=</span>[</div><div class="t m0 x15 hf y1c6f ff8 fs5 fc0 sc0 ls0 ws13a">Extension(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">sample<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x52 hf y1c71 ff8 fs5 fc0 sc0 ls34">[<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">sample.pyx</span>&apos;</span><span class="ls0">],</span></div><div class="t m0 x52 hf y1c72 ff8 fs5 fc0 sc0 ls0 ws13a">libraries<span class="fc6">=</span><span class="ls34">[<span class="ff9 fc9">&apos;</span></span><span class="fc9">sample<span class="ff9 ls34">&apos;</span></span>],</div><div class="t m0 x52 hf y1c73 ff8 fs5 fc0 sc0 ls0 ws13a">library_dirs<span class="fc6 ls34">=</span>[<span class="ff9 fc9 ls34">&apos;<span class="ff8">.</span>&apos;</span>])]</div><div class="t m0 x5 hf y3860 ff8 fs5 fc0 sc0 ls0">setup(</div><div class="t m0 x19 hf y3861 ff8 fs5 fc0 sc0 ls0 ws13c">name <span class="fc6 ls33">=</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Sample extension module</span><span class="ls34">&apos;</span></span>,</div><div class="t m0 x19 hf y1a95 ff8 fs5 fc0 sc0 ls0 ws16d">cmdclass <span class="fc6 ls32">=</span><span class="ls34">{<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">build_ext<span class="ff9 ls34">&apos;</span></span><span class="ws4">: build_ext},</span></div><div class="t m0 x19 hf y3862 ff8 fs5 fc0 sc0 ls0 ws208">ext_modules <span class="fc6 ls33">=</span>ext_modules</div><div class="t m0 x5 hf y3863 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.10.<span class="_ _36"> </span>15.10 <span class="ff1 ls7f">用</span><span class="ws747">Cython <span class="ff1 ws16b">包装 </span><span class="ls246">C</span><span class="ff1 ws14a7">代码 </span>577</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
