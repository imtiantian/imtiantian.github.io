<div id="pf7f" class="pf w0 h0" data-page-no="7f"><div class="pc pc7f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg7f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 ws134">6.6<span class="_ _e"> </span>4.6 <span class="ff1">带有外部状态的生成器函数</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 ws135">6.6.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y2b2 ff1 fs3 fc0 sc0 ls0">你想定义一个生成器函数，但是它会调用某个你想暴露给用户使用的外部状态值。</div><div class="t m0 x5 he y2b3 ff2 fs2 fc4 sc0 ls0 ws135">6.6.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y6ef ff1 fs3 fc0 sc0 ls3a ws153">如果你想让你的生成器暴露外部状态给用户，别忘了你可以简单的将它实现为一个</div><div class="t m0 x5 h9 y6f0 ff1 fs3 fc0 sc0 ls0 ws592">类，然后把生成器函数放到 <span class="ff6 ws308">iter<span class="_ _e"> </span>() </span>方法中过去。比如：</div><div class="t m0 x5 hf ye06 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">collections </span><span class="ws146">import <span class="ff8 fc0">deque</span></span></div><div class="t m0 x5 hf ye07 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">linehistory<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf ye08 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, lines, histlen<span class="fc6 ls34">=</span></span><span class="fc7">3</span>):</span></span></div><div class="t m0 x16 hf ye09 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">lines </span><span class="ls32">=</span><span class="fc0">lines</span></span></div><div class="t m0 x16 hf ye0a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">history </span><span class="ls33">=</span><span class="fc0">deque(maxlen</span><span class="ls34">=</span><span class="fc0">histlen)</span></span></div><div class="t m0 x15 hf ye0b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__iter__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf ye0c ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">lineno, line </span><span class="ws157">in <span class="ff8 ws13a">enumerate<span class="fc0 ls34">(</span>self<span class="fc6">.<span class="fc0 ws145">lines, <span class="fc7 ls34">1</span>):</span></span></span></span></div><div class="t m0 x17 hf ye0d ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">history</span><span class="ls34">.</span><span class="fc0 ws4">append((lineno, line))</span></span></div><div class="t m0 x17 hf ye0e ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0">line</span></div><div class="t m0 x15 hf ye0f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">clear<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf ye10 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">history</span>.<span class="fc0">clear()</span></span></div><div class="t m0 x0 h9 ye11 ff1 fs3 fc0 sc0 ls0 wsa0">为了使用这个类，你可<span class="_ _6"></span>以将它当做是一个普通的<span class="_ _6"></span>生成器函数。然而，由于可<span class="_ _6"></span>以创建</div><div class="t m0 x5 h9 ye12 ff1 fs3 fc0 sc0 ls0 ws593">一个实例对象，<span class="_ _c"></span>于是你可以访问内部属性值，比如 <span class="ff6 ws483">history </span><span class="ws594">属性或者是 <span class="ff6 ws595">clear() </span>方法。</span></div><div class="t m0 x5 h9 ye13 ff1 fs3 fc0 sc0 ls0">代码示例如下：</div><div class="t m0 x5 hf ye14 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">somefile.txt<span class="ff9 ws13b">&apos;</span></span><span class="ls33">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x15 hf ye15 ff8 fs5 fc0 sc0 ls0 ws15f">lines <span class="fc6 ls33">=</span>linehistory(f)</div><div class="t m0 x15 hf ye16 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 fc0">lines:</span></span></div><div class="t m0 x16 hf ye17 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">python</span><span class="ls33">&apos;</span></span>in <span class="ff8 fc0">line:</span></div><div class="t m0 x17 hf ye18 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">lineno, hline </span><span class="ws157">in <span class="ff8 fc0 ws13a">lines<span class="fc6">.</span>history:</span></span></div><div class="t m0 x18 hf ye19 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">{}:{}</span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13b">format(lineno, hline), end<span class="fc6 ws13a">=</span></span><span class="ff9 fc9">&apos;&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 he ye1a ff2 fs2 fc4 sc0 ls0 ws135">6.6.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 ye1b ff1 fs3 fc0 sc0 ls56 ws1fa">关于生成器<span class="_ _c"></span>，很容易掉进函数无所不能的陷阱<span class="_ _1"></span>。如果生成器函数需要跟你的程序<span class="_ _1"></span></div><div class="t m0 x5 h7 ye1c ff1 fs3 fc0 sc0 ls0 ws596">其他<span class="_ _6"></span>部<span class="_ _6"></span>分<span class="_ _6"></span>打交<span class="_ _6"></span>道<span class="_ _6"></span>的<span class="_ _6"></span>话 <span class="ff4 wsa5">(</span><span class="wsa0">比如<span class="_ _6"></span>暴<span class="_ _6"></span>露属<span class="_ _6"></span>性<span class="_ _6"></span>值，<span class="_ _6"></span>允许<span class="_ _6"></span>通<span class="_ _6"></span>过方<span class="_ _6"></span>法<span class="_ _6"></span>调<span class="_ _6"></span>用来<span class="_ _6"></span>控<span class="_ _6"></span>制<span class="_ _6"></span>等等<span class="ff4 ls1b">)</span>，<span class="_ _6"></span>可<span class="_ _6"></span>能会<span class="_ _6"></span>导<span class="_ _6"></span>致</span></div><div class="t m0 x5 h9 ye1d ff1 fs3 fc0 sc0 ls18 ws110">你的代码异常的复杂。如果是这种情况的话<span class="_ _1"></span>，可以考虑使用上面介绍的定义类的方式。</div><div class="t m0 x5 h9 y7c8 ff1 fs3 fc0 sc0 lseb">在<span class="ff6 ls0 ws597">iter<span class="_ _e"> </span>() </span><span class="ls6b ws28f">方法中定义你的生成器不会改变你任何的算法逻辑。由于它是类的一部</span></div><div class="t m0 x5 h9 y330 ff1 fs3 fc0 sc0 ls0">分，所以允许你定义各种属性和方法来供用户使用。</div><div class="t m0 x0 h7 ye1e ff1 fs3 fc0 sc0 ls2c ws598">一个需要注意的小地方是，如果你在迭代操作时不使用 <span class="ff4 ls0 ws579">for </span><span class="ws12f">循环语句<span class="_ _1"></span>，那么你得先</span></div><div class="t m0 x5 h9 ye1f ff1 fs3 fc0 sc0 ls0 ws14">调用 <span class="ff6 ws25d">iter() </span>函数。比如：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws13e">6.6.<span class="_ _5"> </span>4.6 <span class="ff1 ws599">带有外部状态的生成器函数 </span>118</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
