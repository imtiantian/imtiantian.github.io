<div id="pf1da" class="pf w0 h0" data-page-no="1da"><div class="pc pc1da w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1da.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h11 y181 ffa fs5 fcd sc0 ls0 ws4"># findrobots.py</div><div class="t m0 x5 h10 y183 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">gzip</span></div><div class="t m0 x5 h10 y184 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">io</span></div><div class="t m0 x5 h10 y185 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">glob</span></div><div class="t m0 x5 hf y187 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_robots<span class="fc0">(filename):</span></span></div><div class="t m0 x15 h15 y188 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y98e ffa fs5 fc9 sc0 ls0 ws4">Find all of the hosts that access robots.txt in a single log file</div><div class="t m0 x15 h15 y98f ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y990 ff8 fs5 fc0 sc0 ls0 ws145">robots <span class="fc6 ls32">=</span><span class="fca ws13a">set</span>()</div><div class="t m0 x15 hf y991 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">gzip<span class="fc6 ls34">.</span><span class="ws169">open(filename) </span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y992 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 fc0 ws13a">io<span class="fc6 ls34">.</span>TextIOWrapper(f,encoding<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">ascii<span class="ff9 ls34">&apos;</span></span>):</span></span></div><div class="t m0 x17 hf y993 ff8 fs5 fc0 sc0 ls0 ws145">fields <span class="fc6 ls32">=</span><span class="ws13a">line<span class="fc6 ls34">.</span>split()</span></div><div class="t m0 x17 hf ya70 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">fields[<span class="fc7 ls34">6</span><span class="ls32">]</span><span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">/robots.txt<span class="ff9 ls34">&apos;</span></span>:</span></div><div class="t m0 x18 hf y994 ff8 fs5 fc0 sc0 ls0 ws13a">robots<span class="fc6 ls34">.</span>add(fields[<span class="fc7">0</span>])</div><div class="t m0 x15 hf y995 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">robots</span></div><div class="t m0 x5 hf y997 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_all_robots<span class="fc0">(logdir):</span></span></div><div class="t m0 x15 h15 y998 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 ya71 ffa fs5 fc9 sc0 ls0 ws4">Find all hosts across and entire sequence of files</div><div class="t m0 x15 h15 y999 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y99a ff8 fs5 fc0 sc0 ls0 ws15f">files <span class="fc6 ls33">=</span><span class="ws13a">glob<span class="fc6">.</span>glob(logdir<span class="fc6 ls34">+<span class="ff9 fc9">&apos;</span></span><span class="fc9">/*.log.gz<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf y99b ff8 fs5 fc0 sc0 ls0 ws2a3">all_robots <span class="fc6 ls32">=</span><span class="fca ws13a">set</span>()</div><div class="t m0 x15 hf y99c ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws145">robots </span><span class="ws157">in <span class="ff8 ws13a">map<span class="fc0 ws4">(find_robots, files):</span></span></span></div><div class="t m0 x16 hf yddb ff8 fs5 fc0 sc0 ls0 ws13a">all_robots<span class="fc6 ls34">.</span>update(robots)</div><div class="t m0 x15 hf y99d ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">all_robots</span></div><div class="t m0 x5 hf y2f64 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y99f ff8 fs5 fc0 sc0 ls0 ws145">robots <span class="fc6 ls32">=</span><span class="ws13a">find_all_robots(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">logs<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x15 hf y9a0 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws145">ipaddr </span><span class="ws157">in <span class="ff8 fc0">robots:</span></span></div><div class="t m0 x16 hf y9a1 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0">(ipaddr)</span></div><div class="t m0 x0 h7 y2f65 ff1 fs3 fc0 sc0 lse ws10ef">前面的程序使用了通常的 <span class="ff4 ls0 ws10f0">map-reduce </span><span class="ws10f1">风格来编写。函数 <span class="ff6 ls0 ws10f2">find robots() <span class="ff1 wsa0">在一<span class="_ _6"></span>个文</span></span></span></div><div class="t m0 x5 h7 y2f66 ff1 fs3 fc0 sc0 ls0 ws10f3">件名集合上做 <span class="ff4 ws10f4">map </span><span class="ws10f5">操作，<span class="_ _19"></span>并将结果汇总为一个单独的结果，<span class="_ _8"></span>也就是 <span class="ff6 ws196">find all robots()</span></span></div><div class="t m0 x5 h7 y2f67 ff1 fs3 fc0 sc0 ls0 ws723">函<span class="_ _6"></span>数中<span class="_ _6"></span>的 <span class="ff6 ws196">all robots </span><span class="ls1e ws67f">集合。现在<span class="_ _1"></span>，假设你想要修改这个程序让它使用多核 <span class="ff4 ls0 wsa5">CPU<span class="ff1 wsa0">。<span class="_ _6"></span>很</span></span></span></div><div class="t m0 x5 h7 y1a74 ff1 fs3 fc0 sc0 ls40 ws10f6">简单—<span class="_ _19"></span>—只需要将 <span class="ff4 ls0 ws10f7">map() </span><span class="ws10f8">操作替换为一个 <span class="ff6 ls0 ws10f9">concurrent.futures </span><span class="ws180">库中生成的类似操作</span></span></div><div class="t m0 x5 h9 y2f68 ff1 fs3 fc0 sc0 ls0">即可。下面是一个简单修改版本：</div><div class="t m0 x5 h11 y2a9c ffa fs5 fcd sc0 ls0 ws4"># findrobots.py</div><div class="t m0 x5 h10 y2a9d ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">gzip</span></div><div class="t m0 x5 h10 y2f69 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">io</span></div><div class="t m0 x5 h10 y2f6a ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">glob</span></div><div class="t m0 x5 hf y2f6b ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscaf">concurrent </span><span class="ws146">import <span class="ff8 fc0">futures</span></span></div><div class="t m0 x5 hf y2f6c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_robots<span class="fc0">(filename):</span></span></div><div class="t m0 x15 h15 y2f6d ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2f6e ffa fs5 fc9 sc0 ls0 ws4">Find all of the hosts that access robots.txt in a single log file</div><div class="t m0 x15 h15 y576 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.8.<span class="_ _36"> </span>12.8 <span class="ff1 ws600">简单的并行编程 </span>465</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
