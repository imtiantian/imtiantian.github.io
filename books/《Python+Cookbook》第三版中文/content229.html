<div id="pfe5" class="pf w0 h0" data-page-no="e5"><div class="pc pce5 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bge5.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h7 y2a ff1 fs3 fc0 sc0 ls0 ws14">得很容易。下面是个简单的 <span class="ff4 ws445">ec<span class="_ _1"></span>ho <span class="ff1">服务器：</span></span></div><div class="t m0 x5 hf y18f8 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws96c">socketserver </span><span class="ws146">import <span class="ff8 fc0 ws4">StreamRequestHandler, TCPServer</span></span></div><div class="t m0 x5 hf y18f9 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">EchoHandler<span class="ff8 fc0">(StreamRequestHandler):</span></span></div><div class="t m0 x15 hf y18fa ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y18fb ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">rfile:</span></span></span></div><div class="t m0 x17 hf y18fc ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">wfile</span><span class="ls34">.</span><span class="fc0">write(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">GOT:<span class="ff9 ls33">&apos;</span></span></span><span class="ls32">+</span><span class="fc0">line)</span></span></div><div class="t m0 x5 hf y18fd ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">15000</span><span class="ws13b">), EchoHandler)</span></span></div><div class="t m0 x5 hf y18fe ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h7 y18ff ff1 fs3 fc0 sc0 ls0 ws96d">不过，<span class="_ _6"></span>假设你<span class="_ _6"></span>想给 <span class="ff4 ws96e">EchoHandler </span><span class="lse ws96f">增加一个可以接受其他配置选项的 </span><span class="ff6 ws970">init </span><span class="wsa0">方法。</span></div><div class="t m0 x5 h9 y1900 ff1 fs3 fc0 sc0 ls0">比如：</div><div class="t m0 x5 hf y1781 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">EchoHandler<span class="ff8 fc0">(StreamRequestHandler):</span></span></div><div class="t m0 x15 h11 y1782 ffa fs5 fcd sc0 ls0 ws4"># ack is added keyword-only argument. *args, **kwargs are</div><div class="t m0 x15 h11 y1783 ffa fs5 fcd sc0 ls0 ws4"># any normal parameters supplied (which are passed on)</div><div class="t m0 x15 hf y1784 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span><span class="ws4">args, ack, <span class="fc6 ls34">**</span>kwargs):</span></span></span></div><div class="t m0 x16 hf y1901 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws158">ack </span><span class="ls33">=</span><span class="fc0">ack</span></span></div><div class="t m0 x16 hf y1902 ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>__init__(<span class="fc6 ls34">*</span><span class="ws15f">args, <span class="fc6 ls34">**</span>kwargs)</span></span></div><div class="t m0 x15 hf y1788 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1789 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">rfile:</span></span></span></div><div class="t m0 x17 hf y178a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">wfile</span><span class="ls34">.</span><span class="fc0">write(</span></span>self<span class="fc6 ls34">.</span><span class="fc0 ws158">ack <span class="fc6 ls32">+</span>line)</span></div><div class="t m0 x0 h7 y1903 ff1 fs3 fc0 sc0 ls1e ws971">这么修改后<span class="_ _1"></span>，我们就不需要显式地在 <span class="ff4 ls0 ws972">TCPServer </span><span class="ws111">类中添加前缀了<span class="_ _c"></span>。但是你再次运</span></div><div class="t m0 x5 h9 y1904 ff1 fs3 fc0 sc0 ls0">行程序后会报类似下面的错误：</div><div class="t m0 x5 hf y1905 ff8 fs5 fca sc0 ls0 ws16e">Exception <span class="fc0 ws4">happened during processing of request </span><span class="ff7 ws15a">from </span><span class="fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">127.0.0.1<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">59834</span>)</span></div><div class="t m0 x5 hf y1906 ff8 fs5 fc0 sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x5 hf y1907 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 hf y18ae ff8 fs5 fca sc0 ls0 ws13a">TypeError<span class="fc0 ws13b">: __init__() missing <span class="fc7 ls32">1</span><span class="ws4">required keyword<span class="fc6 ls34">-</span></span>only argument: <span class="ff9 fc9">&apos;</span></span><span class="fc9">ack<span class="ff9">&apos;</span></span></div><div class="t m0 x0 h9 y1908 ff1 fs3 fc0 sc0 ls2c ws973">初看起来好像很难修正这个错误，除了修改 <span class="ff6 ls0 ws1de">socketserver <span class="ff1 wsa0">模块源<span class="_ _6"></span>代码或<span class="_ _6"></span>者使用<span class="_ _6"></span>某</span></span></div><div class="t m0 x5 h9 y1909 ff1 fs3 fc0 sc0 ls0 ws974">些<span class="_ _6"></span>奇怪<span class="_ _6"></span>的<span class="_ _6"></span>方<span class="_ _6"></span>法<span class="_ _6"></span>之<span class="_ _6"></span>外。但<span class="_ _6"></span>是，<span class="_ _6"></span>如<span class="_ _6"></span>果<span class="_ _6"></span>使<span class="_ _6"></span>用 <span class="ff6 ws975">partial() </span><span class="ws976">就能<span class="_ _6"></span>很<span class="_ _6"></span>轻<span class="_ _6"></span>松<span class="_ _6"></span>的<span class="_ _6"></span>解决<span class="_ _6"></span>—<span class="_ _8"></span>—<span class="_ _6"></span>给<span class="_ _6"></span>它<span class="_ _6"></span>传<span class="_ _6"></span>递 <span class="ff6">ack</span></span></div><div class="t m0 x5 h9 y190a ff1 fs3 fc0 sc0 ls0">参数的值来初始化即可，如下：</div><div class="t m0 x5 hf y190b ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">partial</span></span></div><div class="t m0 x5 hf y190c ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">15000</span><span class="ws13b">), partial(EchoHandler, ack<span class="fc6 ls34">=<span class="fc0">b</span></span><span class="ff9 fc9">&apos;</span></span><span class="fc9">RECEIVED:<span class="ff9 ls34">&apos;</span></span>))</span></div><div class="t m0 x5 hf y165b ff8 fs5 fc0 sc0 ls0 ws13a">serv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h7 y190d ff1 fs3 fc0 sc0 ls0 ws977">在这个例子<span class="_ _6"></span>中， <span class="ff6 ws30b">init<span class="_ _e"> </span>() </span><span class="ls68 ws978">方法中的 </span><span class="ff4 ws979">ac<span class="_ _1"></span>k <span class="ff1 ls68 ws23f">参数声明方式看上去很有趣，其实就是声</span></span></div><div class="t m0 x5 h7 y14cc ff1 fs3 fc0 sc0 ls158">明<span class="ff4 ls0 ws97a">ac<span class="_ _1"></span>k <span class="ff1 ls13 ws97b">为一个强制关键字参数<span class="_ _1"></span>。关于强制关键字参数问题我们在 <span class="ff4 ls0 ws664">7.2 </span><span class="wse5">小节我们已经讨</span></span></span></div><div class="t m0 x5 h9 y190e ff1 fs3 fc0 sc0 ls0">论过了，读者可以再去回顾一下。</div><div class="t m0 x0 h7 y190f ff1 fs3 fc0 sc0 ls0 ws97c">很多<span class="_ _6"></span>时候 <span class="ff6 ws97d">partial() </span><span class="wsa0">能实<span class="_ _6"></span>现的<span class="_ _6"></span>效果，<span class="_ _6"></span><span class="ff4 ws97e">lam<span class="_ _c"></span>b<span class="_ _6"></span>da <span class="ff1 wsa0">表<span class="_ _6"></span>达式<span class="_ _6"></span>也能<span class="_ _6"></span>实现。比<span class="_ _6"></span>如，之<span class="_ _6"></span>前的<span class="_ _6"></span>几个</span></span></span></div><div class="t m0 x5 h9 y12ef ff1 fs3 fc0 sc0 ls0">例子可以使用下面这样的表达式：</div><div class="t m0 x5 hf y1910 ff8 fs5 fc0 sc0 ls0 ws13a">points<span class="fc6 ls34">.</span>sort(key<span class="fc6 ls34">=</span><span class="ff7 fca ws146">lambda </span><span class="ws13b">p: distance(pt, p))</span></div><div class="t m0 x5 hf y1911 ff8 fs5 fc0 sc0 ls34">p<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws4">apply_async(add, (<span class="fc7 ws13a">3</span><span class="ls33">,</span><span class="fc7 ws13a">4</span>), callback</span><span class="fc6">=<span class="ff7 fca ls0 ws146">lambda </span></span><span class="ls0 ws4">result: output_result(result,log))</span></div><div class="t m0 x5 hf y1912 ff8 fs5 fc0 sc0 ls0 ws13c">serv <span class="fc6 ls32">=</span><span class="ws13a">TCPServer((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">15000</span>),</span></div><div class="t m0 x16 hf y1913 ff7 fs5 fca sc0 ls0 ws146">lambda <span class="ff8 fc6 ls34">*<span class="fc0 ls0 ws15f">args, <span class="fc6 ws13a">**</span><span class="ws4">kwargs: EchoHandler(</span></span>*<span class="fc0 ls0 ws13b">args, ack</span>=<span class="fc0">b</span></span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">RECEIVED:</span><span class="ls34">&apos;<span class="ff8 fc0 ls32">,<span class="fc6 ls34">**</span><span class="ls0">kwargs))</span></span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws13e">9.8.<span class="_ _5"> </span>7.8 <span class="ff1 ws599">减少可调用对象的参数个数 </span>220</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
