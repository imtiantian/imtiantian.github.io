<div id="pf151" class="pf w0 h0" data-page-no="151"><div class="pc pc151 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg151.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0">Spam()</span></span></div><div class="t m0 x5 hf y1ac ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a</span><span class="fca ws160">is <span class="ff8 fc0">c</span></span></div><div class="t m0 x5 hf y1ad ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y1ae ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 yffa ff1 fs3 fc0 sc0 ls0 ws38">最后，假设你想创建 <span class="ff4 ws1d0">8.25 </span>小节中那样的缓存实例。下面我们可以通过元类来实现：</div><div class="t m0 x5 h10 y2357 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">weakref</span></div><div class="t m0 x5 hf y2358 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Cached<span class="ff8 fc0 ws13a">(<span class="fca">type</span>):</span></span></div><div class="t m0 x15 hf y2359 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs):</span></span></div><div class="t m0 x16 hf y235a ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>__init__(<span class="fc6 ls34">*</span><span class="ws15f">args, <span class="fc6 ls34">**</span>kwargs)</span></span></div><div class="t m0 x16 hf y235b ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">__cache </span><span class="ls33">=</span><span class="fc0">weakref</span><span class="ls34">.</span><span class="fc0">WeakValueDictionary()</span></span></div><div class="t m0 x15 hf y235c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__call__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span>args):</span></span></div><div class="t m0 x16 hf y235d ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">args </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">__cache:</span></span></span></div><div class="t m0 x17 hf y235e ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">__cache[args]</span></span></span></div><div class="t m0 x16 hf y235f ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y2360 ff8 fs5 fc0 sc0 ls0 ws158">obj <span class="fc6 ls32">=</span><span class="fca ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>__call__(<span class="fc6 ls34">*</span>args)</span></span></div><div class="t m0 x17 hf y2361 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws5a4">__cache[args] </span><span class="ls32">=</span><span class="fc0">obj</span></span></div><div class="t m0 x17 hf y2362 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">obj</span></div><div class="t m0 x5 h11 y2363 ffa fs5 fcd sc0 ls0 ws4"># Example</div><div class="t m0 x5 hf y2364 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam<span class="ff8 fc0 ws13a">(metaclass<span class="fc6">=</span>Cached):</span></span></div><div class="t m0 x15 hf y2365 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name):</span></span></span></div><div class="t m0 x16 hf y2366 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Creating Spam({!r})<span class="ff9">&apos;</span></span></span><span class="fc6">.</span><span class="ls0">format(name))</span></span></div><div class="t m0 x16 hf y2367 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x0 h9 y2368 ff1 fs3 fc0 sc0 ls0">然后我也来测试一下：</div><div class="t m0 x5 hf y2369 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Guido<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y236a ff8 fs5 fc8 sc0 ls0 ws4">Creating Spam(<span class="ff9 ls34">&apos;</span><span class="ws13a">Guido<span class="ff9 ws13b">&apos;</span>)</span></div><div class="t m0 x5 hf y236b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">b<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Diana<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf yc77 ff8 fs5 fc8 sc0 ls0 ws4">Creating Spam(<span class="ff9 ls34">&apos;</span><span class="ws13a">Diana<span class="ff9 ws13b">&apos;</span>)</span></div><div class="t m0 x5 hf y236c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Guido<span class="ff9 ls34">&apos;</span></span></span>)</span><span class="ffa fcd ws13b"># Cached</span></div><div class="t m0 x5 hf y236d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a</span><span class="fca ws160">is <span class="ff8 fc0">b</span></span></div><div class="t m0 x5 hf y236e ff8 fs5 fc8 sc0 ls0">False</div><div class="t m0 x5 hf y9a6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a</span><span class="fca ws160">is <span class="ff8 fc0 ls32">c</span><span class="ffa fcd ws4"># Cached value returned</span></span></div><div class="t m0 x5 hf y9a7 ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y9a8 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y3ed ff2 fs2 fc4 sc0 ls0 wsadf">11.13.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y236f ff1 fs3 fc0 sc0 ls0">利用元类实现多种实例创建模式通常要比不使用元类的方式优雅得多。</div><div class="t m0 x0 h9 y2370 ff1 fs3 fc0 sc0 ls3a ws153">假设你不使用元类，你可能需要将类隐藏在某些工厂函数后面。比如为了实现一个</div><div class="t m0 x5 h9 y2371 ff1 fs3 fc0 sc0 ls0">单例，你你可能会像下面这样写：</div><div class="t m0 x5 hf y574 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">_Spam<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y575 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y576 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Creating Spam</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.13.<span class="_ _5"> </span>9.13 <span class="ff1 wsb03">使用元类控制实例的创建 </span>328</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
