<div id="pf234" class="pf w0 h0" data-page-no="234"><div class="pc pc234 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg234.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls6f ws13c5">在扩展模块底部<span class="_ _c"></span>，<span class="_ _6"></span>你会发现一个函数表<span class="_ _c"></span>，比如本节中的 <span class="ff6 ls0 ws13c6">SampleMethods <span class="ff1 wsa0">表。<span class="_ _6"></span>这<span class="_ _6"></span>个</span></span></div><div class="t m0 x5 h7 y2b ff1 fs3 fc0 sc0 ls0 ws969">表<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>列<span class="_ _6"></span>出 <span class="ff4 ls214">C</span><span class="wsa0">函<span class="_ _6"></span>数、<span class="_ _6"></span><span class="ff4 ws745">Python </span><span class="lsa5 ws3b5">中使用的名字、文档字<span class="_ _1"></span>符串。所有模<span class="_ _1"></span>块都需要指定这个<span class="_ _1"></span></span></span></div><div class="t m0 x5 h9 y2c ff1 fs3 fc0 sc0 ls0">表，因为它在模块初始化时要被使用到。</div><div class="t m0 x0 h9 y99 ff1 fs3 fc0 sc0 lsa8 ws13c7">最后的函数 <span class="ff6 ls0 ws13c8">PyInit sample() </span><span class="ws3de">是模块初始化函数，但该模块第一次被导入时执行<span class="_ _1"></span>。</span></div><div class="t m0 x5 h9 y9a ff1 fs3 fc0 sc0 ls0">这个函数的主要工作是在解释器中注册模块对象。</div><div class="t m0 x0 h7 y30 ff1 fs3 fc0 sc0 ls0 ws1080">最后一个要点需要提出来，使用 <span class="ff4 ls259">C</span><span class="ws6a5">函数来扩展 <span class="ff4 ws347">Python </span><span class="wsa0">要考虑的事情还有很多，<span class="_ _1"></span>本</span></span></div><div class="t m0 x5 h7 y31 ff1 fs3 fc0 sc0 ls0 wsa0">节<span class="_ _6"></span>只是<span class="_ _6"></span>一<span class="_ _6"></span>小<span class="_ _6"></span>部<span class="_ _6"></span>分。<span class="_ _6"></span>（实<span class="_ _6"></span>际<span class="_ _6"></span>上，<span class="_ _6"></span><span class="ff4 wsd0d">C API </span><span class="ws13c9">包<span class="_ _6"></span>含<span class="_ _6"></span>了<span class="_ _6"></span>超过 <span class="ff4 ws13ca">500 </span></span>个<span class="_ _6"></span>函<span class="_ _6"></span>数）<span class="_ _f"></span>。<span class="_ _6"></span>你<span class="_ _6"></span>应<span class="_ _6"></span>该将<span class="_ _6"></span>本<span class="_ _6"></span>节<span class="_ _6"></span>当<span class="_ _6"></span>做<span class="_ _6"></span>是</div><div class="t m0 x5 h9 y32 ff1 fs3 fc0 sc0 ls0 ws13cb">一<span class="_ _6"></span>个<span class="_ _6"></span>入<span class="_ _0"></span>门<span class="_ _6"></span>篇。<span class="_ _6"></span>更<span class="_ _6"></span>多<span class="_ _0"></span>高<span class="_ _6"></span>级<span class="_ _6"></span>内<span class="_ _0"></span>容，<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>看<span class="_ _0"></span>看 <span class="ff6 ws149">PyArg ParseTuple() </span><span class="ls25a">和</span><span class="ff6 ws5f7">Py BuildValue()<span class="_ _18"> </span></span>函</div><div class="t m0 x5 h9 y33 ff1 fs3 fc0 sc0 ls0">数的文档，然后进一步扩展开。</div><div class="t m0 x5 hd y367f ff2 fs4 fc4 sc0 ls0 ws211">17.3<span class="_ _e"> </span>15.3 <span class="ff1">编写扩展函数操作数组</span></div><div class="t m0 x5 he y3680 ff2 fs2 fc4 sc0 ls0 ws212">17.3.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y3681 ff1 fs3 fc0 sc0 ls0 ws13cc">你想编写一个 <span class="ff4 ls25b">C</span><span class="ls3a ws13cd">扩展函数来操作数组，可能是被 </span><span class="ff4 ws13ce">arra<span class="_ _1"></span>y <span class="ff1 ws10ab">模块或类似 </span><span class="ws13cf">Numpy <span class="ff1 wsa0">库所创</span></span></span></div><div class="t m0 x5 h9 y3682 ff1 fs3 fc0 sc0 ls0">建。不过，你想让你的函数更加通用，而不是针对某个特定的库所生成的数组。</div><div class="t m0 x5 he y3683 ff2 fs2 fc4 sc0 ls0 ws212">17.3.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y3684 ff1 fs3 fc0 sc0 ls149 ws13d0">为了能让接受和处理数组具有可移植性<span class="_ _c"></span>，<span class="_ _6"></span>你需要使用到 <span class="ff13 ls0 ws13d1">Buﬀer<span class="_ _18"> </span>Pr<span class="_ _c"></span>oto<span class="_ _c"></span>c<span class="_ _c"></span>ol <span class="ff4 ls25c">.<span class="ff1 ls149 ws937">下面是<span class="_ _c"></span></span></span></span></div><div class="t m0 x5 h7 y3685 ff1 fs3 fc0 sc0 ls6f ws13d2">一个手写的 <span class="ff4 ls214">C</span><span class="ws13d3">扩展函数例子<span class="_ _1"></span>，用来接受数组数据并调用本章开篇部分的 <span class="ff6 ls0">avg(double</span></span></div><div class="t m0 x5 h9 y3686 ff6 fs3 fc0 sc0 ls0 ws4">*buf, int len)<span class="_ _a"> </span><span class="ff1">函数：</span></div><div class="t m0 x5 hf y3522 ff8 fs5 fc0 sc0 ls0 ws4">/* Call double avg(double *, int) */</div><div class="t m0 x5 hf y3523 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_avg(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y3687 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *bufobj;</div><div class="t m0 x19 hf y444 ff8 fs5 fc0 sc0 ls0 ws4">Py_buffer view;</div><div class="t m0 x19 hf y3688 ff8 fs5 fc0 sc0 ls0 ws4">double result;</div><div class="t m0 x19 hf y3689 ff8 fs5 fc0 sc0 ls0 ws4">/* Get the passed Python object */</div><div class="t m0 x19 hf y368a ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;O&quot;, &amp;bufobj)) {</div><div class="t m0 x15 hf y368b ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y368c ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y368d ff8 fs5 fc0 sc0 ls0 ws4">/* Attempt to extract buffer information from it */</div><div class="t m0 x19 hf y368e ff8 fs5 fc0 sc0 ls0 ws4">if (PyObject_GetBuffer(bufobj, &amp;view,</div><div class="t m0 x50 hf y368f ff8 fs5 fc0 sc0 ls0 ws13d4">PyBUF_ANY_CONTIGUOUS <span class="ffd ls215">|</span><span class="ws4">PyBUF_FORMAT) == -1) {</span></div><div class="t m0 x15 hf y3690 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y3691 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3692 ff8 fs5 fc0 sc0 ls0 ws4">if (view.ndim != 1) {</div><div class="t m0 x15 hf y3693 ff8 fs5 fc0 sc0 ls0 ws4">PyErr_SetString(PyExc_TypeError, &quot;Expected a 1-dimensional array&quot;);</div><div class="t m0 x15 hf y3694 ff8 fs5 fc0 sc0 ls0">PyBuffer_Release(&amp;view);</div><div class="t m0 x15 hf y3695 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y3696 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.3.<span class="_ _36"> </span>15.3 <span class="ff1 ws509">编写扩展函数操作数组 </span>555</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
