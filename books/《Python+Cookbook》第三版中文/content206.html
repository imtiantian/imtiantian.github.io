<div id="pfce" class="pf w0 h0" data-page-no="ce"><div class="pc pcce w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgce.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0">紧跟着头部是一系列的多边形记录，编码格式如下：</div><div class="t m0 x5 hf y1666 ff8 fs5 fc0 sc0 ls0">+------+--------+-------------------------------------------+</div><div class="t m0 x5 hf y1667 ffd fs5 fc0 sc0 ls0 ws13b">|<span class="ff8 ws43e">Byte </span><span class="lsbd">|</span><span class="ff8 ws3ac">Type </span><span class="ls14a">|</span><span class="ff8 ws8cd">Description </span>|</div><div class="t m0 x5 hf y1668 ff8 fs5 fc0 sc0 ls0">+======+========+===========================================+</div><div class="t m0 x5 hf y1669 ffd fs5 fc0 sc0 ls0 ws13b">|<span class="ff8 lsa0">0</span><span class="lsbd">|</span><span class="ff8 ws8c8">int </span><span class="ls14a">|</span><span class="ffc fs6 ws3d4">记录长度（</span><span class="ff8 ls32">N</span><span class="ffc fs6 ws8ce">字节） </span>|</div><div class="t m0 x5 hf y166a ff8 fs5 fc0 sc0 ls0">+------+--------+-------------------------------------------+</div><div class="t m0 x5 hf y166b ffd fs5 fc0 sc0 ls0 ws13b">|<span class="ff8 ws8cf">4-N </span><span class="lsbd">|</span><span class="ff8 ws145">Points </span><span class="ls14a">|</span><span class="ff8 ws15f">(X,Y) <span class="ffc fs6 ws8d0">坐标，以浮点数表示 </span></span>|</div><div class="t m0 x5 hf y166c ff8 fs5 fc0 sc0 ls0">+------+--------+-------------------------------------------+</div><div class="t m0 x0 h7 y166d ff1 fs3 fc0 sc0 ls0 ws38">为了写这样的文件，你可以使用如下的 <span class="ff4 ws5c">Python </span>代码：</div><div class="t m0 x5 h10 y166e ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">struct</span></div><div class="t m0 x5 h10 y166f ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">itertools</span></div><div class="t m0 x5 hf yf36 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">write_polys<span class="fc0 ws13b">(filename, polys):</span></span></div><div class="t m0 x15 h11 y1670 ffa fs5 fcd sc0 ls0 ws4"># Determine bounding box</div><div class="t m0 x15 hf y1671 ff8 fs5 fc0 sc0 ls0 ws16e">flattened <span class="fc6 ls33">=</span><span class="fca ws13a">list<span class="fc0">(itertools<span class="fc6 ls34">.</span>chain(<span class="fc6 ls34">*</span>polys))</span></span></div><div class="t m0 x15 hf y1672 ff8 fs5 fc0 sc0 ls0 ws15f">min_x <span class="fc6 ls33">=</span><span class="fca ws13a">min</span><span class="ws159">(x <span class="ff7 fca ws139">for </span><span class="ws4">x, y <span class="ff7 fca ws157">in </span>flattened)</span></span></div><div class="t m0 x15 hf y1673 ff8 fs5 fc0 sc0 ls0 ws15f">max_x <span class="fc6 ls33">=</span><span class="fca ws13a">max</span><span class="ws159">(x <span class="ff7 fca ws139">for </span><span class="ws4">x, y <span class="ff7 fca ws157">in </span>flattened)</span></span></div><div class="t m0 x15 hf y1674 ff8 fs5 fc0 sc0 ls0 ws15f">min_y <span class="fc6 ls33">=</span><span class="fca ws13a">min</span><span class="ws159">(y <span class="ff7 fca ws139">for </span><span class="ws4">x, y <span class="ff7 fca ws157">in </span>flattened)</span></span></div><div class="t m0 x15 hf y1675 ff8 fs5 fc0 sc0 ls0 ws15f">max_y <span class="fc6 ls33">=</span><span class="fca ws13a">max</span><span class="ws159">(y <span class="ff7 fca ws139">for </span><span class="ws4">x, y <span class="ff7 fca ws157">in </span>flattened)</span></span></div><div class="t m0 x15 hf y1676 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws2a3">(filename, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">wb<span class="ff9 ws13b">&apos;</span><span class="fc0 ls33">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y1677 ff8 fs5 fc0 sc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">write(struct</span><span class="ls34">.</span><span class="fc0">pack(</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">&lt;iddddi</span>&apos;</span><span class="ls32">,<span class="fc7 ls0 ws13a">0x1234<span class="fc0">,</span></span></span></div><div class="t m0 x23 hf y1678 ff8 fs5 fc0 sc0 ls0 ws4">min_x, min_y,</div><div class="t m0 x23 hf y1679 ff8 fs5 fc0 sc0 ls0 ws4">max_x, max_y,</div><div class="t m0 x23 hf y167a ff8 fs5 fca sc0 ls0 ws13a">len<span class="fc0">(polys)))</span></div><div class="t m0 x16 hf y167b ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">poly </span><span class="ws160">in <span class="ff8 fc0">polys:</span></span></div><div class="t m0 x17 hf y11e5 ff8 fs5 fc0 sc0 ls0 ws161">size <span class="fc6 ls33">=</span><span class="fca ws13a">len</span><span class="ws145">(poly) <span class="fc6 ls33">*</span><span class="ws13a">struct<span class="fc6 ls34">.</span>calcsize(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;dd<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x17 hf y167c ff8 fs5 fc0 sc0 ls0 ws13a">f<span class="fc6 ls34">.</span>write(struct<span class="fc6 ls34">.</span>pack(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;i<span class="ff9 ls34">&apos;</span></span><span class="ws145">, size <span class="fc6 ls33">+</span></span><span class="fc7">4</span>))</div><div class="t m0 x17 hf y109e ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws159">pt </span><span class="ws157">in <span class="ff8 fc0">poly:</span></span></div><div class="t m0 x18 hf y167d ff8 fs5 fc0 sc0 ls0 ws13a">f<span class="fc6 ls34">.</span>write(struct<span class="fc6 ls34">.</span>pack(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;dd<span class="ff9 ls34">&apos;</span></span><span class="ls32">,<span class="fc6 ls34">*</span></span>pt))</div><div class="t m0 x0 h9 y167e ff1 fs3 fc0 sc0 ls0 ws8d1">将<span class="_ _6"></span>数<span class="_ _6"></span>据<span class="_ _6"></span>读<span class="_ _6"></span>取<span class="_ _6"></span>回<span class="_ _6"></span>来<span class="_ _6"></span>的<span class="_ _6"></span>时<span class="_ _6"></span>候，<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>利<span class="_ _6"></span>用<span class="_ _6"></span>函<span class="_ _6"></span>数 <span class="ff6 ws8d2">struct.unpack() </span><span class="wsa0">，<span class="_ _6"></span>代<span class="_ _6"></span>码很<span class="_ _6"></span>相<span class="_ _6"></span>似，<span class="_ _6"></span>基<span class="_ _6"></span>本<span class="_ _6"></span>就</span></div><div class="t m0 x5 h9 y167f ff1 fs3 fc0 sc0 ls0">是上面写操作的逆序。如下：</div><div class="t m0 x5 hf y1680 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">read_polys<span class="fc0">(filename):</span></span></div><div class="t m0 x15 hf y1681 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws2a3">(filename, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ws13b">&apos;</span><span class="fc0 ls33">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 h11 y1682 ffa fs5 fcd sc0 ls0 ws4"># Read the header</div><div class="t m0 x16 hf y1683 ff8 fs5 fc0 sc0 ls0 ws145">header <span class="fc6 ls32">=</span><span class="ls34">f<span class="fc6">.</span></span><span class="ws13a">read(<span class="fc7">40</span>)</span></div><div class="t m0 x16 hf y1684 ff8 fs5 fc0 sc0 ls0 ws4">file_code, min_x, min_y, max_x, max_y, num_polys <span class="fc6 ls33">=</span>\</div><div class="t m0 x17 hf y1685 ff8 fs5 fc0 sc0 ls0 ws13a">struct<span class="fc6 ls34">.</span>unpack(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;iddddi<span class="ff9 ws13b">&apos;</span></span><span class="ws4">, header)</span></div><div class="t m0 x16 hf y1686 ff8 fs5 fc0 sc0 ls0 ws15f">polys <span class="fc6 ls33">=</span>[]</div><div class="t m0 x16 hf y1687 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0">(num_polys):</span></span></span></div><div class="t m0 x17 hf y1688 ff8 fs5 fc0 sc0 ls0 ws155">pbytes, <span class="fc6 ls32">=</span><span class="ws13a">struct<span class="fc6 ls34">.</span>unpack(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;i<span class="ff9 ls34">&apos;</span></span><span class="ws4">, f<span class="fc6 ls34">.</span></span>read(<span class="fc7">4</span>))</span></div><div class="t m0 x17 hf y1689 ff8 fs5 fc0 sc0 ls0 ws161">poly <span class="fc6 ls33">=</span>[]</div><div class="t m0 x17 hf y168a ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">m</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0 ws155">(pbytes <span class="fc6 ws1a1">// </span></span><span class="fc7">16<span class="fc0">):</span></span></span></span></div><div class="t m0 x18 hf y168b ff8 fs5 fc0 sc0 ls0 ws159">pt <span class="fc6 ls32">=</span><span class="ws13a">struct<span class="fc6">.</span>unpack(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;dd<span class="ff9 ls34">&apos;</span></span><span class="ws4">, f<span class="fc6 ls34">.</span></span>read(<span class="fc7">16</span>))</span></div><div class="t m0 x18 hf y168c ff8 fs5 fc0 sc0 ls0 ws13a">poly<span class="fc6">.</span>append(pt)</div><div class="t m0 x17 hf y168d ff8 fs5 fc0 sc0 ls0 ws13a">polys<span class="fc6 ls34">.</span>append(poly)</div><div class="t m0 x15 hf y168e ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">polys</span></div><div class="t m0 x0 h9 y674 ff1 fs3 fc0 sc0 ls3a ws153">尽管这个代码可以工作，但是里面混杂了很多读取、解包数据结构和其他细节的代</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">8.12.<span class="_ _5"> </span>6.12 <span class="ff1 ws6e7">读取嵌套和可变长二进制数据 </span>197</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
