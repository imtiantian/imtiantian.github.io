<div id="pf12e" class="pf w0 h0" data-page-no="12e"><div class="pc pc12e w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg12e.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y334 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0">root</span></span></div><div class="t m0 x5 hf y335 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0 ws13a">(c1<span class="fc6">.</span>parent)</span></span></div><div class="t m0 x5 hf y336 ff8 fs5 fc8 sc0 ls0">None</div><div class="t m0 x5 hf y337 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y1fc9 ff2 fs2 fc4 sc0 ls0 wsadf">10.23.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y1fca ff1 fs3 fc0 sc0 ls18 wsb71">循环引用的数据结构在 <span class="ff4 ls0 ws453">Python </span><span class="ws110">中是一个很棘手的问题，因为正常的垃圾回收机制<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y1fcb ff1 fs3 fc0 sc0 ls0">不能适用于这种情形。例如考虑如下代码：</div><div class="t m0 x5 h11 y1fcc ffa fs5 fcd sc0 ls0 ws4"># Class just to illustrate when deletion occurs</div><div class="t m0 x5 hf y1fcd ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Data<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y6b9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__del__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y6ba ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Data.__del__<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 h11 y6bc ffa fs5 fcd sc0 ls0 ws4"># Node class involving a cycle</div><div class="t m0 x5 hf y6bd ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Node<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y6be ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y6bf ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">data </span><span class="ls33">=</span><span class="fc0">Data()</span></span></div><div class="t m0 x16 hf y6c0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">parent </span><span class="ls32">=</span></span>None</div><div class="t m0 x16 hf y1fce ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">children </span><span class="ls32">=</span><span class="fc0">[]</span></span></div><div class="t m0 x15 hf y1fcf ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add_child<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, child):</span></span></span></div><div class="t m0 x16 hf y1fd0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">children</span><span class="ls34">.</span><span class="fc0">append(child)</span></span></div><div class="t m0 x16 hf y1fd1 ff8 fs5 fc0 sc0 ls0 ws13a">child<span class="fc6 ls34">.</span><span class="ws145">parent <span class="fc6 ls33">=</span><span class="fca">self</span></span></div><div class="t m0 x0 h9 y1fd2 ff1 fs3 fc0 sc0 ls0">下面我们使用这个代码来做一些垃圾回收试验：</div><div class="t m0 x5 hf y1fd3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0">Data()</span></span></div><div class="t m0 x5 hf y1fd4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0 ls32">a</span><span class="ffa fcd ws4"># Immediately deleted</span></span></div><div class="t m0 x5 hf y1fd5 ff8 fs5 fc8 sc0 ls0">Data.__del__</div><div class="t m0 x5 hf y1fd6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0">Node()</span></span></div><div class="t m0 x5 hf y1fd7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0 ls32">a</span><span class="ffa fcd ws4"># Immediately deleted</span></span></div><div class="t m0 x5 hf y1fd8 ff8 fs5 fc8 sc0 ls0">Data.__del__</div><div class="t m0 x5 hf y1fd9 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0">Node()</span></span></div><div class="t m0 x5 hf y1fda ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">a<span class="fc6 ls0 ws13a">.<span class="fc0">add_child(Node())</span></span></span></div><div class="t m0 x5 hf y1fdb ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">del <span class="ff8 fc0 ls32">a</span><span class="ffa fcd ws4"># Not deleted (no message)</span></span></div><div class="t m0 x5 hf y1fdc ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y255 ff1 fs3 fc0 sc0 ls18 wsb72">可以看到，最后一个的删除时打印语句没有出现。原因是 <span class="ff4 ls0 wsf8">Python </span><span class="ws110">的垃圾回收机制<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y1fdd ff1 fs3 fc0 sc0 ls6b wsb73">是基于简单的引用计数。当一个对象的引用数变成 <span class="ff4 ls88">0</span><span class="ws28f">的时候才会立即删除掉<span class="_ _c"></span>。而对于</span></div><div class="t m0 x5 h9 yebd ff1 fs3 fc0 sc0 ls1e ws111">循环引用这个条件永远不会成立<span class="_ _1"></span>。因此<span class="_ _1"></span>，在上面例子中最后部分，父节点和孩子<span class="_ _1"></span>节点</div><div class="t m0 x5 h7 y1fde ff1 fs3 fc0 sc0 ls0 ws63">互相拥有对方的引用，导致每个对象的引用计数都不可能变成 <span class="ff4 wsa5">0</span>。</div><div class="t m0 x0 h7 y1fdf ff4 fs3 fc0 sc0 ls0 ws3cb">Python <span class="ff1 ls30 ws138">有另外的垃圾回收器来专门针对循环引用的，但是你永远不知道它什么时<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y1fe0 ff1 fs3 fc0 sc0 ls0">候会触发。另外你还可以手动的触发它，但是代码看上去很挫：</div><div class="t m0 x5 h10 y1fe1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">gc</span></span></div><div class="t m0 x5 hf y1fe2 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">gc<span class="fc6 ls34">.</span><span class="ws16e">collect() <span class="ffa fcd ws4"># Force collection</span></span></span></div><div class="t m0 x5 hf y1fe3 ff8 fs5 fc8 sc0 ls0">Data.__del__</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.23.<span class="_ _5"> </span>8.23 <span class="ff1 wsb70">循环引用数据结构的内存管理 </span>293</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
