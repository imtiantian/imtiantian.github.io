<div id="pf105" class="pf w0 h0" data-page-no="105"><div class="pc pc105 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg105.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">p<span class="fc6 ls33">=</span><span class="ls0 ws13a">Point(<span class="fc7 ls34">2</span></span>,<span class="fc7 ls34">3</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y1ac ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">p<span class="fc6 ls0 ws13a">.</span><span class="ls33">x</span></span><span class="ffa fcd ws13b"># Calls Point.x.__get__(p,Point)</span></div><div class="t m0 x5 hf y1ad ff8 fs5 fc8 sc0 ls0">2</div><div class="t m0 x5 hf y1ae ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">p<span class="fc6 ls0 ws13a">.</span><span class="ls33">y<span class="fc6 ls32">=</span><span class="fc7">5</span></span></span><span class="ffa fcd ws4"># Calls Point.y.__set__(p, 5)</span></div><div class="t m0 x5 hf y1af ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">p<span class="fc6 ls0 ws13a">.</span><span class="ls33">x<span class="fc6 ls32">=<span class="fc7 ls0 ws158">2.3 <span class="ffa fcd ws4"># Calls Point.x.__set__(p, 2.3)</span></span></span></span></span></div><div class="t m0 x5 hf y1b0 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y355 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x15 hf y410 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;descrip.py&quot;</span><span class="ws145">, line <span class="fc7 ws13a">12</span><span class="ls32">,</span><span class="ff7 fca ws157">in </span>__set__</span></div><div class="t m0 x16 hf y411 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Expected an int<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf yba ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: Expected an int</span></div><div class="t m0 x5 hf y8c6 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y33a ff1 fs3 fc0 sc0 ls0 wsa0">作为输入，描述器的每<span class="_ _6"></span>一个方法会接受一个操作<span class="_ _6"></span>实例。为了实现请求操作，<span class="_ _6"></span>会相应</div><div class="t m0 x5 h7 y171c ff1 fs3 fc0 sc0 ls3d wsacc">的操作实例底层的字典 <span class="ff4 ls0 wsacd">( dict <span class="ff1 wsa0">属性</span><span class="ls1b">)</span></span><span class="wsace">。描述器的 <span class="ff6 ls0 ws287">self.name </span><span class="ws164">属性存储了在实例字典中</span></span></div><div class="t m0 x5 h7 y171d ff1 fs3 fc0 sc0 ls0 ws38">被实际使用到的 <span class="ff4 wsa5">k<span class="_ _1"></span>ey<span class="ff1">。</span></span></div><div class="t m0 x5 he y13ad ff2 fs2 fc4 sc0 ls0 ws212">10.9.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y1c46 ff1 fs3 fc0 sc0 ls173 wsacf">描述器可实现大部分 <span class="ff4 ls0 wsad0">Python </span><span class="wsad1">类特性中的底层魔法<span class="_ _1f"></span>，<span class="_ _6"></span>包括 <span class="ff6 ls0 wsad2">@classmethod <span class="ff1">、</span></span></span></div><div class="t m0 x5 h9 y1c47 ff6 fs3 fc0 sc0 ls0 ws317">@staticmethod <span class="ff1 wsa0">、</span><span class="ws1d1">@property <span class="ff1 ws592">，甚至是 </span><span class="wsad3">slots <span class="ff1">特性。</span></span></span></div><div class="t m0 x0 h7 y1c48 ff1 fs3 fc0 sc0 ls48 wsad4">通过定义一个描述器<span class="_ _1"></span>，你可以在底层捕获核心的实例操作 <span class="ff4 ls0 wsad5">(get, set, delete)<span class="ff1 wsa0">，<span class="_ _6"></span>并<span class="_ _6"></span>且</span></span></div><div class="t m0 x5 h9 y1c49 ff1 fs3 fc0 sc0 lsd3 ws4b2">可完全自定义它们的行为<span class="_ _c"></span>。这是一个强大的工具，有了它你可以实现很多高级功能<span class="_ _c"></span>，<span class="_ _c"></span></div><div class="t m0 x5 h9 y1c4a ff1 fs3 fc0 sc0 ls0">并且它也是很多高级库和框架中的重要工具之一。</div><div class="t m0 x0 h9 y1c4b ff1 fs3 fc0 sc0 ls3a ws153">描述器的一个比较困惑的地方是它只能在类级别被定义，而不能为每个实例单独定</div><div class="t m0 x5 h9 y1c4c ff1 fs3 fc0 sc0 ls0">义。因此，下面的代码是无法工作的：</div><div class="t m0 x5 h11 y1c4d ffa fs5 fcd sc0 ls0 ws4"># Does NOT work</div><div class="t m0 x5 hf y1c4e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Point<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf yb73 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, x, y):</span></span></span></div><div class="t m0 x16 hf yb74 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ls33">x</span><span class="ls32">=</span><span class="fc0">Integer(<span class="ff9 fc9 ls34">&apos;<span class="ff8">x</span><span class="ls0 ws13b">&apos;</span></span><span class="ls33">)</span><span class="ffa fcd ws4"># No! Must be a class variable</span></span></span></div><div class="t m0 x16 hf yb75 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ls33">y</span><span class="ls32">=</span><span class="fc0">Integer(<span class="ff9 fc9 ls34">&apos;<span class="ff8">y</span><span class="ls0 ws13b">&apos;</span></span>)</span></span></div><div class="t m0 x16 hf yb76 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ls33">x</span><span class="ls32">=</span><span class="fc0">x</span></span></div><div class="t m0 x16 hf yb77 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ls33">y</span><span class="ls32">=</span><span class="fc0">y</span></span></div><div class="t m0 x0 h9 y1c4f ff1 fs3 fc0 sc0 ls0 wsad6">同时， <span class="ff6 ws308">get<span class="_ _e"> </span>() </span>方法实现起来比看上去要复杂得多：</div><div class="t m0 x5 h11 y1c50 ffa fs5 fcd sc0 ls0 ws4"># Descriptor attribute for an integer type-checked attribute</div><div class="t m0 x5 hf y1c51 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Integer<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1c52 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__get__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, cls):</span></span></span></div><div class="t m0 x16 hf y1c53 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">instance </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y856 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x16 hf y857 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y858 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">instance<span class="fc6">.</span>__dict__[<span class="fca">self<span class="fc6 ls34">.</span></span>name]</span></div><div class="t m0 x31 h9 y1c54 ff6 fs3 fc0 sc0 ls0 wsad7">get<span class="_ _e"> </span>() <span class="ff1 ls40 ws180">看上去有点复杂的原因归结于实例变量和类变量的不同<span class="_ _1"></span>。如果一个描述</span></div><div class="t m0 x5 h9 y1c55 ff1 fs3 fc0 sc0 ls2c wsad8">器被当做一个类变量来访问，那么 <span class="ff6 ls0 ws736">instance </span><span class="wsad9">参数被设置成 <span class="ff6 ls0 ws541">None </span><span class="ws12f">。这种情况下，标准</span></span></div><div class="t m0 x5 h7 y1c56 ff1 fs3 fc0 sc0 ls30 wsada">做法就是简单的返回这个描述器本身即可 <span class="ff4 ls1b">(</span><span class="ws138">尽管你还可以添加其他的自定义操作<span class="ff4 ls0 wsa5">)<span class="ff1 wsa0">。例</span></span></span></div><div class="t m0 x5 h9 y1c57 ff1 fs3 fc0 sc0 ls0">如：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">10.9.<span class="_ _5"> </span>8.9 <span class="ff1 ws9db">创建新的类或实例属性 </span>252</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
