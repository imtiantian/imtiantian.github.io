<div id="pf240" class="pf w0 h0" data-page-no="240"><div class="pc pc240 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg240.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y1e8 ff8 fs5 fc0 sc0 ls0 ws4">double x, y, result;</div><div class="t m0 x19 hf y1e9 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args,&quot;Odd&quot;, &amp;func,&amp;x,&amp;y)) {</div><div class="t m0 x15 hf y1ea ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y903 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y1eb ff8 fs5 fc0 sc0 ls0 ws4">result = call_func(func, x, y);</div><div class="t m0 x19 hf y1ec ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;d&quot;, result);</div><div class="t m0 x5 hf y904 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y376a ff1 fs3 fc0 sc0 ls0">使用这个扩展函数，你要像下面这样测试它：</div><div class="t m0 x5 h10 y376b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y376c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">def <span class="ff8 fcb ws13a">add<span class="fc0">(x,y):</span></span></span></div><div class="t m0 x5 hf y376d ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws146">return <span class="ff8 fc0 ls34">x<span class="fc6 ls0 ws13a">+<span class="fc0">y</span></span></span></span></div><div class="t m0 x5 h10 y376e ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y376f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>call_func(add,<span class="fc7 ls34">3<span class="fc0">,</span><span class="ls0">4</span></span>)</span></div><div class="t m0 x5 hf y3770 ff8 fs5 fc8 sc0 ls0">7.0</div><div class="t m0 x5 hf y3771 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y3772 ff2 fs2 fc4 sc0 ls0 ws212">17.6.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y3773 ff1 fs3 fc0 sc0 ls0 ws141f">如果<span class="_ _6"></span>你在 <span class="ff4 ls209">C</span><span class="ls42 ws1420">语言中调用 </span><span class="ff4 wsa5">Python</span><span class="ls42 ws13bb">，要记住最重要的是 <span class="ff4 ls209">C</span></span><span class="wsa0">语言<span class="_ _6"></span>会是<span class="_ _6"></span>主体。<span class="_ _6"></span>也就<span class="_ _6"></span>是说，</span></div><div class="t m0 x5 h7 y2c2f ff4 fs3 fc0 sc0 ls8">C<span class="ff1 ls0 ws38">语言负责构造参数、调用 </span><span class="ls0 ws5c">Python <span class="ff1">函数、检查异常、检查类型、提取返回值等。</span></span></div><div class="t m0 x0 h7 y3774 ff1 fs3 fc0 sc0 ls18 ws1421">作为第一步，你必须先有一个表示你将要调用的 <span class="ff4 ls0 ws453">Python </span><span class="ws110">可调用对象。这可以是一<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y1bc6 ff1 fs3 fc0 sc0 ls30 ws1422">个函数、类<span class="_ _c"></span>、方法、内置方法或其他任意实现了 <span class="ff6 ls0 wsae8">call<span class="_ _40"> </span>() </span><span class="ws138">操作的东西。为了确保是</span></div><div class="t m0 x5 h9 y3775 ff1 fs3 fc0 sc0 ls0 ws63">可调用的，可以像下面的代码这样利用 <span class="ff6 ws472">PyCallable<span class="_ _7"> </span>Check() </span>做检查：</div><div class="t m0 x5 hf y3776 ff8 fs5 fc0 sc0 ls0 ws4">double call_func(PyObject *func, double x, double y) {</div><div class="t m0 x19 hf y3777 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x19 hf y3778 ff8 fs5 fc0 sc0 ls0 ws4">/* Verify that func is a proper callable */</div><div class="t m0 x19 hf y3779 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyCallable_Check(func)) {</div><div class="t m0 x15 hf y377a ff8 fs5 fc0 sc0 ls0 ws4">fprintf(stderr,&quot;call_func: expected a callable\n&quot;);</div><div class="t m0 x15 hf y377b ff8 fs5 fc0 sc0 ls0 ws13b">goto fail;</div><div class="t m0 x19 hf y2f66 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y377c ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x0 h7 y377d ff1 fs3 fc0 sc0 lsd6">在<span class="ff4 ls26b">C</span><span class="ls2c ws1423">代码里处理错误你需要格外的小心。一般来讲，你不能仅仅抛出一个 <span class="ff4 ls0">Python</span></span></div><div class="t m0 x5 h7 y377e ff1 fs3 fc0 sc0 lse ws1424">异常。错误应该使用 <span class="ff4 ls20">C</span><span class="wsd8">代码方式来被处理。在这里<span class="_ _1"></span>，我们打算将对错误的控制传给一</span></div><div class="t m0 x5 h9 y273f ff1 fs3 fc0 sc0 ls0 ws447">个叫 <span class="ff6 ws3dd">abort() </span><span class="lsa8 ws3de">的错误处理器。它会结束掉整个程序，在真实环境下面你应该要处理的<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y377f ff1 fs3 fc0 sc0 ls0 ws1425">更加<span class="_ _6"></span>优<span class="_ _6"></span>雅些<span class="_ _6"></span>（返<span class="_ _6"></span>回<span class="_ _6"></span>一个<span class="_ _6"></span>状<span class="_ _6"></span>态码）<span class="_ _f"></span>。<span class="_ _6"></span>你<span class="_ _6"></span>要记<span class="_ _6"></span>住<span class="_ _6"></span>的是<span class="_ _6"></span>在<span class="_ _6"></span>这里 <span class="ff4 ls26c">C</span><span class="wsa0">是<span class="_ _6"></span>主<span class="_ _6"></span>角，因<span class="_ _6"></span>此<span class="_ _6"></span>并<span class="_ _6"></span>没有<span class="_ _6"></span>跟<span class="_ _6"></span>抛出</span></div><div class="t m0 x5 h9 y3780 ff1 fs3 fc0 sc0 ls0">异常相对应的操作。错误处理是你在编程时必须要考虑的事情。</div><div class="t m0 x0 h9 y3781 ff1 fs3 fc0 sc0 ls0 ws1426">调用一个函数相对来讲很简单—<span class="_ _8"></span>—只需要使用 <span class="ff6 ws13db">PyObject<span class="_ _16"> </span>Call() </span><span class="wsa0">，传一个可调用对</span></div><div class="t m0 x5 h9 y3782 ff1 fs3 fc0 sc0 ls1e ws111">象给它<span class="_ _1"></span>、一个参数元组和一个可选的关键字字典<span class="_ _1"></span>。要构建参数元组或字典，你可<span class="_ _1"></span>以使</div><div class="t m0 x5 h7 y3783 ff1 fs3 fc0 sc0 ls4">用<span class="ff6 ls0 ws1dc">Py<span class="_ _7"> </span>BuildValue() <span class="ff4 ls83">,</span><span class="ff1">如下：</span></span></div><div class="t m0 x5 hf y3784 ff8 fs5 fc0 sc0 ls0 ws4">double call_func(PyObject *func, double x, double y) {</div><div class="t m0 x19 hf y3137 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *args;</div><div class="t m0 x19 hf y3785 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *kwargs;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.6.<span class="_ _36"> </span>15.6 <span class="ff1 ls81">从</span><span class="ls260">C</span><span class="ff1 ws7da">语言中调用 </span><span class="wscda">Python <span class="ff1 ws42c">代码 </span>567</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
