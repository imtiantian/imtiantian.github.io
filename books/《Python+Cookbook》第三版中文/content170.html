<div id="pfaa" class="pf w0 h0" data-page-no="aa"><div class="pc pcaa w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgaa.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">7.18.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y675 ff1 fs3 fc0 sc0 ls11f">在<span class="ff4 ls0 ws703">Unix </span><span class="lse wsd8">系统中，这种包装文件描述符的技术可以很方便的将一个类文件接口作用<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y676 ff1 fs3 fc0 sc0 lsa8 ws704">于一个以不同方式打开的 <span class="ff4 ls0 ws705">I/O </span><span class="ws3de">通道上，如管道<span class="_ _1"></span>、套接字等。举例来讲<span class="_ _1"></span>，下面是一个操</span></div><div class="t m0 x5 h9 y677 ff1 fs3 fc0 sc0 ls0">作管道的例子：</div><div class="t m0 x5 hf y1284 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 hf y1285 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_client<span class="fc0 ws13b">(client_sock, addr):</span></span></div><div class="t m0 x15 hf y1286 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Got connection from<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, addr)</span></span></div><div class="t m0 x15 h11 y1287 ffa fs5 fcd sc0 ls0 ws4"># Make text-mode file wrappers for socket reading/writing</div><div class="t m0 x15 hf y1288 ff8 fs5 fc0 sc0 ls0 ws16e">client_in <span class="fc6 ls33">=</span><span class="fca ws13a">open<span class="fc0">(client_sock<span class="fc6 ls34">.</span></span></span>fileno(), <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">rt<span class="ff9 ls34">&apos;</span></span><span class="ws4">, encoding<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">latin-1<span class="ff9 ls34">&apos;</span></span>,</span></div><div class="t m0 x18 hf y1289 ff8 fs5 fc0 sc0 ls0 ws13a">closefd<span class="fc6">=<span class="fca">False</span></span>)</div><div class="t m0 x15 hf y128a ff8 fs5 fc0 sc0 ls0 ws2a3">client_out <span class="fc6 ls32">=</span><span class="fca ws13a">open<span class="fc0">(client_sock<span class="fc6 ls34">.</span><span class="ws16e">fileno(), <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">wt<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, encoding<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span></span><span class="fc9">latin-1<span class="ff9 ws13b">&apos;</span></span>,</span></span></div><div class="t m0 x18 hf y128b ff8 fs5 fc0 sc0 ls0 ws13a">closefd<span class="fc6">=<span class="fca">False</span></span>)</div><div class="t m0 x15 h11 y128c ffa fs5 fcd sc0 ls0 ws4"># Echo lines back to the client using file I/O</div><div class="t m0 x15 hf y128d ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 fc0">client_in:</span></span></div><div class="t m0 x16 hf y1b6 ff8 fs5 fc0 sc0 ls0 ws13a">client_out<span class="fc6 ls34">.</span>write(line)</div><div class="t m0 x16 hf y128e ff8 fs5 fc0 sc0 ls0 ws13a">client_out<span class="fc6 ls34">.</span>flush()</div><div class="t m0 x15 hf y128f ff8 fs5 fc0 sc0 ls0 ws13a">client_sock<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 hf y1290 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_server<span class="fc0">(address):</span></span></div><div class="t m0 x15 hf y1291 ff8 fs5 fc0 sc0 ls0 ws13c">sock <span class="fc6 ls32">=</span><span class="ws4">socket(AF_INET, SOCK_STREAM)</span></div><div class="t m0 x15 hf y1292 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>bind(address)</div><div class="t m0 x15 hf y1293 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>listen(<span class="fc7">1</span>)</div><div class="t m0 x15 hf y1294 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y1295 ff8 fs5 fc0 sc0 ls0 ws13b">client, addr <span class="fc6 ls33">=</span><span class="ws13a">sock<span class="fc6">.</span>accept()</span></div><div class="t m0 x16 hf y1296 ff8 fs5 fc0 sc0 ls0 ws13b">echo_client(client, addr)</div><div class="t m0 x0 h9 y1297 ff1 fs3 fc0 sc0 ls3d ws706">需要重点强调的一点是，上面的例子仅仅是为了演示内置的 <span class="ff6 ls0 ws20b">open() <span class="ff1 wsa0">函数的<span class="_ _6"></span>一个<span class="_ _6"></span>特</span></span></div><div class="t m0 x5 h7 y1298 ff1 fs3 fc0 sc0 ls1f ws707">性，并且也只适用于基于 <span class="ff4 ls0 ws708">Unix </span><span class="ws113">的系统。如果你想将一个类文件接口作用在一个套接字</span></div><div class="t m0 x5 h9 y1299 ff1 fs3 fc0 sc0 ls0 ws709">并希望你的代码可以跨平台，请使用套接字对象的 <span class="ff6 ws70a">makefile() </span><span class="wsa0">方法。<span class="_ _1"></span>但是如果不考虑</span></div><div class="t m0 x5 h9 y129a ff1 fs3 fc0 sc0 ls0 ws63">可移植性的话，那上面的解决方案会比使用 <span class="ff6 ws2d1">makefile() </span>性能更好一点。</div><div class="t m0 x0 h9 y129b ff1 fs3 fc0 sc0 ls3a ws153">你也可以使用这种技术来构造一个别名，允许以不同于第一次打开文件的方式使用</div><div class="t m0 x5 h7 y483 ff1 fs3 fc0 sc0 ls1f ws70b">它。例如，下面演示如何创建一个文件对象，它允许你输出二进制数据到标准输出 <span class="ff4 ls0 wsa5">(<span class="ff1">通</span></span></div><div class="t m0 x5 h7 y129c ff1 fs3 fc0 sc0 ls0 wsa0">常以文本模式打开<span class="ff4 ls1b">)</span>：</div><div class="t m0 x5 h10 y129d ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x5 h11 y129e ffa fs5 fcd sc0 ls0 ws4"># Create a binary-mode file for stdout</div><div class="t m0 x5 hf y129f ff8 fs5 fc0 sc0 ls0 ws155">bstdout <span class="fc6 ls32">=</span><span class="fca ws13a">open<span class="fc0">(sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span><span class="ws16e">fileno(), <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">wb<span class="ff9 ls34">&apos;</span></span><span class="ws4">, closefd</span><span class="fc6">=</span></span>False</span>)</div><div class="t m0 x5 hf y12a0 ff8 fs5 fc0 sc0 ls0 ws13a">bstdout<span class="fc6 ls34">.</span>write(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">Hello World<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;</span></span></span>)</div><div class="t m0 x5 hf y12a1 ff8 fs5 fc0 sc0 ls0 ws13a">bstdout<span class="fc6 ls34">.</span>flush()</div><div class="t m0 x0 h9 y6c ff1 fs3 fc0 sc0 ls3a ws153">尽管可以将一个已存在的文件描述符包装成一个正常的文件对象，但是要注意的是</div><div class="t m0 x5 h7 yf8f ff1 fs3 fc0 sc0 ls1f ws70c">并不是所有的文件模式都被支持，并且某些类型的文件描述符可能会有副作用 <span class="ff4 ls0 wsa5">(</span><span class="ws113">特别是</span></div><div class="t m0 x5 h7 y6e ff1 fs3 fc0 sc0 lse wsd8">涉及到错误处理、文件结尾条件等等的时候<span class="_ _1"></span><span class="ff4 ls0 wsa5">)<span class="ff1 lse wsd8">。在不同的操作系统上这种行为也是不一</span></span></div><div class="t m0 x5 h7 y674 ff1 fs3 fc0 sc0 ls1f ws70d">样，特别的，上面的例子都不能在非 <span class="ff4 ls0 ws70e">Unix </span><span class="ws113">系统上运行。我说了这么多，意思就是让你</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">7.18.<span class="_ _5"> </span>5.18 <span class="ff1 ws6e7">将文件描述符包装成文件对象 </span>161</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
