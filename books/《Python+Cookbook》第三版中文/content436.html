<div id="pf1b4" class="pf w0 h0" data-page-no="1b4"><div class="pc pc1b4 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1b4.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">_ssl_context </span><span class="ls32">=</span><span class="fc0">ssl</span>.<span class="fc0">SSLContext(ssl</span><span class="ls34">.</span><span class="fc0">PROTOCOL_TLSv1)</span></span></div><div class="t m0 x16 hf y1ac ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_ssl_context</span><span class="ls34">.</span><span class="fc0">load_verify_locations(cafile)</span></span></div><div class="t m0 x16 hf y1ad ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0">cert:</span></div><div class="t m0 x17 hf y1ae ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_ssl_context</span><span class="ls34">.</span><span class="fc0 ws13b">load_cert_chain(certfile, keyfile)</span></span></div><div class="t m0 x16 hf y1af ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_ssl_context</span><span class="ls34">.</span><span class="fc0 ws208">verify_mode </span><span class="ls32">=</span><span class="fc0">ssl</span><span class="ls34">.</span><span class="fc0">CERT_REQUIRED</span></span></div><div class="t m0 x15 hf y355 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">make_connection<span class="fc0">(<span class="fca">self</span><span class="ws4">, host):</span></span></span></div><div class="t m0 x16 h11 y410 ffa fs5 fcd sc0 ls0 ws4"># Items in the passed dictionary are passed as keyword</div><div class="t m0 x16 h11 y411 ffa fs5 fcd sc0 ls0 ws4"># arguments to the http.client.HTTPSConnection() constructor.</div><div class="t m0 x16 h11 yba ffa fs5 fcd sc0 ls0 ws4"># The context argument allows an ssl.SSLContext instance to</div><div class="t m0 x16 h11 y8c6 ffa fs5 fcd sc0 ls0 ws4"># be passed with information about the SSL configuration</div><div class="t m0 x16 hf ybed ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=<span class="fca ls0 ws13a">super<span class="fc0">()</span></span><span class="ls34">.</span></span><span class="ls0 ws13b">make_connection((host, {<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">context<span class="ff9 ls34">&apos;</span></span></span>:<span class="fca ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_ssl_context}))</span></span></div><div class="t m0 x16 hf ybef ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">s</span></div><div class="t m0 x5 h11 yd7d ffa fs5 fcd sc0 ls0 ws4"># Create the client proxy</div><div class="t m0 x5 hf ybf1 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">ServerProxy(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">https://localhost:15000<span class="ff9 ls34">&apos;</span></span>,</span></div><div class="t m0 x18 hf ybf2 ff8 fs5 fc0 sc0 ls0 ws13a">transport<span class="fc6 ls34">=</span>VerifyCertSafeTransport(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">server_cert.pem<span class="ff9 ls34">&apos;</span></span>),</div><div class="t m0 x18 hf ybf3 ff8 fs5 fc0 sc0 ls0 ws13a">allow_none<span class="fc6 ls34">=</span><span class="fca">True</span>)</div><div class="t m0 x0 h9 y21f7 ff1 fs3 fc0 sc0 ls0 wsa0">服务<span class="_ _6"></span>器<span class="_ _6"></span>将<span class="_ _6"></span>证书<span class="_ _6"></span>发<span class="_ _6"></span>送<span class="_ _6"></span>给客<span class="_ _6"></span>户<span class="_ _6"></span>端，客<span class="_ _6"></span>户<span class="_ _6"></span>端<span class="_ _6"></span>来确<span class="_ _6"></span>认<span class="_ _6"></span>它<span class="_ _6"></span>的合<span class="_ _6"></span>法<span class="_ _6"></span>性。<span class="_ _6"></span>这种<span class="_ _6"></span>确<span class="_ _6"></span>认可<span class="_ _6"></span>以<span class="_ _6"></span>是<span class="_ _6"></span>相互<span class="_ _6"></span>的。</div><div class="t m0 x5 h9 y2b46 ff1 fs3 fc0 sc0 ls0">如果服务器想要确认客户端，可以将服务器启动代码修改如下：</div><div class="t m0 x5 hf y2c4b ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y2c4c ff8 fs5 fc0 sc0 ls0 ws13a">KEYFILE<span class="fc6 ls34">=</span><span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">server_key.pem<span class="ff9 lsa1">&apos;</span><span class="ffa fcd ws4"># Private key of the server</span></span></div><div class="t m0 x15 hf y2c4d ff8 fs5 fc0 sc0 ls0 ws13a">CERTFILE<span class="fc6">=<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">server_cert.pem<span class="ff9 ls33">&apos;</span><span class="ffa fcd ws13b"># Server certificate</span></span></span></div><div class="t m0 x15 hf y5e2 ff8 fs5 fc0 sc0 ls0 ws13a">CA_CERTS<span class="fc6">=<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">client_cert.pem<span class="ff9 ls33">&apos;</span><span class="ffa fcd ws4"># Certificates of accepted clients</span></span></span></div><div class="t m0 x15 hf y5e4 ff8 fs5 fc0 sc0 ls0 ws145">kvserv <span class="fc6 ls32">=</span><span class="ws13a">KeyValueServer((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">15000</span>),</span></div><div class="t m0 x23 hf y5e5 ff8 fs5 fc0 sc0 ls0 ws13a">keyfile<span class="fc6 ls34">=</span>KEYFILE,</div><div class="t m0 x23 hf y5e6 ff8 fs5 fc0 sc0 ls0 ws13a">certfile<span class="fc6 ls34">=</span>CERTFILE,</div><div class="t m0 x23 hf y5e7 ff8 fs5 fc0 sc0 ls0 ws13a">ca_certs<span class="fc6 ls34">=</span>CA_CERTS,</div><div class="t m0 x23 hf y5e8 ff8 fs5 fc0 sc0 ls0 ws13a">cert_reqs<span class="fc6 ls34">=</span>ssl<span class="fc6 ls34">.</span>CERT_REQUIRED,</div><div class="t m0 x23 hf y5e9 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x15 hf y2c4e ff8 fs5 fc0 sc0 ls0 ws13a">kvserv<span class="fc6 ls34">.</span>serve_forever()</div><div class="t m0 x0 h7 y2c4f ff1 fs3 fc0 sc0 ls0 ws38">为了让 <span class="ff4 ws92">XML-RPC </span><span class="ws14">客户端发送证书，修改 <span class="ff6 ws133">ServerProxy </span>的初始化代码如下：</span></div><div class="t m0 x5 h11 y2c50 ffa fs5 fcd sc0 ls0 ws4"># Create the client proxy</div><div class="t m0 x5 hf y2c51 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">ServerProxy(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">https://localhost:15000<span class="ff9 ls34">&apos;</span></span>,</span></div><div class="t m0 x18 hf y2c52 ff8 fs5 fc0 sc0 ls0 ws13a">transport<span class="fc6 ls34">=</span>VerifyCertSafeTransport(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">server_cert.pem<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x3f hf y2c53 ff9 fs5 fc9 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">client_cert.pem</span>&apos;<span class="ff8 fc0 ls0">,</span></div><div class="t m0 x3f hf y2c54 ff9 fs5 fc9 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">client_key.pem</span>&apos;<span class="ff8 fc0 ls0">),</span></div><div class="t m0 x18 hf y2883 ff8 fs5 fc0 sc0 ls0 ws13a">allow_none<span class="fc6 ls34">=</span><span class="fca">True</span>)</div><div class="t m0 x5 he y2c55 ff2 fs2 fc4 sc0 ls0 wsadf">13.10.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y2c56 ff1 fs3 fc0 sc0 ls3a wsfd7">试着去运行本节的代码能测试你的系统配置能力和理解 <span class="ff4 ls0 wsa5">SSL<span class="ff1 wsa0">。可能最大的挑战是如</span></span></div><div class="t m0 x5 h7 y2c57 ff1 fs3 fc0 sc0 ls0 ws38">何一步步的获取初始配置 <span class="ff4 wsa5">k<span class="_ _1"></span>ey<span class="ff1">、证书和其他所需依赖。</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.10.<span class="_ _36"> </span>11.10 <span class="ff1 ws16b">在网络服务中加入 </span><span class="wsfc8">SSL 427</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
