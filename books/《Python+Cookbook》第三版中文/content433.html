<div id="pf1b1" class="pf w0 h0" data-page-no="1b1"><div class="pc pc1b1 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1b1.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_server<span class="fc0">(address):</span></span></div><div class="t m0 x15 hf y1ac ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></div><div class="t m0 x15 hf y1ad ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bind(address)</span></span></div><div class="t m0 x15 hf y1ae ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">listen(</span></span><span class="fc7">1</span><span class="ls0">)</span></div><div class="t m0 x15 h11 y1b0 ffa fs5 fcd sc0 ls0 ws4"># Wrap with an SSL layer requiring client certs</div><div class="t m0 x15 hf y355 ff8 fs5 fc0 sc0 ls0 ws15f">s_ssl <span class="fc6 ls33">=</span><span class="ws13a">ssl<span class="fc6 ls34">.</span>wrap_socket(s,</span></div><div class="t m0 x23 hf y410 ff8 fs5 fc0 sc0 ls0 ws13a">keyfile<span class="fc6 ls34">=</span>KEYFILE,</div><div class="t m0 x23 hf y411 ff8 fs5 fc0 sc0 ls0 ws13a">certfile<span class="fc6 ls34">=</span>CERTFILE,</div><div class="t m0 x23 hf yba ff8 fs5 fc0 sc0 ls0 ws13a">server_side<span class="fc6 ls34">=</span><span class="fca">True</span></div><div class="t m0 x23 hf y8c6 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x15 h11 ybed ffa fs5 fcd sc0 ls0 ws4"># Wait for connections</div><div class="t m0 x15 hf ybee ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf ybef ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf ybf0 ff8 fs5 fc0 sc0 ls0 ws158">c,a <span class="fc6 ls32">=</span><span class="ws13a">s_ssl<span class="fc6">.</span>accept()</span></div><div class="t m0 x17 hf yd7d ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Got connection</span>&apos;</span><span class="ls0 ws13b">, c, a)</span></span></div><div class="t m0 x17 hf ybf1 ff8 fs5 fc0 sc0 ls0">echo_client(c)</div><div class="t m0 x16 hf ybf2 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws16e">Exception </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x17 hf ybf3 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">{}: {}</span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13a">format(e</span><span class="fc6">.</span><span class="ls0 ws13a">__class__<span class="fc6">.</span><span class="ws4">__name__, e))</span></span></span></div><div class="t m0 x5 hf ybf5 ff8 fs5 fc0 sc0 ls0 ws13a">echo_server((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">20000</span>))</div><div class="t m0 x0 h9 y21f8 ff1 fs3 fc0 sc0 ls3a ws153">下面我们演示一个客户端连接服务器的交互例子。客户端会请求服务器来认证并确</div><div class="t m0 x5 h9 y2c18 ff1 fs3 fc0 sc0 ls0">认连接：</div><div class="t m0 x5 hf y2c19 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></span></div><div class="t m0 x5 h10 y2c1a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">ssl</span></span></div><div class="t m0 x5 hf y2c1b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></span></div><div class="t m0 x5 hf y2c1c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">s_ssl <span class="fc6 ls33">=</span><span class="ws13a">ssl<span class="fc6 ls34">.</span>wrap_socket(s,</span></span></div><div class="t m0 x18 hf y2c1d ff8 fs5 fc8 sc0 ls0">cert_reqs=ssl.CERT_REQUIRED,</div><div class="t m0 x18 hf y2c1e ff8 fs5 fc8 sc0 ls0 ws13b">ca_certs = <span class="ff9">&apos;</span><span class="ws13a">server_cert.pem<span class="ff9 ls34">&apos;</span>)</span></div><div class="t m0 x5 hf y2c1f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">s_ssl<span class="fc6">.</span>connect((<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">localhost<span class="ff9 ls34">&apos;</span></span><span class="ls32">,</span><span class="fc7">20000</span>))</span></div><div class="t m0 x5 hf y2c20 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">s_ssl<span class="fc6">.</span>send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Hello World?</span><span class="ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y2c21 ff8 fs5 fc8 sc0 ls0">12</div><div class="t m0 x5 hf y2c22 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">s_ssl<span class="fc6">.</span>recv(<span class="fc7">8192</span>)</span></div><div class="t m0 x5 hf y2c23 ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">Hello World?<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y2c24 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y19dc ff1 fs3 fc0 sc0 lse8 wsfc9">这种直接处理底层 <span class="ff4 ls0 wsfca">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1 lse8 wsfcb">方式有个问题就是它不能很好的跟标准库中已存在的<span class="_ _d"></span></span></span></div><div class="t m0 x5 h7 y2c25 ff1 fs3 fc0 sc0 ls0 wsa0">网<span class="_ _6"></span>络<span class="_ _6"></span>服<span class="_ _0"></span>务<span class="_ _6"></span>兼<span class="_ _6"></span>容。<span class="_ _0"></span>例如，<span class="_ _0"></span>绝<span class="_ _6"></span>大<span class="_ _6"></span>部<span class="_ _0"></span>分<span class="_ _6"></span>服<span class="_ _6"></span>务<span class="_ _6"></span>器<span class="_ _0"></span>代<span class="_ _6"></span>码<span class="_ _6"></span>（<span class="ff4 wsa5">HTTP</span><span class="ls1ed">、</span><span class="ff4 wsfcc">XML-RPC </span>等）<span class="_ _6"></span>实<span class="_ _0"></span>际<span class="_ _6"></span>上<span class="_ _6"></span>是<span class="_ _6"></span>基<span class="_ _0"></span>于</div><div class="t m0 x5 h9 y2c26 ff6 fs3 fc0 sc0 ls0 wsfcd">socketserver <span class="ff1 ls2c ws12f">库的。客户端代码在一个较高层上实现。我们需要另外一种稍微不同的<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y2c27 ff1 fs3 fc0 sc0 ls0 ws14">方式来将 <span class="ff4 wsfce">SSL </span>添加到已存在的服务中：</div><div class="t m0 x0 h7 y2c28 ff1 fs3 fc0 sc0 ls0 ws14">首先，对于服务器而言，可以通过像下面这样使用一个 <span class="ff4 wsfcf">mixin </span>类来添加 <span class="ff4 wsa5">SSL</span>：</div><div class="t m0 x5 h10 y2c29 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">ssl</span></div><div class="t m0 x5 hf y2c2a ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">SSLMixin<span class="ff8 fc0">:</span></span></div><div class="t m0 x5 h15 y2c2b ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x5 h11 y2c2c ffa fs5 fc9 sc0 ls0 ws4">Mixin class that adds support for SSL to existing servers based</div><div class="t m0 x5 h11 y2c2d ffa fs5 fc9 sc0 ls0 ws4">on the socketserver module.</div><div class="t m0 x5 h15 y2c2e ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.10.<span class="_ _36"> </span>11.10 <span class="ff1 ws16b">在网络服务中加入 </span><span class="wsfc8">SSL 424</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
