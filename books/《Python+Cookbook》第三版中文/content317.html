<div id="pf13d" class="pf w0 h0" data-page-no="13d"><div class="pc pc13d w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg13d.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">11.5.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y675 ff1 fs3 fc0 sc0 ls49 wsbc1">引入一个访问函数<span class="_ _1"></span>，使用 <span class="ff6 ls0 ws6b1">nolocal </span><span class="ws1a6">来修改内部变量<span class="_ _1"></span>。然后这个访问函数被作为一</span></div><div class="t m0 x5 h9 y676 ff1 fs3 fc0 sc0 ls0">个属性赋值给包装函数。</div><div class="t m0 x5 hf y2110 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0 ws4">wraps, partial</span></span></div><div class="t m0 x5 h10 y2111 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">logging</span></div><div class="t m0 x5 h11 y2112 ffa fs5 fcd sc0 ls0 ws4"># Utility decorator to attach a function as an attribute of obj</div><div class="t m0 x5 hf y2113 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">attach_wrapper<span class="fc0 ws4">(obj, func<span class="fc6 ls34">=</span></span><span class="fca">None<span class="fc0">):</span></span></span></div><div class="t m0 x15 hf y2114 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">func </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2115 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13b">partial(attach_wrapper, obj)</span></div><div class="t m0 x15 hf y2116 ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ws4">(obj, func<span class="fc6 ls34">.</span>__name__, func)</span></div><div class="t m0 x15 hf y2117 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">func</span></div><div class="t m0 x5 hf y2154 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">logged<span class="fc0 ws4">(level, name<span class="fc6 ls34">=</span></span><span class="fca">None<span class="fc0 ws13b">, message<span class="fc6 ls34">=</span></span>None<span class="fc0">):</span></span></span></div><div class="t m0 x15 h15 y2155 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2156 ffa fs5 fc9 sc0 ls0 ws4">Add logging to a function. level is the logging</div><div class="t m0 x15 h11 y2157 ffa fs5 fc9 sc0 ls0 ws4">level, name is the logger name, and message is the</div><div class="t m0 x15 h11 y2158 ffa fs5 fc9 sc0 ls0 ws4">log message. If name and message aren<span class="ffb ls34">&apos;</span><span class="ws13b">t specified,</span></div><div class="t m0 x15 h11 y2159 ffa fs5 fc9 sc0 ls0 ws4">they default to the function<span class="ffb ls34">&apos;</span>s module and name.</div><div class="t m0 x15 h15 y215a ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y215b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decorate<span class="fc0">(func):</span></span></div><div class="t m0 x16 hf y215c ff8 fs5 fc0 sc0 ls0 ws155">logname <span class="fc6 ls32">=</span><span class="ws13c">name <span class="ff7 fca ws157">if </span>name <span class="ff7 fca ws218">else </span><span class="ws13a">func<span class="fc6 ls34">.</span>__module__</span></span></div><div class="t m0 x16 hf y215d ff8 fs5 fc0 sc0 ls0 ws158">log <span class="fc6 ls32">=</span><span class="ws13a">logging<span class="fc6 ls34">.</span>getLogger(logname)</span></div><div class="t m0 x16 hf y215e ff8 fs5 fc0 sc0 ls0 ws145">logmsg <span class="fc6 ls32">=</span><span class="ws155">message <span class="ff7 fca ws157">if </span>message <span class="ff7 fca ws15a">else </span><span class="ws13a">func<span class="fc6">.</span>__name__</span></span></div><div class="t m0 x16 hf y215f ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x16 hf y2160 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws458">args, </span>**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x17 hf y75a ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span><span class="ws13b">log(level, logmsg)</span></div><div class="t m0 x17 hf y2161 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">func(<span class="fc6 ls34">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs)</span></div><div class="t m0 x16 h11 y2162 ffa fs5 fcd sc0 ls0 ws4"># Attach setter functions</div><div class="t m0 x16 hf y2163 ff7 fs5 fc12 sc0 ls0 ws156">@attach_wrapper<span class="ff8 fc0">(wrapper)</span></div><div class="t m0 x16 hf y2164 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">set_level<span class="fc0">(newlevel):</span></span></div><div class="t m0 x17 hf y2165 ff8 fs5 fc0 sc0 ls0 ws13b">nonlocal level</div><div class="t m0 x17 hf y4a ff8 fs5 fc0 sc0 ls0 ws15f">level <span class="fc6 ls33">=</span>newlevel</div><div class="t m0 x16 hf y2166 ff7 fs5 fc12 sc0 ls0 ws156">@attach_wrapper<span class="ff8 fc0">(wrapper)</span></div><div class="t m0 x16 hf y2167 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">set_message<span class="fc0">(newmsg):</span></span></div><div class="t m0 x17 hf y2168 ff8 fs5 fc0 sc0 ls0 ws13b">nonlocal logmsg</div><div class="t m0 x17 hf y2169 ff8 fs5 fc0 sc0 ls0 ws145">logmsg <span class="fc6 ls32">=</span>newmsg</div><div class="t m0 x16 hf y216a ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x15 hf y216b ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">decorate</span></div><div class="t m0 x5 h11 y216c ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 hf y216d ff7 fs5 fc12 sc0 ls0 ws156">@logged<span class="ff8 fc0 ws13a">(logging<span class="fc6 ls34">.</span>DEBUG)</span></div><div class="t m0 x5 hf y216e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y216f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">11.5.<span class="_ _5"> </span>9.5 <span class="ff1 ws9db">可自定义属性的装饰器 </span>308</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
