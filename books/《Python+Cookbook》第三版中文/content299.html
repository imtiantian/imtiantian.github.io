<div id="pf12b" class="pf w0 h0" data-page-no="12b"><div class="pc pc12b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg12b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">Mul(Number(<span class="fc7">2</span><span class="ws4">), t1)</span></span></div><div class="t m0 x15 hf y1ac ff8 fs5 fc0 sc0 ls0 ws159">t3 <span class="fc6 ls33">=</span><span class="ws13b">Div(t2, Number(<span class="fc7 ls34">5</span>))</span></div><div class="t m0 x15 hf y1ad ff8 fs5 fc0 sc0 ls0 ws159">t4 <span class="fc6 ls33">=</span><span class="ws13a">Add(Number(<span class="fc7">1</span><span class="ws4">), t3)</span></span></div><div class="t m0 x15 h11 y1ae ffa fs5 fcd sc0 ls0 ws13b"># Evaluate it</div><div class="t m0 x15 hf y1af ff8 fs5 fc0 sc0 ls32">e<span class="fc6 ls33">=</span><span class="ls0">Evaluator()</span></div><div class="t m0 x15 hf y1b0 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(e<span class="fc6 ls34">.</span><span class="wsa7e">visit(t4)) <span class="ffa fcd ws4"># Outputs 0.6</span></span></span></div><div class="t m0 x0 h7 y1f87 ff1 fs3 fc0 sc0 ls0 ws38">如果嵌套层次太深那么上述的 <span class="ff4 wsb61">Ev<span class="_ _d"></span>aluator <span class="ff1">就会失效：</span></span></div><div class="t m0 x5 hf y1f88 ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; a = Number(0)</div><div class="t m0 x5 hf y1f89 ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; for n in range(1, 100000):</div><div class="t m0 x5 hf y1f8a ff8 fs5 fc0 sc0 ls0 ws4">... a = Add(a, Number(n))</div><div class="t m0 x5 hf y1f8b ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y1f8c ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; e = Evaluator()</div><div class="t m0 x5 hf y1f8d ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; e.visit(a)</div><div class="t m0 x5 hf y1f8e ff8 fs5 fc0 sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x5 hf y1f8f ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x15 hf y1f90 ff8 fs5 fc0 sc0 ls0 ws4">File &quot;visitor.py&quot;, line 29, in _visit</div><div class="t m0 x5 hf y1f91 ff8 fs5 fc0 sc0 ls0 ws4">return meth(node)</div><div class="t m0 x15 hf y1f92 ff8 fs5 fc0 sc0 ls0 ws4">File &quot;visitor.py&quot;, line 67, in visit_Add</div><div class="t m0 x5 hf y1f93 ff8 fs5 fc0 sc0 ls0 ws4">return self.visit(node.left) + self.visit(node.right)</div><div class="t m0 x5 hf y1dcd ff8 fs5 fc0 sc0 ls0 ws4">RuntimeError: maximum recursion depth exceeded</div><div class="t m0 x5 hf y1f94 ff8 fs5 fc0 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y1f95 ff1 fs3 fc0 sc0 ls0 wsc">现在我们稍微修改下上面的 <span class="ff4 wsa5">Ev<span class="_ _d"></span>aluator<span class="ff1">：</span></span></div><div class="t m0 x5 hf y1f96 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Evaluator<span class="ff8 fc0">(NodeVisitor):</span></span></div><div class="t m0 x15 hf y1f97 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Number<span class="fc0">(<span class="fca">self</span><span class="ws4">, node):</span></span></span></div><div class="t m0 x16 hf y1f98 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">node<span class="fc6 ls34">.</span>value</span></div><div class="t m0 x15 hf y1f99 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Add<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1f9a ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">(</span>yield <span class="ff8 fc0 ws13a">node<span class="fc6 ls34">.</span><span class="ws15f">left) <span class="fc6 ls33">+</span></span>(</span><span class="ws83b">yield <span class="ff8 fc0 ws13a">node<span class="fc6">.</span>right)</span></span></div><div class="t m0 x15 hf y1f9b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Sub<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1f9c ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">(</span>yield <span class="ff8 fc0 ws13a">node<span class="fc6 ls34">.</span><span class="ws15f">left) <span class="fc6 ls33">-</span></span>(</span><span class="ws83b">yield <span class="ff8 fc0 ws13a">node<span class="fc6">.</span>right)</span></span></div><div class="t m0 x15 hf y1f9d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Mul<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1f9e ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">(</span>yield <span class="ff8 fc0 ws13a">node<span class="fc6 ls34">.</span><span class="ws15f">left) <span class="fc6 ls33">*</span></span>(</span><span class="ws83b">yield <span class="ff8 fc0 ws13a">node<span class="fc6">.</span>right)</span></span></div><div class="t m0 x15 hf y1f9f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Div<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 hf y1fa0 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ls34">(</span>yield <span class="ff8 fc0 ws13a">node<span class="fc6 ls34">.</span><span class="ws15f">left) <span class="fc6 ls33">/</span></span>(</span><span class="ws83b">yield <span class="ff8 fc0 ws13a">node<span class="fc6">.</span>right)</span></span></div><div class="t m0 x15 hf y1fa1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_Negate<span class="fc0">(<span class="fca">self</span><span class="ws4">, node):</span></span></span></div><div class="t m0 x16 hf y1fa2 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc6 ls33">-<span class="fc0 ls0 ws13a">(</span></span><span class="ws83b">yield <span class="ff8 fc0 ws13a">node<span class="fc6">.</span>operand)</span></span></div><div class="t m0 x0 h9 y1fa3 ff1 fs3 fc0 sc0 ls0">再次运行，就不会报错了：</div><div class="t m0 x5 hf y1fa4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">Number(<span class="fc7 ls34">0</span>)</span></span></div><div class="t m0 x5 hf y1fa5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">,<span class="fc7">100000</span>):</span></span></span></span></span></div><div class="t m0 x5 hf y1c15 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13b">Add(a, Number(n))</span></span></div><div class="t m0 x5 h10 y1fa6 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y1fa7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">e<span class="fc6 ls33">=</span><span class="ls0">Evaluator()</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.22.<span class="_ _5"> </span>8.22 <span class="ff1 wsb03">不用递归实现访问者模式 </span>290</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
