<div id="pf1ae" class="pf w0 h0" data-page-no="1ae"><div class="pc pc1ae w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ae.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1e8 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">RPCProxy<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1e9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, connection):</span></span></span></div><div class="t m0 x16 hf y1ea ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">_connection </span><span class="ls33">=</span><span class="fc0">connection</span></span></div><div class="t m0 x15 hf y903 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__getattr__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, name):</span></span></span></div><div class="t m0 x16 hf y1eb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">do_rpc<span class="fc0 ls34">(<span class="fc6">*</span><span class="ls0 ws15f">args, </span></span><span class="fc6">**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x17 hf y1ec ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_connection</span><span class="ls34">.</span><span class="fc0">send(json</span>.<span class="fc0 ws4">dumps((name, args, kwargs)))</span></span></div><div class="t m0 x17 hf y904 ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="ws13a">json<span class="fc6 ls34">.</span>loads(<span class="fca">self<span class="fc6 ls34">.</span></span>_connection<span class="fc6 ls34">.</span>recv())</span></div><div class="t m0 x17 hf y905 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">result</span></div><div class="t m0 x16 hf y906 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">do_rpc</span></div><div class="t m0 x0 h7 y2bd0 ff1 fs3 fc0 sc0 ls0 ws2c2">实现 <span class="ff4 wsfa3">RPC </span><span class="ls3d ws164">的一个比较复杂的问题是如何去处理异常。至少，当方法产生异常时服</span></div><div class="t m0 x5 h9 y2bd1 ff1 fs3 fc0 sc0 ls1e ws111">务器不应该奔溃<span class="_ _1"></span>。因此，返回给客户<span class="_ _1"></span>端的异常所代表的含义就要好好设计了<span class="_ _1"></span>。如果你</div><div class="t m0 x5 h7 y1835 ff1 fs3 fc0 sc0 ls0 ws2c8">使用 <span class="ff4 wsa5">pic<span class="_ _1"></span>kle<span class="ff1 wsa0">，异常对象实例在客户端能被反序列化并抛出。如果你使用其他的协议，那</span></span></div><div class="t m0 x5 h7 y2bd2 ff1 fs3 fc0 sc0 ls6b wsfa4">得想想另外的方法了。不过至少<span class="_ _c"></span>，你应该在响应中返回异常字符串。我们在 <span class="ff4 ls0 ws7bc">JSON <span class="ff1">的</span></span></div><div class="t m0 x5 h9 y2bd3 ff1 fs3 fc0 sc0 ls0">例子中就是使用的这种方式。</div><div class="t m0 x0 h7 y2bd4 ff1 fs3 fc0 sc0 ls0 wsfa5">对 于 其 他 的<span class="_ _32"> </span><span class="ff4 wsfa6">RPC </span>实 现 例 子，<span class="_ _a"> </span>我<span class="_ _a"> </span>推 荐 你 看 看 在<span class="_ _36"> </span><span class="ff4 wsfa7">XML-RPC </span><span class="wsfa8">中 使 用 的</span></div><div class="t m0 x5 h7 y2bd5 ff6 fs3 fc0 sc0 ls0 ws59a">SimpleXMLRPCServer <span class="ff1 ls4">和</span><span class="ws133">ServerProxy <span class="ff1 ws38">的实现，也就是 <span class="ff4 ws1d0">11.6 </span>小节中的内容。</span></span></div><div class="t m0 x5 hd y2bd6 ff2 fs4 fc4 sc0 ls0 ws211">13.9<span class="_ _e"> </span>11.9 <span class="ff1">简单的客户端认证</span></div><div class="t m0 x5 he y2bd7 ff2 fs2 fc4 sc0 ls0 ws212">13.9.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y2bd8 ff1 fs3 fc0 sc0 ls13 wsfa9">你想在分布式系统中实现一个简单的客户端连接认证功能<span class="_ _1"></span>，又不想像 <span class="ff4 ls0 wsfaa">SSL <span class="ff1 wsa0">那<span class="_ _6"></span>样的</span></span></div><div class="t m0 x5 h9 y2bd9 ff1 fs3 fc0 sc0 ls0">复杂。</div><div class="t m0 x5 he y831 ff2 fs2 fc4 sc0 ls0 ws212">13.9.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y2bda ff1 fs3 fc0 sc0 ls0 wsfab">可以<span class="_ _6"></span>利用 <span class="ff6 ws27f">hmac </span><span class="lse wsd8">模块实现一个连接握手，从而实现一个简单而高效的认证过程。下</span></div><div class="t m0 x5 h9 y2bdb ff1 fs3 fc0 sc0 ls0">面是代码示例：</div><div class="t m0 x5 h10 y2bdc ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">hmac</span></div><div class="t m0 x5 h10 y2bdd ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">os</span></div><div class="t m0 x5 hf y2bde ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">client_authenticate<span class="fc0 ws13b">(connection, secret_key):</span></span></div><div class="t m0 x15 h15 y2bdf ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y2be0 ffa fs5 fc9 sc0 ls0 ws4">Authenticate client to a remote service.</div><div class="t m0 x15 h11 y2be1 ffa fs5 fc9 sc0 ls0 ws4">connection represents a network connection.</div><div class="t m0 x15 h11 y2be2 ffa fs5 fc9 sc0 ls0 ws4">secret_key is a key known only to both client/server.</div><div class="t m0 x15 h15 y2be3 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y2be4 ff8 fs5 fc0 sc0 ls0 ws155">message <span class="fc6 ls32">=</span><span class="ws13a">connection<span class="fc6 ls34">.</span>recv(<span class="fc7">32</span>)</span></div><div class="t m0 x15 hf y2be5 ff8 fs5 fca sc0 ls0 ws13c">hash <span class="fc6 ls32">=</span><span class="fc0 ws13a">hmac<span class="fc6 ls34">.</span><span class="ws13b">new(secret_key, message)</span></span></div><div class="t m0 x15 hf y2be6 ff8 fs5 fc0 sc0 ls0 ws145">digest <span class="fc6 ls32">=</span><span class="fca ws13a">hash<span class="fc6 ls34">.</span></span>digest()</div><div class="t m0 x15 hf y270c ff8 fs5 fc0 sc0 ls0 ws13a">connection<span class="fc6 ls34">.</span>send(digest)</div><div class="t m0 x5 hf y2be7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">server_authenticate<span class="fc0 ws13b">(connection, secret_key):</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.9.<span class="_ _36"> </span>11.9 <span class="ff1 ws533">简单的客户端认证 </span>421</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
