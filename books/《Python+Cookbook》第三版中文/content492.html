<div id="pf1ec" class="pf w0 h0" data-page-no="1ec"><div class="pc pc1ec w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ec.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 h11 y1ab ffa fs5 fcd sc0 ls0 ws4"># be called using line = yield from readline(sock)</div><div class="t m0 x15 hf y1ac ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">readline<span class="fc0">(sock):</span></span></div><div class="t m0 x16 hf y1ad ff8 fs5 fc0 sc0 ls0 ws15f">chars <span class="fc6 ls33">=</span>[]</div><div class="t m0 x16 hf y1ae ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1af ff8 fs5 fc0 sc0 ls32">c<span class="fc6 ls33">=<span class="ff7 fca ls0 ws16a">yield </span></span><span class="ls0 ws13a">sock<span class="fc6 ls34">.</span>recv(<span class="fc7 ls34">1</span>)</span></div><div class="t m0 x17 hf y1b0 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">c:</span></div><div class="t m0 x18 h10 y355 ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x17 hf y410 ff8 fs5 fc0 sc0 ls0 ws13a">chars<span class="fc6 ls34">.</span>append(c)</div><div class="t m0 x17 hf y411 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ls32">c<span class="fc6 ls0 ws15c">== <span class="fc0 ws13a">b<span class="ff9 fc9 ls34">&apos;</span></span></span></span><span class="fc9 ws156">\n<span class="ff9 ls34">&apos;</span><span class="ff8 fc0">:</span></span></div><div class="t m0 x18 h10 yba ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x16 hf y8c6 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ls34">b</span><span class="ff9 fc9 ws13b">&apos;&apos;<span class="ff8 fc6 ls34">.<span class="fc0 ls0">join(chars)</span></span></span></div><div class="t m0 x15 h11 ybee ffa fs5 fcd sc0 ls0 ws4"># Echo server using generators</div><div class="t m0 x15 hf ybef ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">EchoServer<span class="ff8 fc0">:</span></span></div><div class="t m0 x16 hf ybf0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>,addr,sched):</span></span></div><div class="t m0 x17 hf yd7d ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">sched </span><span class="ls32">=</span><span class="fc0">sched</span></span></div><div class="t m0 x17 hf ybf1 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span>new(<span class="fca">self<span class="fc6 ls34">.</span></span>server_loop(addr))</div><div class="t m0 x16 hf ybf3 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">server_loop<span class="fc0">(<span class="fca">self</span>,addr):</span></span></div><div class="t m0 x17 hf ybf4 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">Socket(socket(AF_INET,SOCK_STREAM))</span></div><div class="t m0 x17 hf ybf6 ff8 fs5 fc0 sc0 ls0 ws13a">s<span class="fc6 ls34">.</span>bind(addr)</div><div class="t m0 x17 hf ybf7 ff8 fs5 fc0 sc0 ls0 ws13a">s<span class="fc6 ls34">.</span>listen(<span class="fc7 ls34">5</span>)</div><div class="t m0 x17 hf ybf8 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 hf ybf9 ff8 fs5 fc0 sc0 ls0 ws158">c,a <span class="fc6 ls32">=</span><span class="ff7 fca ws16a">yield </span><span class="ls34">s<span class="fc6">.</span></span>accept()</div><div class="t m0 x18 hf ybfa ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Got connection from </span>&apos;</span><span class="ls0 ws13b">, a)</span></span></div><div class="t m0 x18 hf ybfb ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">sched</span><span class="ls34">.</span><span class="fc0">new(</span></span>self<span class="fc6 ls34">.</span><span class="fc0">client_handler(Socket(c)))</span></div><div class="t m0 x16 hf y1ed7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">client_handler<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">,client):</span></span></span></div><div class="t m0 x17 hf y1ed8 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 hf y1f83 ff8 fs5 fc0 sc0 ls0 ws161">line <span class="fc6 ls33">=</span><span class="ff7 fca ws583">yield from </span>readline(client)</div><div class="t m0 x18 hf y1ed9 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">line:</span></div><div class="t m0 x29 h10 y1eda ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x18 hf y1edb ff8 fs5 fc0 sc0 ls0 ws161">line <span class="fc6 ls33">=</span><span class="ws13a">b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">GOT:<span class="ff9 ls33">&apos;</span><span class="fc6 ls32">+</span></span>line</span></div><div class="t m0 x18 hf y1f84 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0">line:</span></div><div class="t m0 x29 hf y2515 ff8 fs5 fc0 sc0 ls0 ws15f">nsent <span class="fc6 ls32">=</span><span class="ff7 fca ws83b">yield </span><span class="ws13a">client<span class="fc6 ls34">.</span>send(line)</span></div><div class="t m0 x29 hf y1edc ff8 fs5 fc0 sc0 ls0 ws161">line <span class="fc6 ls33">=</span>line[nsent:]</div><div class="t m0 x17 hf y1edd ff8 fs5 fc0 sc0 ls0 ws13a">client<span class="fc6 ls34">.</span>close()</div><div class="t m0 x17 hf y1ede ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Client closed</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x15 hf y1ee0 ff8 fs5 fc0 sc0 ls0 ws15f">sched <span class="fc6 ls33">=</span>Scheduler()</div><div class="t m0 x15 hf y2516 ff8 fs5 fc0 sc0 ls0 ws13a">EchoServer((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls34">,</span><span class="fc7">16000</span>),sched)</div><div class="t m0 x15 hf y1ee1 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6">.</span>run()</div><div class="t m0 x0 h9 y30ad ff1 fs3 fc0 sc0 ls24 ws11d">这段代码有点复杂<span class="_ _c"></span>。不过<span class="_ _1"></span>，它实现了一个小型的操作系统<span class="_ _1"></span>。有一个就绪的任务队<span class="_ _c"></span></div><div class="t m0 x5 h7 y30ae ff1 fs3 fc0 sc0 ls0 ws118c">列，并且还<span class="_ _6"></span>有因 <span class="ff4 ws118d">I/O </span><span class="ls51 ws118e">休眠的任务等待区域。还有很多调度器负责在就绪队列和 </span><span class="ff4 ws118d">I/O </span>等</div><div class="t m0 x5 h9 y30af ff1 fs3 fc0 sc0 ls0">待区域之间移动任务。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.12.<span class="_ _36"> </span>12.12 <span class="ff1 ws104c">使用生成器代替线程 </span>483</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
