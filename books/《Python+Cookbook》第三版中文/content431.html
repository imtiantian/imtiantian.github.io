<div id="pf1af" class="pf w0 h0" data-page-no="1af"><div class="pc pc1af w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1af.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 h15 y765 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y766 ffa fs5 fc9 sc0 ls0 ws13b">Request client authentication.</div><div class="t m0 x15 h15 y767 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y768 ff8 fs5 fc0 sc0 ls0 ws155">message <span class="fc6 ls32">=</span><span class="ws13a">os<span class="fc6">.</span>urandom(<span class="fc7">32</span>)</span></div><div class="t m0 x15 hf y769 ff8 fs5 fc0 sc0 ls0 ws13a">connection<span class="fc6 ls34">.</span>send(message)</div><div class="t m0 x15 hf y76a ff8 fs5 fca sc0 ls0 ws13c">hash <span class="fc6 ls32">=</span><span class="fc0 ws13a">hmac<span class="fc6 ls34">.</span><span class="ws13b">new(secret_key, message)</span></span></div><div class="t m0 x15 hf y76b ff8 fs5 fc0 sc0 ls0 ws145">digest <span class="fc6 ls32">=</span><span class="fca ws13a">hash<span class="fc6 ls34">.</span></span>digest()</div><div class="t m0 x15 hf y76c ff8 fs5 fc0 sc0 ls0 ws1f5">response <span class="fc6 ls33">=</span><span class="ws13a">connection<span class="fc6 ls34">.</span>recv(<span class="fca">len</span>(digest))</span></div><div class="t m0 x15 hf y842 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">hmac<span class="fc6 ls34">.</span>compare_digest(digest,response)</span></div><div class="t m0 x0 h9 y2be8 ff1 fs3 fc0 sc0 ls3a ws153">基本原理是当连接建立后，服务器给客户端发送一个随机的字节消息（这里例子中</div><div class="t m0 x5 h7 y2be9 ff1 fs3 fc0 sc0 ls0 ws219">使用了 <span class="ff6 wsfac">os.urandom() </span><span class="ls2b wsfad">返回值）<span class="_ _f"></span>。客户端和服务器同时利用 <span class="ff4 ls0 wsfae">hmac </span><span class="ws12e">和一个只有双方知道</span></span></div><div class="t m0 x5 h9 y2bea ff1 fs3 fc0 sc0 ls13 wse5">的密钥来计算出一个加密哈希值<span class="_ _1"></span>。然后客户端将它计算出的摘要发送给服务器，服务<span class="_ _c"></span></div><div class="t m0 x5 h9 y2beb ff1 fs3 fc0 sc0 ls2d ws132">器通过比较这个值和自己计算的是否一致来决定接受或拒绝连接。摘要的比较需要使<span class="_ _1"></span></div><div class="t m0 x5 h9 y2bec ff1 fs3 fc0 sc0 ls124">用<span class="ff6 ls0 wsfaf">hmac.compare digest() </span><span class="ls6b ws28f">函数。使用这个函数可以避免遭到时间分析攻击<span class="_ _1"></span>，不要用</span></div><div class="t m0 x5 h7 y2bed ff1 fs3 fc0 sc0 ls17 wsf6">简单的比较操作符（<span class="ff4 ls0 wsa5">==</span>）<span class="_ _2e"></span>。为了使用这些函数，你需要将它集成到已有的网络或消息</div><div class="t m0 x5 h7 yac6 ff1 fs3 fc0 sc0 ls0 ws38">代码中。例如，对于 <span class="ff4 wsa5">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>ets<span class="ff1">，服务器代码应该类似下面：</span></span></div><div class="t m0 x5 hf y2bee ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 hf y2bef ff8 fs5 fc0 sc0 ls0 ws2a3">secret_key <span class="fc6 ls32">=</span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">peekaboo<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y2bf0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_handler<span class="fc0">(client_sock):</span></span></div><div class="t m0 x15 hf y2bf1 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0 ws4">server_authenticate(client_sock, secret_key):</span></div><div class="t m0 x16 hf y2bf2 ff8 fs5 fc0 sc0 ls0 ws13a">client_sock<span class="fc6 ls34">.</span>close()</div><div class="t m0 x16 h10 y2bf3 ff7 fs5 fca sc0 ls0">return</div><div class="t m0 x15 hf y4bf ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2bf4 ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ws13a">client_sock<span class="fc6 ls34">.</span>recv(<span class="fc7">8192</span>)</span></div><div class="t m0 x16 hf y2bf5 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">msg:</span></div><div class="t m0 x17 h10 y2bf6 ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x16 hf y2bf7 ff8 fs5 fc0 sc0 ls0 ws13a">client_sock<span class="fc6 ls34">.</span>sendall(msg)</div><div class="t m0 x5 hf y2bf8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_server<span class="fc0">(address):</span></span></div><div class="t m0 x15 hf y2bf9 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></div><div class="t m0 x15 hf y2bfa ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bind(address)</span></span></div><div class="t m0 x15 hf y2bfb ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">listen(</span></span><span class="fc7">5</span><span class="ls0">)</span></div><div class="t m0 x15 hf y2bfc ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2bfd ff8 fs5 fc0 sc0 ls0 ws158">c,a <span class="fc6 ls32">=</span><span class="ls34">s<span class="fc6">.</span></span>accept()</div><div class="t m0 x16 hf y2bfe ff8 fs5 fc0 sc0 ls0">echo_handler(c)</div><div class="t m0 x5 hf y2bff ff8 fs5 fc0 sc0 ls0 ws13a">echo_server((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls32">,</span><span class="fc7">18000</span>))</div><div class="t m0 x5 hf y2c00 ff8 fs5 fc0 sc0 ls0 ws4">Within a client, you would do this:</div><div class="t m0 x5 hf y2c01 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x5 hf y2c02 ff8 fs5 fc0 sc0 ls0 ws2a3">secret_key <span class="fc6 ls32">=</span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">peekaboo<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y2c03 ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></div><div class="t m0 x5 hf y2c04 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">connect((</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">localhost</span>&apos;</span><span class="ls32">,<span class="fc7 ls0 ws13a">18000<span class="fc0">))</span></span></span></div><div class="t m0 x5 hf y2c05 ff8 fs5 fc0 sc0 ls0 ws4">client_authenticate(s, secret_key)</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.9.<span class="_ _36"> </span>11.9 <span class="ff1 ws533">简单的客户端认证 </span>422</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
