<div id="pf25d" class="pf w0 h0" data-page-no="25d"><div class="pc pc25d w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg25d.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h7 y2a ff1 fs3 fc0 sc0 ls0 ws38">另外，你还可以使用 <span class="ff6 ws2dc">PyUnicode<span class="_ _7"> </span>FromWideChar() <span class="ff4">:</span></span></div><div class="t m0 x5 hf y212 ff8 fs5 fc0 sc0 ls0 ws16d">PyObject <span class="fc6 ws13a">*</span><span class="ws158">obj <span class="fc6 ls33">=</span><span class="ws8c0">PyUnicode_FromWideChar(w, <span class="fca ws13a">len</span>);</span></span></div><div class="t m0 x0 h7 y3a0e ff1 fs3 fc0 sc0 ls56 ws15ac">对于宽字符串<span class="_ _c"></span>，并没有对字符数据进行解析—<span class="_ _19"></span>—它被假定是原始 <span class="ff4 ls0 ws15ad">Unico<span class="_ _6"></span>de <span class="ff1 wsa0">编<span class="_ _6"></span>码<span class="_ _0"></span>指</span></span></div><div class="t m0 x5 h7 y3a0f ff1 fs3 fc0 sc0 ls0 ws14">针，可以被直接转换成 <span class="ff4 wsa5">Python</span>。</div><div class="t m0 x5 he y3a10 ff2 fs2 fc4 sc0 ls0 wsadf">17.15.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y3a11 ff1 fs3 fc0 sc0 ls163">将<span class="ff4 ls2a5">C</span><span class="ls0 ws3e5">中的字符串转换为 <span class="ff4 ws13ab">Python </span><span class="ws15ae">字符串遵循和 <span class="ff4 ws15af">I/O </span><span class="ws15b0">同样的原则。<span class="_ _c"></span>也就是说，<span class="_ _1"></span>来自 <span class="ff4">C</span></span></span></span></div><div class="t m0 x5 h7 y3a12 ff1 fs3 fc0 sc0 ls2c ws15b1">中的数据必须根据一些解码器被显式的解码为一个字符串。通常编码格式包括 <span class="ff4 ls0 wsa5">ASCII<span class="ff1">、</span></span></div><div class="t m0 x5 h7 y3a13 ff4 fs3 fc0 sc0 ls0 ws650">Latin-1 <span class="ff1 ls11f">和</span><span class="ws15b2">UTF-8. <span class="ff1 lse wsd8">如果你并不确定编码方式或者数据是二进制的，你最好将字符串编<span class="_ _c"></span></span></span></div><div class="t m0 x5 h7 y3a14 ff1 fs3 fc0 sc0 ls18 ws110">码成字节。当构造一个对象的时候<span class="_ _1"></span>，<span class="ff4 ls0 ws453">Python </span>通常会复制你提供的字符串数据。如果有</div><div class="t m0 x5 h7 y3a15 ff1 fs3 fc0 sc0 ls0 ws15b3">必要<span class="_ _6"></span>的话，你<span class="_ _6"></span>需要<span class="_ _6"></span>在后<span class="_ _6"></span>面去释<span class="_ _6"></span>放 <span class="ff4 ls265">C</span><span class="ls19 ws22a">字符串。同时<span class="_ _1"></span>，为了让程序更加健壮，你应该同时</span></div><div class="t m0 x5 h7 y3a16 ff1 fs3 fc0 sc0 ls0 ws14">使用一个指针和一个大小值，而不是依赖 <span class="ff4 wsbe">NULL </span>结尾数据来创建字符串。</div><div class="t m0 x5 hd y3a17 ff2 fs4 fc4 sc0 ls0 wsd91">17.16<span class="_ _e"> </span>15.16 <span class="ff1 ws165">不确定编码格式的 </span><span class="ls23d">C</span><span class="ff1">字符串</span></div><div class="t m0 x5 he y3a18 ff2 fs2 fc4 sc0 ls0 wsadf">17.16.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y3a19 ff1 fs3 fc0 sc0 ls3a ws15b4">你要在 <span class="ff4 ls288">C</span><span class="ls102">和<span class="ff4 ls0 ws4eb">Python <span class="ff1 ws15b5">直接来回转换字符<span class="_ _6"></span>串，但是 </span><span class="ls2a6">C</span><span class="ff1 wsa0">中的编码格式并不确<span class="_ _6"></span>定。例如，</span></span></span></div><div class="t m0 x5 h7 y3a1a ff1 fs3 fc0 sc0 ls0 ws15b6">可能 <span class="ff4 ls248">C</span><span class="ls68 ws15b7">中的数据期望是 </span><span class="ff4 wsa5">UTF-8</span><span class="ls68 ws23f">，但是并没有强制它必须是。你想编写代码来以一种优</span></div><div class="t m0 x5 h7 y3a1b ff1 fs3 fc0 sc0 ls0 wsfb7">雅的方式处理这些不合格数据，这样就不会让 <span class="ff4 wse61">Python </span>奔溃或者破坏进程中的字符串数</div><div class="t m0 x5 h9 y3a1c ff1 fs3 fc0 sc0 ls0">据。</div><div class="t m0 x5 he y10f7 ff2 fs2 fc4 sc0 ls0 wsadf">17.16.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y3a1d ff1 fs3 fc0 sc0 ls0 ws38">下面是一些 <span class="ff4 ls8">C</span>的数据和一个函数来演示这个问题：</div><div class="t m0 x5 hf y23b2 ff8 fs5 fc0 sc0 ls0 ws4">/* Some dubious string data (malformed UTF-8) */</div><div class="t m0 x5 hf y3a1e ff8 fs5 fc0 sc0 ls0 ws4">const char *sdata = &quot;Spicy Jalape\xc3\xb1o\xae&quot;;</div><div class="t m0 x5 hf y3a1f ff8 fs5 fc0 sc0 ls0 ws4">int slen = 16;</div><div class="t m0 x5 hf y3a20 ff8 fs5 fc0 sc0 ls0 ws4">/* Output character data */</div><div class="t m0 x5 hf y3a21 ff8 fs5 fc0 sc0 ls0 ws4">void print_chars(char *s, int len) {</div><div class="t m0 x19 hf y3a22 ff8 fs5 fc0 sc0 ls0 ws4">int n = 0;</div><div class="t m0 x19 hf y3a23 ff8 fs5 fc0 sc0 ls0 ws4">while (n &lt; len) {</div><div class="t m0 x15 hf y3a24 ff8 fs5 fc0 sc0 ls0 ws4">printf(&quot;%2x &quot;, (unsigned char) s[n]);</div><div class="t m0 x15 hf y3a25 ff8 fs5 fc0 sc0 ls0">n++;</div><div class="t m0 x19 hf y3a26 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3814 ff8 fs5 fc0 sc0 ls0">printf(&quot;\n&quot;);</div><div class="t m0 x5 hf y3a27 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y2b96 ff1 fs3 fc0 sc0 ls18 ws10f1">在这个代码中，字符串 <span class="ff6 ls0 ws819">sdata </span><span class="ws144b">包含了 <span class="ff4 ls0 ws15b8">UTF-8 </span><span class="ws15b9">和不合格数据。不过<span class="_ _1"></span>，如果用户在 <span class="ff4 ls0">C</span></span></span></div><div class="t m0 x5 h9 y3a28 ff1 fs3 fc0 sc0 ls40 ws195">中调用 <span class="ff6 ls0 ws149">print chars(sdata,<span class="_ _1c"> </span>slen)<span class="_ _7"> </span><span class="ff1 ws15ba">，<span class="_ _6"></span>它<span class="_ _6"></span>缺<span class="_ _6"></span>能<span class="_ _6"></span>正<span class="_ _6"></span>常<span class="_ _6"></span>工<span class="_ _6"></span>作。<span class="_ _6"></span>现<span class="_ _6"></span>在假<span class="_ _6"></span>设<span class="_ _6"></span>你<span class="_ _6"></span>想<span class="_ _6"></span>将 </span><span class="ws15bb">sdata <span class="ff1 wsa0">的<span class="_ _6"></span>内</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.16.<span class="_ _36"> </span>15.16 <span class="ff1 ws16b">不确定编码格式的 </span><span class="ls246">C</span><span class="ff1 ws15bc">字符串 </span>596</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
