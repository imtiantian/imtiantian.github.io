<div id="pfd1" class="pf w0 h0" data-page-no="d1"><div class="pc pcd1 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgd1.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0 wsc">使用新的 <span class="ff6 ws1d1">Structure </span>类，你可以像下面这样定义一个结构：</div><div class="t m0 x5 hf y212 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PolyHeader<span class="ff8 fc0">(Structure):</span></span></div><div class="t m0 x15 hf y213 ff8 fs5 fc0 sc0 ls0 ws1f5">_fields_ <span class="fc6 ls33">=</span>[</div><div class="t m0 x16 hf y214 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;<span class="ff8 ws13a">&lt;i</span>&apos;</span><span class="ls33">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">file_code</span>&apos;</span><span class="ls0">),</span></div><div class="t m0 x16 hf y215 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">d<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">min_x</span><span class="ls0 ws13b">&apos;</span></span><span class="ls0">),</span></div><div class="t m0 x16 hf y216 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">d<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">min_y</span><span class="ls0 ws13b">&apos;</span></span><span class="ls0">),</span></div><div class="t m0 x16 hf y217 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">d<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">max_x</span><span class="ls0 ws13b">&apos;</span></span><span class="ls0">),</span></div><div class="t m0 x16 hf y218 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">d<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">max_y</span><span class="ls0 ws13b">&apos;</span></span><span class="ls0">),</span></div><div class="t m0 x16 hf y16b0 ff8 fs5 fc0 sc0 ls34">(<span class="ff9 fc9 ls0 ws13b">&apos;</span><span class="fc9">i<span class="ff9">&apos;</span></span><span class="ls32">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">num_polys</span>&apos;</span><span class="ls0">)</span></div><div class="t m0 x15 hf y16b1 ff8 fs5 fc0 sc0 ls0">]</div><div class="t m0 x0 h9 y16ce ff1 fs3 fc0 sc0 ls0 ws8dc">正如你所见，这样写就简单多了。<span class="_ _c"></span>我们添加的类方法 <span class="ff6 ws311">from<span class="_ _7"> </span>file() </span>让我们在不需要</div><div class="t m0 x5 h9 y16cf ff1 fs3 fc0 sc0 ls0">知道任何数据的大小和结构的情况下就能轻松的从文件中读取数据。比如：</div><div class="t m0 x5 hf y9f7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=<span class="fca ls0 ws13a">open<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">polys.bin<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ls34">&apos;</span></span>)</span></span></span></span></div><div class="t m0 x5 hf y16d0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">phead <span class="fc6 ls33">=</span><span class="ws13a">PolyHeader<span class="fc6 ls34">.</span>from_file(f)</span></span></div><div class="t m0 x5 hf y51e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span><span class="ws51e">file_code <span class="fc6 ws159">== <span class="fc7">0x1234</span></span></span></span></div><div class="t m0 x5 hf y51f ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y16d1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>min_x</span></div><div class="t m0 x5 hf y16d2 ff8 fs5 fc8 sc0 ls0">0.5</div><div class="t m0 x5 hf y16d3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>min_y</span></div><div class="t m0 x5 hf y16d4 ff8 fs5 fc8 sc0 ls0">0.5</div><div class="t m0 x5 hf y16d5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>max_x</span></div><div class="t m0 x5 hf y16d6 ff8 fs5 fc8 sc0 ls0">7.0</div><div class="t m0 x5 hf y16d7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>max_y</span></div><div class="t m0 x5 hf y16d8 ff8 fs5 fc8 sc0 ls0">9.2</div><div class="t m0 x5 hf y16d9 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>num_polys</span></div><div class="t m0 x5 hf y16da ff8 fs5 fc8 sc0 ls0">3</div><div class="t m0 x5 hf y16db ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y16dc ff1 fs3 fc0 sc0 ls0 wsa0">一旦你开始使用了元<span class="_ _6"></span>类，你就可以让它变得更加<span class="_ _6"></span>智能。例如，假设你还想支<span class="_ _6"></span>持嵌套</div><div class="t m0 x5 h9 y16dd ff1 fs3 fc0 sc0 ls13 wse5">的字节结构<span class="_ _1"></span>，下面是对前面元类的一个小的改进，提供了一个新的辅助描述器来达到<span class="_ _c"></span></div><div class="t m0 x5 h9 y16de ff1 fs3 fc0 sc0 ls0">想要的效果：</div><div class="t m0 x5 hf y16df ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">NestedStruct<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h15 y16e0 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y16e1 ffa fs5 fc9 sc0 ls0 ws4">Descriptor representing a nested structure</div><div class="t m0 x15 h15 y16e2 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y16e3 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name, struct_type, offset):</span></span></span></div><div class="t m0 x16 hf y16e4 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x16 hf y16e5 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">struct_type </span><span class="ls33">=</span><span class="fc0">struct_type</span></span></div><div class="t m0 x16 hf y16e6 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">offset </span><span class="ls32">=</span><span class="fc0">offset</span></span></div><div class="t m0 x15 hf y16e7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__get__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, cls):</span></span></span></div><div class="t m0 x16 hf y16e8 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">instance </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y16e9 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x16 hf y16ea ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y16eb ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="ws13a">instance<span class="fc6">.</span>_buffer[<span class="fca">self<span class="fc6 ls34">.</span></span>offset:</span></div><div class="t m0 x23 hf y16ec ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">offset<span class="fc6 ls34">+</span></span>self<span class="fc6 ls34">.</span><span class="fc0">struct_type<span class="fc6">.</span>struct_size]</span></div><div class="t m0 x17 hf y16ed ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span>struct_type(data)</div><div class="t m0 x17 h11 y16ee ffa fs5 fcd sc0 ls0 ws4"># Save resulting structure back on instance to avoid</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">8.12.<span class="_ _5"> </span>6.12 <span class="ff1 ws6e7">读取嵌套和可变长二进制数据 </span>200</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
