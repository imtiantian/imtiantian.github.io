<div id="pf1eb" class="pf w0 h0" data-page-no="1eb"><div class="pc pc1eb w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1eb.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x41 hf y15f ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws16e">_numtasks <span class="fc6 ws23d">-= <span class="fc7">1</span></span></span></div><div class="t m0 x5 h11 y956 ffa fs5 fcd sc0 ls0 ws4"># Example implementation of coroutine-based socket I/O</div><div class="t m0 x5 hf y957 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">ReadSocket<span class="ff8 fc0">(YieldEvent):</span></span></div><div class="t m0 x15 hf y958 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, sock, nbytes):</span></span></span></div><div class="t m0 x16 hf y959 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">sock </span><span class="ls33">=</span><span class="fc0">sock</span></span></div><div class="t m0 x16 hf y95a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">nbytes </span><span class="ls32">=</span><span class="fc0">nbytes</span></span></div><div class="t m0 x15 hf y95b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_yield<span class="fc0">(<span class="fca">self</span><span class="ws4">, sched, task):</span></span></span></div><div class="t m0 x16 hf y95c ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span>_read_wait(<span class="fca">self<span class="fc6 ls34">.</span></span>sock<span class="fc6">.</span><span class="ws51e">fileno(), </span><span class="fca">self</span><span class="ws13b">, task)</span></div><div class="t m0 x15 hf y9f3 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_resume<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, sched, task):</span></span></span></div><div class="t m0 x16 hf y9f4 ff8 fs5 fc0 sc0 ls0 ws161">data <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">sock<span class="fc6 ls34">.</span>recv(</span>self<span class="fc6">.</span></span>nbytes)</div><div class="t m0 x16 hf y95d ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span><span class="ws4">add_ready(task, data)</span></div><div class="t m0 x5 hf ybb7 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">WriteSocket<span class="ff8 fc0">(YieldEvent):</span></span></div><div class="t m0 x15 hf ybb8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, sock, data):</span></span></span></div><div class="t m0 x16 hf ybb9 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">sock </span><span class="ls33">=</span><span class="fc0">sock</span></span></div><div class="t m0 x16 hf ybba ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">data </span><span class="ls33">=</span><span class="fc0">data</span></span></div><div class="t m0 x15 hf ybbb ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_yield<span class="fc0">(<span class="fca">self</span><span class="ws4">, sched, task):</span></span></span></div><div class="t m0 x16 hf ybbd ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span>_write_wait(<span class="fca">self<span class="fc6 ls34">.</span></span>sock<span class="fc6 ls34">.</span><span class="ws16e">fileno(), </span><span class="fca">self</span><span class="ws4">, task)</span></div><div class="t m0 x15 hf ybbe ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_resume<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, sched, task):</span></span></span></div><div class="t m0 x16 hf ybbf ff8 fs5 fc0 sc0 ls0 ws15f">nsent <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">send(</span></span>self<span class="fc6 ls34">.</span></span>data)</div><div class="t m0 x16 hf ybc0 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span><span class="ws4">add_ready(task, nsent)</span></div><div class="t m0 x5 hf y2e16 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">AcceptSocket<span class="ff8 fc0">(YieldEvent):</span></span></div><div class="t m0 x15 hf y2e17 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, sock):</span></span></span></div><div class="t m0 x16 hf y30a7 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">sock </span><span class="ls33">=</span><span class="fc0">sock</span></span></div><div class="t m0 x15 hf y2e18 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_yield<span class="fc0">(<span class="fca">self</span><span class="ws4">, sched, task):</span></span></span></div><div class="t m0 x16 hf y2e19 ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span>_read_wait(<span class="fca">self<span class="fc6 ls34">.</span></span>sock<span class="fc6">.</span><span class="ws51e">fileno(), </span><span class="fca">self</span><span class="ws13b">, task)</span></div><div class="t m0 x15 hf y30a8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_resume<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, sched, task):</span></span></span></div><div class="t m0 x16 hf y30a9 ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=<span class="fca ls0 ws13a">self<span class="fc6">.<span class="fc0">sock</span><span class="ls34">.</span><span class="fc0">accept()</span></span></span></span></div><div class="t m0 x16 hf y30aa ff8 fs5 fc0 sc0 ls0 ws13a">sched<span class="fc6 ls34">.</span><span class="ws4">add_ready(task, r)</span></div><div class="t m0 x5 h11 yda4 ffa fs5 fcd sc0 ls0 ws4"># Wrapper around a socket object for use with yield</div><div class="t m0 x5 hf yda5 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Socket<span class="ff8 fc0 ws13a">(<span class="fca">object</span>):</span></span></div><div class="t m0 x15 hf yda6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, sock):</span></span></span></div><div class="t m0 x16 hf yda7 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">_sock </span><span class="ls32">=</span><span class="fc0">sock</span></span></div><div class="t m0 x15 hf yda8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">recv<span class="fc0">(<span class="fca">self</span><span class="ws4">, maxbytes):</span></span></span></div><div class="t m0 x16 hf yab6 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">ReadSocket(<span class="fca">self<span class="fc6 ls34">.</span></span><span class="ws13b">_sock, maxbytes)</span></span></div><div class="t m0 x15 hf yda9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">send<span class="fc0">(<span class="fca">self</span><span class="ws4">, data):</span></span></span></div><div class="t m0 x16 hf ydaa ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">WriteSocket(<span class="fca">self<span class="fc6">.</span></span><span class="ws4">_sock, data)</span></span></div><div class="t m0 x15 hf ydab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">accept<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y30ab ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">AcceptSocket(<span class="fca">self<span class="fc6 ls34">.</span></span>_sock)</span></div><div class="t m0 x15 hf y30ac ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__getattr__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, name):</span></span></span></div><div class="t m0 x16 hf y7c6 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">getattr<span class="fc0 ls34">(</span>self<span class="fc6">.<span class="fc0 ws4">_sock, name)</span></span></span></div><div class="t m0 x5 hf y7c8 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf ydad ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc0 ws13b">socket, AF_INET, SOCK_STREAM</span></span></span></div><div class="t m0 x15 h10 y20f7 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">time</span></div><div class="t m0 x15 h11 ydaf ffa fs5 fcd sc0 ls0 ws4"># Example of a function involving generators.<span class="_ _29"> </span>This should</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.12.<span class="_ _36"> </span>12.12 <span class="ff1 ws104c">使用生成器代替线程 </span>482</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
