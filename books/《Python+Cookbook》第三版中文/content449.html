<div id="pf1c1" class="pf w0 h0" data-page-no="1c1"><div class="pc pc1c1 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1c1.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 wsd91">13.13<span class="_ _e"> </span>11.13 <span class="ff1">发送与接收大型数组</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">13.13.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y2b2 ff1 fs3 fc0 sc0 ls0">你要通过网络连接发送和接受连续数据的大型数组，并尽量减少数据的复制操作。</div><div class="t m0 x5 he y2b3 ff2 fs2 fc4 sc0 ls0 wsadf">13.13.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y2b4 ff1 fs3 fc0 sc0 ls0 ws38">下面的函数利用 <span class="ff6 ws1e2">memoryviews </span>来发送和接受大数组：</div><div class="t m0 x5 h11 y2d48 ffa fs5 fcd sc0 ls0 ws4"># zerocopy.py</div><div class="t m0 x5 hf y2d49 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">send_from<span class="fc0 ws4">(arr, dest):</span></span></div><div class="t m0 x15 hf y2d4a ff8 fs5 fc0 sc0 ls0 ws13c">view <span class="fc6 ls32">=</span><span class="ws13a">memoryview(arr)<span class="fc6 ls34">.</span>cast(<span class="ff9 fc9 ls34">&apos;<span class="ff8">B</span><span class="ls0 ws13b">&apos;</span></span>)</span></div><div class="t m0 x15 hf y2d4b ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">len<span class="fc0">(view):</span></span></div><div class="t m0 x16 hf y2d4c ff8 fs5 fc0 sc0 ls0 ws15f">nsent <span class="fc6 ls33">=</span><span class="ws13a">dest<span class="fc6">.</span>send(view)</span></div><div class="t m0 x16 hf y2d4d ff8 fs5 fc0 sc0 ls0 ws161">view <span class="fc6 ls33">=</span>view[nsent:]</div><div class="t m0 x5 hf y2d4e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">recv_into<span class="fc0 ws4">(arr, source):</span></span></div><div class="t m0 x15 hf y2d4f ff8 fs5 fc0 sc0 ls0 ws13c">view <span class="fc6 ls32">=</span><span class="ws13a">memoryview(arr)<span class="fc6 ls34">.</span>cast(<span class="ff9 fc9 ls34">&apos;<span class="ff8">B</span><span class="ls0 ws13b">&apos;</span></span>)</span></div><div class="t m0 x15 hf y2574 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">len<span class="fc0">(view):</span></span></div><div class="t m0 x16 hf y2d50 ff8 fs5 fc0 sc0 ls0 ws15f">nrecv <span class="fc6 ls33">=</span><span class="ws13a">source<span class="fc6 ls34">.</span>recv_into(view)</span></div><div class="t m0 x16 hf y2d51 ff8 fs5 fc0 sc0 ls0 ws161">view <span class="fc6 ls33">=</span>view[nrecv:]</div><div class="t m0 x0 h7 y2d52 ff1 fs3 fc0 sc0 ls0 ws38">为了测试程序，首先创建一个通过 <span class="ff4 wsebb">so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="_ _1"></span>et <span class="ff1">连接的服务器和客户端程序：</span></span></div><div class="t m0 x5 hf y2d53 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc6">*</span></span></span></span></div><div class="t m0 x5 hf y2d54 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></span></div><div class="t m0 x5 hf y2d55 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">bind((<span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="ls33">,</span><span class="fc7">25000</span>))</span></span></span></div><div class="t m0 x5 hf y2d56 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">listen(</span></span><span class="fc7">1</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y2d57 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">c,a <span class="fc6 ls32">=</span><span class="ls34">s<span class="fc6">.</span></span>accept()</span></div><div class="t m0 x5 hf y2d58 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y2d59 ff1 fs3 fc0 sc0 ls0 wsa0">在客户端（另外一个解释器中）<span class="_ _f"></span>：</div><div class="t m0 x5 hf y2d5a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws146">socket <span class="fca">import <span class="ff8 fc6">*</span></span></span></span></div><div class="t m0 x5 hf y2d5b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0 ws13b">socket(AF_INET, SOCK_STREAM)</span></span></div><div class="t m0 x5 hf y2d5c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">c<span class="fc6 ls0 ws13a">.<span class="fc0">connect((</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">localhost</span>&apos;</span><span class="ls32">,<span class="fc7 ls0 ws13a">25000<span class="fc0">))</span></span></span></span></div><div class="t m0 x5 hf y2d5d ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y2d5e ff1 fs3 fc0 sc0 ls0 ws104b">本节的目标是你能通过连接传输一个超大数组。<span class="_ _c"></span>这种情况的话，可以通过 <span class="ff6 ws170">array </span>模</div><div class="t m0 x5 h9 y2d5f ff1 fs3 fc0 sc0 ls0 ws14">块或 <span class="ff6 ws17d">numpy </span>模块来创建数组：</div><div class="t m0 x5 h11 y2d60 ffa fs5 fcd sc0 ls0 ws4"># Server</div><div class="t m0 x5 hf y2d61 ff8 fs5 fc6 sc0 ls0 ws1a1">&gt;&gt;&gt; <span class="ff7 fca ws146">import <span class="fcc">numpy</span></span></div><div class="t m0 x5 hf y2d62 ff8 fs5 fc6 sc0 ls0 ws1a1">&gt;&gt;&gt; <span class="fc0 ls32">a</span><span class="ls33">=</span><span class="fc0 ws13a">numpy</span><span class="ls34">.</span><span class="fc0 ws13a">arange(<span class="fc7">0.0</span><span class="ls33">,</span><span class="fc7">50000000.0</span>)</span></div><div class="t m0 x5 hf ycd9 ff8 fs5 fc6 sc0 ls0 ws1a1">&gt;&gt;&gt; <span class="fc0 ws13b">send_from(a, c)</span></div><div class="t m0 x5 hf y2d63 ff8 fs5 fc6 sc0 ls0 ws13a">&gt;&gt;&gt;</div><div class="t m0 x5 h11 y2d64 ffa fs5 fcd sc0 ls0 ws4"># Client</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">13.13.<span class="_ _36"> </span>11.13 <span class="ff1 ws104c">发送与接收大型数组 </span>440</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
