<div id="pf264" class="pf w0 h0" data-page-no="264"><div class="pc pc264 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg264.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 wsadf">17.19.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y138 ff1 fs3 fc0 sc0 ls30 ws138">和普通系统文件不同的是，一个类文件对象并不需要使用低级文件描述符来构建<span class="_ _c"></span>。</div><div class="t m0 x5 h7 y139 ff1 fs3 fc0 sc0 ls0 ws15f0">因此，你不能<span class="_ _6"></span>使用普通的 <span class="ff4 lsd7">C</span><span class="wsc39">库函<span class="_ _6"></span>数来访问它。你<span class="_ _6"></span>需要使用 <span class="ff4 ws15f1">Python </span><span class="ls12d">的</span><span class="ff4 ws8a3">C API </span><span class="wsa0">来像普<span class="_ _6"></span>通</span></span></div><div class="t m0 x5 h9 y13a ff1 fs3 fc0 sc0 ls0">文件类似的那样操作类文件对象。</div><div class="t m0 x0 h9 y3a9b ff1 fs3 fc0 sc0 ls0 wsa0">在<span class="_ _6"></span>我们<span class="_ _6"></span>的<span class="_ _6"></span>解<span class="_ _6"></span>决<span class="_ _6"></span>方案<span class="_ _6"></span>中，<span class="_ _6"></span><span class="ff6 ws1227">read() </span><span class="ls13 wse5">方法从被传递的对象中提取出来<span class="_ _1"></span>。一个参数列表被</span></div><div class="t m0 x5 h7 y13c ff1 fs3 fc0 sc0 ls2c ws15f2">构建然后不断的被传给 <span class="ff6 ls0 ws617">PyObject Call() </span><span class="ws12f">来调用这个方法。要检查文件末尾（<span class="ff4 ls0 wsa5">EOF<span class="ff1 wsa0">）<span class="_ _f"></span>，</span></span></span></div><div class="t m0 x5 h7 y13d ff1 fs3 fc0 sc0 ls0 ws38">使用了 <span class="ff6 ws1f3">PySequence<span class="_ _7"> </span>Length() </span><span class="ws14">来查看是否返回对象长度为 <span class="ff4">0.</span></span></div><div class="t m0 x0 h7 y3a9c ff1 fs3 fc0 sc0 ls0 ws663">对<span class="_ _6"></span>于所<span class="_ _6"></span>有<span class="_ _6"></span>的 <span class="ff4 ws11a2">I/<span class="_ _6"></span>O </span><span class="ls13 ws87f">操作<span class="_ _1"></span>，你需要关注底层的编码格式，还有字节和 <span class="ff4 ls0 ws15f3">Unicode <span class="ff1 wsa0">之<span class="_ _6"></span>前<span class="_ _6"></span>的</span></span></span></div><div class="t m0 x5 h9 y3a9d ff1 fs3 fc0 sc0 ls1d ws1c3">区别<span class="_ _c"></span>。本节演示了如何以文本模式读取一个文件并将结果文<span class="_ _6"></span>本解码为一个字节编码<span class="_ _c"></span>，<span class="_ _1"></span></div><div class="t m0 x5 h7 y3330 ff1 fs3 fc0 sc0 ls0 ws15f4">这样<span class="_ _6"></span>在 <span class="ff4 ls20">C</span><span class="lse wsd8">中就可以使用它了。如果你想以二进制模式读取文件<span class="_ _1"></span>，只需要修改一点点即</span></div><div class="t m0 x5 h9 y3a9e ff1 fs3 fc0 sc0 ls0">可，例如：</div><div class="t m0 x5 hf y3a9f ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y3aa0 ff8 fs5 fc0 sc0 ls0 ws4">/* Call read() */</div><div class="t m0 x5 hf y3aa1 ff8 fs5 fc0 sc0 ls0 ws4">if ((data = PyObject_Call(read_meth, read_args, NULL)) == NULL) {</div><div class="t m0 x19 hf y3aa2 ff8 fs5 fc0 sc0 ls0 ws4">goto final;</div><div class="t m0 x5 hf y3aa3 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y3aa4 ff8 fs5 fc0 sc0 ls0 ws4">/* Check for EOF */</div><div class="t m0 x5 hf y3aa5 ff8 fs5 fc0 sc0 ls0 ws4">if (PySequence_Length(data) == 0) {</div><div class="t m0 x19 hf y3e ff8 fs5 fc0 sc0 ls0">Py_DECREF(data);</div><div class="t m0 x19 hf y3aa6 ff8 fs5 fc0 sc0 ls0">break;</div><div class="t m0 x5 hf y3aa7 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y134f ff8 fs5 fc0 sc0 ls0 ws4">if (!PyBytes_Check(data)) {</div><div class="t m0 x19 hf y3aa8 ff8 fs5 fc0 sc0 ls0">Py_DECREF(data);</div><div class="t m0 x19 hf y3aa9 ff8 fs5 fc0 sc0 ls0 ws4">PyErr_SetString(PyExc_IOError, &quot;File must be in binary mode&quot;);</div><div class="t m0 x19 hf y3aaa ff8 fs5 fc0 sc0 ls0 ws4">goto final;</div><div class="t m0 x5 hf y3aab ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y3aac ff8 fs5 fc0 sc0 ls0 ws4">/* Extract underlying buffer data */</div><div class="t m0 x5 hf y3aad ff8 fs5 fc0 sc0 ls0 ws4">PyBytes_AsStringAndSize(data, &amp;buf, &amp;len);</div><div class="t m0 x5 hf y3aae ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x0 h9 y2d1e ff1 fs3 fc0 sc0 ls49 ws15f5">本节最难的地方在于如何进行正确的内存管理<span class="_ _1"></span>。当处理 <span class="ff6 ls0 ws1019">PyObject * `` <span class="ffc fs7 ls2ad ws15f6">变量的时</span></span></div><div class="t m0 x5 h9 y1e9c ffc fs7 fc0 sc0 ls2ae ws15f7">候，需要注意管理引用计数以及在不需要的变量的时候清理它们的值<span class="_ _c"></span>。对 <span class="ff6 fs3 ls0 wsfaf">``Py DECREF() <span class="ff1">的</span></span></div><div class="t m0 x5 h9 y3aaf ff1 fs3 fc0 sc0 ls0">调用就是来做这个的。</div><div class="t m0 x0 h9 y4c8 ff1 fs3 fc0 sc0 ls14f ws91d">本节代码以一种通用方式编写<span class="_ _d"></span>，因此他也能适用于其他的文件操作<span class="_ _d"></span>，比如写文<span class="_ _d"></span></div><div class="t m0 x5 h9 y4c9 ff1 fs3 fc0 sc0 ls12 ws15f8">件。例如<span class="_ _c"></span>，要写数据，只需要获取类文件对象的 <span class="ff6 ls0 ws15f9">write() </span><span class="wse4">方法，将数据转换为合适的<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y4ca ff4 fs3 fc0 sc0 ls0 ws5c">Python <span class="ff1 ws14">对象（字节或 </span><span class="wsa5">Unico<span class="_ _6"></span>de<span class="ff1 wsa0">）<span class="_ _f"></span>，然后调用该方法将输入写入到文件。</span></span></div><div class="t m0 x0 h7 y3ab0 ff1 fs3 fc0 sc0 ls49 ws15fa">最后<span class="_ _1"></span>，尽管类文件对象通常还提供其他方法（<span class="_ _1"></span>比如 <span class="ff4 ls0 wsd56">readline(),<span class="_ _18"> </span>read info()<span class="ff1 wsa0">）<span class="_ _f"></span>，我<span class="_ _6"></span>们</span></span></div><div class="t m0 x5 h7 y3ab1 ff1 fs3 fc0 sc0 ls0 ws2c8">最好只使用基本的 <span class="ff6 wsba9">read() </span><span class="ls16b">和</span><span class="ff6 ws2ca">write() </span><span class="ws153f">方法。在写 <span class="ff4 ls2af">C</span><span class="wsa0">扩展的时候，能简单就尽量简单。</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.19.<span class="_ _36"> </span>15.19 <span class="ff1 ls7f">从</span><span class="ls246">C</span><span class="ff1 ws15dc">语言中读取类文件对象 </span>603</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
