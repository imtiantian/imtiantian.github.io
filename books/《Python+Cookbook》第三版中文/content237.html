<div id="pfed" class="pf w0 h0" data-page-no="ed"><div class="pc pced w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bged.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=</span><span class="ls0">sample()</span></span></div><div class="t m0 x5 hf y1ac ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">f()</span></div><div class="t m0 x5 hf y1ad ff8 fs5 fc8 sc0 ls0 ws4">n= 0</div><div class="t m0 x5 hf y1ae ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">set_n(<span class="fc7">10</span>)</span></span></span></div><div class="t m0 x5 hf y1af ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">f()</span></div><div class="t m0 x5 hf y1b0 ff8 fs5 fc8 sc0 ls0 ws4">n= 10</div><div class="t m0 x5 hf y355 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">get_n()</span></span></span></div><div class="t m0 x5 hf y410 ff8 fs5 fc8 sc0 ls0">10</div><div class="t m0 x5 hf y411 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he yb84 ff2 fs2 fc4 sc0 ls0 ws212">9.12.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y19e6 ff1 fs3 fc0 sc0 ls13 wse5">为了说明清楚它如何工作的<span class="_ _1"></span>，有两点需要解释一下。首先<span class="_ _c"></span>，<span class="ff6 ls0 ws370">nonlocal </span>声明可以让</div><div class="t m0 x5 h9 y19e7 ff1 fs3 fc0 sc0 ls13 wse5">我们编写函数来修改内部变量的值<span class="_ _1"></span>。其次，函数属性允许我们用一种很简单的方式将<span class="_ _c"></span></div><div class="t m0 x5 h7 y19e8 ff1 fs3 fc0 sc0 ls0 ws14">访问方法绑定到闭包函数上，这个跟实例方法很像 <span class="ff4 ls1b">(</span><span class="wsa0">尽管并没有定义任何类<span class="ff4 wsa5">)</span>。</span></div><div class="t m0 x0 h9 y19e9 ff1 fs3 fc0 sc0 ls3a ws153">还可以进一步的扩展，让闭包模拟类的实例。你要做的仅仅是复制上面的内部函数</div><div class="t m0 x5 h9 yb2f ff1 fs3 fc0 sc0 ls0">到一个字典实例中并返回它即可。例如：</div><div class="t m0 x5 h10 y142e ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">sys</span></div><div class="t m0 x5 hf y142f ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">ClosureInstance<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1430 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fca">locals<span class="fc6 ls34">=</span>None</span>):</span></span></div><div class="t m0 x16 hf y19ea ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws145">locals </span>is <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf y19eb ff8 fs5 fca sc0 ls0 ws145">locals <span class="fc6 ls32">=</span><span class="fc0 ws13a">sys<span class="fc6 ls34">.</span>_getframe(<span class="fc7 ls34">1<span class="fc0">)<span class="fc6">.</span></span></span>f_locals</span></div><div class="t m0 x16 h11 y19ec ffa fs5 fcd sc0 ls0 ws4"># Update instance dictionary with callables</div><div class="t m0 x16 hf y1435 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">__dict__</span><span class="ls34">.</span><span class="fc0 ws9bb">update((key,value) </span></span><span class="ff7 ws139">for </span><span class="fc0 ws13b">key, value </span><span class="ff7 ws157">in </span>locals<span class="fc6 ls34">.</span><span class="fc0">items()</span></div><div class="t m0 x23 hf y19ed ff7 fs5 fca sc0 ls0 ws160">if <span class="ff8 ws13a">callable<span class="fc0 ws4">(value) )</span></span></div><div class="t m0 x15 h11 y19ee ffa fs5 fcd sc0 ls0 ws4"># Redirect special methods</div><div class="t m0 x15 hf y19ef ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__len__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y19f0 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">__dict__[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">__len__<span class="ff9 ls34">&apos;</span></span>]()</span></span></div><div class="t m0 x5 h11 y19f1 ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 hf y19f2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">Stack<span class="fc0">():</span></span></div><div class="t m0 x15 hf y19f3 ff8 fs5 fc0 sc0 ls0 ws15f">items <span class="fc6 ls33">=</span>[]</div><div class="t m0 x15 hf y19f4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">push<span class="fc0">(item):</span></span></div><div class="t m0 x16 hf y19f5 ff8 fs5 fc0 sc0 ls0 ws13a">items<span class="fc6 ls34">.</span>append(item)</div><div class="t m0 x15 hf y19f6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">pop<span class="fc0">():</span></span></div><div class="t m0 x16 hf y19f7 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">items<span class="fc6">.</span>pop()</span></div><div class="t m0 x15 hf y19f8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__len__<span class="fc0">():</span></span></div><div class="t m0 x16 hf y19f9 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">len<span class="fc0">(items)</span></span></div><div class="t m0 x15 hf y19fa ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">ClosureInstance()</span></div><div class="t m0 x0 h9 y19fb ff1 fs3 fc0 sc0 ls0">下面是一个交互式会话来演示它是如何工作的：</div><div class="t m0 x5 hf y7ec ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">Stack()</span></span></div><div class="t m0 x5 hf y19fc ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">s</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">9.12.<span class="_ _5"> </span>7.12 <span class="ff1 ws509">访问闭包中定义的变量 </span>228</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
