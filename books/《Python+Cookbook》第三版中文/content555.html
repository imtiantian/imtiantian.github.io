<div id="pf22b" class="pf w0 h0" data-page-no="22b"><div class="pc pc22b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg22b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">17.1.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y675 ff1 fs3 fc0 sc0 ls0 ws135d">对于需要<span class="_ _6"></span>调用 <span class="ff4 ls247">C</span><span class="ls51 ws135e">代码的一些小的问题，通常使用 </span><span class="ff4 ws135f">Python </span><span class="wsf82">标准库中的 <span class="ff6 ws6fd">ctypes </span><span class="wsa0">模块</span></span></div><div class="t m0 x5 h7 y676 ff1 fs3 fc0 sc0 ls0 ws1360">就足够了。<span class="_ _6"></span>要使用 <span class="ff6 ws8c5">ctypes </span><span class="ls68 ws1361">，你首先要确保你要访问的 <span class="ff4 ls248">C</span><span class="ws1362">代码已经被编译到和 </span></span><span class="ff4">Python</span></div><div class="t m0 x5 h9 y677 ff1 fs3 fc0 sc0 ls40 ws180">解释器兼容（<span class="_ _1"></span>同样的架构、字大小<span class="_ _c"></span>、编译器等）的某个共享库中了<span class="_ _c"></span>。为了进行本节的</div><div class="t m0 x5 h7 y678 ff1 fs3 fc0 sc0 ls18 ws1363">演示，假设你有一个共享库名字叫 <span class="ff6 ls0 ws69a">libsample.so </span><span class="ws1364">，里面的内容就是 <span class="ff4 ls0 ws1365">15 </span><span class="ws110">章介绍部分那<span class="_ _1"></span></span></span></div><div class="t m0 x5 h9 y679 ff1 fs3 fc0 sc0 ls1e ws1366">样<span class="_ _1"></span>。另外还假设这个 <span class="ff6 ls0 wsbbc">libsample.so <span class="ff1 ws1367">文<span class="_ _6"></span>件<span class="_ _6"></span>被放<span class="_ _6"></span>置<span class="_ _6"></span>到<span class="_ _6"></span>位<span class="_ _6"></span>于 </span><span class="ws2f1">sample.py <span class="ff1 wsa0">文<span class="_ _6"></span>件相<span class="_ _6"></span>同<span class="_ _6"></span>的<span class="_ _6"></span>目<span class="_ _6"></span>录<span class="_ _6"></span>中</span></span></span></div><div class="t m0 x5 h9 y67a ff1 fs3 fc0 sc0 ls0">了。</div><div class="t m0 x0 h7 y11f0 ff1 fs3 fc0 sc0 ls0 ws14">要访问这个函数库，你要先构建一个包装它的 <span class="ff4 ws5c">Python </span>模块，如下这样：</div><div class="t m0 x5 h11 y2c6f ffa fs5 fcd sc0 ls0 ws4"># sample.py</div><div class="t m0 x5 h10 y2c70 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">ctypes</span></div><div class="t m0 x5 h10 y2c71 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">os</span></div><div class="t m0 x5 h11 y2c72 ffa fs5 fcd sc0 ls0 ws4"># Try to locate the .so file in the same directory as this file</div><div class="t m0 x5 hf y2c73 ff8 fs5 fc0 sc0 ls0 ws15f">_file <span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">libsample.so<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y2c74 ff8 fs5 fc0 sc0 ls0 ws15f">_path <span class="fc6 ls33">=</span><span class="ws13a">os<span class="fc6 ls34">.</span>path<span class="fc6 ls34">.</span>join(<span class="fc6 ls34">*</span>(os<span class="fc6 ls34">.</span>path<span class="fc6 ls34">.</span>split(__file__)[:<span class="fc6 ls34">-</span><span class="fc7">1</span><span class="ls33">]<span class="fc6 ls32">+</span></span>(_file,)))</span></div><div class="t m0 x5 hf y2c75 ff8 fs5 fc0 sc0 ls0 ws13c">_mod <span class="fc6 ls32">=</span><span class="ws13a">ctypes<span class="fc6 ls34">.</span>cdll<span class="fc6 ls34">.</span>LoadLibrary(_path)</span></div><div class="t m0 x5 h11 y2c77 ffa fs5 fcd sc0 ls0 ws4"># int gcd(int, int)</div><div class="t m0 x5 hf y2c78 ff8 fs5 fc0 sc0 ls0 ws158">gcd <span class="fc6 ls32">=</span><span class="ws13a">_mod<span class="fc6 ls34">.</span>gcd</span></div><div class="t m0 x5 hf y2c79 ff8 fs5 fc0 sc0 ls0 ws13a">gcd<span class="fc6 ls34">.</span><span class="ws1f5">argtypes <span class="fc6 ls33">=</span></span>(ctypes<span class="fc6 ls34">.</span><span class="ws13b">c_int, ctypes<span class="fc6 ls34">.</span>c_int)</span></div><div class="t m0 x5 hf y2c7a ff8 fs5 fc0 sc0 ls0 ws13a">gcd<span class="fc6 ls34">.</span><span class="ws155">restype <span class="fc6 ls32">=</span></span>ctypes<span class="fc6">.</span>c_int</div><div class="t m0 x5 h11 y2c7c ffa fs5 fcd sc0 ls0 ws4"># int in_mandel(double, double, int)</div><div class="t m0 x5 hf y2c7d ff8 fs5 fc0 sc0 ls0 ws16e">in_mandel <span class="fc6 ls33">=</span><span class="ws13a">_mod<span class="fc6">.</span>in_mandel</span></div><div class="t m0 x5 hf y35ca ff8 fs5 fc0 sc0 ls0 ws13a">in_mandel<span class="fc6">.</span><span class="ws16d">argtypes <span class="fc6 ls32">=</span></span>(ctypes<span class="fc6 ls34">.</span><span class="ws4">c_double, ctypes</span><span class="fc6">.</span><span class="ws4">c_double, ctypes<span class="fc6 ls34">.</span>c_int)</span></div><div class="t m0 x5 hf y2c7e ff8 fs5 fc0 sc0 ls0 ws13a">in_mandel<span class="fc6">.</span><span class="ws155">restype <span class="fc6 ls33">=</span></span>ctypes<span class="fc6 ls34">.</span>c_int</div><div class="t m0 x5 h11 y2c80 ffa fs5 fcd sc0 ls0 ws4"># int divide(int, int, int *)</div><div class="t m0 x5 hf y2c81 ff8 fs5 fc0 sc0 ls0 ws155">_divide <span class="fc6 ls32">=</span><span class="ws13a">_mod<span class="fc6 ls34">.</span>divide</span></div><div class="t m0 x5 hf y2c82 ff8 fs5 fc0 sc0 ls0 ws13a">_divide<span class="fc6 ls34">.</span><span class="ws1f5">argtypes <span class="fc6 ls33">=</span></span>(ctypes<span class="fc6 ls34">.</span><span class="ws13b">c_int, ctypes<span class="fc6 ls34">.</span>c_int, ctypes<span class="fc6 ls34">.</span></span>POINTER(ctypes<span class="fc6 ls34">.</span>c_int))</div><div class="t m0 x5 hf y2c83 ff8 fs5 fc0 sc0 ls0 ws13a">_divide<span class="fc6 ls34">.</span><span class="ws155">restype <span class="fc6 ls32">=</span></span>ctypes<span class="fc6 ls34">.</span>c_int</div><div class="t m0 x5 hf y2c85 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">divide<span class="fc0 ws4">(x, y):</span></span></div><div class="t m0 x15 hf y2c86 ff8 fs5 fc0 sc0 ls0 ws158">rem <span class="fc6 ls32">=</span><span class="ws13a">ctypes<span class="fc6">.</span>c_int()</span></div><div class="t m0 x15 hf y2c87 ff8 fs5 fc0 sc0 ls0 ws13c">quot <span class="fc6 ls32">=</span><span class="ws4">_divide(x, y, rem)</span></div><div class="t m0 x15 hf y35cb ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">quot,rem<span class="fc6 ls34">.</span>value</span></div><div class="t m0 x5 h11 y2c8a ffa fs5 fcd sc0 ls0 ws4"># void avg(double *, int n)</div><div class="t m0 x5 h11 y2c8b ffa fs5 fcd sc0 ls0 ws4"># Define a special type for the <span class="ffb ls34">&apos;</span>double *<span class="ffb ls32">&apos;</span>argument</div><div class="t m0 x5 hf y2c8c ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">DoubleArrayType<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y35cc ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">from_param<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, param):</span></span></span></div><div class="t m0 x16 hf y2c8d ff8 fs5 fc0 sc0 ls0 ws1f5">typename <span class="fc6 ls33">=</span><span class="fca ws13a">type<span class="fc0">(param)<span class="fc6 ls34">.</span>__name__</span></span></div><div class="t m0 x16 hf y2c8e ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">hasattr<span class="fc0 ls34">(</span>self<span class="fc0 ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">from_<span class="ff9 ls32">&apos;<span class="ff8 fc6">+</span></span><span class="fc0">typename):</span></span></span></div><div class="t m0 x17 hf y2c8f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">getattr<span class="fc0 ls34">(</span>self<span class="fc0 ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">from_<span class="ff9 ls33">&apos;</span><span class="fc6 ls32">+</span><span class="fc0">typename)(param)</span></span></span></div><div class="t m0 x16 hf y35cd ff7 fs5 fca sc0 ls0 ws218">elif <span class="ff8 ws13a">isinstance<span class="fc0 ws13b">(param, ctypes<span class="fc6 ls34">.</span>Array):</span></span></div><div class="t m0 x17 hf y2c90 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">param</span></div><div class="t m0 x16 hf y2c91 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.1.<span class="_ _36"> </span>15.1 <span class="ff1 ws16b">使用 </span><span class="ws135b">ctypes <span class="ff1 ws16b">访问 </span><span class="ls246">C</span><span class="ff1 ws135c">代码 </span>546</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
