<div id="pf233" class="pf w0 h0" data-page-no="233"><div class="pc pc233 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg233.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h10 y334 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y335 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>gcd(<span class="fc7">35</span><span class="ls33">,</span><span class="fc7">42</span>)</span></div><div class="t m0 x5 hf y336 ff8 fs5 fc8 sc0 ls0">7</div><div class="t m0 x5 hf y337 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>in_mandel(<span class="fc7 ls34">0</span><span class="ls32">,<span class="fc7 ls34">0</span><span class="ls33">,</span></span><span class="fc7">500</span>)</span></div><div class="t m0 x5 hf yadd ff8 fs5 fc8 sc0 ls0">1</div><div class="t m0 x5 hf yade ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>in_mandel(<span class="fc7">2.0</span><span class="ls33">,</span><span class="fc7">1.0</span><span class="ls33">,</span><span class="fc7">500</span>)</span></div><div class="t m0 x5 hf yc64 ff8 fs5 fc8 sc0 ls0">0</div><div class="t m0 x5 hf y1555 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>divide(<span class="fc7">42</span><span class="ls32">,<span class="fc7 ls34">8</span></span>)</span></div><div class="t m0 x5 hf y177c ff8 fs5 fc8 sc0 ls0 ws4">(5, 2)</div><div class="t m0 x5 hf y177d ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y39a ff1 fs3 fc0 sc0 ls0 ws13a9">如<span class="_ _6"></span>果<span class="_ _6"></span>你<span class="_ _6"></span>是<span class="_ _0"></span>在 <span class="ff4 ws13aa">Windo<span class="_ _c"></span>ws <span class="ff1 ls56 ws1fa">机器上面尝试这些步骤<span class="_ _1"></span>，可能会遇到各种环境和编译问题<span class="_ _1"></span>，<span class="_ _c"></span></span></span></div><div class="t m0 x5 h7 y3667 ff1 fs3 fc0 sc0 ls0 wsa0">你需要花更多点时间去配置。<span class="_ _c"></span><span class="ff4 ws13ab">Python <span class="ff1 ws13ac">的二进制分发通常使用了 </span><span class="ws13ad">Microsoft Visual Studio</span></span></div><div class="t m0 x5 h9 y3668 ff1 fs3 fc0 sc0 ls1e ws111">来构建<span class="_ _1"></span>。为了让这些扩展能正常工作<span class="_ _1"></span>，你需要使用同样或兼容的工具来编译它<span class="_ _1"></span>。参考</div><div class="t m0 x5 h7 y3669 ff1 fs3 fc0 sc0 ls0 ws38">相应的 <span class="ff4 fc3 ws5c">Python <span class="ff1">文档</span></span></div><div class="t m0 x5 he yd69 ff2 fs2 fc4 sc0 ls0 ws212">17.2.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y366a ff1 fs3 fc0 sc0 ls12 ws13ae">在尝试任何手写扩展之前，最好能先参考下 <span class="ff4 ls0 ws10ff">Python <span class="ff1 ws13af">文档中<span class="_ _6"></span>的 </span></span><span class="fc3 ws13b0">扩展和嵌入 <span class="ff4 ls0">Python</span></span></div><div class="t m0 x5 h7 y2363 ff1 fs3 fc3 sc0 ls0 ws4e4">解释<span class="_ _6"></span>器 <span class="ff4 fc0 ws13b1">.<span class="_ _26"> </span>Python <span class="ff1 lscc">的</span><span class="ls108">C</span><span class="ff1 wsaa7">扩展 </span><span class="ws13b2">API <span class="ff1 ls42 ws186">很大，在这里整个去讲述它没什么实际意义。不过对<span class="_ _1"></span></span></span></span></div><div class="t m0 x5 h9 ye5d ff1 fs3 fc0 sc0 ls0">于最核心的部分还是可以讨论下的。</div><div class="t m0 x0 h9 y366b ff1 fs3 fc0 sc0 ls0">首先，在扩展模块中，你写的函数都是像下面这样的一个普通原型：</div><div class="t m0 x5 hf y366c ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_func(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y366d ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y366e ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y366f ff6 fs3 fc0 sc0 ls0 ws13b3">PyObject <span class="ff1 ls12 ws13b4">是一个能表示任何 </span><span class="ff4 ws10ff">Python <span class="ff1 ls12 ws108c">对象的 </span><span class="ls24f">C</span><span class="ff1 wsa0">数据<span class="_ _6"></span>类<span class="_ _6"></span>型。在<span class="_ _6"></span>一个<span class="_ _6"></span>高<span class="_ _6"></span>级层<span class="_ _6"></span>面，一<span class="_ _6"></span>个</span></span></div><div class="t m0 x5 h7 y2795 ff1 fs3 fc0 sc0 ls10 ws13b5">扩展函数就是一个接受一个 <span class="ff4 ls0 ws131">Python <span class="ff1 ws13b6">对<span class="_ _6"></span>象（在 </span><span class="ws13b7">PyOb<span class="_ _6"></span>ject <span class="ff5 fc2 ws75">*</span><span class="ws13b8">args <span class="ff1 wsa0">中）<span class="_ _6"></span>元<span class="_ _6"></span>组<span class="_ _6"></span>并返<span class="_ _6"></span>回<span class="_ _6"></span>一<span class="_ _6"></span>个新</span></span></span></span></div><div class="t m0 x5 h7 y3670 ff4 fs3 fc0 sc0 ls0 ws4ce">Python <span class="ff1 ws13b9">对象的 </span><span class="ls256">C<span class="ff1 ls51 ws1cd">函数。函数的 </span></span><span class="ff6 ws13ba">self <span class="ff1 ls51 ws1c8">参数对于简单的扩展函数没有被使用到，不过如</span></span></div><div class="t m0 x5 h7 y3671 ff1 fs3 fc0 sc0 lse ws13bb">果你想定义新的类或者是 <span class="ff4 ls20">C</span><span class="wsd8">中的对象类型的话就能派上用场了。比<span class="_ _1"></span>如如果扩展函数是</span></div><div class="t m0 x5 h9 y3672 ff1 fs3 fc0 sc0 ls0 ws38">一个类的一个方法，那么 <span class="ff6 ws27b">self </span>就能引用那个实例了。</div><div class="t m0 x0 h7 y3673 ff6 fs3 fc0 sc0 ls0 ws7cb">PyArg ParseTuple() <span class="ff1 ls30 ws13bc">函数被用来将 </span><span class="ff4 ws6af">Python <span class="ff1 ls30 ws13bc">中的值转换成 </span><span class="ls257">C<span class="ff1 ls30 ws138">中对应表示。它接受<span class="_ _c"></span></span></span></span></div><div class="t m0 x5 h7 y3674 ff1 fs3 fc0 sc0 ls17 wsf6">一个指定输入格式的格式化字符串作为输入，比如“<span class="_ _1"></span><span class="ff4 ls0 wsa5">i<span class="ff1 wsa0">”代<span class="_ _6"></span>表整<span class="_ _6"></span>数，<span class="_ _3"></span>“<span class="ff4 wsa5">d</span><span class="ls17 wsf6">”代表双精度浮</span></span></span></div><div class="t m0 x5 h7 y3675 ff1 fs3 fc0 sc0 lse ws13bd">点数，同样还有存放转换后结果的 <span class="ff4 ls20">C</span><span class="wsd8">变量的地址<span class="_ _1"></span>。如果输入的值不匹配这个格式化字</span></div><div class="t m0 x5 h7 y3676 ff1 fs3 fc0 sc0 ls19 ws13be">符串，就会抛出一个异常并返回一个 <span class="ff4 ls0 ws13bf">NULL <span class="ff1 ws13c0">值。通过<span class="_ _6"></span>检查<span class="_ _6"></span>并返<span class="_ _6"></span>回 </span><span class="wsa5">NULL<span class="ff1 wsa0">，一<span class="_ _6"></span>个合适<span class="_ _6"></span>的</span></span></span></div><div class="t m0 x5 h9 y3677 ff1 fs3 fc0 sc0 ls0">异常会在调用代码中被抛出。</div><div class="t m0 x0 h7 y3678 ff6 fs3 fc0 sc0 ls0 wsac8">Py BuildValue()<span class="_ _1e"> </span><span class="ff1 lsaa ws13c1">函数被用来根据 <span class="ff4 ls258">C</span><span class="ws13c2">数据类型创建 </span></span><span class="ff4 ws13c3">Python <span class="ff1 wsa0">对<span class="_ _0"></span>象。<span class="_ _12"></span>它<span class="_ _0"></span>同<span class="_ _12"></span>样<span class="_ _0"></span>接<span class="_ _12"></span>受</span></span></div><div class="t m0 x5 h7 yd10 ff1 fs3 fc0 sc0 ls0 ws13c4">一<span class="_ _0"></span>个<span class="_ _0"></span>格<span class="_ _0"></span>式<span class="_ _6"></span>化<span class="_ _0"></span>字<span class="_ _0"></span>符<span class="_ _0"></span>串<span class="_ _0"></span>来<span class="_ _0"></span>指<span class="_ _0"></span>定<span class="_ _0"></span>期<span class="_ _0"></span>望<span class="_ _6"></span>类<span class="_ _0"></span>型。<span class="_ _0"></span>在<span class="_ _0"></span>扩<span class="_ _0"></span>展<span class="_ _0"></span>函<span class="_ _0"></span>数<span class="_ _0"></span>中，<span class="_ _0"></span>它<span class="_ _0"></span>被<span class="_ _6"></span>用<span class="_ _0"></span>来<span class="_ _0"></span>返<span class="_ _0"></span>回<span class="_ _0"></span>结<span class="_ _0"></span>果<span class="_ _0"></span>给 <span class="ff4 wsa5">Python</span>。</div><div class="t m0 x5 h9 y3679 ff6 fs3 fc0 sc0 ls0 ws5f7">Py BuildValue() <span class="ff1 ls36 ws14a">的一个特性是它能构建更加复杂的对象类型，比如元组和<span class="_ _1"></span>字典<span class="_ _1"></span>。在<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y367a ff6 fs3 fc0 sc0 ls0 ws1f3">py<span class="_ _7"> </span>divide() <span class="ff1">代码中，一个例子演示了怎样返回一个元组。不过，下面还有一些实例：</span></div><div class="t m0 x5 hf y367b ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;i&quot;, 34);<span class="_ _44"> </span>// Return an integer</div><div class="t m0 x5 hf y367c ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;d&quot;, 3.4);<span class="_ _1a"> </span>// Return a double</div><div class="t m0 x5 hf y367d ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;s&quot;, &quot;Hello&quot;); // Null-terminated UTF-8 string</div><div class="t m0 x5 hf y367e ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;(ii)&quot;, 3, 4); // Tuple (3, 4)</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.2.<span class="_ _36"> </span>15.2 <span class="ff1 ws36c">简单的 </span><span class="ls246">C</span><span class="ff1 ws13a5">扩展模块 </span>554</div><a class="l" href="https://docs.python.org/3/extending/windows.html"><div class="d m1" style="border-style:none;position:absolute;left:167.644500px;bottom:819.940500px;width:65.371000px;height:16.820000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="https://docs.python.org/3/extending/index.html"><div class="d m1" style="border-style:none;position:absolute;left:631.426500px;bottom:710.431500px;width:102.325000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="https://docs.python.org/3/extending/index.html"><div class="d m1" style="border-style:none;position:absolute;left:108.000000px;bottom:689.554500px;width:36.167000px;height:14.016000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
