<div id="pf20d" class="pf w0 h0" data-page-no="20d"><div class="pc pc20d w0 h0"><img class="bi x13 y5 w2 hb" alt="" src="bg20d.png"/><div class="t m0 xe h8 y76 ff2 fs3 fc0 sc0 ls0">CHAPTER</div><div class="t m0 x4d hc y77 ff2 fs4 fc0 sc0 ls0">SIXTEEN</div><div class="t m0 x4e hd y78 ff1 fs4 fc0 sc0 ls0">第十四章：测试、调试和异常</div><div class="t m0 x0 h7 y79 ff1 fs3 fc0 sc0 ls3d ws55d">试验还是很棒的，但是调试<span class="_ _1"></span>？就没那么有趣了。事实是，在 <span class="ff4 ls0 wsf8">Python <span class="ff1 wsa0">测试代码<span class="_ _6"></span>之前</span></span></div><div class="t m0 x5 h9 ycf ff1 fs3 fc0 sc0 ls13 wse5">没有编译器来分析你的代码<span class="_ _1"></span>，因此使的测试成为开发的一个重要部分。本章的目标是<span class="_ _c"></span></div><div class="t m0 x5 h9 yd0 ff1 fs3 fc0 sc0 ls13 wse5">讨论一些关于测试<span class="_ _1"></span>、调试和异常处理的常见问题。但是并不是为测试驱动开发或者单<span class="_ _c"></span></div><div class="t m0 x5 h9 yd1 ff1 fs3 fc0 sc0 ls0">元测试模块做一个简要的介绍。因此，笔者假定读者熟悉测试概念。</div><div class="t m0 x0 h7 yd2 ff4 fs3 fc0 sc0 ls0 wsa5">Con<span class="_ _1"></span>ten<span class="_ _1"></span>ts:</div><div class="t m0 x5 hd yd3 ff2 fs4 fc4 sc0 ls0 ws211">16.1<span class="_ _e"> </span>14.1 <span class="ff1 ws165">测试 </span><span class="ws1275">stdout <span class="ff1">输出</span></span></div><div class="t m0 x5 he yd4 ff2 fs2 fc4 sc0 ls0 ws212">16.1.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 yd5 ff1 fs3 fc0 sc0 ls1f ws113">你的程序中有个方法会输出到标准输出中（<span class="ff4 ls0 wsa5">sys.stdout</span>）<span class="_ _f"></span>。也就是说它会将文本打印</div><div class="t m0 x5 h9 yd6 ff1 fs3 fc0 sc0 ls0">到屏幕上面。你想写个测试来证明它，给定一个输入，相应的输出能正常显示出来。</div><div class="t m0 x5 he yd7 ff2 fs2 fc4 sc0 ls0 ws212">16.1.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y3319 ff1 fs3 fc0 sc0 ls0 ws216">使用 <span class="ff6 ws1276">unittest.mock </span><span class="wsd64">模<span class="_ _6"></span>块<span class="_ _6"></span>中的 <span class="ff6 ws9b2">patch() </span><span class="wsa0">函<span class="_ _6"></span>数，<span class="_ _6"></span>使用<span class="_ _6"></span>起<span class="_ _6"></span>来<span class="_ _6"></span>非常<span class="_ _6"></span>简<span class="_ _6"></span>单，可<span class="_ _6"></span>以<span class="_ _6"></span>为单<span class="_ _6"></span>个<span class="_ _6"></span>测</span></span></div><div class="t m0 x5 h9 y3158 ff1 fs3 fc0 sc0 ls0 ws1277">试模拟 <span class="ff6 ws87e">sys.stdout </span><span class="wsa0">然后回滚，并且不产生大量的临时变量或在测试用例直接暴露状态</span></div><div class="t m0 x5 h9 y331a ff1 fs3 fc0 sc0 ls0">变量。</div><div class="t m0 x0 h9 y331b ff1 fs3 fc0 sc0 ls0 wsc">作为一个例子，我们在 <span class="ff6 ws26f">mymodule </span>模块中定义如下一个函数：</div><div class="t m0 x5 h11 y3193 ffa fs5 fcd sc0 ls0 ws4"># mymodule.py</div><div class="t m0 x5 hf y331c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">urlprint<span class="fc0 ws13b">(protocol, host, domain):</span></span></div><div class="t m0 x15 hf y331d ff8 fs5 fc0 sc0 ls0 ws158">url <span class="fc6 ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">{}://{}.{}<span class="ff9 ls34">&apos;<span class="ff8 fc6">.</span></span></span><span class="ws13b">format(protocol, host, domain)</span></div><div class="t m0 x15 hf y331e ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0">(url)</span></div><div class="t m0 x0 h9 y2e52 ff1 fs3 fc0 sc0 ls0 ws1278">默<span class="_ _0"></span>认<span class="_ _0"></span>情<span class="_ _12"></span>况<span class="_ _0"></span>下<span class="_ _0"></span>内<span class="_ _0"></span>置<span class="_ _12"></span>的 <span class="ff6 ws1279">print </span><span class="ls113 ws127a">函数会将输出发送到 </span><span class="ff6 ws127b">sys.stdout </span><span class="wsa0">。<span class="_ _0"></span>为<span class="_ _0"></span>了<span class="_ _0"></span>测<span class="_ _12"></span>试<span class="_ _0"></span>输<span class="_ _0"></span>出<span class="_ _0"></span>真</span></div><div class="t m0 x5 h9 y3227 ff1 fs3 fc0 sc0 ls224 ws127c">的在那里<span class="_ _8"></span>，你可以使用一个替身对象来模拟它<span class="_ _8"></span>，<span class="_ _6"></span>然后使用断言来确认结果<span class="_ _8"></span>。使用<span class="_ _8"></span></div><div class="t m0 x5 h9 y3228 ff6 fs3 fc0 sc0 ls0 ws127d">unittest.mock <span class="ff1 ls24 ws127e">模块的 </span><span class="ws127f">patch() <span class="ff1 ls24 ws11d">方法可以很方便的在测试运行的上下文中替换对象<span class="_ _1"></span>，<span class="_ _c"></span></span></span></div><div class="t m0 x5 h9 y331f ff1 fs3 fc0 sc0 ls0 ws63">并且当测试完成时候自动返回它们的原有状态。下面是对 <span class="ff6 ws1f3">mymodule </span>模块的测试代码：</div><div class="t m0 x26 h8 y29 ff2 fs3 fc0 sc0 ls0">516</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
