<div id="pfee" class="pf w0 h0" data-page-no="ee"><div class="pc pcee w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgee.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y15f ff8 fs5 fc8 sc0 ls0 ws4">&lt;__main__.ClosureInstance object at 0x10069ed10&gt;</div><div class="t m0 x5 hf y160 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">push(<span class="fc7">10</span>)</span></span></span></div><div class="t m0 x5 hf y956 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">push(<span class="fc7">20</span>)</span></span></span></div><div class="t m0 x5 hf y957 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">push(</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Hello</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y958 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fca ws13a">len<span class="fc0">(s)</span></span></div><div class="t m0 x5 hf y959 ff8 fs5 fc8 sc0 ls0">3</div><div class="t m0 x5 hf y95a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">pop()</span></span></span></div><div class="t m0 x5 hf y95b ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">Hello<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y95c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">pop()</span></span></span></div><div class="t m0 x5 hf y9f3 ff8 fs5 fc8 sc0 ls0">20</div><div class="t m0 x5 hf y9f4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">pop()</span></span></span></div><div class="t m0 x5 hf y95d ff8 fs5 fc8 sc0 ls0">10</div><div class="t m0 x5 hf y95e ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 ydb0 ff1 fs3 fc0 sc0 ls3a ws153">有趣的是，这个代码运行起来会比一个普通的类定义要快很多。你可能会像下面这</div><div class="t m0 x5 h9 ydb1 ff1 fs3 fc0 sc0 ls0">样测试它跟一个类的性能对比：</div><div class="t m0 x5 hf y19fd ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Stack2<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y19fe ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y19ff ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">items </span><span class="ls32">=</span><span class="fc0">[]</span></span></div><div class="t m0 x15 hf y1a00 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">push<span class="fc0">(<span class="fca">self</span><span class="ws4">, item):</span></span></span></div><div class="t m0 x16 hf y1a01 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">items</span><span class="ls34">.</span><span class="fc0">append(item)</span></span></div><div class="t m0 x15 hf y1a02 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">pop<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1a03 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">items<span class="fc6 ls34">.</span>pop()</span></span></div><div class="t m0 x15 hf y1a04 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__len__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1a05 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">len<span class="fc0 ls34">(</span>self<span class="fc6">.<span class="fc0">items)</span></span></span></div><div class="t m0 x0 h9 y1a06 ff1 fs3 fc0 sc0 ls0">如果这样做，你会得到类似如下的结果：</div><div class="t m0 x5 hf y1a07 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws146">timeit <span class="fca">import <span class="ff8 fc0">timeit</span></span></span></span></div><div class="t m0 x5 h11 y1a08 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Test involving closures</span></div><div class="t m0 x5 hf y1a09 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">Stack()</span></span></div><div class="t m0 x5 hf y1a0a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">timeit(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">s.push(1);s.pop()<span class="ff9 ls34">&apos;</span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws4">from __main__ import s<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y1a0b ff8 fs5 fc8 sc0 ls0">0.9874754269840196</div><div class="t m0 x5 h11 y1a0c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Test involving a class</span></div><div class="t m0 x5 hf y1a0d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">Stack2()</span></span></div><div class="t m0 x5 hf y1a0e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">timeit(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">s.push(1);s.pop()<span class="ff9 ls34">&apos;</span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws4">from __main__ import s<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y1a0f ff8 fs5 fc8 sc0 ls0">1.0707052160287276</div><div class="t m0 x5 hf y1a10 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 yf8b ff1 fs3 fc0 sc0 ls17 ws9bc">结果显示，闭包的方案运行起来要快大概 <span class="ff4 ls0 wsa5">8%</span><span class="wsf6">，大部分原因<span class="_ _1"></span>是因为对实例变量的简</span></div><div class="t m0 x5 h7 yf8c ff1 fs3 fc0 sc0 ls0 ws63">化访问，闭包更快是因为不会涉及到额外的 <span class="ff4 ws9bd">self </span>变量。</div><div class="t m0 x0 h7 yf48 ff4 fs3 fc0 sc0 ls0 ws9be">Ra<span class="_ _1"></span>ymond Hettinger <span class="ff1 ls3d ws164">对于这个问题设计出了更加难以理解的改进方案。不过，你得</span></div><div class="t m0 x5 h9 yf8d ff1 fs3 fc0 sc0 ls1d ws1c3">考虑下是否真的需要在你代码中这样做<span class="_ _c"></span>，而且它只是真实类<span class="_ _6"></span>的一个奇怪的替换而已<span class="_ _c"></span>，<span class="_ _1"></span></div><div class="t m0 x5 h9 yf8e ff1 fs3 fc0 sc0 ls0 wsa0">例如，<span class="_ _d"></span>类的主要特性如继承、<span class="_ _d"></span>属性、<span class="_ _c"></span>描述器或类方法都是不能用的。<span class="_ _d"></span>并且你要做一些其</div><div class="t m0 x5 h7 y8c4 ff1 fs3 fc0 sc0 ls19 ws9bf">他的工作才能让一些特殊方法生效 <span class="ff4 ls1b">(</span><span class="ls0 ws9c0">比如上<span class="_ _6"></span>面 <span class="ff6 ws9c1">ClosureInstance </span><span class="ws9c2">中重<span class="_ _6"></span>写过的 <span class="ff6 ws9c3">len ()</span></span></span></div><div class="t m0 x5 h7 y8c5 ff1 fs3 fc0 sc0 ls0 wsa0">实现。<span class="ff4">)</span></div><div class="t m0 x0 h9 y674 ff1 fs3 fc0 sc0 ls3a ws153">最后，你可能还会让其他阅读你代码的人感到疑惑，为什么它看起来不像一个普通</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">9.12.<span class="_ _5"> </span>7.12 <span class="ff1 ws509">访问闭包中定义的变量 </span>229</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
