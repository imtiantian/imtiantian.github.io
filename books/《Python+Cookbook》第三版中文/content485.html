<div id="pf1e5" class="pf w0 h0" data-page-no="1e5"><div class="pc pc1e5 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1e5.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls13 wse5">可以使用多任务系统<span class="_ _1"></span>、广播或扇出。你还可以通过以普通订阅者身份绑定来构建调试<span class="_ _c"></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">和诊断工具。例如，下面是一个简单的诊断类，可以显示被发送的消息：</div><div class="t m0 x5 hf y1b7f ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">DisplayMessages<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1b80 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y1b81 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">count </span><span class="ls32">=</span><span class="fc7">0</span></span></div><div class="t m0 x15 hf y3048 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">send<span class="fc0">(<span class="fca">self</span><span class="ws4">, msg):</span></span></span></div><div class="t m0 x16 hf y1b82 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">count </span><span class="ws23d">+= <span class="fc7">1</span></span></span></div><div class="t m0 x16 hf y1b83 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">msg[{}]: {!r}</span>&apos;</span><span class="fc6">.</span><span class="ls0 ws13a">format(<span class="fca">self</span></span><span class="fc6">.</span><span class="ls0 ws13b">count, msg))</span></span></div><div class="t m0 x5 hf y16b1 ff8 fs5 fc0 sc0 ls0 ws158">exc <span class="fc6 ls32">=</span><span class="ws13a">get_exchange(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">name<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y3049 ff8 fs5 fc0 sc0 ls32">d<span class="fc6 ls33">=</span><span class="ls0">DisplayMessages()</span></div><div class="t m0 x5 hf y1b84 ff8 fs5 fc0 sc0 ls0 ws13a">exc<span class="fc6 ls34">.</span>attach(d)</div><div class="t m0 x0 h7 y304a ff1 fs3 fc0 sc0 ls30 ws138">最后，该实现的一个<span class="_ _1"></span>重要特点是它能兼容多个“<span class="ff4 ls0 wsa5">task-lik<span class="_ _c"></span>e<span class="ff1 wsa0">”<span class="_ _6"></span>对<span class="_ _6"></span>象。例<span class="_ _6"></span>如，<span class="_ _6"></span>消息<span class="_ _6"></span>接<span class="_ _6"></span>受</span></span></div><div class="t m0 x5 h7 y304b ff1 fs3 fc0 sc0 ls0 ws1181">者可以是 <span class="ff4 wsa5">actor<span class="_ _6"></span></span><span class="lsb">（</span><span class="ff4 wse2c">12.10 </span><span class="ls51 ws1182">小节介绍）<span class="_ _f"></span>、协程<span class="_ _1"></span>、网络连接或任何实现了正确的 <span class="ff6 ls0 ws6fd">send() <span class="ff1 wsa0">方法</span></span></span></div><div class="t m0 x5 h9 y304c ff1 fs3 fc0 sc0 ls0">的东西。</div><div class="t m0 x0 h9 y304d ff1 fs3 fc0 sc0 ls63 ws21f">关于交换机的一个可能问题是对于订阅者的正确绑定和解绑<span class="_ _c"></span>。为了正确的管理资<span class="_ _1"></span></div><div class="t m0 x5 h9 y304e ff1 fs3 fc0 sc0 ls0">源，每一个绑定的订阅者必须最终要解绑。在代码中通常会是像下面这样的模式：</div><div class="t m0 x5 hf y1e7f ff8 fs5 fc0 sc0 ls0 ws158">exc <span class="fc6 ls32">=</span><span class="ws13a">get_exchange(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">name<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y304f ff8 fs5 fc0 sc0 ls0 ws13a">exc<span class="fc6 ls34">.</span>attach(some_task)</div><div class="t m0 x5 hf y2e05 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x15 hf yefb ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x5 hf yefc ff7 fs5 fca sc0 ls0 ws156">finally<span class="ff8 fc0">:</span></div><div class="t m0 x15 hf y2e06 ff8 fs5 fc0 sc0 ls0 ws13a">exc<span class="fc6 ls34">.</span>detach(some_task)</div><div class="t m0 x0 h9 y3050 ff1 fs3 fc0 sc0 ls1a8 wscb9">某种意义上<span class="_ _d"></span>，这个和使用文件<span class="_ _d"></span>、锁和类似对象很像<span class="_ _d"></span>。通常很容易会忘记最后的<span class="_ _c"></span></div><div class="t m0 x5 h9 y3051 ff6 fs3 fc0 sc0 ls0 ws2c3">detach() <span class="ff1 ls3d ws164">步骤。为了简化这个，你可以考虑使用上下文管理器协议<span class="_ _1"></span>。例如，在交换机</span></div><div class="t m0 x5 h9 y2448 ff1 fs3 fc0 sc0 ls0 ws38">对象上增加一个 <span class="ff6 ws133">subscribe() </span>方法，如下：</div><div class="t m0 x5 hf y3052 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscaf">contextlib </span><span class="ws146">import <span class="ff8 fc0">contextmanager</span></span></div><div class="t m0 x5 hf y3053 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">collections </span><span class="ws146">import <span class="ff8 fc0">defaultdict</span></span></div><div class="t m0 x5 hf y3054 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Exchange<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y3055 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y3056 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">_subscribers </span><span class="ls32">=</span></span>set<span class="fc0">()</span></div><div class="t m0 x15 hf y26b4 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">attach<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, task):</span></span></span></div><div class="t m0 x16 hf y26b5 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_subscribers</span><span class="ls34">.</span><span class="fc0">add(task)</span></span></div><div class="t m0 x15 hf y3057 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">detach<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, task):</span></span></span></div><div class="t m0 x16 hf ybe6 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_subscribers</span><span class="ls34">.</span><span class="fc0">remove(task)</span></span></div><div class="t m0 x15 h10 y3058 ff7 fs5 fc12 sc0 ls0">@contextmanager</div><div class="t m0 x15 hf y3059 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">subscribe<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ls32">,<span class="fc6 ls34">*</span><span class="ls0">tasks):</span></span></span></span></div><div class="t m0 x16 hf y19c7 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">task </span><span class="ws160">in <span class="ff8 fc0">tasks:</span></span></div><div class="t m0 x17 hf y305a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">attach(task)</span></span></div><div class="t m0 x16 hf y305b ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 h10 y305c ff7 fs5 fca sc0 ls0">yield</div><div class="t m0 x16 hf y305d ff7 fs5 fca sc0 ls0 ws156">finally<span class="ff8 fc0">:</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.11.<span class="_ _36"> </span>12.11 <span class="ff1 wsa0">实现消息发布</span><span class="ls20f">/</span><span class="ff1 ws1180">订阅模型 </span>476</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
