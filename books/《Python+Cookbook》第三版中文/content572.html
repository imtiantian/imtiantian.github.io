<div id="pf23c" class="pf w0 h0" data-page-no="23c"><div class="pc pc23c w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg23c.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff8 fs5 fc0 sc0 ls0">};</div><div class="t m0 x5 hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">/* Module initialization function */</div><div class="t m0 x5 hf y1ae ff8 fs5 fc0 sc0 ls0">PyMODINIT_FUNC</div><div class="t m0 x5 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">PyInit_ptexample(void) {</div><div class="t m0 x19 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *m;</div><div class="t m0 x19 hf y410 ff8 fs5 fc0 sc0 ls0 ws4">m = PyModule_Create(&amp;ptexamplemodule);</div><div class="t m0 x19 hf y411 ff8 fs5 fc0 sc0 ls0 ws4">if (m == NULL)</div><div class="t m0 x15 hf yba ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf ybed ff8 fs5 fc0 sc0 ls0 ws4">/* Import sample, loading its API functions */</div><div class="t m0 x19 hf ybee ff8 fs5 fc0 sc0 ls0 ws4">if (!import_sample()) {</div><div class="t m0 x15 hf ybef ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf ybf0 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf ybf1 ff8 fs5 fc0 sc0 ls0 ws4">return m;</div><div class="t m0 x5 hf ybf2 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y3727 ff1 fs3 fc0 sc0 ls63 ws21f">编译这个新模块时<span class="_ _c"></span>，你甚至不需要去考虑怎样将函数库或代码跟其他模块链接起<span class="_ _1"></span></div><div class="t m0 x5 h9 y3728 ff1 fs3 fc0 sc0 ls0 ws14">来。例如，你可以像下面这样创建一个简单的 <span class="ff6 ws1f3">setup.py </span>文件：</div><div class="t m0 x5 h11 y1c61 ffa fs5 fcd sc0 ls0 ws4"># setup.py</div><div class="t m0 x5 hf y1c62 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws2dd">distutils.core </span><span class="ws146">import <span class="ff8 fc0 ws13b">setup, Extension</span></span></div><div class="t m0 x5 hf y3702 ff8 fs5 fc0 sc0 ls0 ws13a">setup(name<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">ptexample<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x50 hf y6c3 ff8 fs5 fc0 sc0 ls0 ws13a">ext_modules<span class="fc6 ls34">=</span>[</div><div class="t m0 x16 hf y3703 ff8 fs5 fc0 sc0 ls0 ws13a">Extension(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">ptexample<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x34 hf y3704 ff8 fs5 fc0 sc0 ls34">[<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">ptexample.c</span><span class="ls0 ws13b">&apos;</span></span><span class="ls0">],</span></div><div class="t m0 x34 hf y3705 ff8 fs5 fc0 sc0 ls0 ws3c7">include_dirs <span class="fc6 ls32">=</span><span class="ws1409">[], <span class="ffa fcd ws4"># May need pysample.h directory</span></span></div><div class="t m0 x34 hf y3706 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x16 hf y3707 ff8 fs5 fc0 sc0 ls0">]</div><div class="t m0 x5 hf y3708 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x0 h7 y3729 ff1 fs3 fc0 sc0 ls30 ws140a">如果一切正常<span class="_ _1"></span>，你会发现你的新扩展函数能和定义在其他模块中的 <span class="ff4 ls0 ws140b">C API <span class="ff1 wsa0">函<span class="_ _6"></span>数一</span></span></div><div class="t m0 x5 h9 y372a ff1 fs3 fc0 sc0 ls0">起运行的很好。</div><div class="t m0 x5 h10 y372b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y234f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p1 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">2</span>,<span class="fc7 ls34">3</span>)</span></span></div><div class="t m0 x5 hf y372c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">p1</span></div><div class="t m0 x5 hf y2350 ff8 fs5 fc8 sc0 ls0 ws4">&lt;capsule object &quot;Point *&quot; at 0x1004ea330&gt;</div><div class="t m0 x5 h10 y2351 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">ptexample</span></span></div><div class="t m0 x5 hf y129d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">ptexample<span class="fc6 ls34">.</span>print_point(p1)</span></div><div class="t m0 x5 hf y129e ff8 fs5 fc8 sc0 ls0 ws4">2.000000 3.000000</div><div class="t m0 x5 hf y129f ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y372d ff2 fs2 fc4 sc0 ls0 ws212">17.5.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y372e ff1 fs3 fc0 sc0 ls0 wsa0">本节基于一个前提就<span class="_ _6"></span>是，胶囊对象能获取任何你<span class="_ _6"></span>想要的对象的指针。这样<span class="_ _6"></span>的话，定</div><div class="t m0 x5 h9 y372f ff1 fs3 fc0 sc0 ls13 wse5">义模块会填充一个函数指针的结构体<span class="_ _1"></span>，创建一个指向它的胶囊，并在一个模块级属性<span class="_ _c"></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.5.<span class="_ _36"> </span>15.5 <span class="ff1 ws36c">从扩张模块中定义和导出 </span><span class="ls246">C<span class="ff1 ls81">的</span></span><span class="ws1405">API 563</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
