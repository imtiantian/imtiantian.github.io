<div id="pf192" class="pf w0 h0" data-page-no="192"><div class="pc pc192 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg192.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x17 hf y1ab ff8 fs5 fc0 sc0 ls0 ws13a">_post_import_hooks[fullname]<span class="fc6 ls34">.</span>append(func)</div><div class="t m0 x16 hf y1ac ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">func</span></div><div class="t m0 x15 hf y1ad ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">decorate</span></div><div class="t m0 x5 hf y1af ff8 fs5 fc0 sc0 ls0 ws13a">sys<span class="fc6 ls34">.</span>meta_path<span class="fc6 ls34">.</span>insert(<span class="fc7 ls34">0</span><span class="ws13b">, PostImportFinder())</span></div><div class="t m0 x0 h9 y25b ff1 fs3 fc0 sc0 ls0 ws38">这样，你就可以使用 <span class="ff6 ws17c">when<span class="_ _7"> </span>imported() </span>装饰器了，例如：</div><div class="t m0 x5 hf y80e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc wscaf">postimport </span><span class="ws146">import <span class="ff8 fc0">when_imported</span></span></span></div><div class="t m0 x5 hf y80f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fc12 ws156">@when_imported<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">threading</span>&apos;</span><span class="ls0">)</span></span></span></div><div class="t m0 x5 hf y810 ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">def <span class="ff8 fcb ws13a">warn_threads<span class="fc0">(mod):</span></span></span></div><div class="t m0 x5 hf y290f ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws4">Threads? Are you crazy?<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></span></div><div class="t m0 x5 h10 y2910 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y2911 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h10 y2912 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">threading</span></span></div><div class="t m0 x5 hf y2913 ff8 fs5 fc8 sc0 ls0 ws4">Threads? Are you crazy?</div><div class="t m0 x5 hf y39 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y2914 ff1 fs3 fc0 sc0 ls0">作为一个更实际的例子，你可能想在已存在的定义上面添加装饰器，如下所示：</div><div class="t m0 x5 hf y2915 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">wraps</span></span></div><div class="t m0 x5 hf y2916 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscaf">postimport </span><span class="ws146">import <span class="ff8 fc0">when_imported</span></span></div><div class="t m0 x5 hf y2917 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">logged<span class="fc0">(func):</span></span></div><div class="t m0 x15 hf y2918 ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x15 hf y2919 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws458">args, </span>**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x16 hf y17f5 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">Calling</span>&apos;</span><span class="ls0 ws13b">, func</span><span class="fc6">.</span><span class="ls0 ws13b">__name__, args, kwargs)</span></span></div><div class="t m0 x16 hf y291a ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">func(<span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs)</span></div><div class="t m0 x15 hf y291b ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x5 h11 y291c ffa fs5 fcd sc0 ls0 ws4"># Example</div><div class="t m0 x5 hf y291d ff7 fs5 fc12 sc0 ls0 ws156">@when_imported<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">math<span class="ff9 ws13b">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y291e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add_logging<span class="fc0">(mod):</span></span></div><div class="t m0 x15 hf y291f ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws158">cos <span class="fc6 ls32">=</span></span>logged(mod<span class="fc6 ls34">.</span>cos)</div><div class="t m0 x15 hf y2920 ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws158">sin <span class="fc6 ls32">=</span></span>logged(mod<span class="fc6 ls34">.</span>sin)</div><div class="t m0 x5 he y2921 ff2 fs2 fc4 sc0 ls0 wsadf">12.12.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y2922 ff1 fs3 fc0 sc0 ls0 ws38">本节技术依赖于 <span class="ff4 ws2aa">10.11 </span>小节中讲述过的导入钩子，并稍作修改。</div><div class="t m0 x0 h9 y2923 ff6 fs3 fc0 sc0 ls0 ws27d">@when imported<span class="_ _26"> </span><span class="ff1 ls1cb wse2e">装饰器的作用是注册在导入时被激活的处理器函数<span class="_ _8"></span>。该装饰<span class="_ _19"></span></span></div><div class="t m0 x5 h7 y2924 ff1 fs3 fc0 sc0 lsdf wse2f">器检查 <span class="ff4 ls0 wse30">sys.mo<span class="_ _6"></span>dules </span><span class="ws52f">来查看模块是否真的已经被加载了<span class="_ _19"></span>。如果是的话<span class="_ _8"></span>，该处理器<span class="_ _8"></span></span></div><div class="t m0 x5 h9 y2925 ff1 fs3 fc0 sc0 ls0 wse31">被<span class="_ _0"></span>立<span class="_ _0"></span>即<span class="_ _12"></span>调<span class="_ _0"></span>用。<span class="_ _0"></span>不<span class="_ _12"></span>然，<span class="_ _0"></span>处<span class="_ _0"></span>理<span class="_ _12"></span>器<span class="_ _0"></span>被<span class="_ _0"></span>添<span class="_ _0"></span>加<span class="_ _12"></span>到 <span class="ff6 ws3cd">post import hooks<span class="_ _b"> </span></span><span class="ls1cc wse32">字典中的一个列表中去<span class="_ _d"></span>。<span class="_ _d"></span></span></div><div class="t m0 x33 h9 y2926 ff6 fs3 fc0 sc0 ls0 ws3cd">post import hooks <span class="ff1 ls40 ws180">的作用就是收集所有的为每个模块注册的处理器对象。一个模块<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y22fd ff1 fs3 fc0 sc0 ls0">可以注册多个处理器。</div><div class="t m0 x0 h7 y2927 ff1 fs3 fc0 sc0 ls0 wsa0">要让模块导入后触发添加的动作，<span class="_ _c"></span><span class="ff6 wse33">PostImportFinder <span class="ff1 wse34">类被设置为 <span class="ff4 wse35">sys.meta<span class="_ _7"> </span>path </span>第</span></span></div><div class="t m0 x5 h9 y2928 ff1 fs3 fc0 sc0 ls0">一个元素。它会捕获所有模块导入操作。</div><div class="t m0 x0 h9 y2929 ff1 fs3 fc0 sc0 ls0 wse36">本<span class="_ _24"></span>节<span class="_ _24"> </span>中<span class="_ _25"> </span>的 <span class="ff6 wse37">PostImportFinder </span><span class="ls1cd wse38">的作用并不是加载模块<span class="_ _1d"></span>，而是自带导入完成后<span class="_ _19"></span></span></div><div class="t m0 x5 h7 y292a ff1 fs3 fc0 sc0 ls191 wse39">触发相应的动作<span class="_ _1f"></span>。实际的导入被委派给位于 <span class="ff4 ls0 wse3a">sys.meta path<span class="_ _34"> </span><span class="ff1 wsbe1">中 的 其 他 查 找 器。</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">12.12.<span class="_ _5"> </span>10.12 <span class="ff1 wse2d">导入模块的同时修改模块 </span>393</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
