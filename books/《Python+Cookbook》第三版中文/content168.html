<div id="pfa8" class="pf w0 h0" data-page-no="a8"><div class="pc pca8 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bga8.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff6 fs3 fc0 sc0 ls0 ws293">detach() <span class="ff1 ls2d ws132">方法会断开文件的最顶层并返回第二层，之后最顶层就没什么用了<span class="_ _c"></span>。例</span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">如：</div><div class="t m0 x5 hf y1250 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=<span class="fca ls0 ws13a">open<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">sample.txt<span class="ff9 ls34">&apos;</span></span><span class="ls33">,</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">w<span class="ff9">&apos;</span></span></span>)</span></span></span></span></div><div class="t m0 x5 hf y1251 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">f</span></div><div class="t m0 x5 hf y1252 ff8 fs5 fc8 sc0 ls0 ws4">&lt;_io.TextIOWrapper name=<span class="ff9 ls34">&apos;</span><span class="ws13a">sample.txt<span class="ff9 ls33">&apos;</span>mode=<span class="ff9 ws13b">&apos;</span><span class="ls34">w<span class="ff9 ls32">&apos;</span></span>encoding=<span class="ff9 ls34">&apos;</span>UTF-8<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y1253 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">b<span class="fc6 ls33">=</span><span class="ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">detach()</span></span></span></span></div><div class="t m0 x5 hf y1254 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">b</span></div><div class="t m0 x5 hf y1255 ff8 fs5 fc8 sc0 ls0 ws4">&lt;_io.BufferedWriter name=<span class="ff9 ls34">&apos;</span><span class="ws13a">sample.txt<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y1256 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">write(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">hello<span class="ff9 ls34">&apos;</span></span>)</span></span></span></div><div class="t m0 x5 hf y1257 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y1258 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x5 hf yf3 ff8 fs5 fc2 sc0 ls0 ws13a">ValueError<span class="fc0 ws4">: underlying buffer has been detached</span></div><div class="t m0 x5 hf y1259 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y125a ff1 fs3 fc0 sc0 ls0">一旦断开最顶层后，你就可以给返回结果添加一个新的最顶层。比如：</div><div class="t m0 x5 hf y125b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=</span><span class="ls0 ws13a">io<span class="fc6 ls34">.</span><span class="ws4">TextIOWrapper(b, encoding<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span></span><span class="fc9">latin-1<span class="ff9 ws13b">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y125c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">f</span></div><div class="t m0 x5 hf y125d ff8 fs5 fc8 sc0 ls0 ws4">&lt;_io.TextIOWrapper name=<span class="ff9 ls34">&apos;</span><span class="ws13a">sample.txt<span class="ff9 ls33">&apos;</span>encoding=<span class="ff9 ls34">&apos;</span>latin-1<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y125e ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y125f ff1 fs3 fc0 sc0 ls3a ws153">尽管已经向你演示了改变编码的方法，但是你还可以利用这种技术来改变文件行处</div><div class="t m0 x5 h9 y1260 ff1 fs3 fc0 sc0 ls0">理、错误机制以及文件处理的其他方面。例如：</div><div class="t m0 x5 hf y1261 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span><span class="ws145">stdout <span class="fc6 ls32">=</span></span>io<span class="fc6 ls34">.</span>TextIOWrapper(sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span><span class="ws13b">detach(), encoding<span class="fc6 ls34">=</span><span class="ff9 fc9">&apos;</span></span><span class="fc9">ascii<span class="ff9 ls34">&apos;</span></span>,</span></div><div class="t m0 x5 hf y1262 ff7 fs5 fc5 sc0 ls0 ws6f3">... <span class="ff8 fc0 ws13a">errors<span class="fc6">=<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">xmlcharrefreplace<span class="ff9 ls34">&apos;</span></span></span>)</span></div><div class="t m0 x5 hf y1263 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Jalape</span></span><span class="fc9">\u00f1<span class="ff8 ws13a">o<span class="ff9 ls34">&apos;</span><span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y1264 ff8 fs5 fc8 sc0 ls0">Jalape&amp;#241;o</div><div class="t m0 x5 hf y1265 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y1266 ff1 fs3 fc0 sc0 ls0 wsc">注意下最后输出中的非 <span class="ff4 ws6f4">ASCI<span class="_ _6"></span>I </span>字符 <span class="ff6 ls73">ñ</span><span class="ws14">是如何被 <span class="ff6 ws3ce">&amp;#241; </span>取代的。</span></div><div class="t m0 x5 hd y1267 ff2 fs4 fc4 sc0 ls0 ws211">7.17<span class="_ _e"> </span>5.17 <span class="ff1">将字节写入文本文件</span></div><div class="t m0 x5 he y1268 ff2 fs2 fc4 sc0 ls0 ws212">7.17.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y1269 ff1 fs3 fc0 sc0 ls0">你想在文本模式打开的文件中写入原始的字节数据。</div><div class="t m0 x5 he y126a ff2 fs2 fc4 sc0 ls0 ws212">7.17.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y126b ff1 fs3 fc0 sc0 ls0">将字节数据直接写入文件的缓冲区即可，例如：</div><div class="t m0 x5 h10 y83d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sys</span></span></div><div class="t m0 x5 hf y83e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span>write(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Hello<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;</span></span></span>)</span></div><div class="t m0 x5 hf ycf5 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y83f ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x5 hf y840 ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: must be str, not bytes</span></div><div class="t m0 x5 hf y841 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span>buffer<span class="fc6 ls34">.</span>write(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Hello<span class="ff7 ws156">\n<span class="ff9 ls34">&apos;</span></span></span>)</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">7.17.<span class="_ _5"> </span>5.17 <span class="ff1 ws544">将字节写入文本文件 </span>159</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
