<div id="pf186" class="pf w0 h0" data-page-no="186"><div class="pc pc186 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg186.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x17 hf y334 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">None</span></div><div class="t m0 x15 hf y336 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">invalidate_caches<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y337 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">invalidating link cache<span class="ff9">&apos;</span></span>)</div><div class="t m0 x16 hf yadd ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_links</span><span class="ls34">.</span><span class="fc0">clear()</span></span></div><div class="t m0 x5 h11 yadf ffa fs5 fcd sc0 ls0 ws4"># Module Loader for a URL</div><div class="t m0 x5 hf yc64 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">UrlModuleLoader<span class="ff8 fc0 ws13a">(importlib<span class="fc6">.</span>abc<span class="fc6 ls34">.</span>SourceLoader):</span></span></div><div class="t m0 x15 hf y1555 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, baseurl):</span></span></span></div><div class="t m0 x16 hf y177c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">_baseurl </span><span class="ls32">=</span><span class="fc0">baseurl</span></span></div><div class="t m0 x16 hf y177d ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws5a4">_source_cache </span><span class="ls32">=</span><span class="fc0">{}</span></span></div><div class="t m0 x15 hf y177f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">module_repr<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, module):</span></span></span></div><div class="t m0 x16 hf y1780 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws2a3">&lt;urlmodule <span class="ffa fcf ws159">%r </span><span class="ws161">from <span class="ffa fcf ws13a">%r</span><span class="ls34">&gt;</span></span></span><span class="ls32">&apos;<span class="ff8 fc6 ls33">%<span class="fc0 ls0 ws13a">(module<span class="fc6">.</span><span class="ws4">__name__, module</span></span><span class="ls34">.<span class="fc0 ls0">__file__)</span></span></span></span></span></div><div class="t m0 x15 h11 y1782 ffa fs5 fcd sc0 ls0 ws13b"># Required method</div><div class="t m0 x15 hf y1783 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">load_module<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fullname):</span></span></span></div><div class="t m0 x16 hf y1784 ff8 fs5 fc0 sc0 ls0 ws161">code <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span>get_code(fullname)</div><div class="t m0 x16 hf y1785 ff8 fs5 fc0 sc0 ls0 ws158">mod <span class="fc6 ls32">=</span><span class="ws13a">sys<span class="fc6 ls34">.</span>modules<span class="fc6 ls34">.</span><span class="ws13b">setdefault(fullname, imp<span class="fc6 ls34">.</span>new_module(fullname))</span></span></div><div class="t m0 x16 hf y1786 ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws1f5">__file__ <span class="fc6 ls33">=</span></span><span class="fca">self<span class="fc6">.</span></span>get_filename(fullname)</div><div class="t m0 x16 hf y1787 ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws2a3">__loader__ <span class="fc6 ls32">=</span><span class="fca">self</span></span></div><div class="t m0 x16 hf y1788 ff8 fs5 fc0 sc0 ls0 ws13a">mod<span class="fc6 ls34">.</span><span class="ws6c3">__package__ <span class="fc6 ls33">=</span></span>fullname<span class="fc6">.</span>rpartition(<span class="ff9 fc9 ls34">&apos;<span class="ff8">.</span>&apos;</span>)[<span class="fc7 ls34">0</span>]</div><div class="t m0 x16 hf y1789 ff7 fs5 fca sc0 ls0 ws156">exec<span class="ff8 fc0 ws13b">(code, mod<span class="fc6 ls34">.</span>__dict__)</span></div><div class="t m0 x16 hf y178a ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">mod</span></div><div class="t m0 x15 h11 y178c ffa fs5 fcd sc0 ls0 ws13b"># Optional extensions</div><div class="t m0 x15 hf y178d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_code<span class="fc0">(<span class="fca">self</span><span class="ws4">, fullname):</span></span></span></div><div class="t m0 x16 hf y178e ff8 fs5 fc0 sc0 ls0 ws158">src <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span>get_source(fullname)</div><div class="t m0 x16 hf y178f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">compile<span class="fc0 ws15f">(src, </span>self<span class="fc6 ls34">.</span><span class="fc0 wscb8">get_filename(fullname), <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">exec<span class="ff9 ls34">&apos;</span><span class="fc0">)</span></span></span></div><div class="t m0 x15 hf y1790 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_data<span class="fc0">(<span class="fca">self</span><span class="ws4">, path):</span></span></span></div><div class="t m0 x16 h10 y1791 ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x15 hf y10dc ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_filename<span class="fc0">(<span class="fca">self</span><span class="ws4">, fullname):</span></span></span></div><div class="t m0 x16 hf y12d0 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0 ws1f5">_baseurl <span class="fc6 ls33">+</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">/</span><span class="ls32">&apos;</span></span><span class="fc6 ls33">+</span><span class="ws13a">fullname<span class="fc6">.</span>split(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">.<span class="ff9 ls34">&apos;</span></span>)[<span class="fc6 ls34">-<span class="fc7">1</span></span><span class="ls32">]<span class="fc6 ls33">+<span class="ff9 fc9 ls34">&apos;</span></span></span><span class="fc9">.py<span class="ff9">&apos;</span></span></span></span></span></div><div class="t m0 x15 hf y12d2 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_source<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, fullname):</span></span></span></div><div class="t m0 x16 hf y12d3 ff8 fs5 fc0 sc0 ls0 ws1f5">filename <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.</span></span>get_filename(fullname)</div><div class="t m0 x16 hf y12d4 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">loader: reading </span><span class="ffa fcf">%r<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws13b">, filename)</span></div><div class="t m0 x16 hf y1793 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">filename </span>in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_source_cache:</span></span></span></div><div class="t m0 x17 hf y1794 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13b">loader: cached </span><span class="ffa fcf">%r<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws13b">, filename)</span></div><div class="t m0 x17 hf y1795 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_source_cache[filename]</span></span></span></div><div class="t m0 x16 hf y1796 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y1797 ff8 fs5 fc0 sc0 ls32">u<span class="fc6 ls33">=</span><span class="ls0">urlopen(filename)</span></div><div class="t m0 x17 hf y1798 ff8 fs5 fc0 sc0 ls0 ws145">source <span class="fc6 ls32">=</span><span class="ls34">u<span class="fc6">.</span></span><span class="ws13a">read()<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x17 hf y1799 ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws155">loader: <span class="ffa fcf ws159">%r </span><span class="ws13a">loaded<span class="ff9 ls34">&apos;</span></span></span><span class="ws13b">, filename)</span></div><div class="t m0 x17 hf y179a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 wsda8">_source_cache[filename] </span><span class="ls32">=</span><span class="fc0">source</span></span></div><div class="t m0 x17 hf y179b ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">source</span></div><div class="t m0 x16 hf y179c ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 fc0 ws13b">(HTTPError, URLError) </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x17 hf y179d ff8 fs5 fc0 sc0 ls0 ws13a">log<span class="fc6 ls34">.</span>debug(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws155">loader: <span class="ffa fcf ws159">%r </span>failed. </span><span class="ffa fcf">%s<span class="ff9 fc9 ls34">&apos;</span></span><span class="ws13b">, filename, e)</span></div><div class="t m0 x17 hf y179e ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">ImportError<span class="fc0 ls34">(</span><span class="fc9">&quot;Can<span class="ff9 ws13b">&apos;</span><span class="ws4">t load </span><span class="ffa fcf">%s</span><span class="ls32">&quot;<span class="fc6 ls33">%</span></span><span class="fc0">filename)</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">12.11.<span class="_ _5"> </span>10.11 <span class="ff1 wsd98">通过钩子远程加载模块 </span>381</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
