<div id="pfa6" class="pf w0 h0" data-page-no="a6"><div class="pc pca6 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bga6.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls11b">在<span class="ff6 ls0 ws6e1">bad filename() </span><span class="ls42 ws186">函数中怎样处置取决于你自己。另外一个选择就是通过某种方</span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0">式重新编码，示例如下：</div><div class="t m0 x5 hf y48d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">bad_filename<span class="fc0">(filename):</span></span></div><div class="t m0 x15 hf y48e ff8 fs5 fc0 sc0 ls0 ws13c">temp <span class="fc6 ls32">=</span><span class="ws13a">filename<span class="fc6 ls34">.</span>encode(sys<span class="fc6 ls34">.</span><span class="ws13b">getfilesystemencoding(), errors<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span></span><span class="fc9">surrogateescape<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf y48f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">temp<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">latin-1<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x0 h7 y1215 ff1 fs3 fc0 sc0 ls0 wsa0">译者注<span class="ff4">:</span></div><div class="t m0 x5 hf y1216 ff8 fs5 fc0 sc0 ls0">surrogateescape:</div><div class="t m0 x5 hf y517 ffc fs6 fc0 sc0 ls0 ws6e2">这种是 <span class="ff8 fs5 ws145">Python </span><span class="ws235">在绝大部分面向 <span class="ff8 fs5 ws159">OS </span><span class="ls11c">的</span><span class="ff8 fs5 ws158">API </span>中所使用的错误处理器，</span></div><div class="t m0 x5 h12 y518 ffc fs6 fc0 sc0 ls0">它能以一种优雅的方式处理由操作系统提供的数据的编码问题。</div><div class="t m0 x5 hf y519 ffc fs6 fc0 sc0 ls0 ws6e3">在解码出错时会将出错字节存储到一个很少被使用到的 <span class="ff8 fs5 ws155">Unicode </span>编码范围内。</div><div class="t m0 x5 h12 y51a ffc fs6 fc0 sc0 ls0">在编码时将那些隐藏值又还原回原先解码失败的字节序列。</div><div class="t m0 x5 hf y51b ffc fs6 fc0 sc0 ls0 ws6e4">它不仅对于 <span class="ff8 fs5 ws13b">OS API </span>非常有用，也能很容易的处理其他情况下的编码错误。</div><div class="t m0 x0 h9 y1217 ff1 fs3 fc0 sc0 ls0">使用这个版本产生的输出如下：</div><div class="t m0 x5 hf y1218 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">for <span class="ff8 fc0 ws161">name </span><span class="ws160">in <span class="ff8 fc0">files:</span></span></span></div><div class="t m0 x5 hf y1219 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">try<span class="ff8 fc0">:</span></span></div><div class="t m0 x5 hf y121a ff7 fs5 fc5 sc0 ls0 ws1a3">... <span class="fca ws156">print<span class="ff8 fc0">(name)</span></span></div><div class="t m0 x5 hf y121b ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws146">except <span class="ff8 ws13a">UnicodeEncodeError<span class="fc0">:</span></span></span></div><div class="t m0 x5 hf y121c ff7 fs5 fc5 sc0 ls0 ws1a3">... <span class="fca ws156">print<span class="ff8 fc0">(bad_filename(name))</span></span></div><div class="t m0 x5 h10 y263 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y121d ff8 fs5 fc8 sc0 ls0">spam.py</div><div class="t m0 x5 hf y121e ff8 fs5 fc8 sc0 ls0">bäd.txt</div><div class="t m0 x5 hf y121f ff8 fs5 fc8 sc0 ls0">foo.txt</div><div class="t m0 x5 hf y1220 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1221 ff1 fs3 fc0 sc0 ls3a ws153">这一小节主题可能会被大部分读者所忽略。但是如果你在编写依赖文件名和文件系</div><div class="t m0 x5 h9 y1222 ff1 fs3 fc0 sc0 ls13 wse5">统的关键任务程序时<span class="_ _1"></span>，就必须得考虑到这个。否则你可能会在某个周末被叫到办公室<span class="_ _c"></span></div><div class="t m0 x5 h9 y1223 ff1 fs3 fc0 sc0 ls0">去调试一些令人费解的错误。</div><div class="t m0 x5 hd y1224 ff2 fs4 fc4 sc0 ls0 ws211">7.16<span class="_ _e"> </span>5.16 <span class="ff1">增加或改变已打开文件的编码</span></div><div class="t m0 x5 he y1225 ff2 fs2 fc4 sc0 ls0 ws212">7.16.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y1226 ff1 fs3 fc0 sc0 ls0 ws14">你想在不关闭一个已打开的文件前提下增加或改变它的 <span class="ff4 wsc1">Unico<span class="_ _6"></span>de </span>编码。</div><div class="t m0 x5 he y1227 ff2 fs2 fc4 sc0 ls0 ws212">7.16.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y1228 ff1 fs3 fc0 sc0 lsa8 ws6e5">如果你想给一个以二进制模式打开的文件添加 <span class="ff4 ls0 ws6e6">Unico<span class="_ _6"></span>de <span class="ff1 wsa0">编码</span><span class="wsa5">/</span></span><span class="ws3de">解码方式，可以使用</span></div><div class="t m0 x5 h9 y1229 ff6 fs3 fc0 sc0 ls0 ws59a">io.TextIOWrapper() <span class="ff1">对象包装它。比如：</span></div><div class="t m0 x5 h10 y1191 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">urllib.request</span></div><div class="t m0 x5 h10 y1192 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">io</span></div><div class="t m0 x5 hf y122a ff8 fs5 fc0 sc0 ls32">u<span class="fc6 ls33">=</span><span class="ls0 ws13a">urllib<span class="fc6 ls34">.</span>request<span class="fc6 ls34">.</span>urlopen(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">http://www.python.org<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">7.16.<span class="_ _5"> </span>5.16 <span class="ff1 ws6e7">增加或改变已打开文件的编码 </span>157</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
