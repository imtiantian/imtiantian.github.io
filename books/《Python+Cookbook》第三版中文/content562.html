<div id="pf232" class="pf w0 h0" data-page-no="232"><div class="pc pc232 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg232.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff8 fs5 fc0 sc0 ls0">};</div><div class="t m0 x5 hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">/* Module structure */</div><div class="t m0 x5 hf y1ae ff8 fs5 fc0 sc0 ls0 ws4">static struct PyModuleDef samplemodule = {</div><div class="t m0 x19 hf y1af ff8 fs5 fc0 sc0 ls0">PyModuleDef_HEAD_INIT,</div><div class="t m0 x19 hf y355 ff8 fs5 fc0 sc0 ls0 ws4">&quot;sample&quot;,<span class="_ _42"> </span>/* name of module */</div><div class="t m0 x19 hf y410 ff8 fs5 fc0 sc0 ls0 ws4">&quot;A sample module&quot;,<span class="_ _29"> </span>/* Doc string (may be NULL) */</div><div class="t m0 x19 hf y411 ff8 fs5 fc0 sc0 ls0 ws4">-1,<span class="_ _43"> </span>/* Size of per-interpreter state or -1 */</div><div class="t m0 x19 hf yba ff8 fs5 fc0 sc0 ls0 ws4">SampleMethods<span class="_ _41"> </span>/* Method table */</div><div class="t m0 x5 hf y8c6 ff8 fs5 fc0 sc0 ls0">};</div><div class="t m0 x5 hf ybee ff8 fs5 fc0 sc0 ls0 ws4">/* Module initialization function */</div><div class="t m0 x5 hf ybef ff8 fs5 fc0 sc0 ls0">PyMODINIT_FUNC</div><div class="t m0 x5 hf ybf0 ff8 fs5 fc0 sc0 ls0 ws4">PyInit_sample(void) {</div><div class="t m0 x19 hf yd7d ff8 fs5 fc0 sc0 ls0 ws4">return PyModule_Create(&amp;samplemodule);</div><div class="t m0 x5 hf ybf1 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y28ad ff1 fs3 fc0 sc0 ls0 ws38">要绑定这个扩展模块，像下面这样创建一个 <span class="ff6 ws1f3">setup.py </span>文件：</div><div class="t m0 x5 h11 y3652 ffa fs5 fcd sc0 ls0 ws4"># setup.py</div><div class="t m0 x5 hf y3653 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws2dd">distutils.core </span><span class="ws146">import <span class="ff8 fc0 ws13b">setup, Extension</span></span></div><div class="t m0 x5 hf y2984 ff8 fs5 fc0 sc0 ls0 ws13a">setup(name<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">sample<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x50 hf y3654 ff8 fs5 fc0 sc0 ls0 ws13a">ext_modules<span class="fc6 ls34">=</span>[</div><div class="t m0 x16 hf y86 ff8 fs5 fc0 sc0 ls0 ws13a">Extension(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">sample<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x34 hf y3655 ff8 fs5 fc0 sc0 ls34">[<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">pysample.c</span>&apos;</span><span class="ls0">],</span></div><div class="t m0 x34 hf y3656 ff8 fs5 fc0 sc0 ls0 ws3c7">include_dirs <span class="fc6 ls32">=</span><span class="ls34">[</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">/some/dir</span><span class="ls34">&apos;</span></span>],</div><div class="t m0 x34 hf y3657 ff8 fs5 fc0 sc0 ls0 ws147">define_macros <span class="fc6 ls33">=</span><span class="ws13a">[(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">FOO<span class="ff9 ls34">&apos;</span></span><span class="ls34">,</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">1<span class="ff9">&apos;</span></span></span>)],</span></div><div class="t m0 x34 hf y3658 ff8 fs5 fc0 sc0 ls0 ws3c7">undef_macros <span class="fc6 ls32">=</span><span class="ls34">[</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">BAR</span>&apos;</span>],</div><div class="t m0 x34 hf y255b ff8 fs5 fc0 sc0 ls0 ws3c7">library_dirs <span class="fc6 ls32">=</span><span class="ls34">[</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">/usr/local/lib</span>&apos;</span>],</div><div class="t m0 x34 hf y255c ff8 fs5 fc0 sc0 ls0 ws16e">libraries <span class="fc6 ls33">=</span><span class="ls34">[</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">sample</span>&apos;</span>]</div><div class="t m0 x34 hf y3659 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x16 hf y365a ff8 fs5 fc0 sc0 ls0">]</div><div class="t m0 x5 hf y365b ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x0 h9 y1aff ff1 fs3 fc0 sc0 ls0 ws13a6">为<span class="_ _0"></span>了<span class="_ _6"></span>构<span class="_ _0"></span>建<span class="_ _0"></span>最<span class="_ _0"></span>终<span class="_ _0"></span>的<span class="_ _6"></span>函<span class="_ _0"></span>数<span class="_ _0"></span>库，<span class="_ _0"></span>只<span class="_ _0"></span>需<span class="_ _6"></span>简<span class="_ _0"></span>单<span class="_ _0"></span>的<span class="_ _0"></span>使<span class="_ _6"></span>用 <span class="ff6 ws13a7">python3 buildlib.py build<span class="_ _7"> </span>ext --</span></div><div class="t m0 x5 h9 y365c ff6 fs3 fc0 sc0 ls0 ws23a">inplace <span class="ff1">命令即可：</span></div><div class="t m0 x5 hf y365d ff8 fs5 fc0 sc0 ls0 ws4">bash % python3 setup.py build_ext --inplace</div><div class="t m0 x5 hf y365e ff8 fs5 fc0 sc0 ls0 ws4">running build_ext</div><div class="t m0 x5 hf y365f ff8 fs5 fc0 sc0 ls0 ws16d">building <span class="ff9 ws13b">&apos;</span><span class="ws13a">sample<span class="ff9 ls32">&apos;</span>extension</span></div><div class="t m0 x5 hf y3660 ff8 fs5 fc0 sc0 ls0 ws4">gcc -fno-strict-aliasing -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes</div><div class="t m0 x4b hf y3661 ff8 fs5 fc0 sc0 ls0 ws13b">-I/usr/local/include/python3.3m -c pysample.c</div><div class="t m0 x4b hf y3662 ff8 fs5 fc0 sc0 ls0 ws13b">-o build/temp.macosx-10.6-x86_64-3.3/pysample.o</div><div class="t m0 x5 hf y3663 ff8 fs5 fc0 sc0 ls0 ws4">gcc -bundle -undefined dynamic_lookup</div><div class="t m0 x5 hf yde1 ff8 fs5 fc0 sc0 ls0 ws4">build/temp.macosx-10.6-x86_64-3.3/pysample.o \</div><div class="t m0 x4b hf y3664 ff8 fs5 fc0 sc0 ls0 ws4">-L/usr/local/lib -lsample -o sample.so</div><div class="t m0 x5 hf y3665 ff8 fs5 fc0 sc0 ls0 ws4">bash %</div><div class="t m0 x0 h9 y2fc4 ff1 fs3 fc0 sc0 ls6f ws13a8">如上所示<span class="_ _1"></span>，它会创建一个名字叫 <span class="ff6 ls0 ws418">sample.so </span><span class="ws2a7">的共享库<span class="_ _1"></span>。当被编译后<span class="_ _1"></span>，你就能将它<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y3666 ff1 fs3 fc0 sc0 ls0">作为一个模块导入进来了：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.2.<span class="_ _36"> </span>15.2 <span class="ff1 ws36c">简单的 </span><span class="ls246">C</span><span class="ff1 ws13a5">扩展模块 </span>553</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
