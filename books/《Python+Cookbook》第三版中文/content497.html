<div id="pf1f1" class="pf w0 h0" data-page-no="1f1"><div class="pc pc1f1 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1f1.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1e8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">daemonize<span class="fc0 ws51e">(pidfile, </span><span class="fc6">*<span class="fc0 ws4">, stdin</span>=<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">/dev/null<span class="ff9 ws13b">&apos;</span><span class="fc0">,</span></span></span></span></div><div class="t m0 x2d hf y1e9 ff8 fs5 fc0 sc0 ls0 ws13a">stdout<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">/dev/null<span class="ff9 ls34">&apos;</span></span>,</div><div class="t m0 x2d hf y1ea ff8 fs5 fc0 sc0 ls0 ws13a">stderr<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">/dev/null<span class="ff9 ls34">&apos;</span></span>):</div><div class="t m0 x15 hf y1eb ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">os<span class="fc6">.</span>path<span class="fc6 ls34">.</span>exists(pidfile):</span></div><div class="t m0 x16 hf y1ec ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Already running</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x15 h11 y905 ffa fs5 fcd sc0 ls0 ws4"># First fork (detaches from parent)</div><div class="t m0 x15 hf y906 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x16 hf y907 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">os<span class="fc6 ls34">.</span><span class="ws145">fork() <span class="fc6 ls33">&gt;</span></span><span class="fc7">0</span>:</span></div><div class="t m0 x17 hf y908 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">0</span><span class="lsa1">)</span></span><span class="ffa fcd ws13b"># Parent exit</span></span></div><div class="t m0 x15 hf y909 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws155">OSError </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x16 hf ybd8 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">fork #1 failed.</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x15 hf y90a ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>chdir(<span class="ff9 fc9 ls34">&apos;<span class="ff8">/</span>&apos;</span>)</div><div class="t m0 x15 hf y61 ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>umask(<span class="fc7 ls34">0</span>)</div><div class="t m0 x15 hf y90b ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>setsid()</div><div class="t m0 x15 h11 y90c ffa fs5 fcd sc0 ls0 ws4"># Second fork (relinquish session leadership)</div><div class="t m0 x15 hf y90d ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x16 hf y90e ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">os<span class="fc6 ls34">.</span><span class="ws145">fork() <span class="fc6 ls33">&gt;</span></span><span class="fc7">0</span>:</span></div><div class="t m0 x17 hf y90f ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">0</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf y910 ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws155">OSError </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x16 hf y911 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">fork #2 failed.</span><span class="ls34">&apos;</span></span><span class="fc0">)</span></span></div><div class="t m0 x15 h11 y912 ffa fs5 fcd sc0 ls0 ws4"># Flush I/O buffers</div><div class="t m0 x15 hf y913 ff8 fs5 fc0 sc0 ls0 ws13a">sys<span class="fc6 ls34">.</span>stdout<span class="fc6 ls34">.</span>flush()</div><div class="t m0 x15 hf y914 ff8 fs5 fc0 sc0 ls0 ws13a">sys<span class="fc6 ls34">.</span>stderr<span class="fc6 ls34">.</span>flush()</div><div class="t m0 x15 h11 y916 ffa fs5 fcd sc0 ls0 ws4"># Replace file descriptors for stdin, stdout, and stderr</div><div class="t m0 x15 hf y917 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws155">(stdin, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ls34">&apos;</span><span class="fc0 ls33">,</span><span class="fc7">0<span class="fc0 ls33">)</span></span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y2645 ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>dup2(f<span class="fc6 ls34">.</span><span class="ws4">fileno(), sys</span><span class="fc6">.</span>stdin<span class="fc6 ls34">.</span>fileno())</div><div class="t m0 x15 hf y918 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws16d">(stdout, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">ab<span class="ff9 ls34">&apos;</span><span class="fc0 ls32">,<span class="fc7 ls34">0</span><span class="ls33">)</span></span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y919 ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>dup2(f<span class="fc6 ls34">.</span><span class="ws4">fileno(), sys</span><span class="fc6">.</span>stdout<span class="fc6">.</span>fileno())</div><div class="t m0 x15 hf y91a ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0 ws16d">(stderr, <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">ab<span class="ff9 ls34">&apos;</span><span class="fc0 ls32">,<span class="fc7 ls34">0</span><span class="ls33">)</span></span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y30a6 ff8 fs5 fc0 sc0 ls0 ws13a">os<span class="fc6 ls34">.</span>dup2(f<span class="fc6 ls34">.</span><span class="ws4">fileno(), sys</span><span class="fc6">.</span>stderr<span class="fc6">.</span>fileno())</div><div class="t m0 x15 h11 y91c ffa fs5 fcd sc0 ls0 ws4"># Write the PID file</div><div class="t m0 x15 hf y91d ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 ws13a">open<span class="fc0">(pidfile,<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">w<span class="ff9 ls34">&apos;</span></span><span class="ls33">)</span></span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y91e ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(os<span class="fc6">.</span>getpid(),<span class="fca">file<span class="fc6 ls34">=</span></span>f)</span></div><div class="t m0 x15 h11 y920 ffa fs5 fcd sc0 ls0 ws4"># Arrange to have the PID file removed on exit/signal</div><div class="t m0 x15 hf y921 ff8 fs5 fc0 sc0 ls0 ws13a">atexit<span class="fc6 ls34">.</span>register(<span class="ff7 fca ws156">lambda</span><span class="ws13b">: os<span class="fc6 ls34">.</span>remove(pidfile))</span></div><div class="t m0 x15 h11 y922 ffa fs5 fcd sc0 ls0 ws4"># Signal handler for termination (required)</div><div class="t m0 x15 hf y923 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">sigterm_handler<span class="fc0 ws13b">(signo, frame):</span></span></div><div class="t m0 x16 hf y924 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">SystemExit<span class="fc0 ls34">(<span class="fc7">1</span><span class="ls0">)</span></span></span></div><div class="t m0 x15 hf yedf ff8 fs5 fc0 sc0 ls0 ws13a">signal<span class="fc6 ls34">.</span>signal(signal<span class="fc6 ls34">.</span><span class="ws4">SIGTERM, sigterm_handler)</span></div><div class="t m0 x5 hf y927 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">main<span class="fc0">():</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.14.<span class="_ _36"> </span>12.14 <span class="ff1 ls7f">在</span><span class="ws11b9">Unix <span class="ff1 ws11ba">系统上面启动守护进程 </span>488</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
