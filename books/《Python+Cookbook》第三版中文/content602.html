<div id="pf25a" class="pf w0 h0" data-page-no="25a"><div class="pc pc25a w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg25a.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h10 yb1e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sys</span></span></div><div class="t m0 x5 hf yb1f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalape<span class="ff7 ws156">\u00f1</span><span class="ws13a">o<span class="ff9">&apos;</span></span></span></span></span></span></div><div class="t m0 x5 hf yb20 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>getsizeof(s)</span></div><div class="t m0 x5 hf yb21 ff8 fs5 fc8 sc0 ls0">87</div><div class="t m0 x5 hf yb22 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">print_chars(s)</span></div><div class="t m0 x5 hf yb23 ff8 fs5 fc8 sc0 ls0 ws4">53 70 69 63 79 20 4a 61 6c 61 70 65 c3 b1 6f</div><div class="t m0 x5 hf yb24 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>getsizeof(s)</span></div><div class="t m0 x5 hf yb25 ff8 fs5 fc8 sc0 ls0">103</div><div class="t m0 x5 hf yb26 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">print_wchars(s)</span></div><div class="t m0 x5 hf yb27 ff8 fs5 fc8 sc0 ls0 ws4">53 70 69 63 79 20 4a 61 6c 61 70 65 f1 6f</div><div class="t m0 x5 hf yfda ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>getsizeof(s)</span></div><div class="t m0 x5 hf y1e41 ff8 fs5 fc8 sc0 ls0">163</div><div class="t m0 x5 hf y1e42 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y39ce ff1 fs3 fc0 sc0 ls3a ws153">对于少量的字符串对象，可能没什么影响，但是如果你需要在扩展中处理大量的文</div><div class="t m0 x5 h9 yca4 ff1 fs3 fc0 sc0 ls0">本，你可能想避免这个损耗了。下面是一个修订版本可以避免这种内存损耗：</div><div class="t m0 x5 hf y39cf ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_chars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y39d0 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj, *bytes;</div><div class="t m0 x19 hf y39d1 ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x19 hf y39d2 ff8 fs5 fc0 sc0 ls0 ws1305">Py_ssize_t len;</div><div class="t m0 x19 hf y39d3 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;U&quot;, &amp;obj)) {</div><div class="t m0 x15 hf y39d4 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y39d5 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y2b6b ff8 fs5 fc0 sc0 ls0 ws4">bytes = PyUnicode_AsUTF8String(obj);</div><div class="t m0 x19 hf y39d6 ff8 fs5 fc0 sc0 ls0 ws4">PyBytes_AsStringAndSize(bytes, &amp;s, &amp;len);</div><div class="t m0 x19 hf y2a76 ff8 fs5 fc0 sc0 ls0 ws4">print_chars(s, len);</div><div class="t m0 x19 hf y2a77 ff8 fs5 fc0 sc0 ls0">Py_DECREF(bytes);</div><div class="t m0 x19 hf y2a78 ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y2a79 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y39d7 ff1 fs3 fc0 sc0 ls0 ws758">而对 <span class="ff6 ws1580">wchar t </span><span class="wsa0">的<span class="_ _6"></span>处<span class="_ _6"></span>理时<span class="_ _6"></span>想<span class="_ _6"></span>要避<span class="_ _6"></span>免<span class="_ _6"></span>内存<span class="_ _6"></span>损<span class="_ _6"></span>耗就<span class="_ _6"></span>更<span class="_ _6"></span>加难<span class="_ _6"></span>办<span class="_ _6"></span>了。在<span class="_ _6"></span>内部，<span class="_ _6"></span><span class="ff4 ws759">Python </span>使<span class="_ _6"></span>用最</span></div><div class="t m0 x5 h7 y39d8 ff1 fs3 fc0 sc0 ls19 ws1581">高效的表示来存储字符串。例如<span class="_ _1"></span>，只包含 <span class="ff4 ls0 ws1582">ASCI<span class="_ _6"></span>I </span><span class="ws22a">的字符串被存储为字节数组，而包含<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y39d9 ff1 fs3 fc0 sc0 ls0 ws689">范围从 <span class="ff4 ws1583">U+0000 </span><span class="ls8f">到</span><span class="ff4 ws1584">U+FFFF </span><span class="wsa0">的字符的字符串使用双字节表示。由于对于数据的表示形</span></div><div class="t m0 x5 h9 y39da ff1 fs3 fc0 sc0 ls22 ws1585">式不是单一的，你不能将内部数组转换为 <span class="ff6 ls0 ws1586">wchar t<span class="_ _23"> </span>* </span><span class="ws119">然后期望它能正确的工作<span class="_ _1"></span>。你应</span></div><div class="t m0 x5 h7 y39db ff1 fs3 fc0 sc0 ls0 ws1587">该创<span class="_ _6"></span>建一个 <span class="ff6 ws1588">wchar<span class="_ _7"> </span>t </span><span class="ws1589">数组<span class="_ _6"></span>并向<span class="_ _6"></span>其中复<span class="_ _6"></span>制文<span class="_ _6"></span>本。 <span class="ff6 ws335">PyArg ParseTuple() </span><span class="wsa0">的<span class="ff4 ws158a">”u#” </span>格式<span class="_ _6"></span>码可</span></span></div><div class="t m0 x5 h9 y1a42 ff1 fs3 fc0 sc0 ls0 wsa0">以帮助你高效的完成它（它将复制结果附加到字符串对象上）<span class="_ _f"></span>。</div><div class="t m0 x0 h7 y39dc ff1 fs3 fc0 sc0 ls0 ws158b">如果你想避免长时间内存损耗，你唯一的选择就是复制 <span class="ff4 ws158c">Unicode </span>数据懂啊一个临时</div><div class="t m0 x5 h7 y39dd ff1 fs3 fc0 sc0 ls0 ws38">的数组，将它传递给 <span class="ff4 ls8">C</span>函数，然后回收这个数组的内存。下面是一个可能的实现：</div><div class="t m0 x5 hf y39de ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_wchars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y39df ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj;</div><div class="t m0 x19 hf y39e0 ff8 fs5 fc0 sc0 ls0 ws4">wchar_t *s;</div><div class="t m0 x19 hf y39e1 ff8 fs5 fc0 sc0 ls0 ws4">Py_ssize_t len;</div><div class="t m0 x19 hf y39e2 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;U&quot;, &amp;obj)) {</div><div class="t m0 x15 hf y39e3 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y39e4 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y39e5 ff8 fs5 fc0 sc0 ls0 ws4">if ((s = PyUnicode_AsWideCharString(obj, &amp;len)) == NULL) {</div><div class="t m0 x15 hf y39e6 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.14.<span class="_ _36"> </span>15.14 <span class="ff1 ws16b">传递 </span><span class="ws342">Unico<span class="_ _0"></span>de <span class="ff1 ws16b">字符串给 </span><span class="ls246">C</span><span class="ff1 ws1573">函数库 </span>593</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
