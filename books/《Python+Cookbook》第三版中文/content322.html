<div id="pf142" class="pf w0 h0" data-page-no="142"><div class="pc pc142 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg142.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y15f ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x15 hf y160 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;contract.py&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">33</span><span class="ls32">,</span><span class="ff7 fca ws157">in </span>wrapper</span></div><div class="t m0 x5 hf y956 ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: Argument y must be &lt;class <span class="ff9 ls34">&apos;</span><span class="ws13a">int<span class="ff9 ls34">&apos;</span>&gt;</span></span></div><div class="t m0 x5 hf y957 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y21d2 ff1 fs3 fc0 sc0 ls0 ws38">下面是使用装饰器技术来实现 <span class="ff6 ws1e2">@typeassert </span>：</div><div class="t m0 x5 hf y21d3 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws2f0">inspect </span><span class="ws1ff">import <span class="ff8 fc0">signature</span></span></div><div class="t m0 x5 hf y21d4 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">wraps</span></span></div><div class="t m0 x5 hf y21d5 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">typeassert<span class="fc0 ls34">(<span class="fc6">*</span><span class="ls0 ws1f5">ty_args, </span><span class="fc6">**</span><span class="ls0">ty_kwargs):</span></span></span></div><div class="t m0 x15 hf y21d6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decorate<span class="fc0">(func):</span></span></div><div class="t m0 x16 h11 y21d7 ffa fs5 fcd sc0 ls0 ws4"># If in optimized mode, disable type checking</div><div class="t m0 x16 hf y21d8 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">__debug__:</span></div><div class="t m0 x17 hf y21d9 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">func</span></div><div class="t m0 x16 h11 y21da ffa fs5 fcd sc0 ls0 ws4"># Map function argument names to supplied types</div><div class="t m0 x16 hf y21db ff8 fs5 fc0 sc0 ls0 ws158">sig <span class="fc6 ls32">=</span>signature(func)</div><div class="t m0 x16 hf y1d7c ff8 fs5 fc0 sc0 ls0 ws208">bound_types <span class="fc6 ls32">=</span><span class="ws13a">sig<span class="fc6 ls34">.</span>bind_partial(<span class="fc6 ls34">*</span><span class="ws16d">ty_args, </span><span class="fc6">**</span>ty_kwargs)<span class="fc6 ls34">.</span>arguments</span></div><div class="t m0 x16 hf y1d7e ff7 fs5 fc12 sc0 ls0 ws156">@wraps<span class="ff8 fc0">(func)</span></div><div class="t m0 x16 hf y1d7f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">wrapper<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0 ws458">args, </span>**<span class="fc0">kwargs):</span></span></span></div><div class="t m0 x17 hf y1d80 ff8 fs5 fc0 sc0 ls0 ws150">bound_values <span class="fc6 ls33">=</span><span class="ws13a">sig<span class="fc6 ls34">.</span>bind(<span class="fc6 ls34">*</span><span class="ws15f">args, <span class="fc6 ls34">**</span>kwargs)</span></span></div><div class="t m0 x17 h11 y1b6d ffa fs5 fcd sc0 ls0 ws4"># Enforce type assertions across supplied arguments</div><div class="t m0 x17 hf y1b6e ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">name, value </span><span class="ws160">in <span class="ff8 fc0 ws13a">bound_values<span class="fc6 ls34">.</span>arguments<span class="fc6">.</span>items():</span></span></div><div class="t m0 x18 hf y21dc ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws161">name </span><span class="ws160">in <span class="ff8 fc0">bound_types:</span></span></div><div class="t m0 x29 hf y21dd ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 ws13a">isinstance<span class="fc0 ws13b">(value, bound_types[name]):</span></span></div><div class="t m0 x24 hf y21de ff7 fs5 fca sc0 ls0 ws83b">raise <span class="ff8 ws13a">TypeError<span class="fc0">(</span></span></div><div class="t m0 x23 hf y21df ff9 fs5 fc9 sc0 ls34">&apos;<span class="ff8 ls0 ws4">Argument {} must be {}</span>&apos;<span class="ff8 fc6">.<span class="fc0 ls0 ws13b">format(name, bound_types[name])</span></span></div><div class="t m0 x23 hf y1b72 ff8 fs5 fc0 sc0 ls0">)</div><div class="t m0 x17 hf y1b73 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">func(<span class="fc6 ls34">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs)</span></div><div class="t m0 x16 hf y1d82 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">wrapper</span></div><div class="t m0 x15 hf y1b74 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">decorate</span></div><div class="t m0 x0 h9 y666 ff1 fs3 fc0 sc0 ls0 wsa0">可以看出这个装饰器<span class="_ _6"></span>非常灵活，既可以指定所有<span class="_ _6"></span>参数类型，也可以只指定<span class="_ _6"></span>部分。并</div><div class="t m0 x5 h9 y21e0 ff1 fs3 fc0 sc0 ls0">且可以通过位置或关键字来指定参数类型。下面是使用示例：</div><div class="t m0 x5 hf y21e1 ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; @typeassert(int, z=int)</div><div class="t m0 x5 hf y21e2 ff8 fs5 fc0 sc0 ls0 ws4">... def spam(x, y, z=42):</div><div class="t m0 x5 hf y21e3 ff8 fs5 fc0 sc0 ls0 ws4">...<span class="_ _1a"> </span>print(x, y, z)</div><div class="t m0 x5 hf y21e4 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y21e5 ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; spam(1, 2, 3)</div><div class="t m0 x5 hf y126a ff8 fs5 fc0 sc0 ls5e ws209">123<span class="_ _15"></span></div><div class="t m0 x5 hf y21e6 ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; spam(1, <span class="ff9 ws13b">&apos;</span><span class="ws13a">hello<span class="ff9 ls34">&apos;</span><span class="ws13b">, 3)</span></span></div><div class="t m0 x5 hf y21e7 ff8 fs5 fc0 sc0 ls0 ws4">1 hello 3</div><div class="t m0 x5 hf y21e8 ff8 fs5 fc0 sc0 ls0 ws4">&gt;&gt;&gt; spam(1, <span class="ff9 ws13b">&apos;</span><span class="ws13a">hello<span class="ff9 ls34">&apos;</span><span class="ls32">,<span class="ff9 ls34">&apos;</span></span>world<span class="ff9 ws13b">&apos;</span>)</span></div><div class="t m0 x5 hf y21e9 ff8 fs5 fc0 sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x5 hf y21ea ff8 fs5 fc0 sc0 ls0 ws4">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="t m0 x5 hf y21eb ff8 fs5 fc0 sc0 ls0 ws4">File &quot;contract.py&quot;, line 33, in wrapper</div><div class="t m0 x5 hf y3f3 ff8 fs5 fc0 sc0 ls0 ws4">TypeError: Argument z must be &lt;class <span class="ff9 ls34">&apos;</span><span class="ws13a">int<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y21ec ff8 fs5 fc0 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">11.7.<span class="_ _5"> </span>9.7 <span class="ff1 ws243">利用装饰器强制函数上的类型检查 </span>313</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
