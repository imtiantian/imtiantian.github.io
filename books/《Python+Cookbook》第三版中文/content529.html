<div id="pf211" class="pf w0 h0" data-page-no="211"><div class="pc pc211 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg211.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h10 yb1e ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">csv</span></div><div class="t m0 x5 hf yb20 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">dowprices<span class="fc0">():</span></span></div><div class="t m0 x15 hf yb21 ff8 fs5 fc0 sc0 ls32">u<span class="fc6 ls33">=</span><span class="ls0 ws13a">urlopen(<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">http://finance.yahoo.com/d/quotes.csv?s=@^DJI&amp;f=sl1<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf yb22 ff8 fs5 fc0 sc0 ls0 ws15f">lines <span class="fc6 ls33">=</span><span class="ws13a">(line<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ws13b">&apos;</span></span><span class="ls33">)</span><span class="ff7 fca ws139">for </span><span class="ws161">line <span class="ff7 fca ws157">in </span>u)</span></span></div><div class="t m0 x15 hf yb23 ff8 fs5 fc0 sc0 ls0 ws13c">rows <span class="fc6 ls32">=</span>(row <span class="ff7 fca ws139">for </span><span class="ws15b">row <span class="ff7 fca ws160">in </span><span class="ws13a">csv<span class="fc6 ls34">.</span><span class="ws147">reader(lines) <span class="ff7 fca ws157">if </span></span><span class="fca">len</span><span class="ws15f">(row) <span class="fc6 ws15c">== </span></span><span class="fc7">2</span>)</span></span></div><div class="t m0 x15 hf yb24 ff8 fs5 fc0 sc0 ls0 ws145">prices <span class="fc6 ls32">=</span><span class="ws4">{ name:<span class="fca ws13a">float</span><span class="ws155">(price) <span class="ff7 fca ws139">for </span><span class="ws13b">name, price <span class="ff7 fca ws157">in </span>rows }</span></span></span></div><div class="t m0 x15 hf yb25 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">prices</span></div><div class="t m0 x0 h7 y3366 ff1 fs3 fc0 sc0 ls2c ws1292">正常来讲，这个函数会使用 <span class="ff6 ls0 ws10ae">urlopen() </span><span class="lsd6">从<span class="ff4 ls0 ws1293">W<span class="_ _8"></span>eb <span class="ff1 ls2c ws12f">上面获取数据并解析它。在单元测</span></span></span></div><div class="t m0 x5 h7 y11c2 ff1 fs3 fc0 sc0 ls0 wsa0">试中，你可以给它一个预先定义好的数据集。下面是使用补丁操作的例子<span class="ff4">:</span></div><div class="t m0 x5 h10 y37a ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">unittest</span></div><div class="t m0 x5 hf y3367 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wsb44">unittest.mock </span><span class="ws146">import <span class="ff8 fc0">patch</span></span></div><div class="t m0 x5 h10 y3368 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">io</span></div><div class="t m0 x5 h10 y3369 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">example</span></div><div class="t m0 x5 hf y336a ff8 fs5 fc0 sc0 ls0 ws208">sample_data <span class="fc6 ls32">=</span><span class="ws13a">io<span class="fc6">.</span>BytesIO(b<span class="ff9 fc9 ws13b">&apos;&apos;&apos;<span class="ff7">\</span></span></span></div><div class="t m0 x5 hf y336b ff8 fs5 fc9 sc0 ls0 ws13a">&quot;IBM&quot;,91.1<span class="ff7">\r</span></div><div class="t m0 x5 hf y336c ff8 fs5 fc9 sc0 ls0 ws13a">&quot;AA&quot;,13.25<span class="ff7">\r</span></div><div class="t m0 x5 hf y336d ff8 fs5 fc9 sc0 ls0 ws13a">&quot;MSFT&quot;,27.72<span class="ff7">\r</span></div><div class="t m0 x5 h10 y336e ff7 fs5 fc9 sc0 ls0">\r</div><div class="t m0 x5 hf y336f ff9 fs5 fc9 sc0 ls0 ws13b">&apos;&apos;&apos;<span class="ff8 fc0">)</span></div><div class="t m0 x5 hf y3370 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Tests<span class="ff8 fc0 ws13a">(unittest<span class="fc6">.</span>TestCase):</span></span></div><div class="t m0 x15 hf y3371 ff7 fs5 fc12 sc0 ls0 ws156">@patch<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">example.urlopen<span class="ff9 ws13b">&apos;</span><span class="fc0 ws4">, return_value</span><span class="fc6">=<span class="fc0">sample_data)</span></span></span></span></span></div><div class="t m0 x15 hf y3372 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test_dowprices<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, mock_urlopen):</span></span></span></div><div class="t m0 x16 hf y3373 ff8 fs5 fc0 sc0 ls32">p<span class="fc6 ls33">=</span><span class="ls0 ws13a">example<span class="fc6 ls34">.</span>dowprices()</span></div><div class="t m0 x16 hf y3374 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">assertTrue(mock_urlopen</span><span class="ls34">.</span><span class="fc0">called)</span></span></div><div class="t m0 x16 hf y1531 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">assertEqual(p,</span></span></div><div class="t m0 x44 hf y3375 ff8 fs5 fc0 sc0 ls34">{<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">IBM</span>&apos;</span><span class="ls32">:<span class="fc7 ls0 ws13a">91.1<span class="fc0">,</span></span></span></div><div class="t m0 x2d hf y3376 ff9 fs5 fc9 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">AA</span>&apos;<span class="ff8 fc0 ls32">:<span class="fc7 ls0 ws13a">13.25<span class="fc0">,</span></span></span></div><div class="t m0 x2d hf y3377 ff9 fs5 fc9 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">MSFT</span><span class="ls32">&apos;<span class="ff8 fc0">:<span class="fc7 ls0 ws13a">27.72<span class="fc0">})</span></span></span></span></div><div class="t m0 x5 hf y3378 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y3379 ff8 fs5 fc0 sc0 ls0 ws13a">unittest<span class="fc6">.</span>main()</div><div class="t m0 x0 h9 y1a57 ff1 fs3 fc0 sc0 ls0 ws1294">本例<span class="_ _6"></span>中，<span class="_ _6"></span>位<span class="_ _6"></span>于 <span class="ff6 ws471">example </span><span class="ls30 ws1295">模块中的 </span><span class="ff6 ws1296">urlopen() </span><span class="wsa0">函数<span class="_ _6"></span>被<span class="_ _6"></span>一个<span class="_ _6"></span>模<span class="_ _6"></span>拟<span class="_ _6"></span>对象<span class="_ _6"></span>替<span class="_ _6"></span>代，该<span class="_ _6"></span>对<span class="_ _6"></span>象<span class="_ _6"></span>会</span></div><div class="t m0 x5 h7 y337a ff1 fs3 fc0 sc0 ls0 ws38">返回一个包含测试数据的 <span class="ff6 ws303">ByteIO()<span class="ff4">.</span></span></div><div class="t m0 x0 h9 y337b ff1 fs3 fc0 sc0 ls227 ws1297">还有一点<span class="_ _3b"></span>，<span class="_ _6"></span>在打补丁时我们使用了 <span class="ff6 ls0 ws1298">example.urlopen <span class="ff1 ws1299">来 代 替</span></span></div><div class="t m0 x5 h9 y337c ff6 fs3 fc0 sc0 ls0 ws129a">urllib.request.urlopen <span class="ff1 ls143 ws8b1">。当你创建补丁的时候<span class="_ _1d"></span>，你必须使用它们在测试代码<span class="_ _19"></span></span></div><div class="t m0 x5 h7 y337d ff1 fs3 fc0 sc0 ls0 ws129b">中<span class="_ _12"></span>的<span class="_ _24"></span>名<span class="_ _24"></span>称。<span class="_ _24"></span>由<span class="_ _24"></span>于<span class="_ _12"></span>测<span class="_ _24"></span>试<span class="_ _24"></span>代<span class="_ _12"></span>码<span class="_ _24"></span>使<span class="_ _24"></span>用<span class="_ _24"></span>了 <span class="ff6 ws129c">from urllib.request import urlopen<span class="_ _11"> </span><span class="ff4 ls228">,</span></span><span class="wsa0">那<span class="_ _12"></span>么</span></div><div class="t m0 x5 h9 y337e ff6 fs3 fc0 sc0 ls0 ws1e2">dowprices() <span class="ff1 ws14">函数中使用的 </span><span class="ws1d1">urlopen() <span class="ff1 ws14">函数实际上就位于 </span><span class="ws23a">example <span class="ff1">模块了。</span></span></span></div><div class="t m0 x0 h9 y337f ff1 fs3 fc0 sc0 ls0 ws129d">本<span class="_ _6"></span>节<span class="_ _6"></span>实<span class="_ _6"></span>际<span class="_ _6"></span>上<span class="_ _6"></span>只<span class="_ _6"></span>是<span class="_ _6"></span>对 <span class="ff6 ws2f6">unittest.mock </span><span class="wsa0">模<span class="_ _6"></span>块<span class="_ _6"></span>的<span class="_ _6"></span>一<span class="_ _6"></span>次<span class="_ _6"></span>浅<span class="_ _6"></span>尝<span class="_ _6"></span>辄<span class="_ _6"></span>止。<span class="_ _6"></span>更<span class="_ _6"></span>多<span class="_ _6"></span>更<span class="_ _6"></span>高<span class="_ _6"></span>级的<span class="_ _6"></span>特<span class="_ _6"></span>性，<span class="_ _0"></span>请</span></div><div class="t m0 x5 h9 y3380 ff1 fs3 fc0 sc0 ls0 ws14">参考 <span class="fc3">官方文档</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">16.2.<span class="_ _36"> </span>14.2 <span class="ff1 ws98a">在单元测试中给对象打补丁 </span>520</div><a class="l" href="http://docs.python.org/3/library/unittest.mock"><div class="d m1" style="border-style:none;position:absolute;left:149.712000px;bottom:209.583000px;width:47.820000px;height:14.016000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
