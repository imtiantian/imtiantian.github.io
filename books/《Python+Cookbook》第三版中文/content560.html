<div id="pf230" class="pf w0 h0" data-page-no="230"><div class="pc pc230 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg230.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p1 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">1</span>,<span class="fc7 ls34">2</span>)</span></span></div><div class="t m0 x5 hf y1ac ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p2 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">4</span>,<span class="fc7 ls34">5</span>)</span></span></div><div class="t m0 x5 hf y1ad ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">p1<span class="fc6 ls34">.</span>x</span></div><div class="t m0 x5 hf y1ae ff8 fs5 fc8 sc0 ls0">1.0</div><div class="t m0 x5 hf y1af ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">p1<span class="fc6 ls34">.</span>y</span></div><div class="t m0 x5 hf y1b0 ff8 fs5 fc8 sc0 ls0">2.0</div><div class="t m0 x5 hf y355 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>distance(p1,p2)</span></div><div class="t m0 x5 hf y410 ff8 fs5 fc8 sc0 ls0">4.242640687119285</div><div class="t m0 x5 hf y411 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y728 ff1 fs3 fc0 sc0 ls51 wse4e">最后一些小的提示：如果你想在 <span class="ff4 ls0 ws135f">Python </span><span class="ws123f">中访问一些小的 <span class="ff4 ls253">C</span><span class="wsfc6">函数，那么 <span class="ff6 ls0 ws6fd">ctypes <span class="ff1">是</span></span></span></span></div><div class="t m0 x5 h9 y729 ff1 fs3 fc0 sc0 ls1e ws111">一个很有用的函数库<span class="_ _1"></span>。尽管如此<span class="_ _1"></span>，如果你想要去访问一个很大的库，那么可能就<span class="_ _1"></span>需要</div><div class="t m0 x5 h7 y3624 ff1 fs3 fc0 sc0 ls0 ws38">其他的方法了，比如 <span class="ff6 ws27b">Swig <span class="ff4 ws1398">(15.9 </span></span><span class="wsa0">节会讲到<span class="ff4 ls6a">)</span><span class="ls4">或</span><span class="ff4 wsa5">Cython</span>（<span class="ff4 ws2aa">15.10 </span>节）<span class="_ _f"></span>。</span></div><div class="t m0 x0 h7 y72b ff1 fs3 fc0 sc0 ls1e ws1399">对于大型库的访问有个主要问题<span class="_ _1"></span>，由于 <span class="ff4 ls0 ws139a">ctypes </span><span class="ws111">并不是完全自动化，那么你就必须<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y3625 ff1 fs3 fc0 sc0 ls1e ws111">花费大量时间来编写所有的类型签名<span class="_ _1"></span>，就像例子中那样<span class="_ _1"></span>。如果函数库够复杂<span class="_ _1"></span>，你还得</div><div class="t m0 x5 h7 y3626 ff1 fs3 fc0 sc0 lse ws139b">去编写很多小的包装函数和支持类。另外<span class="_ _1"></span>，除非你已经完全精通了所有底层的 <span class="ff4 ls20">C</span><span class="ls0 wsa0">接口</span></div><div class="t m0 x5 h9 y3627 ff1 fs3 fc0 sc0 ls0 wsa0">细<span class="_ _6"></span>节，包<span class="_ _6"></span>括<span class="_ _6"></span>内<span class="_ _6"></span>存<span class="_ _6"></span>分<span class="_ _6"></span>配和<span class="_ _6"></span>错<span class="_ _6"></span>误<span class="_ _6"></span>处<span class="_ _6"></span>理<span class="_ _6"></span>机制，<span class="_ _6"></span>通<span class="_ _6"></span>常<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>很<span class="_ _6"></span>小的<span class="_ _6"></span>代<span class="_ _6"></span>码<span class="_ _6"></span>缺<span class="_ _6"></span>陷、<span class="_ _6"></span>访问<span class="_ _6"></span>越<span class="_ _6"></span>界<span class="_ _6"></span>或<span class="_ _6"></span>其<span class="_ _6"></span>他类</div><div class="t m0 x5 h7 y3628 ff1 fs3 fc0 sc0 ls0 ws14">似错误就能让 <span class="ff4 ws5c">Python </span>程序奔溃。</div><div class="t m0 x0 h7 y3629 ff1 fs3 fc0 sc0 ls0 ws2eb">作为 <span class="ff6 ws139c">ctypes </span><span class="ws139d">的<span class="_ _6"></span>一<span class="_ _6"></span>个替<span class="_ _6"></span>代，<span class="_ _6"></span>你<span class="_ _6"></span>还可<span class="_ _6"></span>以<span class="_ _6"></span>考虑<span class="_ _6"></span>下 <span class="ff4 wsa5">CFFI</span><span class="ls219">。</span><span class="ff4 ws139e">CFFI </span><span class="wsa0">提<span class="_ _6"></span>供了<span class="_ _6"></span>很<span class="_ _6"></span>多类<span class="_ _6"></span>似<span class="_ _6"></span>的功<span class="_ _6"></span>能，</span></span></div><div class="t m0 x5 h7 y362a ff1 fs3 fc0 sc0 ls3d ws2bd">但是使用 <span class="ff4 ls24b">C</span><span class="wsacc">语法并支持更多高级的 <span class="ff4 ls205">C</span><span class="ws164">代码类型。到写这本书为止，<span class="ff4 ls0 ws139f">CFFI </span>还是一个相<span class="_ _1"></span></span></span></div><div class="t m0 x5 h7 y362b ff1 fs3 fc0 sc0 ls0 wsa70">对较新的工程，但是它的流行度正在快速上升。<span class="_ _1"></span>甚至还有在讨论在 <span class="ff4 ws12b">Python </span>将来的版本</div><div class="t m0 x5 h9 y2c4b ff1 fs3 fc0 sc0 ls0">中将它包含进去。因此，这个真的值得一看。</div><div class="t m0 x5 hd y362c ff2 fs4 fc4 sc0 ls0 ws211">17.2<span class="_ _e"> </span>15.2 <span class="ff1 ws357">简单的 </span><span class="ls23d">C</span><span class="ff1">扩展模块</span></div><div class="t m0 x5 he y362d ff2 fs2 fc4 sc0 ls0 ws212">17.2.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y362e ff1 fs3 fc0 sc0 ls0 ws13a0">你想<span class="_ _6"></span>不依<span class="_ _6"></span>靠<span class="_ _6"></span>其他<span class="_ _6"></span>工具，<span class="_ _6"></span>直<span class="_ _6"></span>接使<span class="_ _6"></span>用 <span class="ff4 wsd26">Python </span><span class="ws13a1">的扩<span class="_ _6"></span>展 <span class="ff4 ws13a2">API </span><span class="ls12 ws13a3">来编写一些简单的 <span class="ff4 ls254">C</span></span></span><span class="wsa0">扩展<span class="_ _6"></span>模</span></div><div class="t m0 x5 h9 y362f ff1 fs3 fc0 sc0 ls0">块。</div><div class="t m0 x5 he y3630 ff2 fs2 fc4 sc0 ls0 ws212">17.2.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y58b ff1 fs3 fc0 sc0 ls0 ws13a4">对<span class="_ _6"></span>于简<span class="_ _6"></span>单<span class="_ _6"></span>的 <span class="ff4 ls255">C</span><span class="ls13 wse5">代码，构建一个自定义扩展模块是很容易的<span class="_ _c"></span>。作为第一步，你需要<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y3631 ff1 fs3 fc0 sc0 ls0 ws14">确保你的 <span class="ff4 ls8">C</span>代码有一个正确的头文件。例如：</div><div class="t m0 x5 hf y3632 ff8 fs5 fc0 sc0 ls0 ws4">/* sample.h */</div><div class="t m0 x5 hf y1c41 ff8 fs5 fc0 sc0 ls0 ws4">#include &lt;math.h&gt;</div><div class="t m0 x5 hf y1c43 ff8 fs5 fc0 sc0 ls0 ws4">extern int gcd(int, int);</div><div class="t m0 x5 hf y3633 ff8 fs5 fc0 sc0 ls0 ws4">extern int in_mandel(double x0, double y0, int n);</div><div class="t m0 x5 hf y3634 ff8 fs5 fc0 sc0 ls0 ws4">extern int divide(int a, int b, int *remainder);</div><div class="t m0 x5 hf y3635 ff8 fs5 fc0 sc0 ls0 ws4">extern double avg(double *a, int n);</div><div class="t m0 x5 hf y3636 ff8 fs5 fc0 sc0 ls0 ws4">typedef struct Point {</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.2.<span class="_ _36"> </span>15.2 <span class="ff1 ws36c">简单的 </span><span class="ls246">C</span><span class="ff1 ws13a5">扩展模块 </span>551</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
