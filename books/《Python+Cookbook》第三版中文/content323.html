<div id="pf143" class="pf w0 h0" data-page-no="143"><div class="pc pc143 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg143.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">11.7.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y236 ff1 fs3 fc0 sc0 ls0">这节是高级装饰器示例，引入了很多重要的概念。</div><div class="t m0 x0 h9 y21ed ff1 fs3 fc0 sc0 ls0 wsa0">首先，装饰器只会在函<span class="_ _6"></span>数定义时被调用一次。有时<span class="_ _6"></span>候你去掉装饰器的功能，<span class="_ _6"></span>那么你</div><div class="t m0 x5 h9 ya58 ff1 fs3 fc0 sc0 ls42 wsbd2">只需要简单的返回被装饰函数即可。下面的代码中<span class="_ _1"></span>，如果全局变量　 <span class="ff6 ls0 wsa03">debug </span><span class="ws186">被设置</span></div><div class="t m0 x5 h7 y278 ff1 fs3 fc0 sc0 ls0 ws9b7">成了 <span class="ff4 wsa5">F<span class="_ _d"></span>alse(<span class="ff1 wsbd3">当你使<span class="_ _6"></span>用 </span><span class="wsbd4">-O <span class="ff1 ls17b">或</span><span class="wsbd5">-OO <span class="ff1 ls2c ws12f">参数的优化模式执行程序时</span></span></span>)<span class="ff1 ls2c ws12f">，那么就直接返回未修改</span></span></div><div class="t m0 x5 h9 y279 ff1 fs3 fc0 sc0 ls0">过的函数本身：</div><div class="t m0 x5 hf y21ee ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decorate<span class="fc0">(func):</span></span></div><div class="t m0 x15 h11 y21ef ffa fs5 fcd sc0 ls0 ws4"># If in optimized mode, disable type checking</div><div class="t m0 x15 hf y21f0 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">__debug__:</span></div><div class="t m0 x16 hf y21f1 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">func</span></div><div class="t m0 x0 h9 y1a4b ff1 fs3 fc0 sc0 ls0 wsbd6">其 次， 这 里 还 对 被 包 装 函 数 的 参 数 签 名 进 行 了 检 查，<span class="_ _16"> </span>我 们 使 用 了</div><div class="t m0 x5 h9 y21f2 ff6 fs3 fc0 sc0 ls0 wsbd7">inspect.signature() <span class="ff1 ls18f wsbd8">函数<span class="_ _d"></span>。简单来讲<span class="_ _d"></span>，它运行你提取一个可调用对象的参数签名<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y21f3 ff1 fs3 fc0 sc0 ls0">信息。例如：</div><div class="t m0 x5 hf y21f4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">from <span class="fcc ws2f0">inspect </span><span class="ws146">import <span class="ff8 fc0">signature</span></span></span></div><div class="t m0 x5 hf y21f5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">def <span class="ff8 fcb ws13a">spam<span class="fc0 ws13b">(x, y, z</span><span class="fc6">=<span class="fc7">42<span class="fc0">):</span></span></span></span></span></div><div class="t m0 x5 h10 y21f6 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca">pass</span></div><div class="t m0 x5 h10 y21f7 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y1ee7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">sig <span class="fc6 ls32">=</span>signature(spam)</span></div><div class="t m0 x5 hf y21f8 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0">(sig)</span></span></div><div class="t m0 x5 hf y21f9 ff8 fs5 fc8 sc0 ls0 ws4">(x, y, z=42)</div><div class="t m0 x5 hf y21fa ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sig<span class="fc6 ls34">.</span>parameters</span></div><div class="t m0 x5 hf y21fb ff8 fs5 fc8 sc0 ls0 ws13a">mappingproxy(OrderedDict([(<span class="ff9 ws13b">&apos;</span><span class="ls34">x<span class="ff9">&apos;</span></span><span class="ws4">, &lt;Parameter at 0x10077a050 <span class="ff9 ls34">&apos;<span class="ff8">x</span><span class="ls0 ws13b">&apos;</span></span>&gt;),</span></div><div class="t m0 x5 hf y21fc ff8 fs5 fc8 sc0 ls34">(<span class="ff9 ls0 ws13b">&apos;</span>y<span class="ff9">&apos;</span><span class="ls0 ws4">, &lt;Parameter at 0x10077a158 </span><span class="ff9">&apos;</span>y<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">&gt;), (</span><span class="ff9">&apos;</span>z<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">, &lt;Parameter at 0x10077a1b0 <span class="ff9 ws13b">&apos;</span></span>z<span class="ff9">&apos;</span><span class="ls0">&gt;)]))</span></div><div class="t m0 x5 hf y21fd ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sig<span class="fc6 ls34">.</span>parameters[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">z<span class="ff9 ls34">&apos;</span></span><span class="ls34">]</span><span class="fc6">.</span>name</span></div><div class="t m0 x5 hf y21fe ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">z<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y21ff ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sig<span class="fc6 ls34">.</span>parameters[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">z<span class="ff9 ls34">&apos;</span></span><span class="ls34">]</span><span class="fc6">.</span>default</span></div><div class="t m0 x5 hf y2200 ff8 fs5 fc8 sc0 ls0">42</div><div class="t m0 x5 hf y2201 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sig<span class="fc6 ls34">.</span>parameters[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">z<span class="ff9 ls34">&apos;</span></span><span class="ls34">]</span><span class="fc6">.</span>kind</span></div><div class="t m0 x5 hf y2202 ff8 fs5 fc8 sc0 ls0 ws1f8">&lt;_ParameterKind: <span class="ff9 ls34">&apos;</span><span class="ws13a">POSITIONAL_OR_KEYWORD<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y2203 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y2204 ff1 fs3 fc0 sc0 ls42 wsbd9">装饰器的开始部分，我们使用了 <span class="ff6 ls0 wsbda">bind partial() </span><span class="ws186">方法来执行从指定类型到名称的</span></div><div class="t m0 x5 h9 y2205 ff1 fs3 fc0 sc0 ls0">部分绑定。下面是例子演示：</div><div class="t m0 x5 hf y2206 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws208">bound_types <span class="fc6 ls32">=</span><span class="ws13a">sig<span class="fc6 ls34">.</span>bind_partial(<span class="fca">int</span>,z<span class="fc6 ls34">=</span><span class="fca">int</span>)</span></span></div><div class="t m0 x5 hf y2207 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">bound_types</span></div><div class="t m0 x5 hf y1bb6 ff8 fs5 fc8 sc0 ls0 ws4">&lt;inspect.BoundArguments object at 0x10069bb50&gt;</div><div class="t m0 x5 hf y1bb7 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">bound_types<span class="fc6 ls34">.</span>arguments</span></div><div class="t m0 x5 hf y1bb8 ff8 fs5 fc8 sc0 ls0 ws13a">OrderedDict([(<span class="ff9 ls34">&apos;<span class="ff8">x</span><span class="ls0 ws13b">&apos;</span></span><span class="ws4">, &lt;class <span class="ff9 ls34">&apos;</span></span>int<span class="ff9 ls34">&apos;</span><span class="ws13b">&gt;), (<span class="ff9 ls34">&apos;<span class="ff8">z</span><span class="ls0">&apos;</span></span><span class="ws4">, &lt;class <span class="ff9 ls34">&apos;</span></span></span>int<span class="ff9 ls34">&apos;</span>&gt;)])</div><div class="t m0 x5 hf y1bb9 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 yf48 ff1 fs3 fc0 sc0 ls24 wsbdb">在这个部分绑定中<span class="_ _c"></span>，你可以注意<span class="_ _6"></span>到缺失的参数被忽略了 <span class="ff4 ls0 wsa5">(</span><span class="wsbdc">比如并没有对 <span class="ff4 ls190">y</span><span class="ls0 wsa0">进<span class="_ _6"></span>行<span class="_ _6"></span>绑</span></span></div><div class="t m0 x5 h7 yf8d ff1 fs3 fc0 sc0 lsb">定<span class="ff4 ls0 wsa5">)</span><span class="ls3a wsbdd">。不过最重要的是创建了一个有序字典 </span><span class="ff6 ls0 wsbde">bound<span class="_ _7"> </span>types.arguments </span><span class="ls3a ws153">。这个字典会将参</span></div><div class="t m0 x5 h9 yf8e ff1 fs3 fc0 sc0 ls13 wse5">数名以函数签名中相同顺序映射到指定的类型值上面去<span class="_ _1"></span>。在我们的装饰器例子中，这<span class="_ _c"></span></div><div class="t m0 x5 h9 y8c4 ff1 fs3 fc0 sc0 ls0">个映射包含了我们要强制指定的类型断言。</div><div class="t m0 x0 h9 y6e ff1 fs3 fc0 sc0 ls191 wsbdf">在装饰器创建的实际包装函数中使用到了 <span class="ff6 ls0 wsbe0">sig.bind() <span class="ff1 wsbe1">方 法。<span class="_ _32"> </span></span><span class="wsbe2">bind() <span class="ff1">跟</span></span></span></div><div class="t m0 x5 h9 y674 ff6 fs3 fc0 sc0 ls0 ws1d1">bind<span class="_ _7"> </span>partial() <span class="ff1">类似，但是它不允许忽略任何参数。因此有了下面的结果：</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws9da">11.7.<span class="_ _5"> </span>9.7 <span class="ff1 ws243">利用装饰器强制函数上的类型检查 </span>314</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
