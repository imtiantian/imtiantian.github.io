<div id="pf133" class="pf w0 h0" data-page-no="133"><div class="pc pc133 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg133.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fc0 sc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0">_spam_cache[name]</span></div><div class="t m0 x15 hf y1ac ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">s</span></div><div class="t m0 x0 h9 y205b ff1 fs3 fc0 sc0 ls0">然后做一个测试，你会发现跟之前那个日志对象的创建行为是一致的：</div><div class="t m0 x5 hf y205c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">get_spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">foo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y205d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">b<span class="fc6 ls33">=</span><span class="ls0 ws13a">get_spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">bar<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y205e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a</span><span class="fca ws160">is <span class="ff8 fc0">b</span></span></div><div class="t m0 x5 hf y205f ff8 fs5 fc8 sc0 ls0">False</div><div class="t m0 x5 hf y2060 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0 ws13a">get_spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">foo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf ydeb ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a</span><span class="fca ws160">is <span class="ff8 fc0">c</span></span></div><div class="t m0 x5 hf ydec ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y2061 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y2062 ff2 fs2 fc4 sc0 ls0 wsadf">10.25.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2063 ff1 fs3 fc0 sc0 ls3a ws153">编写一个工厂函数来修改普通的实例创建行为通常是一个比较简单的方法。但是我</div><div class="t m0 x5 h9 y2064 ff1 fs3 fc0 sc0 ls0">们还能否找到更优雅的解决方案呢？</div><div class="t m0 x0 h9 y2065 ff1 fs3 fc0 sc0 ls0 ws911">例如，你可能会考虑重新定义类的 <span class="ff6 ws308">new<span class="_ _e"> </span>() </span>方法，就像下面这样：</div><div class="t m0 x5 h11 y2066 ffa fs5 fcd sc0 ls0 ws4"># Note: This code doesn<span class="ffb ws13b">&apos;</span>t quite work</div><div class="t m0 x5 h10 y1b15 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">weakref</span></div><div class="t m0 x5 hf y2067 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2068 ff8 fs5 fc0 sc0 ls0 ws208">_spam_cache <span class="fc6 ls32">=</span><span class="ws13a">weakref<span class="fc6 ls34">.</span>WeakValueDictionary()</span></div><div class="t m0 x15 hf y2069 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__new__<span class="fc0 ws13b">(cls, name):</span></span></div><div class="t m0 x16 hf y206a ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">name </span>in <span class="ff8 fc0 ws13a">cls<span class="fc6 ls34">.</span>_spam_cache:</span></div><div class="t m0 x17 hf y206b ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">cls<span class="fc6 ls34">.</span>_spam_cache[name]</span></div><div class="t m0 x16 hf y206c ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y206d ff8 fs5 fca sc0 ls0 ws161">self <span class="fc6 ls33">=</span><span class="ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>__new__(cls)</span></span></div><div class="t m0 x17 hf y206e ff8 fs5 fc0 sc0 ls0 ws13a">cls<span class="fc6 ls34">.</span><span class="ws23c">_spam_cache[name] <span class="fc6 ls32">=</span><span class="fca">self</span></span></div><div class="t m0 x17 hf y206f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x15 hf y2070 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name):</span></span></span></div><div class="t m0 x16 hf y2071 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Initializing Spam</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x16 hf y2072 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x0 h9 y2073 ff1 fs3 fc0 sc0 ls0 wsb84">初看起来好像可以达到预期效果，<span class="_ _1"></span>但是问题是 <span class="ff6 wsb85">init<span class="_ _e"> </span>() </span><span class="wsa0">每次都会被调用，不管这</span></div><div class="t m0 x5 h9 y2074 ff1 fs3 fc0 sc0 ls0">个实例是否被缓存了。例如：</div><div class="t m0 x5 hf ye9e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Dave<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf ye9f ff8 fs5 fc8 sc0 ls0 ws4">Initializing Spam</div><div class="t m0 x5 hf yea0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">t<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Dave<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf ye1b ff8 fs5 fc8 sc0 ls0 ws4">Initializing Spam</div><div class="t m0 x5 hf yea1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s</span><span class="fca ws160">is <span class="ff8 fc0">t</span></span></div><div class="t m0 x5 hf yea2 ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf yea3 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y8c4 ff1 fs3 fc0 sc0 ls0">这个或许不是你想要的效果，因此这种方法并不可取。</div><div class="t m0 x0 h9 y6e ff1 fs3 fc0 sc0 ls3a ws153">上面我们使用到了弱引用计数，对于垃圾回收来讲是很有帮助的，关于这个我们在</div><div class="t m0 x5 h7 y674 ff4 fs3 fc0 sc0 ls0 wsb86">8.23 <span class="ff1 ls10 wsdf">小节已经讲过了。当我们保持实例缓存时<span class="_ _c"></span>，你可能只想在程序中使用到它们时才</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.25.<span class="_ _5"> </span>8.25 <span class="ff1 wsb83">创建缓存实例 </span>298</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
