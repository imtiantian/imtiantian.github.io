<div id="pf135" class="pf w0 h0" data-page-no="135"><div class="pc pc135 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg135.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">foo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y1ac ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">b<span class="fc6 ls33">=</span><span class="ls0 ws13a">Spam(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">foo<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y1ad ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a</span><span class="fca ws160">is <span class="ff8 fc0">b</span></span></div><div class="t m0 x5 hf y1ae ff8 fs5 fc8 sc0 ls0">False</div><div class="t m0 x5 hf y1af ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 ye8c ff1 fs3 fc0 sc0 ls48 wsb8a">有几种方式可以防止用户这样做<span class="_ _1"></span>，第一个是将类的名字修改为以下划线 <span class="ff4 ls0 wsb8b">( ) <span class="ff1 wsa0">开<span class="_ _6"></span>头，</span></span></div><div class="t m0 x5 h9 y7cb ff1 fs3 fc0 sc0 ls22 wsb8c">提示用户别直接调用它。第二种就是让这个类的 <span class="ff6 ls0 ws8e8">init<span class="_ _e"> </span>() </span><span class="ws119">方法抛出一个异常<span class="_ _c"></span>，让它</span></div><div class="t m0 x5 h9 y7cc ff1 fs3 fc0 sc0 ls0">不能被初始化：</div><div class="t m0 x5 hf y8a8 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2092 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs):</span></span></div><div class="t m0 x16 hf yd3e ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="fc9">&quot;Can<span class="ff9 ws13b">&apos;</span><span class="ws4">t instantiate directly&quot;<span class="fc0">)</span></span></span></span></div><div class="t m0 x15 h11 y2093 ffa fs5 fcd sc0 ls0 ws13b"># Alternate constructor</div><div class="t m0 x15 h10 y2094 ff7 fs5 fc12 sc0 ls0">@classmethod</div><div class="t m0 x15 hf y2095 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_new<span class="fc0 ws13b">(cls, name):</span></span></div><div class="t m0 x16 hf y8ae ff8 fs5 fca sc0 ls0 ws161">self <span class="fc6 ls33">=</span><span class="fc0 ws13a">cls<span class="fc6 ls34">.</span>__new__(cls)</span></div><div class="t m0 x16 hf y8af ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x0 h9 y2096 ff1 fs3 fc0 sc0 ls0 wsb8d">然后修改缓存管理器代码，<span class="_ _8"></span>使用 <span class="ff6 wsb8e">Spam.<span class="_ _7"> </span>new() </span><span class="wsb8f">来创建实例，<span class="_ _19"></span>而不是直接调用 <span class="ff6">Spam()</span></span></div><div class="t m0 x5 h9 y2097 ff1 fs3 fc0 sc0 ls0">构造函数：</div><div class="t m0 x5 h12 y1637 ffa fs5 fcd sc0 ls0 ws4"># ------------------------<span class="ffc fs6 ws3d3">最后的修正方案 </span>------------------------</div><div class="t m0 x5 hf y1638 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">CachedSpamManager2<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1639 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y2098 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">_cache </span><span class="ls32">=</span><span class="fc0">weakref</span><span class="ls34">.</span><span class="fc0">WeakValueDictionary()</span></span></div><div class="t m0 x15 hf y2099 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get_spam<span class="fc0">(<span class="fca">self</span><span class="ws4">, name):</span></span></span></div><div class="t m0 x16 hf y209a ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">name </span>not in <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_cache:</span></span></span></div><div class="t m0 x17 hf y209b ff8 fs5 fc0 sc0 ls0 ws161">temp <span class="fc6 ls33">=</span><span class="ws13a">Spam3<span class="fc6 ls34">.</span><span class="ws43f">_new(name) <span class="ffa fcd ws13b"># Modified creation</span></span></span></div><div class="t m0 x17 hf y209c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">_cache[name] </span><span class="ls32">=</span><span class="fc0">temp</span></span></div><div class="t m0 x16 hf y209d ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y209e ff8 fs5 fc0 sc0 ls0 ws161">temp <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6">.</span></span>_cache[name]</div><div class="t m0 x16 hf y209f ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">temp</span></div><div class="t m0 x15 hf y20a0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">clear<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x17 hf y20a1 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_cache</span>.<span class="fc0">clear()</span></span></div><div class="t m0 x5 hf y20a2 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam3<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y20a3 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span><span class="ws458">args, </span><span class="fc6">**</span>kwargs):</span></span></div><div class="t m0 x16 hf y20a4 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="fc9">&quot;Can<span class="ff9 ws13b">&apos;</span><span class="ws4">t instantiate directly&quot;<span class="fc0">)</span></span></span></span></div><div class="t m0 x15 h11 y20a5 ffa fs5 fcd sc0 ls0 ws13b"># Alternate constructor</div><div class="t m0 x15 h10 y20a6 ff7 fs5 fc12 sc0 ls0">@classmethod</div><div class="t m0 x15 hf y20a7 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_new<span class="fc0 ws13b">(cls, name):</span></span></div><div class="t m0 x16 hf y20a8 ff8 fs5 fca sc0 ls0 ws161">self <span class="fc6 ls33">=</span><span class="fc0 ws13a">cls<span class="fc6 ls34">.</span>__new__(cls)</span></div><div class="t m0 x16 hf y20a9 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x16 hf y20aa ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x0 h7 y20ab ff1 fs3 fc0 sc0 ls0 wsb90">最后<span class="_ _6"></span>这<span class="_ _6"></span>样<span class="_ _6"></span>的<span class="_ _6"></span>方案<span class="_ _6"></span>就<span class="_ _6"></span>已<span class="_ _6"></span>经足<span class="_ _6"></span>够<span class="_ _6"></span>好<span class="_ _6"></span>了。缓<span class="_ _6"></span>存<span class="_ _6"></span>和<span class="_ _6"></span>其他<span class="_ _6"></span>构<span class="_ _6"></span>造<span class="_ _6"></span>模式<span class="_ _6"></span>还<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>使用 <span class="ff4 wsb91">9.13 </span><span class="wsa0">小<span class="_ _6"></span>节<span class="_ _6"></span>中<span class="_ _6"></span>的</span></div><div class="t m0 x5 h7 y28 ff1 fs3 fc0 sc0 ls0 ws14">元类实现的更优雅一点 <span class="ff4 wsa5">(</span><span class="wsa0">使用了更高级的技术<span class="ff4 ls1b">)</span>。</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.25.<span class="_ _5"> </span>8.25 <span class="ff1 wsb83">创建缓存实例 </span>300</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
