<div id="pf1d7" class="pf w0 h0" data-page-no="1d7"><div class="pc pc1d7 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1d7.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_client<span class="fc0">(q):</span></span></div><div class="t m0 x15 h15 y1ac ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y1ad ffa fs5 fc9 sc0 ls0 ws4">Handle a client connection</div><div class="t m0 x15 h15 y1ae ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y1af ff8 fs5 fc0 sc0 ls0 ws13b">sock, client_addr <span class="fc6 ls32">=</span><span class="ls34">q<span class="fc6">.</span></span>get()</div><div class="t m0 x15 hf y1b0 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Got connection from<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, client_addr)</span></span></div><div class="t m0 x15 hf y355 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y410 ff8 fs5 fc0 sc0 ls0 ws158">msg <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>recv(<span class="fc7">65536</span>)</span></div><div class="t m0 x16 hf y411 ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 fc0">msg:</span></div><div class="t m0 x17 h10 yba ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x16 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6">.</span>sendall(msg)</div><div class="t m0 x15 hf ybed ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Client closed connection<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf ybef ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>close()</div><div class="t m0 x5 hf yd7d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">echo_server<span class="fc0 ws13b">(addr, nworkers):</span></span></div><div class="t m0 x15 h11 ybf1 ffa fs5 fcd sc0 ls0 ws4"># Launch the client workers</div><div class="t m0 x15 hf ybf2 ff8 fs5 fc0 sc0 ls32">q<span class="fc6 ls33">=</span><span class="ls0">Queue()</span></div><div class="t m0 x15 hf ybf3 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0">(nworkers):</span></span></span></div><div class="t m0 x16 hf ybf4 ff8 fs5 fc0 sc0 ls32">t<span class="fc6 ls33">=</span><span class="ls0 ws13a">Thread(target<span class="fc6 ls34">=</span><span class="ws13b">echo_client, args<span class="fc6 ls34">=</span>(q,))</span></span></div><div class="t m0 x16 hf ybf5 ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x16 hf ybf6 ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.<span class="fc0">start()</span></span></div><div class="t m0 x15 h11 ybf8 ffa fs5 fcd sc0 ls0 ws4"># Run the server</div><div class="t m0 x15 hf ybf9 ff8 fs5 fc0 sc0 ls0 ws13c">sock <span class="fc6 ls32">=</span><span class="ws4">socket(AF_INET, SOCK_STREAM)</span></div><div class="t m0 x15 hf ybfa ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>bind(addr)</div><div class="t m0 x15 hf ybfb ff8 fs5 fc0 sc0 ls0 ws13a">sock<span class="fc6 ls34">.</span>listen(<span class="fc7">5</span>)</div><div class="t m0 x15 hf y1ed6 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y1ed7 ff8 fs5 fc0 sc0 ls0 ws13b">client_sock, client_addr <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x16 hf y1ed8 ff8 fs5 fc0 sc0 ls34">q<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws4">put((client_sock, client_addr))</span></div><div class="t m0 x5 hf y1ed9 ff8 fs5 fc0 sc0 ls0 ws13a">echo_server((<span class="ff9 fc9 ls34">&apos;&apos;</span><span class="ls34">,</span><span class="fc7">15000</span><span class="ws159">), </span><span class="fc7">128</span>)</div><div class="t m0 x0 h9 y2203 ff1 fs3 fc0 sc0 ls0 ws363">使用 <span class="ff6 ws10d1">ThreadPoolExecutor </span><span class="ls51 ws1c8">相对于手动实现的一个好处在于它使得任务提交者更方</span></div><div class="t m0 x5 h9 y2f1f ff1 fs3 fc0 sc0 ls0">便的从被调用函数中获取返回值。例如，你可能会像下面这样写：</div><div class="t m0 x5 hf y2f20 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscf2">concurrent.futures </span><span class="ws1ff">import <span class="ff8 fc0">ThreadPoolExecutor</span></span></div><div class="t m0 x5 h10 y2f21 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">urllib.request</span></div><div class="t m0 x5 hf y2f22 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">fetch_url<span class="fc0">(url):</span></span></div><div class="t m0 x15 hf y2f23 ff8 fs5 fc0 sc0 ls32">u<span class="fc6 ls33">=</span><span class="ls0 ws13a">urllib<span class="fc6 ls34">.</span>request<span class="fc6 ls34">.</span>urlopen(url)</span></div><div class="t m0 x15 hf y2f24 ff8 fs5 fc0 sc0 ls0 ws13c">data <span class="fc6 ls32">=</span><span class="ls34">u</span><span class="fc6 ws13a">.</span>read()</div><div class="t m0 x15 hf y2f25 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">data</span></div><div class="t m0 x5 hf y2f26 ff8 fs5 fc0 sc0 ls0 ws13c">pool <span class="fc6 ls32">=</span><span class="ws13a">ThreadPoolExecutor(<span class="fc7">10</span>)</span></div><div class="t m0 x5 h11 y2f27 ffa fs5 fcd sc0 ls0 ws4"># Submit work to the pool</div><div class="t m0 x5 hf y2f28 ff8 fs5 fc0 sc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">pool<span class="fc6 ls34">.</span><span class="ws23c">submit(fetch_url, <span class="ff9 fc9 ws13b">&apos;</span></span><span class="fc9">http://www.python.org<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 hf y2f29 ff8 fs5 fc0 sc0 ls32">b<span class="fc6 ls33">=</span><span class="ls0 ws13a">pool<span class="fc6 ls34">.</span><span class="ws23c">submit(fetch_url, <span class="ff9 fc9 ws13b">&apos;</span></span><span class="fc9">http://www.pypy.org<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 h11 y2f2a ffa fs5 fcd sc0 ls0 ws4"># Get the results back</div><div class="t m0 x5 hf y2f2b ff8 fs5 fc0 sc0 ls32">x<span class="fc6 ls33">=</span><span class="ls34">a<span class="fc6 ls0 ws13a">.<span class="fc0">result()</span></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.7.<span class="_ _36"> </span>12.7 <span class="ff1 ws600">创建一个线程池 </span>462</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
