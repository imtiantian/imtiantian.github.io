<div id="pf170" class="pf w0 h0" data-page-no="170"><div class="pc pc170 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg170.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Deleted:<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, c</span><span class="fc6">.</span>deleted)</span></div><div class="t m0 x0 h9 y2630 ff1 fs3 fc0 sc0 ls0">如果你运行这个程序，你会得到下面这样的输出：</div><div class="t m0 x5 hf y2631 ff8 fs5 fc0 sc0 ls0 ws4">Loaded: {<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">i<span class="ff9">&apos;</span></span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13a">range<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">print</span><span class="ls34">&apos;</span></span>}</div><div class="t m0 x5 hf y2632 ff8 fs5 fc0 sc0 ls0 ws4">Stored: {<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">i<span class="ff9">&apos;</span></span></span>}</div><div class="t m0 x5 hf y2633 ff8 fs5 fc0 sc0 ls0 ws4">Deleted: {<span class="ff9 fc9 ls34">&apos;<span class="ff8">i</span><span class="ls0 ws13b">&apos;</span></span>}</div><div class="t m0 x0 h7 y2634 ff1 fs3 fc0 sc0 ls0 wsa0">最后，<span class="ff4 ws5d">AST </span><span class="ws14">可以通过 <span class="ff6 ws1d1">compile() </span>函数来编译并执行。例如：</span></div><div class="t m0 x5 hf y2635 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">exec<span class="ff8 fc0 ls34">(</span><span class="ff8 ws13a">compile<span class="fc0">(top,<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">&lt;stdin&gt;<span class="ff9 ls34">&apos;</span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">exec<span class="ff9 ls34">&apos;</span></span>))</span></span></span></div><div class="t m0 x5 hf y2636 ff8 fs5 fc8 sc0 ls0">0</div><div class="t m0 x5 hf y2637 ff8 fs5 fc8 sc0 ls0">1</div><div class="t m0 x5 hf y2638 ff8 fs5 fc8 sc0 ls0">2</div><div class="t m0 x5 hf y2639 ff8 fs5 fc8 sc0 ls0">3</div><div class="t m0 x5 hf ya18 ff8 fs5 fc8 sc0 ls0">4</div><div class="t m0 x5 hf ya19 ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf ya1a ff8 fs5 fc8 sc0 ls0">6</div><div class="t m0 x5 hf ya1b ff8 fs5 fc8 sc0 ls0">7</div><div class="t m0 x5 hf ya1c ff8 fs5 fc8 sc0 ls0">8</div><div class="t m0 x5 hf y263a ff8 fs5 fc8 sc0 ls0">9</div><div class="t m0 x5 hf y263b ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y263c ff2 fs2 fc4 sc0 ls0 wsadf">11.24.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y263d ff1 fs3 fc0 sc0 ls3a ws153">当你能够分析源代码并从中获取信息的时候，你就能写很多代码分析、优化或验证</div><div class="t m0 x5 h9 y263e ff1 fs3 fc0 sc0 ls0 wsb5e">工具了。例如，相比盲目的传递一些代码片段到类似 <span class="ff6 ws25d">exec() </span><span class="wsa0">函数中，你可以先将它转</span></div><div class="t m0 x5 h7 y263f ff1 fs3 fc0 sc0 ls0 ws1fb">换成<span class="_ _6"></span>一个 <span class="ff4 wsa5">AST</span><span class="ls42 ws186">，然后观察它的细节看它到底是怎样做的。你还可以写一些工具来查看</span></div><div class="t m0 x5 h9 y2640 ff1 fs3 fc0 sc0 ls0">某个模块的全部源码，并且在此基础上执行某些静态分析。</div><div class="t m0 x0 h7 y2641 ff1 fs3 fc0 sc0 ls17 wsce0">需要注意的是，如果你知道自己在干啥<span class="_ _1"></span>，你还能够重写 <span class="ff4 ls0 wsce1">AST </span><span class="wsf6">来表示新的代码。下<span class="_ _1"></span></span></div><div class="t m0 x5 h7 yfeb ff1 fs3 fc0 sc0 ls35 wsce2">面是一个装饰器例子，可以通过重新解析函数体源码、重写 <span class="ff4 ls0 wsce3">AST </span><span class="ws144">并重新创建函数代码</span></div><div class="t m0 x5 h9 y2642 ff1 fs3 fc0 sc0 ls0">对象来将全局访问变量降为函数体作用范围，</div><div class="t m0 x5 h11 y2643 ffa fs5 fcd sc0 ls0 ws4"># namelower.py</div><div class="t m0 x5 h10 y1e6a ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">ast</span></div><div class="t m0 x5 h10 y1e6b ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">inspect</span></div><div class="t m0 x5 h11 y1e6d ffa fs5 fcd sc0 ls0 ws4"># Node visitor that lowers globally accessed names into</div><div class="t m0 x5 h11 y1e6e ffa fs5 fcd sc0 ls0 ws4"># the function body as local variables.</div><div class="t m0 x5 hf y2644 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">NameLower<span class="ff8 fc0 ws13a">(ast<span class="fc6 ls34">.</span>NodeVisitor):</span></span></div><div class="t m0 x15 hf y1e6f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, lowered_names):</span></span></span></div><div class="t m0 x16 hf y1e70 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws5a4">lowered_names </span><span class="ls32">=</span><span class="fc0">lowered_names</span></span></div><div class="t m0 x15 hf y1e72 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">visit_FunctionDef<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, node):</span></span></span></div><div class="t m0 x16 h11 y1307 ffa fs5 fcd sc0 ls0 ws4"># Compile some assignments to lower the constants</div><div class="t m0 x16 hf y1e73 ff8 fs5 fc0 sc0 ls0 ws161">code <span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13b">__globals = globals()<span class="ff7 ws156">\n<span class="ff9">&apos;</span></span></span></div><div class="t m0 x16 hf y1e74 ff8 fs5 fc0 sc0 ls0 ws161">code <span class="fc6 ws1a1">+= <span class="ff9 fc9 ws13b">&apos;<span class="ff7 ws156">\n</span><span class="ls34">&apos;</span></span><span class="ws13a">.<span class="fc0">join(<span class="fc9 ws13b">&quot;{0} = __globals[<span class="ff9 ls34">&apos;</span><span class="ws13a">{0}<span class="ff9 ls34">&apos;</span>]&quot;</span></span></span><span class="ls34">.</span></span></span>format(name)</div><div class="t m0 x23 hf y1e75 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13c">name </span><span class="ws157">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">lowered_names)</span></span></span></div><div class="t m0 x16 hf y171b ff8 fs5 fc0 sc0 ls0 ws1f5">code_ast <span class="fc6 ls33">=</span><span class="ws13a">ast<span class="fc6 ls34">.</span><span class="ws13b">parse(code, mode<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span></span><span class="fc9">exec<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.24.<span class="_ _5"> </span>9.24 <span class="ff1 ws7da">解析与分析 </span><span class="wscda">Python <span class="ff1 wscdb">源码 </span>359</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
