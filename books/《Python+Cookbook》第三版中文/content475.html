<div id="pf1db" class="pf w0 h0" data-page-no="1db"><div class="pc pc1db w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1db.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff8 fs5 fc0 sc0 ls0 ws145">robots <span class="fc6 ls32">=</span><span class="fca ws13a">set</span>()</div><div class="t m0 x15 hf y1ac ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">gzip<span class="fc6 ls34">.</span><span class="ws169">open(filename) </span></span><span class="ws157">as <span class="ff8 fc0">f:</span></span></div><div class="t m0 x16 hf y1ad ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws161">line </span><span class="ws160">in <span class="ff8 fc0 ws13a">io<span class="fc6 ls34">.</span>TextIOWrapper(f,encoding<span class="fc6 ls34">=<span class="ff9 fc9">&apos;</span></span><span class="fc9">ascii<span class="ff9 ls34">&apos;</span></span>):</span></span></div><div class="t m0 x17 hf y1ae ff8 fs5 fc0 sc0 ls0 ws145">fields <span class="fc6 ls32">=</span><span class="ws13a">line<span class="fc6 ls34">.</span>split()</span></div><div class="t m0 x17 hf y1af ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">fields[<span class="fc7 ls34">6</span><span class="ls32">]</span><span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">/robots.txt<span class="ff9 ls34">&apos;</span></span>:</span></div><div class="t m0 x18 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws13a">robots<span class="fc6 ls34">.</span>add(fields[<span class="fc7">0</span>])</div><div class="t m0 x15 hf y355 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">robots</span></div><div class="t m0 x5 hf y411 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">find_all_robots<span class="fc0">(logdir):</span></span></div><div class="t m0 x15 h15 yba ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y8c6 ffa fs5 fc9 sc0 ls0 ws4">Find all hosts across and entire sequence of files</div><div class="t m0 x15 h15 ybed ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf ybee ff8 fs5 fc0 sc0 ls0 ws15f">files <span class="fc6 ls33">=</span><span class="ws13a">glob<span class="fc6">.</span>glob(logdir<span class="fc6 ls34">+<span class="ff9 fc9">&apos;</span></span><span class="fc9">/*.log.gz<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf ybef ff8 fs5 fc0 sc0 ls0 ws2a3">all_robots <span class="fc6 ls32">=</span><span class="fca ws13a">set</span>()</div><div class="t m0 x15 hf ybf0 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws13a">futures<span class="fc6">.</span><span class="wsd67">ProcessPoolExecutor() </span></span><span class="ws160">as <span class="ff8 fc0">pool:</span></span></div><div class="t m0 x16 hf yd7d ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws145">robots </span><span class="ws157">in <span class="ff8 fc0 ws13a">pool<span class="fc6 ls34">.</span><span class="ws13b">map(find_robots, files):</span></span></span></div><div class="t m0 x17 hf ybf1 ff8 fs5 fc0 sc0 ls0 ws13a">all_robots<span class="fc6 ls34">.</span>update(robots)</div><div class="t m0 x15 hf ybf2 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">all_robots</span></div><div class="t m0 x5 hf ybf4 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf ybf5 ff8 fs5 fc0 sc0 ls0 ws145">robots <span class="fc6 ls32">=</span><span class="ws13a">find_all_robots(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">logs<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x15 hf ybf6 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws145">ipaddr </span><span class="ws157">in <span class="ff8 fc0">robots:</span></span></div><div class="t m0 x16 hf ybf7 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0">(ipaddr)</span></div><div class="t m0 x0 h9 y21a8 ff1 fs3 fc0 sc0 ls3a ws153">通过这个修改后，运行这个脚本产生同样的结果，但是在四核机器上面比之前快了</div><div class="t m0 x5 h7 y2d37 ff4 fs3 fc0 sc0 ls0 ws171">3.5 <span class="ff1 ws38">倍。实际的性能优化效果根据你的机器 </span><span class="wsa8">CPU <span class="ff1">数量的不同而不同。</span></span></div><div class="t m0 x5 he y2f6f ff2 fs2 fc4 sc0 ls0 ws212">14.8.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2f70 ff6 fs3 fc0 sc0 ls0 ws10fa">ProcessPoolExecutor <span class="ff1">的典型用法如下：</span></div><div class="t m0 x5 hf y2f71 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wscf2">concurrent.futures </span><span class="ws1ff">import <span class="ff8 fc0">ProcessPoolExecutor</span></span></div><div class="t m0 x5 hf y27cc ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 wsd67">ProcessPoolExecutor() </span><span class="ws157">as <span class="ff8 fc0">pool:</span></span></div><div class="t m0 x15 hf y2f72 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x15 hf y2f73 ff8 fs5 fc0 sc0 ls0 ws13b">do work <span class="ff7 fca ws157">in </span>parallel using pool</div><div class="t m0 x15 hf y2f74 ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x0 h7 y2f75 ff1 fs3 fc0 sc0 ls0 ws10fb">其原<span class="_ _6"></span>理<span class="_ _6"></span>是，一<span class="_ _6"></span>个 <span class="ff6 ws10fc">ProcessPoolExecutor </span><span class="ws10fd">创建 <span class="ff4 ls202">N</span><span class="ws10fe">个<span class="_ _6"></span>独<span class="_ _6"></span>立的 <span class="ff4 ws10ff">Python </span><span class="wsa0">解<span class="_ _6"></span>释器，<span class="_ _6"></span><span class="ff4 ls202">N</span>是<span class="_ _6"></span>系</span></span></span></div><div class="t m0 x5 h7 y2f76 ff1 fs3 fc0 sc0 ls0 wsd38">统上面可用 <span class="ff4 wsa8">CPU </span><span class="ws495">的个数。你可以通过提供可选参数给 <span class="ff6 ws710">ProcessPoolExecutor(N) </span>来修</span></div><div class="t m0 x5 h7 y2f77 ff1 fs3 fc0 sc0 ls0 ws1100">改处理器<span class="_ _6"></span>数量。这个处<span class="_ _6"></span>理池会一直<span class="_ _6"></span>运行到 <span class="ff4 ws1101">with </span><span class="wsa0">块中最<span class="_ _6"></span>后一个语句<span class="_ _6"></span>执行完成，然<span class="_ _6"></span>后处理</span></div><div class="t m0 x5 h9 y2f78 ff1 fs3 fc0 sc0 ls0">池被关闭。不过，程序会一直等待直到所有提交的工作被处理完成。</div><div class="t m0 x0 h9 y2f79 ff1 fs3 fc0 sc0 ls3a ws153">被提交到池中的工作必须被定义为一个函数。有两种方法去提交。如果你想让一个</div><div class="t m0 x5 h7 y2f7a ff1 fs3 fc0 sc0 ls0 ws38">列表推导或一个 <span class="ff6 ws19e">map() </span><span class="wsc">操作并行执行的话，可使用 <span class="ff6 ws17c">pool.map() <span class="ff4">:</span></span></span></div><div class="t m0 x5 h11 y2f7b ffa fs5 fcd sc0 ls0 ws4"># A function that performs a lot of work</div><div class="t m0 x5 hf y2f7c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">work<span class="fc0">(x):</span></span></div><div class="t m0 x15 hf y2f7d ff8 fs5 fc6 sc0 ls0 ws13a">...</div><div class="t m0 x15 hf y2f7e ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">result</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.8.<span class="_ _36"> </span>12.8 <span class="ff1 ws600">简单的并行编程 </span>466</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
