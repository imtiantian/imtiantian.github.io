<div id="pf260" class="pf w0 h0" data-page-no="260"><div class="pc pc260 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg260.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 wsd91">17.17<span class="_ _e"> </span>15.17 <span class="ff1 ws165">传递文件名给 </span><span class="ls23d">C</span><span class="ff1">扩展</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">17.17.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y2b2 ff1 fs3 fc0 sc0 ls0 ws15d0">你需<span class="_ _6"></span>要<span class="_ _6"></span>向 <span class="ff4 ls25f">C</span><span class="ls2d ws132">库函数传递文件名，但是需要确保文件名根据系统期望的文件名编码<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y23ec ff1 fs3 fc0 sc0 ls0">方式编码过。</div><div class="t m0 x5 he y23ed ff2 fs2 fc4 sc0 ls0 wsadf">17.17.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y3a57 ff1 fs3 fc0 sc0 ls0">写一个接受一个文件名为参数的扩展函数，如下这样：</div><div class="t m0 x5 hf y3a58 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_get_filename(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y3a59 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *bytes;</div><div class="t m0 x19 hf y3a5a ff8 fs5 fc0 sc0 ls0 ws4">char *filename;</div><div class="t m0 x19 hf y3a5b ff8 fs5 fc0 sc0 ls0 ws4">Py_ssize_t len;</div><div class="t m0 x19 hf y3a5c ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args,&quot;O&amp;&quot;, PyUnicode_FSConverter, &amp;bytes)) {</div><div class="t m0 x15 hf y3a5d ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y3a5e ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3a5f ff8 fs5 fc0 sc0 ls0 ws4">PyBytes_AsStringAndSize(bytes, &amp;filename, &amp;len);</div><div class="t m0 x19 hf y3a60 ff8 fs5 fc0 sc0 ls0 ws4">/* Use filename */</div><div class="t m0 x19 hf y1f1d ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x19 hf y3a61 ff8 fs5 fc0 sc0 ls0 ws4">/* Cleanup and return */</div><div class="t m0 x19 hf y3a62 ff8 fs5 fc0 sc0 ls0">Py_DECREF(bytes)</div><div class="t m0 x19 hf y1589 ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y3a63 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y3a64 ff1 fs3 fc0 sc0 ls2c ws15d1">如果你已经有了一个 <span class="ff6 ls0 ws119c">PyObject<span class="_ _11"> </span>* </span><span class="ws12f">，希望将其转换成一个文件名，可以像下面这样</span></div><div class="t m0 x5 h9 y3a65 ff1 fs3 fc0 sc0 ls0">做：</div><div class="t m0 x5 hf y34f3 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj;<span class="_ _22"> </span>/* Object with the filename */</div><div class="t m0 x5 hf y3a66 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *bytes;</div><div class="t m0 x5 hf y3a67 ff8 fs5 fc0 sc0 ls0 ws4">char *filename;</div><div class="t m0 x5 hf y3a68 ff8 fs5 fc0 sc0 ls0 ws4">Py_ssize_t len;</div><div class="t m0 x5 hf y3a69 ff8 fs5 fc0 sc0 ls0 ws4">bytes = PyUnicode_EncodeFSDefault(obj);</div><div class="t m0 x5 hf y3a6a ff8 fs5 fc0 sc0 ls0 ws4">PyBytes_AsStringAndSize(bytes, &amp;filename, &amp;len);</div><div class="t m0 x5 hf y3a6b ff8 fs5 fc0 sc0 ls0 ws4">/* Use filename */</div><div class="t m0 x5 hf y3150 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y3a6c ff8 fs5 fc0 sc0 ls0 ws4">/* Cleanup */</div><div class="t m0 x5 hf y311b ff8 fs5 fc0 sc0 ls0">Py_DECREF(bytes);</div><div class="t m0 x5 hf y3a6d ff8 fs5 fc0 sc0 ls0 ws4">If you need to return a filename back to Python, use the following code:</div><div class="t m0 x5 hf y311e ff8 fs5 fc0 sc0 ls0 ws4">/* Turn a filename into a Python object */</div><div class="t m0 x5 hf y1483 ff8 fs5 fc0 sc0 ls0 ws4">char *filename;<span class="_ _41"> </span>/* Already set */</div><div class="t m0 x5 hf y395 ff8 fs5 fc0 sc0 ls0 ws4">int<span class="_ _3a"> </span>filename_len;<span class="_ _4a"> </span>/* Already set */</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.17.<span class="_ _36"> </span>15.17 <span class="ff1 ws16b">传递文件名给 </span><span class="ls246">C</span><span class="ff1 ws15d2">扩展 </span>599</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
