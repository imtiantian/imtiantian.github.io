<div id="pf257" class="pf w0 h0" data-page-no="257"><div class="pc pc257 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg257.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_chars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">PyObject *o, *bytes;</div><div class="t m0 x19 hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x19 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;U&quot;, &amp;o)) {</div><div class="t m0 x15 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y355 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y410 ff8 fs5 fc0 sc0 ls0 ws4">bytes = PyUnicode_AsUTF8String(o);</div><div class="t m0 x19 hf y411 ff8 fs5 fc0 sc0 ls0 ws4">s = PyBytes_AsString(bytes);</div><div class="t m0 x19 hf yba ff8 fs5 fc0 sc0 ls0">print_chars(s);</div><div class="t m0 x19 hf y8c6 ff8 fs5 fc0 sc0 ls0">Py_DECREF(bytes);</div><div class="t m0 x19 hf ybed ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf ybee ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y398c ff1 fs3 fc0 sc0 ls6b ws1561">通过这个修改，一个 <span class="ff4 ls0 ws1562">UTF-8 </span><span class="ws28f">编码的字符串根据需要被创建<span class="_ _c"></span>，然后在使用过后被丢</span></div><div class="t m0 x5 h9 y398d ff1 fs3 fc0 sc0 ls0">弃。下面是修订后的效果：</div><div class="t m0 x5 h10 y398e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sys</span></span></div><div class="t m0 x5 hf y27e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=<span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalape<span class="ff7 ws156">\u00f1</span><span class="ws13a">o<span class="ff9">&apos;</span></span></span></span></span></span></div><div class="t m0 x5 hf yc50 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>getsizeof(s)</span></div><div class="t m0 x5 hf y398f ff8 fs5 fc8 sc0 ls0">87</div><div class="t m0 x5 hf y7b4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">print_chars(s)</span></div><div class="t m0 x5 hf y3990 ff8 fs5 fc8 sc0 ls0 ws4">53 70 69 63 79 20 4a 61 6c 61 70 65 c3 b1 6f</div><div class="t m0 x5 hf y3991 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sys<span class="fc6 ls34">.</span>getsizeof(s)</span></div><div class="t m0 x5 hf y3992 ff8 fs5 fc8 sc0 ls0">87</div><div class="t m0 x5 hf y3993 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y3994 ff1 fs3 fc0 sc0 ls1f ws3f1">如果你试着传递 <span class="ff4 ls0 ws1563">NULL </span><span class="ws1564">结尾字符串给 <span class="ff4 ls0 ws1565">ct<span class="_ _1"></span>yp<span class="_ _6"></span>es <span class="ff1 ls1f ws1566">包装过的函数，要注意的是 </span>ct<span class="_ _1"></span>yp<span class="_ _6"></span>es <span class="ff1">只</span></span></span></div><div class="t m0 x5 h7 y3995 ff1 fs3 fc0 sc0 ls0 ws14">能允许传递字节，并且它不会检查中间嵌入的 <span class="ff4 wsbe">NULL </span>字节。例如：</div><div class="t m0 x5 h10 y3996 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">ctypes</span></span></div><div class="t m0 x5 hf y3997 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">lib <span class="fc6 ls32">=</span><span class="ws13a">ctypes<span class="fc6">.</span>cdll<span class="fc6 ls34">.</span>LoadLibrary(<span class="fc9">&quot;./libsample.so&quot;</span>)</span></span></div><div class="t m0 x5 hf y3998 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws208">print_chars <span class="fc6 ls32">=</span><span class="ws13a">lib<span class="fc6 ls34">.</span>print_chars</span></span></div><div class="t m0 x5 hf y3999 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">print_chars<span class="fc6 ls34">.</span><span class="ws1f5">argtypes <span class="fc6 ls33">=</span></span>(ctypes<span class="fc6">.</span>c_char_p,)</span></div><div class="t m0 x5 hf y399a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">print_chars(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Hello World<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y399b ff8 fs5 fc8 sc0 ls0 ws4">48 65 6c 6c 6f 20 57 6f 72 6c 64</div><div class="t m0 x5 hf y399c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">print_chars(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Hello<span class="ff7 ws156">\x00</span>World<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y399d ff8 fs5 fc8 sc0 ls0 ws4">48 65 6c 6c 6f</div><div class="t m0 x5 hf y399e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">print_chars(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Hello World</span><span class="ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y399f ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y39a0 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x5 hf y39a1 ff8 fs5 fc2 sc0 ls0 ws13a">ctypes.ArgumentError<span class="fc0 ws4">: argument 1: &lt;class <span class="ff9 ls34">&apos;</span><span class="ws13a">TypeError<span class="ff9 ls34">&apos;</span><span class="ws13b">&gt;: wrong type</span></span></span></div><div class="t m0 x5 hf y39a2 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y39a3 ff1 fs3 fc0 sc0 ls0 ws14">如果你想传递字符串而不是字节，你需要先执行手动的 <span class="ff4 ws61f">UTF-8 </span>编码。例如：</div><div class="t m0 x5 hf y39a4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">print_chars(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Hello World</span><span class="ls34">&apos;<span class="ff8 fc6">.</span></span></span>encode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ls34">&apos;</span></span>))</span></div><div class="t m0 x5 hf y39a5 ff8 fs5 fc8 sc0 ls0 ws4">48 65 6c 6c 6f 20 57 6f 72 6c 64</div><div class="t m0 x5 hf y20de ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y39a6 ff1 fs3 fc0 sc0 lsa8 ws1567">对于其他扩展工具（比如 <span class="ff4 ls0 wsa5">Swig</span><span class="ls16c">、<span class="ff4 ls0 wsa5">Cython</span></span><span class="ws1568">）<span class="_ _2e"></span>，在你使用它们传递字符串给 <span class="ff4 ls29b">C</span><span class="ls0 wsa0">代码<span class="_ _6"></span>时</span></span></div><div class="t m0 x5 h9 y2ded ff1 fs3 fc0 sc0 ls0">要先好好学习相应的东西了。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.13.<span class="_ _36"> </span>15.13 <span class="ff1 ws16b">传递 </span><span class="ws1544">NULL <span class="ff1 ws7da">结尾的字符串给 </span><span class="ls246">C</span><span class="ff1 ws1545">函数库 </span>590</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
