<div id="pf237" class="pf w0 h0" data-page-no="237"><div class="pc pc237 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg237.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 he y137 ff2 fs2 fc4 sc0 ls0 ws212">17.4.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y138 ff1 fs3 fc0 sc0 ls3a ws153">隐形结构体可以很容易的通过将它们包装在胶囊对象中来处理。考虑我们例子代码</div><div class="t m0 x5 h7 y139 ff1 fs3 fc0 sc0 ls0 ws14">中的下列 <span class="ff4 ls8">C</span>代码片段：</div><div class="t m0 x5 hf y1dc6 ff8 fs5 fc0 sc0 ls0 ws4">typedef struct Point {</div><div class="t m0 x15 hf y1dc7 ff8 fs5 fc0 sc0 ls0 ws13b">double x,y;</div><div class="t m0 x5 hf y1dc8 ff8 fs5 fc0 sc0 ls0 ws4">} Point;</div><div class="t m0 x5 hf ycdc ff8 fs5 fc0 sc0 ls0 ws4">extern double distance(Point *p1, Point *p2);</div><div class="t m0 x0 h7 y36c5 ff1 fs3 fc0 sc0 ls0 ws38">下面是一个使用胶囊包装 <span class="ff4 ws13e6">P<span class="_ _1"></span>oin<span class="_ _1"></span>t <span class="ff1 ws14">结构体和 <span class="ff6 ws17c">distance() </span>函数的扩展代码实例：</span></span></div><div class="t m0 x5 hf y21d8 ff8 fs5 fc0 sc0 ls0 ws4">/* Destructor function for points */</div><div class="t m0 x5 hf y21d9 ff8 fs5 fc0 sc0 ls0 ws4">static void del_Point(PyObject *obj) {</div><div class="t m0 x19 hf y36c6 ff8 fs5 fc0 sc0 ls0">free(PyCapsule_GetPointer(obj,&quot;Point&quot;));</div><div class="t m0 x5 hf y21da ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y1d7c ff8 fs5 fc0 sc0 ls0 ws4">/* Utility functions */</div><div class="t m0 x5 hf y1d7d ff8 fs5 fc0 sc0 ls0 ws4">static Point *PyPoint_AsPoint(PyObject *obj) {</div><div class="t m0 x19 hf y1d7e ff8 fs5 fc0 sc0 ls0 ws4">return (Point *) PyCapsule_GetPointer(obj, &quot;Point&quot;);</div><div class="t m0 x5 hf y1d7f ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y36c7 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *PyPoint_FromPoint(Point *p, int must_free) {</div><div class="t m0 x19 hf y36c8 ff8 fs5 fc0 sc0 ls0 ws4">return PyCapsule_New(p, &quot;Point&quot;, must_free ? del_Point : NULL);</div><div class="t m0 x5 hf y21dc ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y21de ff8 fs5 fc0 sc0 ls0 ws4">/* Create a new Point object */</div><div class="t m0 x5 hf y21df ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_Point(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y1b73 ff8 fs5 fc0 sc0 ls0 ws4">Point *p;</div><div class="t m0 x19 hf y1d82 ff8 fs5 fc0 sc0 ls0 ws4">double x,y;</div><div class="t m0 x19 hf y1b74 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args,&quot;dd&quot;,&amp;x,&amp;y)) {</div><div class="t m0 x15 hf y1b75 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y1b76 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y36c9 ff8 fs5 fc0 sc0 ls0 ws4">p = (Point *) malloc(sizeof(Point));</div><div class="t m0 x19 hf y36ca ff8 fs5 fc0 sc0 ls0 ws4">p-&gt;x = x;</div><div class="t m0 x19 hf y36cb ff8 fs5 fc0 sc0 ls0 ws4">p-&gt;y = y;</div><div class="t m0 x19 hf y36cc ff8 fs5 fc0 sc0 ls0 ws4">return PyPoint_FromPoint(p, 1);</div><div class="t m0 x5 hf y36cd ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y36ce ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_distance(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y36cf ff8 fs5 fc0 sc0 ls0 ws4">Point *p1, *p2;</div><div class="t m0 x19 hf y36d0 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *py_p1, *py_p2;</div><div class="t m0 x19 hf y36d1 ff8 fs5 fc0 sc0 ls0 ws4">double result;</div><div class="t m0 x19 hf y36d2 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args,&quot;OO&quot;,&amp;py_p1, &amp;py_p2)) {</div><div class="t m0 x15 hf y36d3 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y177b ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y36d4 ff8 fs5 fc0 sc0 ls0 ws4">if (!(p1 = PyPoint_AsPoint(py_p1))) {</div><div class="t m0 x15 hf y36d5 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.4.<span class="_ _36"> </span>15.4 <span class="ff1 ls81">在</span><span class="ls260">C</span><span class="ff1 ws13e5">扩展模块中操作隐形指针 </span>558</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
