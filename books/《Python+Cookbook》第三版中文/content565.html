<div id="pf235" class="pf w0 h0" data-page-no="235"><div class="pc pc235 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg235.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y1e8 ff8 fs5 fc0 sc0 ls0 ws4">/* Check the type of items in the array */</div><div class="t m0 x19 hf y1e9 ff8 fs5 fc0 sc0 ls0 ws4">if (strcmp(view.format,&quot;d&quot;) != 0) {</div><div class="t m0 x15 hf y1ea ff8 fs5 fc0 sc0 ls0 ws4">PyErr_SetString(PyExc_TypeError, &quot;Expected an array of doubles&quot;);</div><div class="t m0 x15 hf y903 ff8 fs5 fc0 sc0 ls0">PyBuffer_Release(&amp;view);</div><div class="t m0 x15 hf y1eb ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y1ec ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y905 ff8 fs5 fc0 sc0 ls0 ws4">/* Pass the raw buffer and size to the C function */</div><div class="t m0 x19 hf y906 ff8 fs5 fc0 sc0 ls0 ws4">result = avg(view.buf, view.shape[0]);</div><div class="t m0 x19 hf y908 ff8 fs5 fc0 sc0 ls0 ws4">/* Indicate we<span class="ff9 ws13b">&apos;</span>re done working with the buffer */</div><div class="t m0 x19 hf y909 ff8 fs5 fc0 sc0 ls0">PyBuffer_Release(&amp;view);</div><div class="t m0 x19 hf ybd8 ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;d&quot;, result);</div><div class="t m0 x5 hf ybd9 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h9 y3033 ff1 fs3 fc0 sc0 ls0">下面我们演示下这个扩展函数是如何工作的：</div><div class="t m0 x5 h10 y3697 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">array</span></span></div><div class="t m0 x5 hf y3698 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">avg(array<span class="fc6 ls34">.</span>array(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">d<span class="ff9">&apos;</span></span></span>,[<span class="fc7 ls34">1<span class="fc0">,</span><span class="ls0">2</span><span class="fc0">,</span>3</span>]))</span></div><div class="t m0 x5 hf y3699 ff8 fs5 fc8 sc0 ls0">2.0</div><div class="t m0 x5 h10 y369a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">numpy</span></span></div><div class="t m0 x5 hf y369b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">avg(numpy<span class="fc6 ls34">.</span>array([<span class="fc7">1.0</span><span class="ls34">,</span><span class="fc7">2.0</span><span class="ls34">,</span><span class="fc7">3.0</span>]))</span></div><div class="t m0 x5 hf y369c ff8 fs5 fc8 sc0 ls0">2.0</div><div class="t m0 x5 hf y369d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">avg([<span class="fc7">1</span><span class="ls34">,<span class="fc7">2</span></span>,<span class="fc7 ls34">3</span>])</span></div><div class="t m0 x5 hf y369e ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y369f ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x5 hf y36a0 ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ls32">:<span class="ff9 ls34">&apos;</span><span class="ls0">list</span><span class="ff9">&apos;</span><span class="ls0 ws4">does not support the buffer interface</span></span></div><div class="t m0 x5 hf y36a1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">avg(b<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">Hello<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y36a2 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y36a3 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x5 hf y36a4 ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: Expected an array of doubles</span></div><div class="t m0 x5 hf y36a5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">numpy<span class="fc6 ls34">.</span>array([[<span class="fc7">1.</span><span class="ls34">,</span><span class="fc7">2.</span>,<span class="fc7">3.</span>],[<span class="fc7">4.</span><span class="ls34">,</span><span class="fc7">5.</span>,<span class="fc7">6.</span>]])</span></span></div><div class="t m0 x5 hf y36a6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">avg(a[:,<span class="fc7">2</span>])</span></div><div class="t m0 x5 hf y8f2 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y8f3 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x5 hf y8f4 ff8 fs5 fc2 sc0 ls0 ws13a">ValueError<span class="fc0 ws4">: ndarray is not contiguous</span></div><div class="t m0 x5 hf y8f5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>avg(a)</span></div><div class="t m0 x5 hf y36a7 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y36a8 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x5 hf y36a9 ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: Expected a 1-dimensional array</span></div><div class="t m0 x5 hf y36aa ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>avg(a[<span class="fc7 ls34">0</span>])</span></div><div class="t m0 x5 hf y8fa ff8 fs5 fc8 sc0 ls0">2.0</div><div class="t m0 x5 hf y8fb ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y36ab ff2 fs2 fc4 sc0 ls0 ws212">17.3.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y36ac ff1 fs3 fc0 sc0 ls0 wsfb5">将一个数组对象传给 <span class="ff4 ls204">C</span><span class="ws13d5">函数可能是一个扩展函数做的最常见的事。很多 <span class="ff4 ws1115">Python </span>应</span></div><div class="t m0 x5 h9 y36ad ff1 fs3 fc0 sc0 ls1e ws111">用程序<span class="_ _1"></span>，从图像处理到科学计算<span class="_ _1"></span>，都是基于高性能的数组处理。通过编写能接受<span class="_ _1"></span>并操</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.3.<span class="_ _36"> </span>15.3 <span class="ff1 ws509">编写扩展函数操作数组 </span>556</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
