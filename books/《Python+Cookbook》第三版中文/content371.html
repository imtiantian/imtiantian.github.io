<div id="pf173" class="pf w0 h0" data-page-no="173"><div class="pc pc173 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg173.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y432 ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13a">LOAD_FAST<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y433 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y2662 ff1 fs3 fc0 sc0 ls0 wsced">奇<span class="_ _6"></span>怪<span class="_ _6"></span>的<span class="_ _6"></span>是，<span class="_ _6"></span>在 <span class="ff6 wscee">dis </span><span class="ls49 ws1a6">模块中并没有函数让你以编程方式很容易的来处理字节码。不<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y2663 ff1 fs3 fc0 sc0 ls0 ws63">过，下面的生成器函数可以将原始字节码序列转换成 <span class="ff6 ws472">opcodes </span>和参数。</div><div class="t m0 x5 h10 y2664 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">opcode</span></div><div class="t m0 x5 hf y2665 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">generate_opcodes<span class="fc0">(codebytes):</span></span></div><div class="t m0 x15 hf y2666 ff8 fs5 fc0 sc0 ls0 ws150">extended_arg <span class="fc6 ls33">=</span><span class="fc7">0</span></div><div class="t m0 x15 hf y2667 ff8 fs5 fc0 sc0 ls32">i<span class="fc6 ls33">=<span class="fc7 ls0">0</span></span></div><div class="t m0 x15 hf y2668 ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls33">=<span class="fca ls0 ws13a">len<span class="fc0">(codebytes)</span></span></span></div><div class="t m0 x15 hf y2669 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0 ls33">i<span class="fc6 ls32">&lt;</span><span class="ls0">n:</span></span></div><div class="t m0 x16 hf y266a ff8 fs5 fc0 sc0 ls0 ws159">op <span class="fc6 ls32">=</span>codebytes[i]</div><div class="t m0 x16 hf ybc ff8 fs5 fc0 sc0 ls32">i<span class="fc6 ls0 ws23d">+= <span class="fc7">1</span></span></div><div class="t m0 x16 hf y266b ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws159">op <span class="fc6 ws23d">&gt;= </span><span class="ws13a">opcode<span class="fc6">.</span>HAVE_ARGUMENT:</span></span></div><div class="t m0 x17 hf y266c ff8 fs5 fc0 sc0 ls0 ws15f">oparg <span class="fc6 ls33">=</span><span class="ws150">codebytes[i] <span class="fc6 ls32">+</span><span class="ws13a">codebytes[i<span class="fc6 ls34">+<span class="fc7">1<span class="fc0">]</span></span><span class="ls0">*<span class="fc7 ws158">256 </span><span class="ls33">+</span></span></span>extended_arg</span></span></div><div class="t m0 x17 hf y266d ff8 fs5 fc0 sc0 ls0 ws150">extended_arg <span class="fc6 ls33">=</span><span class="fc7">0</span></div><div class="t m0 x17 hf y266e ff8 fs5 fc0 sc0 ls32">i<span class="fc6 ls0 ws23d">+= <span class="fc7">2</span></span></div><div class="t m0 x17 hf y266f ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws159">op <span class="fc6">== </span><span class="ws13a">opcode<span class="fc6">.</span>EXTENDED_ARG:</span></span></div><div class="t m0 x18 hf y2670 ff8 fs5 fc0 sc0 ls0 ws150">extended_arg <span class="fc6 ls33">=</span><span class="ws15f">oparg <span class="fc6 ls32">*</span><span class="fc7">65536</span></span></div><div class="t m0 x18 h10 y2671 ff7 fs5 fca sc0 ls0">continue</div><div class="t m0 x16 hf y2672 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y2673 ff8 fs5 fc0 sc0 ls0 ws15f">oparg <span class="fc6 ls33">=</span><span class="fca">None</span></div><div class="t m0 x16 hf y2674 ff7 fs5 fca sc0 ls0 ws16a">yield <span class="ff8 fc0 ws4">(op, oparg)</span></div><div class="t m0 x0 h9 y2675 ff1 fs3 fc0 sc0 ls0">使用方法如下：</div><div class="t m0 x5 hf y2676 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">for <span class="ff8 fc0 ws13b">op, oparg </span><span class="ws157">in <span class="ff8 fc0 ws13a">generate_opcodes(countdown<span class="fc6 ls34">.</span>__code__<span class="fc6">.</span>co_code):</span></span></span></div><div class="t m0 x5 hf y2677 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws156">print<span class="ff8 fc0 ws4">(op, opcode<span class="fc6 ls34">.</span>opname[op], oparg)</span></span></div><div class="t m0 x0 h9 y2678 ff1 fs3 fc0 sc0 ls30 ws138">这种方式很少有人知道，你可以利用它替换任何你想要替换的函数的原始字节码<span class="_ _c"></span>。</div><div class="t m0 x5 h9 y2679 ff1 fs3 fc0 sc0 ls0">下面我们用一个示例来演示整个过程：</div><div class="t m0 x5 hf y3a5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca">def <span class="ff8 fcb ws13a">add<span class="fc0 ws4">(x, y):</span></span></span></div><div class="t m0 x5 hf y267a ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="fca ws146">return <span class="ff8 fc0 ls32">x<span class="fc6 ls33">+</span><span class="ls0">y</span></span></span></div><div class="t m0 x5 h10 y267b ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y835 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">c<span class="fc6 ls33">=</span><span class="ls0 ws13a">add<span class="fc6 ls34">.</span>__code__</span></span></div><div class="t m0 x5 hf y836 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">c</span></div><div class="t m0 x5 hf y837 ff8 fs5 fc8 sc0 ls0 ws4">&lt;code object add at 0x1007beed0, file &quot;&lt;stdin&gt;&quot;, line 1&gt;</div><div class="t m0 x5 hf y838 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">c<span class="fc6 ls0 ws13a">.<span class="fc0">co_code</span></span></span></div><div class="t m0 x5 hf y839 ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;<span class="ffd">|</span></span><span class="ls0 ws13a">\x00\x00<span class="ffd ws13b">|</span>\x01\x00\x17S<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf ye48 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 h11 y83a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Make a completely new code object with bogus byte code</span></div><div class="t m0 x5 h10 y83b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">types</span></span></div><div class="t m0 x5 hf y83c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws208">newbytecode <span class="fc6 ls32">=</span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13a">xxxxxxx<span class="ff9">&apos;</span></span></span></div><div class="t m0 x5 hf y83d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">nc <span class="fc6 ls33">=</span><span class="ws13a">types<span class="fc6 ls34">.</span>CodeType(c<span class="fc6 ls34">.</span><span class="ws13b">co_argcount, c<span class="fc6 ls34">.</span>co_kwonlyargcount,</span></span></span></div><div class="t m0 x5 hf y83e ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ls34">c<span class="fc6 ls0 ws13a">.<span class="fc0 ws4">co_nlocals, c</span>.<span class="fc0 ws4">co_stacksize, c</span><span class="ls34">.</span><span class="fc0 ws4">co_flags, newbytecode, c</span>.<span class="fc0">co_consts,</span></span></span></div><div class="t m0 x5 hf ycf5 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ls34">c<span class="fc6 ls0 ws13a">.<span class="fc0 ws4">co_names, c</span><span class="ls34">.</span><span class="fc0 ws4">co_varnames, c</span><span class="ls34">.</span><span class="fc0 ws13b">co_filename, c</span><span class="ls34">.</span><span class="fc0">co_name,</span></span></span></div><div class="t m0 x5 hf y83f ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ls34">c<span class="fc6 ls0 ws13a">.<span class="fc0 ws4">co_firstlineno, c</span>.<span class="fc0">co_lnotab)</span></span></span></div><div class="t m0 x5 hf y840 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">nc</span></div><div class="t m0 x5 hf y841 ff8 fs5 fc8 sc0 ls0 ws4">&lt;code object add at 0x10069fe40, file &quot;&lt;stdin&gt;&quot;, line 1&gt;</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.25.<span class="_ _5"> </span>9.25 <span class="ff1 ws16b">拆解 </span><span class="ws747">Python <span class="ff1 wscec">字节码 </span>362</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
