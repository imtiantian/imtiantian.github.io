<div id="pf23b" class="pf w0 h0" data-page-no="23b"><div class="pc pc23b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg23b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1ab ff8 fs5 fc0 sc0 ls0 ws4">PyInit_sample(void) {</div><div class="t m0 x19 hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">PyObject *m;</div><div class="t m0 x19 hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">PyObject *py_point_api;</div><div class="t m0 x19 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">m = PyModule_Create(&amp;samplemodule);</div><div class="t m0 x19 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws4">if (m == NULL)</div><div class="t m0 x15 hf y355 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y411 ff8 fs5 fc0 sc0 ls0 ws4">/* Add the Point C API functions */</div><div class="t m0 x19 hf yba ff8 fs5 fc0 sc0 ls0 ws4">py_point_api = PyCapsule_New((void *) &amp;_point_api, &quot;sample._point_api&quot;, NULL);</div><div class="t m0 x19 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws4">if (py_point_api) {</div><div class="t m0 x15 hf ybed ff8 fs5 fc0 sc0 ls0 ws13b">PyModule_AddObject(m, &quot;_point_api&quot;, py_point_api);</div><div class="t m0 x19 hf ybee ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf ybef ff8 fs5 fc0 sc0 ls0 ws4">return m;</div><div class="t m0 x5 hf ybf0 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y3714 ff1 fs3 fc0 sc0 ls0 ws14">最后，下面是一个新的扩展模块例子，用来加载并使用这些 <span class="ff4 ws1408">API </span>函数：</div><div class="t m0 x5 hf y2895 ff8 fs5 fc0 sc0 ls0 ws4">/* ptexample.c */</div><div class="t m0 x5 hf y2897 ff8 fs5 fc0 sc0 ls0 ws4">/* Include the header associated with the other module */</div><div class="t m0 x5 hf y2898 ff8 fs5 fc0 sc0 ls0 ws4">#include &quot;pysample.h&quot;</div><div class="t m0 x5 hf y289a ff8 fs5 fc0 sc0 ls0 ws4">/* An extension function that uses the exported API */</div><div class="t m0 x5 hf yfe2 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *print_point(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y3715 ff8 fs5 fc0 sc0 ls0 ws4">PyObject *obj;</div><div class="t m0 x19 hf y4fe ff8 fs5 fc0 sc0 ls0 ws4">Point *p;</div><div class="t m0 x19 hf y4ff ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args,&quot;O&quot;, &amp;obj)) {</div><div class="t m0 x15 hf y3716 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y2b49 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y3717 ff8 fs5 fc0 sc0 ls0 ws4">/* Note: This is defined in a different module */</div><div class="t m0 x19 hf y3718 ff8 fs5 fc0 sc0 ls0 ws4">p = PyPoint_AsPoint(obj);</div><div class="t m0 x19 hf y3719 ff8 fs5 fc0 sc0 ls0 ws4">if (!p) {</div><div class="t m0 x15 hf y2975 ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y371a ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y371b ff8 fs5 fc0 sc0 ls0 ws4">printf(&quot;%f %f\n&quot;, p-&gt;x, p-&gt;y);</div><div class="t m0 x19 hf y371c ff8 fs5 fc0 sc0 ls0 ws4">return Py_BuildValue(&quot;&quot;);</div><div class="t m0 x5 hf y371d ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y371e ff8 fs5 fc0 sc0 ls0 ws4">static PyMethodDef PtExampleMethods[] = {</div><div class="t m0 x19 hf y371f ff8 fs5 fc0 sc0 ls0 ws4">{&quot;print_point&quot;, print_point, METH_VARARGS, &quot;output a point&quot;},</div><div class="t m0 x19 hf y3720 ff8 fs5 fc0 sc0 ls0 ws4">{ NULL, NULL, 0, NULL}</div><div class="t m0 x5 hf y3721 ff8 fs5 fc0 sc0 ls0">};</div><div class="t m0 x5 hf y3722 ff8 fs5 fc0 sc0 ls0 ws4">static struct PyModuleDef ptexamplemodule = {</div><div class="t m0 x19 hf y3723 ff8 fs5 fc0 sc0 ls0">PyModuleDef_HEAD_INIT,</div><div class="t m0 x19 hf y30ca ff8 fs5 fc0 sc0 ls0 ws4">&quot;ptexample&quot;,<span class="_ _42"> </span>/* name of module */</div><div class="t m0 x19 hf y3724 ff8 fs5 fc0 sc0 ls0 ws4">&quot;A module that imports an API&quot;,<span class="_ _29"> </span>/* Doc string (may be NULL) */</div><div class="t m0 x19 hf y3725 ff8 fs5 fc0 sc0 ls0 ws4">-1,<span class="_ _43"> </span>/* Size of per-interpreter state or -1 */</div><div class="t m0 x19 hf y3726 ff8 fs5 fc0 sc0 ls0 ws4">PtExampleMethods<span class="_ _41"> </span>/* Method table */</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.5.<span class="_ _36"> </span>15.5 <span class="ff1 ws36c">从扩张模块中定义和导出 </span><span class="ls246">C<span class="ff1 ls81">的</span></span><span class="ws1405">API 562</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
