<div id="pf24b" class="pf w0 h0" data-page-no="24b"><div class="pc pc24b w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg24b.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0">要构建我们测试的目标模块，像下面这样做：</div><div class="t m0 x5 hf y212 ff8 fs5 fc0 sc0 ls0 ws4">bash % python3 setup.py build_ext --inplace</div><div class="t m0 x5 hf y213 ff8 fs5 fc0 sc0 ls0 ws4">running build_ext</div><div class="t m0 x5 hf y214 ff8 fs5 fc0 sc0 ls0 ws4">cythoning sample.pyx to sample.c</div><div class="t m0 x5 hf y215 ff8 fs5 fc0 sc0 ls0 ws16d">building <span class="ff9 ws13b">&apos;</span><span class="ws13a">sample<span class="ff9 ls32">&apos;</span>extension</span></div><div class="t m0 x5 hf y216 ff8 fs5 fc0 sc0 ls0 ws4">gcc -fno-strict-aliasing -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes</div><div class="t m0 x4b hf y217 ff8 fs5 fc0 sc0 ls0 ws13b">-I/usr/local/include/python3.3m -c sample.c</div><div class="t m0 x4b hf y218 ff8 fs5 fc0 sc0 ls0 ws13b">-o build/temp.macosx-10.6-x86_64-3.3/sample.o</div><div class="t m0 x5 hf y16b0 ff8 fs5 fc0 sc0 ls0 ws4">gcc -bundle -undefined dynamic_lookup build/temp.macosx-10.6-x86_64-3.3/sample.o</div><div class="t m0 x19 hf y16b1 ff8 fs5 fc0 sc0 ls0 ws4">-L. -lsample -o sample.so</div><div class="t m0 x5 hf y16b2 ff8 fs5 fc0 sc0 ls0 ws4">bash %</div><div class="t m0 x0 h9 y3864 ff1 fs3 fc0 sc0 ls0 ws14">如果一切顺利的话，你应该有了一个扩展模块 <span class="ff6 ws1d1">sample.so </span>，可在下面例子中使用：</div><div class="t m0 x5 h10 y3865 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">sample</span></span></div><div class="t m0 x5 hf y3866 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>gcd(<span class="fc7">42</span><span class="ls34">,</span><span class="fc7">10</span>)</span></div><div class="t m0 x5 hf y3867 ff8 fs5 fc8 sc0 ls0">2</div><div class="t m0 x5 hf y3868 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>in_mandel(<span class="fc7 ls34">1<span class="fc0">,</span><span class="ls0">1</span><span class="fc0">,</span><span class="ls0">400</span></span>)</span></div><div class="t m0 x5 hf y322c ff8 fs5 fc8 sc0 ls0">False</div><div class="t m0 x5 hf y69a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>in_mandel(<span class="fc7 ls34">0<span class="fc0">,</span><span class="ls0">0</span><span class="fc0">,</span><span class="ls0">400</span></span>)</span></div><div class="t m0 x5 hf y1412 ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y3869 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>divide(<span class="fc7">42</span>,<span class="fc7">10</span>)</span></div><div class="t m0 x5 hf y386a ff8 fs5 fc8 sc0 ls0 ws4">(4, 2)</div><div class="t m0 x5 h10 y386b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">array</span></span></div><div class="t m0 x5 hf y386c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">a<span class="fc6 ls33">=</span><span class="ls0 ws13a">array<span class="fc6 ls34">.</span>array(<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">d<span class="ff9">&apos;</span></span></span>,[<span class="fc7 ls34">1<span class="fc0">,</span><span class="ls0">2</span><span class="fc0">,</span>3</span>])</span></span></div><div class="t m0 x5 hf y386d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>avg(a)</span></div><div class="t m0 x5 hf y386e ff8 fs5 fc8 sc0 ls0">2.0</div><div class="t m0 x5 hf y386f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p1 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">2</span>,<span class="fc7 ls34">3</span>)</span></span></div><div class="t m0 x5 hf y3870 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws159">p2 <span class="fc6 ls33">=</span><span class="ws13a">sample<span class="fc6 ls34">.</span>Point(<span class="fc7 ls34">4</span>,<span class="fc7 ls34">5</span>)</span></span></div><div class="t m0 x5 hf y3871 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">p1</span></div><div class="t m0 x5 hf y3872 ff8 fs5 fc8 sc0 ls0 ws4">&lt;capsule object &quot;Point&quot; at 0x1005d1e70&gt;</div><div class="t m0 x5 hf y3873 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">p2</span></div><div class="t m0 x5 hf y3874 ff8 fs5 fc8 sc0 ls0 ws4">&lt;capsule object &quot;Point&quot; at 0x1005d1ea0&gt;</div><div class="t m0 x5 hf y3875 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">sample<span class="fc6 ls34">.</span>distance(p1,p2)</span></div><div class="t m0 x5 hf y3876 ff8 fs5 fc8 sc0 ls0">2.8284271247461903</div><div class="t m0 x5 hf y3877 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y3878 ff2 fs2 fc4 sc0 ls0 wsadf">17.10.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y3879 ff1 fs3 fc0 sc0 ls22 ws14b5">本节包含了很多前面所讲的高级特性，包括数组操作<span class="_ _c"></span>、包装隐形指针和释放 <span class="ff4 ls0 wsa5">GIL<span class="ff1">。</span></span></div><div class="t m0 x5 h9 y387a ff1 fs3 fc0 sc0 ls0 wsa0">每<span class="_ _0"></span>一<span class="_ _6"></span>部<span class="_ _0"></span>分<span class="_ _0"></span>都<span class="_ _0"></span>会<span class="_ _6"></span>逐<span class="_ _0"></span>个<span class="_ _0"></span>被<span class="_ _0"></span>讲<span class="_ _6"></span>述<span class="_ _0"></span>到，<span class="_ _0"></span>但<span class="_ _0"></span>是<span class="_ _6"></span>我<span class="_ _0"></span>们<span class="_ _0"></span>最<span class="_ _0"></span>好<span class="_ _6"></span>能<span class="_ _0"></span>复<span class="_ _0"></span>习<span class="_ _0"></span>一<span class="_ _6"></span>下<span class="_ _0"></span>前<span class="_ _0"></span>面<span class="_ _0"></span>几<span class="_ _6"></span>小<span class="_ _0"></span>节。<span class="_ _0"></span>在<span class="_ _0"></span>顶<span class="_ _6"></span>层，<span class="_ _0"></span>使<span class="_ _0"></span>用</div><div class="t m0 x5 h7 y387b ff4 fs3 fc0 sc0 ls0 ws14b6">Cython <span class="ff1 ls18 ws144b">是基于 </span><span class="ls245">C</span><span class="ff1 wsa0">之上。</span><span class="ws14b7">.pxd <span class="ff1 ls18 ws14b8">文件仅仅只包含 </span><span class="ls245">C</span><span class="ff1 wsa0">定义（类似</span><span class="ws14b9">.h <span class="ff1 wsa0">文<span class="_ _6"></span>件）<span class="_ _f"></span>，<span class="ff4 ws14ba">.pyx </span><span class="ls18 ws110">文件包含<span class="_ _1"></span></span></span></span></span></div><div class="t m0 x5 h7 y387c ff1 fs3 fc0 sc0 ls0 wsa0">了实现（类似<span class="ff4 ws14bb">.c </span>文件）<span class="_ _f"></span>。<span class="ff6 ws23a">cimport </span><span class="ws38">语句被 <span class="ff4 ws14bc">Cython </span></span>用来导入<span class="ff4 ws14bd">.p<span class="_ _1"></span>xd <span class="ff1">文件中的定义。它跟使</span></span></div><div class="t m0 x5 h7 ye3 ff1 fs3 fc0 sc0 ls0 ws14">用普通的加载 <span class="ff4 ws5c">Python </span>模块的导入语句是不同的。</div><div class="t m0 x0 h9 y387d ff1 fs3 fc0 sc0 ls0 wsc0e">尽<span class="_ _6"></span>管 <span class="ff13 ws14be">.pxd </span><span class="ls13 wse5">文件包含了定义<span class="_ _c"></span>，但它们并不是用来自动创建扩展代码的。因此<span class="_ _c"></span>，你还</span></div><div class="t m0 x5 h9 y387e ff1 fs3 fc0 sc0 ls1f ws14bf">是要写包装函数。例如，就算 <span class="ff6 ls0 ws14c0">csample.pxd </span><span class="ws14c1">文件声明了 <span class="ff6 ls0 ws14c2">int<span class="_ _26"> </span>gcd(int,<span class="_ _11"> </span>int) <span class="ff1 wsa0">函数，你</span></span></span></div><div class="t m0 x5 h9 y387f ff1 fs3 fc0 sc0 ls0 ws38">仍然需要在 <span class="ff6 ws17c">sample.pyx </span>中为它写一个包装函数。例如：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.10.<span class="_ _36"> </span>15.10 <span class="ff1 ls7f">用</span><span class="ws747">Cython <span class="ff1 ws16b">包装 </span><span class="ls246">C</span><span class="ff1 ws14a7">代码 </span>578</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
