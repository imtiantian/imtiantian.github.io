<div id="pf242" class="pf w0 h0" data-page-no="242"><div class="pc pc242 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg242.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x19 hf y334 ff8 fs5 fc0 sc0 ls0 ws4">return retval;</div><div class="t m0 x5 hf y336 ff8 fs5 fc0 sc0 ls0">fail:</div><div class="t m0 x19 hf y337 ff8 fs5 fc0 sc0 ls0">PyGILState_Release(state);</div><div class="t m0 x19 hf yadd ff8 fs5 fc0 sc0 ls0">abort();</div><div class="t m0 x5 hf yade ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y1b1 ff1 fs3 fc0 sc0 ls0 wsa0">一旦<span class="_ _6"></span>返回，<span class="_ _6"></span><span class="ff6 ws1436">PyGILState Ensure() </span><span class="ws1437">可<span class="_ _6"></span>以确保<span class="_ _6"></span>调用<span class="_ _6"></span>线程<span class="_ _6"></span>独占 <span class="ff4 ws4b8">Python </span><span class="ws1438">解<span class="_ _6"></span>释器。<span class="_ _6"></span>就算 <span class="ff4">C</span></span></span></div><div class="t m0 x5 h7 y1b2 ff1 fs3 fc0 sc0 ls0 wsa0">代码<span class="_ _6"></span>运<span class="_ _6"></span>行<span class="_ _6"></span>于<span class="_ _6"></span>另外<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>解释<span class="_ _6"></span>器<span class="_ _6"></span>不<span class="_ _6"></span>知道<span class="_ _6"></span>的<span class="_ _6"></span>线<span class="_ _6"></span>程也<span class="_ _6"></span>没<span class="_ _6"></span>事。<span class="_ _6"></span>这时<span class="_ _6"></span>候，<span class="_ _6"></span><span class="ff4 ls1d1">C</span>代<span class="_ _6"></span>码<span class="_ _6"></span>可以<span class="_ _6"></span>自<span class="_ _6"></span>由<span class="_ _6"></span>的使<span class="_ _6"></span>用<span class="_ _6"></span>任</div><div class="t m0 x5 h7 y1cc ff1 fs3 fc0 sc0 ls35 ws238">何它想要的 <span class="ff4 ls0 ws757">Python C-API <span class="ff1 wsa0">函数。调用成功后，<span class="_ _6"></span></span><span class="ws1439">PyGILState<span class="_ _16"> </span>Release() </span></span><span class="ws144">被用来讲解释器</span></div><div class="t m0 x5 h9 y1cd ff1 fs3 fc0 sc0 ls0">恢复到原始状态。</div><div class="t m0 x0 h9 y37a1 ff1 fs3 fc0 sc0 ls0 ws143a">要 注 意 的 是 每 一 个<span class="_ _27"> </span><span class="ff6 ws65d">PyGILState Ensure()<span class="_ _27"> </span></span><span class="ls26e ws143b">调用必须跟着一个匹配的<span class="_ _48"></span></span></div><div class="t m0 x5 h9 y37a2 ff6 fs3 fc0 sc0 ls0 ws65d">PyGILState Release()<span class="_ _b"> </span><span class="ff1 ws143c">调<span class="_ _0"></span>用<span class="_ _12"></span>—<span class="_ _8"></span>—<span class="_ _0"></span>即<span class="_ _0"></span>便<span class="_ _12"></span>有<span class="_ _0"></span>错<span class="_ _0"></span>误<span class="_ _0"></span>发<span class="_ _12"></span>生。<span class="_ _0"></span>在<span class="_ _0"></span>这<span class="_ _12"></span>里，<span class="_ _0"></span>我<span class="_ _0"></span>们<span class="_ _0"></span>使<span class="_ _12"></span>用<span class="_ _0"></span>一<span class="_ _0"></span>个 <span class="ff6 ws69d">goto </span>语</span></div><div class="t m0 x5 h7 y37a3 ff1 fs3 fc0 sc0 ls0 ws143d">句<span class="_ _6"></span>看上<span class="_ _6"></span>去<span class="_ _6"></span>是<span class="_ _6"></span>个<span class="_ _6"></span>可<span class="_ _6"></span>怕<span class="_ _6"></span>的<span class="_ _6"></span>设计，<span class="_ _6"></span>但<span class="_ _6"></span>是<span class="_ _6"></span>实<span class="_ _6"></span>际<span class="_ _6"></span>上<span class="_ _6"></span>我<span class="_ _6"></span>们使<span class="_ _6"></span>用<span class="_ _6"></span>它<span class="_ _6"></span>来<span class="_ _6"></span>讲<span class="_ _6"></span>控<span class="_ _6"></span>制<span class="_ _6"></span>权转<span class="_ _6"></span>移<span class="_ _6"></span>给<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>普<span class="_ _6"></span>通的 <span class="ff4">exit</span></div><div class="t m0 x5 h7 y37a4 ff1 fs3 fc0 sc0 ls13 ws143e">块来执行相应的操作<span class="_ _1"></span>。在 <span class="ff6 ls0 ws143f">fail: </span><span class="ws1440">标签后面的代码和 <span class="ff4 ls0 wsa18">Python </span><span class="ls92">的<span class="ff6 ls0 ws1441">fianl: <span class="ff1 wsa0">块<span class="_ _6"></span>的<span class="_ _6"></span>用<span class="_ _6"></span>途是<span class="_ _6"></span>一</span></span></span></span></div><div class="t m0 x5 h9 yc8a ff1 fs3 fc0 sc0 ls0">样的。</div><div class="t m0 x0 h7 y37a5 ff1 fs3 fc0 sc0 ls3d ws1442">如果你使用所有这些约定来编写 <span class="ff4 ls205">C</span><span class="ws1443">代码，包括对 <span class="ff4 ls0 ws1444">GIL </span><span class="ws164">的管理<span class="_ _1"></span>、异常检查和错误检</span></span></div><div class="t m0 x5 h7 y37a6 ff1 fs3 fc0 sc0 ls2d ws1445">查<span class="_ _1"></span>，你会发现从 <span class="ff4 ls25f">C</span><span class="ws1446">语言中调用 <span class="ff4 ls0 ws1447">Python </span><span class="ws132">解释器是可靠的—<span class="_ _19"></span>—就算再复杂的程序，用到<span class="_ _c"></span></span></span></div><div class="t m0 x5 h9 y37a7 ff1 fs3 fc0 sc0 ls0">了高级编程技巧比如多线程都没问题。</div><div class="t m0 x5 hd y3388 ff2 fs4 fc4 sc0 ls0 ws211">17.7<span class="_ _e"> </span>15.7 <span class="ff1 lsac">从</span><span class="ls23d">C</span><span class="ff1">扩展中释放全局锁</span></div><div class="t m0 x5 he y37a8 ff2 fs2 fc4 sc0 ls0 ws212">17.7.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y37a9 ff1 fs3 fc0 sc0 ls0 wsfb5">你想让 <span class="ff4 ls204">C</span>扩展代码和 <span class="ff4 ws1369">Python </span><span class="wsa0">解释器中的其他进程一起正确的执行，那么你就需要</span></div><div class="t m0 x5 h7 y37aa ff1 fs3 fc0 sc0 ls0 wsa0">去释放并重新获取全局解释器锁（<span class="ff4 wsa5">GIL</span>）<span class="_ _f"></span>。</div><div class="t m0 x5 he y37ab ff2 fs2 fc4 sc0 ls0 ws212">17.7.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y2e35 ff1 fs3 fc0 sc0 ls4">在<span class="ff4 ls8">C</span><span class="ls0 wsa0">扩展代码中，<span class="ff4 ws1448">GIL </span>可以通过在代码中插入下面这样的宏来释放和重新获取：</span></div><div class="t m0 x5 hf y37ac ff8 fs5 fc0 sc0 ls0 ws4">#include &quot;Python.h&quot;</div><div class="t m0 x5 hf y37ad ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x5 hf y37ae ff8 fs5 fc0 sc0 ls0 ws4">PyObject *pyfunc(PyObject *self, PyObject *args) {</div><div class="t m0 x3c hf y37af ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x3c hf y37b0 ff8 fs5 fc0 sc0 ls0">Py_BEGIN_ALLOW_THREADS</div><div class="t m0 x3c hf y37b1 ff8 fs5 fc0 sc0 ls0 ws4">// Threaded C code.<span class="_ _29"> </span>Must not use Python API functions</div><div class="t m0 x3c hf y37b2 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x3c hf y37b3 ff8 fs5 fc0 sc0 ls0">Py_END_ALLOW_THREADS</div><div class="t m0 x3c hf y37b4 ff8 fs5 fc0 sc0 ls0">...</div><div class="t m0 x3c hf y37b5 ff8 fs5 fc0 sc0 ls0 ws4">return result;</div><div class="t m0 x5 hf y37b6 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">17.7.<span class="_ _36"> </span>15.7 <span class="ff1 ls81">从</span><span class="ls260">C</span><span class="ff1 ws1449">扩展中释放全局锁 </span>569</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
