<div id="pf1ab" class="pf w0 h0" data-page-no="1ab"><div class="pc pc1ab w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ab.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 ws211">13.8<span class="_ _e"> </span>11.8 <span class="ff1">实现远程方法调用</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 ws212">13.8.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y658 ff1 fs3 fc0 sc0 ls0 ws260">你想在一个消息传输层如 <span class="ff6 wsf77">sockets </span><span class="wsa0">、<span class="ff6 wsf78">multiprocessing<span class="_ _1e"> </span>connections </span><span class="ls55">或</span><span class="ff6 wsf79">ZeroMQ </span>的</span></div><div class="t m0 x5 h7 y659 ff1 fs3 fc0 sc0 ls0 wsa0">基础之上实现一个简单的远程过程调用（<span class="ff4 wsa5">RPC</span>）<span class="_ _f"></span>。</div><div class="t m0 x5 he y18fe ff2 fs2 fc4 sc0 ls0 ws212">13.8.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y18bb ff1 fs3 fc0 sc0 ls0 wsf7a">将函数请求、参数和返回值使用 <span class="ff4 wsf7b">pic<span class="_ _c"></span>kle <span class="ff1 wsbf4">编码后，在不同的解释器直接传送 </span><span class="wsf7c">pic<span class="_ _c"></span>kle <span class="ff1">字</span></span></span></div><div class="t m0 x5 h7 y18bc ff1 fs3 fc0 sc0 ls30 wsf7d">节字符串，可以很容易的实现 <span class="ff4 ls0 wsa5">RPC</span><span class="wsb9c">。下面是一个简单的 <span class="ff4 ls0 wsf7e">PR<span class="_ _c"></span>C <span class="ff1 wsa0">处<span class="_ _6"></span>理器，<span class="_ _6"></span>可<span class="_ _6"></span>以被<span class="_ _6"></span>整<span class="_ _6"></span>合到</span></span></span></div><div class="t m0 x5 h9 y18bd ff1 fs3 fc0 sc0 ls0">一个服务器中去：</div><div class="t m0 x5 h11 y2b7c ffa fs5 fcd sc0 ls0 ws4"># rpcserver.py</div><div class="t m0 x5 h10 y2b7d ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">pickle</span></div><div class="t m0 x5 hf y2b7e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">RPCHandler<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y2b7f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y2b80 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws2a3">_functions </span><span class="ls33">=</span><span class="fc0 ws13b">{ }</span></span></div><div class="t m0 x15 hf yfce ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">register_function<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, func):</span></span></span></div><div class="t m0 x16 hf y2b81 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_functions[func</span><span class="ls34">.</span><span class="fc0 ws16e">__name__] </span><span class="ls33">=</span><span class="fc0">func</span></span></div><div class="t m0 x15 hf y2b82 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handle_connection<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, connection):</span></span></span></div><div class="t m0 x16 hf y2b83 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf y2b84 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x18 h11 y2b85 ffa fs5 fcd sc0 ls0 ws4"># Receive a message</div><div class="t m0 x18 hf y2b86 ff8 fs5 fc0 sc0 ls0 ws13b">func_name, args, kwargs <span class="fc6 ls33">=</span><span class="ws13a">pickle<span class="fc6 ls34">.</span>loads(connection<span class="fc6 ls34">.</span>recv())</span></div><div class="t m0 x18 h11 y2b87 ffa fs5 fcd sc0 ls0 ws4"># Run the RPC and send a response</div><div class="t m0 x18 hf y2b88 ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x29 hf y2b89 ff8 fs5 fc0 sc0 ls32">r<span class="fc6">=<span class="fca ls0 ws13a">self</span><span class="ls34">.</span></span><span class="ls0 ws13a">_functions[func_name](<span class="fc6 ls34">*</span>args,<span class="fc6 ls34">**</span>kwargs)</span></div><div class="t m0 x29 hf y2b8a ff8 fs5 fc0 sc0 ls0 ws13a">connection<span class="fc6 ls34">.</span>send(pickle<span class="fc6">.</span>dumps(r))</div><div class="t m0 x18 hf y2b8b ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws16e">Exception </span><span class="ws157">as <span class="ff8 fc0">e:</span></span></div><div class="t m0 x29 hf y2b8c ff8 fs5 fc0 sc0 ls0 ws13a">connection<span class="fc6 ls34">.</span>send(pickle<span class="fc6">.</span>dumps(e))</div><div class="t m0 x16 hf y2b8d ff7 fs5 fca sc0 ls0 ws146">except <span class="ff8 ws13a">EOFError<span class="fc0">:</span></span></div><div class="t m0 x3d h10 y2b8e ff7 fs5 fca sc0 ls0">pass</div><div class="t m0 x0 h9 y2b8f ff1 fs3 fc0 sc0 ls0 wsa0">要使用这个处理器，你<span class="_ _6"></span>需要将它加入到一个消息<span class="_ _6"></span>服务器中。你有很多种选<span class="_ _6"></span>择，但是</div><div class="t m0 x5 h7 y2b90 ff1 fs3 fc0 sc0 ls0 ws14">使用 <span class="ff6 ws4f7">multiprocessing </span>库是最简单的。下面是一个 <span class="ff4 wsf7f">RPC </span>服务器例子：</div><div class="t m0 x5 hf y2b91 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc wsf5c">multiprocessing.connection </span><span class="ws146">import <span class="ff8 fc0">Listener</span></span></div><div class="t m0 x5 hf y2b92 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">threading </span><span class="ws146">import <span class="ff8 fc0">Thread</span></span></div><div class="t m0 x5 hf y2b93 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">rpc_server<span class="fc0 ws4">(handler, address, authkey):</span></span></div><div class="t m0 x15 hf y2b94 ff8 fs5 fc0 sc0 ls0 ws13c">sock <span class="fc6 ls32">=</span><span class="ws4">Listener(address, authkey<span class="fc6 ls34">=</span>authkey)</span></div><div class="t m0 x15 hf y2b95 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y2b96 ff8 fs5 fc0 sc0 ls0 ws145">client <span class="fc6 ls32">=</span><span class="ws13a">sock<span class="fc6 ls34">.</span>accept()</span></div><div class="t m0 x16 hf y2b97 ff8 fs5 fc0 sc0 ls32">t<span class="fc6 ls33">=</span><span class="ls0 ws13a">Thread(target<span class="fc6 ls34">=</span>handler<span class="fc6 ls34">.</span><span class="ws13b">handle_connection, args<span class="fc6 ls34">=</span>(client,))</span></span></div><div class="t m0 x16 hf y2b98 ff8 fs5 fc0 sc0 ls34">t<span class="fc6 ls0 ws13a">.</span><span class="ls0 ws145">daemon <span class="fc6 ls33">=</span><span class="fca">True</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">13.8.<span class="_ _5"> </span>11.8 <span class="ff1 ws533">实现远程方法调用 </span>418</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
