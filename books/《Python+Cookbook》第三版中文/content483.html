<div id="pf1e3" class="pf w0 h0" data-page-no="1e3"><div class="pc pc1e3 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1e3.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws4">send((func, args, kwargs, r))</span></span></div><div class="t m0 x16 hf y1ac ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">r</span></div><div class="t m0 x15 hf y1ae ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">run<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1af ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws4">func, args, kwargs, r <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span></span>recv()</div><div class="t m0 x17 hf y355 ff8 fs5 fc0 sc0 ls0 ws13a">r<span class="fc6 ls34">.</span>set_result(func(<span class="fc6 ls34">*</span><span class="ws15f">args, </span><span class="fc6">**</span>kwargs))</div><div class="t m0 x5 h11 y411 ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 hf yba ff8 fs5 fc0 sc0 ls0 ws145">worker <span class="fc6 ls33">=</span>Worker()</div><div class="t m0 x5 hf y8c6 ff8 fs5 fc0 sc0 ls0 ws13a">worker<span class="fc6 ls34">.</span>start()</div><div class="t m0 x5 hf ybed ff8 fs5 fc0 sc0 ls32">r<span class="fc6 ls33">=</span><span class="ls0 ws13a">worker<span class="fc6 ls34">.</span>submit(<span class="fca">pow</span><span class="ls33">,</span><span class="fc7">2</span><span class="ls33">,<span class="fc7 ls34">3</span></span>)</span></div><div class="t m0 x5 hf ybee ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(r<span class="fc6 ls34">.</span>result())</span></div><div class="t m0 x0 h9 y3025 ff1 fs3 fc0 sc0 ls30 ws138">最后，<span class="_ _3b"></span>“发送<span class="_ _c"></span>”一个任务消息的概念可以被扩展到多进程甚至是大型分布式系统中</div><div class="t m0 x5 h7 y3026 ff1 fs3 fc0 sc0 ls0 ws117c">去。例如，一<span class="_ _6"></span>个类 <span class="ff4 ws1173">actor </span><span class="ws117d">对象的 <span class="ff6 ws8c5">send() </span><span class="ls68 ws23f">方法可以被编程让它能在一个套接字连接上传</span></span></div><div class="t m0 x5 h7 y3027 ff1 fs3 fc0 sc0 ls0 ws14">输数据或通过某些消息中间件（比如 <span class="ff4 wsa5">AMQP</span><span class="lsb">、</span><span class="ff4 ws117e">ZMQ </span>等）来发送。</div><div class="t m0 x5 hd y3028 ff2 fs4 fc4 sc0 ls0 wsd91">14.11<span class="_ _e"> </span>12.11 <span class="ff1 ws117f">实现消息发布</span><span class="ls198">/</span><span class="ff1">订阅模型</span></div><div class="t m0 x5 he y3029 ff2 fs2 fc4 sc0 ls0 wsadf">14.11.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y302a ff1 fs3 fc0 sc0 ls0 wsa0">你有一个基于线程通信的程序，想让它们实现发布<span class="ff4 ls6">/</span>订阅模式的消息通信。</div><div class="t m0 x5 he y302b ff2 fs2 fc4 sc0 ls0 wsadf">14.11.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y1351 ff1 fs3 fc0 sc0 ls0 wsa0">要实现发布<span class="ff4 ls6">/</span>订阅的消息通信模式，你通常要引入一个单独的“交换机”或“网关”</div><div class="t m0 x5 h9 y1352 ff1 fs3 fc0 sc0 ls0 wsa0">对<span class="_ _6"></span>象作<span class="_ _6"></span>为<span class="_ _6"></span>所<span class="_ _6"></span>有<span class="_ _6"></span>消<span class="_ _6"></span>息的<span class="_ _6"></span>中<span class="_ _6"></span>介。<span class="_ _6"></span>也<span class="_ _6"></span>就<span class="_ _6"></span>是说，<span class="_ _6"></span>不<span class="_ _6"></span>直<span class="_ _6"></span>接<span class="_ _6"></span>将<span class="_ _6"></span>消<span class="_ _6"></span>息从<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>任<span class="_ _6"></span>务<span class="_ _6"></span>发送<span class="_ _6"></span>到<span class="_ _6"></span>另<span class="_ _6"></span>一<span class="_ _6"></span>个，<span class="_ _6"></span>而是</div><div class="t m0 x5 h9 y302c ff1 fs3 fc0 sc0 ls13 wse5">将其发送给交换机<span class="_ _1"></span>，然后由交换机将它发送给一个或多个被关联任务。下面是一个非<span class="_ _c"></span></div><div class="t m0 x5 h9 y302d ff1 fs3 fc0 sc0 ls0">常简单的交换机实现例子：</div><div class="t m0 x5 hf y246c ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">collections </span><span class="ws146">import <span class="ff8 fc0">defaultdict</span></span></div><div class="t m0 x5 hf y246e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Exchange<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y246f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y2470 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws3c7">_subscribers </span><span class="ls32">=</span></span>set<span class="fc0">()</span></div><div class="t m0 x15 hf y2472 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">attach<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, task):</span></span></span></div><div class="t m0 x16 hf y1d84 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_subscribers</span><span class="ls34">.</span><span class="fc0">add(task)</span></span></div><div class="t m0 x15 hf y1b7e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">detach<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, task):</span></span></span></div><div class="t m0 x16 hf y32e ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_subscribers</span><span class="ls34">.</span><span class="fc0">remove(task)</span></span></div><div class="t m0 x15 hf y330 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">send<span class="fc0">(<span class="fca">self</span><span class="ws4">, msg):</span></span></span></div><div class="t m0 x16 hf y331 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws2a3">subscriber </span><span class="ws157">in <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_subscribers:</span></span></span></div><div class="t m0 x17 hf y332 ff8 fs5 fc0 sc0 ls0 ws13a">subscriber<span class="fc6 ls34">.</span>send(msg)</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.11.<span class="_ _36"> </span>12.11 <span class="ff1 wsa0">实现消息发布</span><span class="ls20f">/</span><span class="ff1 ws1180">订阅模型 </span>474</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
