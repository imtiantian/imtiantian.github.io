<div id="pf15f" class="pf w0 h0" data-page-no="15f"><div class="pc pc15f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg15f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 hf y1ab ff8 fs5 fc0 sc0 ls0 ws1f5">cls_dict <span class="fc6 ls33">=</span><span class="ws13b">{ name: <span class="fca ws13a">property<span class="fc0">(operator<span class="fc6 ls34">.</span>itemgetter(n))</span></span></span></div><div class="t m0 x18 hf y1ac ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">n, name </span><span class="ws160">in <span class="ff8 ws13a">enumerate<span class="fc0 ws4">(fieldnames) }</span></span></span></div><div class="t m0 x15 h11 y1ae ffa fs5 fcd sc0 ls0 ws4"># Make a __new__ function and add to the class dict</div><div class="t m0 x15 hf y1af ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__new__<span class="fc0 ws15f">(cls, <span class="fc6 ls34">*</span>args):</span></span></div><div class="t m0 x16 hf y1b0 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">len<span class="fc0 ws145">(args) <span class="fc6 ws159">!= </span></span>len<span class="fc0">(fieldnames):</span></span></div><div class="t m0 x17 hf y355 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Expected {} arguments<span class="ff9 ls34">&apos;<span class="ff8 fc6">.</span></span></span>format(</span>len<span class="fc0">(fieldnames)))</span></span></div><div class="t m0 x16 hf y410 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">tuple<span class="fc6">.<span class="fc0 ws4">__new__(cls, args)</span></span></span></div><div class="t m0 x15 hf yba ff8 fs5 fc0 sc0 ls0 ws13a">cls_dict[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">__new__<span class="ff9 ls34">&apos;</span></span><span class="ls32">]<span class="fc6 ls33">=</span></span>__new__</div><div class="t m0 x15 h11 ybed ffa fs5 fcd sc0 ls0 ws4"># Make the class</div><div class="t m0 x15 hf ybee ff8 fs5 fc0 sc0 ls0 ws158">cls <span class="fc6 ls32">=</span><span class="ws13a">types<span class="fc6 ls34">.</span><span class="ws13b">new_class(classname, (</span><span class="fca">tuple</span><span class="ws4">,), {},</span></span></div><div class="t m0 x24 hf ybef ff7 fs5 fca sc0 ls0 ws1ff">lambda <span class="ff8 fc0 ws13b">ns: ns<span class="fc6 ls34">.</span>update(cls_dict))</span></div><div class="t m0 x15 h11 yd7d ffa fs5 fcd sc0 ls0 ws4"># Set the module to that of the caller</div><div class="t m0 x15 hf ybf1 ff8 fs5 fc0 sc0 ls0 ws13a">cls<span class="fc6 ls34">.</span><span class="ws2a3">__module__ <span class="fc6 ls32">=</span></span>sys<span class="fc6 ls34">.</span>_getframe(<span class="fc7 ls34">1<span class="fc0">)<span class="fc6">.</span></span></span>f_globals[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">__name__<span class="ff9 ls34">&apos;</span></span>]</div><div class="t m0 x15 hf ybf2 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">cls</span></div><div class="t m0 x0 h7 y24ba ff1 fs3 fc0 sc0 ls24 ws11d">这段代码的最后部分使用了一个所谓的<span class="_ _1"></span><span class="ff4 ls1a1">”<span class="ff1 ls24">框架魔法<span class="_ _c"></span><span class="ff4 ls0 wsa5">”<span class="ff1 wsc74">，<span class="_ _0"></span>通<span class="_ _6"></span>过<span class="_ _6"></span>调<span class="_ _6"></span>用 <span class="ff6 ws3e1">sys. getframe()</span></span></span></span></span></div><div class="t m0 x5 h7 y24bb ff1 fs3 fc0 sc0 ls0 ws14">来获取调用者的模块名。另外一个框架魔法例子在 <span class="ff4 ws1d0">2.15 </span>小节中有介绍过。</div><div class="t m0 x0 h9 y24bc ff1 fs3 fc0 sc0 ls0">下面的例子演示了前面的代码是如何工作的：</div><div class="t m0 x5 hf y24bd ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">Point <span class="fc6 ls33">=</span><span class="ws13a">named_tuple(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Point<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, [<span class="ff9 fc9">&apos;<span class="ff8 ls34">x<span class="ff9">&apos;</span></span></span><span class="ls32">,<span class="ff9 fc9 ls34">&apos;<span class="ff8">y</span>&apos;</span></span>])</span></span></span></div><div class="t m0 x5 hf y24be ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">Point</span></div><div class="t m0 x5 hf y24bf ff8 fs5 fc8 sc0 ls0 ws145">&lt;class <span class="ff9 ls34">&apos;</span><span class="ws13a">__main__.Point<span class="ff9 ls34">&apos;</span>&gt;</span></div><div class="t m0 x5 hf y24c0 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">p<span class="fc6 ls33">=</span><span class="ls0 ws13a">Point(<span class="fc7 ls34">4</span></span>,<span class="fc7 ls34">5</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf yd9f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fca ws13a">len<span class="fc0">(p)</span></span></div><div class="t m0 x5 hf y24c1 ff8 fs5 fc8 sc0 ls0">2</div><div class="t m0 x5 hf y24c2 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">p<span class="fc6 ls0 ws13a">.<span class="fc0">x</span></span></span></div><div class="t m0 x5 hf y24c3 ff8 fs5 fc8 sc0 ls0">4</div><div class="t m0 x5 hf y24c4 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">p<span class="fc6 ls0 ws13a">.<span class="fc0">y</span></span></span></div><div class="t m0 x5 hf y24c5 ff8 fs5 fc8 sc0 ls0">5</div><div class="t m0 x5 hf y12e9 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">p<span class="fc6 ls0 ws13a">.</span><span class="ls33">x<span class="fc6 ls32">=<span class="fc7 ls0">2</span></span></span></span></div><div class="t m0 x5 hf yad3 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf yad4 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x5 hf yad5 ff8 fs5 fc2 sc0 ls0 ws13a">AttributeError<span class="fc0 ws4">: can<span class="ff9 ls34">&apos;</span><span class="ws13b">t set attribute</span></span></div><div class="t m0 x5 hf yad6 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="ffa fcf ws159">%s %s<span class="ff9 fc9 ls32">&apos;</span></span><span class="fc6 ls33">%</span>p)</span></span></div><div class="t m0 x5 hf yad7 ff8 fs5 fc8 sc0 ls0 ws4">4 5</div><div class="t m0 x5 hf y24c6 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y24c7 ff1 fs3 fc0 sc0 ls3a ws153">这项技术一个很重要的方面是它对于元类的正确使用。你可能像通过直接实例化一</div><div class="t m0 x5 h9 y24c8 ff1 fs3 fc0 sc0 ls0">个元类来直接创建一个类：</div><div class="t m0 x5 hf y24c9 ff8 fs5 fc0 sc0 ls0 ws15f">Stock <span class="fc6 ls33">=</span><span class="fca ws13a">type<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">Stock<span class="ff9 ls34">&apos;</span></span><span class="ws13b">, (), cls_dict)</span></span></span></div><div class="t m0 x0 h9 y24ca ff1 fs3 fc0 sc0 ls19 wsc75">这种方法的问题在于它忽略了一些关键步骤，比如对于元类中 <span class="ff6 ls0 ws3db">prepare<span class="_ _e"> </span>() <span class="ff1 wsa0">方法</span></span></div><div class="t m0 x5 h9 y24cb ff1 fs3 fc0 sc0 ls0 wsc76">的调<span class="_ _6"></span>用。<span class="_ _6"></span>通过<span class="_ _6"></span>使<span class="_ _6"></span>用 <span class="ff6 ws4a4">types.new class() </span><span class="ls6b ws28f">，你可以保证所有的必要初始化步骤都能得到</span></div><div class="t m0 x5 h9 y24cc ff1 fs3 fc0 sc0 ls0 wsa0">执行。比如，<span class="ff6 ws3f6">types.new<span class="_ _7"> </span>class() </span><span class="ls82 wsc77">第四个参数的回调函数接受 </span><span class="ff6 wsc78">prepare<span class="_ _e"> </span>() </span>方法返<span class="_ _6"></span>回</div><div class="t m0 x5 h9 y24cd ff1 fs3 fc0 sc0 ls0">的映射对象。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.18.<span class="_ _5"> </span>9.18 <span class="ff1 wsae1">以编程方式定义类 </span>342</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
