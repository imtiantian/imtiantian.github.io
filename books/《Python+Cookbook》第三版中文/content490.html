<div id="pf1ea" class="pf w0 h0" data-page-no="1ea"><div class="pc pc1ea w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ea.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x15 h11 y1e8 ffa fs5 fcd sc0 ls0 ws4"># Poll for I/O events and restart waiting tasks</div><div class="t m0 x15 hf y1e9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_iopoll<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y1ea ff8 fs5 fc0 sc0 ls0 ws169">rset,wset,eset <span class="fc6 ls32">=</span><span class="ws13a">select(<span class="fca">self<span class="fc6 ls34">.</span></span>_read_waiting,</span></div><div class="t m0 x45 hf y903 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_write_waiting,[])</span></div><div class="t m0 x16 hf y1eb ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">r</span><span class="ws157">in <span class="ff8 fc0">rset:</span></span></div><div class="t m0 x17 hf y1ec ff8 fs5 fc0 sc0 ls0 ws13b">evt, task <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_read_waiting<span class="fc6">.</span>pop(r)</span></span></div><div class="t m0 x17 hf y904 ff8 fs5 fc0 sc0 ls0 ws13a">evt<span class="fc6 ls34">.</span>handle_resume(<span class="fca">self</span><span class="ws13b">, task)</span></div><div class="t m0 x16 hf y905 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">w</span><span class="ws157">in <span class="ff8 fc0">wset:</span></span></div><div class="t m0 x17 hf y906 ff8 fs5 fc0 sc0 ls0 ws13b">evt, task <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_write_waiting<span class="fc6 ls34">.</span>pop(w)</span></span></div><div class="t m0 x17 hf y907 ff8 fs5 fc0 sc0 ls0 ws13a">evt<span class="fc6 ls34">.</span>handle_resume(<span class="fca">self</span><span class="ws13b">, task)</span></div><div class="t m0 x15 hf y909 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">new<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">,task):</span></span></span></div><div class="t m0 x16 h15 ybd8 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 ybd9 ffa fs5 fc9 sc0 ls0 ws4">Add a newly started task to the scheduler</div><div class="t m0 x16 h15 y90a ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y90b ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_ready</span><span class="ls34">.</span><span class="fc0 ws147">append((task, </span></span>None<span class="fc0">))</span></div><div class="t m0 x16 hf y90c ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws51e">_numtasks </span><span class="ws1a1">+= <span class="fc7">1</span></span></span></div><div class="t m0 x15 hf y90e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">add_ready<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, task, msg<span class="fc6 ls34">=</span></span>None<span class="fc0">):</span></span></span></div><div class="t m0 x16 h15 y90f ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 y910 ffa fs5 fc9 sc0 ls0 ws4">Append an already started task to the ready queue.</div><div class="t m0 x16 h11 y911 ffa fs5 fc9 sc0 ls0 ws4">msg is what to send into the task when it resumes.</div><div class="t m0 x16 h15 ye93 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y912 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_ready</span><span class="ls34">.</span><span class="fc0 ws13b">append((task, msg))</span></span></div><div class="t m0 x15 h11 y914 ffa fs5 fcd sc0 ls0 ws4"># Add a task to the reading set</div><div class="t m0 x15 hf y915 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_read_wait<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fileno, evt, task):</span></span></span></div><div class="t m0 x16 hf y916 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 wsd67">_read_waiting[fileno] </span><span class="ls33">=</span><span class="fc0 ws13b">(evt, task)</span></span></div><div class="t m0 x15 h11 y2645 ffa fs5 fcd sc0 ls0 ws4"># Add a task to the write set</div><div class="t m0 x15 hf y918 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">_write_wait<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, fileno, evt, task):</span></span></span></div><div class="t m0 x16 hf y919 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws8a2">_write_waiting[fileno] </span><span class="ls33">=</span><span class="fc0 ws13b">(evt, task)</span></span></div><div class="t m0 x15 hf y30a6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">run<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 h15 y91b ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 h11 y91c ffa fs5 fc9 sc0 ls0 ws4">Run the task scheduler until there are no tasks</div><div class="t m0 x16 h15 y91d ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x16 hf y91e ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_numtasks:</span></span></div><div class="t m0 x3d hf y91f ff7 fs5 fca sc0 ls0 ws139">if not <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_ready:</span></span></div><div class="t m0 x34 hf y920 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_iopoll()</span></div><div class="t m0 x3d hf y921 ff8 fs5 fc0 sc0 ls0 ws4">task, msg <span class="fc6 ls32">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_ready<span class="fc6 ls34">.</span>popleft()</span></span></div><div class="t m0 x3d hf yede ff7 fs5 fca sc0 ls0 ws156">try<span class="ff8 fc0">:</span></div><div class="t m0 x41 h11 y922 ffa fs5 fcd sc0 ls0 ws4"># Run the coroutine to the next yield</div><div class="t m0 x41 hf y923 ff8 fs5 fc0 sc0 ls33">r<span class="fc6 ls32">=</span><span class="ls0 ws13a">task<span class="fc6 ls34">.</span>send(msg)</span></div><div class="t m0 x41 hf y924 ff7 fs5 fca sc0 ls0 ws160">if <span class="ff8 ws13a">isinstance<span class="fc0 ws13b">(r, YieldEvent):</span></span></div><div class="t m0 x46 hf y925 ff8 fs5 fc0 sc0 ls34">r<span class="fc6">.</span><span class="ls0 ws13a">handle_yield(<span class="fca">self</span><span class="ws4">, task)</span></span></div><div class="t m0 x41 hf yedf ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x46 hf y926 ff7 fs5 fca sc0 ls0 ws83b">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13b">unrecognized yield event<span class="ff9 ls34">&apos;</span><span class="fc0">)</span></span></span></div><div class="t m0 x3d hf y927 ff7 fs5 fca sc0 ls0 ws1ff">except <span class="ff8 ws13a">StopIteration<span class="fc0">:</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.12.<span class="_ _36"> </span>12.12 <span class="ff1 ws104c">使用生成器代替线程 </span>481</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
