<div id="pf169" class="pf w0 h0" data-page-no="169"><div class="pc pc169 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg169.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff7 fs5 fca sc0 ls0 ws157">if not <span class="ff8 ws13a">isinstance<span class="fc0 ws4">(value, expected_type):</span></span></div><div class="t m0 x17 hf y1ac ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">{} must be a {}<span class="ff9 ls34">&apos;</span></span><span class="fc6">.</span><span class="ws4">format(name, expected_type))</span></span></span></div><div class="t m0 x16 hf y1ad ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ls34">(</span>self<span class="fc0 ws13b">, storage_name, value)</span></div><div class="t m0 x15 hf y1af ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">prop</span></div><div class="t m0 x5 h11 y355 ffa fs5 fcd sc0 ls0 ws4"># Example use</div><div class="t m0 x5 hf y410 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Person<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y411 ff8 fs5 fc0 sc0 ls0 ws13c">name <span class="fc6 ls32">=</span><span class="ws13a">typed_property(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">name<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fca">str</span>)</span></div><div class="t m0 x15 hf yba ff8 fs5 fc0 sc0 ls0 ws158">age <span class="fc6 ls32">=</span><span class="ws13a">typed_property(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">age<span class="ff9 ls34">&apos;</span></span><span class="ls32">,</span><span class="fca">int</span>)</span></div><div class="t m0 x15 hf ybed ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name, age):</span></span></span></div><div class="t m0 x16 hf ybee ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x16 hf ybef ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws158">age </span><span class="ls33">=</span><span class="fc0">age</span></span></div><div class="t m0 x5 he y2584 ff2 fs2 fc4 sc0 ls0 wsadf">11.21.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2585 ff1 fs3 fc0 sc0 ls56 ws1fa">本节我们演示内部函数或者闭包的一个重要特性<span class="_ _c"></span>，它们很像一个宏<span class="_ _1"></span>。例子中的函<span class="_ _1"></span></div><div class="t m0 x5 h9 y17b0 ff1 fs3 fc0 sc0 ls1a5">数<span class="ff6 ls0 ws149">typed property()<span class="_ _7"> </span></span><span class="ls149 ws937">看上去有点难理解<span class="_ _1"></span>，其实它所做的仅仅就是为你生成属性并返<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y2586 ff1 fs3 fc0 sc0 ls0 wsa0">回<span class="_ _0"></span>这<span class="_ _6"></span>个<span class="_ _0"></span>属<span class="_ _0"></span>性<span class="_ _0"></span>对<span class="_ _6"></span>象。<span class="_ _0"></span>因<span class="_ _0"></span>此，<span class="_ _0"></span>当<span class="_ _0"></span>在<span class="_ _6"></span>一<span class="_ _0"></span>个<span class="_ _0"></span>类<span class="_ _6"></span>中<span class="_ _0"></span>使<span class="_ _0"></span>用<span class="_ _0"></span>它<span class="_ _6"></span>的<span class="_ _0"></span>时<span class="_ _0"></span>候，<span class="_ _0"></span>效<span class="_ _0"></span>果<span class="_ _6"></span>跟<span class="_ _0"></span>将<span class="_ _0"></span>它<span class="_ _0"></span>里<span class="_ _6"></span>面<span class="_ _0"></span>的<span class="_ _0"></span>代<span class="_ _6"></span>码<span class="_ _0"></span>放<span class="_ _0"></span>到</div><div class="t m0 x5 h7 y2587 ff1 fs3 fc0 sc0 lsc8 wsca7">类定义中去是一样的<span class="_ _c"></span>。尽管属性的 <span class="ff6 ls0 wsca8">getter </span><span class="ls1a6">和<span class="ff6 ls0 wsca8">setter </span></span><span class="wsca9">方法访问了本地变量如 <span class="ff6 ls0 ws9aa">name <span class="ff4">,</span></span></span></div><div class="t m0 x5 h9 y2445 ff6 fs3 fc0 sc0 ls0 ws17a">expected<span class="_ _7"> </span>type <span class="ff1 ws14">以及 </span><span class="ws27b">storate<span class="_ _16"> </span>name <span class="ff1">，这个很正常，这些变量的值会保存在闭包当中。</span></span></div><div class="t m0 x0 h9 y2588 ff1 fs3 fc0 sc0 ls0 wscaa">我<span class="_ _0"></span>们<span class="_ _6"></span>还<span class="_ _0"></span>可<span class="_ _6"></span>以<span class="_ _0"></span>使<span class="_ _0"></span>用 <span class="ff6 wscab">functools.partial() </span><span class="wsa0">来<span class="_ _6"></span>稍<span class="_ _0"></span>稍<span class="_ _6"></span>改<span class="_ _0"></span>变<span class="_ _0"></span>下<span class="_ _6"></span>这<span class="_ _0"></span>个<span class="_ _0"></span>例<span class="_ _6"></span>子，<span class="_ _0"></span>很<span class="_ _6"></span>有<span class="_ _0"></span>趣。<span class="_ _0"></span>例<span class="_ _6"></span>如，</span></div><div class="t m0 x5 h9 y2589 ff1 fs3 fc0 sc0 ls0">你可以像下面这样：</div><div class="t m0 x5 hf y258a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">partial</span></span></div><div class="t m0 x5 hf y258b ff8 fs5 fc0 sc0 ls0 ws145">String <span class="fc6 ls33">=</span><span class="ws13b">partial(typed_property, expected_type<span class="fc6 ls34">=</span><span class="fca ws13a">str</span>)</span></div><div class="t m0 x5 hf y258c ff8 fs5 fc0 sc0 ls0 ws155">Integer <span class="fc6 ls32">=</span><span class="ws4">partial(typed_property, expected_type<span class="fc6 ls34">=</span><span class="fca ws13a">int</span>)</span></div><div class="t m0 x5 h11 y258d ffa fs5 fcd sc0 ls0 ws4"># Example:</div><div class="t m0 x5 hf y258e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Person<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y258f ff8 fs5 fc0 sc0 ls0 ws13c">name <span class="fc6 ls32">=</span><span class="ws13a">String(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">name<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x15 hf y2590 ff8 fs5 fc0 sc0 ls0 ws158">age <span class="fc6 ls32">=</span><span class="ws13a">Integer(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">age<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x15 hf y2591 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name, age):</span></span></span></div><div class="t m0 x16 hf y2592 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x16 hf y2593 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws158">age </span><span class="ls33">=</span><span class="fc0">age</span></span></div><div class="t m0 x0 h7 y2594 ff1 fs3 fc0 sc0 ls0 ws14">其实你可以发现，这里的代码跟 <span class="ff4 ws1d0">8.13 </span>小节中的类型系统描述器代码有些相似。</div><div class="t m0 x5 hd y2595 ff2 fs4 fc4 sc0 ls0 ws211">11.22<span class="_ _e"> </span>9.22 <span class="ff1">定义上下文管理器的简单方法</span></div><div class="t m0 x5 he y2596 ff2 fs2 fc4 sc0 ls0 wsadf">11.22.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y2597 ff1 fs3 fc0 sc0 ls0 ws14">你想自己去实现一个新的上下文管理器，以便使用 <span class="ff4 wscac">with </span>语句。</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.22.<span class="_ _5"> </span>9.22 <span class="ff1 wsb70">定义上下文管理器的简单方法 </span>352</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
