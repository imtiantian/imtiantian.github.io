<div id="pf1d5" class="pf w0 h0" data-page-no="1d5"><div class="pc pc1d5 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1d5.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x17 hf y1ab ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">RuntimeError<span class="fc0 ls34">(</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Already connected</span>&apos;</span><span class="fc0">)</span></span></div><div class="t m0 x16 hf y1ac ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">local</span><span class="ls34">.</span><span class="fc0 ws161">sock </span><span class="ls33">=</span><span class="fc0">socket(</span></span>self<span class="fc6 ls34">.</span><span class="fc0 ws1f4">family, </span>self<span class="fc6 ls34">.</span><span class="fc0">type)</span></div><div class="t m0 x16 hf y1ad ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">local</span><span class="ls34">.</span><span class="fc0">sock</span>.<span class="fc0">connect(</span></span>self<span class="fc6 ls34">.</span><span class="fc0">address)</span></div><div class="t m0 x16 hf y1ae ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">local<span class="fc6 ls34">.</span>sock</span></span></div><div class="t m0 x15 hf y1b0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__exit__<span class="fc0">(<span class="fca">self</span><span class="ws4">, exc_ty, exc_val, tb):</span></span></span></div><div class="t m0 x16 hf y355 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">local</span><span class="ls34">.</span><span class="fc0">sock</span>.<span class="fc0">close()</span></span></div><div class="t m0 x16 hf y410 ff7 fs5 fca sc0 ls0 ws139">del <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">local</span><span class="ls34">.</span><span class="fc0">sock</span></span></span></div><div class="t m0 x0 h9 y2ef6 ff1 fs3 fc0 sc0 ls0 ws10c4">代 码 中， 自 己 观 察 对 于<span class="_ _32"> </span><span class="ff6 ws10c5">self.local </span><span class="ls201 ws10c6">属性的使用<span class="_ _2e"></span>。它被初始化尾一个<span class="_ _2e"></span></span></div><div class="t m0 x5 h9 y2ef7 ff6 fs3 fc0 sc0 ls0 ws10c7">threading.local() <span class="ff1 lsc8 ws10c8">实例<span class="_ _c"></span>。其他方法操作被存储为 <span class="ff6 ls0 ws10c9">self.local.sock <span class="ff1 wsa0">的<span class="_ _0"></span>套<span class="_ _6"></span>接<span class="_ _6"></span>字<span class="_ _0"></span>对<span class="_ _6"></span>象。</span></span></span></div><div class="t m0 x5 h9 y2ef8 ff1 fs3 fc0 sc0 ls0 ws63">有了这些就可以在多线程中安全的使用 <span class="ff6 ws2dc">LazyConnection </span>实例了。例如：</div><div class="t m0 x5 hf y296a ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws285">functools </span><span class="ws146">import <span class="ff8 fc0">partial</span></span></div><div class="t m0 x5 hf y844 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">test<span class="fc0">(conn):</span></span></div><div class="t m0 x15 hf y2ef9 ff7 fs5 fca sc0 ls0 ws15a">with <span class="ff8 fc0 ws161">conn </span><span class="ws157">as <span class="ff8 fc0">s:</span></span></div><div class="t m0 x16 hf y2efa ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">GET /index.html HTTP/1.0<span class="ff7 ws156">\r\n</span></span>&apos;</span>)</span></span></div><div class="t m0 x16 hf y8c9 ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws4">Host: www.python.org<span class="ff7 ws156">\r\n</span></span><span class="ls34">&apos;</span></span>)</span></span></div><div class="t m0 x16 hf y2efb ff8 fs5 fc0 sc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">send(b<span class="ff9 fc9 ws13b">&apos;<span class="ff7 ws156">\r\n</span><span class="ls34">&apos;</span></span>)</span></span></div><div class="t m0 x16 hf y2efc ff8 fs5 fc0 sc0 ls0 ws161">resp <span class="fc6 ls33">=</span><span class="ls34">b</span><span class="ff9 fc9 ws13b">&apos;&apos;</span><span class="fc6 ls34">.</span><span class="ws13a">join(<span class="fca">iter</span>(partial(s<span class="fc6">.</span><span class="ws458">recv, </span><span class="fc7">8192</span><span class="ws13b">), b<span class="ff9 fc9">&apos;&apos;</span>))</span></span></div><div class="t m0 x15 hf y2efd ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">Got {} bytes<span class="ff9 ws13b">&apos;</span><span class="fc6 ls34">.</span></span>format(<span class="fca">len</span>(resp)))</span></div><div class="t m0 x5 hf y2efe ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">__name__ <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">__main__<span class="ff9 ls34">&apos;</span></span></span>:</span></div><div class="t m0 x15 hf y2eff ff8 fs5 fc0 sc0 ls0 ws13c">conn <span class="fc6 ls32">=</span><span class="ws13a">LazyConnection((<span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">www.python.org<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,</span><span class="fc7">80</span>))</span></div><div class="t m0 x15 hf y1d2d ff8 fs5 fc0 sc0 ls0 ws159">t1 <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6 ls34">=</span><span class="ws4">test, args<span class="fc6 ls34">=</span>(conn,))</span></span></div><div class="t m0 x15 hf y1d2e ff8 fs5 fc0 sc0 ls0 ws159">t2 <span class="fc6 ls33">=</span><span class="ws13a">threading<span class="fc6 ls34">.</span>Thread(target<span class="fc6 ls34">=</span><span class="ws4">test, args<span class="fc6 ls34">=</span>(conn,))</span></span></div><div class="t m0 x15 hf y1d2f ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span>start()</div><div class="t m0 x15 hf y2cf0 ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span>start()</div><div class="t m0 x15 hf y2f00 ff8 fs5 fc0 sc0 ls0 ws13a">t1<span class="fc6 ls34">.</span>join()</div><div class="t m0 x15 hf y2f01 ff8 fs5 fc0 sc0 ls0 ws13a">t2<span class="fc6 ls34">.</span>join()</div><div class="t m0 x0 h9 y2f02 ff1 fs3 fc0 sc0 ls184 wsb34">它之所以行得通的原因是每个线程会创建一个自己专属的套接字连接（<span class="_ _d"></span>存储为<span class="_ _d"></span></div><div class="t m0 x5 h7 y2f03 ff4 fs3 fc0 sc0 ls0 wsa5">self.lo<span class="_ _6"></span>cal.so<span class="_ _6"></span>c<span class="_ _1"></span>k<span class="ff1 ls77 ws2d4">）<span class="_ _2e"></span>。因此<span class="_ _c"></span>，当不同的线程执行套接字操作时<span class="_ _c"></span>，由于操作的是不同的<span class="_ _6"></span>套接<span class="_ _c"></span></span></div><div class="t m0 x5 h9 y2f04 ff1 fs3 fc0 sc0 ls0">字，因此它们不会相互影响。</div><div class="t m0 x5 he y2f05 ff2 fs2 fc4 sc0 ls0 ws212">14.6.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h9 y2f06 ff1 fs3 fc0 sc0 ls3a ws153">在大部分程序中创建和操作线程特定状态并不会有什么问题。不过，当出了问题的</div><div class="t m0 x5 h9 y2f07 ff1 fs3 fc0 sc0 ls1e ws111">时候<span class="_ _1"></span>，通常是因为某个对象被多个线程使用到<span class="_ _1"></span>，用来操作一些专用的系统资源<span class="_ _1"></span>，比如</div><div class="t m0 x5 h9 y2f08 ff1 fs3 fc0 sc0 ls13 wse5">一个套接字或文件<span class="_ _1"></span>。你不能让所有线程贡献一个单独对象，因为多个线程同时读和写<span class="_ _c"></span></div><div class="t m0 x5 h9 y2f09 ff1 fs3 fc0 sc0 ls2d ws132">的时候会产生混乱。本地线程存储通过让这些资源只能在被使用的线程中可见来解决<span class="_ _1"></span></div><div class="t m0 x5 h9 y10c7 ff1 fs3 fc0 sc0 ls0">这个问题。</div><div class="t m0 x0 h9 y2f0a ff1 fs3 fc0 sc0 ls0 ws694">本节中，<span class="_ _1"></span>使用 <span class="ff6 wsb42">thread.local() </span><span class="wscce">可以让 <span class="ff6 wsb42">LazyConnection </span>类支持一个线程一个连接，</span></div><div class="t m0 x5 h9 y135 ff1 fs3 fc0 sc0 ls0">而不是对于所有的进程都只有一个连接。</div><div class="t m0 x0 h9 y2f0b ff1 fs3 fc0 sc0 ls0 ws10ca">其原理<span class="_ _6"></span>是，每个 <span class="ff6 ws10cb">threading.local() </span><span class="wsa0">实<span class="_ _6"></span>例为每<span class="_ _6"></span>个线程维<span class="_ _6"></span>护着一<span class="_ _6"></span>个单独<span class="_ _6"></span>的实例<span class="_ _6"></span>字典。</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">14.6.<span class="_ _36"> </span>12.6 <span class="ff1 ws544">保存线程的状态信息 </span>460</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
