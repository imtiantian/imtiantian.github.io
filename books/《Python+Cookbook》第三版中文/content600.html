<div id="pf258" class="pf w0 h0" data-page-no="258"><div class="pc pc258 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg258.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 wsd91">17.14<span class="_ _e"> </span>15.14 <span class="ff1 ws165">传递 </span><span class="ws33d">Unico<span class="_ _6"></span>de <span class="ff1 ws165">字符串给 </span><span class="ls23d">C</span><span class="ff1">函数库</span></span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">17.14.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y658 ff1 fs3 fc0 sc0 ls0 ws144f">你要写一个扩展模块，需要将一个 <span class="ff4 ws347">Python </span><span class="ws348">字符串传递给 <span class="ff4 ls259">C</span><span class="wsa0">的某个库函数，<span class="_ _1"></span>但是这</span></span></div><div class="t m0 x5 h7 y659 ff1 fs3 fc0 sc0 ls0 ws38">个函数不知道该怎么处理 <span class="ff4 wsa5">Unico<span class="_ _6"></span>de</span>。</div><div class="t m0 x5 he y18fe ff2 fs2 fc4 sc0 ls0 wsadf">17.14.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y18bb ff1 fs3 fc0 sc0 ls0 ws1569">这<span class="_ _0"></span>里<span class="_ _6"></span>我<span class="_ _0"></span>们<span class="_ _0"></span>需<span class="_ _6"></span>要<span class="_ _0"></span>考<span class="_ _0"></span>虑<span class="_ _6"></span>很<span class="_ _0"></span>多<span class="_ _0"></span>的<span class="_ _6"></span>问<span class="_ _0"></span>题，<span class="_ _0"></span>但<span class="_ _6"></span>是<span class="_ _0"></span>最<span class="_ _0"></span>主<span class="_ _6"></span>要<span class="_ _0"></span>的<span class="_ _0"></span>问<span class="_ _6"></span>题<span class="_ _0"></span>是<span class="_ _0"></span>现<span class="_ _6"></span>存<span class="_ _0"></span>的 <span class="ff4 ls27a">C</span><span class="wsa0">函<span class="_ _0"></span>数<span class="_ _6"></span>库<span class="_ _0"></span>并<span class="_ _0"></span>不<span class="_ _6"></span>理<span class="_ _0"></span>解</span></div><div class="t m0 x5 h7 y18bc ff4 fs3 fc0 sc0 ls0 ws10c">Python <span class="ff1 ws64f">的原<span class="_ _6"></span>生 </span><span class="ws156a">Unico<span class="_ _6"></span>de <span class="ff1 ws156b">表示。因<span class="_ _6"></span>此，你的<span class="_ _6"></span>挑战<span class="_ _6"></span>是将 </span></span>Python <span class="ff1 ws156c">字符<span class="_ _6"></span>串转<span class="_ _6"></span>换为一<span class="_ _6"></span>个能<span class="_ _6"></span>被 </span>C</div><div class="t m0 x5 h9 y18bd ff1 fs3 fc0 sc0 ls0">理解的形式。</div><div class="t m0 x0 h7 y28f6 ff1 fs3 fc0 sc0 ls0 ws156d">为<span class="_ _6"></span>了演<span class="_ _6"></span>示<span class="_ _6"></span>的<span class="_ _6"></span>目<span class="_ _6"></span>的，下<span class="_ _6"></span>面<span class="_ _6"></span>有<span class="_ _6"></span>两<span class="_ _6"></span>个 <span class="ff4 ls263">C</span><span class="ls13 wse5">函数<span class="_ _1"></span>，用来操作字符串数据并输出它来调试和测<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y39a7 ff1 fs3 fc0 sc0 ls1f ws156e">试。一个使用形式为 <span class="ff6 ls0 ws156f">char<span class="_ _11"> </span>*,<span class="_ _11"> </span>int </span><span class="ws9fb">形式的字节，而另一个使用形式为 <span class="ff6 ls0 ws149">wchar t<span class="_ _26"> </span>*,<span class="_ _11"> </span>int</span></span></div><div class="t m0 x5 h9 y39a8 ff1 fs3 fc0 sc0 ls0">的宽字符形式：</div><div class="t m0 x5 hf y39a9 ff8 fs5 fc0 sc0 ls0 ws4">void print_chars(char *s, int len) {</div><div class="t m0 x19 hf y39aa ff8 fs5 fc0 sc0 ls0 ws4">int n = 0;</div><div class="t m0 x19 hf y39ab ff8 fs5 fc0 sc0 ls0 ws4">while (n &lt; len) {</div><div class="t m0 x15 hf y14f3 ff8 fs5 fc0 sc0 ls0 ws4">printf(&quot;%2x &quot;, (unsigned char) s[n]);</div><div class="t m0 x15 hf y39ac ff8 fs5 fc0 sc0 ls0">n++;</div><div class="t m0 x19 hf y39ad ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y39ae ff8 fs5 fc0 sc0 ls0">printf(&quot;\n&quot;);</div><div class="t m0 x5 hf y2987 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 hf y39af ff8 fs5 fc0 sc0 ls0 ws4">void print_wchars(wchar_t *s, int len) {</div><div class="t m0 x19 hf y39b0 ff8 fs5 fc0 sc0 ls0 ws4">int n = 0;</div><div class="t m0 x19 hf y39b1 ff8 fs5 fc0 sc0 ls0 ws4">while (n &lt; len) {</div><div class="t m0 x15 hf y39b2 ff8 fs5 fc0 sc0 ls0 ws13b">printf(&quot;%x &quot;, s[n]);</div><div class="t m0 x15 hf y39b3 ff8 fs5 fc0 sc0 ls0">n++;</div><div class="t m0 x19 hf y39b4 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y39b5 ff8 fs5 fc0 sc0 ls0">printf(&quot;\n&quot;);</div><div class="t m0 x5 hf y24f4 ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x0 h7 y96e ff1 fs3 fc0 sc0 ls35 ws1570">对于面向字节的函数 <span class="ff6 ls0 ws1571">print<span class="_ _7"> </span>chars() </span><span class="ws1532">，你需要将 <span class="ff4 ls0 ws8a5">Python </span><span class="ws144">字符串转换为一个合适的</span></span></div><div class="t m0 x5 h7 y1608 ff1 fs3 fc0 sc0 ls0 ws14">编码比如 <span class="ff4 ws1572">UTF-8. </span>下面是一个这样的扩展函数例子：</div><div class="t m0 x5 hf y39b6 ff8 fs5 fc0 sc0 ls0 ws4">static PyObject *py_print_chars(PyObject *self, PyObject *args) {</div><div class="t m0 x19 hf y39b7 ff8 fs5 fc0 sc0 ls0 ws4">char *s;</div><div class="t m0 x19 hf y39b8 ff8 fs5 fc0 sc0 ls0 ws1303">Py_ssize_t len;</div><div class="t m0 x19 hf y39b9 ff8 fs5 fc0 sc0 ls0 ws4">if (!PyArg_ParseTuple(args, &quot;s#&quot;, &amp;s, &amp;len)) {</div><div class="t m0 x15 hf y39ba ff8 fs5 fc0 sc0 ls0 ws13b">return NULL;</div><div class="t m0 x19 hf y39bb ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x19 hf y39bc ff8 fs5 fc0 sc0 ls0 ws4">print_chars(s, len);</div><div class="t m0 x19 hf y39bd ff8 fs5 fc0 sc0 ls0">Py_RETURN_NONE;</div><div class="t m0 x5 hf y39be ff8 fs5 fc0 sc0 ls0">}</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.14.<span class="_ _36"> </span>15.14 <span class="ff1 ws16b">传递 </span><span class="ws342">Unico<span class="_ _0"></span>de <span class="ff1 ws16b">字符串给 </span><span class="ls246">C</span><span class="ff1 ws1573">函数库 </span>591</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
