<div id="pf154" class="pf w0 h0" data-page-no="154"><div class="pc pc154 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg154.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y1401 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x5 he y23a2 ff2 fs2 fc4 sc0 ls0 wsadf">11.14.3 <span class="ff1">讨论</span></div><div class="t m0 x0 h7 y23a3 ff1 fs3 fc0 sc0 ls3d ws437">本节一个关键点就是 <span class="ff4 ls0 wsc22">OrderedMeta </span><span class="ws6b6">元类中定义的 <span class="ff4 ls0 wsc23">‘‘<span class="_ _30"> </span>prepare<span class="_ _e"> </span>()‘‘ <span class="ff1 wsa0">方<span class="_ _6"></span>法。这个<span class="_ _6"></span>方法</span></span></span></div><div class="t m0 x5 h9 y23a4 ff1 fs3 fc0 sc0 ls2d ws132">会在开始定义类和它的父类的时候被执行。它必须返回一个映射对象以便在类定义体<span class="_ _1"></span></div><div class="t m0 x5 h7 y23a5 ff1 fs3 fc0 sc0 ls0 ws100">中<span class="_ _6"></span>被<span class="_ _6"></span>使<span class="_ _6"></span>用<span class="_ _6"></span>到。我<span class="_ _6"></span>们<span class="_ _6"></span>这<span class="_ _6"></span>里<span class="_ _6"></span>通<span class="_ _6"></span>过<span class="_ _6"></span>返<span class="_ _6"></span>回<span class="_ _6"></span>了<span class="_ _6"></span>一<span class="_ _6"></span>个 <span class="ff4 wsc24">OrderedDict </span><span class="wsa0">而<span class="_ _6"></span>不<span class="_ _6"></span>是<span class="_ _6"></span>一<span class="_ _6"></span>个<span class="_ _6"></span>普<span class="_ _6"></span>通<span class="_ _6"></span>的字<span class="_ _6"></span>典，<span class="_ _6"></span>可<span class="_ _6"></span>以<span class="_ _6"></span>很</span></div><div class="t m0 x5 h9 y23a6 ff1 fs3 fc0 sc0 ls0">容易的捕获定义的顺序。</div><div class="t m0 x0 h9 y23a7 ff1 fs3 fc0 sc0 ls0 wsa0">如果你想构造自己的<span class="_ _6"></span>类字典对象，可以很容易的<span class="_ _6"></span>扩展这个功能。比如，下面<span class="_ _6"></span>的这个</div><div class="t m0 x5 h9 y23a8 ff1 fs3 fc0 sc0 ls0">修改方案可以防止重复的定义：</div><div class="t m0 x5 hf y23a9 ff7 fs5 fca sc0 ls0 ws15a">from <span class="fcc ws168">collections </span><span class="ws146">import <span class="ff8 fc0">OrderedDict</span></span></div><div class="t m0 x5 hf y23aa ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">NoDupOrderedDict<span class="ff8 fc0">(OrderedDict):</span></span></div><div class="t m0 x15 hf y23ab ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, clsname):</span></span></span></div><div class="t m0 x16 hf y23ac ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">clsname </span><span class="ls33">=</span><span class="fc0">clsname</span></span></div><div class="t m0 x16 hf y21f5 ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>__init__()</span></div><div class="t m0 x15 hf y21f6 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__setitem__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws4">, name, value):</span></span></span></div><div class="t m0 x16 hf y21f7 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13c">name </span>in <span class="ff8 ws13a">self<span class="fc0">:</span></span></div><div class="t m0 x17 hf y1ee7 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">{} already defined in {}<span class="ff9 ws13b">&apos;</span><span class="fc6 ls34">.</span></span><span class="ws150">format(name, </span></span>self<span class="fc6 ls34">.</span><span class="fc0">clsname))</span></span></div><div class="t m0 x16 hf y21f8 ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span><span class="ws13b">__setitem__(name, value)</span></span></div><div class="t m0 x5 hf y23ad ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">OrderedMeta<span class="ff8 fc0 ls34">(</span></span><span class="ff8 ws13a">type<span class="fc0">):</span></span></div><div class="t m0 x15 hf y23ae ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__new__<span class="fc0 ws4">(cls, clsname, bases, clsdict):</span></span></div><div class="t m0 x16 hf y23af ff8 fs5 fc0 sc0 ls32">d<span class="fc6 ls33">=<span class="fca ls0 ws13a">dict<span class="fc0">(clsdict)</span></span></span></div><div class="t m0 x16 hf y23b0 ff8 fs5 fc0 sc0 ls0 ws13a">d[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">_order<span class="ff9 ls34">&apos;</span></span><span class="ls33">]<span class="fc6 ls32">=</span></span><span class="ws15f">[name <span class="ff7 fca ws139">for </span><span class="ws13c">name <span class="ff7 fca ws157">in </span><span class="ws155">clsdict <span class="ff7 fca ws157">if </span></span></span></span>name[<span class="fc7">0</span><span class="ls33">]</span><span class="fc6 ws159">!= <span class="ff9 fc9 ls34">&apos;<span class="ff8">_</span><span class="ls0 ws13b">&apos;</span></span></span>]</div><div class="t m0 x16 hf y23b1 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">type<span class="fc6 ls34">.</span><span class="fc0 ws4">__new__(cls, clsname, bases, d)</span></span></div><div class="t m0 x15 h10 y2200 ff7 fs5 fc12 sc0 ls0">@classmethod</div><div class="t m0 x15 hf y2201 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__prepare__<span class="fc0 ws13b">(cls, clsname, bases):</span></span></div><div class="t m0 x16 hf y2202 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">NoDupOrderedDict(clsname)</span></div><div class="t m0 x0 h9 y23b2 ff1 fs3 fc0 sc0 ls0">下面我们测试重复的定义会出现什么情况：</div><div class="t m0 x5 hf y23b3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws16a">class <span class="fcc ls34">A</span><span class="ff8 fc0 ws13a">(metaclass<span class="fc6 ls34">=</span>OrderedMeta):</span></span></div><div class="t m0 x5 hf y23b4 ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">def <span class="ff8 fcb ws13a">spam<span class="fc0">(<span class="fca">self</span>):</span></span></span></div><div class="t m0 x5 h10 y23b5 ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">pass</span></div><div class="t m0 x5 hf y23b6 ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">def <span class="ff8 fcb ws13a">spam<span class="fc0">(<span class="fca">self</span>):</span></span></span></div><div class="t m0 x5 h10 y23b7 ff7 fs5 fc5 sc0 ls0 ws139">... <span class="fca">pass</span></div><div class="t m0 x5 h10 y23b8 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y23b9 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y23ba ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x15 hf ybe7 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">4</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span>A</span></div><div class="t m0 x15 hf y23bb ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;dupmethod2.py&quot;</span><span class="ws4">, line <span class="fc7 ws13a">25</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span>__setitem__</span></div><div class="t m0 x16 hf y23bc ff8 fs5 fc0 sc0 ls0 ws145">(name, <span class="fca ws13a">self<span class="fc6 ls34">.</span></span>clsname))</div><div class="t m0 x5 hf y23bd ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws4">: spam already defined in A</span></div><div class="t m0 x5 hf y23be ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y23bf ff1 fs3 fc0 sc0 ls0 wsc25">最后<span class="_ _6"></span>还有<span class="_ _6"></span>一点<span class="_ _6"></span>很重<span class="_ _6"></span>要，就<span class="_ _6"></span>是在 <span class="ff6 wsc26">new<span class="_ _e"> </span>() </span><span class="wsa0">方<span class="_ _6"></span>法中<span class="_ _6"></span>对于<span class="_ _6"></span>元类<span class="_ _6"></span>中被<span class="_ _6"></span>修改<span class="_ _6"></span>字典<span class="_ _6"></span>的处<span class="_ _6"></span>理。尽</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.14.<span class="_ _5"> </span>9.14 <span class="ff1 wsaf4">捕获类的属性定义顺序 </span>331</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
