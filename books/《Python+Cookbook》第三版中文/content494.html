<div id="pf1ee" class="pf w0 h0" data-page-no="1ee"><div class="pc pc1ee w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg1ee.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hd y112 ff2 fs4 fc4 sc0 ls0 wsd91">14.13<span class="_ _e"> </span>12.13 <span class="ff1">多个线程队列轮询</span></div><div class="t m0 x5 he y113 ff2 fs2 fc4 sc0 ls0 wsadf">14.13.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y658 ff1 fs3 fc0 sc0 ls3a ws153">你有一个线程队列集合，想为到来的元素轮询它们，就跟你为一个客户端请求去轮</div><div class="t m0 x5 h9 y659 ff1 fs3 fc0 sc0 ls0">询一个网络连接集合的方式一样。</div><div class="t m0 x5 he y18fe ff2 fs2 fc4 sc0 ls0 wsadf">14.13.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y18bb ff1 fs3 fc0 sc0 ls3a ws153">对于轮询问题的一个常见解决方案中有个很少有人知道的技巧，包含了一个隐藏的</div><div class="t m0 x5 h9 y18bc ff1 fs3 fc0 sc0 ls0 wsa0">回<span class="_ _6"></span>路网<span class="_ _6"></span>络<span class="_ _6"></span>连<span class="_ _6"></span>接。<span class="_ _6"></span>本<span class="_ _6"></span>质上<span class="_ _6"></span>讲<span class="_ _6"></span>其<span class="_ _6"></span>思<span class="_ _6"></span>想<span class="_ _6"></span>就是：<span class="_ _6"></span>对<span class="_ _6"></span>于<span class="_ _6"></span>每<span class="_ _6"></span>个<span class="_ _6"></span>你<span class="_ _6"></span>想要<span class="_ _6"></span>轮<span class="_ _6"></span>询<span class="_ _6"></span>的<span class="_ _6"></span>队<span class="_ _6"></span>列，你<span class="_ _6"></span>创<span class="_ _6"></span>建<span class="_ _6"></span>一<span class="_ _6"></span>对<span class="_ _6"></span>连接</div><div class="t m0 x5 h9 y18bd ff1 fs3 fc0 sc0 ls13 wse5">的套接字<span class="_ _1"></span>。然后你在其中一个套接字上面编写代码来标识存在的数据，另外一个套接<span class="_ _c"></span></div><div class="t m0 x5 h9 y2ea3 ff1 fs3 fc0 sc0 ls0 ws14">字被传给 <span class="ff6 ws1f3">select() </span>或类似的一个轮询数据到达的函数。下面的例子演示了这个思想：</div><div class="t m0 x5 h10 y30cb ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">queue</span></div><div class="t m0 x5 h10 y30cc ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">socket</span></div><div class="t m0 x5 h10 y30cd ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">os</span></div><div class="t m0 x5 hf y30ce ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">PollableQueue<span class="ff8 fc0 ws13a">(queue<span class="fc6 ls34">.</span>Queue):</span></span></div><div class="t m0 x15 hf y10d8 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y30cf ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>__init__()</span></div><div class="t m0 x16 h11 y30d0 ffa fs5 fcd sc0 ls0 ws4"># Create a pair of connected sockets</div><div class="t m0 x16 hf y1b4e ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">os<span class="fc6 ls34">.</span><span class="ws13c">name <span class="fc6 ws159">== <span class="ff9 fc9 ls34">&apos;</span></span></span><span class="fc9">posix<span class="ff9 ls34">&apos;</span></span>:</span></div><div class="t m0 x17 hf y30d1 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws208">_putsocket, </span></span>self<span class="fc6 ls34">.</span><span class="fc0 ws2a3">_getsocket <span class="fc6 ls32">=</span><span class="ws13a">socket<span class="fc6">.</span>socketpair()</span></span></div><div class="t m0 x16 hf y30d2 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 h11 y30d3 ffa fs5 fcd sc0 ls0 ws4"># Compatibility on non-POSIX systems</div><div class="t m0 x17 hf y30d4 ff8 fs5 fc0 sc0 ls0 ws145">server <span class="fc6 ls32">=</span><span class="ws13a">socket<span class="fc6">.</span>socket(socket<span class="fc6 ls34">.</span><span class="ws13b">AF_INET, socket<span class="fc6 ls34">.</span>SOCK_STREAM)</span></span></div><div class="t m0 x17 hf y30d5 ff8 fs5 fc0 sc0 ls0 ws13a">server<span class="fc6 ls34">.</span>bind((<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">127.0.0.1<span class="ff9 ls34">&apos;</span></span><span class="ls33">,</span><span class="fc7">0</span>))</div><div class="t m0 x17 hf y30d6 ff8 fs5 fc0 sc0 ls0 ws13a">server<span class="fc6 ls34">.</span>listen(<span class="fc7 ls34">1</span>)</div><div class="t m0 x17 hf y30d7 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws2a3">_putsocket </span><span class="ls33">=</span><span class="fc0">socket</span><span class="ls34">.</span><span class="fc0">socket(socket</span><span class="ls34">.</span><span class="fc0 ws4">AF_INET, socket</span><span class="ls34">.</span><span class="fc0">SOCK_STREAM)</span></span></div><div class="t m0 x17 hf y30d8 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_putsocket</span>.<span class="fc0">connect(server</span>.<span class="fc0">getsockname())</span></span></div><div class="t m0 x17 hf y30d9 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws4">_getsocket, _ </span><span class="ls32">=</span><span class="fc0">server</span><span class="ls34">.</span><span class="fc0">accept()</span></span></div><div class="t m0 x17 hf y30da ff8 fs5 fc0 sc0 ls0 ws13a">server<span class="fc6 ls34">.</span>close()</div><div class="t m0 x15 hf y1208 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">fileno<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y30db ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_getsocket<span class="fc6 ls34">.</span>fileno()</span></span></div><div class="t m0 x15 hf y30dc ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">put<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, item):</span></span></span></div><div class="t m0 x16 hf y30dd ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>put(item)</span></div><div class="t m0 x16 hf y30de ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_putsocket</span>.<span class="fc0">send(b<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">x<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y30df ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">get<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0">):</span></span></span></div><div class="t m0 x16 hf y30e0 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_getsocket</span>.<span class="fc0">recv(<span class="fc7 ls34">1</span>)</span></span></div><div class="t m0 x16 hf y30e1 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span>get()</span></span></div><div class="t m0 x0 h9 y30e2 ff1 fs3 fc0 sc0 ls0 ws11a8">在这个代码中，<span class="_ _1"></span>一个新的 <span class="ff6 ws8c1">Queue </span><span class="wsa0">实例类型被定义，<span class="_ _1"></span>底层是一个被连接套接字对。<span class="_ _1"></span>在</span></div><div class="t m0 x5 h7 y30e3 ff4 fs3 fc0 sc0 ls0 ws11a9">Unix <span class="ff1 ws2c8">机器上的 <span class="ff6 ws11aa">socketpair() </span><span class="ws11ab">函数能轻松的创建这样的套接字。在 </span></span><span class="ws11ac">Windo<span class="_ _c"></span>ws <span class="ff1 wsa0">上面，你</span></span></div><div class="t m0 x5 h9 y30e4 ff1 fs3 fc0 sc0 ls18 ws11ad">必须使用类似代码来模拟它。然后定义普通的 <span class="ff6 ls0 ws819">get() </span><span class="ls17b">和<span class="ff6 ls0 ws819">put() </span></span><span class="ws110">方法在这些套接字上面<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">14.13.<span class="_ _36"> </span>12.13 <span class="ff1 ws11ae">多个线程队列轮询 </span>485</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
