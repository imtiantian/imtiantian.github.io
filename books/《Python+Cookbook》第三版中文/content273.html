<div id="pf111" class="pf w0 h0" data-page-no="111"><div class="pc pc111 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg111.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 hf y765 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0 ws458">price </span><span class="ls32">=</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">a lot<span class="ff9">&apos;</span></span></span></span></div><div class="t m0 x5 hf y766 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y767 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x15 hf y768 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;example.py&quot;</span><span class="ws145">, line <span class="fc7 ws13a">16</span><span class="ls32">,</span><span class="ff7 fca ws157">in </span>__set__</span></div><div class="t m0 x16 hf y769 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws16d">expected <span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span></span></span>str<span class="fc0 ls34">(</span>self<span class="fc6 ls34">.</span><span class="fc0">expected_type))</span></span></div><div class="t m0 x5 hf y76a ff8 fs5 fc2 sc0 ls0 ws13a">TypeError<span class="fc0 ws13b">: expected &lt;class <span class="ff9">&apos;</span><span class="ws13a">float<span class="ff9 ls34">&apos;</span>&gt;</span></span></div><div class="t m0 x5 hf y76b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0 ws13c">name </span><span class="ls32">=</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">ABRACADABRA<span class="ff9">&apos;</span></span></span></span></div><div class="t m0 x5 hf y76c ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x15 hf y842 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws145">, line <span class="fc7 ls34">1</span><span class="ls32">,</span><span class="ff7 fca ws160">in </span><span class="fc6 ws13a">&lt;<span class="fc0">module</span>&gt;</span></span></div><div class="t m0 x15 hf y1d75 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;example.py&quot;</span><span class="ws145">, line <span class="fc7 ws13a">17</span><span class="ls32">,</span><span class="ff7 fca ws157">in </span>__set__</span></div><div class="t m0 x16 hf y1d76 ff8 fs5 fca sc0 ls0 ws13a">super<span class="fc0">()<span class="fc6 ls34">.</span><span class="ws13b">__set__(instance, value)</span></span></div><div class="t m0 x15 hf y1d77 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fc9 ws13a">&quot;example.py&quot;</span><span class="ws145">, line <span class="fc7 ws13a">35</span><span class="ls32">,</span><span class="ff7 fca ws157">in </span>__set__</span></div><div class="t m0 x16 hf y1d78 ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">ValueError<span class="fc0 ls34">(<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws4">size must be &lt; <span class="ff9 ls32">&apos;</span><span class="fc6 ls33">+</span></span>str<span class="fc0 ls34">(</span>self<span class="fc6">.<span class="fc0">size))</span></span></span></div><div class="t m0 x5 hf y1d79 ff8 fs5 fc2 sc0 ls0 ws13a">ValueError<span class="fc0 ws4">: size must be &lt; 8</span></div><div class="t m0 x5 hf y1d7a ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1d7b ff1 fs3 fc0 sc0 ls0">还有一些技术可以简化上面的代码，其中一种是使用类装饰器：</div><div class="t m0 x5 h11 y1d7c ffa fs5 fcd sc0 ls0 ws4"># Class decorator to apply constraints</div><div class="t m0 x5 hf y1d7d ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">check_attributes<span class="fc0">(<span class="fc6 ls34">**</span>kwargs):</span></span></div><div class="t m0 x15 hf y1d7e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">decorate<span class="fc0">(cls):</span></span></div><div class="t m0 x16 hf y1d7f ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">key, value </span><span class="ws157">in <span class="ff8 fc0 ws13a">kwargs<span class="fc6 ls34">.</span>items():</span></span></div><div class="t m0 x17 hf y1d80 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">isinstance<span class="fc0 ws4">(value, Descriptor):</span></span></div><div class="t m0 x18 hf y1b6d ff8 fs5 fc0 sc0 ls0 ws13a">value<span class="fc6 ls34">.</span><span class="ws13c">name <span class="fc6 ls32">=</span>key</span></div><div class="t m0 x18 hf y1b6e ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ws13b">(cls, key, value)</span></div><div class="t m0 x17 hf y1b6f ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x18 hf y1d81 ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ws13b">(cls, key, value(key))</span></div><div class="t m0 x16 hf y1b70 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">cls</span></div><div class="t m0 x15 hf y1b72 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">decorate</span></div><div class="t m0 x5 h11 y1d82 ffa fs5 fcd sc0 ls0 ws4"># Example</div><div class="t m0 x5 hf y1b74 ff7 fs5 fc12 sc0 ls0 ws156">@check_attributes<span class="ff8 fc0 ws13a">(name<span class="fc6 ls34">=</span>SizedString(size<span class="fc6 ls34">=<span class="fc7">8</span></span>),</span></div><div class="t m0 x34 hf y1b75 ff8 fs5 fc0 sc0 ls0 ws13a">shares<span class="fc6 ls34">=</span>UnsignedInteger,</div><div class="t m0 x34 hf y1b76 ff8 fs5 fc0 sc0 ls0 ws13a">price<span class="fc6">=</span>UnsignedFloat)</div><div class="t m0 x5 hf y1b77 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Stock<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y1d83 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, name, shares, price):</span></span></span></div><div class="t m0 x16 hf y1b78 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">name </span><span class="ls33">=</span><span class="fc0">name</span></span></div><div class="t m0 x16 hf y1b79 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws19f">shares </span><span class="ls32">=</span><span class="fc0">shares</span></span></div><div class="t m0 x16 hf y1b7a ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws458">price </span><span class="ls32">=</span><span class="fc0">price</span></span></div><div class="t m0 x0 h9 y109 ff1 fs3 fc0 sc0 ls0">另外一种方式是使用元类：</div><div class="t m0 x5 h11 y1d84 ffa fs5 fcd sc0 ls0 ws4"># A metaclass that applies checking</div><div class="t m0 x5 hf y1d85 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">checkedmeta<span class="ff8 fc0 ls34">(</span></span><span class="ff8 ws13a">type<span class="fc0">):</span></span></div><div class="t m0 x15 hf y1b7e ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__new__<span class="fc0 ws4">(cls, clsname, bases, methods):</span></span></div><div class="t m0 x16 h11 y32e ffa fs5 fcd sc0 ls0 ws4"># Attach attribute names to the descriptors</div><div class="t m0 x16 hf y32f ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">key, value </span><span class="ws157">in <span class="ff8 fc0 ws13a">methods<span class="fc6 ls34">.</span>items():</span></span></div><div class="t m0 x17 hf y330 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 ws13a">isinstance<span class="fc0 ws4">(value, Descriptor):</span></span></div><div class="t m0 x18 hf y331 ff8 fs5 fc0 sc0 ls0 ws13a">value<span class="fc6 ls34">.</span><span class="ws13c">name <span class="fc6 ls32">=</span>key</span></div><div class="t m0 x16 hf y332 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">type<span class="fc6 ls34">.</span><span class="fc0 ws4">__new__(cls, clsname, bases, methods)</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">10.13.<span class="_ _5"> </span>8.13 <span class="ff1 wsb03">实现数据模型的类型约束 </span>264</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
