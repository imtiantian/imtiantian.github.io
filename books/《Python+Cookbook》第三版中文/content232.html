<div id="pfe8" class="pf w0 h0" data-page-no="e8"><div class="pc pce8 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bge8.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls63 ws21f">为了让回调函数访问外部信息<span class="_ _c"></span>，一种方法是使用一个绑定方法来代替一个简单函<span class="_ _1"></span></div><div class="t m0 x5 h9 y2b ff1 fs3 fc0 sc0 ls0 ws495">数。比如，下面这个类会保存一个内部序列号，每次接收到一个 <span class="ff6 ws25d">result </span><span class="wsa0">的时候序列号</span></div><div class="t m0 x5 h7 y2c ff1 fs3 fc0 sc0 ls4">加<span class="ff4 ls6">1</span><span class="ls0">：</span></div><div class="t m0 x5 hf y1949 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">ResultHandler<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 hf y194a ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span>):</span></span></div><div class="t m0 x16 hf y194b ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">sequence </span><span class="ls32">=</span><span class="fc7">0</span></span></div><div class="t m0 x15 hf y194c ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handler<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, result):</span></span></span></div><div class="t m0 x16 hf y194d ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">sequence </span><span class="ws23d">+= <span class="fc7">1</span></span></span></div><div class="t m0 x16 hf y194e ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">[{}] Got: {}<span class="ff9">&apos;</span></span></span><span class="fc6">.</span><span class="ls0 ws13a">format(<span class="fca">self</span></span><span class="fc6">.</span><span class="ls0 ws13b">sequence, result))</span></span></div><div class="t m0 x0 h9 y27c ff1 fs3 fc0 sc0 ls49 ws98b">使用这个类的时候<span class="_ _1"></span>，你先创建一个类的实例<span class="_ _1"></span>，然后用它的 <span class="ff6 ls0 ws374">handler() </span><span class="ws1a6">绑定方法来<span class="_ _1"></span></span></div><div class="t m0 x5 h9 y698 ff1 fs3 fc0 sc0 ls0">做为回调函数：</div><div class="t m0 x5 hf y194f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">r<span class="fc6 ls33">=</span><span class="ls0">ResultHandler()</span></span></div><div class="t m0 x5 hf y1950 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13b">apply_async(add, (<span class="fc7 ls34">2</span><span class="ls32">,<span class="fc7 ls34">3</span></span>), callback<span class="fc6 ls34">=</span><span class="ws13a">r<span class="fc6 ls34">.</span>handler)</span></span></div><div class="t m0 x5 hf y1951 ff8 fs5 fc8 sc0 ls0 ws4">[1] Got: 5</div><div class="t m0 x5 hf y1952 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13b">apply_async(add, (<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">hello<span class="ff9 ls34">&apos;</span></span><span class="ls33">,</span><span class="ff9 fc9">&apos;<span class="ff8 ws13a">world</span><span class="ls34">&apos;</span></span>), callback<span class="fc6 ws13a">=</span><span class="ls34">r<span class="fc6">.</span></span>handler)</span></div><div class="t m0 x5 hf y1953 ff8 fs5 fc8 sc0 ls0 ws4">[2] Got: helloworld</div><div class="t m0 x5 hf y1954 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1955 ff1 fs3 fc0 sc0 ls0">第二种方式，作为类的替代，可以使用一个闭包捕获状态值，例如：</div><div class="t m0 x5 hf y1956 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">make_handler<span class="fc0">():</span></span></div><div class="t m0 x15 hf y1957 ff8 fs5 fc0 sc0 ls0 ws1f5">sequence <span class="fc6 ls33">=</span><span class="fc7">0</span></div><div class="t m0 x15 hf y1958 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">handler<span class="fc0">(result):</span></span></div><div class="t m0 x16 hf y1959 ff8 fs5 fc0 sc0 ls0 ws13b">nonlocal sequence</div><div class="t m0 x16 hf y195a ff8 fs5 fc0 sc0 ls0 ws1f5">sequence <span class="fc6 ws1a1">+= <span class="fc7">1</span></span></div><div class="t m0 x16 hf y195b ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">[{}] Got: {}<span class="ff9">&apos;</span></span></span><span class="fc6">.</span><span class="ls0 ws4">format(sequence, result))</span></span></div><div class="t m0 x15 hf y195c ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">handler</span></div><div class="t m0 x0 h9 y195d ff1 fs3 fc0 sc0 ls0">下面是使用闭包方式的一个例子：</div><div class="t m0 x5 hf y195e ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws155">handler <span class="fc6 ls32">=</span>make_handler()</span></div><div class="t m0 x5 hf y195f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13b">apply_async(add, (<span class="fc7 ls34">2</span><span class="ls32">,<span class="fc7 ls34">3</span></span>), callback<span class="fc6 ls34">=</span>handler)</span></div><div class="t m0 x5 hf y8f ff8 fs5 fc8 sc0 ls0 ws4">[1] Got: 5</div><div class="t m0 x5 hf y1960 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13b">apply_async(add, (<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws13a">hello<span class="ff9 ls34">&apos;</span></span><span class="ls33">,</span><span class="ff9 fc9">&apos;<span class="ff8 ws13a">world</span><span class="ls34">&apos;</span></span>), callback<span class="fc6 ws13a">=</span>handler)</span></div><div class="t m0 x5 hf y1961 ff8 fs5 fc8 sc0 ls0 ws4">[2] Got: helloworld</div><div class="t m0 x5 hf y1962 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 ye2e ff1 fs3 fc0 sc0 ls0">还有另外一个更高级的方法，可以使用协程来完成同样的事情：</div><div class="t m0 x5 hf y1963 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">make_handler<span class="fc0">():</span></span></div><div class="t m0 x15 hf y1964 ff8 fs5 fc0 sc0 ls0 ws1f5">sequence <span class="fc6 ls33">=</span><span class="fc7">0</span></div><div class="t m0 x15 hf y1965 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 ws13a">True<span class="fc0">:</span></span></div><div class="t m0 x16 hf y1966 ff8 fs5 fc0 sc0 ls0 ws145">result <span class="fc6 ls32">=</span><span class="ff7 fca">yield</span></div><div class="t m0 x16 hf y1967 ff8 fs5 fc0 sc0 ls0 ws1f5">sequence <span class="fc6 ws1a1">+= <span class="fc7">1</span></span></div><div class="t m0 x16 hf y1968 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">[{}] Got: {}<span class="ff9">&apos;</span></span></span><span class="fc6">.</span><span class="ls0 ws4">format(sequence, result))</span></span></div><div class="t m0 x0 h9 y1969 ff1 fs3 fc0 sc0 ls0 wsc">对于协程，你需要使用它的 <span class="ff6 ws25d">send() </span>方法作为回调函数，如下所示：</div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">9.10.<span class="_ _5"> </span>7.10 <span class="ff1 ws98a">带额外状态信息的回调函数 </span>223</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
