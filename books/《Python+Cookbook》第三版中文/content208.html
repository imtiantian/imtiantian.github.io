<div id="pfd0" class="pf w0 h0" data-page-no="d0"><div class="pc pcd0 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bgd0.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x0 h9 y2a ff1 fs3 fc0 sc0 ls0">下面的例子利用这个类来读取之前我们写入的多边形数据的头部数据：</div><div class="t m0 x5 hf y212 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">f<span class="fc6 ls33">=<span class="fca ls0 ws13a">open<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">polys.bin<span class="ff9 ws13b">&apos;</span></span><span class="ls33">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">rb<span class="ff9 ls34">&apos;</span></span>)</span></span></span></span></div><div class="t m0 x5 hf y213 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws15f">phead <span class="fc6 ls33">=</span><span class="ws13a">PolyHeader(f<span class="fc6 ls34">.</span>read(<span class="fc7">40</span>))</span></span></div><div class="t m0 x5 hf y214 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span><span class="ws51e">file_code <span class="fc6 ws159">== <span class="fc7">0x1234</span></span></span></span></div><div class="t m0 x5 hf y215 ff8 fs5 fc8 sc0 ls0">True</div><div class="t m0 x5 hf y216 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>min_x</span></div><div class="t m0 x5 hf y217 ff8 fs5 fc8 sc0 ls0">0.5</div><div class="t m0 x5 hf y218 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>min_y</span></div><div class="t m0 x5 hf y16b0 ff8 fs5 fc8 sc0 ls0">0.5</div><div class="t m0 x5 hf y16b1 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>max_x</span></div><div class="t m0 x5 hf y16b2 ff8 fs5 fc8 sc0 ls0">7.0</div><div class="t m0 x5 hf y16b3 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>max_y</span></div><div class="t m0 x5 hf y16b4 ff8 fs5 fc8 sc0 ls0">9.2</div><div class="t m0 x5 hf y16b5 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">phead<span class="fc6">.</span>num_polys</span></div><div class="t m0 x5 hf y16b6 ff8 fs5 fc8 sc0 ls0">3</div><div class="t m0 x5 hf y16b7 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y16b8 ff1 fs3 fc0 sc0 ls0 wsa0">这个很有趣，不过这种<span class="_ _6"></span>方式还是有一些烦人的地<span class="_ _6"></span>方。首先，尽管你获得了一<span class="_ _6"></span>个类接</div><div class="t m0 x5 h7 y16b9 ff1 fs3 fc0 sc0 ls1f ws8da">口的便利，但是这个代码还是有点臃肿，还需要使用者指定很多底层的细节 <span class="ff4 ls0 wsa5">(</span><span class="ws113">比如重复</span></div><div class="t m0 x5 h7 y16ba ff1 fs3 fc0 sc0 ls0 ws8db">使用 <span class="ff6 ws1da">StructField </span><span class="wsa0">，指定偏移量等<span class="ff4 wsa5">)</span><span class="ls3a ws153">。另外，返回的结果类同样确实一些便利的方法来</span></span></div><div class="t m0 x5 h9 y16bb ff1 fs3 fc0 sc0 ls0">计算结构的总数。</div><div class="t m0 x0 h9 y16bc ff1 fs3 fc0 sc0 ls30 ws138">任何时候只要你遇到了像这样冗余的类定义，你应该考虑下使用类装饰器或元类<span class="_ _c"></span>。</div><div class="t m0 x5 h9 ybf8 ff1 fs3 fc0 sc0 ls0 wsa0">元类有<span class="_ _6"></span>一个特<span class="_ _6"></span>性就是<span class="_ _6"></span>它能够被<span class="_ _6"></span>用来填<span class="_ _6"></span>充许多<span class="_ _6"></span>低层的<span class="_ _6"></span>实现细<span class="_ _6"></span>节，从而<span class="_ _6"></span>释放使用<span class="_ _6"></span>者的负<span class="_ _6"></span>担。</div><div class="t m0 x5 h9 y16bd ff1 fs3 fc0 sc0 ls0 ws63">下面我来举个例子，使用元类稍微改造下我们的 <span class="ff6 ws1d1">Structure </span>类：</div><div class="t m0 x5 hf y16be ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">StructureMeta<span class="ff8 fc0 ls34">(</span></span><span class="ff8 ws13a">type<span class="fc0">):</span></span></div><div class="t m0 x15 h15 y16bf ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 h11 y16c0 ffa fs5 fc9 sc0 ls0 ws4">Metaclass that automatically creates StructField descriptors</div><div class="t m0 x15 h15 ya9 ffb fs5 fc9 sc0 ls0">&apos;&apos;&apos;</div><div class="t m0 x15 hf y16c1 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, clsname, bases, clsdict):</span></span></span></div><div class="t m0 x16 hf yba7 ff8 fs5 fc0 sc0 ls0 ws145">fields <span class="fc6 ls32">=</span><span class="fca ws13a">getattr</span><span class="ls34">(</span><span class="fca ws13a">self</span><span class="ls33">,</span><span class="ff9 fc9 ws13b">&apos;<span class="ff8 ws13a">_fields_</span><span class="ls34">&apos;</span></span><span class="ws13b">, [])</span></div><div class="t m0 x16 hf y6e3 ff8 fs5 fc0 sc0 ls0 ws2a3">byte_order <span class="fc6 ls32">=</span><span class="ff9 fc9 ws13b">&apos;&apos;</span></div><div class="t m0 x16 hf y16c2 ff8 fs5 fc0 sc0 ls0 ws145">offset <span class="fc6 ls32">=</span><span class="fc7">0</span></div><div class="t m0 x16 hf y16c3 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">format, fieldname </span><span class="ws157">in <span class="ff8 fc0">fields:</span></span></div><div class="t m0 x17 hf y16c4 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">format<span class="fc6 ls34">.</span>startswith((<span class="ff9 fc9 ws13b">&apos;<span class="ff8 ls34">&lt;<span class="ff9">&apos;</span><span class="fc0">,</span></span>&apos;<span class="ff8 ls34">&gt;<span class="ff9">&apos;</span><span class="fc0">,</span></span>&apos;<span class="ff8 ls34">!<span class="ff9">&apos;</span></span></span>,<span class="ff9 fc9 ls34">&apos;<span class="ff8">@</span>&apos;</span>)):</span></div><div class="t m0 x18 hf y16c5 ff8 fs5 fc0 sc0 ls0 ws2a3">byte_order <span class="fc6 ls32">=</span><span class="ws13a">format[<span class="fc7 ls34">0</span>]</span></div><div class="t m0 x18 hf y12c ff8 fs5 fc0 sc0 ls0 ws145">format <span class="fc6 ls32">=</span><span class="ws13a">format[<span class="fc7 ls34">1</span>:]</span></div><div class="t m0 x17 hf y16c6 ff8 fs5 fc0 sc0 ls0 ws145">format <span class="fc6 ls32">=</span><span class="ws2a3">byte_order <span class="fc6 ls33">+</span>format</span></div><div class="t m0 x17 hf y16c7 ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ls34">(</span>self<span class="fc0 ws4">, fieldname, StructField(format, offset))</span></div><div class="t m0 x17 hf yedc ff8 fs5 fc0 sc0 ls0 ws145">offset <span class="fc6 ws23d">+= </span><span class="ws13a">struct<span class="fc6 ls34">.</span>calcsize(format)</span></div><div class="t m0 x16 hf y16c8 ff8 fs5 fca sc0 ls0 ws13a">setattr<span class="fc0 ls34">(</span>self<span class="fc0 ls32">,<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9">struct_size<span class="ff9 ws13b">&apos;</span><span class="fc0 ws4">, offset)</span></span></div><div class="t m0 x5 hf y105e ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Structure<span class="ff8 fc0 ws13a">(metaclass<span class="fc6 ls34">=</span>StructureMeta):</span></span></div><div class="t m0 x15 hf y16c9 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__init__<span class="fc0">(<span class="fca">self</span><span class="ws4">, bytedata):</span></span></span></div><div class="t m0 x16 hf y16ca ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws155">_buffer </span><span class="ls33">=</span><span class="fc0">bytedata</span></span></div><div class="t m0 x15 h10 y16cb ff7 fs5 fc12 sc0 ls0">@classmethod</div><div class="t m0 x15 hf y16cc ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">from_file<span class="fc0 ws4">(cls, f):</span></span></div><div class="t m0 x16 hf y16cd ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">cls(f<span class="fc6">.</span>read(cls<span class="fc6 ls34">.</span>struct_size))</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">8.12.<span class="_ _5"> </span>6.12 <span class="ff1 ws6e7">读取嵌套和可变长二进制数据 </span>199</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
