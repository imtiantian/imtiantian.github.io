<div id="pf252" class="pf w0 h0" data-page-no="252"><div class="pc pc252 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg252.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;min must be &lt;= max&quot;)</div><div class="t m0 x15 hf y1ac ff8 fs5 fc0 sc0 ls0 ws4">if a.shape[0] != out.shape[0]:</div><div class="t m0 x16 hf y1ad ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;input and output arrays must be the same size&quot;)</div><div class="t m0 x15 hf y1ae ff8 fs5 fc0 sc0 ls0 ws13b">with nogil:</div><div class="t m0 x16 hf y1af ff8 fs5 fc0 sc0 ls0 ws4">for i in range(a.shape[0]):</div><div class="t m0 x17 hf y1b0 ff8 fs5 fc0 sc0 ls0 ws4">out[i] = (a[i] if a[i] &lt; max else max) if a[i] &gt; min else min</div><div class="t m0 x0 h9 y391c ff1 fs3 fc0 sc0 ls0">如果你想写一个操作二维数组的版本，下面是可以参考下：</div><div class="t m0 x5 hf y391d ff8 fs5 fc0 sc0 ls0">@cython.boundscheck(False)</div><div class="t m0 x5 hf y391e ff8 fs5 fc0 sc0 ls0">@cython.wraparound(False)</div><div class="t m0 x5 hf y391f ff8 fs5 fc0 sc0 ls0 ws4">cpdef clip2d(double[:,:] a, double min, double max, double[:,:] out):</div><div class="t m0 x15 hf y3920 ff8 fs5 fc0 sc0 ls0 ws4">if min &gt; max:</div><div class="t m0 x16 hf y3921 ff8 fs5 fc0 sc0 ls0 ws4">raise ValueError(&quot;min must be &lt;= max&quot;)</div><div class="t m0 x15 hf y4f2 ff8 fs5 fc0 sc0 ls0 ws4">for n in range(a.ndim):</div><div class="t m0 x16 hf y2a8e ff8 fs5 fc0 sc0 ls0 ws4">if a.shape[n] != out.shape[n]:</div><div class="t m0 x17 hf y3922 ff8 fs5 fc0 sc0 ls0 ws4">raise TypeError(&quot;a and out have different shapes&quot;)</div><div class="t m0 x15 hf y2894 ff8 fs5 fc0 sc0 ls0 ws4">for i in range(a.shape[0]):</div><div class="t m0 x16 hf y2895 ff8 fs5 fc0 sc0 ls0 ws4">for j in range(a.shape[1]):</div><div class="t m0 x17 hf y2896 ff8 fs5 fc0 sc0 ls0 ws4">if a[i,j] &lt; min:</div><div class="t m0 x18 hf y2897 ff8 fs5 fc0 sc0 ls0 ws13b">out[i,j] = min</div><div class="t m0 x17 hf y2898 ff8 fs5 fc0 sc0 ls0 ws4">elif a[i,j] &gt; max:</div><div class="t m0 x18 hf y2899 ff8 fs5 fc0 sc0 ls0 ws13b">out[i,j] = max</div><div class="t m0 x17 hf y289a ff8 fs5 fc0 sc0 ls0">else:</div><div class="t m0 x18 hf yfe2 ff8 fs5 fc0 sc0 ls0 ws13b">out[i,j] = a[i,j]</div><div class="t m0 x0 h7 y26ca ff1 fs3 fc0 sc0 ls0 ws1534">希望<span class="_ _6"></span>读者<span class="_ _6"></span>不<span class="_ _6"></span>要忘<span class="_ _6"></span>了本<span class="_ _6"></span>节所<span class="_ _6"></span>有<span class="_ _6"></span>代码<span class="_ _6"></span>都不<span class="_ _6"></span>会绑<span class="_ _6"></span>定<span class="_ _6"></span>到某<span class="_ _6"></span>个特<span class="_ _6"></span>定<span class="_ _6"></span>数组<span class="_ _6"></span>库（比<span class="_ _6"></span>如 <span class="ff4 wsa5">NumPy</span><span class="wsa0">）上</span></div><div class="t m0 x5 h9 y3923 ff1 fs3 fc0 sc0 ls1e ws111">面<span class="_ _1"></span>。这样代码就更有灵活性。不过<span class="_ _c"></span>，要注意的是如果处理数组要涉<span class="_ _6"></span>及到多维数组<span class="_ _1"></span>、切</div><div class="t m0 x5 h9 y3924 ff1 fs3 fc0 sc0 ls1e ws111">片<span class="_ _1"></span>、偏移和其他因素的时候情况会变得复杂起来<span class="_ _1"></span>。这些内容已经超出本节范围<span class="_ _1"></span>，更多</div><div class="t m0 x5 h7 y3925 ff1 fs3 fc0 sc0 ls0 ws38">信息请参考 <span class="ff4 fc3 ws9c">PEP 3118 </span>，同时 <span class="ff4 fc3 wsba">Cython </span><span class="fc3">文档中关于“类型内存视图” </span>篇也值得一读。</div><div class="t m0 x5 hd yf63 ff2 fs4 fc4 sc0 ls0 wsd91">17.12<span class="_ _e"> </span>15.12 <span class="ff1">将函数指针转换为可调用对象</span></div><div class="t m0 x5 he yad4 ff2 fs2 fc4 sc0 ls0 wsadf">17.12.1 <span class="ff1">问题</span></div><div class="t m0 x0 h7 y3926 ff1 fs3 fc0 sc0 ls23 ws1535">你已经获得了一个被编译函数的内存地址<span class="_ _c"></span>，想将它转换成一个 <span class="ff4 ls0 wsca1">Python <span class="ff1 wsa0">可<span class="_ _0"></span>调<span class="_ _6"></span>用<span class="_ _6"></span>对</span></span></div><div class="t m0 x5 h9 y3927 ff1 fs3 fc0 sc0 ls0">象，这样的话你就可以将它作为一个扩展函数使用了。</div><div class="t m0 x5 he y2c44 ff2 fs2 fc4 sc0 ls0 wsadf">17.12.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h7 y3928 ff6 fs3 fc0 sc0 ls0 ws6a0">ctypes <span class="ff1 ws6a2">模块可被用来创建包装任意内存地址的 <span class="ff4 ws1536">Python </span><span class="wsa0">可调用对象。<span class="_ _1"></span>下面的例子演</span></span></div><div class="t m0 x5 h7 y3929 ff1 fs3 fc0 sc0 ls0 ws14">示了怎样获取 <span class="ff4 ls8">C</span>函数的原始、底层地址，以及如何将其转换为一个可调用对象：</div><div class="t m0 x5 h10 y392a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws146">import <span class="fcc">ctypes</span></span></div><div class="t m0 x5 hf y392b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">lib <span class="fc6 ls32">=</span><span class="ws13a">ctypes<span class="fc6">.</span>cdll<span class="fc6 ls34">.</span>LoadLibrary(<span class="fca">None</span>)</span></span></div><div class="t m0 x5 h11 y392c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ffa fcd ws4"># Get the address of sin() from the C math library</span></div><div class="t m0 x5 hf y392d ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13c">addr <span class="fc6 ls32">=</span><span class="ws13a">ctypes<span class="fc6 ls34">.</span>cast(lib<span class="fc6 ls34">.</span><span class="ws13b">sin, ctypes</span><span class="fc6">.</span>c_void_p)<span class="fc6 ls34">.</span>value</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.12.<span class="_ _36"> </span>15.12 <span class="ff1 ws1537">将函数指针转换为可调用对象 </span>585</div><a class="l" href="http://www.python.org/dev/peps/pep-3118"><div class="d m1" style="border-style:none;position:absolute;left:203.509500px;bottom:539.047500px;width:51.216000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="http://docs.cython.org/src/userguide/memoryviews.html"><div class="d m1" style="border-style:none;position:absolute;left:345.823500px;bottom:539.047500px;width:197.368000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
