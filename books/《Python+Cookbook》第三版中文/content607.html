<div id="pf25f" class="pf w0 h0" data-page-no="25f"><div class="pc pc25f w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg25f.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls0">个损坏的字符串，不能被正确解码的时候会怎样呢？</div><div class="t m0 x0 h9 y76 ff1 fs3 fc0 sc0 ls0 wsa0">一般来讲，可以通过制<span class="_ _6"></span>定一些错误策略比如严格、<span class="_ _6"></span>忽略、替代或其他类似的<span class="_ _6"></span>来处理</div><div class="t m0 x5 h7 y8dd ff4 fs3 fc0 sc0 ls0 ws15c6">Unico<span class="_ _6"></span>de <span class="ff1 wsa0">错误。不过，<span class="_ _1"></span>这些策略的一个缺点是它们永久性破坏了原始字符串的内容。例</span></div><div class="t m0 x5 h9 y99 ff1 fs3 fc0 sc0 ls0">如，如果例子中的不合格数据使用这些策略之一解码，你会得到下面这样的结果：</div><div class="t m0 x5 hf y3a39 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws158">raw <span class="fc6 ls32">=</span><span class="ls34">b<span class="ff9 fc9">&apos;</span></span><span class="fc9 ws13b">Spicy Jalape<span class="ff7 ws156">\xc3\xb1</span><span class="ls34">o</span><span class="ff7 ws156">\xae<span class="ff9">&apos;</span></span></span></span></div><div class="t m0 x5 hf y3a3a ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">raw<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ls34">&apos;</span></span><span class="ls34">,</span><span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">ignore<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y3a3b ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalapeño<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y3a3c ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">raw<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ls34">&apos;</span></span><span class="ls34">,</span><span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">replace<span class="ff9 ws13b">&apos;</span></span>)</span></div><div class="t m0 x5 hf y3a3d ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalapeño?<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y3a3e ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y3a3f ff6 fs3 fc0 sc0 ls0 ws15c7">surrogateescape <span class="ff1 ls1f ws113">错误处理策略会将所有不可解码字节转化为一个代理对的低位字</span></div><div class="t m0 x5 h7 y3a40 ff1 fs3 fc0 sc0 ls0 wsa0">节（<span class="ff4 ws15c8">udcXX </span><span class="ls4">中</span><span class="ff4 ws340">XX </span>是原始字节值）<span class="_ _f"></span>。例如：</div><div class="t m0 x5 hf y3a41 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">raw<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ls34">&apos;</span></span><span class="ls34">,</span><span class="ff9 fc9 ws13b">&apos;</span><span class="fc9">surrogateescape<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y3a42 ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalapeño\udcae<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y3a43 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y2361 ff1 fs3 fc0 sc0 ls2b ws15c9">单独的低位代理字符比如 <span class="ffd ls84">\<span class="ff6 ls0 ws15ca">udcae </span></span><span class="ls12c">在<span class="ff4 ls0 ws15cb">Unico<span class="_ _6"></span>de <span class="ff1 wsa0">中是非<span class="_ _6"></span>法的。因此，<span class="_ _6"></span>这个字<span class="_ _6"></span>符串就是</span></span></span></div><div class="t m0 x5 h9 y3a44 ff1 fs3 fc0 sc0 ls0">一个非法表示。实际上，如果你将它传个一个执行输出的函数，你会得到一个错误：</div><div class="t m0 x5 hf y3a45 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">s<span class="fc6 ls33">=</span><span class="ls0 ws13a">raw<span class="fc6 ls34">.</span>decode(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">utf-8<span class="ff9 ls34">&apos;</span></span></span>,<span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">surrogateescape</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y3a46 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws156">print<span class="ff8 fc0">(s)</span></span></div><div class="t m0 x5 hf y3a47 ff8 fs5 fce sc0 ls0 ws4">Traceback (most recent call last):</div><div class="t m0 x19 hf y3a48 ff8 fs5 fc0 sc0 ls0 ws13c">File <span class="fca ws13a">&quot;&lt;stdin&gt;&quot;</span><span class="ws13b">, line <span class="fc7 ws13a">1</span><span class="ws4">, in &lt;module&gt;</span></span></div><div class="t m0 x5 hf y3a49 ff8 fs5 fc2 sc0 ls0 ws13a">UnicodeEncodeError<span class="fc0 ls33">:<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0">utf-8<span class="ff9 ls32">&apos;</span><span class="ws4">codec can<span class="ff9 ls34">&apos;</span><span class="ws13b">t encode character <span class="ff9 ls34">&apos;</span></span></span>\udcae<span class="ff9">&apos;</span></span></span></div><div class="t m0 x5 hf y3a4a ff8 fs5 fc8 sc0 ls0 ws4">in position 14: surrogates not allowed</div><div class="t m0 x5 hf y3a4b ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h7 y3a4c ff1 fs3 fc0 sc0 ls6b ws15cc">然而，允许代理转换的关<span class="_ _1"></span>键点在于从 <span class="ff4 ls240">C</span><span class="ls0 ws15cd">传<span class="_ _6"></span>给 <span class="ff4 ws1345">Python </span><span class="ws6c0">又回<span class="_ _6"></span>传给 <span class="ff4 ls24f">C</span></span></span><span class="ws28f">的不合格字符串</span></div><div class="t m0 x5 h9 y3a4d ff1 fs3 fc0 sc0 ls42 ws15ce">不会有任何数据丢失。当这个字符串再次使用 <span class="ff6 ls0 ws185">surrogateescape </span><span class="ws186">编码时<span class="_ _1"></span>，代理字符会</span></div><div class="t m0 x5 h9 y3a4e ff1 fs3 fc0 sc0 ls0">转换回原始字节。例如：</div><div class="t m0 x5 hf y3a4f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0">s</span></div><div class="t m0 x5 hf y3190 ff9 fs5 fc8 sc0 ls34">&apos;<span class="ff8 ls0 ws13b">Spicy Jalapeño\udcae<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y3191 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls34">s<span class="fc6 ls0 ws13a">.<span class="fc0">encode(</span></span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">utf-8</span>&apos;</span><span class="ls0 ws13a">,</span><span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13a">surrogateescape</span>&apos;</span><span class="ls0">)</span></span></div><div class="t m0 x5 hf y3192 ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws4">Spicy Jalape\xc3\xb1o\xae<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y3a50 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y3a51 ff1 fs3 fc0 sc0 ls68 ws23f">作为一般准则，最好避免代理编码—<span class="_ _8"></span>—如果你正确的使用了编码，那么你的代码就</div><div class="t m0 x5 h9 y3a52 ff1 fs3 fc0 sc0 ls13 wse5">值得信赖<span class="_ _1"></span>。不过，有时候确实会出现你并不能控制数据编码并且你又不能忽略或替换<span class="_ _c"></span></div><div class="t m0 x5 h9 y36e9 ff1 fs3 fc0 sc0 ls0">坏数据，因为其他函数可能会用到它。那么就可以使用本节的技术了。</div><div class="t m0 x0 h7 y3a53 ff1 fs3 fc0 sc0 ls0 wsa0">最后<span class="_ _6"></span>一<span class="_ _6"></span>点<span class="_ _6"></span>要<span class="_ _6"></span>注意<span class="_ _6"></span>的<span class="_ _6"></span>是，<span class="_ _6"></span><span class="ff4 ws131">Python </span><span class="ls2d ws132">中许多面向系统的函数<span class="_ _1"></span>，特别是和文件名<span class="_ _1"></span>、环境变</span></div><div class="t m0 x5 h9 y3a54 ff1 fs3 fc0 sc0 ls0 wsba0">量和命令行参数相关的都会使用代理编码。例如，<span class="_ _c"></span>如果你使用像 <span class="ff6 wsba1">os.listdir() </span>这样的</div><div class="t m0 x5 h9 y36eb ff1 fs3 fc0 sc0 ls13 wse5">函数<span class="_ _1"></span>，传入一个包含了不可解码文件名的目录的话，它会返回一个代理转换后的字符<span class="_ _c"></span></div><div class="t m0 x5 h7 y3a55 ff1 fs3 fc0 sc0 ls0 ws14">串。参考 <span class="ff4 ws1d0">5.15 </span>的相关章节。</div><div class="t m0 x0 h7 y3a56 ff4 fs3 fc3 sc0 ls0 wsd0">PEP 383 <span class="ff1 fc0 ws14">中有更多关于本机提到的以及和 <span class="ff4 ws15cf">surrogateescap<span class="_ _6"></span>e </span>错误处理相关的信息。</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsd97">17.16.<span class="_ _36"> </span>15.16 <span class="ff1 ws16b">不确定编码格式的 </span><span class="ls246">C</span><span class="ff1 ws15bc">字符串 </span>598</div><a class="l" href="https://www.python.org/dev/peps/pep-0383/"><div class="d m1" style="border-style:none;position:absolute;left:137.887500px;bottom:167.958000px;width:45.358000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
