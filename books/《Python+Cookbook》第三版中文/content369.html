<div id="pf171" class="pf w0 h0" data-page-no="171"><div class="pc pc171 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg171.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 h11 y1e8 ffa fs5 fcd sc0 ls0 ws4"># Inject new statements into the function body</div><div class="t m0 x16 hf y1e9 ff8 fs5 fc0 sc0 ls0 ws13a">node<span class="fc6">.</span>body[:<span class="fc7 ls34">0</span><span class="ls32">]<span class="fc6">=</span></span>code_ast<span class="fc6 ls34">.</span>body</div><div class="t m0 x16 h11 y903 ffa fs5 fcd sc0 ls0 ws4"># Save the function object</div><div class="t m0 x16 hf y1eb ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws13c">func </span><span class="ls33">=</span><span class="fc0">node</span></span></div><div class="t m0 x5 h11 y904 ffa fs5 fcd sc0 ls0 ws4"># Decorator that turns global names into locals</div><div class="t m0 x5 hf y905 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">lower_names<span class="fc0 ls34">(</span><span class="fc6">*<span class="fc0">namelist):</span></span></span></div><div class="t m0 x15 hf y906 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">lower<span class="fc0">(func):</span></span></div><div class="t m0 x16 hf y907 ff8 fs5 fc0 sc0 ls0 ws1f5">srclines <span class="fc6 ls33">=</span><span class="ws13a">inspect<span class="fc6 ls34">.</span>getsource(func)<span class="fc6">.</span>splitlines()</span></div><div class="t m0 x16 h11 y908 ffa fs5 fcd sc0 ls0 ws4"># Skip source lines prior to the @lower_names decorator</div><div class="t m0 x16 hf y909 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ws13b">n, line </span><span class="ws157">in <span class="ff8 ws13a">enumerate<span class="fc0">(srclines):</span></span></span></div><div class="t m0 x17 hf ybd8 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff9 fc9 ls34">&apos;<span class="ff8 ls0 ws13a">@lower_names</span><span class="ls33">&apos;</span></span>in <span class="ff8 fc0">line:</span></div><div class="t m0 x18 h10 ybd9 ff7 fs5 fca sc0 ls0">break</div><div class="t m0 x16 hf y61 ff8 fs5 fc0 sc0 ls0 ws158">src <span class="fc6 ls32">=<span class="ff9 fc9 ls34">&apos;<span class="ff7 ls0 ws156">\n</span>&apos;</span><span class="ls34">.</span></span><span class="ws13a">join(srclines[n<span class="fc6">+<span class="fc7 ls34">1</span></span>:])</span></div><div class="t m0 x16 h11 y90b ffa fs5 fcd sc0 ls0 ws4"># Hack to deal with indented code</div><div class="t m0 x16 hf y90c ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws13a">src<span class="fc6 ls34">.</span>startswith((<span class="ff9 fc9 ws38a">&apos; &apos;</span><span class="ls34">,</span><span class="ff9 fc9 ws13b">&apos;<span class="ff7 ws156">\t</span>&apos;</span>)):</span></div><div class="t m0 x17 hf y90d ff8 fs5 fc0 sc0 ls0 ws158">src <span class="fc6 ls32">=<span class="ff9 fc9 ls34">&apos;</span></span><span class="fc9 ws13b">if 1:<span class="ff7 ws156">\n<span class="ff9 ls32">&apos;</span></span><span class="fc6 ls33">+</span></span>src</div><div class="t m0 x16 hf y90e ff8 fs5 fc0 sc0 ls0 ws158">top <span class="fc6 ls32">=</span><span class="ws13a">ast<span class="fc6 ls34">.</span><span class="ws4">parse(src, mode<span class="fc6 ls34">=</span><span class="ff9 fc9 ws13b">&apos;</span></span><span class="fc9">exec<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x16 h11 y910 ffa fs5 fcd sc0 ls0 ws4"># Transform the AST</div><div class="t m0 x16 hf y911 ff8 fs5 fc0 sc0 ls0 ws159">cl <span class="fc6 ls32">=</span>NameLower(namelist)</div><div class="t m0 x16 hf ye93 ff8 fs5 fc0 sc0 ls0 ws13a">cl<span class="fc6 ls34">.</span>visit(top)</div><div class="t m0 x16 h11 y913 ffa fs5 fcd sc0 ls0 ws4"># Execute the modified AST</div><div class="t m0 x16 hf y914 ff8 fs5 fc0 sc0 ls0 ws161">temp <span class="fc6 ls33">=</span>{}</div><div class="t m0 x16 hf y915 ff7 fs5 fca sc0 ls0 ws156">exec<span class="ff8 fc0 ws13a">(<span class="fca">compile</span>(top,<span class="ff9 fc9 ls34">&apos;&apos;</span>,<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">exec<span class="ff9 ls34">&apos;</span></span><span class="ws13b">), temp, temp)</span></span></div><div class="t m0 x16 h11 y917 ffa fs5 fcd sc0 ls0 ws4"># Pull out the modified code object</div><div class="t m0 x16 hf y2645 ff8 fs5 fc0 sc0 ls0 ws13a">func<span class="fc6">.</span><span class="ws16d">__code__ <span class="fc6 ls32">=</span></span>temp[func<span class="fc6 ls34">.</span>__name__]<span class="fc6 ls34">.</span>__code__</div><div class="t m0 x16 hf y918 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">func</span></div><div class="t m0 x15 hf y919 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">lower</span></div><div class="t m0 x0 h9 y2646 ff1 fs3 fc0 sc0 ls0">为了使用这个代码，你可以像下面这样写：</div><div class="t m0 x5 hf y2647 ff8 fs5 fc0 sc0 ls0 ws13c">INCR <span class="fc6 ls32">=</span><span class="fc7">1</span></div><div class="t m0 x5 hf y1a27 ff7 fs5 fc12 sc0 ls0 ws156">@lower_names<span class="ff8 fc0 ws13a">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">INCR<span class="ff9 ls34">&apos;</span></span>)</span></div><div class="t m0 x5 hf y1a28 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">countdown<span class="fc0">(n):</span></span></div><div class="t m0 x15 hf y1b00 ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0 ls33">n<span class="fc6 ls32">&gt;<span class="fc7 ls34">0</span></span><span class="ls0">:</span></span></div><div class="t m0 x16 hf y2648 ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls0 ws23d">-= <span class="fc0">INCR</span></span></div><div class="t m0 x0 h9 y22fa ff1 fs3 fc0 sc0 ls0 ws38">装饰器会将 <span class="ff6 ws1e2">countdown() </span>函数重写为类似下面这样子：</div><div class="t m0 x5 hf y2649 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">countdown<span class="fc0">(n):</span></span></div><div class="t m0 x15 hf y264a ff8 fs5 fc0 sc0 ls0 ws16e">__globals <span class="fc6 ls33">=</span><span class="fca ws13a">globals</span>()</div><div class="t m0 x15 hf y264b ff8 fs5 fc0 sc0 ls0 ws13c">INCR <span class="fc6 ls32">=</span><span class="ws13a">__globals[<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">INCR<span class="ff9 ls34">&apos;</span></span>]</span></div><div class="t m0 x15 hf y264c ff7 fs5 fca sc0 ls0 ws16a">while <span class="ff8 fc0 ls33">n<span class="fc6 ls32">&gt;<span class="fc7 ls34">0</span></span><span class="ls0">:</span></span></div><div class="t m0 x16 hf y1e74 ff8 fs5 fc0 sc0 ls32">n<span class="fc6 ls0 ws23d">-= <span class="fc0">INCR</span></span></div><div class="t m0 x0 h7 y264d ff1 fs3 fc0 sc0 ls0 ws38">在性能测试中，它会让函数运行快 <span class="ff4">20%</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.24.<span class="_ _5"> </span>9.24 <span class="ff1 ws7da">解析与分析 </span><span class="wscda">Python <span class="ff1 wscdb">源码 </span>360</span></div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
