<div id="pf167" class="pf w0 h0" data-page-no="167"><div class="pc pc167 w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg167.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x16 hf y1ab ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">_methods </span><span class="ls32">=</span><span class="fc0">{}</span></span></div><div class="t m0 x16 hf y1ac ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">__name__ </span><span class="ls32">=</span><span class="fc0">func</span><span class="ls34">.</span><span class="fc0">__name__</span></span></div><div class="t m0 x16 hf y1ad ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0 ws16d">_default </span><span class="ls32">=</span><span class="fc0">func</span></span></div><div class="t m0 x15 hf y1af ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">match<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ls33">,</span><span class="fc6">*<span class="fc0">types):</span></span></span></span></div><div class="t m0 x16 hf y1b0 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">register<span class="fc0">(func):</span></span></div><div class="t m0 x17 hf y355 ff8 fs5 fc0 sc0 ls0 ws16e">ndefaults <span class="fc6 ls32">=</span><span class="fca ws13a">len<span class="fc0">(func<span class="fc6 ls34">.</span><span class="ws147">__defaults__) </span></span><span class="ff7 ws157">if </span><span class="fc0">func<span class="fc6 ls34">.</span><span class="ws150">__defaults__ </span></span><span class="ff7 ws15a">else </span><span class="fc7">0</span></span></div><div class="t m0 x17 hf y410 ff7 fs5 fca sc0 ls0 ws139">for <span class="ff8 fc0 ls32">n</span><span class="ws157">in <span class="ff8 ws13a">range<span class="fc0">(ndefaults<span class="fc6 ls34">+<span class="fc7">1</span></span>):</span></span></span></div><div class="t m0 x18 hf y411 ff8 fs5 fca sc0 ls0 ws13a">self<span class="fc6">.<span class="fc0">_methods[types[:</span></span>len<span class="fc0 ws155">(types) <span class="fc6 ls32">-</span><span class="ws158">n]] <span class="fc6 ls33">=</span>func</span></span></div><div class="t m0 x17 hf yba ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x16 hf y8c6 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0">register</span></div><div class="t m0 x15 hf ybee ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__call__<span class="fc0">(<span class="fca">self</span><span class="ls33">,</span><span class="fc6">*</span>args):</span></span></div><div class="t m0 x16 hf ybef ff8 fs5 fc0 sc0 ls0 ws15f">types <span class="fc6 ls33">=</span><span class="fca ws13a">tuple</span><span class="ls34">(</span><span class="fca ws13a">type</span>(arg) <span class="ff7 fca ws139">for </span><span class="ws158">arg <span class="ff7 fca ws157">in </span><span class="ws13a">args[<span class="fc7 ls34">1</span>:])</span></span></div><div class="t m0 x16 hf ybf0 ff8 fs5 fc0 sc0 ls0 ws161">meth <span class="fc6 ls33">=</span><span class="fca ws13a">self<span class="fc6 ls34">.</span><span class="fc0">_methods<span class="fc6 ls34">.</span><span class="ws2a3">get(types, </span></span>None</span>)</div><div class="t m0 x16 hf yd7d ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0">meth:</span></div><div class="t m0 x17 hf ybf1 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">meth(<span class="fc6 ls34">*</span>args)</span></div><div class="t m0 x16 hf ybf2 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf ybf3 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 ws13a">self<span class="fc6">.<span class="fc0">_default(</span><span class="ls34">*</span><span class="fc0">args)</span></span></span></div><div class="t m0 x15 hf ybf5 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">__get__<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, instance, cls):</span></span></span></div><div class="t m0 x16 hf ybf6 ff7 fs5 fca sc0 ls0 ws157">if <span class="ff8 fc0 ws16d">instance </span>is not <span class="ff8 ws13a">None<span class="fc0">:</span></span></div><div class="t m0 x17 hf ybf7 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">types<span class="fc6 ls34">.</span>MethodType(<span class="fca">self</span><span class="ws4">, instance)</span></span></div><div class="t m0 x16 hf ybf8 ff7 fs5 fca sc0 ls0 ws156">else<span class="ff8 fc0">:</span></div><div class="t m0 x17 hf ybf9 ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8">self</span></div><div class="t m0 x0 h9 y2558 ff1 fs3 fc0 sc0 ls0">为了使用描述器版本，你需要像下面这样写：</div><div class="t m0 x5 hf y2559 ff7 fs5 fca sc0 ls0 ws16a">class <span class="fcc ws156">Spam<span class="ff8 fc0">:</span></span></div><div class="t m0 x15 h10 y255a ff7 fs5 fc12 sc0 ls0">@multimethod</div><div class="t m0 x15 hf y255b ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">bar<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ls32">,<span class="fc6 ls34">*</span><span class="ls0">args):</span></span></span></span></div><div class="t m0 x16 h11 y255c ffa fs5 fcd sc0 ls0 ws4"># Default method called if no match</div><div class="t m0 x16 hf y255d ff7 fs5 fca sc0 ls0 ws16a">raise <span class="ff8 ws13a">TypeError<span class="fc0">(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9 ws4">No matching method for bar<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x15 hf y255e ff7 fs5 fc12 sc0 ls0 ws156">@bar.match<span class="ff8 fc0 ls34">(<span class="fca ls0 ws13a">int</span><span class="ls33">,<span class="fca ls0 ws13a">int<span class="fc0">)</span></span></span></span></div><div class="t m0 x15 hf y255f ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">bar<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, x, y):</span></span></span></div><div class="t m0 x16 hf y2560 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Bar 1:</span>&apos;</span><span class="ls0 ws13b">, x, y)</span></span></div><div class="t m0 x15 hf y2561 ff7 fs5 fc12 sc0 ls0 ws156">@bar.match<span class="ff8 fc0 ls34">(<span class="fca ls0 ws13a">str</span><span class="ls33">,<span class="fca ls0 ws13a">int<span class="fc0">)</span></span></span></span></div><div class="t m0 x15 hf y2562 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">bar<span class="fc0 ls34">(</span><span class="fca">self<span class="fc0 ws13b">, s, n <span class="fc6 ls32">=<span class="fc7 ls34">0</span></span>):</span></span></span></div><div class="t m0 x16 hf y2563 ff7 fs5 fca sc0 ls0 ws156">print<span class="ff8 fc0 ls34">(<span class="ff9 fc9">&apos;<span class="ff8 ls0 ws13b">Bar 2:</span>&apos;</span><span class="ls0 ws13b">, s, n)</span></span></div><div class="t m0 x0 h9 y2564 ff1 fs3 fc0 sc0 ls0 wsa0">描述器方案同样也有前面提到的限制（不支持关键字参数和继承）<span class="_ _f"></span>。</div><div class="t m0 x0 h9 y2565 ff1 fs3 fc0 sc0 ls3a ws153">所有事物都是平等的，有好有坏，也许最好的办法就是在普通代码中避免使用方法</div><div class="t m0 x5 h9 y2566 ff1 fs3 fc0 sc0 ls0 wsa0">重<span class="_ _6"></span>载。不<span class="_ _6"></span>过<span class="_ _6"></span>有<span class="_ _6"></span>些<span class="_ _6"></span>特<span class="_ _6"></span>殊情<span class="_ _6"></span>况<span class="_ _6"></span>下<span class="_ _6"></span>还<span class="_ _6"></span>是<span class="_ _6"></span>有意<span class="_ _6"></span>义<span class="_ _6"></span>的，<span class="_ _6"></span>比<span class="_ _6"></span>如<span class="_ _6"></span>基<span class="_ _6"></span>于模<span class="_ _6"></span>式<span class="_ _6"></span>匹<span class="_ _6"></span>配<span class="_ _6"></span>的<span class="_ _6"></span>方法<span class="_ _6"></span>重<span class="_ _6"></span>载<span class="_ _6"></span>程<span class="_ _6"></span>序<span class="_ _6"></span>中。举</div><div class="t m0 x5 h7 y2567 ff1 fs3 fc0 sc0 ls0 wsa0">个例<span class="_ _6"></span>子，<span class="_ _6"></span><span class="ff4 wsb91">8.21 </span><span class="ls2d ws132">小节中的访问者模式可以修改为一个使用方法重载的类。但是<span class="_ _c"></span>，除了这</span></div><div class="t m0 x5 h9 y2568 ff1 fs3 fc0 sc0 ls0 wsa0">个以外，通常不应该使用方法重载（就简单的使用不同名称的方法就行了）<span class="_ _f"></span>。</div><div class="t m0 x0 h7 y2569 ff1 fs3 fc0 sc0 lsb2">在<span class="ff4 ls0 wsca1">Python </span><span class="ls23 ws11a">社区对于实现方法重载的讨论已经由来已久<span class="_ _c"></span>。对于引发这个争论的原<span class="_ _c"></span></span></div><div class="t m0 x5 h7 y256a ff1 fs3 fc0 sc0 ls0 wsca2">因，<span class="_ _c"></span>可以参考下 <span class="ff4 wsca3">Guido v<span class="_ _c"></span>an Rossum <span class="ff1 wsca4">的这篇博客： </span><span class="fc3 wsca5">Five-Min<span class="_ _c"></span>ute Multimetho<span class="_ _6"></span>ds in Python</span></span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 wsae0">11.20.<span class="_ _5"> </span>9.20 <span class="ff1 wsc0a">利用函数注解实现方法重载 </span>350</div><a class="l" href="http://www.artima.com/weblogs/viewpost.jsp?thread=101605"><div class="d m1" style="border-style:none;position:absolute;left:498.193500px;bottom:129.826500px;width:191.147000px;height:16.821000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
