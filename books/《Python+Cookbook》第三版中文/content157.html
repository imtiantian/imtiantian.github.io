<div id="pf9d" class="pf w0 h0" data-page-no="9d"><div class="pc pc9d w0 h0"><img class="bi x13 y5 w2 ha" alt="" src="bg9d.png"/><div class="t m0 xd h9 y75 ff1 fs3 fc0 sc0 lsb">《<span class="ff2 ls0 wsce">Python Co<span class="_ _6"></span>okb<span class="_ _6"></span>o<span class="_ _6"></span>ok</span><span class="ls0 wsa0">》第三版<span class="ff2 wsce">, Release 2.0.0</span></span></div><div class="t m0 x5 h9 y2a ff1 fs3 fc0 sc0 ls0">字节数。</div><div class="t m0 x0 h7 y76 ff1 fs3 fc0 sc0 lse ws69b">如果字节数小于缓冲区大小，表明数据被截断或者被破坏了 <span class="ff4 ls1b">(</span><span class="wsd8">比如你期望每次读取<span class="_ _1"></span></span></div><div class="t m0 x5 h7 y8dd ff1 fs3 fc0 sc0 ls0 wsa0">指定数量的字节<span class="ff4 wsa5">)</span>。</div><div class="t m0 x0 h7 y2e ff1 fs3 fc0 sc0 ls113 ws69c">最后<span class="_ _d"></span>，留心观察其他函数库和模块中和 <span class="ff6 ls0 ws69d">into </span><span class="ws69e">相关的函数 <span class="ff4 ls0 wsa5">(<span class="ff1 ws69f">比<span class="_ _0"></span>如 <span class="ff6 ws3e1">recv into()<span class="_ _b"> </span></span>，</span></span></span></div><div class="t m0 x5 h7 y2f ff6 fs3 fc0 sc0 ls0 ws6a0">pack<span class="_ _7"> </span>into() <span class="ff1 lsb">等</span><span class="ff4 wsa5">)<span class="ff1 wsa0">。<span class="_ _c"></span><span class="ff4 ws6a1">Python <span class="ff1 ws6a2">的很多其他部分已经能支持直接的 </span><span class="ws6a3">I/O <span class="ff1 wsa0">或数据访问操作，这</span></span></span></span></span></div><div class="t m0 x5 h9 y30 ff1 fs3 fc0 sc0 ls0">些操作可被用来填充或修改数组和缓冲区内容。</div><div class="t m0 x0 h7 y9d ff1 fs3 fc0 sc0 ls0 wsc">关于解析二进制结构和 <span class="ff6 ws133">memoryviews </span><span class="ws14">使用方法的更高级例子，请参考 <span class="ff4 ws1d0">6.12 </span>小节。</span></div><div class="t m0 x5 hd y1131 ff2 fs4 fc4 sc0 ls0 ws211">7.10<span class="_ _e"> </span>5.10 <span class="ff1">内存映射的二进制文件</span></div><div class="t m0 x5 he y1132 ff2 fs2 fc4 sc0 ls0 ws212">7.10.1 <span class="ff1">问题</span></div><div class="t m0 x0 h9 y1133 ff1 fs3 fc0 sc0 ls3a ws153">你想内存映射一个二进制文件到一个可变字节数组中，目的可能是为了随机访问它</div><div class="t m0 x5 h9 y1134 ff1 fs3 fc0 sc0 ls0">的内容或者是原地做些修改。</div><div class="t m0 x5 he y1135 ff2 fs2 fc4 sc0 ls0 ws212">7.10.2 <span class="ff1">解决方案</span></div><div class="t m0 x0 h9 y1076 ff1 fs3 fc0 sc0 ls0 ws409">使用 <span class="ff6 ws27f">mmap </span><span class="lse wsd8">模块来内存映射文件。下面是一个工具函数，向你演示了如何打开一个</span></div><div class="t m0 x5 h9 y1136 ff1 fs3 fc0 sc0 ls0">文件并以一种便捷方式内存映射这个文件。</div><div class="t m0 x5 h10 y1137 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">os</span></div><div class="t m0 x5 h10 y1138 ff7 fs5 fca sc0 ls0 ws146">import <span class="fcc">mmap</span></div><div class="t m0 x5 hf y1139 ff7 fs5 fca sc0 ls0 ws139">def <span class="ff8 fcb ws13a">memory_map<span class="fc0 ws4">(filename, access</span><span class="fc6">=<span class="fc0">mmap</span><span class="ls34">.</span><span class="fc0">ACCESS_WRITE):</span></span></span></div><div class="t m0 x15 hf y113a ff8 fs5 fc0 sc0 ls0 ws13c">size <span class="fc6 ls32">=</span><span class="ws13a">os<span class="fc6 ls34">.</span>path<span class="fc6 ls34">.</span>getsize(filename)</span></div><div class="t m0 x15 hf y113b ff8 fs5 fc0 sc0 ls0 ws159">fd <span class="fc6 ls33">=</span><span class="ws13a">os<span class="fc6 ls34">.</span><span class="ws13b">open(filename, os<span class="fc6 ls34">.</span>O_RDWR)</span></span></div><div class="t m0 x15 hf y113c ff7 fs5 fca sc0 ls0 ws146">return <span class="ff8 fc0 ws13a">mmap<span class="fc6 ls34">.</span><span class="ws13b">mmap(fd, size, access<span class="fc6 ls34">=</span>access)</span></span></div><div class="t m0 x0 h9 y113d ff1 fs3 fc0 sc0 ls56 ws1fa">为了使用这个函数<span class="_ _c"></span>，你需要有一个已创建并且内容不为空的文件<span class="_ _1"></span>。下面是一个例<span class="_ _1"></span></div><div class="t m0 x5 h9 y113e ff1 fs3 fc0 sc0 ls0">子，教你怎样初始创建一个文件并将其内容扩充到指定大小：</div><div class="t m0 x5 hf y113f ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13c">size <span class="fc6 ls32">=</span><span class="fc7">1000000</span></span></div><div class="t m0 x5 hf y1140 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="fca ws15a">with <span class="ff8 ws13a">open<span class="fc0 ls34">(<span class="ff9 fc9">&apos;</span></span><span class="fc9">data<span class="ff9 ls34">&apos;</span><span class="fc0 ls32">,</span><span class="ff9 ls34">&apos;</span>wb<span class="ff9 ls34">&apos;</span><span class="fc0 ls32">)</span></span></span><span class="ws160">as <span class="ff8 fc0">f:</span></span></span></div><div class="t m0 x5 hf y1141 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">seek(size</span><span class="ls34">-</span><span class="fc7">1<span class="fc0">)</span></span></span></span></div><div class="t m0 x5 hf y1142 ff7 fs5 fc5 sc0 ls0 ws1a2">... <span class="ff8 fc0 ls34">f<span class="fc6 ls0 ws13a">.<span class="fc0">write(b</span></span><span class="ff9 fc9">&apos;</span></span><span class="fc9 ws156">\x00<span class="ff9 ls34">&apos;</span><span class="ff8 fc0">)</span></span></div><div class="t m0 x5 h10 y1143 ff7 fs5 fc5 sc0 ls0">...</div><div class="t m0 x5 hf y1144 ff8 fs5 fc8 sc0 ls0">&gt;&gt;&gt;</div><div class="t m0 x0 h9 y1145 ff1 fs3 fc0 sc0 ls0 ws38">下面是一个利用 <span class="ff6 ws19e">memory<span class="_ _7"> </span>map() </span>函数类内存映射文件内容的例子：</div><div class="t m0 x5 hf y1146 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ls32">m<span class="fc6 ls33">=</span><span class="ls0 ws13a">memory_map(<span class="ff9 fc9 ls34">&apos;</span><span class="fc9">data<span class="ff9 ls34">&apos;</span></span>)</span></span></div><div class="t m0 x5 hf y1147 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fca ws13a">len<span class="fc0">(m)</span></span></div><div class="t m0 x5 hf y1148 ff8 fs5 fc8 sc0 ls0">1000000</div><div class="t m0 x5 hf y1149 ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">m[<span class="fc7 ls34">0<span class="fc0">:</span><span class="ls0">10</span></span>]</span></div><div class="t m0 x5 hf y114a ff8 fs5 fc8 sc0 ls34">b<span class="ff9 ls0 ws13b">&apos;</span><span class="ls0 ws13a">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00<span class="ff9">&apos;</span></span></div><div class="t m0 x5 hf y114b ff7 fs5 fc5 sc0 ls0 ws139">&gt;&gt;&gt; <span class="ff8 fc0 ws13a">m[<span class="fc7 ls34">0</span>]</span></div><div class="t m0 x5 h9 y29 ff2 fs3 fc0 sc0 ls0 ws21d">7.10.<span class="_ _5"> </span>5.10 <span class="ff1 ws509">内存映射的二进制文件 </span>148</div></div><div class="pi" data-data='{"ctm":[1.500000,0.000000,0.000000,1.500000,0.000000,0.000000]}'></div></div>
